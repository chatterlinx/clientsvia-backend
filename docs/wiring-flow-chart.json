{
  "wiringFlowChart": {
    "meta": {
      "version": "1.0.1",
      "updatedAt": "2026-02-03T09:45:00.000Z",
      "description": "Truth source wiring flow chart for the platform. Nodes represent components/modals/tabs, edges show connections/wiring. Copy-paste this JSON for future reference. Update dynamically on changes (e.g., add new nodes/edges for features like new APIs). Failing points flagged in 'health' per node.",
      "instructions": "To update: Add/remove nodes/edges, increment version, note changes in 'changelog'. Use for troubleshooting: Trace paths from input (e.g., CALL_START) to output (e.g., BOOKING_COMPLETE). If a path breaks, check 'health' and 'dependencies'."
    },
    "changelog": [
      {
        "version": "1.0.0",
        "changes": "Initial chart based on Control Plane UI (v79.4), wiring JSON, penguin-air-config, and logs. Covers all tabs, modals, scenarios, APIs, prompts. Flagged known failing points (e.g., consent injection, API calls)."
      },
      {
        "version": "1.0.1",
        "changes": "V92 FIXES APPLIED: (1) LLM consent injection now catches 'get a technician', (2) BookingFlowRunner now uses slot.options for confirmPrompt/askFullName/lastNameQuestion, (3) BookingFlowResolver extracts all slot options including confirmSpelling/askMissingNamePart."
      },
      {
        "version": "1.0.2",
        "changes": "V92: Added discovery clarification node - agent now asks clarifying questions for vague issues (e.g., 'AC problems' → 'Is it not cooling, not heating, or something else?') BEFORE offering to schedule."
      },
      {
        "version": "1.0.3",
        "changes": "V92: (1) Added EmptyUtteranceGuard - routes filler-only inputs ('uh,' → ',') to SilenceHandler instead of tier3 LLM, (2) Added DirectBookingIntentDetector patterns for 'how soon can you get somebody out here', (3) Fixed fast-path to actually trigger bookingModeLocked state transition."
      }
    ],
    "fixedInV92": [
      {
        "node": "section_discoveryConsent",
        "issue": "Injection skips if no scheduling keywords",
        "fix": "Expanded llmSchedulingPatterns regex to catch 'get a technician', 'send someone', 'come take a look', etc.",
        "commit": "dbab7af7"
      },
      {
        "node": "section_bookingPrompts",
        "issue": "Custom fields (confirmPrompt, spelling) skipped in BookingFlowRunner",
        "fix": "BookingFlowRunner now reads from step.options for all slot settings",
        "commit": "f643d9e0"
      },
      {
        "node": "slots_name",
        "issue": "askFullName/lastNameQuestion not wired",
        "fix": "Added full name handling with lastNameQuestion follow-up",
        "commit": "fd99c919"
      }
    ],
    "remainingIssues": [
      {
        "node": "integrations_googleCalendar",
        "issue": "Not wired to time slot step",
        "priority": "medium",
        "suggestedFix": "Add googleCalendarFetch call in BookingFlowRunner when currentBookingStep === 'time'"
      },
      {
        "node": "integrations_smsNotifications",
        "issue": "Not triggered post-booking",
        "priority": "medium",
        "suggestedFix": "Wire to BOOKING_COMPLETE action in finalizeBooking"
      },
      {
        "node": "scenarios_switchboard",
        "issue": "No REQUIRE_BOOKING or TRANSFER action types wired",
        "priority": "low",
        "suggestedFix": "Add actionType handlers in HybridScenarioSelector"
      },
      {
        "node": "placeholders",
        "issue": "Not wired to all responses",
        "priority": "low",
        "suggestedFix": "Run replacePlaceholders on all response paths"
      }
    ],
    "nodes": [
      {
        "id": "tab_frontDesk",
        "label": "Front Desk Tab",
        "type": "tab",
        "description": "Core AI behavior settings. Score: 93% Yellow (Mostly Ready). Includes personality, discovery/consent, booking prompts.",
        "health": "IMPROVED: Consent gating now catches more patterns (V92 fix).",
        "dependencies": ["dataConfig_templateReferences", "integrations_googleCalendar"],
        "position": { "x": 100, "y": 100 }
      },
      {
        "id": "section_personality",
        "label": "Personality Section",
        "type": "section",
        "description": "AI name, tone, style. 100% complete. Wired to greeting/responses.",
        "health": "Healthy: Used in all responses (e.g., warm/concise).",
        "dependencies": ["placeholders_companyName"],
        "position": { "x": 200, "y": 200 }
      },
      {
        "id": "section_discoveryConsent",
        "label": "Discovery & Consent Section",
        "type": "section",
        "description": "Consent phrases, explicit consent required. 100% complete. Includes debugLogging toggle.",
        "health": "FIXED (V92): LLM responses now inject consent question when implying scheduling.",
        "dependencies": ["section_discoveryClarification", "dynamicFlows_booking_intent"],
        "position": { "x": 200, "y": 300 }
      },
      {
        "id": "section_discoveryClarification",
        "label": "Discovery Clarification",
        "type": "section",
        "description": "V92: Asks clarifying questions when issue is vague (e.g., 'AC problems' → 'Is it not cooling, not heating, or something else?'). Trade-specific questions for HVAC, plumbing, electrical.",
        "health": "NEW (V92): Prevents rushing to booking without understanding the problem.",
        "config": {
          "enabled": "discovery.clarifyingQuestions.enabled",
          "vaguePatterns": "discovery.clarifyingQuestions.vaguePatterns"
        },
        "dependencies": ["dynamicFlows_booking_intent"],
        "position": { "x": 200, "y": 350 }
      },
      {
        "id": "section_bookingPrompts",
        "label": "Booking Prompts Section",
        "type": "section",
        "description": "Step-by-step slots (e.g., name with confirmSpelling, askFullName). 100% complete.",
        "health": "FIXED (V92): Custom fields now wired through step.options to BookingFlowRunner.",
        "dependencies": ["slots_name", "integrations_googleGeo"],
        "position": { "x": 200, "y": 400 }
      },
      {
        "id": "slots_name",
        "label": "Name Slot Prompt",
        "type": "slot",
        "description": "Custom JSON: question, confirmPrompt, spelling, full name asks. Required, type: name.",
        "health": "FIXED (V92): askFullName + lastNameQuestion now wired. confirmPrompt used.",
        "dependencies": [],
        "position": { "x": 300, "y": 450 }
      },
      {
        "id": "section_greetings",
        "label": "Greeting Section",
        "type": "section",
        "description": "Custom greetings (e.g., good morning responses). 100% complete.",
        "health": "Healthy: Used in CALL_START.",
        "dependencies": [],
        "position": { "x": 200, "y": 500 }
      },
      {
        "id": "section_vocabulary",
        "label": "Vocabulary Section",
        "type": "section",
        "description": "Filler words, name stop words. 70% (Yellow).",
        "health": "Needs Review: Underutilized in STT_PREPROCESSING.",
        "dependencies": [],
        "position": { "x": 200, "y": 600 }
      },
      {
        "id": "section_loopPrevention",
        "label": "Loop Prevention Section",
        "type": "section",
        "description": "Max loops, rephrase. 75% (Yellow).",
        "health": "Healthy: Wired to silencePolicy/timedFollowUp.",
        "dependencies": [],
        "position": { "x": 200, "y": 700 }
      },
      {
        "id": "tab_flowTree",
        "label": "Flow Tree Tab",
        "type": "tab",
        "description": "Visual flow builder (not fully used).",
        "health": "Underutilized: Could integrate with new chart.",
        "dependencies": ["dynamicFlows"],
        "position": { "x": 400, "y": 100 }
      },
      {
        "id": "tab_dynamicFlow",
        "label": "Dynamic Flow Tab",
        "type": "tab",
        "description": "Custom flows (4 enabled: booking_intent, emergency, after_hours, technician_request).",
        "health": "Healthy: Wired to transition_mode.",
        "dependencies": ["scenarios_switchboard"],
        "position": { "x": 500, "y": 200 }
      },
      {
        "id": "dynamicFlows_booking_intent",
        "label": "Booking Intent Flow",
        "type": "flow",
        "description": "Triggers on 'schedule', actions: set_flag, transition_mode.",
        "health": "IMPROVED: Works with V92 consent gating.",
        "dependencies": ["section_discoveryConsent"],
        "position": { "x": 600, "y": 250 }
      },
      {
        "id": "tab_dataConfig",
        "label": "Data & Config Tab",
        "type": "tab",
        "description": "Templates, scenarios, cheat sheets, placeholders.",
        "health": "Yellow: 80% DB coverage; dead configs like cheatSheets not wired.",
        "dependencies": ["activeTemplates_hvac_v1.1"],
        "position": { "x": 700, "y": 100 }
      },
      {
        "id": "activeTemplates_hvac_v1.1",
        "label": "HVAC Template V1.1",
        "type": "template",
        "description": "245 scenarios, 40 categories, 2669 triggers.",
        "health": "Needs Review: 178 not enterprise-ready (low triggers/replies).",
        "dependencies": ["scenarios"],
        "position": { "x": 800, "y": 150 }
      },
      {
        "id": "scenarios",
        "label": "Scenarios (245)",
        "type": "scenario_pool",
        "description": "E.g., Thermostat Not Turning On (EMERGENCY, stopRouting: true).",
        "health": "Healthy: Matching works; consent injection improved.",
        "dependencies": ["scenarios_switchboard"],
        "position": { "x": 900, "y": 200 }
      },
      {
        "id": "scenarios_switchboard",
        "label": "Scenario Switchboard",
        "type": "switchboard",
        "description": "Action types (REPLY_ONLY 245, others 0). Wiring map for types like EMERGENCY → ESCALATE_OR_BOOK.",
        "health": "Underutilized: No REQUIRE_BOOKING or TRANSFER wired; coverage 27% enterprise-ready.",
        "dependencies": ["transfers_directory"],
        "position": { "x": 1000, "y": 250 }
      },
      {
        "id": "tab_callProtection",
        "label": "Call Protection Tab",
        "type": "tab",
        "description": "Frustration/escalation triggers.",
        "health": "Healthy: Wired to escalation (triggerCount: 4).",
        "dependencies": [],
        "position": { "x": 1100, "y": 100 }
      },
      {
        "id": "tab_transferCalls",
        "label": "Transfer Calls Tab",
        "type": "tab",
        "description": "Directory for transfers.",
        "health": "Underutilized: No transfers in logs.",
        "dependencies": ["scenarios_switchboard"],
        "position": { "x": 1200, "y": 200 }
      },
      {
        "id": "transfers_directory",
        "label": "Transfer Directory",
        "type": "directory",
        "description": "Targets for escalation/transfer.",
        "health": "Healthy: Wired but not triggered.",
        "dependencies": [],
        "position": { "x": 1300, "y": 250 }
      },
      {
        "id": "tab_callCenter",
        "label": "Call Center Tab",
        "type": "tab",
        "description": "Call handling configs.",
        "health": "Unknown: Not in logs.",
        "dependencies": [],
        "position": { "x": 1400, "y": 100 }
      },
      {
        "id": "tab_links",
        "label": "Links Tab",
        "type": "tab",
        "description": "External links (e.g., websiteurl).",
        "health": "Healthy: Used in placeholders.",
        "dependencies": ["placeholders"],
        "position": { "x": 1500, "y": 200 }
      },
      {
        "id": "placeholders",
        "label": "Placeholders (11)",
        "type": "placeholder_map",
        "description": "e.g., {companyName}, {websiteurl}. Not configured in dataConfig.placeholders (dead).",
        "health": "Needs Review: Not wired to all responses.",
        "dependencies": [],
        "position": { "x": 1600, "y": 250 }
      },
      {
        "id": "integrations_googleCalendar",
        "label": "Google Calendar Integration",
        "type": "integration",
        "description": "Connected, colorMapping. Not called in logs.",
        "health": "Failing Point: Not wired to time slot step.",
        "dependencies": ["section_bookingPrompts"],
        "position": { "x": 300, "y": 500 }
      },
      {
        "id": "integrations_googleGeo",
        "label": "Google Geo Integration",
        "type": "integration",
        "description": "For address validation. AddressValidationService exists.",
        "health": "WIRED: Called in BookingFlowRunner address step.",
        "dependencies": ["section_bookingPrompts"],
        "position": { "x": 400, "y": 550 }
      },
      {
        "id": "integrations_smsNotifications",
        "label": "SMS Notifications",
        "type": "integration",
        "description": "Enabled, templates. Not used post-booking.",
        "health": "Underutilized: Wire to COMPLETE action.",
        "dependencies": [],
        "position": { "x": 500, "y": 600 }
      },
      {
        "id": "call_start",
        "label": "CALL_START",
        "type": "entry_point",
        "description": "Inbound call entry. Wires to greeting.",
        "health": "Healthy.",
        "dependencies": ["section_greetings"],
        "position": { "x": 0, "y": 0 }
      },
      {
        "id": "guard_emptyUtterance",
        "label": "Empty Utterance Guard",
        "type": "guard",
        "description": "V92: Routes empty/punctuation-only inputs to SilenceHandler instead of LLM. Prevents 'uh,' → ',' from burning 820 tokens on tier3 fallback.",
        "health": "NEW (V92): Saves ~$0.002/call on filler-only utterances.",
        "config": {
          "enabled": "routing.emptyUtteranceGuard.enabled"
        },
        "dependencies": ["silenceHandler"],
        "position": { "x": 150, "y": 50 }
      },
      {
        "id": "detector_directBookingIntent",
        "label": "Direct Booking Intent Detector",
        "type": "detector",
        "description": "V92: Detects 'how soon can you get somebody out here' and similar patterns. Skips consent question and goes directly to booking.",
        "health": "FIXED (V92): Now catches 'get somebody out', 'how soon can you come'.",
        "config": {
          "patterns": "booking.directIntentPatterns"
        },
        "dependencies": ["dynamicFlows_booking_intent"],
        "position": { "x": 350, "y": 350 }
      },
      {
        "id": "booking_complete",
        "label": "BOOKING_COMPLETE",
        "type": "exit_point",
        "description": "End of booking. Should trigger SMS/confirmation.",
        "health": "Needs Review: SMS not wired.",
        "dependencies": ["integrations_smsNotifications"],
        "position": { "x": 1700, "y": 700 }
      }
    ],
    "edges": [
      {
        "id": "e1",
        "source": "call_start",
        "target": "tab_frontDesk",
        "label": "Initial Wiring"
      },
      {
        "id": "e1b",
        "source": "call_start",
        "target": "guard_emptyUtterance",
        "label": "V92: Check for empty/filler input first"
      },
      {
        "id": "e1c",
        "source": "guard_emptyUtterance",
        "target": "section_discoveryConsent",
        "label": "Has real content → Continue routing"
      },
      {
        "id": "e3c",
        "source": "section_discoveryConsent",
        "target": "detector_directBookingIntent",
        "label": "V92: Check for direct booking intent"
      },
      {
        "id": "e3d",
        "source": "detector_directBookingIntent",
        "target": "dynamicFlows_booking_intent",
        "label": "Direct intent detected → Skip consent"
      },
      {
        "id": "e2",
        "source": "tab_frontDesk",
        "target": "section_discoveryConsent",
        "label": "Consent Gating (V92 Fixed)"
      },
      {
        "id": "e3",
        "source": "section_discoveryConsent",
        "target": "section_discoveryClarification",
        "label": "Issue Vague? → Ask Clarification (V92)"
      },
      {
        "id": "e3b",
        "source": "section_discoveryClarification",
        "target": "dynamicFlows_booking_intent",
        "label": "Issue Clear → Trigger Mode Switch"
      },
      {
        "id": "e4",
        "source": "dynamicFlows_booking_intent",
        "target": "section_bookingPrompts",
        "label": "Enter Booking Mode"
      },
      {
        "id": "e5",
        "source": "section_bookingPrompts",
        "target": "slots_name",
        "label": "First Slot (V92: Custom Prompts Wired)"
      },
      {
        "id": "e6",
        "source": "tab_dataConfig",
        "target": "activeTemplates_hvac_v1.1",
        "label": "Load Scenarios"
      },
      {
        "id": "e7",
        "source": "activeTemplates_hvac_v1.1",
        "target": "scenarios",
        "label": "Match Attempt"
      },
      {
        "id": "e8",
        "source": "scenarios",
        "target": "scenarios_switchboard",
        "label": "Action Type (REPLY_ONLY etc.)"
      },
      {
        "id": "e9",
        "source": "scenarios_switchboard",
        "target": "transfers_directory",
        "label": "If TRANSFER"
      },
      {
        "id": "e10",
        "source": "section_bookingPrompts",
        "target": "integrations_googleGeo",
        "label": "Address Validation (WIRED)"
      },
      {
        "id": "e11",
        "source": "section_bookingPrompts",
        "target": "integrations_googleCalendar",
        "label": "Time Slot Check (TODO)"
      },
      {
        "id": "e12",
        "source": "tab_frontDesk",
        "target": "placeholders",
        "label": "Dynamic Values"
      },
      {
        "id": "e13",
        "source": "tab_dynamicFlow",
        "target": "dynamicFlows_booking_intent",
        "label": "Custom Flows"
      },
      {
        "id": "e14",
        "source": "section_bookingPrompts",
        "target": "booking_complete",
        "label": "Complete Booking"
      },
      {
        "id": "e15",
        "source": "booking_complete",
        "target": "integrations_smsNotifications",
        "label": "Send Confirmation (TODO)"
      },
      {
        "id": "e16",
        "source": "tab_callProtection",
        "target": "scenarios_switchboard",
        "label": "Escalation Handling"
      },
      {
        "id": "e17",
        "source": "tab_transferCalls",
        "target": "transfers_directory",
        "label": "Transfer Targets"
      },
      {
        "id": "e18",
        "source": "tab_callCenter",
        "target": "call_start",
        "label": "Call Handling (Loop Back)"
      },
      {
        "id": "e19",
        "source": "tab_links",
        "target": "placeholders",
        "label": "External Links in Responses"
      },
      {
        "id": "e20",
        "source": "tab_frontDesk",
        "target": "section_vocabulary",
        "label": "STT Preprocessing"
      },
      {
        "id": "e21",
        "source": "tab_frontDesk",
        "target": "section_loopPrevention",
        "label": "Silence/Loop Handling"
      },
      {
        "id": "e22",
        "source": "tab_flowTree",
        "target": "tab_dynamicFlow",
        "label": "Visual Builder Integration"
      }
    ]
  }
}
