<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Box Detail | ClientsVia</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-hover: #22222e;
            --border-color: #2a2a38;
            --text-primary: #e5e5e5;
            --text-secondary: #a0a0b0;
            --text-muted: #6b6b7b;
            --accent-red: #ef4444;
            --accent-orange: #f97316;
            --accent-yellow: #eab308;
            --accent-green: #22c55e;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-cyan: #06b6d4;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Navigation */
        .nav-bar {
            background: #000;
            padding: 0 24px;
            display: flex;
            align-items: center;
            height: 56px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-bar a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 16px 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-back {
            background: var(--accent-blue) !important;
            color: white !important;
            border-radius: 6px;
            padding: 8px 16px !important;
            margin-right: auto;
        }

        .nav-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-secondary { background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .btn-danger { background: var(--accent-red); color: white; }

        /* Call Header */
        .call-header {
            padding: 24px 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .call-title {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .call-title h1 {
            font-size: 20px;
            font-family: 'JetBrains Mono', monospace;
        }

        .call-outcome {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .outcome-COMPLETED { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .outcome-TRANSFERRED { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }
        .outcome-HUNG_UP, .outcome-ERROR { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }

        .call-meta {
            display: flex;
            gap: 32px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .call-meta strong { color: var(--text-primary); }

        .call-flags {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .flag-chip {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .flag-loopDetected { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        .flag-bailoutTriggered { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .flag-bookingIgnored { background: rgba(234, 179, 8, 0.2); color: var(--accent-yellow); }
        .flag-slowResponse { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }

        /* Tabs */
        .tabs-bar {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 40px;
        }

        .tab-btn {
            padding: 16px 24px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover { color: var(--text-primary); }
        .tab-btn.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        /* TODO tab with notification dot */
        .tab-btn-todo {
            position: relative;
        }
        .todo-dot {
            position: absolute;
            top: 10px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--accent-red);
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
            display: none;
        }
        .todo-dot.active { display: block; }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        /* Black Box Builder Modals */
        .bb-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .bb-modal-overlay.active { display: flex; }
        .bb-modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .bb-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bb-modal-header h2 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bb-modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }
        .bb-modal-close:hover { color: var(--text-primary); }
        .bb-modal-body { padding: 24px; }
        .bb-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .bb-form-group {
            margin-bottom: 20px;
        }
        .bb-form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .bb-form-input, .bb-form-textarea, .bb-form-select {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }
        .bb-form-input:focus, .bb-form-textarea:focus, .bb-form-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        .bb-form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }
        .bb-form-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .bb-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .bb-btn-primary {
            background: var(--accent-blue);
            color: white;
        }
        .bb-btn-primary:hover { background: #2563eb; }
        .bb-btn-secondary {
            background: var(--bg-hover);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        .bb-btn-secondary:hover { background: var(--bg-card); }
        .bb-btn-success {
            background: var(--accent-green);
            color: white;
        }
        .bb-btn-success:hover { background: #16a34a; }
        .bb-success-message {
            text-align: center;
            padding: 40px 20px;
        }
        .bb-success-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .bb-success-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--accent-green);
        }
        .bb-success-detail {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        .bb-step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        .bb-step {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            background: var(--bg-hover);
            color: var(--text-muted);
        }
        .bb-step.active {
            background: var(--accent-blue);
            color: white;
        }
        .bb-step.completed {
            background: var(--accent-green);
            color: white;
        }
        .bb-step-connector {
            width: 40px;
            height: 2px;
            background: var(--border-color);
            align-self: center;
        }
        .bb-step-connector.completed {
            background: var(--accent-green);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 32px 40px;
            min-height: calc(100vh - 250px);
        }

        .tab-content.active { display: block; }

        /* Overview Tab */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }

        .info-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 24px;
        }

        .info-card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .info-row:last-child { border-bottom: none; }

        .info-label { color: var(--text-secondary); }
        .info-value { 
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .diagnosis-card {
            border-left: 4px solid var(--accent-red);
        }

        .diagnosis-card.warning { border-left-color: var(--accent-orange); }
        .diagnosis-card.info { border-left-color: var(--accent-blue); }
        
        /* üÜï PHASE 2: Source & State styles */
        .source-card {
            border-left: 4px solid var(--accent-purple);
        }
        
        .source-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
        }
        
        .source-voice { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .source-test { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }
        .source-sms { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .source-web { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        
        .mode-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }
        
        .locks-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .lock-item {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
            text-align: center;
        }
        
        .lock-item.active {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
        }
        
        .lock-item.locked {
            background: rgba(234, 179, 8, 0.15);
            color: var(--accent-yellow);
        }
        
        .rolling-summary {
            margin-top: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .rolling-summary strong {
            color: var(--text-primary);
        }

        .diagnosis-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-top: 12px;
        }

        .diagnosis-fix {
            margin-top: 16px;
            padding: 12px;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 6px;
            font-size: 13px;
            color: var(--accent-green);
        }

        /* Sequence Diagram Tab */
        .mermaid-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 32px;
            overflow-x: auto;
        }

        .mermaid {
            display: flex;
            justify-content: center;
        }

        /* Waterfall Tab */
        .waterfall-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .waterfall-turn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }

        .waterfall-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .waterfall-bar {
            position: relative;
            height: 32px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .segment {
            position: absolute;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 4px;
        }

        /* V2: Updated segment colors for new architecture */
        .segment-STT { background: #22d3ee; }
        .segment-Match { background: #22c55e; }  /* Scenario matched - green */
        .segment-Fast { background: #22c55e; }  /* Fast match (legacy) */
        .segment-LLM { background: #f59e0b; }  /* LLM tier3 - orange */
        .segment-Processing { background: #a78bfa; }  /* Generic processing */
        .segment-TTS { background: #ec4899; }
        .segment-slow { background: repeating-linear-gradient(45deg, #f59e0b, #f59e0b 5px, #d97706 5px, #d97706 10px); }
        .segment-failed { background: #ef4444; }
        /* Legacy support */
        .segment-Brain-1 { background: #f59e0b; }
        .segment-Triage { background: #a78bfa; }
        .segment-Brain-2 { background: #3b82f6; }

        .waterfall-legend {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        /* Timeline Tab */
        .timeline-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 24px;
        }

        .timeline-event {
            display: flex;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .timeline-event:last-child { border-bottom: none; }

        .timeline-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--text-muted);
            min-width: 60px;
        }

        .timeline-type {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            min-width: 140px;
            text-align: center;
        }

        /* === V2 Event Type Colors (Jan 2026) === */
        /* Call Lifecycle */
        .type-CALL_START, .type-CALL_END { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        .type-GREETING_SENT { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .type-GATHER_FINAL, .type-GATHER_PARTIAL { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .type-GATHER_TIMEOUT { background: rgba(234, 179, 8, 0.2); color: var(--accent-yellow); }
        
        /* V2: Scenario Matching */
        .type-SCENARIO_MATCH_ATTEMPT { background: rgba(6, 182, 212, 0.2); color: var(--accent-cyan); }
        .type-SCENARIO_MATCHED { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .type-SCENARIO_NO_MATCH { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        .type-TIER3_FALLBACK { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        
        /* Response */
        .type-AGENT_RESPONSE_BUILT { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .type-TURN_COMPLETE { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }
        
        /* State & Routing */
        .type-STATE_LOADED, .type-STATE_SAVED { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        .type-ROUTING_DECISION { background: rgba(6, 182, 212, 0.2); color: var(--accent-cyan); }
        .type-HYBRID_PATH_START, .type-HYBRID_PATH_SUCCESS { background: rgba(6, 182, 212, 0.2); color: var(--accent-cyan); }
        .type-PATH_RESOLVED { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        
        /* Intent & Mode */
        .type-INTENT_DETECTED { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }
        .type-MODE_CHANGED { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        
        /* Booking */
        .type-BOOKING_MODE_LOCKED { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .type-SLOT_COLLECTED, .type-SLOT_ASKING { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .type-BOOKING_COMPLETE { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        
        /* TTS */
        .type-TTS_STARTED, .type-TTS_COMPLETED { background: rgba(236, 72, 153, 0.2); color: var(--accent-pink); }
        .type-TWIML_SENT, .type-GATHER_CONFIGURED { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        
        /* STT */
        .type-STT_PREPROCESSING { background: rgba(6, 182, 212, 0.2); color: var(--accent-cyan); }
        .type-STT_HINTS_LOADED { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        
        /* Errors & Warnings */
        .type-BAILOUT_TRIGGERED { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .type-LOOP_DETECTED { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        .type-CONVERSATION_ENGINE_ERROR { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .type-ERROR_OCCURRED { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        
        /* Transfer & Customer */
        .type-TRANSFER_INITIATED { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }
        .type-CUSTOMER_IDENTIFIED { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        
        /* Legacy Support */
        .type-FAST_MATCH_HIT { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .type-SYNONYM_TRANSLATION { background: rgba(236, 72, 153, 0.2); color: var(--accent-pink); }
        .type-MATCHING_PIPELINE { background: rgba(6, 182, 212, 0.2); color: var(--accent-cyan); }
        .type-LLM_FALLBACK { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        .type-TRIAGE_DECISION { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }

        .timeline-data {
            flex: 1;
            font-size: 13px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Transcript Tab */
        .transcript-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 24px;
        }

        .transcript-turn {
            display: flex;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .transcript-turn:last-child { border-bottom: none; }

        .transcript-speaker {
            font-weight: 600;
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 4px;
            min-width: 80px;
            text-align: center;
        }

        .speaker-caller {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        .speaker-agent {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
        }

        .transcript-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.6;
        }

        .transcript-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 80px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideIn { 
            from { transform: translateX(100%); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           ROADMAP TAB STYLES
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .roadmap-container {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .roadmap-header {
            text-align: center;
            margin-bottom: 32px;
        }
        .roadmap-header h2 {
            font-size: 28px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .roadmap-overall {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 32px;
            border: 1px solid var(--border-color);
        }
        .roadmap-overall-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .roadmap-overall-bar {
            height: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .roadmap-overall-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #f59e0b 50%, #ef4444 100%);
            border-radius: 12px;
            transition: width 0.5s ease;
            position: relative;
        }
        .roadmap-overall-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .roadmap-overall-text {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin-top: 12px;
        }
        .roadmap-phase {
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .roadmap-phase-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.2s;
        }
        .roadmap-phase-header:hover {
            background: var(--bg-hover);
        }
        .roadmap-phase-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .roadmap-phase-icon {
            font-size: 24px;
        }
        .roadmap-phase-name {
            font-size: 18px;
            font-weight: 600;
        }
        .roadmap-phase-meta {
            font-size: 13px;
            color: var(--text-muted);
        }
        .roadmap-phase-progress {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .roadmap-phase-bar {
            width: 120px;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }
        .roadmap-phase-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .roadmap-phase-fill.high { background: var(--accent-green); }
        .roadmap-phase-fill.medium { background: var(--accent-yellow); }
        .roadmap-phase-fill.low { background: var(--accent-red); }
        .roadmap-phase-pct {
            font-size: 14px;
            font-weight: 600;
            min-width: 45px;
            text-align: right;
        }
        .roadmap-items {
            padding: 0 20px 20px;
        }
        .roadmap-item {
            display: grid;
            grid-template-columns: 32px 1fr 100px 80px 80px;
            gap: 16px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .roadmap-item:last-child { border-bottom: none; }
        .roadmap-item-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: var(--bg-secondary);
        }
        .roadmap-item-checkbox:hover {
            border-color: var(--accent-blue);
        }
        .roadmap-item-checkbox.checked {
            background: var(--accent-green);
            border-color: var(--accent-green);
        }
        .roadmap-item-checkbox.partial {
            background: var(--accent-yellow);
            border-color: var(--accent-yellow);
        }
        .roadmap-item-name {
            font-size: 14px;
        }
        .roadmap-item-name.completed {
            color: var(--text-muted);
            text-decoration: line-through;
        }
        .roadmap-item-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            text-align: center;
        }
        .roadmap-item-status.done { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .roadmap-item-status.partial { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .roadmap-item-status.todo { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .roadmap-item-priority {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            text-align: center;
            text-transform: uppercase;
            font-weight: 600;
        }
        .roadmap-item-priority.high { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .roadmap-item-priority.med { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .roadmap-item-priority.low { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .roadmap-item-pct {
            font-size: 14px;
            font-weight: 500;
            text-align: right;
        }
        .roadmap-footer {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 13px;
        }
        .roadmap-footer a {
            color: var(--accent-blue);
            text-decoration: none;
        }
        .roadmap-target {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        .roadmap-target-badge {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-bar">
        <a href="#" class="nav-back" onclick="goBack()">‚Üê Back to List</a>
        <div class="nav-actions">
            <button class="btn btn-secondary" onclick="copySnapshot()">üìã Copy for Engineering</button>
            <button class="btn btn-secondary" onclick="exportJSON()">üì• Export JSON</button>
        </div>
    </nav>

    <!-- Call Header -->
    <div class="call-header" id="callHeader">
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading recording...</p>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-bar">
        <button class="tab-btn active" data-tab="overview">Overview</button>
        <button class="tab-btn" data-tab="sequence">Sequence Diagram</button>
        <button class="tab-btn" data-tab="waterfall">Waterfall</button>
        <button class="tab-btn" data-tab="decision">Decision Tree</button>
        <button class="tab-btn" data-tab="timeline">Timeline</button>
        <button class="tab-btn" data-tab="transcript">Transcript</button>
        <button class="tab-btn" data-tab="raw" style="color: #f97316;">Raw Events</button>
        <button class="tab-btn tab-btn-todo" data-tab="todo">
            üìã TODO
            <span class="todo-dot" id="todoDot"></span>
        </button>
        <button class="tab-btn" data-tab="sttAnalysis" style="color: #10b981;">
            üéôÔ∏è STT Analysis
        </button>
        <button class="tab-btn" data-tab="roadmap" style="color: #f59e0b;">
            üöÄ Roadmap
        </button>
    </div>

    <!-- Tab Content -->
    <div id="tabOverview" class="tab-content active"></div>
    <div id="tabSequence" class="tab-content"></div>
    <div id="tabWaterfall" class="tab-content"></div>
    <div id="tabDecision" class="tab-content"></div>
    <div id="tabTimeline" class="tab-content"></div>
    <div id="tabTranscript" class="tab-content"></div>
    <div id="tabRaw" class="tab-content"></div>
    <div id="tabTodo" class="tab-content"></div>
    <div id="tabSttAnalysis" class="tab-content"></div>
    <div id="tabRoadmap" class="tab-content"></div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let companyId = null;
        let callId = null;
        let recording = null;
        let snapshot = null;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INITIALIZATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'dark',
            themeVariables: {
                primaryColor: '#3b82f6',
                primaryTextColor: '#e5e5e5',
                primaryBorderColor: '#2a2a38',
                lineColor: '#6b6b7b',
                secondaryColor: '#1a1a24',
                tertiaryColor: '#12121a'
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            companyId = params.get('companyId');
            callId = params.get('callId');

            if (!companyId || !callId) {
                showError('Missing companyId or callId');
                return;
            }

            await loadRecording();
            setupTabs();
        });

        function goBack() {
            window.location.href = `black-box.html?companyId=${companyId}`;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DATA LOADING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadRecording() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/company/${companyId}/blackbox/call/${callId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load recording');

                const data = await response.json();
                
                if (data.success) {
                    recording = data.recording;
                    snapshot = data.snapshot;
                    renderAll();
                }
            } catch (error) {
                console.error('Failed to load recording:', error);
                showError('Failed to load recording: ' + error.message);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RENDERING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderAll() {
            renderHeader();
            renderOverview();
            renderSequenceDiagram();
            renderWaterfall();
            renderDecisionTree();
            renderTimeline();
            renderTranscript();
            renderRawEvents();
            renderTodo();
            renderSttAnalysis();
            renderRoadmap();
        }

        function renderHeader() {
            const startDate = new Date(recording.startedAt);
            const duration = recording.durationMs ? formatDuration(recording.durationMs) : '-';
            
            const flags = [];
            if (recording.flags?.loopDetected) flags.push({ key: 'loopDetected', label: 'üîÑ LOOP' });
            if (recording.flags?.bailoutTriggered) flags.push({ key: 'bailoutTriggered', label: 'üö® BAILOUT' });
            if (recording.flags?.bookingIgnored) flags.push({ key: 'bookingIgnored', label: 'üìÖ BOOKING IGNORED' });
            if (recording.flags?.slowResponse) flags.push({ key: 'slowResponse', label: 'üê¢ SLOW' });

            document.getElementById('callHeader').innerHTML = `
                <div class="call-title">
                    <h1>üìº ${recording.callId}</h1>
                    <span class="call-outcome outcome-${recording.callOutcome}">${recording.callOutcome}</span>
                </div>
                <div class="call-meta">
                    <span>üìû <strong>${formatPhone(recording.from)}</strong> ‚Üí <strong>${formatPhone(recording.to)}</strong></span>
                    <span>üìÖ ${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString()}</span>
                    <span>‚è±Ô∏è ${duration}</span>
                    <span>üîÑ ${recording.performance?.totalTurns || 0} turns</span>
                </div>
                ${flags.length > 0 ? `
                    <div class="call-flags">
                        ${flags.map(f => `<span class="flag-chip flag-${f.key}">${f.label}</span>`).join('')}
                    </div>
                ` : ''}
            `;
        }

        function renderOverview() {
            const booking = recording.booking || {};
            const perf = recording.performance || {};
            const diag = recording.diagnosis || {};
            const snapshot = recording.sessionSnapshot || {};
            const locks = snapshot.locks || {};

            document.getElementById('tabOverview').innerHTML = `
                <div class="overview-grid">
                    <!-- üÜï PHASE 2: Source & State Card -->
                    <div class="info-card source-card">
                        <h3>üì° Source & State</h3>
                        <div class="info-row">
                            <span class="info-label">Source</span>
                            <span class="info-value source-badge source-${recording.source || 'voice'}">${(recording.source || 'voice').toUpperCase()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Mode</span>
                            <span class="info-value mode-badge">${snapshot.mode || 'DISCOVERY'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phase</span>
                            <span class="info-value">${snapshot.phase || 'greeting'}</span>
                        </div>
                        <div class="locks-grid">
                            <span class="lock-item ${locks.greeted ? 'active' : ''}">‚úì Greeted</span>
                            <span class="lock-item ${locks.issueCaptured ? 'active' : ''}">‚úì Issue</span>
                            <span class="lock-item ${locks.bookingStarted ? 'active' : ''}">‚úì Booking</span>
                            <span class="lock-item ${locks.bookingLocked ? 'locked' : ''}">üîí Locked</span>
                        </div>
                        ${snapshot.memory?.rollingSummary ? `
                            <div class="rolling-summary">
                                <strong>Summary:</strong> ${snapshot.memory.rollingSummary}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="info-card">
                        <h3>üéØ Intent & Booking</h3>
                        <div class="info-row">
                            <span class="info-label">Primary Intent</span>
                            <span class="info-value">${recording.primaryIntent || 'unknown'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Confidence</span>
                            <span class="info-value">${recording.primaryIntentConfidence ? (recording.primaryIntentConfidence * 100).toFixed(0) + '%' : '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">First Booking Intent</span>
                            <span class="info-value">${booking.firstIntentDetectedAtMs ? (booking.firstIntentDetectedAtMs / 1000).toFixed(1) + 's' : 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Intent Locked At</span>
                            <span class="info-value">${booking.intentLockedAtMs ? (booking.intentLockedAtMs / 1000).toFixed(1) + 's' : 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Questions Before Lock</span>
                            <span class="info-value">${booking.questionsAskedBeforeLock || 0}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Booking Completed</span>
                            <span class="info-value">${booking.completed ? '‚úÖ Yes' : '‚ùå No'}</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3>‚ö° Performance</h3>
                        <div class="info-row">
                            <span class="info-label">Total Turns</span>
                            <span class="info-value">${perf.totalTurns || 0}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Avg Turn Time</span>
                            <span class="info-value">${perf.avgTurnTimeMs ? (perf.avgTurnTimeMs / 1000).toFixed(1) + 's' : '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Slowest Turn</span>
                            <span class="info-value">#${perf.slowestTurn?.turnNumber || '?'} (${perf.slowestTurn?.totalMs || 0}ms)</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Bottleneck</span>
                            <span class="info-value">${perf.slowestTurn?.bottleneck || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">LLM Calls</span>
                            <span class="info-value">${perf.llmCalls?.count || 0} (${((perf.llmCalls?.totalMs || 0) / 1000).toFixed(1)}s)</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">TTS Total</span>
                            <span class="info-value">${((perf.ttsTotalMs || 0) / 1000).toFixed(1)}s</span>
                        </div>
                    </div>

                    <div class="info-card diagnosis-card ${diag.severity?.toLowerCase() || 'info'}">
                        <h3>üîç Diagnosis</h3>
                        <div class="info-row">
                            <span class="info-label">Primary Bottleneck</span>
                            <span class="info-value">${diag.primaryBottleneck || 'NONE'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Severity</span>
                            <span class="info-value">${diag.severity || 'INFO'}</span>
                        </div>
                        ${diag.rootCause ? `<p class="diagnosis-text">${diag.rootCause}</p>` : ''}
                        ${diag.suggestedFix ? `<div class="diagnosis-fix">üí° <strong>Fix:</strong> ${diag.suggestedFix}</div>` : ''}
                    </div>

                    <div class="info-card">
                        <h3>üë§ Customer</h3>
                        <div class="info-row">
                            <span class="info-label">Returning</span>
                            <span class="info-value">${recording.customerContext?.isReturning ? '‚úÖ Yes' : '‚ùå No'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Calls</span>
                            <span class="info-value">${recording.customerContext?.totalCalls || 1}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Name</span>
                            <span class="info-value">${recording.customerContext?.customerName || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CLIENT-SIDE VISUALIZATION GENERATORS (fallback for older recordings)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // V2 VISUALIZATION (Updated Jan 2026 for new architecture)
        // - Brain-1/Brain-2 ‚Üí ConversationEngine
        // - Triage ‚Üí ScenarioMatcher
        // - FAST_MATCH_HIT ‚Üí SCENARIO_MATCHED
        // - LLM_FALLBACK ‚Üí TIER3_FALLBACK
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function generateSequenceDiagramFromEvents(events) {
            if (!events || events.length === 0) return null;
            
            let mermaid = `sequenceDiagram
    participant C as Caller
    participant T as Twilio
    participant CE as ConversationEngine
    participant SM as ScenarioMatcher
    participant LLM as LLM (Tier3)
    participant TTS as TTS
`;
            
            for (const event of events) {
                const time = `${((event.t || 0) / 1000).toFixed(0)}s`;
                const truncText = (text, len) => text ? (text.length > len ? text.substring(0, len) + '...' : text) : '';
                
                switch (event.type) {
                    case 'CALL_START':
                        mermaid += `    Note over C,TTS: CALL START\n`;
                        break;
                    case 'GREETING_SENT':
                        mermaid += `    TTS-->>C: ${time} Greeting\n`;
                        break;
                    case 'GATHER_FINAL':
                        mermaid += `    C->>T: ${time} "${truncText(event.data?.text, 25)}"\n`;
                        mermaid += `    T->>CE: Process\n`;
                        break;
                    case 'STT_PREPROCESSING':
                        const fillers = event.data?.fillersRemoved?.length || 0;
                        if (fillers > 0) {
                            mermaid += `    Note over T: üîá ${fillers} fillers removed\n`;
                        }
                        break;
                    case 'SCENARIO_MATCH_ATTEMPT':
                        const scenCount = event.data?.scenariosChecked || '?';
                        mermaid += `    CE->>SM: Check ${scenCount} scenarios\n`;
                        break;
                    case 'SCENARIO_MATCHED':
                        const scenario = truncText(event.data?.scenarioName || '?', 20);
                        const tier = event.data?.tier || 'tier1';
                        mermaid += `    SM->>CE: ‚úÖ ${tier.toUpperCase()}: ${scenario}\n`;
                        break;
                    case 'TIER3_FALLBACK':
                        mermaid += `    SM->>LLM: ‚ö†Ô∏è No match - LLM fallback\n`;
                        mermaid += `    LLM->>CE: Response (${event.data?.latencyMs || '?'}ms)\n`;
                        break;
                    // Legacy support for old event types
                    case 'FAST_MATCH_HIT':
                        mermaid += `    CE->>SM: ‚úÖ Fast Match (legacy)\n`;
                        break;
                    case 'LLM_FALLBACK':
                        mermaid += `    Note over CE: ‚ö†Ô∏è LLM Fallback (legacy)\n`;
                        break;
                    case 'TRIAGE_DECISION':
                        mermaid += `    SM->>CE: Route: ${event.data?.route || 'MESSAGE_ONLY'}\n`;
                        break;
                    case 'INTENT_DETECTED':
                        mermaid += `    Note over CE: Intent: ${event.data?.intent || '?'}\n`;
                        break;
                    case 'MODE_CHANGED':
                        mermaid += `    Note over CE: Mode: ${event.data?.toMode || '?'}\n`;
                        break;
                    case 'AGENT_RESPONSE_BUILT':
                        const source = event.data?.source || 'unknown';
                        mermaid += `    CE->>TTS: Response (${source})\n`;
                        break;
                    case 'TTS_COMPLETED':
                        mermaid += `    TTS-->>C: ${time} Audio\n`;
                        break;
                    case 'BOOKING_MODE_LOCKED':
                        mermaid += `    Note over CE: üìÖ BOOKING LOCKED\n`;
                        break;
                    case 'SLOT_COLLECTED':
                        mermaid += `    Note over CE: ‚úÖ ${event.data?.slot}: ${truncText(event.data?.value, 15)}\n`;
                        break;
                    case 'LOOP_DETECTED':
                        mermaid += `    Note over CE: üîÑ LOOP DETECTED\n`;
                        break;
                    case 'BAILOUT_TRIGGERED':
                        mermaid += `    Note over CE: üö® BAILOUT\n`;
                        break;
                    case 'TRANSFER_INITIATED':
                        mermaid += `    CE->>T: üìû TRANSFER\n`;
                        break;
                    case 'CONVERSATION_ENGINE_ERROR':
                        mermaid += `    Note over CE: ‚ùå ERROR\n`;
                        break;
                }
            }
            
            mermaid += `    Note over C,TTS: CALL END`;
            return mermaid;
        }
        
        function generateDecisionTreeFromEvents(events) {
            if (!events || events.length === 0) return null;
            
            // V2: Support both new and legacy event types
            const scenarioMatch = events.find(e => e.type === 'SCENARIO_MATCHED');
            const tier3Fallback = events.find(e => e.type === 'TIER3_FALLBACK');
            const fastMatch = events.find(e => e.type === 'FAST_MATCH_HIT'); // Legacy
            const llmFallback = events.find(e => e.type === 'LLM_FALLBACK'); // Legacy
            const intentDetected = events.find(e => e.type === 'INTENT_DETECTED');
            const bookingLocked = events.find(e => e.type === 'BOOKING_MODE_LOCKED');
            const bookingActivated = events.find(e => e.type === 'BOOKING_MODE_ACTIVATED'); // Legacy
            const bailout = events.find(e => e.type === 'BAILOUT_TRIGGERED');
            const transfer = events.find(e => e.type === 'TRANSFER_INITIATED');
            const agentResponse = events.find(e => e.type === 'AGENT_RESPONSE_BUILT');
            
            // Sanitize text for Mermaid - remove special chars that break parsing
            const sanitize = (str) => (str || '?').replace(/["\[\]{}|<>]/g, '').substring(0, 30);
            
            // Build a simple linear flowchart that's always valid
            let lines = [];
            lines.push('flowchart TD');
            lines.push('    A[Caller Input]');
            
            let lastNode = 'A';
            let nodeId = 0;
            const nextNode = () => 'N' + (++nodeId);
            
            // V2: Scenario matching with tier info
            if (scenarioMatch) {
                const n = nextNode();
                const tier = scenarioMatch.data?.tier || 'tier1';
                const name = sanitize(scenarioMatch.data?.scenarioName || 'Matched');
                lines.push(`    ${lastNode} --> ${n}[${tier.toUpperCase()}: ${name}]`);
                lines.push(`    style ${n} fill:#22c55e,color:#fff`);
                lastNode = n;
            } else if (tier3Fallback || llmFallback) {
                const n = nextNode();
                lines.push(`    ${lastNode} --> ${n}[LLM Tier-3 Fallback]`);
                lines.push(`    style ${n} fill:#f59e0b,color:#000`);
                lastNode = n;
            } else if (fastMatch) {
                // Legacy support
                const n = nextNode();
                lines.push(`    ${lastNode} --> ${n}[Fast Match (legacy)]`);
                lines.push(`    style ${n} fill:#22c55e,color:#fff`);
                lastNode = n;
            } else {
                const n = nextNode();
                lines.push(`    ${lastNode} --> ${n}[Processing]`);
                lastNode = n;
            }
            
            // Intent detection
            if (intentDetected) {
                const n = nextNode();
                const intent = sanitize(intentDetected.data?.intent);
                lines.push(`    ${lastNode} --> ${n}[Intent: ${intent}]`);
                lastNode = n;
            }
            
            // V2: Booking locked (replaces booking activated)
            if (bookingLocked || bookingActivated) {
                const n = nextNode();
                lines.push(`    ${lastNode} --> ${n}[üìÖ Booking Locked]`);
                lines.push(`    style ${n} fill:#3b82f6,color:#fff`);
                lastNode = n;
            }
            
            // Loop detected
            if (recording.flags?.loopDetected) {
                const n = nextNode();
                lines.push(`    ${lastNode} --> ${n}[üîÑ LOOP DETECTED]`);
                lines.push(`    style ${n} fill:#f97316,color:#fff`);
                lastNode = n;
            }
            
            // Bailout
            if (bailout) {
                const n = nextNode();
                const reason = sanitize(bailout.data?.reason || '');
                lines.push(`    ${lastNode} --> ${n}[üö® BAILOUT${reason ? ': ' + reason : ''}]`);
                lines.push(`    style ${n} fill:#ef4444,color:#fff`);
                lastNode = n;
            }
            
            // Transfer
            if (transfer) {
                const n = nextNode();
                lines.push(`    ${lastNode} --> ${n}[üìû TRANSFER]`);
                lines.push(`    style ${n} fill:#8b5cf6,color:#fff`);
                lastNode = n;
            }
            
            // Final response - show response source if available
            if (agentResponse && !bailout && !transfer) {
                const n = nextNode();
                const source = agentResponse.data?.source || 'Response';
                lines.push(`    ${lastNode} --> ${n}[‚úÖ ${sanitize(source)}]`);
                lines.push(`    style ${n} fill:#10b981,color:#fff`);
            }
            
            return lines.join('\n');
        }
        
        function generateWaterfallFromEvents(events) {
            if (!events || events.length === 0) return [];
            
            const waterfall = [];
            const gatherEvents = events.filter(e => e.type === 'GATHER_FINAL');
            
            gatherEvents.forEach((gatherEvent, index) => {
                const turn = index + 1;
                const turnStart = gatherEvent.t || 0;
                
                // Find next gather or end of events
                const nextGather = gatherEvents[index + 1];
                const turnEnd = nextGather ? nextGather.t : (events[events.length - 1]?.t || turnStart + 5000);
                
                const turnEvents = events.filter(e => (e.t || 0) >= turnStart && (e.t || 0) < turnEnd);
                
                const segments = [];
                let currentOffset = 0;
                
                // STT segment
                segments.push({
                    name: 'STT',
                    startMs: currentOffset,
                    durationMs: 300,
                    status: 'ok',
                    detail: `Speech received`
                });
                currentOffset += 300;
                
                // V2: Scenario Matching segment (replaces Brain-1)
                const scenarioMatch = turnEvents.find(e => e.type === 'SCENARIO_MATCHED');
                const tier3Fallback = turnEvents.find(e => e.type === 'TIER3_FALLBACK');
                const fastMatch = turnEvents.find(e => e.type === 'FAST_MATCH_HIT'); // Legacy
                const llmResponse = turnEvents.find(e => e.type === 'LLM_RESPONSE'); // Legacy
                
                if (scenarioMatch) {
                    const tier = scenarioMatch.data?.tier || 'tier1';
                    const ms = scenarioMatch.data?.latencyMs || 50;
                    segments.push({
                        name: `Match (${tier})`,
                        startMs: currentOffset,
                        durationMs: ms,
                        status: 'ok',
                        detail: scenarioMatch.data?.scenarioName || 'Scenario matched'
                    });
                    currentOffset += ms;
                } else if (tier3Fallback) {
                    const llmMs = tier3Fallback.data?.latencyMs || 2000;
                    segments.push({
                        name: 'LLM (tier3)',
                        startMs: currentOffset,
                        durationMs: llmMs,
                        status: llmMs > 3000 ? 'slow' : 'ok',
                        detail: `LLM fallback: ${llmMs}ms`
                    });
                    currentOffset += llmMs;
                } else if (fastMatch) {
                    // Legacy support
                    segments.push({
                        name: 'Fast Match',
                        startMs: currentOffset,
                        durationMs: 50,
                        status: 'ok',
                        detail: 'Fast match (legacy)'
                    });
                    currentOffset += 50;
                } else if (llmResponse) {
                    // Legacy support
                    const llmMs = llmResponse.data?.ms || 2000;
                    segments.push({
                        name: 'LLM',
                        startMs: currentOffset,
                        durationMs: llmMs,
                        status: llmMs > 3000 ? 'slow' : 'ok',
                        detail: `LLM: ${llmMs}ms`
                    });
                    currentOffset += llmMs;
                } else {
                    // Check for response to estimate processing time
                    const response = turnEvents.find(e => e.type === 'AGENT_RESPONSE_BUILT');
                    const estimatedMs = response ? Math.max(50, (response.t || 0) - (turnStart + 300)) : 500;
                    segments.push({
                        name: 'Processing',
                        startMs: currentOffset,
                        durationMs: Math.min(estimatedMs, 3000),
                        status: estimatedMs > 3000 ? 'slow' : 'ok',
                        detail: `ConversationEngine: ~${Math.round(estimatedMs)}ms`
                    });
                    currentOffset += Math.min(estimatedMs, 3000);
                }
                
                // TTS segment (V2: use TTS_COMPLETED)
                const tts = turnEvents.find(e => e.type === 'TTS_COMPLETED') || 
                            turnEvents.find(e => e.type === 'TTS_GENERATED'); // Legacy
                if (tts) {
                    const ttsMs = tts.data?.latencyMs || tts.data?.ms || 400;
                    segments.push({
                        name: 'TTS',
                        startMs: currentOffset,
                        durationMs: ttsMs,
                        status: ttsMs > 2000 ? 'slow' : 'ok',
                        detail: `TTS: ${ttsMs}ms`
                    });
                    currentOffset += ttsMs;
                }
                
                waterfall.push({
                    turn,
                    totalMs: currentOffset,
                    segments
                });
            });
            
            return waterfall;
        }

        async function renderSequenceDiagram() {
            const container = document.getElementById('tabSequence');
            let diagram = recording.visualization?.sequenceDiagram;
            
            // Fallback: generate from events if not stored
            if (!diagram && recording.events?.length > 0) {
                diagram = generateSequenceDiagramFromEvents(recording.events);
            }
            
            if (!diagram) {
                container.innerHTML = '<div class="loading-state"><p>No sequence diagram available (no events recorded)</p></div>';
                return;
            }

            container.innerHTML = `<div class="mermaid-container"><div class="mermaid">${diagram}</div></div>`;
            
            try {
                await mermaid.run();
            } catch (e) {
                console.error('Mermaid render error:', e);
                container.innerHTML = `<div class="loading-state"><p>Diagram render error. Raw Mermaid:</p><pre style="text-align:left;font-size:11px;overflow:auto;max-height:400px;">${diagram}</pre></div>`;
            }
        }

        function renderWaterfall() {
            const container = document.getElementById('tabWaterfall');
            let waterfall = recording.visualization?.waterfall;
            
            // Fallback: generate from events if not stored
            if ((!waterfall || waterfall.length === 0) && recording.events?.length > 0) {
                waterfall = generateWaterfallFromEvents(recording.events);
            }
            
            if (!waterfall || waterfall.length === 0) {
                container.innerHTML = '<div class="loading-state"><p>No waterfall data available (no turns recorded)</p></div>';
                return;
            }

            let html = '<div class="waterfall-container">';
            
            for (const turn of waterfall) {
                const maxMs = Math.max(...turn.segments.map(s => s.startMs + s.durationMs), 1);
                
                html += `
                    <div class="waterfall-turn">
                        <div class="waterfall-header">
                            <span><strong>Turn ${turn.turn}</strong></span>
                            <span>Total: ${(turn.totalMs / 1000).toFixed(1)}s</span>
                        </div>
                        <div class="waterfall-bar">
                            ${turn.segments.map(seg => {
                                const left = (seg.startMs / maxMs) * 100;
                                const width = Math.max((seg.durationMs / maxMs) * 100, 5); // min 5% width
                                const statusClass = seg.status === 'slow' ? 'segment-slow' : 
                                                   seg.status === 'failed' ? 'segment-failed' : 
                                                   `segment-${seg.name.split(' ')[0]}`;
                                return `<div class="segment ${statusClass}" 
                                            style="left: ${left}%; width: ${width}%;" 
                                            title="${seg.name}: ${seg.durationMs}ms - ${seg.detail || ''}">${seg.name}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += `
                <div class="waterfall-legend">
                    <div class="legend-item"><div class="legend-color" style="background: #22d3ee;"></div> STT</div>
                    <div class="legend-item"><div class="legend-color" style="background: #22c55e;"></div> Scenario Match (Free)</div>
                    <div class="legend-item"><div class="legend-color" style="background: #f59e0b;"></div> LLM Tier-3 ($)</div>
                    <div class="legend-item"><div class="legend-color" style="background: #a78bfa;"></div> Processing</div>
                    <div class="legend-item"><div class="legend-color" style="background: #ec4899;"></div> TTS</div>
                </div>
            </div>`;
            
            container.innerHTML = html;
        }

        async function renderDecisionTree() {
            const container = document.getElementById('tabDecision');
            let diagram = recording.visualization?.decisionTree;
            
            // Fallback: generate from events if not stored
            if (!diagram && recording.events?.length > 0) {
                diagram = generateDecisionTreeFromEvents(recording.events);
            }
            
            if (!diagram) {
                container.innerHTML = '<div class="loading-state"><p>No decision tree available (no events recorded)</p></div>';
                return;
            }

            container.innerHTML = `<div class="mermaid-container"><div class="mermaid">${diagram}</div></div>`;
            
            try {
                await mermaid.run();
            } catch (e) {
                console.error('Mermaid render error:', e);
                container.innerHTML = `<div class="loading-state"><p>Diagram render error. Raw Mermaid:</p><pre style="text-align:left;font-size:11px;overflow:auto;max-height:400px;">${diagram}</pre></div>`;
            }
        }

        function renderTimeline() {
            const container = document.getElementById('tabTimeline');
            const events = recording.events || [];
            
            if (events.length === 0) {
                container.innerHTML = '<div class="loading-state"><p>No timeline events available</p></div>';
                return;
            }

            container.innerHTML = `
                <div class="timeline-container">
                    ${events.map(event => `
                        <div class="timeline-event">
                            <span class="timeline-time">${formatTime(event.t || 0)}</span>
                            <span class="timeline-type type-${event.type}">${event.type}</span>
                            <span class="timeline-data">${formatEventData(event)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderTranscript() {
            const container = document.getElementById('tabTranscript');
            const callerTurns = recording.transcript?.callerTurns || [];
            const agentTurns = recording.transcript?.agentTurns || [];
            
            // Merge and sort by time
            const allTurns = [
                ...callerTurns.map(t => ({ ...t, speaker: 'caller' })),
                ...agentTurns.map(t => ({ ...t, speaker: 'agent' }))
            ].sort((a, b) => (a.t || 0) - (b.t || 0));
            
            if (allTurns.length === 0) {
                container.innerHTML = '<div class="loading-state"><p>No transcript available</p></div>';
                return;
            }

            container.innerHTML = `
                <div class="transcript-container">
                    ${allTurns.map(turn => `
                        <div class="transcript-turn">
                            <span class="transcript-speaker speaker-${turn.speaker}">${turn.speaker === 'caller' ? 'üë§ Caller' : 'ü§ñ Agent'}</span>
                            <div class="transcript-text">
                                "${turn.text}"
                                <div class="transcript-meta">
                                    Turn ${turn.turn} ‚Ä¢ ${formatTime(turn.t || 0)}
                                    ${turn.confidence ? ` ‚Ä¢ Confidence: ${(turn.confidence * 100).toFixed(0)}%` : ''}
                                    ${turn.source ? ` ‚Ä¢ Source: ${turn.source}` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderRawEvents() {
            const container = document.getElementById('tabRaw');
            const events = recording.events || [];
            
            if (events.length === 0) {
                container.innerHTML = '<div class="loading-state"><p>No raw events available</p></div>';
                return;
            }
            
            // JSON syntax highlighting
            function syntaxHighlight(json) {
                if (typeof json !== 'string') {
                    json = JSON.stringify(json, null, 2);
                }
                return json
                    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                        let cls = 'json-number';
                        if (/^"/.test(match)) {
                            if (/:$/.test(match)) {
                                cls = 'json-key';
                            } else {
                                cls = 'json-string';
                            }
                        } else if (/true|false/.test(match)) {
                            cls = 'json-boolean';
                        } else if (/null/.test(match)) {
                            cls = 'json-null';
                        }
                        return '<span class="' + cls + '">' + match + '</span>';
                    });
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center;">
                    <button onclick="copyRawEvents()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                        üìã Copy All Events
                    </button>
                    <span style="color: #94a3b8; font-size: 13px;">${events.length} events</span>
                </div>
                <div style="background: #0f172a; border-radius: 8px; padding: 16px; overflow: auto; max-height: 600px;">
                    <style>
                        .json-key { color: #93c5fd; }
                        .json-string { color: #86efac; }
                        .json-number { color: #fde68a; }
                        .json-boolean { color: #f472b6; }
                        .json-null { color: #f87171; }
                        .event-block { 
                            border-left: 3px solid #334155; 
                            padding-left: 12px; 
                            margin-bottom: 8px;
                            font-family: 'JetBrains Mono', 'Fira Code', 'Monaco', monospace;
                            font-size: 12px;
                            line-height: 1.5;
                        }
                        .event-block:hover { border-left-color: #f97316; background: rgba(249, 115, 22, 0.05); }
                    </style>
                    ${events.map((event, idx) => `
                        <div class="event-block">
                            <pre style="margin: 0; white-space: pre-wrap; word-break: break-all;">${syntaxHighlight(event)}</pre>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function copyRawEvents() {
            const events = recording.events || [];
            const json = JSON.stringify(events, null, 2);
            navigator.clipboard.writeText(json).then(() => {
                alert('‚úÖ Raw events copied to clipboard!');
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TODO TAB - Coverage Gap Analysis
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function analyzeCoverageGaps() {
            const events = recording.events || [];
            const gaps = [];
            
            // Find all GATHER_FINAL events (caller utterances)
            const callerUtterances = events.filter(e => e.type === 'GATHER_FINAL');
            
            for (const utterance of callerUtterances) {
                const text = utterance.data?.text || '';
                const turn = utterance.turn || 0;
                
                // Find events that happened after this utterance for this turn
                const turnEvents = events.filter(e => 
                    e.t >= utterance.t && 
                    e.t <= (utterance.t + 10000) // Within 10 seconds
                );
                
                // Check if this hit LLM fallback (no fast match)
                const llmFallback = turnEvents.find(e => e.type === 'LLM_FALLBACK');
                const fastMatch = turnEvents.find(e => e.type === 'FAST_MATCH_HIT');
                const triageDecision = turnEvents.find(e => e.type === 'TRIAGE_DECISION');
                const loopDetected = turnEvents.find(e => e.type === 'LOOP_DETECTED');
                const llmResponse = turnEvents.find(e => e.type === 'LLM_RESPONSE');
                
                const gap = {
                    text,
                    turn,
                    issues: [],
                    suggestions: {}
                };
                
                // Issue 1: No fast match (hit LLM)
                if (llmFallback && !fastMatch) {
                    gap.issues.push({
                        type: 'NO_FAST_MATCH',
                        severity: 'warning',
                        description: 'No fast match - used LLM fallback',
                        costImpact: `~$${(llmResponse?.data?.ms || 5000) / 1000 * 0.01} per call`
                    });
                    
                    // Extract suggested keywords from the utterance
                    const keywords = extractKeywords(text);
                    gap.suggestions.keywords = keywords;
                }
                
                // Issue 2: Triage didn't match a card
                if (triageDecision && !triageDecision.data?.matched) {
                    gap.issues.push({
                        type: 'NO_TRIAGE_MATCH',
                        severity: 'error',
                        description: 'No triage card matched this intent',
                        cardSuggested: generateCardSuggestion(text, triageDecision.data?.intentTag)
                    });
                }
                
                // Issue 3: Loop detected
                if (loopDetected) {
                    gap.issues.push({
                        type: 'LOOP_DETECTED',
                        severity: 'critical',
                        description: 'Response looped - caller heard same thing twice'
                    });
                }
                
                // Issue 4: Booking intent but not handled
                const intentDetected = turnEvents.find(e => e.type === 'INTENT_DETECTED');
                const bookingActivated = turnEvents.find(e => e.type === 'BOOKING_MODE_ACTIVATED');
                if (intentDetected?.data?.intent === 'booking' && !bookingActivated) {
                    gap.issues.push({
                        type: 'BOOKING_NOT_HANDLED',
                        severity: 'critical',
                        description: 'Booking intent detected but booking flow not activated'
                    });
                }
                
                if (gap.issues.length > 0) {
                    gaps.push(gap);
                }
            }
            
            return gaps;
        }
        
        function extractKeywords(text) {
            // Common stop words to ignore
            const stopWords = ['i', 'me', 'my', 'we', 'our', 'you', 'your', 'a', 'an', 'the', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can', 'to', 'of', 'in', 'for', 'on', 'with', 'at', 'by', 'from', 'as', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'up', 'down', 'out', 'off', 'over', 'under', 'again', 'further', 'then', 'once', 'here', 'there', 'when', 'where', 'why', 'how', 'all', 'each', 'few', 'more', 'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'than', 'too', 'very', 'just', 'and', 'but', 'if', 'or', 'because', 'as', 'until', 'while', 'it', 'its', 'this', 'that', 'these', 'those', 'am', 'what', 'which', 'who', 'whom', 'need', 'want', 'like', 'think', 'know', 'yeah', 'yes', 'no', 'ok', 'okay', 'um', 'uh', 'well', 'dont', "don't"];
            
            const words = text.toLowerCase()
                .replace(/[^\w\s]/g, ' ')
                .split(/\s+/)
                .filter(w => w.length > 2 && !stopWords.includes(w));
            
            // Deduplicate and return
            return [...new Set(words)];
        }
        
        function generateCardSuggestion(text, intentTag) {
            const lowerText = text.toLowerCase();
            
            // Detect common patterns
            if (lowerText.includes('schedule') || lowerText.includes('book') || lowerText.includes('appointment')) {
                return {
                    name: 'Service Appointment Request',
                    triageTag: 'BOOKING_SERVICE_APPOINTMENT',
                    category: 'booking',
                    action: 'BOOK',
                    openingLine: "I'd be happy to schedule that for you."
                };
            }
            
            if (lowerText.includes('thermostat') && (lowerText.includes('blank') || lowerText.includes('not working'))) {
                return {
                    name: 'Thermostat Issue',
                    triageTag: 'THERMOSTAT_ISSUE',
                    category: 'troubleshooting',
                    action: 'ASK_FOLLOWUP',
                    openingLine: "I can help with your thermostat issue."
                };
            }
            
            if (lowerText.includes('ac') || lowerText.includes('air condition') || lowerText.includes('cooling')) {
                return {
                    name: 'AC Service Request',
                    triageTag: 'AC_SERVICE_REQUEST',
                    category: 'service',
                    action: 'ASK_FOLLOWUP',
                    openingLine: "I can help with your AC service needs."
                };
            }
            
            // Generic fallback
            const keywords = extractKeywords(text);
            const tagName = keywords.slice(0, 3).join('_').toUpperCase() || 'NEW_CARD';
            return {
                name: `${keywords.slice(0, 3).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')} Inquiry`,
                triageTag: tagName,
                category: 'general',
                action: 'ASK_FOLLOWUP',
                openingLine: 'I can help you with that.'
            };
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LEARNING LOOP FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Detect spam-related events in the recording
        function detectSpamEvents() {
            const events = recording?.events || [];
            const spamEvents = [];
            
            // Look for spam-related events
            events.forEach(event => {
                if (event.type === 'SPAM_DETECTED' || event.type === 'SPAM_BLOCKED') {
                    spamEvents.push(event);
                }
                // Check for bailout events that might be spam-related
                if (event.type === 'BAILOUT_TRIGGERED' && event.data?.type === 'spam') {
                    spamEvents.push(event);
                }
            });
            
            // Also check for telemarketer-like phrases in caller turns
            const telemarkerPhrases = [
                'google listing', 'google business', 'seo services', 'website ranking',
                'business listing', 'verify your business', 'improve your ranking',
                'marketing services', 'advertising opportunity', 'special offer',
                'free consultation', 'press 1', 'press one', 'are you the owner',
                'decision maker', 'person in charge', 'speak to the owner'
            ];
            
            const callerTurns = recording?.transcript?.callerTurns || [];
            callerTurns.forEach(turn => {
                const text = (turn.text || '').toLowerCase();
                telemarkerPhrases.forEach(phrase => {
                    if (text.includes(phrase)) {
                        spamEvents.push({
                            type: 'TELEMARKETER_PHRASE_DETECTED',
                            turn: turn.turn,
                            data: {
                                text: turn.text,
                                phrase: phrase,
                                suggestion: 'Add to Edge Cases for automatic blocking'
                            }
                        });
                    }
                });
            });
            
            return spamEvents;
        }
        
        // Render the Learning Loop quick-action section
        function renderLearningLoopSection(spamEvents, callerPhone) {
            const hasSpamEvents = spamEvents.length > 0;
            const hasBailout = recording?.flags?.bailoutTriggered;
            const hasPhone = callerPhone && callerPhone.length > 5;
            
            // Extract unique spam phrases
            const spamPhrases = [...new Set(spamEvents
                .filter(e => e.data?.phrase || e.data?.text)
                .map(e => e.data?.phrase || (e.data?.text || '').substring(0, 50))
            )];
            
            return `
                <div style="margin-bottom: 32px;">
                    <h2 style="margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        üéì Learning Loop
                        <span style="background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">ENTERPRISE</span>
                    </h2>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">
                        One-click actions to make your AI smarter. Additions go directly to Edge Cases or Blacklist ‚Äî <strong>FREE blocking next time!</strong>
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                        
                        ${hasPhone ? `
                        <!-- QUICK ADD TO BLACKLIST -->
                        <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(249, 115, 22, 0.1)); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                <span style="font-size: 24px;">üö´</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--accent-red);">Block This Number</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Add to company blacklist (Layer 1)</div>
                                </div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="font-family: 'JetBrains Mono', monospace; font-size: 16px; color: var(--text-primary);">${callerPhone}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <select id="spamCategory" style="flex: 1; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
                                    <option value="telemarketer">ü§ñ Telemarketer</option>
                                    <option value="robocall">üìû Robocall</option>
                                    <option value="harassment">‚ö†Ô∏è Harassment</option>
                                    <option value="other">‚ùå Other</option>
                                </select>
                                <button onclick="quickAddToBlacklist('${callerPhone}')" style="padding: 8px 20px; background: linear-gradient(135deg, #ef4444, #f97316); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                    ‚ûï Block Now
                                </button>
                            </div>
                            <div style="margin-top: 12px; font-size: 11px; color: var(--accent-green);">
                                ‚úì Instant block ‚Ä¢ ‚úì $0.00 cost ‚Ä¢ ‚úì All future calls from this number rejected
                            </div>
                        </div>
                        ` : ''}
                        
                        ${spamPhrases.length > 0 ? spamPhrases.slice(0, 3).map((phrase, idx) => `
                        <!-- QUICK ADD EDGE CASE ${idx + 1} -->
                        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                <span style="font-size: 24px;">üõ°Ô∏è</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--accent-purple);">Block This Phrase</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Add to Edge Cases (Layer 2)</div>
                                </div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--text-primary);">"${phrase}"</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <select id="edgeCaseAction_${idx}" style="flex: 1; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
                                    <option value="polite_hangup">Polite Hangup</option>
                                    <option value="override_response">Custom Response</option>
                                    <option value="flag_only">Flag Only</option>
                                </select>
                                <button onclick="quickAddEdgeCase('${phrase.replace(/'/g, "\\'")}', ${idx})" style="padding: 8px 20px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                    ‚ûï Add Rule
                                </button>
                            </div>
                            <div style="margin-top: 12px; font-size: 11px; color: var(--accent-green);">
                                ‚úì Instant protection ‚Ä¢ ‚úì $0.00 cost ‚Ä¢ ‚úì Handled before LLM
                            </div>
                        </div>
                        `).join('') : ''}
                        
                        ${!hasPhone && spamPhrases.length === 0 && hasBailout ? `
                        <!-- BAILOUT DETECTED - SUGGEST ACTIONS -->
                        <div style="background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(249, 115, 22, 0.1)); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 12px; padding: 20px; grid-column: 1 / -1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                <span style="font-size: 24px;">‚ö†Ô∏è</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--accent-yellow);">Bailout Triggered</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">This call triggered a bailout ‚Äî review if this was spam or a real customer</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; margin-top: 16px;">
                                <button onclick="markAsSpam()" style="flex: 1; padding: 12px; background: rgba(239, 68, 68, 0.2); border: 1px solid var(--accent-red); border-radius: 8px; color: var(--accent-red); font-weight: 600; cursor: pointer;">
                                    üö´ This was spam ‚Äî Block number
                                </button>
                                <button onclick="markAsCustomer()" style="flex: 1; padding: 12px; background: rgba(34, 197, 94, 0.2); border: 1px solid var(--accent-green); border-radius: 8px; color: var(--accent-green); font-weight: 600; cursor: pointer;">
                                    ‚úÖ This was a real customer ‚Äî Improve scenarios
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                    </div>
                    
                    <!-- Learning Loop Stats -->
                    <div style="margin-top: 20px; padding: 16px; background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; color: var(--accent-green); font-size: 13px;">
                            <span>üí°</span>
                            <strong>How it works:</strong>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px;">1Ô∏è‚É£</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">You click "Add"</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px;">2Ô∏è‚É£</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Rule saved to Layer 1/2</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px;">3Ô∏è‚É£</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Next call: FREE blocking!</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Quick Add to Blacklist API call
        async function quickAddToBlacklist(phoneNumber) {
            const category = document.getElementById('spamCategory')?.value || 'telemarketer';
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Adding...';
            
            try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                const response = await fetch(`/api/admin/learning-loop/quick-add-blacklist/${companyId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        phoneNumber: phoneNumber,
                        reason: `Flagged from Black Box call ${callId}`,
                        sourceCallId: callId,
                        spamCategory: category
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    btn.textContent = '‚úÖ Blocked!';
                    btn.style.background = 'var(--accent-green)';
                    showToast('success', `Number ${phoneNumber} added to blacklist! Future calls will be blocked for FREE.`);
                } else {
                    btn.textContent = '‚ùå Failed';
                    btn.style.background = 'var(--accent-red)';
                    showToast('error', result.message || 'Failed to add to blacklist');
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = '‚ûï Block Now';
                        btn.style.background = '';
                    }, 2000);
                }
            } catch (error) {
                btn.textContent = '‚ùå Error';
                btn.style.background = 'var(--accent-red)';
                showToast('error', 'Network error: ' + error.message);
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = '‚ûï Block Now';
                    btn.style.background = '';
                }, 2000);
            }
        }
        
        // Quick Add Edge Case API call
        async function quickAddEdgeCase(phrase, idx) {
            const actionType = document.getElementById(`edgeCaseAction_${idx}`)?.value || 'polite_hangup';
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Adding...';
            
            try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                const response = await fetch(`/api/admin/learning-loop/quick-add-edge-case/${companyId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        triggerPhrase: phrase,
                        actionType: actionType,
                        priority: 85,
                        sourceCallId: callId,
                        sourceEvent: 'BLACK_BOX_TODO',
                        category: 'telemarketer'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    btn.textContent = '‚úÖ Added!';
                    btn.style.background = 'var(--accent-green)';
                    showToast('success', `Edge case added! "${phrase}" will now be handled automatically for FREE.`);
                } else {
                    btn.textContent = '‚ùå Failed';
                    btn.style.background = 'var(--accent-red)';
                    showToast('error', result.message || 'Failed to add edge case');
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = '‚ûï Add Rule';
                        btn.style.background = '';
                    }, 2000);
                }
            } catch (error) {
                btn.textContent = '‚ùå Error';
                btn.style.background = 'var(--accent-red)';
                showToast('error', 'Network error: ' + error.message);
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = '‚ûï Add Rule';
                    btn.style.background = '';
                }, 2000);
            }
        }
        
        // Mark bailout as spam
        function markAsSpam() {
            const phone = recording?.callerNumber || recording?.metadata?.callerNumber;
            if (phone) {
                document.getElementById('spamCategory').value = 'telemarketer';
                quickAddToBlacklist(phone);
            } else {
                showToast('error', 'No phone number available for this call');
            }
        }
        
        // Mark bailout as real customer (show coverage gaps)
        function markAsCustomer() {
            document.querySelector('[data-tab="todo"]').click();
            showToast('info', 'Review the coverage gaps below to improve handling for this type of customer.');
        }
        
        // Simple toast notification
        function showToast(type, message) {
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            const colors = {
                success: 'var(--accent-green)',
                error: 'var(--accent-red)',
                info: 'var(--accent-blue)'
            };
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${colors[type] || colors.info};
                color: white;
                border-radius: 8px;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 4000);
        }
        
        function renderTodo() {
            const container = document.getElementById('tabTodo');
            const gaps = analyzeCoverageGaps();
            const todoDot = document.getElementById('todoDot');
            
            // Detect spam-related events for learning loop
            const spamEvents = detectSpamEvents();
            const callerPhone = recording?.callerNumber || recording?.metadata?.callerNumber || '';
            
            // Show/hide notification dot
            if (gaps.length > 0 || spamEvents.length > 0) {
                todoDot.classList.add('active');
            } else {
                todoDot.classList.remove('active');
            }
            
            if (gaps.length === 0 && spamEvents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <h3 style="margin-bottom: 8px; color: var(--accent-green);">No Coverage Gaps Found</h3>
                        <p>All caller utterances were handled by fast-match or matched triage cards.</p>
                    </div>
                `;
                return;
            }
            
            // Build spam/learning loop section HTML
            let learningLoopHTML = '';
            if (spamEvents.length > 0 || (recording?.flags?.bailoutTriggered && callerPhone)) {
                learningLoopHTML = renderLearningLoopSection(spamEvents, callerPhone);
            }
            
            container.innerHTML = `
                <style>
                    .todo-gap {
                        background: var(--bg-card);
                        border: 1px solid var(--border-color);
                        border-radius: 10px;
                        margin-bottom: 24px;
                        overflow: hidden;
                    }
                    .todo-gap-header {
                        padding: 16px 20px;
                        background: rgba(239, 68, 68, 0.1);
                        border-bottom: 1px solid var(--border-color);
                    }
                    .todo-gap-header.warning { background: rgba(249, 115, 22, 0.1); }
                    .todo-gap-header.critical { background: rgba(239, 68, 68, 0.2); }
                    .todo-gap-utterance {
                        font-family: 'JetBrains Mono', monospace;
                        font-size: 14px;
                        color: var(--text-primary);
                    }
                    .todo-issues {
                        padding: 16px 20px;
                        display: flex;
                        flex-wrap: wrap;
                        gap: 8px;
                    }
                    .issue-chip {
                        padding: 4px 12px;
                        border-radius: 4px;
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                    }
                    .issue-chip.warning { background: rgba(249, 115, 22, 0.2); color: #f97316; }
                    .issue-chip.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
                    .issue-chip.critical { background: rgba(239, 68, 68, 0.3); color: #ef4444; }
                    .todo-step {
                        padding: 20px;
                        border-top: 1px solid var(--border-color);
                    }
                    .todo-step-title {
                        font-size: 13px;
                        font-weight: 600;
                        color: var(--accent-blue);
                        margin-bottom: 12px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .todo-step-instruction {
                        font-size: 12px;
                        color: var(--text-secondary);
                        margin-bottom: 12px;
                    }
                    .todo-field-table {
                        width: 100%;
                        border-collapse: collapse;
                    }
                    .todo-field-table td {
                        padding: 8px 12px;
                        border: 1px solid var(--border-color);
                        font-size: 13px;
                    }
                    .todo-field-table td:first-child {
                        width: 140px;
                        background: rgba(59, 130, 246, 0.1);
                        color: var(--accent-blue);
                        font-weight: 500;
                    }
                    .todo-field-table td:last-child {
                        font-family: 'JetBrains Mono', monospace;
                        color: var(--text-primary);
                    }
                    .copy-btn {
                        background: var(--bg-hover);
                        border: 1px solid var(--border-color);
                        color: var(--text-secondary);
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 11px;
                        cursor: pointer;
                        margin-left: 8px;
                    }
                    .copy-btn:hover {
                        background: var(--accent-blue);
                        color: white;
                    }
                    .keywords-list {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 6px;
                        margin-top: 8px;
                    }
                    .keyword-chip {
                        background: rgba(34, 197, 94, 0.2);
                        color: var(--accent-green);
                        padding: 4px 10px;
                        border-radius: 4px;
                        font-size: 12px;
                        font-family: 'JetBrains Mono', monospace;
                        cursor: pointer;
                    }
                    .keyword-chip:hover { background: rgba(34, 197, 94, 0.3); }
                </style>
                
                ${learningLoopHTML}
                
                ${gaps.length > 0 ? `
                <div style="margin-bottom: 24px; margin-top: 24px;">
                    <h2 style="margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        üìã Coverage Gaps Found
                        <span style="background: var(--accent-red); color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px;">${gaps.length}</span>
                    </h2>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        These caller utterances didn't fast-match or hit triage cards. Add the suggested content to improve coverage.
                    </p>
                </div>
                
                ${gaps.map((gap, idx) => renderGapCard(gap, idx)).join('')}
                ` : ''}
            `;
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STT ANALYSIS TAB - Deepgram Comparison & Vocabulary Training
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let sttComparisonResult = null;
        
        function renderSttAnalysis() {
            const container = document.getElementById('tabSttAnalysis');
            
            // Get Twilio transcripts from this recording
            const twilioTurns = (recording.transcript?.callerTurns || []).length;
            const avgConfidence = calculateAverageConfidence();
            const lowConfTurns = countLowConfidenceTurns();
            
            container.innerHTML = `
                <style>
                    .stt-card {
                        background: var(--bg-card);
                        border: 1px solid var(--border-color);
                        border-radius: 12px;
                        padding: 24px;
                        margin-bottom: 20px;
                    }
                    .stt-card h3 {
                        margin: 0 0 16px 0;
                        color: var(--text-primary);
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .stt-stat-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 16px;
                        margin-bottom: 20px;
                    }
                    .stt-stat {
                        background: var(--bg-secondary);
                        border-radius: 8px;
                        padding: 16px;
                        text-align: center;
                    }
                    .stt-stat-value {
                        font-size: 28px;
                        font-weight: 700;
                        margin-bottom: 4px;
                    }
                    .stt-stat-label {
                        font-size: 12px;
                        color: var(--text-secondary);
                        text-transform: uppercase;
                    }
                    .stt-btn {
                        padding: 12px 24px;
                        border-radius: 8px;
                        border: none;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 14px;
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.2s;
                    }
                    .stt-btn-primary {
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                    }
                    .stt-btn-primary:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    }
                    .stt-btn-primary:disabled {
                        background: #4b5563;
                        cursor: not-allowed;
                        transform: none;
                    }
                    .stt-comparison-result {
                        margin-top: 24px;
                        border-top: 1px solid var(--border-color);
                        padding-top: 24px;
                    }
                    .stt-suggestion {
                        background: var(--bg-secondary);
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        padding: 12px 16px;
                        margin-bottom: 12px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .stt-suggestion-add {
                        background: #10b981;
                        color: white;
                        border: none;
                        padding: 6px 12px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 12px;
                    }
                    .stt-side-by-side {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 20px;
                    }
                    .stt-transcript-box {
                        background: var(--bg-secondary);
                        border-radius: 8px;
                        padding: 16px;
                        font-family: monospace;
                        font-size: 13px;
                        line-height: 1.6;
                        max-height: 200px;
                        overflow-y: auto;
                    }
                    .stt-transcript-label {
                        font-weight: 600;
                        margin-bottom: 8px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .stt-verdict {
                        padding: 16px;
                        border-radius: 8px;
                        margin-top: 16px;
                    }
                    .stt-verdict.good { background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; }
                    .stt-verdict.warning { background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; }
                    .stt-verdict.bad { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; }
                </style>
                
                <div class="stt-card">
                    <h3>üìä Current STT Performance (This Call)</h3>
                    <div class="stt-stat-grid">
                        <div class="stt-stat">
                            <div class="stt-stat-value" style="color: #3b82f6;">${twilioTurns}</div>
                            <div class="stt-stat-label">Caller Turns</div>
                        </div>
                        <div class="stt-stat">
                            <div class="stt-stat-value" style="color: ${avgConfidence >= 80 ? '#10b981' : avgConfidence >= 60 ? '#f59e0b' : '#ef4444'};">${avgConfidence}%</div>
                            <div class="stt-stat-label">Avg Confidence</div>
                        </div>
                        <div class="stt-stat">
                            <div class="stt-stat-value" style="color: ${lowConfTurns === 0 ? '#10b981' : '#ef4444'};">${lowConfTurns}</div>
                            <div class="stt-stat-label">Low Confidence Turns</div>
                        </div>
                    </div>
                    
                    <div style="background: #1e293b; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <p style="margin: 0; color: #94a3b8;">
                            <strong>üß† What is this?</strong><br>
                            Compare your current Twilio STT against Deepgram's premium transcription. 
                            This helps you build your vocabulary to make Twilio as accurate as Deepgram - for FREE!
                        </p>
                    </div>
                    
                    <button id="sttCompareBtn" class="stt-btn stt-btn-primary" onclick="runSttComparison()">
                        üéôÔ∏è Compare with Deepgram
                    </button>
                    <span id="sttCompareStatus" style="margin-left: 16px; color: var(--text-secondary);"></span>
                </div>
                
                <div id="sttComparisonResults"></div>
            `;
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ROADMAP TAB - Production Readiness Checklist
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderRoadmap() {
            const container = document.getElementById('tabRoadmap');
            
            // Load saved state from localStorage
            const savedState = JSON.parse(localStorage.getItem('roadmapState') || '{}');
            
            // Roadmap data structure - UPDATED Jan 19, 2026
            const roadmap = {
                phases: [
                    {
                        id: 'speed',
                        name: 'Speed Optimization',
                        icon: '‚ö°',
                        target: '<1.5 second response time',
                        timeline: 'Week 1 (CRITICAL)',
                        current: '2-3 seconds',
                        goal: '<1.5 seconds',
                        items: [
                            { id: 'tts-cache', name: 'TTS caching for common phrases', status: savedState['tts-cache'] || 'todo', priority: 'high', need: 'Cache greetings, slot questions, confirmations' },
                            { id: 'latency-mask', name: 'Latency masking', status: savedState['latency-mask'] || 'todo', priority: 'high', need: '"One moment" filler audio during LLM' },
                            { id: 'redis-cache', name: 'Redis company config caching', status: savedState['redis-cache'] || 'done', priority: 'med', need: 'Company config cached in Redis with 5min TTL' },
                            { id: 'scenario-coverage', name: '90%+ tier-1 scenario coverage', status: savedState['scenario-coverage'] || 'partial', priority: 'high', need: 'Add triggers until 90% match without LLM' },
                            { id: 'prewarm-tts', name: 'Pre-warm next TTS', status: savedState['prewarm-tts'] || 'todo', priority: 'med', need: 'Predict likely next response, pre-generate' },
                            { id: 'llm-timeout', name: 'LLM timeout optimized', status: savedState['llm-timeout'] || 'done', priority: 'high', need: 'LLM0 timeout at 6s, ConversationEngine at 8s' }
                        ]
                    },
                    {
                        id: 'reliability',
                        name: 'Reliability & Stability',
                        icon: 'üõ°Ô∏è',
                        target: 'Zero crashes, graceful degradation',
                        timeline: 'Week 1-2',
                        items: [
                            { id: 'error-handling', name: 'Error handling all paths', status: savedState['error-handling'] || 'done', priority: 'high', need: 'Every code path has try/catch + recovery' },
                            { id: 'graceful-degrade', name: 'Graceful degradation', status: savedState['graceful-degrade'] || 'done', priority: 'med', need: 'Never hang up, always give helpful response' },
                            { id: 'null-safety', name: 'Null-safety throughout', status: savedState['null-safety'] || 'done', priority: 'high', need: 'All aiResult?.prop, session?.mode etc' },
                            { id: 'staging-env', name: 'Staging environment', status: savedState['staging-env'] || 'todo', priority: 'med', need: 'Test on staging before production deploy' },
                            { id: 'smoke-tests', name: 'Automated smoke tests', status: savedState['smoke-tests'] || 'todo', priority: 'med', need: 'Test critical flows before every deploy' },
                            { id: 'error-alerting', name: 'Error alerting', status: savedState['error-alerting'] || 'todo', priority: 'med', need: 'Slack/email notification on production errors' },
                            { id: 'spam-filter-fix', name: 'Spam filter infinite loop fix', status: savedState['spam-filter-fix'] || 'done', priority: 'high', need: 'setInterval cleared before new one' }
                        ]
                    },
                    {
                        id: 'intelligence',
                        name: 'Conversation Intelligence',
                        icon: 'üß†',
                        target: 'Human-like conversations',
                        timeline: 'Week 2-3',
                        items: [
                            { id: 'name-detection', name: 'Smart name detection', status: savedState['name-detection'] || 'done', priority: 'high', need: 'Stop words: probably, air conditioner, what' },
                            { id: 'phone-confirm', name: 'Natural phone confirmation', status: savedState['phone-confirm'] || 'done', priority: 'med', need: '"that is a good number" understood + caller ID first' },
                            { id: 'scenario-matching', name: 'High-confidence scenario matching', status: savedState['scenario-matching'] || 'done', priority: 'high', need: 'Tier-1 short-circuit at 80%+ confidence' },
                            { id: 'interruption-handling', name: 'Mid-booking interruption handling', status: savedState['interruption-handling'] || 'partial', priority: 'med', need: 'Answer questions, return to slot' },
                            { id: 'empathy-control', name: 'Empathy language control', status: savedState['empathy-control'] || 'done', priority: 'low', need: 'forbiddenPhrases configured' },
                            { id: 'filler-words', name: 'Safe filler word removal', status: savedState['filler-words'] || 'done', priority: 'high', need: 'Kept: please, thanks, actually, you know' },
                            { id: 'json-leak-fix', name: 'JSON leak to TTS fixed', status: savedState['json-leak-fix'] || 'done', priority: 'high', need: 'parsed.response handled correctly' },
                            { id: 'post-booking-readback', name: 'Post-booking read-back', status: savedState['post-booking-readback'] || 'done', priority: 'med', need: '"What name/phone/address do you have?" works' }
                        ]
                    },
                    {
                        id: 'ui',
                        name: 'UI & Configuration',
                        icon: 'üéõÔ∏è',
                        target: 'All settings exposed in UI',
                        timeline: 'Week 2-3',
                        items: [
                            { id: 'booking-prompts', name: 'Booking prompts UI-controlled', status: savedState['booking-prompts'] || 'done', priority: 'high', need: 'All slot questions from UI' },
                            { id: 'transfer-calls', name: 'Transfer Calls tab functional', status: savedState['transfer-calls'] || 'done', priority: 'med', need: 'Company switchboard working' },
                            { id: 'call-protection', name: 'Call Protection (Edge Cases) UI', status: savedState['call-protection'] || 'done', priority: 'med', need: 'Spam/escalation rules in UI' },
                            { id: 'behavior-rules', name: 'Behavior rules UI', status: savedState['behavior-rules'] || 'done', priority: 'med', need: 'Tone, style settings exposed' },
                            { id: 'blackbox-roadmap', name: 'Black Box Roadmap tab', status: 'done', priority: 'low', need: 'This tab!' },
                            { id: 'fallback-nuked', name: 'Legacy fallback system removed', status: savedState['fallback-nuked'] || 'done', priority: 'med', need: 'connectionMessages.voice.fallback nuked' },
                            { id: 'company-profile-audit', name: 'Company Profile tabs audited', status: savedState['company-profile-audit'] || 'done', priority: 'med', need: 'All tabs verified: Overview‚ÜíSpam Filter' },
                            { id: 'wiring-registry', name: 'Wiring registry complete', status: savedState['wiring-registry'] || 'done', priority: 'med', need: 'LLM-0, 3-Tier, Slots documented' }
                        ]
                    },
                    {
                        id: 'integrations',
                        name: 'Integrations',
                        icon: 'üîó',
                        target: 'Calendar + SMS + Maps working',
                        timeline: 'Week 3-4',
                        items: [
                            { id: 'gcal-integration', name: 'Google Calendar integration', status: savedState['gcal-integration'] || 'todo', priority: 'high', need: 'Real-time availability, booking creation' },
                            { id: 'sms-confirm', name: 'SMS confirmations', status: savedState['sms-confirm'] || 'todo', priority: 'high', need: 'Booking confirmation texts' },
                            { id: 'customer-lookup', name: 'Customer recognition', status: savedState['customer-lookup'] || 'done', priority: 'med', need: 'Phone number ‚Üí customer context' },
                            { id: 'address-validation', name: 'Google Maps Address Validation', status: savedState['address-validation'] || 'done', priority: 'high', need: 'Unit detection, gate code, building type' },
                            { id: 'webhook-events', name: 'Webhook events', status: savedState['webhook-events'] || 'todo', priority: 'low', need: 'Post call events to external systems' }
                        ]
                    },
                    {
                        id: 'architecture',
                        name: 'Architecture & Documentation',
                        icon: 'üìê',
                        target: 'World-class enterprise code',
                        timeline: 'Ongoing',
                        items: [
                            { id: 'mongoose-keys', name: 'Mongoose map keys fixed', status: savedState['mongoose-keys'] || 'done', priority: 'high', need: 'Dots replaced with colons in all keys' },
                            { id: 'legacy-cleanup', name: 'Legacy code removed', status: savedState['legacy-cleanup'] || 'done', priority: 'med', need: 'Phantom services, unused tabs deleted' },
                            { id: 'wiring-docs', name: 'Wiring registry documented', status: savedState['wiring-docs'] || 'done', priority: 'med', need: 'wiringRegistry.v1.js complete' },
                            { id: 'company-profile-docs', name: 'Company Profile ‚Üî Runtime mapped', status: savedState['company-profile-docs'] || 'done', priority: 'med', need: '_companyProfileConfig section added' },
                            { id: 'multi-tenant-safe', name: 'Multi-tenant safety verified', status: savedState['multi-tenant-safe'] || 'done', priority: 'high', need: 'All settings per-company, no hardcoding' }
                        ]
                    }
                ]
            };
            
            // Calculate progress for each phase and overall
            function calculatePhaseProgress(phase) {
                const statusValues = { done: 100, partial: 50, todo: 0 };
                const total = phase.items.reduce((sum, item) => sum + statusValues[item.status], 0);
                return Math.round(total / phase.items.length);
            }
            
            function calculateOverallProgress() {
                const allItems = roadmap.phases.flatMap(p => p.items);
                const statusValues = { done: 100, partial: 50, todo: 0 };
                const total = allItems.reduce((sum, item) => sum + statusValues[item.status], 0);
                return Math.round(total / allItems.length);
            }
            
            const overallProgress = calculateOverallProgress();
            const totalItems = roadmap.phases.flatMap(p => p.items).length;
            const doneItems = roadmap.phases.flatMap(p => p.items).filter(i => i.status === 'done').length;
            const partialItems = roadmap.phases.flatMap(p => p.items).filter(i => i.status === 'partial').length;
            
            // Determine overall color
            let overallColor = overallProgress >= 70 ? '#22c55e' : overallProgress >= 40 ? '#f59e0b' : '#ef4444';
            
            container.innerHTML = `
                <div class="roadmap-container">
                    <div class="roadmap-header">
                        <h2>üöÄ Production Readiness Roadmap</h2>
                        <p style="color: var(--text-secondary);">ClientsVia.ai ‚Üí World-Class Enterprise AI Receptionist</p>
                    </div>
                    
                    <div class="roadmap-overall">
                        <div class="roadmap-overall-title">Overall Progress</div>
                        <div class="roadmap-overall-bar">
                            <div class="roadmap-overall-fill" style="width: ${overallProgress}%;"></div>
                        </div>
                        <div class="roadmap-overall-text" style="color: ${overallColor};">${overallProgress}%</div>
                        <div style="text-align: center; color: var(--text-secondary); font-size: 13px; margin-top: 8px;">
                            ${doneItems} done ¬∑ ${partialItems} in progress ¬∑ ${totalItems - doneItems - partialItems} todo
                        </div>
                    </div>
                    
                    ${roadmap.phases.map(phase => {
                        const progress = calculatePhaseProgress(phase);
                        const fillClass = progress >= 70 ? 'high' : progress >= 40 ? 'medium' : 'low';
                        return `
                            <div class="roadmap-phase">
                                <div class="roadmap-phase-header" onclick="togglePhase('${phase.id}')">
                                    <div class="roadmap-phase-title">
                                        <span class="roadmap-phase-icon">${phase.icon}</span>
                                        <div>
                                            <div class="roadmap-phase-name">${phase.name}</div>
                                            <div class="roadmap-phase-meta">${phase.timeline} ¬∑ Target: ${phase.target}</div>
                                        </div>
                                    </div>
                                    <div class="roadmap-phase-progress">
                                        <div class="roadmap-phase-bar">
                                            <div class="roadmap-phase-fill ${fillClass}" style="width: ${progress}%;"></div>
                                        </div>
                                        <span class="roadmap-phase-pct">${progress}%</span>
                                    </div>
                                </div>
                                <div class="roadmap-items" id="phase-${phase.id}">
                                    ${phase.items.map(item => `
                                        <div class="roadmap-item">
                                            <div class="roadmap-item-checkbox ${item.status}" 
                                                 onclick="toggleRoadmapItem('${item.id}', '${item.status}')"
                                                 title="Click to toggle status">
                                                ${item.status === 'done' ? '‚úì' : item.status === 'partial' ? '~' : ''}
                                            </div>
                                            <div class="roadmap-item-name ${item.status === 'done' ? 'completed' : ''}">${item.name}
                                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">${item.need}</div>
                                            </div>
                                            <div class="roadmap-item-status ${item.status}">
                                                ${item.status === 'done' ? '‚úÖ Done' : item.status === 'partial' ? 'üîÑ Partial' : '‚ùå TODO'}
                                            </div>
                                            <div class="roadmap-item-priority ${item.priority}">${item.priority}</div>
                                            <div class="roadmap-item-pct">
                                                ${item.status === 'done' ? '100%' : item.status === 'partial' ? '50%' : '0%'}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    <div class="roadmap-footer">
                        <p>üíæ Progress auto-saved to browser ¬∑ <a href="#" onclick="resetRoadmap(); return false;">Reset to defaults</a></p>
                        <p style="margin-top: 8px;">Last updated: ${new Date().toLocaleString()}</p>
                    </div>
                </div>
            `;
        }
        
        function togglePhase(phaseId) {
            const items = document.getElementById('phase-' + phaseId);
            if (items) {
                items.style.display = items.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function toggleRoadmapItem(itemId, currentStatus) {
            // Cycle through: todo ‚Üí partial ‚Üí done ‚Üí todo
            const nextStatus = {
                'todo': 'partial',
                'partial': 'done',
                'done': 'todo'
            };
            const newStatus = nextStatus[currentStatus] || 'todo';
            
            // Save to localStorage
            const savedState = JSON.parse(localStorage.getItem('roadmapState') || '{}');
            savedState[itemId] = newStatus;
            localStorage.setItem('roadmapState', JSON.stringify(savedState));
            
            // Re-render
            renderRoadmap();
            
            // Show toast
            const statusText = newStatus === 'done' ? '‚úÖ Marked complete!' : 
                              newStatus === 'partial' ? 'üîÑ Marked in progress' : 
                              '‚è≥ Reset to TODO';
            showToast(statusText, newStatus === 'done' ? 'success' : 'info');
        }
        
        function resetRoadmap() {
            if (confirm('Reset all roadmap progress to defaults?')) {
                localStorage.removeItem('roadmapState');
                renderRoadmap();
                showToast('Roadmap reset to defaults', 'info');
            }
        }
        
        function calculateAverageConfidence() {
            const turns = recording.transcript?.callerTurns || [];
            if (turns.length === 0) {
                // Try events
                const gatherEvents = (recording.events || []).filter(e => e.type === 'GATHER_FINAL');
                if (gatherEvents.length === 0) return 0;
                const sum = gatherEvents.reduce((acc, e) => acc + (e.data?.confidence || 0), 0);
                return Math.round((sum / gatherEvents.length) * 100);
            }
            const sum = turns.reduce((acc, t) => acc + (t.confidence || 0), 0);
            return Math.round((sum / turns.length) * 100);
        }
        
        function countLowConfidenceTurns() {
            const turns = recording.transcript?.callerTurns || [];
            if (turns.length === 0) {
                const gatherEvents = (recording.events || []).filter(e => e.type === 'GATHER_FINAL');
                return gatherEvents.filter(e => (e.data?.confidence || 0) < 0.7).length;
            }
            return turns.filter(t => (t.confidence || 0) < 0.7).length;
        }
        
        async function runSttComparison() {
            const btn = document.getElementById('sttCompareBtn');
            const status = document.getElementById('sttCompareStatus');
            const resultsDiv = document.getElementById('sttComparisonResults');
            
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Analyzing...';
            status.textContent = 'Sending to Deepgram for comparison...';
            
            try {
                const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
                const response = await fetch('/api/admin/stt-profile/compare/' + callId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ companyId })
                });
                
                const result = await response.json();
                sttComparisonResult = result;
                
                if (result.success) {
                    status.textContent = 'Analysis complete!';
                    renderComparisonResults(result);
                } else {
                    status.textContent = 'Error: ' + (result.error || 'Unknown error');
                    resultsDiv.innerHTML = '<div class="stt-card" style="border-color: #ef4444;"><p style="color: #ef4444;">‚ùå ' + (result.error || 'Comparison failed') + '</p></div>';
                }
            } catch (error) {
                status.textContent = 'Error: ' + error.message;
                resultsDiv.innerHTML = '<div class="stt-card" style="border-color: #ef4444;"><p style="color: #ef4444;">‚ùå ' + error.message + '</p></div>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üéôÔ∏è Compare with Deepgram';
            }
        }
        
        function renderComparisonResults(result) {
            const container = document.getElementById('sttComparisonResults');
            
            // Recommendation verdict
            const rec = result.recommendation || {};
            const verdictClass = rec.verdict?.includes('SUFFICIENT') || rec.verdict?.includes('COMPARABLE') ? 'good' : 
                                rec.verdict?.includes('BETTER') ? 'warning' : 'bad';
            
            // Vocabulary suggestions
            const vocab = result.vocabularySuggestions || {};
            const hasVocabSuggestions = vocab.available && vocab.summary?.totalSuggestions > 0;
            
            container.innerHTML = `
                <div class="stt-card">
                    <h3>${rec.icon || 'üìä'} Analysis Result</h3>
                    
                    <div class="stt-verdict ${verdictClass}">
                        <strong style="font-size: 16px;">${rec.message || 'Analysis complete'}</strong>
                        <p style="margin: 8px 0 0 0; color: var(--text-secondary);">${rec.details || ''}</p>
                        <p style="margin: 8px 0 0 0; font-style: italic;">${rec.action || ''}</p>
                    </div>
                    
                    ${result.comparison?.available ? `
                        <div style="margin-top: 24px;">
                            <h4 style="margin-bottom: 12px;">üìä Comparison Stats</h4>
                            <div class="stt-stat-grid">
                                <div class="stt-stat">
                                    <div class="stt-stat-value" style="color: #3b82f6;">${result.comparison.similarity || 0}%</div>
                                    <div class="stt-stat-label">Similarity</div>
                                </div>
                                <div class="stt-stat">
                                    <div class="stt-stat-value" style="color: #f59e0b;">${result.comparison.twilioAvgConfidence || 0}%</div>
                                    <div class="stt-stat-label">Twilio Confidence</div>
                                </div>
                                <div class="stt-stat">
                                    <div class="stt-stat-value" style="color: #10b981;">${result.comparison.deepgramConfidence || 0}%</div>
                                    <div class="stt-stat-label">Deepgram Confidence</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 24px;">
                            <h4 style="margin-bottom: 12px;">üîç Side-by-Side Transcript</h4>
                            <div class="stt-side-by-side">
                                <div>
                                    <div class="stt-transcript-label">
                                        <span style="color: #f59e0b;">üìû Twilio</span>
                                        <span style="color: var(--text-secondary); font-weight: normal; font-size: 12px;">(${result.twilio?.totalWords || 0} words)</span>
                                    </div>
                                    <div class="stt-transcript-box">${result.comparison.sideBySide?.twilio || 'No transcript'}</div>
                                </div>
                                <div>
                                    <div class="stt-transcript-label">
                                        <span style="color: #10b981;">üéôÔ∏è Deepgram</span>
                                        <span style="color: var(--text-secondary); font-weight: normal; font-size: 12px;">(${result.deepgram?.wordCount || 0} words)</span>
                                    </div>
                                    <div class="stt-transcript-box">${result.comparison.sideBySide?.deepgram || 'No transcript'}</div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div style="margin-top: 24px; padding: 20px; background: var(--bg-secondary); border-radius: 8px;">
                            <p style="margin: 0; color: var(--text-secondary);">
                                ${result.deepgram?.message || 'Deepgram comparison not available. Make sure DEEPGRAM_API_KEY is configured.'}
                            </p>
                        </div>
                    `}
                </div>
                
                ${hasVocabSuggestions ? `
                    <div class="stt-card">
                        <h3>üéØ Vocabulary Suggestions</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            Add these to your STT Profile to improve future transcriptions - <strong>FREE accuracy boost!</strong>
                        </p>
                        
                        ${vocab.corrections?.length > 0 ? `
                            <div style="margin-bottom: 24px;">
                                <h4 style="margin-bottom: 12px; color: #f59e0b;">üîß Corrections (Mishear Fixes)</h4>
                                ${vocab.corrections.map(c => `
                                    <div class="stt-suggestion">
                                        <div>
                                            <code style="color: #ef4444;">"${c.heard}"</code> ‚Üí <code style="color: #10b981;">"${c.shouldBe}"</code>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${c.reason}</div>
                                        </div>
                                        <button class="stt-suggestion-add" onclick="addCorrection('${c.heard}', '${c.shouldBe}')">+ Add</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${vocab.keywords?.length > 0 ? `
                            <div style="margin-bottom: 24px;">
                                <h4 style="margin-bottom: 12px; color: #3b82f6;">üéØ Keywords (Boost Recognition)</h4>
                                ${vocab.keywords.map(k => `
                                    <div class="stt-suggestion">
                                        <div>
                                            <code style="color: #3b82f6;">"${k.phrase}"</code>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${k.reason}</div>
                                        </div>
                                        <button class="stt-suggestion-add" onclick="addKeyword('${k.phrase}', ${k.boostWeight || 5})">+ Add</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${vocab.fillers?.length > 0 ? `
                            <div style="margin-bottom: 24px;">
                                <h4 style="margin-bottom: 12px; color: #8b5cf6;">üîá Fillers (Strip Noise)</h4>
                                ${vocab.fillers.map(f => `
                                    <div class="stt-suggestion">
                                        <div>
                                            <code style="color: #8b5cf6;">"${f.phrase}"</code>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Appeared ${f.occurrences} times</div>
                                        </div>
                                        <button class="stt-suggestion-add" onclick="addFiller('${f.phrase}')">+ Add</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <button class="stt-btn stt-btn-primary" onclick="addAllSuggestions()" style="margin-top: 16px;">
                            ‚ú® Add All Suggestions to STT Profile
                        </button>
                    </div>
                ` : ''}
            `;
        }
        
        async function addCorrection(heard, normalized) {
            await addToSttProfile('corrections', { heard, normalized, context: [], enabled: true });
        }
        
        async function addKeyword(phrase, boostWeight) {
            await addToSttProfile('vocabulary', { phrase, type: 'manual', source: 'Deepgram Analysis', boostWeight, enabled: true });
        }
        
        async function addFiller(phrase) {
            await addToSttProfile('fillers', { phrase, scope: 'template', enabled: true, addedBy: 'deepgram_analysis' });
        }
        
        async function addToSttProfile(type, item) {
            try {
                const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
                
                // Get template ID from recording or company
                const templateId = recording.metadata?.templateId;
                if (!templateId) {
                    showToast('error', 'Template ID not found in recording');
                    return;
                }
                
                const response = await fetch('/api/admin/stt-profile/' + templateId + '/' + type, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ item })
                });
                
                if (response.ok) {
                    showToast('success', 'Added to STT Profile!');
                } else {
                    const err = await response.json();
                    showToast('error', err.error || 'Failed to add');
                }
            } catch (error) {
                showToast('error', error.message);
            }
        }
        
        async function addAllSuggestions() {
            if (!sttComparisonResult?.vocabularySuggestions?.copyReady) {
                showToast('error', 'No suggestions to add');
                return;
            }
            
            const vocab = sttComparisonResult.vocabularySuggestions;
            let added = 0;
            
            // Add all corrections
            for (const c of (vocab.copyReady?.corrections || [])) {
                await addCorrection(c.heard, c.normalized);
                added++;
            }
            
            // Add all keywords
            for (const k of (vocab.copyReady?.keywords || [])) {
                await addKeyword(k.phrase, k.boostWeight);
                added++;
            }
            
            // Add all fillers
            for (const f of (vocab.copyReady?.fillers || [])) {
                await addFiller(f.phrase);
                added++;
            }
            
            showToast('success', 'Added ' + added + ' items to STT Profile!');
        }
        
        // Detect slang, colloquialisms, and regional dialect terms
        function detectSlangAndSynonyms(text) {
            const slangMappings = {
                // Equipment slang
                'thingy': ['unit', 'system', 'device', 'equipment'],
                'thing': ['unit', 'system', 'device'],
                'box': ['unit', 'condenser', 'system'],
                'the box outside': ['outdoor unit', 'condenser', 'outside unit', 'AC unit'],
                'the thing on the wall': ['thermostat', 'wall unit', 'control panel'],
                'thingy on the wall': ['thermostat', 'wall unit', 'control panel'],
                'that dial': ['thermostat', 'control'],
                'the motor': ['compressor', 'blower motor', 'fan motor'],
                'the spinny thing': ['fan', 'blower', 'motor'],
                'thing that spins': ['fan', 'blower', 'fan blade'],
                
                // Problem description slang
                'on the fritz': ['not working', 'broken', 'malfunctioning'],
                'busted': ['broken', 'not working', 'damaged'],
                'acting up': ['malfunctioning', 'not working properly', 'having issues'],
                'acting funny': ['malfunctioning', 'not working right', 'behaving oddly'],
                'went out': ['stopped working', 'failed', 'broke down'],
                'conked out': ['stopped working', 'died', 'failed'],
                'gave out': ['stopped working', 'failed', 'broke'],
                'crapped out': ['broke', 'stopped working', 'failed'],
                'done broke': ['broken', 'stopped working'],
                'ain\'t working': ['not working', 'broken', 'won\'t work'],
                'won\'t kick on': ['won\'t start', 'won\'t turn on', 'not starting'],
                'won\'t fire up': ['won\'t start', 'won\'t ignite', 'not starting'],
                'making a racket': ['making noise', 'loud', 'noisy'],
                'making a ruckus': ['making noise', 'loud sounds', 'noisy'],
                
                // Action slang  
                'come take a look': ['inspect', 'diagnose', 'check out'],
                'come check it out': ['inspect', 'diagnose', 'service'],
                'come fix it': ['repair', 'service', 'fix'],
                'y\'all': ['you', 'your company'],
                'gonna': ['going to', 'will'],
                'wanna': ['want to', 'would like to'],
                'gotta': ['need to', 'have to'],
                
                // Temperature/comfort slang
                'freezing': ['very cold', 'too cold', 'extremely cold'],
                'burning up': ['very hot', 'too hot', 'overheating'],
                'roasting': ['very hot', 'too warm', 'sweltering'],
                'sweating bullets': ['very hot', 'no cooling', 'AC not working']
            };
            
            const detected = [];
            const lowerText = text.toLowerCase();
            
            for (const [slang, meanings] of Object.entries(slangMappings)) {
                if (lowerText.includes(slang)) {
                    detected.push({
                        original: slang,
                        meanings: meanings,
                        context: text
                    });
                }
            }
            
            return detected;
        }
        
        // Generate full production-ready scenario content
        function generateFullScenarioContent(gap) {
            const text = gap.text.toLowerCase();
            const keywords = extractKeywords(gap.text);
            const detectedSlang = detectSlangAndSynonyms(gap.text);
            
            // Detect intent type
            const isBooking = /schedule|book|appointment|technician|come out|send someone/i.test(text);
            const isTroubleshooting = /not working|broken|issue|problem|won't|doesn't/i.test(text);
            const isEmergency = /emergency|urgent|leak|flood|no heat|gas smell/i.test(text);
            
            let scenarioName, category, triggers, negativeTriggers, quickReplies, fullReplies, followUpMode;
            
            if (isBooking) {
                scenarioName = 'Service Appointment Request';
                category = 'Booking';
                triggers = [
                    gap.text,
                    'schedule service',
                    'book an appointment',
                    'need a technician',
                    'send someone out',
                    'set up a service call',
                    'schedule a tech',
                    'book a service visit',
                    'need someone to come out',
                    'make an appointment'
                ];
                negativeTriggers = [
                    'cancel my appointment',
                    'reschedule my appointment', 
                    'what time is my appointment',
                    'when is the technician coming',
                    'change my booking'
                ];
                quickReplies = [
                    'Got it, I can help you schedule that.',
                    'Sure, let me help you book an appointment.',
                    'Absolutely, I can set that up for you.',
                    'No problem, let\'s get you scheduled.',
                    'Of course, I\'ll help you with that right away.'
                ];
                fullReplies = [
                    'I\'d be happy to help you schedule a service appointment with {companyName}. May I start with your name?',
                    'Let me get you set up with one of our technicians. To schedule your appointment, I\'ll need your name, phone number, and the best time that works for you. What\'s your name?',
                    'Sure thing! {companyName} can definitely help with that. I\'ll need to collect a few details to book your service call. Can I get your name please?',
                    'No problem at all. I can schedule a technician to come out and take a look. First, may I have your name so I can pull up your account or create a new one?',
                    'Absolutely, I\'ll get that scheduled for you. {companyName} services the {serviceArea} area. Let\'s start with your name and the address where you need service.'
                ];
                followUpMode = 'ASK_FOLLOWUP_QUESTION';
            } else if (isEmergency) {
                scenarioName = 'Emergency Service Request';
                category = 'Emergency';
                triggers = [
                    gap.text,
                    'emergency',
                    'urgent',
                    'no heat',
                    'no cooling',
                    'water leak',
                    'gas smell',
                    'flooding',
                    'smoke',
                    'sparking'
                ];
                negativeTriggers = [
                    'not an emergency',
                    'no rush',
                    'whenever you can',
                    'at your convenience'
                ];
                quickReplies = [
                    'I understand this is urgent. Let me help you right away.',
                    'I\'m so sorry to hear that. Let me get you help immediately.',
                    'That sounds serious. I\'ll prioritize this right now.',
                    'I completely understand. Let\'s handle this as a priority.',
                    'Don\'t worry, we\'ll take care of this urgently.'
                ];
                fullReplies = [
                    'I understand this is urgent. {companyName} treats emergencies as our top priority. Let me get a technician dispatched to you as soon as possible. What\'s your name and address?',
                    'I\'m so sorry you\'re dealing with this. For emergencies, {companyName} offers priority service. To get someone out to you quickly, I need your name, address, and phone number.',
                    'That definitely sounds like an emergency. Let me connect you with our emergency dispatch right away. Before I do, can I get your name and the service address?',
                    'I understand, and {companyName} takes this seriously. We have technicians on call for situations like this. What\'s your name and where is the emergency?',
                    'Don\'t worry, we\'ll get this handled. {companyName} has emergency technicians available. To dispatch someone immediately, I need your name, phone number, and address.'
                ];
                followUpMode = 'TRANSFER';
            } else {
                // Troubleshooting or General
                scenarioName = keywords.slice(0, 3).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') + ' Issue';
                category = 'Troubleshooting';
                triggers = [
                    gap.text,
                    ...keywords.map(k => k + ' not working'),
                    ...keywords.map(k => k + ' problem'),
                    ...keywords.slice(0, 3).map(k => 'issue with ' + k)
                ].slice(0, 10);
                negativeTriggers = [
                    'just checking',
                    'how much does it cost',
                    'what are your hours',
                    'general question',
                    'pricing'
                ];
                quickReplies = [
                    'I can help troubleshoot that with you.',
                    'Let me help you figure out what\'s going on.',
                    'I understand, let\'s see what we can do.',
                    'No problem, I can assist with that.',
                    'Got it, let me help you with that issue.'
                ];
                fullReplies = [
                    'I can help troubleshoot that with you. To better understand what\'s happening, can you tell me when you first noticed the issue?',
                    'Let me help you figure out what\'s going on. Is the system making any unusual sounds or displaying any error codes?',
                    'I understand how frustrating that can be. {companyName} can definitely help. Has anything changed recently that might have caused this?',
                    'No problem, I can assist with that. Can you describe exactly what\'s happening? Is the unit running at all?',
                    'Got it. To help diagnose the issue, can you tell me if the problem started suddenly or has been getting worse over time?'
                ];
                followUpMode = 'ASK_FOLLOWUP_QUESTION';
            }
            
            // Advanced settings based on category
            let scenarioType, replyStrategy, replySelection, priorityLevel, personality, handoffPolicy, cooldown;
            
            if (isBooking) {
                scenarioType = 'BOOKING';
                replyStrategy = 'FULL_ONLY';
                replySelection = 'RANDOM';
                priorityLevel = 90;  // High priority - booking is revenue
                personality = 'PROFESSIONAL_WARM';
                handoffPolicy = 'LOW_CONFIDENCE_ONLY';
                cooldown = 0;
            } else if (isEmergency) {
                scenarioType = 'EMERGENCY';
                replyStrategy = 'QUICK_THEN_FULL';
                replySelection = 'SEQUENTIAL';
                priorityLevel = 100;  // Highest priority - emergencies first
                personality = 'EMPATHETIC_URGENT';
                handoffPolicy = 'LOW_CONFIDENCE_ONLY';
                cooldown = 0;
            } else {
                scenarioType = 'FAQ';
                replyStrategy = 'AUTO';
                replySelection = 'RANDOM';
                priorityLevel = 50;  // Normal priority
                personality = 'PROFESSIONAL_HELPFUL';
                handoffPolicy = 'LOW_CONFIDENCE_ONLY';
                cooldown = 0;
            }
            
            return {
                scenarioName,
                category,
                triggers,
                negativeTriggers,
                quickReplies,
                fullReplies,
                followUpMode,
                triageTag: scenarioName.toUpperCase().replace(/\s+/g, '_'),
                // Detected slang/dialect terms
                detectedSlang,
                // Advanced settings
                scenarioType,
                replyStrategy,
                replySelection,
                priorityLevel,
                personality,
                handoffPolicy,
                cooldown
            };
        }
        
        // Global storage for copy data (avoids escaping issues in onclick)
        window.copyData = window.copyData || {};
        
        function renderGapCard(gap, idx) {
            const severity = gap.issues.some(i => i.severity === 'critical') ? 'critical' : 
                            gap.issues.some(i => i.severity === 'error') ? 'error' : 'warning';
            
            // Generate full content
            const content = generateFullScenarioContent(gap);
            
            // Store content in global object with unique IDs (avoids onclick escaping issues)
            const dataId = `gap_${idx}`;
            window.copyData[`${dataId}_name`] = content.scenarioName;
            window.copyData[`${dataId}_tag`] = content.triageTag;
            window.copyData[`${dataId}_triggers`] = content.triggers.join('\n');
            window.copyData[`${dataId}_negative`] = content.negativeTriggers.join('\n');
            window.copyData[`${dataId}_quick`] = content.quickReplies.join('\n');
            window.copyData[`${dataId}_full`] = content.fullReplies.join('\n');
            window.copyData[`${dataId}_opening`] = content.fullReplies[0].split('.')[0] + '.';
            window.copyData[`${dataId}_keywords`] = content.triggers.slice(0, 5).join(', ');
            
            // Store synonyms for Quick Add button
            content.detectedSlang.forEach((s, sIdx) => {
                window.copyData[`${dataId}_slang_${sIdx}`] = s.original;
                window.copyData[`${dataId}_meanings_${sIdx}`] = s.meanings.join(', ');
            });
            
            const safeText = (gap.text || '').replace(/"/g, '&quot;').substring(0, 40);
            
            return `
                <div class="todo-gap">
                    <div class="todo-gap-header ${severity}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary); font-size: 12px;">TURN ${gap.turn} ‚Ä¢ GAP #${idx + 1}</span>
                        </div>
                        <div class="todo-gap-utterance" style="margin-top: 8px;">
                            "${safeText}..."
                        </div>
                    </div>
                    
                    <div class="todo-issues">
                        ${gap.issues.map(issue => `
                            <span class="issue-chip ${issue.severity}">${issue.type.replace(/_/g, ' ')}</span>
                        `).join('')}
                    </div>
                    
                    ${content.detectedSlang.length > 0 ? `
                    <!-- SLANG/DIALECT DETECTION - Matches Effective Synonyms UI -->
                    <div style="padding: 16px 20px; background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(139, 92, 246, 0.15)); border-bottom: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 18px;">üó£Ô∏è</span>
                                <span style="font-weight: 600; color: var(--accent-pink);">New Synonyms Detected!</span>
                                <span style="background: var(--accent-pink); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${content.detectedSlang.length} mappings</span>
                            </div>
                            <span style="color: var(--accent-green); font-size: 12px; font-weight: 500;">+ Quick Add</span>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">
                            Add these to <strong>Effective Synonyms</strong> in your scenario's Inherited Configuration section:
                        </p>
                        ${content.detectedSlang.map((s, sIdx) => `
                            <div style="background: rgba(139, 92, 246, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--accent-purple);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                    <div>
                                        <div style="color: var(--accent-purple); font-weight: 600; font-size: 14px; margin-bottom: 4px;">${s.meanings[0]}</div>
                                        <div style="color: var(--text-muted); font-size: 12px; font-family: 'JetBrains Mono', monospace;">
                                            ${s.original}, ${s.meanings.slice(1).join(', ')}
                                        </div>
                                    </div>
                                    <button class="copy-btn" onclick="copyFromStore('${dataId}_meanings_${sIdx}', this)" style="background: var(--accent-purple); white-space: nowrap;">üìã Copy</button>
                                </div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 12px; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 6px; border-left: 3px solid var(--accent-green);">
                            <div style="color: var(--accent-green); font-size: 12px; margin-bottom: 8px;">
                                <strong>üìç Where to add:</strong>
                            </div>
                            <ol style="color: var(--text-secondary); font-size: 12px; margin: 0; padding-left: 20px; line-height: 1.8;">
                                <li>Open the related Scenario (or create the new one above)</li>
                                <li>Scroll to <strong>Inherited Configuration</strong> ‚Üí <strong>Effective Synonyms</strong></li>
                                <li>Click <strong>+ Quick Add</strong></li>
                                <li>Paste the base term and its synonyms</li>
                            </ol>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- CATEGORY WARNING -->
                    <div style="padding: 12px 20px; background: rgba(234, 179, 8, 0.1); border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--accent-yellow); font-size: 13px;">
                            ‚ö†Ô∏è <strong>Required Category:</strong> "${content.category}" ‚Äî Add this category in Scenario Builder if it doesn't exist.
                        </span>
                    </div>
                    
                    <!-- SCENARIO BUILDER FIELDS (Exact field names from form) -->
                    <div class="todo-step">
                        <div class="todo-step-title">
                            <span>üìù SCENARIO BUILDER ‚Äî Copy these values</span>
                        </div>
                        
                        <table class="todo-field-table" style="margin-bottom: 16px;">
                            <tr>
                                <td style="background: rgba(139, 92, 246, 0.2); color: #a78bfa;">Name *</td>
                                <td>${content.scenarioName} <button class="copy-btn" onclick="copyFromStore('${dataId}_name', this)">üìã</button></td>
                            </tr>
                            <tr>
                                <td style="background: rgba(139, 92, 246, 0.2); color: #a78bfa;">Category *</td>
                                <td>${content.category} <span style="color: var(--text-muted);">(select from dropdown)</span></td>
                            </tr>
                        </table>
                        
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: 500; color: var(--accent-purple);">Triggers * <span style="font-weight: normal; color: var(--text-muted);">(one per line)</span></span>
                                <button class="copy-btn" onclick="copyFromStore('${dataId}_triggers', this)">üìã Copy All</button>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.8; max-height: 150px; overflow-y: auto;">
                                ${content.triggers.map(t => `<div>${t}</div>`).join('')}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: 500; color: var(--accent-red);">Negative Triggers <span style="font-weight: normal; color: var(--text-muted);">(one per line)</span></span>
                                <button class="copy-btn" onclick="copyFromStore('${dataId}_negative', this)">üìã Copy All</button>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.8;">
                                ${content.negativeTriggers.map(t => `<div>${t}</div>`).join('')}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: 500; color: var(--accent-cyan);">Quick Replies * <span style="font-weight: normal; color: var(--text-muted);">(5 short responses, one per line)</span></span>
                                <button class="copy-btn" onclick="copyFromStore('${dataId}_quick', this)">üìã Copy All</button>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.8;">
                                ${content.quickReplies.map(t => `<div>${t}</div>`).join('')}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: 500; color: var(--accent-green);">Full Replies * <span style="font-weight: normal; color: var(--text-muted);">(5 complete responses, one per line)</span></span>
                                <button class="copy-btn" onclick="copyFromStore('${dataId}_full', this)">üìã Copy All</button>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.8; max-height: 200px; overflow-y: auto;">
                                ${content.fullReplies.map(t => `<div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed var(--border-color);">${t}</div>`).join('')}
                            </div>
                        </div>
                        
                        <!-- Replies & Flow Tab Settings -->
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border-color);">
                            <div style="font-weight: 600; color: var(--accent-cyan); margin-bottom: 12px; font-size: 13px;">üìù Replies & Flow Tab</div>
                            <table class="todo-field-table">
                                <tr>
                                    <td style="background: rgba(6, 182, 212, 0.2); color: #22d3ee;">Follow Up Mode</td>
                                    <td>${content.followUpMode} <span style="color: var(--text-muted);">(Advanced Settings tab)</span></td>
                                </tr>
                                <tr>
                                    <td style="background: rgba(6, 182, 212, 0.2); color: #22d3ee;">Reply Selection Strategy</td>
                                    <td>üé≤ ${content.replySelection} <span style="color: var(--text-muted);">(dropdown)</span></td>
                                </tr>
                                <tr>
                                    <td style="background: rgba(6, 182, 212, 0.2); color: #22d3ee;">Scenario Type</td>
                                    <td>üöÄ ${content.scenarioType} <span style="color: var(--text-muted);">(dropdown)</span></td>
                                </tr>
                                <tr>
                                    <td style="background: rgba(6, 182, 212, 0.2); color: #22d3ee;">Reply Strategy</td>
                                    <td>üéØ ${content.replyStrategy} <span style="color: var(--text-muted);">(dropdown)</span></td>
                                </tr>
                            </table>
                        </div>
                        
                        <!-- Advanced Settings Tab -->
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border-color);">
                            <div style="font-weight: 600; color: var(--accent-orange); margin-bottom: 12px; font-size: 13px;">‚öôÔ∏è Advanced Settings Tab</div>
                            <table class="todo-field-table">
                                <tr>
                                    <td style="background: rgba(249, 115, 22, 0.2); color: #fb923c;">Priority Level</td>
                                    <td><strong style="color: ${content.priorityLevel >= 90 ? 'var(--accent-green)' : content.priorityLevel >= 70 ? 'var(--accent-yellow)' : 'var(--text-primary)'};">${content.priorityLevel}</strong> <span style="color: var(--text-muted);">(0-100, higher = matched first)</span></td>
                                </tr>
                                <tr>
                                    <td style="background: rgba(249, 115, 22, 0.2); color: #fb923c;">Personality</td>
                                    <td>${content.personality.replace(/_/g, ' ')} <span style="color: var(--text-muted);">(if available)</span></td>
                                </tr>
                                <tr>
                                    <td style="background: rgba(249, 115, 22, 0.2); color: #fb923c;">Handoff Policy</td>
                                    <td>${content.handoffPolicy.replace(/_/g, ' ')} <span style="color: var(--text-muted);">(dropdown)</span></td>
                                </tr>
                                <tr>
                                    <td style="background: rgba(249, 115, 22, 0.2); color: #fb923c;">Cooldown</td>
                                    <td>${content.cooldown} seconds <span style="color: var(--text-muted);">(prevent spam)</span></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- TRIAGE CARD FIELDS -->
                    <div class="todo-step">
                        <div class="todo-step-title">
                            <span>üìã TRIAGE CARD ‚Äî Copy these values (after scenario is saved)</span>
                        </div>
                        
                        <table class="todo-field-table">
                            <tr>
                                <td style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">Card Name *</td>
                                <td>${content.scenarioName} <button class="copy-btn" onclick="copyFromStore('${dataId}_name', this)">üìã</button></td>
                            </tr>
                            <tr>
                                <td style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">Triage Tag *</td>
                                <td>${content.triageTag} <button class="copy-btn" onclick="copyFromStore('${dataId}_tag', this)">üìã</button></td>
                            </tr>
                            <tr>
                                <td style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">Category *</td>
                                <td>${content.category} <span style="color: var(--text-muted);">(select from dropdown)</span></td>
                            </tr>
                            <tr>
                                <td style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">Opening Line *</td>
                                <td>${content.fullReplies[0].split('.')[0]}. <button class="copy-btn" onclick="copyFromStore('${dataId}_opening', this)">üìã</button></td>
                            </tr>
                            <tr>
                                <td style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">Action *</td>
                                <td>${content.category === 'Booking' ? 'BOOK' : content.category === 'Emergency' ? 'TRANSFER' : 'ASK_FOLLOWUP'} <span style="color: var(--text-muted);">(select from dropdown)</span></td>
                            </tr>
                            <tr>
                                <td style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">Keywords *</td>
                                <td>${content.triggers.slice(0, 5).join(', ')} <button class="copy-btn" onclick="copyFromStore('${dataId}_keywords', this)">üìã</button></td>
                            </tr>
                            <tr>
                                <td style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">Linked Scenario</td>
                                <td>${content.scenarioName} <span style="color: var(--text-muted);">(select after creating scenario)</span></td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- RESULT -->
                    <div style="padding: 16px 20px; background: rgba(34, 197, 94, 0.1); border-top: 1px solid var(--border-color);">
                        <span style="color: var(--accent-green); font-size: 13px;">
                            ‚úÖ <strong>After adding both:</strong> Callers saying "${safeText}..." will fast-match instantly (0ms vs ~5000ms LLM)
                        </span>
                    </div>
                </div>
            `;
        }
        
        function copyValue(value, btn) {
            navigator.clipboard.writeText(value).then(() => {
                if (!btn) return;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.style.background = 'var(--accent-green)';
                btn.style.color = 'white';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 1000);
            });
        }
        
        function copyFromStore(key, btn) {
            const value = window.copyData[key] || '';
            navigator.clipboard.writeText(value).then(() => {
                if (!btn) return;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.style.background = 'var(--accent-green)';
                btn.style.color = 'white';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 1000);
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TABS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function setupTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update buttons
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Update content
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById('tab' + capitalize(btn.dataset.tab)).classList.add('active');
                });
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ACTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function copySnapshot() {
            if (snapshot) {
                await navigator.clipboard.writeText(snapshot);
                alert('‚úÖ Engineering snapshot copied to clipboard!');
            }
        }

        function exportJSON() {
            const blob = new Blob([JSON.stringify(recording, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `blackbox-${callId}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // HELPERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function formatPhone(phone) {
            if (!phone) return '-';
            const digits = phone.replace(/\D/g, '');
            if (digits.length === 11 && digits.startsWith('1')) {
                return `+1 ${digits.slice(1,4)}-${digits.slice(4,7)}-${digits.slice(7)}`;
            }
            return phone;
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${String(secs).padStart(2, '0')}`;
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function formatEventData(event) {
            const data = event.data || {};
            const truncate = (str, len) => str && str.length > len ? str.substring(0, len) + '...' : str || '';
            
            switch (event.type) {
                // === Call Lifecycle ===
                case 'CALL_START':
                    return `${data.from || '?'} ‚Üí ${data.to || '?'} (${data.source || 'voice'})`;
                case 'GREETING_SENT':
                    return `"${truncate(data.text, 50)}"`;
                case 'GATHER_FINAL':
                case 'GATHER_PARTIAL':
                    return `"${truncate(data.text, 50)}" (conf: ${(data.confidence || 0).toFixed(2)})`;
                case 'GATHER_TIMEOUT':
                    return `${data.reason || 'No speech'} ‚Üí ${data.nextAction || '?'}`;
                    
                // === V2: Scenario Matching ===
                case 'SCENARIO_MATCH_ATTEMPT':
                    return `Checking ${data.scenariosChecked || '?'} scenarios for "${truncate(data.normalizedInput, 30)}"`;
                case 'SCENARIO_MATCHED':
                    return `‚úÖ ${(data.tier || 'tier1').toUpperCase()}: ${data.scenarioName || '?'} (${(data.confidence || 0).toFixed(2)})`;
                case 'SCENARIO_NO_MATCH':
                    return `Best: ${data.bestCandidate || 'none'} (${(data.bestConfidence || 0).toFixed(2)} < ${data.threshold || 0.7})`;
                case 'TIER3_FALLBACK':
                    return `‚ö†Ô∏è LLM called: ${data.latencyMs || '?'}ms, ${data.tokensUsed || 0} tokens`;
                    
                // === Response ===
                case 'AGENT_RESPONSE_BUILT':
                    const source = data.source || 'unknown';
                    const tokens = data.tokensUsed ? ` (${data.tokensUsed} tokens)` : '';
                    return `[${source}]${tokens} "${truncate(data.text, 40)}"`;
                case 'TURN_COMPLETE':
                    return `${data.handler || '?'} ‚Üí ${data.action || '?'}`;
                    
                // === State ===
                case 'STATE_LOADED':
                    return `${data.source || '?'} (turn ${data.turnCount || 0})`;
                case 'STATE_SAVED':
                    return `${data.result || '?'}`;
                case 'ROUTING_DECISION':
                    return `${data.path || '?'} (LLM-0: ${data.llm0Enabled ? 'ON' : 'OFF'})`;
                case 'HYBRID_PATH_START':
                    return `"${truncate(data.userInput, 40)}"`;
                case 'HYBRID_PATH_SUCCESS':
                    return `${data.latencyMs || '?'}ms - mode: ${data.mode || '?'}`;
                case 'PATH_RESOLVED':
                    return `${data.usedPath || '?'}: ${data.latencyMs || '?'}ms`;
                    
                // === Intent & Mode ===
                case 'INTENT_DETECTED':
                    return `${data.intent || '?'} (${(data.confidence || 0).toFixed(2)})`;
                case 'MODE_CHANGED':
                    return `${data.fromMode || '?'} ‚Üí ${data.toMode || '?'}`;
                    
                // === Booking ===
                case 'BOOKING_MODE_LOCKED':
                    return `Intent confidence: ${(data.intentConfidence || 0).toFixed(2)}`;
                case 'SLOT_COLLECTED':
                    return `‚úÖ ${data.slot}: "${truncate(data.value, 30)}"`;
                case 'SLOT_ASKING':
                    return `Asking: ${data.slot}`;
                case 'BOOKING_COMPLETE':
                    return `All slots filled`;
                    
                // === TTS ===
                case 'TTS_STARTED':
                    return `${data.voiceId || '?'} (${data.textLength || 0} chars)`;
                case 'TTS_COMPLETED':
                    return `${data.latencyMs || '?'}ms`;
                case 'TWIML_SENT':
                    return `${data.route || '?'} (${data.twimlLength || 0} bytes)`;
                    
                // === STT ===
                case 'STT_PREPROCESSING':
                    const fillers = data.fillersRemoved?.length || 0;
                    return `${fillers} fillers removed ‚Üí "${truncate(data.cleaned, 40)}"`;
                case 'STT_HINTS_LOADED':
                    return `${data.hintsCount || 0} hints from ${data.source || '?'}`;
                    
                // === Errors ===
                case 'BAILOUT_TRIGGERED':
                    return `üö® ${data.type || '?'} - ${data.reason || '?'}`;
                case 'CONVERSATION_ENGINE_ERROR':
                    return `‚ùå ${data.errorType || 'Error'}: ${truncate(data.error, 60)}`;
                case 'ERROR_OCCURRED':
                    return `‚ùå ${data.source || '?'}: ${truncate(data.message, 60)}`;
                    
                // === Customer ===
                case 'CUSTOMER_IDENTIFIED':
                    return `${data.isReturning ? 'üîÑ Returning' : 'üÜï New'}: ${data.customerName || '?'}`;
                    
                // === Legacy ===
                case 'TRIAGE_DECISION':
                    return `${data.route || data.cardName || '?'}`;
                case 'LLM_FALLBACK':
                    return `${data.ms || '?'}ms`;
                case 'FAST_MATCH_HIT':
                    return `${data.cardName || '?'}`;
                case 'SYNONYM_TRANSLATION':
                    const reps = data.replacements || [];
                    return `üó£Ô∏è ${reps.length > 0 ? reps.slice(0, 2).join(', ') : 'none'}`;
                case 'MATCHING_PIPELINE':
                    const m = data.matching || {};
                    return `üî¨ ${m.decision || '?'}: ${m.selected || 'none'}`;
                    
                default:
                    // Compact JSON display for unknown events
                    const json = JSON.stringify(data);
                    return json.length > 80 ? json.substring(0, 77) + '...' : json;
            }
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function showError(message) {
            document.getElementById('callHeader').innerHTML = `
                <div class="loading-state">
                    <h3>‚ùå Error</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BLACK BOX BUILDER - Create Scenario & Card from Gaps
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let currentGapData = null;
        let createdScenarioId = null;
        let builderStep = 1; // 1 = scenario, 2 = card, 3 = done

        function openScenarioBuilder(gapIndex) {
            const gaps = analyzeCoverageGaps();
            currentGapData = gaps[gapIndex];
            builderStep = 1;
            createdScenarioId = null;
            
            // Pre-fill form
            const suggestion = currentGapData.issues.find(i => i.cardSuggested)?.cardSuggested || 
                              generateCardSuggestion(currentGapData.text, null);
            const keywords = currentGapData.suggestions?.keywords || extractKeywords(currentGapData.text);
            
            document.getElementById('scenarioName').value = suggestion.name;
            document.getElementById('scenarioCategory').value = suggestion.category;
            document.getElementById('scenarioTriggers').value = [
                currentGapData.text,
                ...keywords.slice(0, 3).map(k => k + ' service'),
                ...keywords.slice(0, 2).map(k => 'need ' + k)
            ].join('\n');
            document.getElementById('scenarioNegatives').value = 'cancel\nreschedule\nwhat time';
            document.getElementById('scenarioQuickReplies').value = [
                "Got it, let me help with that.",
                "I can assist you with that.",
                "Sure, let me help."
            ].join('\n');
            document.getElementById('scenarioFullReplies').value = [
                suggestion.openingLine,
                suggestion.openingLine.replace("I'd be happy to", "Let me help you"),
                suggestion.openingLine.replace("I'd be happy to", "Sure, I can")
            ].join('\n');
            document.getElementById('scenarioFollowUp').value = 'ASK_FOLLOWUP_QUESTION';
            
            updateStepIndicator(1);
            showModal('scenarioModal');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function updateStepIndicator(step) {
            document.querySelectorAll('.bb-step').forEach((el, idx) => {
                el.classList.remove('active', 'completed');
                if (idx + 1 < step) el.classList.add('completed');
                if (idx + 1 === step) el.classList.add('active');
            });
            document.querySelectorAll('.bb-step-connector').forEach((el, idx) => {
                el.classList.toggle('completed', idx + 1 < step);
            });
        }

        async function saveScenario() {
            const btn = document.getElementById('saveScenarioBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                const token = localStorage.getItem('adminToken');
                
                // Get the active template ID first
                const templatesRes = await fetch('/api/admin/global-instant-responses', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const templatesData = await templatesRes.json();
                const activeTemplate = templatesData.data?.find(t => t.isActive) || templatesData.data?.[0];
                
                if (!activeTemplate) {
                    throw new Error('No active template found. Please create a template first.');
                }
                
                // Find or create category
                const category = document.getElementById('scenarioCategory').value;
                let targetCategory = activeTemplate.categories?.find(c => 
                    c.name.toLowerCase() === category.toLowerCase()
                );
                
                if (!targetCategory && activeTemplate.categories?.length > 0) {
                    targetCategory = activeTemplate.categories[0];
                }
                
                if (!targetCategory) {
                    throw new Error('No categories found in template. Please add a category first.');
                }
                
                // Build scenario data
                const scenarioData = {
                    scenarioId: 'SCEN_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6),
                    name: document.getElementById('scenarioName').value,
                    isActive: true,
                    triggers: document.getElementById('scenarioTriggers').value.split('\n').filter(t => t.trim()),
                    negativeTriggers: document.getElementById('scenarioNegatives').value.split('\n').filter(t => t.trim()),
                    quickReplies: document.getElementById('scenarioQuickReplies').value.split('\n').filter(t => t.trim()),
                    fullReplies: document.getElementById('scenarioFullReplies').value.split('\n').filter(t => t.trim()),
                    followUpMode: document.getElementById('scenarioFollowUp').value,
                    minConfidence: 0.70,
                    priority: 0,
                    categories: [category]
                };
                
                // Save scenario
                const response = await fetch(`/api/admin/global-instant-responses/${activeTemplate._id}/categories/${targetCategory.id}/scenarios`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scenarioData)
                });
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Failed to save scenario');
                }
                
                const result = await response.json();
                createdScenarioId = scenarioData.scenarioId;
                
                // Show success and prepare for card creation
                showScenarioSuccess(scenarioData.name);
                
            } catch (error) {
                console.error('Failed to save scenario:', error);
                alert('‚ùå Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚úÖ Confirm & Save Scenario';
            }
        }

        function showScenarioSuccess(scenarioName) {
            builderStep = 2;
            updateStepIndicator(2);
            
            const modalBody = document.querySelector('#scenarioModal .bb-modal-body');
            modalBody.innerHTML = `
                <div class="bb-success-message">
                    <div class="bb-success-icon">‚úÖ</div>
                    <div class="bb-success-title">Scenario Created!</div>
                    <div class="bb-success-detail">"${scenarioName}" has been saved.</div>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        Now create the Triage Card to trigger this scenario when callers speak.
                    </p>
                    <button class="bb-btn bb-btn-success" onclick="openCardBuilder()">
                        ‚ûï Create Triage Card
                    </button>
                </div>
            `;
            
            // Hide footer save button
            document.querySelector('#scenarioModal .bb-modal-footer').style.display = 'none';
        }

        function openCardBuilder() {
            closeModal('scenarioModal');
            
            // Pre-fill card form from scenario
            const scenarioName = document.getElementById('scenarioName')?.value || currentGapData?.issues.find(i => i.cardSuggested)?.cardSuggested?.name || 'New Card';
            const suggestion = currentGapData?.issues.find(i => i.cardSuggested)?.cardSuggested || {};
            const keywords = currentGapData?.suggestions?.keywords || extractKeywords(currentGapData?.text || '');
            
            document.getElementById('cardName').value = scenarioName;
            document.getElementById('cardTriageTag').value = (suggestion.triageTag || scenarioName.toUpperCase().replace(/\s+/g, '_')).substring(0, 50);
            document.getElementById('cardCategory').value = suggestion.category || 'general';
            document.getElementById('cardAction').value = suggestion.action || 'ASK_FOLLOWUP';
            document.getElementById('cardOpeningLine').value = suggestion.openingLine || "I can help you with that.";
            document.getElementById('cardKeywords').value = keywords.join(', ');
            
            showModal('cardModal');
        }

        async function saveCard() {
            const btn = document.getElementById('saveCardBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                const token = localStorage.getItem('adminToken');
                
                // Build card data
                const cardData = {
                    companyId: companyId,
                    trade: 'hvac', // Default, could be made dynamic
                    triageLabel: document.getElementById('cardName').value,
                    triageTag: document.getElementById('cardTriageTag').value,
                    category: document.getElementById('cardCategory').value,
                    action: document.getElementById('cardAction').value,
                    openingLine: document.getElementById('cardOpeningLine').value,
                    keywords: document.getElementById('cardKeywords').value.split(',').map(k => k.trim()).filter(k => k),
                    isActive: true,
                    linkedScenarioId: createdScenarioId
                };
                
                // Save card
                const response = await fetch(`/api/company/${companyId}/triage-cards`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(cardData)
                });
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Failed to save card');
                }
                
                // Show final success
                showFinalSuccess(cardData.triageLabel);
                
            } catch (error) {
                console.error('Failed to save card:', error);
                alert('‚ùå Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚úÖ Confirm & Save Card';
            }
        }

        function showFinalSuccess(cardName) {
            builderStep = 3;
            updateStepIndicator(3);
            
            const modalBody = document.querySelector('#cardModal .bb-modal-body');
            modalBody.innerHTML = `
                <div class="bb-success-message">
                    <div class="bb-success-icon">üéâ</div>
                    <div class="bb-success-title">Coverage Gap Resolved!</div>
                    <div class="bb-success-detail">
                        <p>‚úì Scenario created</p>
                        <p>‚úì Triage Card "${cardName}" created</p>
                        <p>‚úì Keywords configured</p>
                    </div>
                    <p style="color: var(--accent-green); margin-bottom: 20px; font-weight: 500;">
                        Next caller saying "${currentGapData?.text?.substring(0, 40)}..." will fast-match! üöÄ
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button class="bb-btn bb-btn-secondary" onclick="closeModal('cardModal'); renderTodo();">
                            üîô Back to TODO
                        </button>
                        <button class="bb-btn bb-btn-primary" onclick="closeModal('cardModal'); window.location.reload();">
                            üîÑ Refresh Page
                        </button>
                    </div>
                </div>
            `;
            
            document.querySelector('#cardModal .bb-modal-footer').style.display = 'none';
        }
    </script>

    <!-- Scenario Builder Modal -->
    <div id="scenarioModal" class="bb-modal-overlay">
        <div class="bb-modal">
            <div class="bb-modal-header">
                <h2>üìù Create Scenario</h2>
                <button class="bb-modal-close" onclick="closeModal('scenarioModal')">&times;</button>
            </div>
            <div class="bb-modal-body">
                <!-- Step Indicator -->
                <div class="bb-step-indicator">
                    <div class="bb-step active">1</div>
                    <div class="bb-step-connector"></div>
                    <div class="bb-step">2</div>
                    <div class="bb-step-connector"></div>
                    <div class="bb-step">3</div>
                </div>
                
                <div class="bb-form-group">
                    <label class="bb-form-label">Scenario Name</label>
                    <input type="text" id="scenarioName" class="bb-form-input" placeholder="e.g., Service Appointment Request">
                </div>
                
                <div class="bb-form-group">
                    <label class="bb-form-label">Category</label>
                    <select id="scenarioCategory" class="bb-form-select">
                        <option value="booking">Booking</option>
                        <option value="troubleshooting">Troubleshooting</option>
                        <option value="information">Information</option>
                        <option value="emergency">Emergency</option>
                        <option value="general">General</option>
                    </select>
                </div>
                
                <div class="bb-form-group">
                    <label class="bb-form-label">Triggers (what caller says - one per line)</label>
                    <textarea id="scenarioTriggers" class="bb-form-textarea" placeholder="schedule ac service
book appointment
need a technician"></textarea>
                    <div class="bb-form-hint">These phrases will trigger this scenario</div>
                </div>
                
                <div class="bb-form-group">
                    <label class="bb-form-label">Negative Triggers (prevent false match - one per line)</label>
                    <textarea id="scenarioNegatives" class="bb-form-textarea" placeholder="cancel
reschedule
what time is my appointment"></textarea>
                    <div class="bb-form-hint">If caller says these, this scenario will NOT match</div>
                </div>
                
                <div class="bb-form-group">
                    <label class="bb-form-label">Quick Replies (3 short responses)</label>
                    <textarea id="scenarioQuickReplies" class="bb-form-textarea" placeholder="Got it, let me help.
I can assist with that.
Sure, let me check."></textarea>
                </div>
                
                <div class="bb-form-group">
                    <label class="bb-form-label">Full Replies (3-5 complete responses)</label>
                    <textarea id="scenarioFullReplies" class="bb-form-textarea" placeholder="I'd be happy to schedule that for you.
Let me help you book an appointment.
Sure, let's get you set up with a technician."></textarea>
                </div>
                
                <div class="bb-form-group">
                    <label class="bb-form-label">After Responding</label>
                    <select id="scenarioFollowUp" class="bb-form-select">
                        <option value="ASK_FOLLOWUP_QUESTION">Ask follow-up question</option>
                        <option value="ASK_IF_BOOK">Ask if they want to book</option>
                        <option value="TRANSFER">Transfer to human</option>
                        <option value="NONE">End conversation</option>
                    </select>
                </div>
            </div>
            <div class="bb-modal-footer">
                <button class="bb-btn bb-btn-secondary" onclick="closeModal('scenarioModal')">Cancel</button>
                <button id="saveScenarioBtn" class="bb-btn bb-btn-success" onclick="saveScenario()">‚úÖ Confirm & Save Scenario</button>
            </div>
        </div>
    </div>

    <!-- Triage Card Builder Modal -->
    <div id="cardModal" class="bb-modal-overlay">
        <div class="bb-modal">
            <div class="bb-modal-header">
                <h2>üìã Create Triage Card</h2>
                <button class="bb-modal-close" onclick="closeModal('cardModal')">&times;</button>
            </div>
            <div class="bb-modal-body">
                <!-- Step Indicator -->
                <div class="bb-step-indicator">
                    <div class="bb-step completed">1</div>
                    <div class="bb-step-connector completed"></div>
                    <div class="bb-step active">2</div>
                    <div class="bb-step-connector"></div>
                    <div class="bb-step">3</div>
                </div>
                
                <div class="bb-form-group">
                    <label class="bb-form-label">Card Name</label>
                    <input type="text" id="cardName" class="bb-form-input" placeholder="e.g., Service Appointment Request">
                </div>
                
                <div class="bb-form-group">
                    <label class="bb-form-label">Triage Tag (auto-generated)</label>
                    <input type="text" id="cardTriageTag" class="bb-form-input" placeholder="BOOKING_SERVICE_APPOINTMENT">
                    <div class="bb-form-hint">Used internally for routing</div>
                </div>
                
                <div class="bb-form-group">
                    <label class="bb-form-label">Category</label>
                    <select id="cardCategory" class="bb-form-select">
                        <option value="booking">Booking</option>
                        <option value="troubleshooting">Troubleshooting</option>
                        <option value="information">Information</option>
                        <option value="emergency">Emergency</option>
                        <option value="general">General</option>
                    </select>
                </div>
                
                <div class="bb-form-group">
                    <label class="bb-form-label">Action</label>
                    <select id="cardAction" class="bb-form-select">
                        <option value="BOOK">Start Booking Flow</option>
                        <option value="ASK_FOLLOWUP">Ask Follow-up Question</option>
                        <option value="TRANSFER">Transfer to Human</option>
                        <option value="MESSAGE_ONLY">Take Message</option>
                    </select>
                </div>
                
                <div class="bb-form-group">
                    <label class="bb-form-label">Opening Line</label>
                    <input type="text" id="cardOpeningLine" class="bb-form-input" placeholder="I'd be happy to schedule that for you.">
                    <div class="bb-form-hint">First thing AI says when this card matches</div>
                </div>
                
                <div class="bb-form-group">
                    <label class="bb-form-label">Keywords (comma separated)</label>
                    <input type="text" id="cardKeywords" class="bb-form-input" placeholder="schedule, book, appointment, technician">
                    <div class="bb-form-hint">Keywords that trigger fast-match (no LLM needed)</div>
                </div>
            </div>
            <div class="bb-modal-footer">
                <button class="bb-btn bb-btn-secondary" onclick="closeModal('cardModal')">Cancel</button>
                <button id="saveCardBtn" class="bb-btn bb-btn-success" onclick="saveCard()">‚úÖ Confirm & Save Card</button>
            </div>
        </div>
    </div>
</body>
</html>

