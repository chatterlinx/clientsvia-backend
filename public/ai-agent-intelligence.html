<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Intelligence Settings - ClientsVia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CSS warnings
        tailwind.config = { corePlugins: { preflight: false } }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .settings-card {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }
        .settings-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .toggle-switch {
            appearance: none;
            width: 44px;
            height: 24px;
            background: #cbd5e1;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch:checked {
            background: #3b82f6;
        }
        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        .toggle-switch:checked::before {
            transform: translateX(20px);
        }
        .confidence-meter {
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
            height: 6px;
            border-radius: 3px;
        }
        .llm-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-active { background: #d1fae5; color: #065f46; }
        .status-fallback { background: #fef3c7; color: #92400e; }
        .status-disabled { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-brain text-blue-600 mr-2"></i>
                        AI Agent Intelligence Settings
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <select id="companySelect" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Select Company...</option>
                    </select>
                    <button onclick="saveAllSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition-colors">
                        <i class="fas fa-save mr-2"></i>Save All Settings
                    </button>
                    <a href="/" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-home"></i>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Warning Banner -->
        <div id="warningBanner" class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
            <div class="flex">
                <i class="fas fa-exclamation-triangle text-amber-400 mr-3 mt-0.5"></i>
                <div>
                    <h3 class="text-sm font-medium text-amber-800">AI Agent Intelligence Configuration</h3>
                    <p class="text-sm text-amber-700 mt-1">
                        These settings control how your AI agent thinks, learns, and responds. Changes take effect immediately for new calls.
                        <strong>Test thoroughly before deploying to production.</strong>
                    </p>
                </div>
            </div>
        </div>

        <!-- Company Info Panel -->
        <div id="companyInfo" class="bg-white rounded-lg shadow-sm p-6 mb-6 hidden">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900" id="companyName">Company Name</h2>
                    <p class="text-sm text-gray-500" id="companyDetails">Trade Types â€¢ Phone Number</p>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- AI Status Indicator -->
                    <div class="flex items-center">
                        <div id="aiStatusDot" class="w-3 h-3 bg-green-400 rounded-full mr-2"></div>
                        <span id="aiStatusText" class="text-sm text-gray-600">AI Agent Active</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Settings Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- LLM & Processing Settings -->
            <div class="settings-card bg-white rounded-lg p-6">
                <h3 class="section-header text-lg font-semibold mb-4">
                    <i class="fas fa-microchip mr-2"></i>LLM & Processing Engine
                </h3>
                
                <!-- Primary LLM Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Primary LLM Model</label>
                    <select id="primaryLLM" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="ollama-phi3">Ollama Phi-3 (Fast, Local)</option>
                        <option value="ollama-mistral">Ollama Mistral (Balanced)</option>
                        <option value="gemini-pro">Gemini Pro (Cloud, Powerful)</option>
                        <option value="openai-gpt4">OpenAI GPT-4 (Premium)</option>
                        <option value="claude-3">Claude-3 (Advanced)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Primary AI model for answering questions</p>
                </div>

                <!-- Fallback LLM -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fallback LLM Model</label>
                    <select id="fallbackLLM" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="gemini-pro">Gemini Pro (Reliable Cloud)</option>
                        <option value="ollama-phi3">Ollama Phi-3 (Local)</option>
                        <option value="ollama-mistral">Ollama Mistral (Local)</option>
                        <option value="openai-gpt4">OpenAI GPT-4 (Premium)</option>
                        <option value="claude-3">Claude-3 (Advanced)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Backup model when primary fails</p>
                </div>

                <!-- Processing Mode -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Processing Mode</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="useLLM" class="toggle-switch">
                            <span class="ml-3 text-sm text-gray-700">Enable LLM Processing</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="semanticSearchEnabled" class="toggle-switch">
                            <span class="ml-3 text-sm text-gray-700">Enable Semantic Search</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="confidenceScoring" class="toggle-switch">
                            <span class="ml-3 text-sm text-gray-700">Confidence Scoring</span>
                        </label>
                    </div>
                </div>

                <!-- LLM Status Display -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">LLM Status</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Ollama (Local)</span>
                            <span id="ollamaStatus" class="llm-status status-active">Active</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Gemini Pro</span>
                            <span id="geminiStatus" class="llm-status status-fallback">Fallback</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">OpenAI GPT-4</span>
                            <span id="openaiStatus" class="llm-status status-disabled">Disabled</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Intelligence & Memory Settings -->
            <div class="settings-card bg-white rounded-lg p-6">
                <h3 class="section-header text-lg font-semibold mb-4">
                    <i class="fas fa-brain mr-2"></i>Intelligence & Memory
                </h3>

                <!-- Memory Mode -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Memory Mode</label>
                    <select id="memoryMode" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="short">Short Term (Single Response)</option>
                        <option value="conversation">Conversation (Full Call Memory)</option>
                        <option value="session">Session (Cross-Call Memory)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">How much context the agent remembers</p>
                </div>

                <!-- AI Intelligence Features -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">AI Intelligence Features</label>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700">Contextual Memory</span>
                            <input type="checkbox" id="contextualMemory" class="toggle-switch">
                        </label>
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700">Dynamic Reasoning</span>
                            <input type="checkbox" id="dynamicReasoning" class="toggle-switch">
                        </label>
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700">Smart Escalation</span>
                            <input type="checkbox" id="smartEscalation" class="toggle-switch">
                        </label>
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700">Auto Learning Queue</span>
                            <input type="checkbox" id="autoLearningQueue" class="toggle-switch">
                        </label>
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700">Real-time Optimization</span>
                            <input type="checkbox" id="realTimeOptimization" class="toggle-switch">
                        </label>
                    </div>
                </div>

                <!-- Context Retention -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Context Retention</label>
                    <div class="flex items-center space-x-4">
                        <input type="range" id="contextRetention" min="5" max="120" value="30" class="flex-1">
                        <span id="contextRetentionValue" class="text-sm font-medium text-gray-600 min-w-16">30 min</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">How long to remember caller context</p>
                </div>
            </div>

            <!-- Confidence & Escalation Settings -->
            <div class="settings-card bg-white rounded-lg p-6">
                <h3 class="section-header text-lg font-semibold mb-4">
                    <i class="fas fa-chart-line mr-2"></i>Confidence & Escalation
                </h3>

                <!-- Fallback Threshold -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fallback Confidence Threshold</label>
                    <div class="relative">
                        <input type="range" id="fallbackThreshold" min="0" max="1" step="0.05" value="0.5" class="w-full">
                        <div class="confidence-meter w-full mt-2"></div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>Low (0.0)</span>
                            <span id="fallbackThresholdValue" class="font-medium">0.5</span>
                            <span>High (1.0)</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Minimum confidence before escalation</p>
                </div>

                <!-- Escalation Mode -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Escalation Mode</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="escalationMode" value="ask" class="mr-3">
                            <div>
                                <div class="text-sm font-medium">Ask First</div>
                                <div class="text-xs text-gray-500">Confirm before escalating</div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="escalationMode" value="auto" class="mr-3">
                            <div>
                                <div class="text-sm font-medium">Auto Escalate</div>
                                <div class="text-xs text-gray-500">Escalate immediately</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Response Limits -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Re-prompt After Turns</label>
                        <input type="number" id="rePromptAfterTurns" min="1" max="10" value="3" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Max Prompts Per Call</label>
                        <input type="number" id="maxPromptsPerCall" min="1" max="10" value="2" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Custom Escalation Message -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Custom Escalation Message</label>
                    <textarea id="customEscalationMessage" rows="3" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="I understand you have a question I haven't been able to answer directly..."></textarea>
                </div>
            </div>

            <!-- Learning & Knowledge Settings -->
            <div class="settings-card bg-white rounded-lg p-6">
                <h3 class="section-header text-lg font-semibold mb-4">
                    <i class="fas fa-graduation-cap mr-2"></i>Learning & Knowledge
                </h3>

                <!-- Auto Learning -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Auto Learning Configuration</label>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between">
                            <span class="text-sm text-gray-700">Enable Auto Learning</span>
                            <input type="checkbox" id="autoLearningEnabled" class="toggle-switch">
                        </label>
                        <div class="ml-4 space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Learning Approval Mode</label>
                                <select id="learningApprovalMode" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="manual">Manual Approval Required</option>
                                    <option value="auto-high-confidence">Auto-approve High Confidence</option>
                                    <option value="disabled">Learning Disabled</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Learning Confidence Threshold</label>
                                <div class="flex items-center space-x-4">
                                    <input type="range" id="learningConfidenceThreshold" min="0" max="1" step="0.05" value="0.85" class="flex-1">
                                    <span id="learningConfidenceValue" class="text-sm font-medium text-gray-600 min-w-12">0.85</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Sources -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Knowledge Source Priority</label>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <span class="text-sm">Company Q&A</span>
                            <span class="text-xs text-blue-600 font-medium">Priority 1</span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <span class="text-sm">Trade Category Q&A</span>
                            <span class="text-xs text-blue-600 font-medium">Priority 2</span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <span class="text-sm">Vector Search</span>
                            <span class="text-xs text-blue-600 font-medium">Priority 3</span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <span class="text-sm">LLM Fallback</span>
                            <span class="text-xs text-blue-600 font-medium">Priority 4</span>
                        </div>
                    </div>
                </div>

                <!-- Max Pending Q&As -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Max Pending Q&As</label>
                    <input type="number" id="maxPendingQnAs" min="10" max="500" value="100" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Maximum learning queue size</p>
                </div>
            </div>

            <!-- Performance & Monitoring -->
            <div class="settings-card bg-white rounded-lg p-6 lg:col-span-2">
                <h3 class="section-header text-lg font-semibold mb-4">
                    <i class="fas fa-tachometer-alt mr-2"></i>Performance & Monitoring
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Performance Targets -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-3">Performance Targets</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Target Confidence Rate</label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="targetConfidenceRate" min="0.5" max="1" step="0.05" value="0.87" class="flex-1">
                                    <span id="targetConfidenceRateValue" class="text-xs font-medium min-w-10">87%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Target Response Time (s)</label>
                                <input type="number" id="targetResponseTime" min="0.5" max="5" step="0.1" value="1.8" class="w-full text-sm rounded border-gray-300">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Target Escalation Rate</label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="targetEscalationRate" min="0" max="0.5" step="0.01" value="0.12" class="flex-1">
                                    <span id="targetEscalationRateValue" class="text-xs font-medium min-w-10">12%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Features -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-3">Advanced Features</h4>
                        <div class="space-y-2">
                            <label class="flex items-center justify-between">
                                <span class="text-xs text-gray-700">Sentiment Analysis</span>
                                <input type="checkbox" id="sentimentAnalysis" class="toggle-switch scale-75">
                            </label>
                            <label class="flex items-center justify-between">
                                <span class="text-xs text-gray-700">Predictive Intent Analysis</span>
                                <input type="checkbox" id="predictiveIntentAnalysis" class="toggle-switch scale-75">
                            </label>
                            <label class="flex items-center justify-between">
                                <span class="text-xs text-gray-700">A/B Test Strategies</span>
                                <input type="checkbox" id="abTestStrategies" class="toggle-switch scale-75">
                            </label>
                            <label class="flex items-center justify-between">
                                <span class="text-xs text-gray-700">Intelligent Routing</span>
                                <input type="checkbox" id="intelligentRouting" class="toggle-switch scale-75">
                            </label>
                        </div>
                    </div>

                    <!-- Real-time Stats -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-3">Current Performance</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">Confidence Rate</span>
                                <span class="text-xs font-medium text-green-600">94%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">Avg Response Time</span>
                                <span class="text-xs font-medium text-green-600">1.2s</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">Escalation Rate</span>
                                <span class="text-xs font-medium text-yellow-600">8%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">Learning Queue</span>
                                <span class="text-xs font-medium text-blue-600">23 items</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Panel -->
        <div class="mt-6 bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-flask mr-2"></i>Test AI Agent Response
            </h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Test Query</label>
                    <textarea id="testQuery" rows="3" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="What are your hours?"></textarea>
                    <button onclick="testAIResponse()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition-colors">
                        <i class="fas fa-play mr-2"></i>Test Response
                    </button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">AI Response</label>
                    <div id="testResponse" class="p-4 bg-gray-50 rounded-md border min-h-20 text-sm">
                        <span class="text-gray-500 italic">Response will appear here...</span>
                    </div>
                    <div id="testMetrics" class="mt-2 text-xs text-gray-500 hidden">
                        <span class="mr-4">Confidence: <span id="testConfidence">--</span></span>
                        <span class="mr-4">Response Time: <span id="testResponseTime">--</span>ms</span>
                        <span>Method: <span id="testMethod">--</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="mt-6 flex flex-wrap gap-3">
            <button onclick="loadPreset('conservative')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md transition-colors">
                <i class="fas fa-shield-alt mr-2"></i>Conservative Preset
            </button>
            <button onclick="loadPreset('balanced')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition-colors">
                <i class="fas fa-balance-scale mr-2"></i>Balanced Preset
            </button>
            <button onclick="loadPreset('aggressive')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition-colors">
                <i class="fas fa-rocket mr-2"></i>Aggressive Preset
            </button>
            <button onclick="exportSettings()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md transition-colors">
                <i class="fas fa-download mr-2"></i>Export Settings
            </button>
            <button onclick="importSettings()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md transition-colors">
                <i class="fas fa-upload mr-2"></i>Import Settings
            </button>
        </div>
    </div>

    <script>
        let currentCompanyId = null;
        let currentSettings = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadCompanies();
            setupEventListeners();
        });

        function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
        }

        async function loadCompanies() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/company/companies', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const companies = await response.json();
                    const select = document.getElementById('companySelect');
                    companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company._id;
                        option.textContent = company.companyName;
                        select.appendChild(option);
                    });
                } else {
                    console.error('Failed to load companies');
                }
            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }

        function setupEventListeners() {
            // Company selection
            document.getElementById('companySelect').addEventListener('change', function(e) {
                if (e.target.value) {
                    loadCompanySettings(e.target.value);
                } else {
                    hideCompanyInfo();
                }
            });

            // Range sliders
            const ranges = ['fallbackThreshold', 'contextRetention', 'learningConfidenceThreshold', 'targetConfidenceRate', 'targetEscalationRate'];
            ranges.forEach(id => {
                const slider = document.getElementById(id);
                const display = document.getElementById(id + 'Value');
                slider.addEventListener('input', function() {
                    let value = this.value;
                    if (id.includes('Rate') || id.includes('Threshold')) {
                        value = Math.round(value * 100) + '%';
                    } else if (id === 'contextRetention') {
                        value = value + ' min';
                    }
                    display.textContent = value;
                });
            });
        }

        async function loadCompanySettings(companyId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/company/companies/${companyId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const company = await response.json();
                    currentCompanyId = companyId;
                    currentSettings = company;
                    
                    displayCompanyInfo(company);
                    populateSettings(company);
                    document.getElementById('companyInfo').classList.remove('hidden');
                } else {
                    console.error('Failed to load company settings');
                }
            } catch (error) {
                console.error('Error loading company settings:', error);
            }
        }

        function displayCompanyInfo(company) {
            document.getElementById('companyName').textContent = company.companyName;
            
            const details = [];
            if (company.tradeTypes && company.tradeTypes.length > 0) {
                details.push(company.tradeTypes.join(', '));
            }
            if (company.businessPhone || company.companyPhone) {
                details.push(company.businessPhone || company.companyPhone);
            }
            document.getElementById('companyDetails').textContent = details.join(' â€¢ ');

            // Update AI status
            const isEnabled = company.aiSettings?.enabled !== false;
            const statusDot = document.getElementById('aiStatusDot');
            const statusText = document.getElementById('aiStatusText');
            
            if (isEnabled) {
                statusDot.className = 'w-3 h-3 bg-green-400 rounded-full mr-2';
                statusText.textContent = 'AI Agent Active';
            } else {
                statusDot.className = 'w-3 h-3 bg-red-400 rounded-full mr-2';
                statusText.textContent = 'AI Agent Disabled';
            }
        }

        function populateSettings(company) {
            const intelligence = company.agentIntelligenceSettings || {};
            const aiSettings = company.aiSettings || {};

            // LLM Settings
            document.getElementById('primaryLLM').value = intelligence.primaryLLM || 'ollama-phi3';
            document.getElementById('fallbackLLM').value = intelligence.fallbackLLM || 'gemini-pro';
            document.getElementById('useLLM').checked = intelligence.useLLM !== false;
            document.getElementById('semanticSearchEnabled').checked = intelligence.semanticSearchEnabled || false;
            document.getElementById('confidenceScoring').checked = intelligence.confidenceScoring !== false;

            // Memory & Intelligence
            document.getElementById('memoryMode').value = intelligence.memoryMode || 'conversation';
            document.getElementById('contextualMemory').checked = aiSettings.contextualMemory?.enabled !== false;
            document.getElementById('dynamicReasoning').checked = aiSettings.dynamicReasoning?.enabled !== false;
            document.getElementById('smartEscalation').checked = aiSettings.smartEscalation?.enabled !== false;
            document.getElementById('autoLearningQueue').checked = intelligence.autoLearningQueue || false;
            document.getElementById('realTimeOptimization').checked = aiSettings.continuousLearning?.realTimeOptimization !== false;

            // Confidence & Escalation
            const fallbackThreshold = intelligence.fallbackThreshold || 0.5;
            document.getElementById('fallbackThreshold').value = fallbackThreshold;
            document.getElementById('fallbackThresholdValue').textContent = fallbackThreshold;

            const escalationMode = intelligence.escalationMode || 'ask';
            document.querySelector(`input[name="escalationMode"][value="${escalationMode}"]`).checked = true;

            document.getElementById('rePromptAfterTurns').value = intelligence.rePromptAfterTurns || 3;
            document.getElementById('maxPromptsPerCall').value = intelligence.maxPromptsPerCall || 2;
            document.getElementById('customEscalationMessage').value = aiSettings.customEscalationMessage || '';

            // Learning Settings
            document.getElementById('autoLearningEnabled').checked = intelligence.autoLearningEnabled !== false;
            document.getElementById('learningApprovalMode').value = intelligence.learningApprovalMode || 'manual';
            
            const learningThreshold = intelligence.learningConfidenceThreshold || 0.85;
            document.getElementById('learningConfidenceThreshold').value = learningThreshold;
            document.getElementById('learningConfidenceValue').textContent = learningThreshold;

            document.getElementById('maxPendingQnAs').value = intelligence.maxPendingQnAs || 100;

            // Performance Settings
            const targetConfidence = aiSettings.performanceBenchmarks?.targetConfidenceRate || 0.87;
            document.getElementById('targetConfidenceRate').value = targetConfidence;
            document.getElementById('targetConfidenceRateValue').textContent = Math.round(targetConfidence * 100) + '%';

            document.getElementById('targetResponseTime').value = aiSettings.performanceBenchmarks?.targetResponseTime || 1.8;

            const targetEscalation = aiSettings.performanceBenchmarks?.targetEscalationRate || 0.12;
            document.getElementById('targetEscalationRate').value = targetEscalation;
            document.getElementById('targetEscalationRateValue').textContent = Math.round(targetEscalation * 100) + '%';

            // Advanced Features
            document.getElementById('sentimentAnalysis').checked = aiSettings.sentimentAnalysis || false;
            document.getElementById('predictiveIntentAnalysis').checked = aiSettings.continuousLearning?.predictiveIntentAnalysis || false;
            document.getElementById('abTestStrategies').checked = aiSettings.continuousLearning?.abTestStrategies || false;
            document.getElementById('intelligentRouting').checked = intelligence.intelligentRouting !== false;

            // Context retention
            const contextRetention = aiSettings.contextualMemory?.memoryRetentionHours || 24;
            const contextMinutes = Math.round((contextRetention / 24) * 1440); // Convert hours to minutes for display
            document.getElementById('contextRetention').value = Math.min(120, Math.max(5, contextMinutes));
            document.getElementById('contextRetentionValue').textContent = Math.min(120, Math.max(5, contextMinutes)) + ' min';
        }

        function hideCompanyInfo() {
            document.getElementById('companyInfo').classList.add('hidden');
            currentCompanyId = null;
            currentSettings = {};
        }

        async function saveAllSettings() {
            if (!currentCompanyId) {
                alert('Please select a company first');
                return;
            }

            try {
                const settings = collectAllSettings();
                const token = localStorage.getItem('authToken');
                
                const response = await fetch(`/api/company/companies/${currentCompanyId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showSuccessMessage('Settings saved successfully!');
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showErrorMessage('Failed to save settings. Please try again.');
            }
        }

        function collectAllSettings() {
            return {
                agentIntelligenceSettings: {
                    useLLM: document.getElementById('useLLM').checked,
                    primaryLLM: document.getElementById('primaryLLM').value,
                    fallbackLLM: document.getElementById('fallbackLLM').value,
                    memoryMode: document.getElementById('memoryMode').value,
                    fallbackThreshold: parseFloat(document.getElementById('fallbackThreshold').value),
                    escalationMode: document.querySelector('input[name="escalationMode"]:checked').value,
                    rePromptAfterTurns: parseInt(document.getElementById('rePromptAfterTurns').value),
                    maxPromptsPerCall: parseInt(document.getElementById('maxPromptsPerCall').value),
                    semanticSearchEnabled: document.getElementById('semanticSearchEnabled').checked,
                    confidenceScoring: document.getElementById('confidenceScoring').checked,
                    autoLearningQueue: document.getElementById('autoLearningQueue').checked,
                    autoLearningEnabled: document.getElementById('autoLearningEnabled').checked,
                    learningApprovalMode: document.getElementById('learningApprovalMode').value,
                    learningConfidenceThreshold: parseFloat(document.getElementById('learningConfidenceThreshold').value),
                    maxPendingQnAs: parseInt(document.getElementById('maxPendingQnAs').value),
                    intelligentRouting: document.getElementById('intelligentRouting').checked
                },
                aiSettings: {
                    customEscalationMessage: document.getElementById('customEscalationMessage').value,
                    sentimentAnalysis: document.getElementById('sentimentAnalysis').checked,
                    contextualMemory: {
                        enabled: document.getElementById('contextualMemory').checked,
                        memoryRetentionHours: Math.round((parseInt(document.getElementById('contextRetention').value) / 60) * 24) // Convert minutes to hours
                    },
                    dynamicReasoning: {
                        enabled: document.getElementById('dynamicReasoning').checked
                    },
                    smartEscalation: {
                        enabled: document.getElementById('smartEscalation').checked
                    },
                    continuousLearning: {
                        realTimeOptimization: document.getElementById('realTimeOptimization').checked,
                        predictiveIntentAnalysis: document.getElementById('predictiveIntentAnalysis').checked,
                        abTestStrategies: document.getElementById('abTestStrategies').checked
                    },
                    performanceBenchmarks: {
                        targetConfidenceRate: parseFloat(document.getElementById('targetConfidenceRate').value),
                        targetResponseTime: parseFloat(document.getElementById('targetResponseTime').value),
                        targetEscalationRate: parseFloat(document.getElementById('targetEscalationRate').value)
                    }
                }
            };
        }

        async function testAIResponse() {
            if (!currentCompanyId) {
                alert('Please select a company first');
                return;
            }

            const query = document.getElementById('testQuery').value.trim();
            if (!query) {
                alert('Please enter a test query');
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const startTime = Date.now();
                
                const response = await fetch('/api/ai-agent/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        query: query,
                        companyId: currentCompanyId
                    })
                });

                const responseTime = Date.now() - startTime;

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('testResponse').innerHTML = result.response || 'No response received';
                    document.getElementById('testConfidence').textContent = result.confidence ? Math.round(result.confidence * 100) + '%' : '--';
                    document.getElementById('testResponseTime').textContent = responseTime;
                    document.getElementById('testMethod').textContent = result.responseMethod || 'unknown';
                    document.getElementById('testMetrics').classList.remove('hidden');
                } else {
                    document.getElementById('testResponse').innerHTML = '<span class="text-red-600">Error testing AI response</span>';
                }
            } catch (error) {
                console.error('Error testing AI response:', error);
                document.getElementById('testResponse').innerHTML = '<span class="text-red-600">Failed to test AI response</span>';
            }
        }

        function loadPreset(type) {
            switch(type) {
                case 'conservative':
                    // High confidence, low risk settings
                    document.getElementById('fallbackThreshold').value = 0.8;
                    document.getElementById('fallbackThresholdValue').textContent = '0.8';
                    document.querySelector('input[name="escalationMode"][value="ask"]').checked = true;
                    document.getElementById('autoLearningEnabled').checked = false;
                    document.getElementById('semanticSearchEnabled').checked = false;
                    break;
                case 'balanced':
                    // Moderate settings
                    document.getElementById('fallbackThreshold').value = 0.5;
                    document.getElementById('fallbackThresholdValue').textContent = '0.5';
                    document.querySelector('input[name="escalationMode"][value="ask"]').checked = true;
                    document.getElementById('autoLearningEnabled').checked = true;
                    document.getElementById('semanticSearchEnabled').checked = true;
                    break;
                case 'aggressive':
                    // Low confidence, high automation settings
                    document.getElementById('fallbackThreshold').value = 0.3;
                    document.getElementById('fallbackThresholdValue').textContent = '0.3';
                    document.querySelector('input[name="escalationMode"][value="auto"]').checked = true;
                    document.getElementById('autoLearningEnabled').checked = true;
                    document.getElementById('realTimeOptimization').checked = true;
                    break;
            }
            showSuccessMessage(`${type.charAt(0).toUpperCase() + type.slice(1)} preset loaded`);
        }

        function exportSettings() {
            if (!currentSettings) {
                alert('No settings to export');
                return;
            }

            const exportData = {
                companyName: currentSettings.companyName,
                agentIntelligenceSettings: currentSettings.agentIntelligenceSettings,
                aiSettings: currentSettings.aiSettings,
                exportedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentSettings.companyName}_ai_settings.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const settings = JSON.parse(e.target.result);
                            if (settings.agentIntelligenceSettings || settings.aiSettings) {
                                // Apply imported settings
                                populateSettings({
                                    agentIntelligenceSettings: settings.agentIntelligenceSettings,
                                    aiSettings: settings.aiSettings
                                });
                                showSuccessMessage('Settings imported successfully!');
                            } else {
                                showErrorMessage('Invalid settings file format');
                            }
                        } catch (error) {
                            showErrorMessage('Failed to import settings file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function showSuccessMessage(message) {
            const div = document.createElement('div');
            div.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            div.innerHTML = `<i class="fas fa-check mr-2"></i>${message}`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function showErrorMessage(message) {
            const div = document.createElement('div');
            div.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            div.innerHTML = `<i class="fas fa-times mr-2"></i>${message}`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>
