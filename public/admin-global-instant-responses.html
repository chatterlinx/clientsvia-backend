<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global AI Brain - ClientVia.ai v2.8-CLEAN</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- DEPLOYMENT VERSION: OPTION_B_PERFECT - 2025-11-02 21:15:00 UTC - Template Status Label Fixed -->
    <script>
        // üî• DEPLOYMENT VERIFICATION SYSTEM
        const BUILD_VERSION = 'LLM_LEARNING_CONSOLE_UI';
        const BUILD_DATE = '2025-11-02 23:59:00 UTC';
        const BUILD_DESCRIPTION = 'üß† Added LLM Learning Console Tab - Organize suggestions by template, cost dashboard, approve/reject queue (UI structure complete, backend functions pending)';
        
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üöÄ DEPLOYMENT VERSION:', BUILD_VERSION);
        console.log('üìÖ BUILD DATE:', BUILD_DATE);
        console.log('üìù CHANGES:', BUILD_DESCRIPTION);
        console.log('üîÑ Cache-Buster:', Date.now());
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        // Display version in UI
        window.DEPLOYMENT_VERSION = {
            commit: BUILD_VERSION,
            date: BUILD_DATE,
            description: BUILD_DESCRIPTION
        };
    </script>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- üé® Enterprise Test Pilot - Dedicated Stylesheet -->
    <link rel="stylesheet" href="/css/enterprise-test-pilot.css">
    
    <!-- üß† Intelligence Settings Modal - Dual 3-Tier System -->
    <link rel="stylesheet" href="/css/intelligence-modal.css">
    
    <!-- Synonym & Filler Management System -->
    <script src="/js/ToastManager.js"></script>
    <script src="/js/FrontendErrorReporter.js"></script>
    <script src="/js/ai-agent-settings/SynonymManager.js"></script>
    <script src="/js/ai-agent-settings/FillerManager.js"></script>
    <script src="/js/ai-agent-settings/SuggestionManager.js"></script>
    <script src="/js/ai-agent-settings/SuggestionRenderer.js"></script>
    <script src="/js/ai-agent-settings/SuggestionAnalysisModal.js"></script>
    <script src="/js/ai-agent-settings/TestReportExporter.js"></script>
    <script src="/js/template-settings-manager.js"></script>
    
    <!-- üéØ Template Data Manager - World-Class State Management -->
    <script src="/js/TemplateDataManager.js"></script>
    
    <!-- üß† V7: Scenario Architect Panel - Persistent AI Co-Pilot -->
    <script src="/js/managers/ScenarioArchitectPanel.js"></script>
    
    <!-- üöÄ AI Gateway Manager - LLM Health Monitoring & Suggestion System -->
    <script src="/js/ai-gateway/HealthModal.js"></script>
    <script src="/js/ai-gateway/HealthReportModal.js"></script>
    <script src="/js/ai-gateway/AIGatewayManager.js"></script>
    <script src="/js/ai-gateway/index.js"></script>
    
    <!-- üìä Chart.js - Data Visualization Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- üìà Enterprise Test Pilot - Trend Analytics -->
    <script src="/js/ai-agent-settings/EnterpriseTrendCharts.js"></script>
    
    <!-- üîÆ Enterprise Test Pilot - Before/After Simulator -->
    <script src="/js/ai-agent-settings/EnterpriseBeforeAfterSimulator.js"></script>
    
    <!-- ‚ö° Enterprise Test Pilot - Bulk Actions System -->
    <script src="/js/ai-agent-settings/EnterpriseBulkActions.js"></script>
    
    <!-- üß† Intelligence Settings Modal - Dual 3-Tier System -->
    <script src="/js/ai-agent-settings/IntelligenceSettingsModal.js"></script>
    
    <style>
        /* ============================================================================
         * WORLD-CLASS DESIGN SYSTEM - Salesforce/Stripe/Linear Standards
         * ============================================================================ */
        
        /* DESIGN TOKENS - Single source of truth for colors, spacing, shadows */
        :root {
            /* Primary Colors */
            --color-primary-50: #eff6ff;
            --color-primary-100: #dbeafe;
            --color-primary-200: #bfdbfe;
            --color-primary-300: #93c5fd;
            --color-primary-400: #60a5fa;
            --color-primary-500: #3b82f6;
            --color-primary-600: #2563eb;
            --color-primary-700: #1d4ed8;
            --color-primary-800: #1e40af;
            --color-primary-900: #1e3a8a;
            
            /* Neutral Grays */
            --color-gray-50: #f9fafb;
            --color-gray-100: #f3f4f6;
            --color-gray-200: #e5e7eb;
            --color-gray-300: #d1d5db;
            --color-gray-400: #9ca3af;
            --color-gray-500: #6b7280;
            --color-gray-600: #4b5563;
            --color-gray-700: #374151;
            --color-gray-800: #1f2937;
            --color-gray-900: #111827;
            
            /* Semantic Colors */
            --color-success-500: #10b981;
            --color-success-600: #059669;
            --color-warning-500: #f59e0b;
            --color-warning-600: #d97706;
            --color-error-500: #ef4444;
            --color-error-600: #dc2626;
            --color-info-500: #3b82f6;
            --color-info-600: #2563eb;
            
            /* Spacing Scale (8px base) */
            --space-1: 0.25rem;  /* 4px */
            --space-2: 0.5rem;   /* 8px */
            --space-3: 0.75rem;  /* 12px */
            --space-4: 1rem;     /* 16px */
            --space-5: 1.25rem;  /* 20px */
            --space-6: 1.5rem;   /* 24px */
            --space-8: 2rem;     /* 32px */
            --space-10: 2.5rem;  /* 40px */
            --space-12: 3rem;    /* 48px */
            
            /* Border Radius */
            --radius-sm: 0.375rem;  /* 6px */
            --radius-md: 0.5rem;    /* 8px */
            --radius-lg: 0.75rem;   /* 12px */
            --radius-xl: 1rem;      /* 16px */
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Typography */
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* ============================================================================
         * TEMPLATE DATA SUB-TABS - World-Class Tab System
         * ============================================================================ */
        
        .template-data-subtabs {
            display: flex;
            gap: var(--space-1);
            border-bottom: 2px solid var(--color-gray-200);
            margin: var(--space-6) 0 var(--space-8);
            padding: 0 var(--space-2);
        }
        
        .template-data-subtab-btn {
            position: relative;
            padding: var(--space-3) var(--space-5);
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-gray-600);
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            margin-bottom: -2px;
        }
        
        .template-data-subtab-btn:hover {
            color: var(--color-primary-600);
            background: var(--color-primary-50);
        }
        
        .template-data-subtab-btn.active {
            color: var(--color-primary-700);
            background: white;
            border-bottom-color: var(--color-primary-600);
            box-shadow: var(--shadow-sm);
        }
        
        .template-data-subtab-btn .icon {
            font-size: 1rem;
            transition: transform var(--transition-fast);
        }
        
        .template-data-subtab-btn:hover .icon {
            transform: scale(1.1);
        }
        
        .template-data-subtab-btn .badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            background: var(--color-gray-400);
            border-radius: var(--radius-full);
            margin-left: var(--space-1);
            transition: background var(--transition-fast);
        }
        
        .template-data-subtab-btn.active .badge {
            background: var(--color-primary-600);
        }
        
        /* Tab Content Panels */
        .template-data-subtab-panel {
            display: none;
            animation: fadeIn var(--transition-base);
        }
        
        .template-data-subtab-panel.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ============================================================================
         * ENTERPRISE TABLE COMPONENT - Salesforce DataTable Style
         * ============================================================================ */
        
        .enterprise-table {
            width: 100%;
            background: white;
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .enterprise-table thead {
            background: linear-gradient(to bottom, var(--color-gray-50), var(--color-gray-100));
            border-bottom: 2px solid var(--color-gray-300);
        }
        
        .enterprise-table th {
            padding: var(--space-4) var(--space-4);
            text-align: left;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--color-gray-700);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }
        
        .enterprise-table tbody tr {
            border-bottom: 1px solid var(--color-gray-200);
            transition: background var(--transition-fast);
        }
        
        .enterprise-table tbody tr:hover {
            background: var(--color-primary-50);
        }
        
        .enterprise-table tbody tr.expanded {
            background: var(--color-primary-100);
            border-left: 4px solid var(--color-primary-600);
        }
        
        .enterprise-table td {
            padding: var(--space-4);
            font-size: 0.875rem;
            color: var(--color-gray-900);
            vertical-align: top;
        }
        
        /* Expandable Row Content */
        .table-expansion-panel {
            background: linear-gradient(135deg, var(--color-primary-50), var(--color-gray-50));
            padding: var(--space-6);
            border-top: 2px solid var(--color-primary-200);
            animation: slideDown var(--transition-base);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }
        
        /* ============================================================================
         * INLINE EDITABLE FIELDS - Stripe-Style Inline Editing
         * ============================================================================ */
        
        .inline-edit-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .inline-edit-value {
            padding: var(--space-2) var(--space-3);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .inline-edit-value:hover {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }
        
        .inline-edit-input {
            padding: var(--space-2) var(--space-3);
            border: 2px solid var(--color-primary-500);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            outline: none;
            box-shadow: 0 0 0 3px var(--color-primary-100);
        }
        
        /* ============================================================================
         * BADGE SYSTEM - Semantic Color-Coded Badges
         * ============================================================================ */
        
        .badge-base {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: var(--radius-full);
            white-space: nowrap;
        }
        
        .badge-inheritance {
            background: var(--color-primary-100);
            color: var(--color-primary-800);
            border: 1px solid var(--color-primary-300);
        }
        
        .badge-custom {
            background: var(--color-warning-100);
            color: var(--color-warning-800);
            border: 1px solid var(--color-warning-300);
        }
        
        .badge-count {
            background: var(--color-gray-200);
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-400);
        }
        
        /* ============================================================================
         * SKELETON LOADING STATES - Premium Loading Experience
         * ============================================================================ */
        
        .skeleton {
            background: linear-gradient(90deg, var(--color-gray-200) 25%, var(--color-gray-300) 50%, var(--color-gray-200) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-md);
        }
        
        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        .skeleton-text {
            height: 1rem;
            margin-bottom: var(--space-2);
        }
        
        .skeleton-button {
            height: 2.5rem;
            width: 6rem;
        }
        
        /* ============================================================================
         * EXISTING STYLES (Preserved)
         * ============================================================================ */
        
        /* WIDE CONTAINER - Full real estate like Data Center */
        .container {
            max-width: 1400px !important;
        }

        /* DATA CENTER NAVIGATION - BLUE THEME */
        .nav-link {
            text-decoration: none;
            color: #4a5568;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .nav-link:hover {
            background: #edf2f7;
            color: #2b6cb0;
        }
        .nav-link.active,
        .nav-link.active-tab {
            background: #3182ce; /* BLUE */
            color: white;
        }
        .stat-card {
            @apply bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl p-6 shadow-md hover:shadow-lg transition-shadow;
        }
        .category-card {
            @apply bg-white rounded-lg border-2 border-gray-200 p-4 hover:border-blue-400 hover:shadow-lg transition-all cursor-pointer;
        }
        .category-card.expanded {
            @apply border-blue-500 shadow-xl;
        }
        .scenario-item {
            @apply bg-gray-50 rounded-lg p-4 border border-gray-200 hover:bg-blue-50 hover:border-blue-300 transition-all;
        }
        .badge {
            @apply px-3 py-1 text-xs font-bold rounded-full;
        }
        .badge-active {
            @apply bg-green-100 text-green-700 border border-green-300;
        }
        .badge-inactive {
            @apply bg-gray-100 text-gray-600 border border-gray-300;
        }
        .badge-priority {
            @apply bg-yellow-100 text-yellow-700 border border-yellow-300;
        }
        
        /* ============================================================================
         * MODAL ANIMATIONS - Smooth entrance/exit
         * ============================================================================ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px); 
            }
            to { 
                opacity: 1;
                transform: translateY(0); 
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    
    <!-- ============================================ -->
    <!-- HEADER NAVIGATION -->
    <!-- ============================================ -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-brain text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">ClientVia.ai</h1>
                        <p class="text-xs text-gray-500">Global AI Brain</p>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="hidden md:flex items-center space-x-1">
                    <a href="/directory.html" class="nav-link">
                        <i class="fas fa-list-alt"></i>
                        <span>Directory</span>
                    </a>
                    <a href="/admin-data-center.html" class="nav-link">
                        <i class="fas fa-database"></i>
                        <span>Data Center</span>
                    </a>
                    <a href="/admin-call-archives.html" class="nav-link">
                        <i class="fas fa-phone-volume"></i>
                        <span>Call Archives</span>
                    </a>
                    <a href="/admin-notification-center.html" class="nav-link admin-nav">
                        <i class="fas fa-bell"></i>
                        <span>Notification Center</span>
                    </a>
                    <a href="/admin-global-instant-responses.html" class="nav-link active-tab">
                        <i class="fas fa-brain"></i>
                        <span>Global AI Brain</span>
                    </a>
                    
                    <!-- Separator -->
                    <div class="h-6 w-px bg-gray-300 mx-2"></div>
                    
                    <!-- Logout -->
                    <a href="#" onclick="handleLogout(event)" class="nav-link text-red-600 hover:text-red-700 hover:bg-red-50">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </nav>

                <!-- Mobile menu button -->
                <button class="md:hidden text-gray-700">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- ============================================ -->
    <!-- MAIN CONTENT -->
    <!-- ============================================ -->
    <main class="flex-1 container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Page Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                        <i class="fas fa-brain text-blue-600"></i>
                        Global AI Brain Management
                    </h1>
                    <p class="text-gray-600 mt-2">
                        World-class instant response library with 100+ human-like conversation scenarios
                    </p>
            </div>
        </div>

            <!-- Sub Tabs -->
            <div class="mt-3 border-b border-gray-200">
                <nav class="flex gap-2">
                    <button id="tab-overview" onclick="switchTab('overview')" class="px-6 py-3 font-semibold text-blue-600 border-b-2 border-blue-600 transition-colors">
                        <i class="fas fa-layer-group mr-2"></i>
                        Overview
                    </button>
                    <button id="tab-behaviors" onclick="switchTab('behaviors')" class="px-6 py-3 font-semibold text-gray-500 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-300 transition-colors">
                        <i class="fas fa-theater-masks mr-2"></i>
                        Behaviors
                    </button>
                    <button id="tab-action-hooks" onclick="switchTab('action-hooks')" class="px-6 py-3 font-semibold text-gray-500 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-300 transition-colors">
                        <i class="fas fa-bolt mr-2"></i>
                        Action Hooks
                    </button>
                    <button id="tab-settings" onclick="switchTab('settings')" class="px-6 py-3 font-semibold text-gray-500 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-300 transition-colors">
                        <i class="fas fa-cog mr-2"></i>
                        Settings
                    </button>
                </nav>
            </div>
        </div>

        <!-- Overview Tab Content -->
        <div id="overview-tab" class="tab-content">
            
            <!-- Overview Sub-Tabs (Compact Design) -->
            <div class="bg-gray-50 border-b border-gray-300 -mx-4 px-4 sm:-mx-6 sm:px-6 lg:-mx-8 lg:px-8 mb-6">
                <div class="flex gap-1 pt-2">
                    <button id="overview-subtab-dashboard" onclick="switchOverviewSubTab('dashboard')" class="px-4 py-2 text-sm font-medium text-blue-700 border-b-2 border-blue-600 bg-white rounded-t">
                        <i class="fas fa-flask mr-1.5 text-xs"></i>
                        Test Pilot
                    </button>
                    <!-- ‚ú® V2: Opens new standalone LLM Learning Console -->
                    <a href="/admin/llm-learning-v2" id="overview-subtab-llm-learning" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 border-b-2 border-transparent rounded-t inline-flex items-center">
                        <i class="fas fa-graduation-cap mr-1.5 text-xs"></i>
                        LLM Learning Console
                        <span id="llm-suggestions-badge" class="ml-1.5 px-1.5 py-0.5 bg-gradient-to-r from-orange-500 to-red-500 text-white text-xs rounded-full font-bold animate-pulse">0</span>
                    </a>
                    <button id="overview-subtab-ai-gateway" onclick="switchOverviewSubTab('ai-gateway')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 border-b-2 border-transparent rounded-t">
                        <i class="fas fa-network-wired mr-1.5 text-xs"></i>
                        AI Gateway
                        <span class="ml-1.5 px-1.5 py-0.5 bg-purple-500 text-white text-xs rounded-full font-bold animate-pulse">LLM</span>
                    </button>
                    <button id="overview-subtab-templates" onclick="switchOverviewSubTab('templates')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 border-b-2 border-transparent rounded-t">
                        <i class="fas fa-copy mr-1.5 text-xs"></i>
                        Templates
                    </button>
                    <button id="overview-subtab-maintenance" onclick="switchOverviewSubTab('maintenance')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 border-b-2 border-transparent rounded-t">
                        <i class="fas fa-tools mr-1.5 text-xs"></i>
                        Maintenance
                    </button>
                </div>
            </div>

            <!-- Test Pilot Sub-Tab Content -->
            <div id="overview-dashboard-content" class="overview-subtab-content">
                
                <!-- Test Pilot Header -->
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                        <i class="fas fa-flask text-blue-600"></i>
                        Test Pilot
                    </h2>
                    <p class="text-gray-600 mt-1">Test and preview your AI templates before deploying to production</p>
                </div>
                
                <!-- ================================================================
                     üìû SHARED TEST PHONE CONFIGURATION (COLLAPSIBLE)
                     ================================================================
                     Purpose: Single source of truth for test phone number
                     Features:
                     - Collapsed by default ("set it and forget it")
                     - Smooth accordion animation
                     - Used by BOTH Template & Company Testing modes
                     - Enterprise-grade UI/UX
                     ================================================================ -->
                
                <div id="twilio-config-accordion" class="mb-6 bg-white rounded-xl shadow-lg border-2 border-indigo-400 overflow-hidden transition-all duration-300">
                    <!-- Accordion Header (Always Visible) -->
                    <button onclick="toggleTwilioConfigAccordion()" 
                            class="w-full px-6 py-4 flex items-center justify-between bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 cursor-pointer group"
                            aria-expanded="false"
                            aria-controls="twilio-config-content">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-md">
                                <i class="fas fa-phone-alt text-indigo-600 text-xl"></i>
                            </div>
                            <div class="text-left">
                                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                    üìû Shared Test Phone Configuration
                                    <span class="px-2 py-0.5 bg-white/20 text-xs rounded-full font-semibold">Shared by Both Modes</span>
                                </h3>
                                <p class="text-sm text-indigo-100 mt-0.5">
                                    Configure once ‚Ä¢ Used by Template & Company Testing
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span id="twilio-config-status-badge" class="px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full shadow-md">
                                ‚úì CONFIGURED
                            </span>
                            <i id="twilio-accordion-icon" class="fas fa-chevron-down text-white text-xl transition-transform duration-300"></i>
                        </div>
                    </button>
                    
                    <!-- Accordion Content (Collapsible) -->
                    <div id="twilio-config-content" 
                         class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out"
                         style="transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);">
                        <div class="p-6 bg-gradient-to-br from-indigo-50 to-purple-50 border-t-2 border-indigo-200">
                            
                            <!-- Alert Banner -->
                            <div class="mb-4 p-3 bg-blue-100 border-l-4 border-blue-600 rounded-r-lg">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-info-circle text-blue-600 text-lg mt-0.5"></i>
                                    <div class="text-sm text-blue-900">
                                        <strong class="font-bold">Important:</strong> This phone number is used by <strong>BOTH</strong> Template Testing and Company Testing modes.
                                        The toggle switches above control which configuration this number routes to.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <!-- Left Column: Phone & Credentials -->
                                <div class="lg:col-span-2 space-y-4">
                                    <!-- Phone Number -->
                                    <div>
                                        <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                                            <i class="fas fa-hashtag text-indigo-600"></i>
                                            Test Phone Number (E.164 format)
                                        </label>
                                        <input type="tel" 
                                               id="twilio-test-phone" 
                                               placeholder="+15551234567" 
                                               class="w-full px-4 py-3 border-2 border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base font-mono bg-white shadow-sm transition-all">
                                        <p class="text-xs text-gray-600 mt-1.5 flex items-center gap-1">
                                            <i class="fas fa-info-circle text-indigo-500"></i>
                                            This number routes to either Template or Company Testing based on toggle selection
                                        </p>
                                    </div>
                                    
                                    <!-- Twilio Credentials -->
                                    <div class="bg-white border-2 border-indigo-200 rounded-lg p-4 shadow-sm">
                                        <h5 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                                            <i class="fas fa-key text-indigo-600"></i>
                                            Twilio Integration Credentials
                                        </h5>
                                        <p class="text-xs text-gray-600 mb-3">
                                            Get these from your Twilio console. Required for voice call handling.
                                        </p>
                                        <div class="grid grid-cols-1 gap-3">
                                            <!-- Account SID -->
                                            <div>
                                                <label class="block text-xs font-semibold text-gray-700 mb-1">
                                                    Account SID:
                                                </label>
                                                <input type="text" 
                                                       id="twilio-test-account-sid" 
                                                       placeholder="AC18c622a49f28d9abf8952ecf06ba59f2" 
                                                       class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-xs font-mono bg-white">
                                            </div>
                                            
                                            <!-- Auth Token -->
                                            <div>
                                                <label class="block text-xs font-semibold text-gray-700 mb-1">
                                                    Auth Token:
                                                </label>
                                                <input type="password" 
                                                       id="twilio-test-auth-token" 
                                                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                                       class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-xs font-mono bg-white">
                                            </div>
                                        </div>
                                        <p class="text-xs text-indigo-600 mt-3 flex items-center gap-1">
                                            <i class="fas fa-lock"></i>
                                            Encrypted and stored securely
                                        </p>
                                    </div>
                                    
                                    <!-- Test Call Greeting -->
                                    <div class="bg-white border-2 border-indigo-200 rounded-lg p-4 shadow-sm">
                                        <div class="flex items-center justify-between mb-2">
                                            <label class="block text-sm font-bold text-gray-800 flex items-center gap-2">
                                                <i class="fas fa-microphone text-indigo-600"></i>
                                                Test Call Greeting
                                            </label>
                                            <button type="button" 
                                                    onclick="resetGreetingToDefault()" 
                                                    class="text-xs px-3 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg font-semibold transition-colors">
                                                <i class="fas fa-undo mr-1"></i>
                                                Reset to Default
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-600 mb-2">
                                            Spoken when calling the test number. Use <code class="bg-indigo-100 px-1.5 py-0.5 rounded text-indigo-800 font-mono text-xs">{template_name}</code> for dynamic insertion.
                                        </p>
                                        <textarea id="twilio-test-greeting" 
                                                  rows="3" 
                                                  class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-white resize-none"
                                                  placeholder="Enter custom greeting message..."></textarea>
                                        <div class="flex justify-between items-center mt-1.5">
                                            <p class="text-xs text-gray-500">
                                                <i class="fas fa-info-circle mr-1"></i>
                                                Greeting updates automatically based on active testing mode
                                            </p>
                                            <span id="greeting-char-count" class="text-xs text-gray-500 font-mono">0 / 500</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Testing Notes -->
                                    <div>
                                        <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                                            <i class="fas fa-sticky-note text-indigo-600"></i>
                                            Testing Notes (Optional)
                                        </label>
                                        <textarea id="twilio-test-notes" 
                                                  rows="2" 
                                                  placeholder="e.g., Testing appointment booking flow, hold scenarios..."
                                                  class="w-full px-3 py-2 border-2 border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-white resize-none"></textarea>
                                    </div>
                                </div>
                                
                                <!-- Right Column: Stats & Actions -->
                                <div class="space-y-4">
                                    <!-- Quick Stats -->
                                    <div class="bg-white border-2 border-indigo-200 rounded-lg p-4 shadow-sm">
                                        <h5 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                                            <i class="fas fa-chart-bar text-indigo-600"></i>
                                            Quick Stats
                                        </h5>
                                        <div class="space-y-3">
                                            <div class="text-center bg-gradient-to-br from-green-50 to-emerald-50 px-3 py-3 rounded-lg border-2 border-green-200">
                                                <div class="text-2xl font-bold text-green-600" id="test-call-count">0</div>
                                                <div class="text-xs text-gray-700 font-semibold">Total Test Calls</div>
                                            </div>
                                            <div class="text-center bg-gradient-to-br from-blue-50 to-cyan-50 px-3 py-3 rounded-lg border-2 border-blue-200">
                                                <div class="text-xs text-gray-700 font-semibold" id="test-last-called">Never</div>
                                                <div class="text-xs text-gray-500 mt-0.5">Last Tested</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Button -->
                                    <button onclick="saveTwilioTestConfig()" 
                                            class="w-full px-6 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg font-bold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                                        <i class="fas fa-save text-lg"></i>
                                        Save Configuration
                                    </button>
                                    
                                    <!-- Security Notice -->
                                    <div class="bg-green-50 border-2 border-green-300 rounded-lg p-3">
                                        <p class="text-xs text-green-800 font-semibold flex items-start gap-2">
                                            <i class="fas fa-shield-alt text-green-600 mt-0.5"></i>
                                            <span>
                                                <strong>Isolated & Secure:</strong> This test number is completely isolated from production.
                                                Zero crossover with customer phone numbers.
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ================================================================
                     üéõÔ∏è TESTING CONTROL PANEL (NEW ARCHITECTURE)
                     ================================================================
                     Purpose: Centralized toggle controls with tab navigation
                     Features:
                     - Both toggles visible at all times
                     - Mutually exclusive (only ONE can be ON)
                     - Tabs switch between Template and Company views
                     - Clear visual feedback
                     ================================================================ -->
                
                <!-- CONTROL PANEL: Toggle Switches -->
                <!-- TAB NAVIGATION -->
                <div class="mb-6 bg-white rounded-xl shadow-lg border-2 border-blue-500 overflow-hidden">
                    <div class="flex border-b-2 border-gray-200">
                        <!-- Template Testing Tab -->
                        <button onclick="switchTestMode('template')" 
                                id="template-mode-btn"
                                class="flex-1 px-6 py-4 font-bold text-lg transition-all duration-300
                                       bg-gradient-to-r from-purple-600 to-pink-600 text-white
                                       border-b-4 border-purple-700">
                            <i class="fas fa-brain mr-2"></i>
                            üß† Template Testing
                            <p class="text-xs mt-1 opacity-90 font-normal">Perfect your AI templates</p>
                        </button>
                        
                        <!-- Company Testing Tab -->
                        <button onclick="switchTestMode('company')" 
                                id="company-mode-btn"
                                class="flex-1 px-6 py-4 font-bold text-lg transition-all duration-300
                                       bg-gray-100 text-gray-600 hover:bg-gray-200">
                            <i class="fas fa-building mr-2"></i>
                            üè¢ Company Testing
                            <p class="text-xs mt-1 font-normal">Test real production setup</p>
                        </button>
                    </div>
                    
                    <!-- Tab Description Panel -->
                    <div id="mode-description" class="px-6 py-3 bg-gradient-to-r from-purple-50 to-pink-50">
                        <!-- Template Mode Description (Default Visible) -->
                        <p id="template-mode-desc" class="text-sm text-gray-700">
                            <i class="fas fa-info-circle text-purple-600 mr-2"></i>
                            <strong>Template Mode:</strong> Test your AI template rules, scenarios, fillers, and synonyms in isolation. Perfect for template development and fine-tuning.
                        </p>
                        <!-- Company Mode Description (Hidden by Default) -->
                        <p id="company-mode-desc" class="hidden text-sm text-gray-700">
                            <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                            <strong>Company Mode:</strong> Test a real company's FULL production configuration (Company Q&A, placeholders, voice settings, etc). What you test = what customers get! 100% production simulator.
                        </p>
                    </div>
                </div>
                
                <!-- ================================================================
                     üìã TEMPLATE MODE CONTENT (Shown when Template tab active)
                     ================================================================ -->
                <div id="template-mode-content" style="display: block;">
                    
                    <!-- Template Selector -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-300 rounded-xl p-6 mb-8 shadow-sm">
                        <div id="template-select-helper" class="mb-3 p-3 bg-purple-100 border border-purple-300 rounded-lg text-sm text-purple-800 flex items-center gap-2" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <span class="font-medium">Please select a template to begin editing</span>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fas fa-brain text-purple-600 mr-2"></i>
                                üìã Currently Editing Template:
                            </label>
                            <select id="dashboard-template-selector" onchange="switchDashboardTemplate(this.value)" 
                                    class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-lg font-semibold bg-white shadow-sm">
                                <option value="">-- Select a template --</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ================================================================
                         üü£ AI SUGGESTIONS SECTION
                         ================================================================
                         Purpose: Show AI-discovered improvements for current template
                         ALWAYS VISIBLE - Shows empty state when no suggestions
                         Better UX: User selects template first, then sees its suggestions
                         ================================================================ -->
                <div id="ai-suggestions-section" class="mb-8">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-400 to-cyan-400 rounded-t-xl px-4 py-3 text-white">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                                    <i class="fas fa-lightbulb text-blue-500"></i>
                                </div>
                                <div>
                                    <h2 class="text-lg font-bold flex items-center gap-2">
                                        üí° AI Suggestions
                                        <span id="suggestions-count-badge" class="px-2 py-0.5 bg-white text-blue-600 rounded-full text-xs font-bold">0</span>
                                    </h2>
                                    <p class="text-blue-50 text-xs">
                                        Intelligent improvements discovered from call patterns
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Priority Summary - COMPACT VERSION -->
                    <div class="bg-gradient-to-r from-blue-50 to-cyan-50 px-4 py-2 border-x-2 border-blue-200">
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-white rounded-lg p-2 border-2 border-red-200 text-center">
                                <div id="suggestions-high-count" class="text-2xl font-bold text-red-600">0</div>
                                <div class="text-xs text-gray-600">
                                    <i class="fas fa-exclamation-circle text-red-500 mr-1"></i>
                                    High
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border-2 border-yellow-200 text-center">
                                <div id="suggestions-medium-count" class="text-2xl font-bold text-yellow-600">0</div>
                                <div class="text-xs text-gray-600">
                                    <i class="fas fa-flag text-yellow-500 mr-1"></i>
                                    Medium
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border-2 border-gray-200 text-center">
                                <div id="suggestions-low-count" class="text-2xl font-bold text-gray-600">0</div>
                                <div class="text-xs text-gray-600">
                                    <i class="fas fa-info-circle text-gray-500 mr-1"></i>
                                    Low
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Suggestions List - COMPACT VERSION -->
                    <div class="bg-white rounded-b-xl p-4 border-2 border-t-0 border-blue-200 shadow-lg">
                        <!-- Batch Actions - COMPACT -->
                        <div class="flex gap-2 mb-4 pb-3 border-b border-gray-200">
                            <button onclick="applyAllHighConfidenceSuggestions()" 
                                    class="px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg font-semibold text-sm shadow-md hover:shadow-xl transition-all flex items-center gap-2">
                                <i class="fas fa-check-double"></i>
                                Apply All (90%+)
                            </button>
                            <button onclick="refreshSuggestions()" 
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold text-sm transition-all flex items-center gap-2">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                            <button onclick="dismissLowPriority()" 
                                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold text-sm transition-all flex items-center gap-2">
                                <i class="fas fa-filter"></i>
                                Dismiss Low
                            </button>
                        </div>
                        
                        <!-- Suggestions Cards Container -->
                        <div id="suggestions-cards-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                            <!-- Cards will be rendered here by JavaScript -->
                        </div>
                        
                        <!-- Empty State - COMPACT VERSION -->
                        <div id="suggestions-empty-state" class="hidden text-center py-6">
                            <i class="fas fa-check-circle text-green-500 text-4xl mb-2"></i>
                            <h3 class="text-lg font-bold text-gray-700 mb-1">All Caught Up!</h3>
                            <p class="text-sm text-gray-600">No pending suggestions. The AI will notify you when patterns are detected.</p>
                        </div>
                        
                        <!-- Loading State -->
                        <div id="suggestions-loading-state" class="hidden text-center py-12">
                            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto mb-4"></div>
                            <p class="text-gray-600 font-semibold">Loading suggestions...</p>
                        </div>
                    </div>
                </div>
                
                <!-- ============================================================================
                     TEMPLATE DATA SUB-TABS - World-Class UX (Salesforce-Style)
                     ============================================================================
                     Context-aware tabs that show template-specific settings
                     Auto-refreshes when template dropdown changes
                     ========================================================================= -->
                <div class="template-data-subtabs" role="tablist" aria-label="Template Data Navigation">
                    <button id="template-data-tab-settings" 
                            class="template-data-subtab-btn active" 
                            role="tab"
                            aria-selected="true"
                            aria-controls="template-data-panel-settings"
                            onclick="switchTemplateDataTab('settings')">
                        <i class="fas fa-cog icon"></i>
                        <span>Template Settings</span>
                        <span class="badge" id="template-settings-badge">0</span>
                    </button>
                    <button id="template-data-tab-categories" 
                            class="template-data-subtab-btn" 
                            role="tab"
                            aria-selected="false"
                            aria-controls="template-data-panel-categories"
                            onclick="switchTemplateDataTab('categories')">
                        <i class="fas fa-layer-group icon"></i>
                        <span>Category Settings</span>
                        <span class="badge" id="category-settings-badge">0</span>
                    </button>
                </div>
                
                <!-- TEMPLATE SETTINGS TAB PANEL -->
                <div id="template-data-panel-settings" 
                     class="template-data-subtab-panel active" 
                     role="tabpanel"
                     aria-labelledby="template-data-tab-settings">
                    
                    <!-- üîç SYSTEM DIAGNOSTICS SECTION -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-6 mb-6 shadow-sm">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                                    <i class="fas fa-stethoscope text-blue-600"></i>
                                    System Diagnostics
                                </h3>
                                <p class="text-sm text-gray-600 mt-1">
                                    Test critical dependencies and monitor 3-Tier Intelligence System health
                                </p>
                            </div>
                        </div>
                        
                        <!-- OpenAI Connection Test -->
                        <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <h4 class="text-md font-semibold text-gray-900 flex items-center gap-2 mb-1">
                                        <i class="fas fa-brain text-purple-600"></i>
                                        OpenAI API Connection
                                    </h4>
                                    <p class="text-sm text-gray-600">
                                        Test Tier 3 LLM fallback system connectivity and performance
                                    </p>
                                </div>
                                <button onclick="window.aiGatewayManager && window.aiGatewayManager.testOpenAIConnection ? window.aiGatewayManager.testOpenAIConnection() : alert('AI Gateway not initialized')" 
                                        id="test-openai-btn"
                                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all flex items-center gap-2 text-sm shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-vial"></i>
                                    Test Connection
                                </button>
                            </div>
                            
                            <!-- Status Display -->
                            <div id="openai-status-container" class="hidden mt-4">
                                <div id="openai-status-content" class="p-4 rounded-lg">
                                    <!-- Dynamic content populated by JS -->
                                </div>
                            </div>
                            
                            <!-- QUICK STATUS BANNER (COMPACT SUMMARY) -->
                            <div id="diagnostic-status-banner" class="hidden mt-4">
                                <div id="diagnostic-status-card" class="rounded-lg p-4 border-2 shadow-sm">
                                    <!-- Header with Overall Status -->
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-3">
                                            <div id="status-icon" class="text-2xl">
                                                <!-- Icon populated by JS -->
                                            </div>
                                            <div>
                                                <h5 id="status-title" class="font-bold text-base">
                                                    <!-- Title populated by JS -->
                                                </h5>
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="refreshDiagnostics()" class="px-3 py-1.5 bg-white bg-opacity-20 hover:bg-opacity-30 rounded text-xs font-semibold transition-colors">
                                                <i class="fas fa-sync-alt mr-1"></i>
                                                Refresh
                                            </button>
                                            <button onclick="toggleDiagnosticErrors()" class="px-3 py-1.5 bg-white bg-opacity-20 hover:bg-opacity-30 rounded text-xs font-semibold transition-colors">
                                                Details
                                                <i class="fas fa-chevron-down ml-1"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Component Status Grid -->
                                    <div class="grid grid-cols-2 gap-2 text-xs">
                                        <!-- OpenAI Status -->
                                        <div class="flex items-center gap-2 p-2 rounded" id="openai-status-row">
                                            <span id="openai-status-icon" class="text-base">‚ö™</span>
                                            <span class="font-semibold">OpenAI LLM:</span>
                                            <span id="openai-status-text" class="font-mono font-bold">-</span>
                                        </div>
                                        
                                        <!-- MongoDB Status -->
                                        <div class="flex items-center gap-2 p-2 rounded" id="mongodb-status-row">
                                            <span id="mongodb-status-icon" class="text-base">‚ö™</span>
                                            <span class="font-semibold">MongoDB:</span>
                                            <span id="mongodb-status-text" class="font-mono font-bold">-</span>
                                        </div>
                                        
                                        <!-- Redis Status -->
                                        <div class="flex items-center gap-2 p-2 rounded" id="redis-status-row">
                                            <span id="redis-status-icon" class="text-base">‚ö™</span>
                                            <span class="font-semibold">Redis Cache:</span>
                                            <span id="redis-status-text" class="font-mono font-bold">-</span>
                                        </div>
                                        
                                        <!-- 3-Tier Status -->
                                        <div class="flex items-center gap-2 p-2 rounded" id="tier3-status-row">
                                            <span id="tier3-status-icon" class="text-base">‚ö™</span>
                                            <span class="font-semibold">3-Tier AI:</span>
                                            <span id="tier3-status-text" class="font-mono font-bold">-</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Issue Summary -->
                                    <div id="status-issues" class="mt-2 text-xs opacity-90 hidden">
                                        <!-- Populated by JS if there are issues -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ERROR LOG SECTION (DETAILED REPORT) -->
                            <div id="diagnostic-error-log" class="hidden mt-4">
                                <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <h5 class="font-bold text-red-900 flex items-center gap-2">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            System Error Log
                                        </h5>
                                        <div class="flex gap-2">
                                            <button onclick="copyDiagnosticErrors()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold transition-colors">
                                                <i class="fas fa-copy mr-1"></i>
                                                Copy All
                                            </button>
                                            <button onclick="refreshDiagnostics()" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-semibold transition-colors">
                                                <i class="fas fa-sync-alt mr-1"></i>
                                                Refresh
                                            </button>
                                            <button onclick="closeDiagnostics()" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded text-xs font-semibold transition-colors">
                                                <i class="fas fa-times mr-1"></i>
                                                Close
                                            </button>
                                        </div>
                                    </div>
                                    <div id="diagnostic-error-list" class="bg-white rounded p-4 max-h-96 overflow-y-auto text-sm font-mono text-gray-800">
                                        <!-- Errors will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-6 mb-6 shadow-sm">
                        <!-- üìå TEMPLATE ID BADGE (VISUAL TRACKING) -->
                        <div id="filler-synonym-template-badge" class="mb-6 p-4 rounded-lg border-2 hidden" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                                        <i class="fas fa-brain text-white text-2xl"></i>
                                    </div>
                                    <div class="text-white">
                                        <div class="text-xs font-semibold opacity-90 uppercase tracking-wide">Editing Template</div>
                                        <div class="text-lg font-bold" id="template-badge-name">Loading...</div>
                                        <div class="text-xs font-mono opacity-75 flex items-center gap-2 mt-1">
                                            <span>Template ID:</span>
                                            <code id="template-badge-id" class="bg-white bg-opacity-20 px-2 py-0.5 rounded">...</code>
                                            <span class="mx-1">‚Ä¢</span>
                                            <span class="bg-green-400 bg-opacity-40 px-2 py-0.5 rounded flex items-center gap-1">
                                                <i class="fas fa-link text-xs"></i>
                                                <span id="template-badge-filler-id">...-F</span>
                                            </span>
                                            <span class="bg-purple-400 bg-opacity-40 px-2 py-0.5 rounded flex items-center gap-1">
                                                <i class="fas fa-link text-xs"></i>
                                                <span id="template-badge-synonym-id">...-S</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right text-white">
                                    <div class="text-xs opacity-75">Last Synced</div>
                                    <div class="text-sm font-semibold" id="template-badge-sync-time">Just now</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- üîá FILLER WORDS SECTION -->
                        <div class="mb-8" data-template-section="fillers">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                                        <i class="fas fa-filter text-gray-600"></i>
                                        Filler Words (Noise Removal)
                                        <span id="filler-container-id" class="text-xs font-mono text-gray-400 ml-2" title="Filler Container ID"></span>
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Words to remove from caller input before matching ‚Ä¢ Inherited by ALL categories
                                    </p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="importTemplateFillers()" 
                                            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition-colors flex items-center gap-2 text-sm">
                                        <i class="fas fa-file-import"></i>
                                        Import
                                    </button>
                                    <button onclick="exportTemplateFillers()" 
                                            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition-colors flex items-center gap-2 text-sm">
                                        <i class="fas fa-file-export"></i>
                                        Export
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded px-3 py-1.5 mb-3 text-xs text-gray-600 flex items-center gap-2">
                                <i class="fas fa-info-circle text-blue-500 text-xs"></i>
                                <span><strong>How it works:</strong> These words are removed from caller speech before scenario matching. Example: "um, I need help with the, you know, thingy" ‚Üí "I need help with thingy"</span>
                            </div>
                            
                            <!-- Add Filler Input -->
                            <div class="flex gap-3 mb-4">
                                <input type="text" 
                                       id="template-filler-input" 
                                       placeholder="Add filler words (comma-separated: um, uh, like, you know...)" 
                                       class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       onkeypress="if(event.key==='Enter'){event.preventDefault();addFillerWord();}">
                                <button onclick="addFillerWord()" 
                                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors flex items-center gap-2">
                                    <i class="fas fa-plus"></i>
                                    Add
                                </button>
                            </div>
                            
                            <!-- Filler Words List Display (Compact Columns) -->
                            <div id="template-fillers-display" 
                                 class="grid grid-cols-8 gap-x-3 gap-y-1 p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 text-sm">
                                <!-- Filler words will be rendered here in 8 tight columns -->
                                <div class="text-gray-400 text-center py-8 col-span-8">Loading filler words...</div>
                            </div>
                        </div>
                        
                        <!-- üî§ SYNONYM MAPPINGS SECTION -->
                        <div data-template-section="synonyms">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                                        <i class="fas fa-language text-purple-600"></i>
                                        Synonym Mappings (Colloquial ‚Üí Technical)
                                        <span id="synonym-container-id" class="text-xs font-mono text-gray-400 ml-2" title="Synonym Container ID"></span>
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Translate customer slang into technical terms ‚Ä¢ Inherited by ALL categories
                                    </p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="importTemplateSynonyms()" 
                                            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition-colors flex items-center gap-2 text-sm">
                                        <i class="fas fa-file-import"></i>
                                        Import
                                    </button>
                                    <button onclick="exportTemplateSynonyms()" 
                                            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition-colors flex items-center gap-2 text-sm">
                                        <i class="fas fa-file-export"></i>
                                        Export
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-purple-50 border border-purple-200 rounded px-3 py-1.5 mb-3 text-xs text-gray-600 flex items-center gap-2">
                                <i class="fas fa-info-circle text-purple-500 text-xs"></i>
                                <span><strong>How it works:</strong> Customer says "the thingy on the wall" ‚Üí System translates to "the thermostat on the wall" before matching</span>
                            </div>
                            
                            <!-- Add Synonym Input -->
                            <div class="flex gap-2 mb-4">
                                <input type="text" 
                                       id="template-synonym-technical" 
                                       placeholder="Technical term (e.g., thermostat)" 
                                       class="flex-1 px-4 py-2 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                <div class="flex items-center px-3 text-2xl text-gray-400 font-bold">‚Üí</div>
                                <input type="text" 
                                       id="template-synonym-colloquial" 
                                       placeholder="Colloquial terms (e.g., thingy, box, thing on wall)" 
                                       class="flex-1 px-4 py-2 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                       onkeypress="if(event.key==='Enter'){event.preventDefault();addSynonymMapping();}">
                                <button onclick="addSynonymMapping()" 
                                        class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-colors flex items-center gap-2">
                                    <i class="fas fa-plus"></i>
                                    Add
                                </button>
                            </div>
                            
                            <!-- Synonyms Display with Counter -->
                            <div class="relative">
                                <div class="flex items-center justify-between mb-2 px-1">
                                    <span class="text-xs font-semibold text-gray-600">
                                        <span id="synonym-visible-count">0</span> of <span id="synonym-total-count">0</span> mappings shown
                                    </span>
                                    <span class="text-xs text-purple-600" id="synonym-scroll-hint" style="display: none;">
                                        <i class="fas fa-arrows-alt-v"></i> Scroll for more
                                    </span>
                                </div>
                                <div id="template-synonyms-display" 
                                     class="space-y-2 min-h-[120px] max-h-[400px] overflow-y-auto p-4 bg-purple-50 rounded-lg border-2 border-dashed border-purple-300"
                                     onscroll="updateSynonymScrollHint()">
                                    <!-- Loading skeleton -->
                                    <div class="skeleton skeleton-text w-full"></div>
                                    <div class="skeleton skeleton-text w-3/4"></div>
                                    <div class="skeleton skeleton-text w-5/6"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ================================================================
                         üéØ INTELLIGENCE MODE (Template Mode ONLY)
                         ================================================================
                         This is ONLY for Template Testing - hidden in Company Mode
                         ================================================================ -->
                    <div id="intelligence-mode-section" class="template-mode-only" style="display: block;">
                    
                    <!-- üéØ INTELLIGENCE MODE PRESET SELECTOR -->
                    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-xl p-6 mt-6 shadow-lg">
                        <div class="mb-6">
                            <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                                <i class="fas fa-rocket text-purple-600"></i>
                                Intelligence Mode
                            </h3>
                            <p class="text-sm text-gray-600 mt-2">
                                Choose how aggressively Test Pilot analyzes your template. This automatically configures LLM analysis depth, cost limits, and quality thresholds.
                            </p>
                        </div>
                        
                        <!-- Current Mode Display -->
                        <div id="current-intelligence-mode" class="mb-6 p-4 bg-white rounded-lg border-2 border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="text-sm text-gray-600">Current Mode:</span>
                                    <span id="current-mode-name" class="text-lg font-bold text-gray-900 ml-2">Not Set</span>
                                </div>
                                <span id="current-mode-emoji" class="text-3xl">‚öôÔ∏è</span>
                            </div>
                        </div>
                        
                        <!-- Preset Cards (3-column grid) -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            
                            <!-- MAXIMUM MODE -->
                            <div class="preset-card border-3 rounded-xl p-5 cursor-pointer transition-all hover:shadow-xl hover:-translate-y-1 bg-gradient-to-br from-red-50 to-orange-50 border-red-300"
                                 onclick="selectIntelligenceMode('MAXIMUM')"
                                 data-mode="MAXIMUM">
                                <div class="text-center mb-3">
                                    <div class="text-5xl mb-2">üî•</div>
                                    <h4 class="text-xl font-bold text-red-700">MAXIMUM LLM HELP</h4>
                                    <p class="text-xs text-gray-600 mt-1">Best for perfecting templates</p>
                                </div>
                                
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-brain text-red-600 w-4"></i>
                                        <span class="text-gray-700">Deep LLM analysis (GPT-4o)</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-microscope text-red-600 w-4"></i>
                                        <span class="text-gray-700">Always analyze (even on success)</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-chart-line text-red-600 w-4"></i>
                                        <span class="text-gray-700">Conflict detection: AGGRESSIVE</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-magic text-red-600 w-4"></i>
                                        <span class="text-gray-700">Before/after simulation</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-dollar-sign text-red-600 w-4"></i>
                                        <span class="text-gray-700 font-semibold">~$0.15/test</span>
                                    </div>
                                </div>
                                
                                <div class="mt-4 p-3 bg-white rounded-lg border border-red-200">
                                    <p class="text-xs text-gray-600 leading-relaxed">
                                        <strong class="text-red-700">Best for:</strong> Initial template development, finding hidden issues, perfectionism
                                    </p>
                                </div>
                            </div>
                            
                            <!-- BALANCED MODE -->
                            <div class="preset-card border-3 rounded-xl p-5 cursor-pointer transition-all hover:shadow-xl hover:-translate-y-1 bg-gradient-to-br from-blue-50 to-cyan-50 border-blue-300"
                                 onclick="selectIntelligenceMode('BALANCED')"
                                 data-mode="BALANCED">
                                <div class="text-center mb-3">
                                    <div class="text-5xl mb-2">‚öñÔ∏è</div>
                                    <h4 class="text-xl font-bold text-blue-700">BALANCED</h4>
                                    <p class="text-xs text-gray-600 mt-1">Smart cost-quality balance</p>
                                </div>
                                
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-brain text-blue-600 w-4"></i>
                                        <span class="text-gray-700">Standard LLM (GPT-4o-mini)</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-microscope text-blue-600 w-4"></i>
                                        <span class="text-gray-700">Analyze on failure</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-chart-line text-blue-600 w-4"></i>
                                        <span class="text-gray-700">Conflict detection: STANDARD</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-magic text-blue-600 w-4"></i>
                                        <span class="text-gray-700">Impact analysis included</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-dollar-sign text-blue-600 w-4"></i>
                                        <span class="text-gray-700 font-semibold">~$0.05/test</span>
                                    </div>
                                </div>
                                
                                <div class="mt-4 p-3 bg-white rounded-lg border border-blue-200">
                                    <p class="text-xs text-gray-600 leading-relaxed">
                                        <strong class="text-blue-700">Best for:</strong> Ongoing maintenance, periodic improvements, most use cases
                                    </p>
                                </div>
                            </div>
                            
                            <!-- MINIMAL MODE -->
                            <div class="preset-card border-3 rounded-xl p-5 cursor-pointer transition-all hover:shadow-xl hover:-translate-y-1 bg-gradient-to-br from-green-50 to-emerald-50 border-green-300"
                                 onclick="selectIntelligenceMode('MINIMAL')"
                                 data-mode="MINIMAL">
                                <div class="text-center mb-3">
                                    <div class="text-5xl mb-2">üíö</div>
                                    <h4 class="text-xl font-bold text-green-700">MINIMAL</h4>
                                    <p class="text-xs text-gray-600 mt-1">Cost-optimized testing</p>
                                </div>
                                
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-brain text-green-600 w-4"></i>
                                        <span class="text-gray-700">Fast LLM (GPT-4o-mini)</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-microscope text-green-600 w-4"></i>
                                        <span class="text-gray-700">Only critical failures</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-chart-line text-green-600 w-4"></i>
                                        <span class="text-gray-700">Conflict detection: DISABLED</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-magic text-green-600 w-4"></i>
                                        <span class="text-gray-700">Basic suggestions only</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-dollar-sign text-green-600 w-4"></i>
                                        <span class="text-gray-700 font-semibold">~$0.02/test</span>
                                    </div>
                                </div>
                                
                                <div class="mt-4 p-3 bg-white rounded-lg border border-green-200">
                                    <p class="text-xs text-gray-600 leading-relaxed">
                                        <strong class="text-green-700">Best for:</strong> Mature templates, tight budgets, high-volume testing
                                    </p>
                                </div>
                            </div>
                            
                        </div>
                        
                        <!-- Comparison Note -->
                        <div class="mt-4 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-lightbulb text-yellow-600 text-xl mt-1"></i>
                                <div class="text-sm">
                                    <p class="font-semibold text-yellow-900 mb-1">üí° Pro Tip:</p>
                                    <p class="text-yellow-800 leading-relaxed">
                                        Start with <strong>MAXIMUM</strong> to perfect your template upfront, then switch to <strong>BALANCED</strong> for ongoing maintenance. 
                                        The upfront investment pays off with 99% free (Tier 1) production calls!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    </div>
                    <!-- END: Intelligence Mode Section (Template Mode Only) -->
                    
                    <!-- ========================================================================== -->
                    <!-- üìà ENTERPRISE TREND ANALYTICS - TEMPLATE PERFORMANCE OVER TIME -->
                    <!-- ========================================================================== -->
                    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-300 rounded-xl p-6 mt-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                                    <i class="fas fa-chart-line text-blue-600"></i>
                                    Performance Trends
                                </h3>
                                <p class="text-sm text-gray-600 mt-1">
                                    Visualize template improvement over time with confidence trends, tier distribution, and cost analysis
                                </p>
                            </div>
                            <button onclick="loadEnterpriseTrendCharts()" 
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all flex items-center gap-2 shadow-md">
                                <i class="fas fa-sync-alt"></i>
                                Load Charts
                            </button>
                        </div>
                        
                        <!-- Charts Container -->
                        <div id="enterprise-trend-charts" class="mt-4">
                            <!-- Charts will be rendered here by EnterpriseTrendCharts.js -->
                            <div class="text-center py-12 bg-white rounded-lg border-2 border-gray-200">
                                <i class="fas fa-chart-bar text-6xl text-gray-300 mb-4"></i>
                                <h4 class="text-xl font-bold text-gray-700 mb-2">Ready to Load Trends</h4>
                                <p class="text-gray-600 mb-4">
                                    Click "Load Charts" above to visualize your template's performance over time.
                                </p>
                                <p class="text-sm text-gray-500">
                                    üí° Tip: Run some tests first to see meaningful trends
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üß† AI LEARNING & OPTIMIZATION SECTION -->
                    <div class="bg-gradient-to-br from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-6 mt-6 shadow-sm">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                                    <i class="fas fa-brain text-indigo-600"></i>
                                    AI Learning & Optimization
                                </h3>
                                <p class="text-sm text-gray-600 mt-1">
                                    Configure how this template learns from LLM analysis and shares patterns
                                </p>
                            </div>
                            <button onclick="saveAILearningSettings()" 
                                    id="save-learning-settings-btn"
                                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold transition-all flex items-center gap-2 text-sm shadow-md hover:bg-indigo-700 active:scale-95">
                                <i class="fas fa-save"></i>
                                Save Settings
                            </button>
                        </div>
                        
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-3 mb-6 text-sm text-gray-700">
                            <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                            <strong>How it works:</strong> When Tier 3 (LLM) is used, the AI analyzes caller speech patterns and automatically improves Tier 1 (rule-based) matching over time, reducing costs.
                        </div>
                        
                        <!-- Learning Scope -->
                        <div class="bg-white border-2 border-gray-200 rounded-lg p-5 mb-4">
                            <h4 class="text-md font-semibold text-gray-900 flex items-center gap-2 mb-3">
                                <i class="fas fa-share-alt text-blue-600"></i>
                                Learning Scope & Sharing
                            </h4>
                            
                            <div class="space-y-4">
                                <!-- Learning Enabled (Always ON) -->
                                <div class="flex items-center justify-between px-3 py-2 bg-green-50 border-2 border-green-200 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-check-circle text-green-600"></i>
                                        <div>
                                            <p class="font-semibold text-green-900 text-sm">Learning Enabled</p>
                                            <p class="text-xs text-green-700">Patterns are always captured and stored</p>
                                        </div>
                                    </div>
                                    <div class="px-2 py-1 bg-green-100 text-green-800 font-semibold text-xs rounded-full">
                                        Always ON
                                    </div>
                                </div>
                                
                                <!-- Share Within Industry -->
                                <div class="flex items-start gap-2 px-3 py-2 bg-gray-50 border-2 border-gray-200 rounded-lg hover:border-indigo-300 transition-colors">
                                    <input type="checkbox" 
                                           id="learning-share-industry" 
                                           onchange="updateAILearningUI()"
                                           class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mt-0.5">
                                    <div class="flex-1">
                                        <label for="learning-share-industry" class="font-semibold text-gray-900 cursor-pointer flex items-center gap-2 text-sm">
                                            <i class="fas fa-building text-indigo-600 text-xs"></i>
                                            Share Patterns Within Industry
                                        </label>
                                        <p class="text-xs text-gray-600 mt-0.5">
                                            High-confidence patterns are shared with other templates in the same industry (e.g., all HVAC templates)
                                        </p>
                                        
                                        <!-- Industry Sharing Threshold (shown when enabled) -->
                                        <div id="industry-threshold-container" class="mt-3 pl-6 border-l-2 border-indigo-200 hidden">
                                            <label class="text-sm font-medium text-gray-700 mb-1 block">Industry Share Threshold</label>
                                            <div class="flex items-center gap-3">
                                                <input type="range" 
                                                       id="learning-industry-threshold" 
                                                       min="70" 
                                                       max="95" 
                                                       value="85" 
                                                       onchange="updateAILearningUI()"
                                                       oninput="document.getElementById('industry-threshold-value').textContent=this.value"
                                                       class="flex-1">
                                                <span id="industry-threshold-value" class="text-md font-bold text-indigo-600 min-w-[50px]">85</span>
                                                <span class="text-sm text-gray-500">%</span>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">
                                                Patterns with quality score ‚â• threshold will be shared with industry peers
                                            </p>
                                            
                                            <!-- Auto-Approve Industry Sharing -->
                                            <div class="flex items-center gap-2 mt-3 p-2 bg-indigo-50 rounded">
                                                <input type="checkbox" 
                                                       id="learning-auto-approve-industry" 
                                                       class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                                <label for="learning-auto-approve-industry" class="text-sm text-gray-700 cursor-pointer">
                                                    Auto-approve industry sharing (no manual review)
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Propose for Global -->
                                <div class="flex items-start gap-2 px-3 py-2 bg-gray-50 border-2 border-gray-200 rounded-lg hover:border-purple-300 transition-colors">
                                    <input type="checkbox" 
                                           id="learning-propose-global" 
                                           onchange="updateAILearningUI()"
                                           class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500 mt-0.5">
                                    <div class="flex-1">
                                        <label for="learning-propose-global" class="font-semibold text-gray-900 cursor-pointer flex items-center gap-2 text-sm">
                                            <i class="fas fa-globe text-purple-600 text-xs"></i>
                                            Propose Patterns for Global Platform
                                        </label>
                                        <p class="text-xs text-gray-600 mt-0.5">
                                            Universal patterns (work across all industries) are submitted for admin review to be shared platform-wide
                                        </p>
                                        
                                        <!-- Global Propose Threshold (shown when enabled) -->
                                        <div id="global-threshold-container" class="mt-3 pl-6 border-l-2 border-purple-200 hidden">
                                            <label class="text-sm font-medium text-gray-700 mb-1 block">Global Propose Threshold</label>
                                            <div class="flex items-center gap-3">
                                                <input type="range" 
                                                       id="learning-global-threshold" 
                                                       min="85" 
                                                       max="98" 
                                                       value="90" 
                                                       onchange="updateAILearningUI()"
                                                       oninput="document.getElementById('global-threshold-value').textContent=this.value"
                                                       class="flex-1">
                                                <span id="global-threshold-value" class="text-md font-bold text-purple-600 min-w-[50px]">90</span>
                                                <span class="text-sm text-gray-500">%</span>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">
                                                Only exceptionally high-quality patterns will be proposed for global review
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ‚ö° NEW: Intelligence Settings Configuration -->
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-300 rounded-lg p-5 mb-4 shadow-md">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-md font-semibold text-gray-900 flex items-center gap-2 mb-2">
                                        <i class="fas fa-brain text-purple-600"></i>
                                        Test Pilot Intelligence Settings
                                    </h4>
                                    <p class="text-sm text-gray-600">
                                        Configure how aggressively the AI learns during testing. 
                                        Choose from presets (Conservative, Balanced, Aggressive, YOLO) or customize thresholds.
                                    </p>
                                </div>
                                <button onclick="window.intelligenceSettingsModal.open()" 
                                        class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 flex items-center gap-2">
                                    <i class="fas fa-cog"></i>
                                    Configure Intelligence
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tier Confidence Thresholds -->
                        <div class="bg-white border-2 border-gray-200 rounded-lg p-5 mb-4">
                            <h4 class="text-md font-semibold text-gray-900 flex items-center gap-2 mb-3">
                                <i class="fas fa-sliders-h text-green-600"></i>
                                Tier Confidence Thresholds
                            </h4>
                            
                            <p class="text-sm text-gray-600 mb-4">
                                Control when the AI escalates from fast (free) to smart (expensive) tiers
                            </p>
                            
                            <div class="space-y-4">
                                <!-- Tier 1 Threshold -->
                                <div class="px-3 py-2 bg-green-50 border-2 border-green-200 rounded-lg">
                                    <div class="flex items-center justify-between mb-1">
                                        <label class="text-xs font-semibold text-gray-900 flex items-center gap-2">
                                            <span class="px-2 py-0.5 bg-green-500 text-white text-xs rounded font-bold">TIER 1</span>
                                            Rule-Based Matching (Free)
                                        </label>
                                        <div class="flex items-center gap-2">
                                            <span id="tier1-threshold-value" class="text-lg font-bold text-green-600">80</span>
                                            <span class="text-sm text-gray-500">% confidence</span>
                                        </div>
                                    </div>
                                    <input type="range" 
                                           id="learning-tier1-threshold" 
                                           min="60" 
                                           max="95" 
                                           value="80" 
                                           oninput="document.getElementById('tier1-threshold-value').textContent=this.value"
                                           class="w-full">
                                    <p class="text-xs text-gray-600 mt-1">
                                        If match confidence ‚â• threshold ‚Üí Use Tier 1 (instant, free)
                                    </p>
                                </div>
                                
                                <!-- Tier 2 Threshold -->
                                <div class="px-3 py-2 bg-blue-50 border-2 border-blue-200 rounded-lg">
                                    <div class="flex items-center justify-between mb-1">
                                        <label class="text-xs font-semibold text-gray-900 flex items-center gap-2">
                                            <span class="px-2 py-0.5 bg-blue-500 text-white text-xs rounded font-bold">TIER 2</span>
                                            Semantic Analysis (Free)
                                        </label>
                                        <div class="flex items-center gap-2">
                                            <span id="tier2-threshold-value" class="text-lg font-bold text-blue-600">60</span>
                                            <span class="text-sm text-gray-500">% confidence</span>
                                        </div>
                                    </div>
                                    <input type="range" 
                                           id="learning-tier2-threshold" 
                                           min="40" 
                                           max="80" 
                                           value="60" 
                                           oninput="document.getElementById('tier2-threshold-value').textContent=this.value"
                                           class="w-full">
                                    <p class="text-xs text-gray-600 mt-1">
                                        If Tier 1 fails but Tier 2 ‚â• threshold ‚Üí Use semantic matching (fast, free)
                                    </p>
                                </div>
                                
                                <!-- Tier 3 (LLM) Info -->
                                <div class="px-3 py-2 bg-purple-50 border-2 border-purple-200 rounded-lg">
                                    <div class="flex items-center justify-between mb-1">
                                        <label class="text-xs font-semibold text-gray-900 flex items-center gap-2">
                                            <span class="px-2 py-0.5 bg-purple-500 text-white text-xs rounded font-bold">TIER 3</span>
                                            LLM Fallback (Expensive)
                                        </label>
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs text-purple-700 font-medium">Used when Tier 1 & 2 fail</span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-600">
                                        GPT-4 analyzes the input and teaches Tier 1/2 for future free matches
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Budget Controls -->
                        <div class="bg-white border-2 border-gray-200 rounded-lg p-5">
                            <h4 class="text-md font-semibold text-gray-900 flex items-center gap-2 mb-3">
                                <i class="fas fa-dollar-sign text-yellow-600"></i>
                                LLM Budget Controls
                            </h4>
                            
                            <p class="text-sm text-gray-600 mb-4">
                                Set spending limits for Tier 3 (LLM) fallback to prevent unexpected costs
                            </p>
                            
                            <!-- 3 Column Layout for Compact Display -->
                            <div class="grid grid-cols-3 gap-4">
                                <!-- Monthly Budget -->
                                <div>
                                    <label class="text-xs font-medium text-gray-700 mb-1 block">Monthly LLM Budget (USD)</label>
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg text-gray-400">$</span>
                                        <input type="number" 
                                               id="learning-llm-budget" 
                                               min="0" 
                                               max="10000" 
                                               value="500" 
                                               step="50"
                                               class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 font-semibold text-sm">
                                        <span class="text-xs text-gray-500">per month</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">
                                        Max spend on OpenAI API calls per month (resets monthly)
                                    </p>
                                </div>
                                
                                <!-- Cost Per Call Warning -->
                                <div>
                                    <label class="text-xs font-medium text-gray-700 mb-1 block">Cost Per Call Warning (USD)</label>
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg text-gray-400">$</span>
                                        <input type="number" 
                                               id="learning-llm-cost-per-call" 
                                               min="0.01" 
                                               max="5.00" 
                                               value="0.50" 
                                               step="0.05"
                                               class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 font-semibold text-sm">
                                        <span class="text-xs text-gray-500">per call</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">
                                        Alert sent to Notification Center if a single LLM call exceeds this amount
                                    </p>
                                </div>
                                
                                <!-- Min Pattern Frequency -->
                                <div>
                                    <label class="text-xs font-medium text-gray-700 mb-1 block">Minimum Pattern Frequency</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" 
                                               id="learning-min-pattern-freq" 
                                               min="1" 
                                               max="20" 
                                               value="3" 
                                               step="1"
                                               class="w-20 px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 font-semibold text-center text-sm">
                                        <span class="text-xs text-gray-500">occurrences before applying</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">
                                        Pattern must appear this many times before being auto-applied (prevents false positives)
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Save Button (Bottom) -->
                        <div class="flex items-center justify-end gap-3 mt-6 pt-4 border-t-2 border-gray-200">
                            <button onclick="loadAILearningSettings()" 
                                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition-colors flex items-center gap-2">
                                <i class="fas fa-undo"></i>
                                Reset to Saved
                            </button>
                            <button onclick="saveAILearningSettings()" 
                                    class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold transition-all flex items-center gap-2 shadow-md hover:shadow-lg">
                                <i class="fas fa-save"></i>
                                Save AI Learning Settings
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ========================================================================== -->
                <!-- üìä AI COST DASHBOARD - REAL-TIME COST TRACKING & OPTIMIZATION -->
                <!-- ========================================================================== -->
                <div id="ai-cost-dashboard-section" class="mb-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl shadow-lg border-2 border-green-400 overflow-hidden">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-green-600 to-emerald-600 px-6 py-4 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center shadow-md">
                                <i class="fas fa-chart-line text-green-600 text-lg"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                    üìä AI Cost Dashboard
                                    <span id="cost-status-badge" class="text-xs font-semibold bg-green-700 px-3 py-1 rounded-lg shadow">
                                        LOADING...
                                    </span>
                                </h3>
                                <p class="text-xs text-white font-medium">
                                    Real-time OpenAI usage, budget tracking, and cost optimization
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="refreshAICostDashboard()" class="px-4 py-2 bg-white text-green-600 hover:bg-green-50 rounded-lg font-semibold transition-all flex items-center gap-2 shadow-md">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                            <button onclick="exportCostReport()" class="px-4 py-2 bg-white text-blue-600 hover:bg-blue-50 rounded-lg font-semibold transition-all flex items-center gap-2 shadow-md">
                                <i class="fas fa-file-download"></i>
                                Export Report
                            </button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div id="ai-cost-dashboard-content" class="p-6">
                        <!-- Loading State -->
                        <div id="cost-loading-state" class="text-center py-12">
                            <i class="fas fa-spinner fa-spin text-6xl text-green-300 mb-4"></i>
                            <h4 class="text-xl font-bold text-gray-700 mb-2">Loading Cost Data...</h4>
                            <p class="text-gray-600">Fetching your AI usage and costs from OpenAI</p>
                        </div>

                        <!-- Main Dashboard (shown when data loaded) -->
                        <div id="cost-dashboard-main" class="hidden space-y-6">
                            <!-- Budget Overview Card -->
                            <div class="bg-white rounded-lg border-2 border-green-300 p-6 shadow-md">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                        <i class="fas fa-wallet text-green-600"></i>
                                        Current Month Budget
                                    </h4>
                                    <div id="cost-month-label" class="text-sm text-gray-600 font-semibold">
                                        November 2025
                                    </div>
                                </div>
                                
                                <!-- Budget Progress Bar -->
                                <div class="mb-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-2xl font-bold text-gray-900" id="cost-total-spent">$0.00</span>
                                        <span class="text-sm text-gray-600">of <span id="cost-budget-limit" class="font-bold">$500.00</span></span>
                                    </div>
                                    <div class="relative w-full h-8 bg-gray-200 rounded-lg overflow-hidden">
                                        <div id="cost-budget-progress-bar" 
                                             class="absolute top-0 left-0 h-full bg-gradient-to-r from-green-500 to-emerald-500 transition-all duration-500" 
                                             style="width: 0%">
                                        </div>
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <span id="cost-budget-percentage" class="text-sm font-bold text-gray-700">0%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Stats Grid -->
                                <div class="grid grid-cols-4 gap-4">
                                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                                        <div class="text-2xl font-bold text-gray-900" id="cost-total-calls">0</div>
                                        <div class="text-xs text-gray-600">LLM Calls</div>
                                    </div>
                                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                                        <div class="text-2xl font-bold text-gray-900" id="cost-avg-per-call">$0.00</div>
                                        <div class="text-xs text-gray-600">Avg/Call</div>
                                    </div>
                                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                                        <div class="text-2xl font-bold text-gray-900" id="cost-estimated-monthly">$0.00</div>
                                        <div class="text-xs text-gray-600">Est. Month End</div>
                                    </div>
                                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                                        <div class="text-2xl font-bold text-gray-900" id="cost-remaining-budget">$500.00</div>
                                        <div class="text-xs text-gray-600">Remaining</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Optimization Recommendations -->
                            <div id="cost-recommendations-container" class="hidden bg-gradient-to-br from-yellow-50 to-amber-50 rounded-lg border-2 border-yellow-400 p-6">
                                <h4 class="text-lg font-bold text-yellow-900 flex items-center gap-2 mb-4">
                                    <i class="fas fa-lightbulb text-yellow-600"></i>
                                    üí° Cost Optimization Recommendations
                                </h4>
                                <div id="cost-recommendations-list" class="space-y-3">
                                    <!-- Recommendations inserted here -->
                                </div>
                            </div>
                            
                            <!-- Cost Trend Chart (Last 7 Days) -->
                            <div class="bg-white rounded-lg border-2 border-gray-300 p-6 shadow-md">
                                <h4 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                                    <i class="fas fa-chart-area text-blue-600"></i>
                                    Cost Trends (Last 7 Days)
                                </h4>
                                <div id="cost-trend-chart" class="space-y-2">
                                    <!-- Chart bars inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- CATEGORY SETTINGS TAB PANEL -->
                <div id="template-data-panel-categories" 
                     class="template-data-subtab-panel" 
                     role="tabpanel"
                     aria-labelledby="template-data-tab-categories">
                    
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-6 mb-6 shadow-sm">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-3">
                                    <i class="fas fa-layer-group text-blue-600"></i>
                                    Category-Specific Settings
                                </h3>
                                <p class="text-sm text-gray-600 mt-1">
                                    Each category can extend template settings with additional fillers and synonyms
                                </p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">Total Categories</div>
                                <div class="text-3xl font-bold text-blue-600" id="category-table-count">0</div>
                            </div>
                        </div>
                        
                        <!-- Enterprise DataTable -->
                        <div class="overflow-x-auto">
                            <table class="enterprise-table" id="category-settings-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">
                                            <i class="fas fa-chevron-right text-gray-400"></i>
                                        </th>
                                        <th>Category Name</th>
                                        <th>Scenarios</th>
                                        <th>Custom Fillers</th>
                                        <th>Custom Synonyms</th>
                                        <th>Total Effective</th>
                                        <th style="width: 120px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="category-settings-tbody">
                                    <!-- Loading skeleton rows -->
                                    <tr>
                                        <td colspan="7" class="text-center py-12">
                                            <div class="skeleton skeleton-text w-full mb-2"></div>
                                            <div class="skeleton skeleton-text w-3/4 mx-auto mb-2"></div>
                                            <div class="skeleton skeleton-text w-5/6 mx-auto"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="category-settings-empty" class="hidden text-center py-12">
                            <div class="text-6xl mb-4">üìÅ</div>
                            <h4 class="text-xl font-bold text-gray-900 mb-2">No Categories Yet</h4>
                            <p class="text-gray-600 mb-6">Create your first category to start adding category-specific settings</p>
                            <button onclick="openAddCategoryModal()" 
                                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors">
                                <i class="fas fa-plus mr-2"></i>
                                Add Your First Category
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Return to original template selector section -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-6 mb-8 shadow-sm">
                    <!-- Template Stats -->
                    <div id="dashboard-template-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 pt-4 border-t border-blue-200">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" id="dash-stat-categories">0</div>
                            <div class="text-xs text-gray-600 mt-1">üìÅ Categories</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="dash-stat-scenarios">0</div>
                            <div class="text-xs text-gray-600 mt-1">üí¨ Scenarios</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600" id="dash-stat-triggers">0</div>
                            <div class="text-xs text-gray-600 mt-1">‚ö° Triggers</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-indigo-600" id="dash-stat-version">v0.0.0</div>
                            <div class="text-xs text-gray-600 mt-1">üî¢ Version</div>
                        </div>
                    </div>
                    
                    <div id="dashboard-template-updated" class="text-xs text-gray-500 mt-3 text-center">
                        üïí Last updated: --
                    </div>
                </div>

                <!-- ================================================================
                     üì± TEMPLATE TEST MODE SECTION (Always Visible)
                     ================================================================
                     Always visible - mutually exclusive toggle with Company Testing
                     ================================================================ -->
                <div id="template-test-mode">
                
                <!-- OLD TWILIO CONFIG REMOVED - NOW AT TOP AS COLLAPSIBLE ACCORDION -->
                
                </div>
                <!-- END: Template Test Mode Section -->
                
                </div>
                <!-- END: Template Mode Content -->

                <!-- ================================================================
                     üè¢ COMPANY MODE CONTENT (Shown when Company tab active)
                     ================================================================ -->
                <div id="company-mode-content" style="display: none;">
                    
                    <!-- Company Selector -->
                    <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border-2 border-blue-300 rounded-xl p-6 mb-8 shadow-sm">
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fas fa-building text-blue-600 mr-2"></i>
                                üè¢ Currently Testing Company:
                            </label>
                            <select id="top-company-selector-dropdown" onchange="onCompanySelected(this.value)" 
                                    class="w-full px-4 py-3 border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg font-semibold bg-white shadow-sm">
                                <option value="">-- Select a company to test --</option>
                            </select>
                            <p class="text-xs text-gray-600 mt-2">
                                <i class="fas fa-shield-alt text-blue-600 mr-1"></i>
                                Testing the company's REAL production configuration (Mongoose + Redis)
                            </p>
                        </div>
                    </div>
                
                    <!-- ================================================================
                         üè¢ COMPANY TESTING CONFIGURATION (CLEAN REBUILD)
                         ================================================================
                         Purpose: Simple, focused configuration for company testing
                         No duplicates, no confusion, just what's needed
                         ================================================================ -->
                    
                    <div class="bg-white rounded-xl border-2 border-blue-400 p-6 shadow-lg mb-8">
                        
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center shadow-md">
                                    <i class="fas fa-building text-white text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-gray-900">üè¢ Company Testing Configuration</h4>
                                    <p class="text-sm text-gray-600">Configure testing settings for this company</p>
                                </div>
                            </div>
                        </div>
                            
                        <!-- Company Details Container (Hidden until company selected) -->
                        <div id="company-details-container" style="display: none;" class="mb-6">
                            
                            <!-- Company Header -->
                            <div class="mb-4 p-4 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-lg shadow-md">
                                <div class="text-center text-white">
                                    <div class="text-xs font-semibold uppercase tracking-wide opacity-90 mb-1">
                                        üéØ Currently Testing
                                    </div>
                                    <div id="company-test-current-name" class="text-xl font-bold mb-1">
                                        No company selected
                                    </div>
                                    <div id="company-test-current-id" class="text-xs font-mono opacity-75">
                                        Select a company above
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Templates Section -->
                            <div id="templates-section" class="mb-6">
                                <div class="flex items-center gap-2 mb-3">
                                    <i class="fas fa-brain text-purple-600 text-lg"></i>
                                    <h3 class="text-lg font-bold text-gray-800">Loaded Templates</h3>
                                </div>
                                <div id="templates-cards-container" class="grid grid-cols-1 gap-4">
                                    <!-- Template cards will be rendered here -->
                                </div>
                            </div>
                            
                            <!-- Company-Specific Configuration (Rich Detail Cards) -->
                            <div id="company-config-section" class="mt-6">
                                <div class="flex items-center gap-2 mb-3">
                                    <i class="fas fa-cog text-blue-600 text-lg"></i>
                                    <h3 class="text-lg font-bold text-gray-800">Company Customizations</h3>
                                    <span class="text-xs text-gray-500 ml-2">(Overrides from Templates)</span>
                                </div>
                                <div id="customizations-cards-container" class="grid grid-cols-1 gap-4">
                                    <!-- Customization cards will be rendered here -->
                                </div>
                            </div>
                            
                        </div>
                        
                        <!-- Info Note -->
                        <div class="mt-4 bg-blue-50 px-4 py-3 rounded-lg border border-blue-200">
                            <p class="text-xs text-blue-900 leading-relaxed">
                                <i class="fas fa-shield-alt mr-1"></i>
                                <strong>Production Simulator:</strong> Tests the company's EXACT MongoDB configuration. What you test = what customers get!
                            </p>
                        </div>
                    </div>
                    
<!-- ================================================================
     ‚ö° COMPANY PRODUCTION INTELLIGENCE SETTINGS
     ================================================================
     
     FILE LOCATION: public/admin-global-instant-responses.html
     LINES: 2163-2612 (original)
     
     PURPOSE:
     Configure the 3-tier intelligence system for a SPECIFIC company.
     These settings control how real customer calls are processed.
     
     ARCHITECTURE:
     - Main Container: Single unified white box with green border
     - Header: Company icon, title, reload button
     - Settings: All intelligence configuration
     - Smart Warmup: Optional premium feature (collapsible)
     - Save Button: Persists settings to database
     
     DEPENDENCIES:
     - JavaScript Functions: loadCompanyProductionIntelligence(), saveCompanyProductionIntelligence()
     - CSS: Tailwind utility classes
     - IDs: All prefixed with "company-" for namespace isolation
     
     DEBUGGING:
     - Each major section has data-section attribute for easy targeting
     - All interactive elements have descriptive IDs
     - Console logs in JS functions for tracing
     
     ================================================================ -->
<div class="bg-white rounded-xl border-2 border-green-400 p-6 shadow-lg mb-8" 
     data-section="company-production-intelligence"
     data-debug-id="main-container">
    
    <!-- ============================================================
         SECTION 1: HEADER
         ============================================================
         Contains: Company icon, title, reload button
         Purpose: Visual identity and data refresh
         ============================================================ -->
    <div class="flex items-center justify-between mb-6" 
         data-section="header">
        
        <!-- Header Left: Icon + Title -->
        <div class="flex items-center gap-3">
            <!-- Rocket Icon (Green Gradient) -->
            <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-lg flex items-center justify-center shadow-md">
                <i class="fas fa-rocket text-white text-xl"></i>
            </div>
            
            <!-- Title + Subtitle -->
            <div>
                <h4 class="text-lg font-bold text-gray-900">‚ö° Company Production Intelligence</h4>
                <p class="text-sm text-gray-600">Configure 3-tier system for REAL customer calls</p>
            </div>
        </div>
        
        <!-- Header Right: Reload Button -->
        <button onclick="loadCompanyProductionIntelligence()" 
                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition-all text-sm"
                data-action="reload-settings">
            <i class="fas fa-sync-alt mr-1"></i>
            Reload
        </button>
    </div>
    <!-- END SECTION 1: HEADER -->
    
    
    <!-- ============================================================
         SECTION 1.5: INTELLIGENCE MODE INDICATOR
         ============================================================
         Purpose: Clearly show if company is using GLOBAL or CUSTOM settings
         Visual: Prominent badge with mode-specific styling and icon
         Action: Button to switch between modes (with confirmation)
         ============================================================ -->
    <div id="company-intelligence-mode-indicator" 
         class="mb-6 p-4 rounded-lg border-2"
         data-section="mode-indicator"
         data-intelligence-mode="global">
        
        <!-- Mode Badge Content -->
        <div class="flex items-center justify-between">
            
            <!-- Left: Mode Icon + Status -->
            <div class="flex items-center gap-3">
                <!-- Mode Icon -->
                <div id="mode-icon-container" 
                     class="w-12 h-12 rounded-full flex items-center justify-center">
                    <i id="mode-icon" class="text-white text-xl"></i>
                </div>
                
                <!-- Mode Text -->
                <div>
                    <div class="flex items-center gap-2">
                        <span id="mode-badge-text" class="font-bold text-lg"></span>
                        <span id="mode-subtitle" class="text-sm"></span>
                    </div>
                    <p id="mode-description" class="text-xs mt-1"></p>
                </div>
            </div>
            
            <!-- Right: Switch Button -->
            <button id="switch-mode-btn" 
                    onclick="showModeSwitchModal()" 
                    class="px-4 py-2 rounded-lg font-semibold transition-all text-sm"
                    data-action="switch-mode">
                <i class="fas fa-exchange-alt mr-1"></i>
                <span id="switch-btn-text">Switch Mode</span>
            </button>
        </div>
        
        <!-- Companies Affected Counter (only shown when in global mode) -->
        <div id="global-companies-count" 
             class="hidden mt-3 pt-3 border-t text-xs font-semibold">
            <i class="fas fa-building mr-1"></i>
            This company is 1 of <span id="global-companies-total" class="font-mono">0</span> companies using global settings
        </div>
    </div>
    <!-- END SECTION 1.5: MODE INDICATOR -->
    
    
    <!-- ============================================================
         SECTION 2: INTELLIGENCE SETTINGS CONTAINER
         ============================================================
         Contains: All configuration options for 3-tier system
         ============================================================ -->
    <div id="company-intelligence-settings" 
         data-section="settings-container">
        
        <!-- ============================================================
             2.1: 3-TIER SYSTEM TOGGLE
             ============================================================
             Interactive card that enables/disables entire 3-tier system
             Visual states: Enabled (green) / Disabled (gray)
             Click handler: toggleTier3Card()
             ============================================================ -->
        <div class="mb-6" data-section="tier3-toggle-wrapper">
            <!-- Hidden Checkbox (stores state) -->
            <input type="checkbox" 
                   id="company-enable-tier3" 
                   checked 
                   class="hidden"
                   data-state="tier3-enabled">
            
            <!-- Interactive Toggle Card -->
            <div id="tier3-toggle-card" 
                 onclick="toggleTier3Card()" 
                 class="relative cursor-pointer rounded-lg p-4 border-2 transition-all duration-200"
                 style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-color: #10b981;"
                 data-component="tier3-toggle-card"
                 data-interactive="true">
                
                <!-- Status Indicator Dot (Top Right) -->
                <div id="tier3-status-dot" 
                     class="absolute top-3 right-3 w-3 h-3 rounded-full"
                     style="background: #10b981;"
                     data-visual="status-indicator"></div>
                
                <!-- Card Content -->
                <div class="flex items-start gap-3">
                    <!-- Icon Container (Circle) -->
                    <div id="tier3-icon-container" 
                         class="w-10 h-10 rounded-full flex items-center justify-center"
                         style="background: #10b981;"
                         data-visual="icon-container">
                        <i id="tier3-icon" class="fas fa-check text-white" data-visual="icon"></i>
                    </div>
                    
                    <!-- Text Content -->
                    <div class="flex-1">
                        <h4 id="tier3-title" class="text-base font-bold text-green-800">
                            3-Tier Intelligence System Enabled
                        </h4>
                        <p id="tier3-description" class="text-sm text-green-700 mt-1">
                            Tier 1 (Rules) ‚Üí Tier 2 (Semantic) ‚Üí Tier 3 (LLM Fallback)
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- END 2.1: 3-TIER SYSTEM TOGGLE -->
        
        
        <!-- ============================================================
             2.2: TIER CONFIDENCE THRESHOLDS
             ============================================================
             Side-by-side sliders for Tier 1 and Tier 2 thresholds
             Higher values = stricter matching = less fallthrough
             ============================================================ -->
        <div class="grid grid-cols-2 gap-6 mb-6" 
             data-section="tier-thresholds">
            
            <!-- 2.2.1: Tier 1 Threshold Slider -->
            <div data-component="tier1-threshold">
                <!-- Label + Current Value -->
                <div class="flex items-center justify-between mb-2">
                    <label class="text-sm font-bold text-gray-800">
                        <i class="fas fa-layer-group text-blue-600 mr-1"></i>
                        Tier 1 Threshold (Rule-Based)
                    </label>
                    <span class="text-lg font-mono font-bold text-blue-700" 
                          id="company-tier1-value"
                          data-value-display="tier1-threshold">0.80</span>
                </div>
                
                <!-- Range Slider -->
                <input type="range" 
                       id="company-tier1-slider" 
                       min="0.70" 
                       max="0.95" 
                       step="0.01" 
                       value="0.80"
                       oninput="updateCompanyTier1Value(this.value)"
                       class="w-full h-2 bg-gradient-to-r from-blue-300 to-blue-600 rounded-lg appearance-none cursor-pointer"
                       data-control="tier1-slider">
                
                <!-- Min/Max Labels -->
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>0.70 (More Tier 2/3)</span>
                    <span>0.95 (Stricter)</span>
                </div>
                
                <!-- Help Text -->
                <p class="text-xs text-gray-600 mt-2 bg-blue-50 p-2 rounded border border-blue-200">
                    <strong>Higher = More strict:</strong> Requires exact keyword matches. Lower = More triggers flow to Tier 2 semantic analysis.
                </p>
            </div>
            <!-- END 2.2.1: Tier 1 Threshold -->
            
            
            <!-- 2.2.2: Tier 2 Threshold Slider -->
            <div data-component="tier2-threshold">
                <!-- Label + Current Value -->
                <div class="flex items-center justify-between mb-2">
                    <label class="text-sm font-bold text-gray-800">
                        <i class="fas fa-brain text-purple-600 mr-1"></i>
                        Tier 2 Threshold (Semantic)
                    </label>
                    <span class="text-lg font-mono font-bold text-purple-700" 
                          id="company-tier2-value"
                          data-value-display="tier2-threshold">0.60</span>
                </div>
                
                <!-- Range Slider -->
                <input type="range" 
                       id="company-tier2-slider" 
                       min="0.50" 
                       max="0.80" 
                       step="0.01" 
                       value="0.60"
                       oninput="updateCompanyTier2Value(this.value)"
                       class="w-full h-2 bg-gradient-to-r from-purple-300 to-purple-600 rounded-lg appearance-none cursor-pointer"
                       data-control="tier2-slider">
                
                <!-- Min/Max Labels -->
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>0.50 (More Tier 3)</span>
                    <span>0.80 (Stricter)</span>
                </div>
                
                <!-- Help Text -->
                <p class="text-xs text-gray-600 mt-2 bg-purple-50 p-2 rounded border border-purple-200">
                    <strong>Higher = More strict:</strong> Requires higher semantic similarity. Lower = More queries flow to Tier 3 LLM.
                </p>
            </div>
            <!-- END 2.2.2: Tier 2 Threshold -->
            
        </div>
        <!-- END 2.2: TIER CONFIDENCE THRESHOLDS -->
        
        
        <!-- ============================================================
             2.3: LLM MODEL SELECTOR
             ============================================================
             Dropdown for selecting Tier 3 LLM model
             Includes beta warning and testing models toggle
             ============================================================ -->
        <div class="mb-6" data-section="llm-model-selector">
            
            <!-- Label -->
            <label class="block text-sm font-bold text-gray-800 mb-2">
                <i class="fas fa-microchip text-green-600 mr-1"></i>
                Tier 3 LLM Model
            </label>
            
            <!-- Model Dropdown -->
            <select id="company-llm-model" 
                    onchange="checkBetaModelWarning()"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm font-semibold bg-white"
                    data-control="llm-model-select">
                
                <!-- Stable Models Group -->
                <optgroup label="‚úÖ Stable Models (Production-Ready)">
                    <option value="gpt-4o">üöÄ GPT-4o (Best Quality - ~$0.10/call)</option>
                    <option value="gpt-4o-mini" selected>‚öñÔ∏è GPT-4o-mini (Balanced - ~$0.04/call)</option>
                    <option value="gpt-3.5-turbo">‚ö° GPT-3.5-turbo (Fast & Cheap - ~$0.01/call)</option>
                </optgroup>
                
                <!-- Beta Models Group (Hidden by default) -->
                <optgroup label="üß™ Testing/Beta Models (Admin Testing Only)" 
                          id="beta-models-group" 
                          style="display: none;"
                          data-group="beta-models">
                    <!-- Add new models here for testing before production rollout -->
                    <!-- <option value="gpt-4.5-preview">üß™ GPT-4.5 Preview (BETA - Test Only)</option> -->
                </optgroup>
            </select>
            
            <!-- Help Text -->
            <p class="text-xs text-gray-600 mt-2">
                Model used when Tier 1 & 2 fail to match (edge cases only)
            </p>
            
            <!-- Beta Model Warning (Hidden until beta model selected) -->
            <div id="beta-model-warning" 
                 class="hidden mt-3 p-3 bg-amber-50 border-l-4 border-amber-500 rounded"
                 data-warning="beta-model">
                <div class="flex items-start gap-2">
                    <i class="fas fa-exclamation-triangle text-amber-600 mt-0.5"></i>
                    <div>
                        <p class="text-sm font-bold text-amber-900">‚ö†Ô∏è Beta Model Selected</p>
                        <p class="text-xs text-amber-800 mt-1">
                            This model is in testing phase. Only use for pilot companies. 
                            Not recommended for production use until fully validated.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Show Beta Models Toggle -->
            <div class="mt-3">
                <label class="flex items-center gap-2 cursor-pointer text-xs text-gray-600 hover:text-gray-800">
                    <input type="checkbox" 
                           id="show-beta-models" 
                           onchange="toggleBetaModels()" 
                           class="w-4 h-4 text-amber-600 rounded"
                           data-control="show-beta-toggle">
                    <span>üß™ Show testing/beta models (admin testing only)</span>
                </label>
            </div>
        </div>
        <!-- END 2.3: LLM MODEL SELECTOR -->
        
        
        <!-- ============================================================
             2.4: COST LIMITS
             ============================================================
             Two-column grid: Max cost per call + Daily budget
             Prevents runaway LLM costs
             ============================================================ -->
        <div class="grid grid-cols-2 gap-4 mb-6" 
             data-section="cost-limits">
            
            <!-- 2.4.1: Max Cost Per Call -->
            <div data-component="max-cost-per-call">
                <label class="block text-sm font-bold text-gray-800 mb-2">
                    <i class="fas fa-dollar-sign text-amber-600 mr-1"></i>
                    Max Cost Per Call
                </label>
                <div class="flex items-center gap-2">
                    <span class="text-gray-700 font-semibold">$</span>
                    <input type="number" 
                           id="company-max-cost-per-call" 
                           min="0.01" 
                           max="1.00" 
                           step="0.01" 
                           value="0.10"
                           class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 text-sm font-mono"
                           data-control="max-cost-input">
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    Prevents single call from costing too much
                </p>
            </div>
            <!-- END 2.4.1 -->
            
            
            <!-- 2.4.2: Daily LLM Budget -->
            <div data-component="daily-budget">
                <label class="block text-sm font-bold text-gray-800 mb-2">
                    <i class="fas fa-calendar-day text-red-600 mr-1"></i>
                    Daily LLM Budget
                </label>
                <div class="flex items-center gap-2">
                    <span class="text-gray-700 font-semibold">$</span>
                    <input type="number" 
                           id="company-daily-budget" 
                           placeholder="No limit"
                           min="0" 
                           step="1"
                           class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-sm font-mono"
                           data-control="daily-budget-input">
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    Auto-pause Tier 3 if exceeded (optional)
                </p>
            </div>
            <!-- END 2.4.2 -->
            
        </div>
        <!-- END 2.4: COST LIMITS -->
        
        
        <!-- ============================================================
             2.5: LIVE COST PREVIEW
             ============================================================
             Real-time cost estimation based on current settings
             Shows tier distribution percentages and monthly estimate
             ============================================================ -->
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border-2 border-green-300" 
             data-section="cost-preview">
            
            <!-- Header: Title + Monthly Cost -->
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-bold text-gray-800">
                    <i class="fas fa-chart-line text-green-600 mr-1"></i>
                    Estimated Monthly Cost
                </span>
                <span class="text-2xl font-bold text-green-700" 
                      id="company-monthly-cost-estimate"
                      data-value-display="monthly-cost">$0.00</span>
            </div>
            
            <!-- Tier Distribution (3-column grid) -->
            <div class="grid grid-cols-3 gap-2 text-xs">
                <!-- Tier 1 -->
                <div class="bg-white p-2 rounded border border-green-200 text-center">
                    <div class="text-blue-600 font-mono font-bold" 
                         id="company-tier1-percent"
                         data-value-display="tier1-percent">90%</div>
                    <div class="text-gray-600">Tier 1 (Free)</div>
                </div>
                
                <!-- Tier 2 -->
                <div class="bg-white p-2 rounded border border-green-200 text-center">
                    <div class="text-purple-600 font-mono font-bold" 
                         id="company-tier2-percent"
                         data-value-display="tier2-percent">8%</div>
                    <div class="text-gray-600">Tier 2 (Free)</div>
                </div>
                
                <!-- Tier 3 -->
                <div class="bg-white p-2 rounded border border-green-200 text-center">
                    <div class="text-red-600 font-mono font-bold" 
                         id="company-tier3-percent"
                         data-value-display="tier3-percent">2%</div>
                    <div class="text-gray-600">Tier 3 (Paid)</div>
                </div>
            </div>
            
            <!-- Footer Note -->
            <p class="text-xs text-gray-600 mt-2">
                Based on 1,000 calls/month. Lower thresholds = more Tier 3 triggers = higher costs.
            </p>
        </div>
        <!-- END 2.5: LIVE COST PREVIEW -->
        
        
        <!-- ============================================================
             2.6: SMART WARMUP (Premium Feature)
             ============================================================
             Optional LLM pre-warming during Tier 2 to eliminate delay
             Collapsible section with toggle, settings, and analytics
             ============================================================ -->
        <div class="mt-8 pt-6 border-t-2 border-amber-200" 
             data-section="smart-warmup">
            
            <!-- 2.6.1: Section Header -->
            <div class="mb-4" data-component="warmup-header">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-fire text-orange-600 text-lg"></i>
                    <h5 class="text-md font-bold text-gray-900">Smart LLM Pre-warming (Premium)</h5>
                    <span class="px-2 py-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs font-bold rounded-full">OPTIONAL</span>
                </div>
                <p class="text-xs text-gray-600 leading-relaxed">
                    Eliminate perceived delay by pre-warming LLM during Tier 2. Only charges if Tier 2 fails. 
                    <strong>Intelligent prediction</strong> reduces wasted calls by 70%+.
                </p>
            </div>
            <!-- END 2.6.1 -->
            
            
            <!-- 2.6.2: Warmup Toggle + Settings Expander -->
            <div class="mb-4 p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg border-2 border-orange-300" 
                 data-component="warmup-control">
                
                <!-- Hidden Checkbox (stores state) -->
                <input type="checkbox" 
                       id="company-enable-warmup" 
                       class="hidden"
                       data-state="warmup-enabled">
                
                <!-- Interactive Toggle Card -->
                <div id="warmup-toggle-card" 
                     onclick="toggleWarmupCard()" 
                     class="relative cursor-pointer rounded-lg p-4 border-2 transition-all duration-200 mb-3"
                     style="background: #f3f4f6; border-color: #d1d5db;"
                     data-interactive="true"
                     data-component="warmup-toggle">
                    
                    <!-- Status Indicator Dot -->
                    <div id="warmup-status-dot" 
                         class="absolute top-3 right-3 w-3 h-3 rounded-full"
                         style="background: #9ca3af;"
                         data-visual="status-indicator"></div>
                    
                    <!-- Card Content -->
                    <div class="flex items-start gap-3">
                        <!-- Icon Container -->
                        <div id="warmup-icon-container" 
                             class="w-10 h-10 rounded-full flex items-center justify-center"
                             style="background: #e5e7eb;"
                             data-visual="icon-container">
                            <i id="warmup-icon" class="fas fa-times text-gray-600" data-visual="icon"></i>
                        </div>
                        
                        <!-- Text Content -->
                        <div class="flex-1">
                            <h4 id="warmup-title" class="text-base font-bold text-gray-700">
                                Smart Warmup Disabled
                            </h4>
                            <p id="warmup-description" class="text-sm text-gray-600 mt-1">
                                Click to enable LLM pre-warming
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Expand/Collapse Button -->
                <button onclick="toggleWarmupSettingsVisibility()" 
                        class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white hover:bg-gray-100 border-2 border-gray-300 rounded-lg transition-colors"
                        data-action="toggle-warmup-settings">
                    <i id="warmup-expand-icon" class="fas fa-chevron-down text-gray-600"></i>
                    <span class="text-xs font-semibold text-gray-700">Settings</span>
                </button>
                
                <!-- Status Banner (Shows when enabled) -->
                <div id="warmup-status-banner" 
                     class="hidden mt-3 pt-3 border-t-2 border-green-300"
                     data-conditional="warmup-enabled">
                    <div class="flex items-center gap-2 bg-green-100 px-4 py-2 rounded-lg border-2 border-green-500">
                        <i class="fas fa-check-circle text-green-600 text-lg"></i>
                        <span class="text-sm font-bold text-green-700">
                            üî• LLM TIER 2 WARM UP ENABLED
                        </span>
                    </div>
                    <p class="text-xs text-green-700 mt-2 font-semibold">
                        ‚úÖ Smart warmup is ACTIVE. LLM will pre-warm during Tier 2 to eliminate delay.
                    </p>
                </div>
            </div>
            <!-- END 2.6.2 -->
            
            
            <!-- 2.6.3: Warmup Settings (Collapsible) -->
            <div id="warmup-settings-container" 
                 class="hidden space-y-4"
                 data-section="warmup-settings"
                 data-collapsible="true">
                
                <!-- 2.6.3.1: Confidence Threshold Slider -->
                <div data-component="warmup-threshold">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm font-bold text-gray-800">
                            <i class="fas fa-gauge-high text-purple-600 mr-1"></i>
                            Warmup Trigger Threshold
                        </label>
                        <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-mono font-bold">
                            <span id="company-warmup-threshold-value" data-value-display="warmup-threshold">0.75</span>
                        </span>
                    </div>
                    <input type="range" 
                           id="company-warmup-threshold-slider" 
                           min="0.50" 
                           max="0.85" 
                           step="0.05" 
                           value="0.75"
                           oninput="updateCompanyWarmupThresholdValue(this.value)"
                           class="w-full h-2 bg-gradient-to-r from-green-300 via-yellow-300 to-red-300 rounded-lg appearance-none cursor-pointer"
                           data-control="warmup-threshold-slider">
                    <div class="flex justify-between text-xs text-gray-600 mt-1">
                        <span>0.50 (Aggressive)</span>
                        <span>0.85 (Conservative)</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        Only pre-warm if Tier 2 confidence is <strong>below</strong> this threshold. 
                        Higher = more selective = less cost, but less benefit.
                    </p>
                </div>
                <!-- END 2.6.3.1 -->
                
                
                <!-- 2.6.3.2: Daily Budget -->
                <div data-component="warmup-budget">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-piggy-bank text-green-600 mr-1"></i>
                        Daily Warmup Budget
                    </label>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-700 font-semibold">$</span>
                        <input type="number" 
                               id="company-warmup-daily-budget" 
                               min="1.00" 
                               max="50.00" 
                               step="1.00" 
                               value="5.00"
                               class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm font-mono"
                               data-control="warmup-budget-input">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        Maximum spend per day on warmup calls. Auto-pauses when reached.
                    </p>
                </div>
                <!-- END 2.6.3.2 -->
                
                
                <!-- 2.6.3.3: Category Overrides -->
                <div class="grid grid-cols-2 gap-4" data-component="warmup-categories">
                    
                    <!-- Always Warmup -->
                    <div>
                        <label class="block text-sm font-bold text-gray-800 mb-2">
                            <i class="fas fa-circle-check text-green-600 mr-1"></i>
                            Always Warmup
                        </label>
                        <input type="text" 
                               id="company-warmup-always-categories" 
                               placeholder="pricing, emergency, vip"
                               class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-xs"
                               data-control="always-warmup-input">
                        <p class="text-xs text-gray-500 mt-1">
                            Categories to always pre-warm (comma-separated)
                        </p>
                    </div>
                    
                    <!-- Never Warmup -->
                    <div>
                        <label class="block text-sm font-bold text-gray-800 mb-2">
                            <i class="fas fa-circle-xmark text-red-600 mr-1"></i>
                            Never Warmup
                        </label>
                        <input type="text" 
                               id="company-warmup-never-categories" 
                               placeholder="greeting, goodbye"
                               class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-xs"
                               data-control="never-warmup-input">
                        <p class="text-xs text-gray-500 mt-1">
                            Categories to never pre-warm (comma-separated)
                        </p>
                    </div>
                </div>
                <!-- END 2.6.3.3 -->
                
                
                <!-- 2.6.3.4: Pattern Learning Toggle -->
                <div data-component="warmup-pattern-learning">
                    <label class="flex items-center gap-2 cursor-pointer text-sm text-gray-700 hover:text-gray-900">
                        <input type="checkbox" 
                               id="company-warmup-pattern-learning" 
                               checked
                               class="w-4 h-4 text-purple-600 rounded"
                               data-control="pattern-learning-toggle">
                        <span>
                            <i class="fas fa-brain text-purple-600 mr-1"></i>
                            Enable Pattern Learning (track which queries benefit most)
                        </span>
                    </label>
                </div>
                <!-- END 2.6.3.4 -->
                
                
                <!-- 2.6.3.5: Minimum Hit Rate -->
                <div data-component="warmup-min-hit-rate">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-target text-red-600 mr-1"></i>
                        Minimum Hit Rate (Auto-Disable)
                    </label>
                    <div class="flex items-center gap-2">
                        <input type="number" 
                               id="company-warmup-min-hit-rate" 
                               min="0.20" 
                               max="0.80" 
                               step="0.05" 
                               value="0.30"
                               class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-sm font-mono"
                               data-control="min-hit-rate-input">
                        <span class="text-gray-700 font-semibold text-sm">%</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        Auto-disable warmup if hit rate drops below this. Hit rate = warmup used / warmup triggered.
                    </p>
                </div>
                <!-- END 2.6.3.5 -->
                
                
                <!-- 2.6.3.6: Warmup Analytics Preview -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border-2 border-blue-300" 
                     data-component="warmup-analytics">
                    
                    <!-- Header -->
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-chart-bar text-blue-600"></i>
                        <span class="text-sm font-bold text-gray-900">Warmup Analytics (Last 7 Days)</span>
                    </div>
                    
                    <!-- Metrics Grid -->
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        <!-- Hit Rate -->
                        <div class="bg-white p-2 rounded border border-blue-200 text-center">
                            <div class="text-blue-600 font-mono font-bold" 
                                 id="company-warmup-hit-rate"
                                 data-value-display="warmup-hit-rate">N/A</div>
                            <div class="text-gray-600">Hit Rate</div>
                        </div>
                        
                        <!-- Total Cost -->
                        <div class="bg-white p-2 rounded border border-blue-200 text-center">
                            <div class="text-green-600 font-mono font-bold" 
                                 id="company-warmup-cost"
                                 data-value-display="warmup-cost">$0.00</div>
                            <div class="text-gray-600">Total Cost</div>
                        </div>
                        
                        <!-- Time Saved -->
                        <div class="bg-white p-2 rounded border border-blue-200 text-center">
                            <div class="text-purple-600 font-mono font-bold" 
                                 id="company-warmup-time-saved"
                                 data-value-display="warmup-time-saved">0ms</div>
                            <div class="text-gray-600">Avg Time Saved</div>
                        </div>
                    </div>
                    
                    <!-- Footer Note -->
                    <p class="text-xs text-gray-600 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        Analytics load after saving settings. Refresh to see latest data.
                    </p>
                </div>
                <!-- END 2.6.3.6 -->
                
            </div>
            <!-- END 2.6.3: Warmup Settings -->
            
        </div>
        <!-- END 2.6: SMART WARMUP -->
        
    </div>
    <!-- END SECTION 2: INTELLIGENCE SETTINGS CONTAINER -->
    
    
    <!-- ============================================================
         SECTION 3: SAVE BUTTON
         ============================================================
         Persists all settings to database
         Triggers: saveCompanyProductionIntelligence()
         ============================================================ -->
    <div class="mt-6 pt-4 border-t border-gray-200" 
         data-section="save-button">
        <button onclick="saveCompanyProductionIntelligence()" 
                class="w-full px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg font-bold shadow-lg hover:shadow-xl transition-all text-lg"
                data-action="save-settings">
            <i class="fas fa-save mr-2"></i>
            Save Production Intelligence Settings
        </button>
    </div>
    <!-- END SECTION 3: SAVE BUTTON -->
    
    
    <!-- ============================================================
         SECTION 4: WARNING NOTE
         ============================================================
         Reminds admin these settings affect real customers
         ============================================================ -->
    <div class="mt-4 bg-amber-50 px-4 py-3 rounded-lg border border-amber-300" 
         data-section="warning-note">
        <p class="text-xs text-amber-900 leading-relaxed">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            <strong>Production Settings:</strong> These settings affect REAL customer calls. Be conservative unless testing. Lower thresholds = more LLM calls = higher costs.
        </p>
    </div>
    <!-- END SECTION 4: WARNING NOTE -->
    
</div>
<!-- END: COMPANY PRODUCTION INTELLIGENCE SETTINGS -->


<!-- ================================================================
     üåç GLOBAL PLATFORM INTELLIGENCE SETTINGS
     ================================================================
     
     FILE LOCATION: public/admin-global-instant-responses.html
     PURPOSE: Configure the 3-tier intelligence system for ALL companies in global mode
     
     PROTECTION: 4-LAYER SECURITY SYSTEM
     - Layer 1: View-Only Mode (default, locked with üîí icon)
     - Layer 2: Unlock Confirmation (typed "UNLOCK GLOBAL EDIT")
     - Layer 3: Edit Mode Visual Warnings (red banner, 10min timeout)
     - Layer 4: Save Confirmation (typed "SAVE GLOBAL CHANGES")
     
     ARCHITECTURE:
     - Main Container: Blue gradient border (global theme)
     - Companies Affected Counter: Shows # of companies in global mode
     - Settings: Identical to Company Intelligence (same structure)
     - Lock/Unlock Button: Controls edit mode with confirmation
     
     ================================================================ -->
<div id="global-intelligence-container"
     class="bg-white rounded-xl border-2 border-blue-400 p-6 shadow-lg mb-8" 
     data-section="global-production-intelligence"
     data-debug-id="global-container">
    
    <!-- SECTION 1: HEADER -->
    <div class="flex items-center justify-between mb-6" 
         data-section="header">
        
        <!-- Header Left: Icon + Title -->
        <div class="flex items-center gap-3">
            <!-- Globe Icon (Blue Gradient) -->
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-lg flex items-center justify-center shadow-md">
                <i class="fas fa-globe text-white text-xl"></i>
            </div>
            
            <!-- Title + Subtitle -->
            <div>
                <h4 class="text-lg font-bold text-gray-900">üåç Global Platform Intelligence</h4>
                <p class="text-sm text-gray-600">Default settings for <span id="global-companies-affected-count" class="font-mono font-bold text-blue-700">0</span> companies</p>
            </div>
        </div>
        
        <!-- Header Right: Reload + Lock/Unlock Buttons -->
        <div class="flex items-center gap-2">
            <button onclick="loadGlobalProductionIntelligence()" 
                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition-all text-sm"
                    data-action="reload-global-settings">
                <i class="fas fa-sync-alt mr-1"></i>
                Reload
            </button>
            
            <button id="global-lock-unlock-btn" 
                    onclick="toggleGlobalEditMode()" 
                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition-all text-sm border-2 border-gray-300"
                    data-action="toggle-edit-mode">
                <i id="global-lock-icon" class="fas fa-lock mr-1"></i>
                <span id="global-lock-text">Unlock to Edit</span>
            </button>
        </div>
    </div>
    <!-- END SECTION 1: HEADER -->
    
    
    <!-- SECTION 1.5: EDIT MODE WARNING BANNER (Hidden by default, shows when unlocked) -->
    <div id="global-edit-warning-banner" 
         class="hidden mb-6 p-4 bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-500 rounded-lg"
         data-section="edit-warning">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                <div>
                    <p class="text-sm font-bold text-red-900">
                        ‚ö†Ô∏è GLOBAL EDIT MODE ACTIVE
                    </p>
                    <p class="text-xs text-red-700 mt-1">
                        Changes will affect <span id="global-warning-company-count" class="font-mono font-bold">0</span> companies. Auto-locks in <span id="global-edit-timeout" class="font-mono">10:00</span> minutes.
                    </p>
                </div>
            </div>
            <button onclick="lockGlobalEditMode()" 
                    class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold text-xs transition-all">
                <i class="fas fa-lock mr-1"></i>
                Lock Now
            </button>
        </div>
    </div>
    <!-- END SECTION 1.5: EDIT WARNING BANNER -->
    
    
    <!-- SECTION 2: INTELLIGENCE SETTINGS CONTAINER (Initially Disabled) -->
    <div id="global-intelligence-settings" 
         data-section="settings-container"
         class="opacity-60 pointer-events-none">
        
        <!-- 2.1: 3-TIER SYSTEM TOGGLE -->
        <div class="mb-6" data-section="tier3-toggle-wrapper">
            <input type="checkbox" 
                   id="global-enable-tier3" 
                   checked 
                   class="hidden"
                   data-state="tier3-enabled">
            
            <div id="global-tier3-toggle-card" 
                 onclick="toggleGlobalTier3Card()" 
                 class="relative cursor-pointer rounded-lg p-4 border-2 transition-all duration-200"
                 style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-color: #10b981;"
                 data-component="tier3-toggle-card">
                
                <div id="global-tier3-status-dot" 
                     class="absolute top-3 right-3 w-3 h-3 rounded-full"
                     style="background: #10b981;"></div>
                
                <div class="flex items-start gap-3">
                    <div id="global-tier3-icon-container" 
                         class="w-10 h-10 rounded-full flex items-center justify-center"
                         style="background: #10b981;">
                        <i id="global-tier3-icon" class="fas fa-check text-white"></i>
                    </div>
                    
                    <div class="flex-1">
                        <h4 id="global-tier3-title" class="text-base font-bold text-green-800">
                            3-Tier Intelligence System Enabled
                        </h4>
                        <p id="global-tier3-description" class="text-sm text-green-700 mt-1">
                            Tier 1 (Rules) ‚Üí Tier 2 (Semantic) ‚Üí Tier 3 (LLM Fallback)
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- END 2.1 -->
        
        
        <!-- 2.2: TIER CONFIDENCE THRESHOLDS -->
        <div class="grid grid-cols-2 gap-6 mb-6" data-section="tier-thresholds">
            
            <!-- Tier 1 Threshold -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <label class="text-sm font-bold text-gray-800">
                        <i class="fas fa-layer-group text-blue-600 mr-1"></i>
                        Tier 1 Threshold (Rule-Based)
                    </label>
                    <span class="text-lg font-mono font-bold text-blue-700" 
                          id="global-tier1-value">0.80</span>
                </div>
                
                <input type="range" 
                       id="global-tier1-slider" 
                       min="0.70" 
                       max="0.95" 
                       step="0.01" 
                       value="0.80"
                       oninput="updateGlobalTier1Value(this.value)"
                       class="w-full h-2 bg-gradient-to-r from-blue-300 to-blue-600 rounded-lg appearance-none cursor-pointer">
                
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>0.70 (More Tier 2/3)</span>
                    <span>0.95 (Stricter)</span>
                </div>
            </div>
            
            <!-- Tier 2 Threshold -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <label class="text-sm font-bold text-gray-800">
                        <i class="fas fa-brain text-purple-600 mr-1"></i>
                        Tier 2 Threshold (Semantic)
                    </label>
                    <span class="text-lg font-mono font-bold text-purple-700" 
                          id="global-tier2-value">0.60</span>
                </div>
                
                <input type="range" 
                       id="global-tier2-slider" 
                       min="0.50" 
                       max="0.80" 
                       step="0.01" 
                       value="0.60"
                       oninput="updateGlobalTier2Value(this.value)"
                       class="w-full h-2 bg-gradient-to-r from-purple-300 to-purple-600 rounded-lg appearance-none cursor-pointer">
                
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>0.50 (More Tier 3)</span>
                    <span>0.80 (Stricter)</span>
                </div>
            </div>
            
        </div>
        <!-- END 2.2 -->
        
        
        <!-- 2.3: LLM MODEL SELECTOR -->
        <div class="mb-6">
            <label class="block text-sm font-bold text-gray-800 mb-2">
                <i class="fas fa-microchip text-green-600 mr-1"></i>
                Tier 3 LLM Model
            </label>
            
            <select id="global-llm-model" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm font-semibold bg-white">
                <optgroup label="‚úÖ Stable Models (Production-Ready)">
                    <option value="gpt-4o">üöÄ GPT-4o (Best Quality - ~$0.10/call)</option>
                    <option value="gpt-4o-mini" selected>‚öñÔ∏è GPT-4o-mini (Balanced - ~$0.04/call)</option>
                    <option value="gpt-3.5-turbo">‚ö° GPT-3.5-turbo (Fast & Cheap - ~$0.01/call)</option>
                </optgroup>
            </select>
        </div>
        <!-- END 2.3 -->
        
        
        <!-- 2.4: COST LIMITS -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            
            <!-- Max Cost Per Call -->
            <div>
                <label class="block text-sm font-bold text-gray-800 mb-2">
                    <i class="fas fa-dollar-sign text-amber-600 mr-1"></i>
                    Max Cost Per Call
                </label>
                <div class="flex items-center gap-2">
                    <span class="text-gray-700 font-semibold">$</span>
                    <input type="number" 
                           id="global-max-cost-per-call" 
                           min="0.01" 
                           max="1.00" 
                           step="0.01" 
                           value="0.10"
                           class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 text-sm font-mono">
                </div>
            </div>
            
            <!-- Daily LLM Budget -->
            <div>
                <label class="block text-sm font-bold text-gray-800 mb-2">
                    <i class="fas fa-calendar-day text-red-600 mr-1"></i>
                    Daily LLM Budget
                </label>
                <div class="flex items-center gap-2">
                    <span class="text-gray-700 font-semibold">$</span>
                    <input type="number" 
                           id="global-daily-budget" 
                           placeholder="No limit"
                           min="0" 
                           step="1"
                           class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-sm font-mono">
                </div>
            </div>
            
        </div>
        <!-- END 2.4 -->
        
        
        <!-- 2.5: LIVE COST PREVIEW -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border-2 border-blue-300 mb-6">
            
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-bold text-gray-800">
                    <i class="fas fa-chart-line text-blue-600 mr-1"></i>
                    Estimated Monthly Cost (per company)
                </span>
                <span class="text-2xl font-bold text-blue-700" 
                      id="global-monthly-cost-estimate">$0.00</span>
            </div>
            
            <div class="grid grid-cols-3 gap-2 text-xs">
                <div class="bg-white p-2 rounded border border-blue-200 text-center">
                    <div class="text-blue-600 font-mono font-bold" 
                         id="global-tier1-percent">90%</div>
                    <div class="text-gray-600">Tier 1 (Free)</div>
                </div>
                
                <div class="bg-white p-2 rounded border border-blue-200 text-center">
                    <div class="text-purple-600 font-mono font-bold" 
                         id="global-tier2-percent">8%</div>
                    <div class="text-gray-600">Tier 2 (Free)</div>
                </div>
                
                <div class="bg-white p-2 rounded border border-blue-200 text-center">
                    <div class="text-red-600 font-mono font-bold" 
                         id="global-tier3-percent">2%</div>
                    <div class="text-gray-600">Tier 3 (Paid)</div>
                </div>
            </div>
        </div>
        <!-- END 2.5 -->
        
    </div>
    <!-- END SECTION 2: SETTINGS CONTAINER -->
    
    
    <!-- SECTION 3: SAVE BUTTON (Disabled by default) -->
    <div class="mt-6 pt-4 border-t border-gray-200">
        <button id="global-save-btn" 
                onclick="showGlobalSaveConfirmationModal()" 
                disabled
                class="w-full px-6 py-3 bg-gray-300 text-gray-500 rounded-lg font-bold shadow-lg cursor-not-allowed text-lg"
                data-action="save-global-settings">
            <i class="fas fa-lock mr-2"></i>
            Unlock to Save Changes
        </button>
    </div>
    <!-- END SECTION 3: SAVE BUTTON -->
    
    
    <!-- SECTION 4: CRITICAL WARNING NOTE -->
    <div class="mt-4 bg-red-50 px-4 py-3 rounded-lg border border-red-300">
        <p class="text-xs text-red-900 leading-relaxed">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            <strong>CRITICAL:</strong> These settings affect ALL companies in global mode. Changes propagate immediately. Only edit with extreme care and admin approval.
        </p>
    </div>
    <!-- END SECTION 4: WARNING NOTE -->
    
</div>
<!-- END: GLOBAL PLATFORM INTELLIGENCE SETTINGS -->

                    
                </div>
                <!-- END: Company Mode Content -->

                <!-- ========================================================================== -->
                <!-- üß™ LIVE TEST MONITOR - Real-time Results & AI Suggestions -->
                <!-- ========================================================================== -->
                <div id="live-test-monitor" class="mb-6 bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl shadow-lg border-2 border-purple-400 overflow-hidden">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-purple-600 to-blue-600 px-6 py-4 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center shadow-md">
                                <i class="fas fa-flask text-purple-600 text-lg"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                    üß™ Live Test Monitor
                                    <span id="live-test-count" class="text-sm font-semibold bg-purple-700 px-3 py-1 rounded-lg shadow">0 tests</span>
                                </h3>
                                <p class="text-xs text-white font-medium">
                                    Real-time test results and AI-powered improvement suggestions
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="clearLiveTestMonitor()" class="px-4 py-2 bg-white text-red-600 hover:bg-red-50 rounded-lg font-semibold transition-all flex items-center gap-2 shadow-md">
                                <i class="fas fa-trash"></i>
                                Clear
                            </button>
                            <button onclick="refreshLiveTestMonitor()" class="px-4 py-2 bg-white text-purple-600 hover:bg-purple-50 rounded-lg font-semibold transition-all flex items-center gap-2 shadow-md">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                            <button onclick="copyLiveTestReport()" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-semibold transition-all flex items-center gap-2 shadow-md">
                                <i class="fas fa-clipboard"></i>
                                Copy Full Report
                            </button>
                            <button onclick="openTestLogModal()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-semibold transition-all flex items-center gap-2 shadow-md">
                                <i class="fas fa-flask"></i>
                                Full Test Log
                            </button>
                            <button onclick="openQualityDashboard()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all flex items-center gap-2 shadow-md">
                                <i class="fas fa-chart-line"></i>
                                Quality Report
                            </button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div id="live-test-monitor-content" class="p-6">
                        <!-- Empty State (shown when no tests yet) -->
                        <div id="live-test-empty-state" class="text-center py-12">
                            <i class="fas fa-flask text-6xl text-purple-300 mb-4"></i>
                            <h4 class="text-xl font-bold text-gray-700 mb-2">No Test Results Yet</h4>
                            <p class="text-gray-600 mb-4">Call the test number below and your results will appear here instantly!</p>
                            <div class="inline-block bg-white px-6 py-3 rounded-lg shadow-md border-2 border-purple-300">
                                <div class="text-sm text-gray-600 mb-1">Test Phone Number:</div>
                                <div class="text-2xl font-bold text-purple-600" id="live-test-phone-display">Loading...</div>
                            </div>
                        </div>

                        <!-- Test Results Grid (shown when tests exist) -->
                        <div id="live-test-results-grid" class="hidden space-y-4">
                            <!-- Results will be inserted here by JavaScript -->
                        </div>

                        <!-- AI Suggestions Panel (shown when suggestions exist) -->
                        <div id="live-test-suggestions-panel" class="hidden mt-6 bg-yellow-50 rounded-lg border-2 border-yellow-400 p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <i class="fas fa-lightbulb text-3xl text-yellow-600"></i>
                                <div>
                                    <h4 class="text-lg font-bold text-yellow-900">üí° AI Improvement Suggestions</h4>
                                    <p class="text-sm text-yellow-700">Based on your recent test results</p>
                                </div>
                            </div>
                            <div id="live-test-suggestions-content" class="space-y-3">
                                <!-- Suggestions will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========================================================================== -->
                <!-- TEST PHRASE LIBRARY - WORLD-CLASS TESTING COMPANION -->
                <!-- ========================================================================== -->
                <div class="mb-6 bg-white rounded-xl shadow-lg border-2 border-green-500 overflow-hidden">
                    <!-- Header -->
                    <div class="bg-green-600 px-6 py-4 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center shadow-md">
                                <i class="fas fa-list-check text-green-600 text-lg"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                    üìã Test Phrase Library
                                    <span id="total-phrase-count" class="text-sm font-semibold bg-green-700 px-3 py-1 rounded-lg shadow">0 phrases</span>
                                </h3>
                                <p class="text-xs text-white font-medium">
                                    All test phrases from the current template - ready to copy & test
                                </p>
                            </div>
                        </div>
                        <button onclick="toggleTestPhraseLibrary()" id="test-phrase-toggle-btn" class="px-4 py-2 bg-white text-green-600 hover:bg-green-50 rounded-lg font-semibold transition-all flex items-center gap-2 shadow-md">
                            <i class="fas fa-chevron-down" id="test-phrase-toggle-icon"></i>
                            <span id="test-phrase-toggle-text">Expand</span>
                        </button>
                    </div>

                    <!-- Expandable Content -->
                    <div id="test-phrase-library-content" class="hidden">
                        <!-- Search Bar -->
                        <div class="px-6 pt-4 bg-gray-50">
                            <div class="relative">
                                <input type="text" id="test-phrase-search" 
                                       placeholder="üîç Search test phrases... (e.g., 'appointment', 'emergency', 'pricing')"
                                       class="w-full px-4 py-3 pl-10 border-2 border-green-400 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-600 text-sm bg-white shadow-sm"
                                       oninput="filterTestPhrases()">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-green-500"></i>
                            </div>
                        </div>

                        <!-- üéØ Active Test Template Banner (Shows which template Twilio will ACTUALLY use) -->
                        <div id="active-test-template-banner" class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-green-600 border-b-2 border-emerald-700">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="bg-white rounded-full p-2">
                                        <i class="fas fa-phone-volume text-emerald-600 text-lg"></i>
                                    </div>
                                    <div>
                                        <div class="text-xs font-semibold text-emerald-100 uppercase tracking-wide">
                                            üéØ Active Test Template (Twilio Routes Here)
                                        </div>
                                        <div id="active-test-template-display" class="text-lg font-bold text-white mt-1">
                                            Loading...
                                        </div>
                                    </div>
                                </div>
                                <button onclick="loadTestPhrases()" class="px-4 py-2 bg-white text-emerald-600 hover:bg-emerald-50 rounded-lg font-semibold transition-all flex items-center gap-2 shadow-md text-sm">
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Action Buttons Row -->
                        <div class="px-6 py-3 bg-gray-50 flex gap-2 flex-wrap border-b-2 border-gray-200">
                            <button onclick="expandAllCategories()" class="text-xs px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold transition-colors shadow-sm">
                                <i class="fas fa-expand-alt mr-1"></i>
                                Expand All
                            </button>
                            <button onclick="collapseAllCategories()" class="text-xs px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors shadow-sm">
                                <i class="fas fa-compress-alt mr-1"></i>
                                Collapse All
                            </button>
                            <button onclick="copyAllPhrases()" class="text-xs px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-colors shadow-sm">
                                <i class="fas fa-copy mr-1"></i>
                                Copy All
                            </button>
                        </div>

                        <!-- Categories with Phrases -->
                        <div id="test-phrase-categories" class="px-6 py-4 space-y-3 max-h-[600px] overflow-y-auto">
                            <!-- Will be populated dynamically -->
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading test phrases...</p>
                            </div>
                        </div>

                        <!-- Footer Stats -->
                        <div class="bg-green-600 px-6 py-3 border-t-2 border-green-700 flex items-center justify-between">
                            <div class="flex gap-6 text-xs">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-layer-group text-white"></i>
                                    <span class="font-semibold text-white"><span id="footer-category-count">0</span> Categories</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-comment-dots text-white"></i>
                                    <span class="font-semibold text-white"><span id="footer-phrase-count">0</span> Total Phrases</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-clock text-white"></i>
                                    <span class="font-medium text-green-100">Updated: <span id="footer-last-updated">Just now</span></span>
                                </div>
                            </div>
                            <button onclick="refreshTestPhrases()" class="text-xs px-4 py-2 bg-white hover:bg-green-50 text-green-600 rounded-lg font-semibold transition-colors shadow-md">
                                <i class="fas fa-sync mr-1"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Categories List -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">
                            <i class="fas fa-folder-open text-blue-600 mr-2"></i>
                            Categories
                        </h2>
                        <button onclick="openAddDirectoryModal()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
                            <i class="fas fa-plus-circle"></i>
                            Add Category
                        </button>
                    </div>
                    <div id="categories-container" class="space-y-4">
                        <!-- Categories will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- ========================================================================
                 üß† LLM LEARNING CONSOLE V1 - REMOVED (2025-11-08)
                 ========================================================================
                 V1 embedded console deleted. Use standalone V2: /admin/llm-learning-v2
                 ======================================================================== -->

            <!-- AI Gateway Sub-Tab Content -->
            <div id="overview-ai-gateway-content" class="overview-subtab-content hidden">
                
                <!-- ========================================================================
                     AI GATEWAY - LLM HEALTH MONITORING & SUGGESTION QUEUE
                     ======================================================================== -->
                
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">
                        <i class="fas fa-network-wired text-purple-600 mr-2"></i>
                        AI Gateway - LLM Health & Suggestion System
                    </h2>
                    <p class="text-gray-600">
                        Real-time health monitoring and LLM-generated suggestions to improve template performance and reduce costs.
                    </p>
                </div>

                <!-- ==================== SYSTEM HEALTH DASHBOARD ==================== -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-gray-900">
                            <i class="fas fa-heartbeat text-red-500 mr-2"></i>
                            System Health Status
                        </h3>
                        <div class="flex gap-2">
                            <button id="ai-gateway-test-openai-btn" onclick="window.aiGatewayManager && window.aiGatewayManager.testOpenAIConnection()" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700 transition-colors">
                                <i class="fas fa-vial mr-2"></i>
                                Run Health Check
                            </button>
                            <button onclick="window.aiGatewayManager && window.aiGatewayManager.loadHealthStatus()" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 transition-colors">
                                <i class="fas fa-heartbeat mr-2"></i>
                                Refresh Health Status
                            </button>
                            <button onclick="window.aiGatewayManager && window.aiGatewayManager.loadSuggestions()" class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded hover:bg-gray-700 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>
                                Refresh Suggestions
                            </button>
                        </div>
                    </div>

                    <!-- Health Cards Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        
                        <!-- LLM Connection Card -->
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-bold text-gray-700">LLM Connection</h4>
                                <span id="llm-status-indicator" class="w-3 h-3 bg-gray-400 rounded-full animate-pulse"></span>
                            </div>
                            <p id="llm-status-text" class="text-gray-600 text-sm mb-1">Checking...</p>
                            <p id="llm-response-time" class="text-gray-500 text-xs">Response time: --ms</p>
                        </div>

                        <!-- MongoDB Card -->
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-bold text-gray-700">MongoDB</h4>
                                <span id="db-status-indicator" class="w-3 h-3 bg-gray-400 rounded-full animate-pulse"></span>
                            </div>
                            <p id="db-status-text" class="text-gray-600 text-sm mb-1">Checking...</p>
                            <p id="db-query-time" class="text-gray-500 text-xs">Query time: --ms</p>
                        </div>

                        <!-- Redis Cache Card -->
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-bold text-gray-700">Redis Cache</h4>
                                <span id="redis-status-indicator" class="w-3 h-3 bg-gray-400 rounded-full animate-pulse"></span>
                            </div>
                            <p id="redis-status-text" class="text-gray-600 text-sm mb-1">Checking...</p>
                            <p id="redis-latency" class="text-gray-500 text-xs">Latency: --ms</p>
                        </div>

                        <!-- 3-Tier System Card -->
                        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-4 border border-yellow-200">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-bold text-gray-700">3-Tier System</h4>
                                <span id="tier-system-indicator" class="w-3 h-3 bg-gray-400 rounded-full"></span>
                            </div>
                            <p id="tier-system-text" class="text-gray-600 text-sm mb-1">Checking...</p>
                            <p id="tier-system-info" class="text-gray-500 text-xs">Status: Unknown</p>
                        </div>

                    </div>
                </div>

                <!-- ==================== HEALTH CHECK LOGS ==================== -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">
                            <i class="fas fa-file-medical-alt text-red-500 mr-2"></i>
                            üìä Health Check Logs
                        </h3>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">Last 10 tests</span>
                            <button onclick="window.aiGatewayManager && window.aiGatewayManager.loadHealthLogs()" class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Health Logs Table -->
                    <div id="health-logs-container" class="overflow-x-auto">
                        <!-- Loading Skeleton -->
                        <div id="health-logs-loading" class="space-y-2">
                            <div class="animate-pulse bg-gray-200 rounded h-12"></div>
                            <div class="animate-pulse bg-gray-200 rounded h-12"></div>
                            <div class="animate-pulse bg-gray-200 rounded h-12"></div>
                        </div>

                        <!-- Empty State -->
                        <div id="health-logs-empty" class="hidden text-center py-8">
                            <i class="fas fa-inbox text-gray-400 text-4xl mb-3"></i>
                            <p class="text-gray-600">No health checks run yet</p>
                            <button onclick="window.aiGatewayManager && window.aiGatewayManager.testOpenAIConnection()" class="mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                Run First Health Check
                            </button>
                        </div>

                        <!-- Logs Table (populated by JS) -->
                        <table id="health-logs-table" class="hidden min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Systems</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="health-logs-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Logs will be populated here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ==================== KNOWLEDGE BASE - AI SUGGESTIONS QUEUE ==================== -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 mb-1">
                                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                                üìö KNOWLEDGE BASE - AI Suggestions Queue
                            </h3>
                            <p class="text-sm text-gray-600">LLM-generated improvements from production call analysis</p>
                        </div>
                        <!-- Template Filter -->
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium text-gray-700">Filter by Template:</label>
                                    <option value="">All Templates</option>
                                    <!-- Templates will be loaded here -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Bar -->
                    <div id="suggestions-stats-bar" class="flex items-center gap-6 mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-center gap-2">
                            <span class="text-purple-600 font-bold text-lg">üü£</span>
                            <span class="text-sm font-medium text-gray-700"><span id="suggestions-pending-count">0</span> Pending</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-green-600 font-bold text-lg">üü¢</span>
                            <span class="text-sm font-medium text-gray-700"><span id="suggestions-applied-count">0</span> Applied</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-red-600 font-bold text-lg">üî¥</span>
                            <span class="text-sm font-medium text-gray-700"><span id="suggestions-ignored-count">0</span> Ignored</span>
                        </div>
                    </div>

                    <!-- Suggestions Container -->
                    <div id="suggestions-container" class="space-y-4">
                        <!-- Loading Skeleton (shown initially) -->
                        <div id="suggestions-loading-skeleton" class="space-y-4">
                            <div class="animate-pulse bg-gray-200 rounded-lg h-32"></div>
                            <div class="animate-pulse bg-gray-200 rounded-lg h-32"></div>
                            <div class="animate-pulse bg-gray-200 rounded-lg h-32"></div>
                        </div>

                        <!-- Empty State (shown when no suggestions) -->
                        <div id="suggestions-empty-state" class="hidden text-center py-12">
                            <i class="fas fa-inbox text-gray-400 text-5xl mb-4"></i>
                            <p class="text-gray-600 text-lg mb-2">No suggestions yet</p>
                            <p class="text-gray-500 text-sm">Production call data will appear here once LLM analyzes calls.</p>
                        </div>

                        <!-- Suggestions will be rendered here by AIGatewayManager.js -->
                    </div>

                    <!-- Load More Button -->
                    <div id="suggestions-load-more-container" class="hidden mt-6 text-center">
                        <button onclick="window.aiGatewayManager && window.aiGatewayManager.loadSuggestions()" class="px-6 py-2 bg-blue-600 text-white font-medium rounded hover:bg-blue-700 transition-colors">
                            <i class="fas fa-arrow-down mr-2"></i>
                            Load More Suggestions...
                        </button>
                    </div>
                </div>

            </div>

            <!-- Templates Sub-Tab Content -->
            <div id="overview-templates-content" class="overview-subtab-content hidden">
                
                <!-- Templates Nested Sub-Tabs -->
                <div class="bg-gray-100 border-b border-gray-300 -mx-4 px-4 sm:-mx-6 sm:px-6 lg:-mx-8 lg:px-8 mb-6">
                    <div class="flex gap-1 pt-1">
                        <button id="templates-nested-alltemplates" onclick="switchTemplatesNestedTab('alltemplates')" class="px-3 py-1.5 text-xs font-medium text-blue-700 border-b-2 border-blue-600 bg-white rounded-t">
                            <i class="fas fa-list mr-1 text-xs"></i>
                            All Templates
                        </button>
                        <button id="templates-nested-industrysetup" onclick="switchTemplatesNestedTab('industrysetup')" class="px-3 py-1.5 text-xs font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-200 border-b-2 border-transparent rounded-t">
                            <i class="fas fa-industry mr-1 text-xs"></i>
                            Industry Setup
                        </button>
                    </div>
                </div>

                <!-- All Templates Nested Content -->
                <div id="templates-alltemplates-content" class="templates-nested-content">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">
                                <i class="fas fa-copy text-blue-600 mr-2"></i>
                                Global AI Brain Templates
                            </h2>
                            <p class="text-gray-600">
                                Manage all industry-specific AI agent templates. Clone from Universal for new industries.
                            </p>
                        </div>
                        <button onclick="openCreateTemplateModal()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
                            <i class="fas fa-plus-circle"></i>
                            Create New Template
                        </button>
                    </div>

                    <!-- Templates Table -->
                    <div id="templates-table-container" class="bg-white rounded-lg border-2 border-gray-200 overflow-hidden">
                        <!-- Templates table will be loaded here -->
                    </div>

                    <!-- üîç COMPARISON VIEW - Full Page -->
                    <div id="comparison-view-container" class="hidden">
                        <!-- Comparison view will be loaded here -->
                    </div>
                </div>

                <!-- Industry Setup Nested Content -->
                <div id="templates-industrysetup-content" class="templates-nested-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">
                                <i class="fas fa-industry text-orange-600 mr-2"></i>
                                Industry Types Management
                            </h2>
                            <p class="text-gray-600">
                                Define available industries for AI Brain templates. These appear in the "Create Template" dropdown.
                            </p>
                        </div>
                        <button onclick="openAddIndustryModal()" 
                                style="background-color: #ea580c; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-plus-circle"></i>
                            Add Industry Type
                        </button>
                    </div>

                    <!-- Industry Types Table -->
                    <div id="industry-types-table-container" class="bg-white rounded-lg border-2 border-gray-200 overflow-hidden">
                        <!-- Industry types table will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Maintenance Sub-Tab Content -->
            <div id="overview-maintenance-content" class="overview-subtab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">
                        <i class="fas fa-tools text-orange-600 mr-2"></i>
                        Maintenance & Tools
                    </h2>
                    <p class="text-gray-600">
                        Advanced tools for batch operations, data migration, and legacy data management.
                    </p>
                </div>

                <div class="space-y-6">
                    <!-- Enhance Keywords Card -->
                    <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-6">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-magic text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-gray-900">Enhance Active Template with Keywords & Q&A</h4>
                                        <p class="text-sm text-gray-600">Auto-generate keywords and Q&A pairs for all scenarios</p>
                                    </div>
                                </div>
                                <div class="space-y-2 text-sm text-gray-700">
                                    <p><i class="fas fa-key text-purple-600 mr-2"></i>Extracts keywords from triggers for faster matching</p>
                                    <p><i class="fas fa-question-circle text-purple-600 mr-2"></i>Generates Q&A pairs for AI training</p>
                                    <p><i class="fas fa-chart-line text-purple-600 mr-2"></i>Adds confidence scores for better routing</p>
                                    <p class="text-purple-700 font-semibold mt-3 bg-purple-100 px-3 py-2 rounded border border-purple-300">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Use this for legacy scenarios imported without keywords
                                    </p>
                                </div>
                            </div>
                            <div class="ml-4">
                                <button onclick="enhanceActiveTemplate()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                    <i class="fas fa-magic"></i>
                                    Enhance Template
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Export/Import Card -->
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-file-export text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-gray-900">Export / Import Templates</h4>
                                        <p class="text-sm text-gray-600">Backup and restore AI brain templates</p>
                                    </div>
                                </div>
                                <div class="space-y-2 text-sm text-gray-700">
                                    <p><i class="fas fa-download text-blue-600 mr-2"></i>Export templates as JSON for backup</p>
                                    <p><i class="fas fa-upload text-blue-600 mr-2"></i>Import templates from JSON files</p>
                                    <p class="text-blue-700 font-semibold mt-3 bg-blue-100 px-3 py-2 rounded border border-blue-300">
                                        <i class="fas fa-shield-alt mr-1"></i>
                                        For backup, migration, and version control
                                    </p>
                                </div>
                            </div>
                            <div class="ml-4 flex flex-col gap-2">
                                <button onclick="exportActiveTemplate()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                    <i class="fas fa-download"></i>
                                    Export JSON
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk Upload Scenarios Card -->
                    <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-6">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-file-upload text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-gray-900">Bulk Upload Scenarios</h4>
                                        <p class="text-sm text-gray-600">Load multiple scenarios from CSV file</p>
                                    </div>
                                </div>
                                <div class="space-y-2 text-sm text-gray-700">
                                    <p><i class="fas fa-check-circle text-purple-600 mr-2"></i>Pre-validation (zero risk preview)</p>
                                    <p><i class="fas fa-check-circle text-purple-600 mr-2"></i>Atomic transactions (all or nothing)</p>
                                    <p><i class="fas fa-check-circle text-purple-600 mr-2"></i>Auto-rollback on errors</p>
                                    <p class="text-purple-700 font-semibold mt-3 bg-purple-100 px-3 py-2 rounded border border-purple-300">
                                        <i class="fas fa-rocket mr-1"></i>
                                        Enterprise-grade bulk loader for 10-100+ scenarios
                                    </p>
                                </div>
                            </div>
                            <div class="ml-4 flex flex-col gap-2">
                                <button onclick="openBulkUploadModal()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    Bulk Upload
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Paste Loader Card -->
                    <div class="bg-emerald-50 border-2 border-emerald-200 rounded-lg p-6">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-12 h-12 bg-emerald-600 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-paste text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-black">Quick Paste & Submit</h4>
                                        <p class="text-sm text-black">Copy AI output ‚Üí Paste ‚Üí Submit (No CSV files!)</p>
                                    </div>
                                </div>
                                <div class="space-y-2 text-sm text-black">
                                    <p><i class="fas fa-check-circle text-emerald-600 mr-2"></i>Copy CSV from AI partner</p>
                                    <p><i class="fas fa-check-circle text-emerald-600 mr-2"></i>Paste directly into form</p>
                                    <p><i class="fas fa-check-circle text-emerald-600 mr-2"></i>Auto-validation & load</p>
                                    <p style="color: white; font-weight: 600; margin-top: 12px; background: #10b981; padding: 8px 12px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                        <i class="fas fa-rocket mr-1"></i>
                                        No file management required - just paste and go!
                                    </p>
                                </div>
                            </div>
                            <div class="ml-4 flex flex-col gap-2">
                                <button onclick="openQuickPasteModal()" style="padding: 12px 24px; background: #10b981; color: white; border: 4px solid #000000; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; white-space: nowrap; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                    <i class="fas fa-paste"></i>
                                    Quick Paste
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- Behaviors Tab Content -->
        <div id="behaviors-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg border-2 border-gray-200 p-6">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">
                            <i class="fas fa-theater-masks text-purple-600 mr-2"></i>
                            AI Behavior Templates
                        </h2>
                        <p class="text-gray-600">
                            Pre-defined behavior instructions that guide how the AI responds in different situations. 
                            Categories inherit one of these behaviors to ensure consistent, appropriate responses.
                        </p>
                    </div>
                    <button onclick="openAddBehaviorModal()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-plus-circle"></i>
                        Add New Behavior
                    </button>
                </div>
                
                <div id="behaviors-list" class="space-y-4">
                    <!-- Behaviors will be rendered here -->
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- ACTION HOOKS TAB CONTENT -->
        <!-- ============================================ -->
        <div id="action-hooks-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg border-2 border-gray-200 p-6">
                <!-- Main Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-bolt text-yellow-500"></i>
                            Action Hooks System
                        </h2>
                        <p class="text-gray-600 mt-1">
                            Manage categories and hooks that define AI post-response actions
                        </p>
                    </div>
                </div>

                <!-- Nested Sub-Tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-4">
                        <button id="subtab-hooks" onclick="switchActionHooksSubTab('hooks')" class="px-4 py-2 font-semibold text-yellow-600 border-b-2 border-yellow-600 transition-colors">
                            <i class="fas fa-bolt mr-2"></i>
                            Hooks
                        </button>
                        <button id="subtab-directories" onclick="switchActionHooksSubTab('directories')" class="px-4 py-2 font-semibold text-gray-500 hover:text-yellow-600 border-b-2 border-transparent hover:border-yellow-300 transition-colors">
                            <i class="fas fa-folder-open mr-2"></i>
                            Directories
                        </button>
                    </nav>
                </div>

                <!-- Hooks Sub-Tab Content -->
                <div id="action-hooks-subtab-content" class="action-hooks-subtab-content">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">Action Hooks</h3>
                            <p class="text-gray-600 text-sm mt-1">Define actions the AI should take after responding</p>
                        </div>
                        <button onclick="openAddActionHookModal()" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                            <i class="fas fa-plus-circle"></i>
                            Add New Action Hook
                        </button>
                    </div>

                    <!-- Filter/Search -->
                    <div class="mb-6 flex gap-4">
                        <div class="flex-1">
                            <input type="text" id="action-hooks-search" placeholder="Search action hooks..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                        </div>
                        <select id="action-hooks-directory-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                            <option value="">All Directories</option>
                            <!-- Categories will be loaded dynamically -->
                        </select>
                    </div>
                    
                    <div id="action-hooks-list" class="space-y-4">
                        <!-- Action hooks will be rendered here -->
                    </div>
                </div>

                <!-- Categories Sub-Tab Content -->
                <div id="action-hooks-directories-subtab-content" class="action-hooks-subtab-content hidden">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">Hook Directories</h3>
                            <p class="text-gray-600 text-sm mt-1">Organize action hooks into logical groups</p>
                        </div>
                        <button onclick="openAddHookDirectoryModal()" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                            <i class="fas fa-plus-circle"></i>
                            Add New Directory
                        </button>
                    </div>

                    <!-- Filter/Search -->
                    <div class="mb-6">
                        <input type="text" id="directories-search" placeholder="Search directories..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                    </div>
                    
                    <div id="directories-list" class="space-y-4">
                        <!-- Categories will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab Content -->
        <div id="settings-tab" class="tab-content hidden">
            <div class="max-w-5xl mx-auto space-y-8">
                
                <!-- Page Header -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-8 text-white">
                    <h2 class="text-3xl font-bold mb-2 flex items-center gap-3">
                        <i class="fas fa-cog"></i>
                        Platform Settings
                    </h2>
                    <p class="text-blue-100">
                        Administrative controls for initializing and managing the Global AI Brain system
                    </p>
                </div>

                <!-- Database Seeding Section -->
                <div class="bg-white rounded-xl shadow-lg border-2 border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-4 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-seedling text-green-600"></i>
                            Database Initialization
                        </h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Seed initial data into the platform (only needed on first setup or after database wipe)
                        </p>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        
                        <!-- ‚ö†Ô∏è FORCE DELETE SPECIFIC OLD TEMPLATE -->
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-400 rounded-lg p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-wrench text-white text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-gray-900">üîß Force Delete Old Template (Quick Fix)</h4>
                                            <p class="text-sm text-gray-600">One-click removal of template ID: 68e5033ab02424067d056f0a</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 text-sm text-gray-700">
                                        <p><i class="fas fa-bolt text-yellow-600 mr-2"></i><strong>Quick fix for:</strong> HTTP 500 errors with old template schema</p>
                                        <p><i class="fas fa-magic text-yellow-600 mr-2"></i><strong>What it does:</strong> Deactivates & deletes the specific old template (no typing required)</p>
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i><strong>After deletion:</strong> Refresh page and click "Seed 8 Categories"</p>
                                        <p class="text-yellow-700 font-semibold mt-3 bg-yellow-100 px-3 py-2 rounded border border-yellow-300">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Safe for migration - targets only the problematic old template
                                        </p>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <button onclick="forceDeleteOldTemplate()" class="px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                        <i class="fas fa-bolt"></i>
                                        Force Delete Old
                                    </button>
                                    <p class="text-xs text-yellow-700 mt-2 text-center font-medium">One click - no typing</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- üå± SEED UNIVERSAL TEST TEMPLATE (Production-Ready) -->
                        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-400 rounded-lg p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-seedling text-white text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-gray-900">üå± Seed Universal Test Template</h4>
                                            <p class="text-sm text-gray-600">Load 12 test categories with 14 comprehensive scenarios</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 text-sm text-gray-700">
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i><strong>12 Categories:</strong> Appointment Booking, Emergency, Pricing, Hours, Hold, Gratitude, Complaints, Payments, Billing, General, Small Talk, Confused</p>
                                        <p><i class="fas fa-rocket text-purple-600 mr-2"></i><strong>14 Scenarios:</strong> All form fields tested (triggers, entities, hooks, variations, etc.)</p>
                                        <p><i class="fas fa-phone text-purple-600 mr-2"></i><strong>Phone Ready:</strong> Call your Twilio test number immediately after seeding</p>
                                        <p><i class="fas fa-database text-purple-600 mr-2"></i><strong>Smart Seeding:</strong> Replaces existing "Universal AI Brain" template if found</p>
                                        <p class="text-purple-700 font-semibold mt-3 bg-purple-100 px-3 py-2 rounded border border-purple-300">
                                            <i class="fas fa-star mr-1"></i>
                                            Production-ready ‚Ä¢ World-class ‚Ä¢ 100% tested ‚Ä¢ Use this to iron out bugs before 103 categories
                                        </p>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <button onclick="seedUniversalTestTemplate()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                        <i class="fas fa-seedling"></i>
                                        Seed Test Template
                                    </button>
                                    <p class="text-xs text-purple-700 mt-2 text-center font-medium">‚úÖ Works on ANY environment</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ‚ö†Ô∏è DELETE OLD TEMPLATE (Migration Tool) -->
                        <!-- Create New Industry Template -->
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-copy text-white text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-gray-900">‚ú® Create Industry-Specific Template</h4>
                                            <p class="text-sm text-gray-600">Clone Universal template for Healthcare, Home Services, Retail, etc.</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 text-sm text-gray-700">
                                        <p><i class="fas fa-clone text-blue-600 mr-2"></i>Clone from Universal (all 103 categories copied)</p>
                                        <p><i class="fas fa-edit text-blue-600 mr-2"></i>Customize scenarios for specific industries</p>
                                        <p><i class="fas fa-building text-blue-600 mr-2"></i>Companies select template at signup</p>
                                        <p class="text-blue-700 font-semibold mt-3 bg-blue-100 px-3 py-2 rounded border border-blue-300">
                                            <i class="fas fa-lightbulb mr-1"></i>
                                            Infrastructure ready - Build 103 Universal first, then clone as needed
                                        </p>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <button onclick="openCreateTemplateModal()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                        <i class="fas fa-plus-circle"></i>
                                        Create Template
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-300 rounded-lg p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-500 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-trash-alt text-white text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-gray-900">üîß Delete All Templates (Nuclear Option)</h4>
                                            <p class="text-sm text-gray-600">Remove ALL templates from database (with typed confirmation)</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 text-sm text-gray-700">
                                        <p><i class="fas fa-exclamation-triangle text-red-600 mr-2"></i><strong>Use this if:</strong> Multiple templates exist or unknown template IDs</p>
                                        <p><i class="fas fa-exclamation-triangle text-red-600 mr-2"></i><strong>What it does:</strong> Permanently deletes ALL global templates from database</p>
                                        <p><i class="fas fa-shield-alt text-blue-600 mr-2"></i><strong>Safety:</strong> Requires typing "DELETE" to confirm (prevents accidents)</p>
                                        <p><i class="fas fa-redo text-green-600 mr-2"></i><strong>After deletion:</strong> Click "Seed 8 Categories" to rebuild with new schema</p>
                                        <p class="text-red-700 font-semibold mt-3 bg-red-100 px-3 py-2 rounded border border-red-300">
                                            <i class="fas fa-skull-crossbones mr-1"></i>
                                            DANGEROUS: Only for schema migration or fixing corrupted templates
                                        </p>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <button onclick="deleteAllTemplates()" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                        <i class="fas fa-trash-alt"></i>
                                        Delete All Templates
                                    </button>
                                    <p class="text-xs text-red-600 mt-2 text-center font-medium">Must type "DELETE"</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Seed Behaviors Card -->
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 rounded-lg p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-500 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-theater-masks text-white text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-gray-900">Seed 15 AI Behavior Templates</h4>
                                            <p class="text-sm text-gray-600">Empathetic, Professional, Urgent, Friendly, etc.</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 text-sm text-gray-700">
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Creates platform-wide behavior library</p>
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Used by categories to control AI tone & pace</p>
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Safe to run - checks if behaviors already exist</p>
                                        <p class="text-orange-700 font-semibold mt-3">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Run this FIRST before creating categories
                                        </p>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <button onclick="seedBehaviors()" class="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                        <i class="fas fa-play-circle"></i>
                                        Seed Behaviors
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Seed Action Hooks Card -->
                        <div class="bg-gradient-to-r from-yellow-50 to-amber-50 border-2 border-yellow-200 rounded-lg p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-amber-500 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-bolt text-white text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-gray-900">Seed 16 Global Action Hooks</h4>
                                            <p class="text-sm text-gray-600">Escalate, Schedule, Callback, Payment, etc.</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 text-sm text-gray-700">
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Creates platform-wide action hooks library</p>
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Defines what AI should do after responding</p>
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Safe to run - checks if hooks already exist</p>
                                        <p class="text-yellow-700 font-semibold mt-3">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Run this SECOND after seeding behaviors
                                        </p>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <button onclick="seedActionHooks()" class="px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                        <i class="fas fa-play-circle"></i>
                                        Seed Action Hooks
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Seed Action Hook Directories Card -->
                        <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-folder-open text-white text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-gray-900">Seed 7 Action Hook Directories</h4>
                                            <p class="text-sm text-gray-600">Escalation, Scheduling, Communication, Payment, etc.</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 text-sm text-gray-700">
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Creates default categories for organizing hooks</p>
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Required for dynamic hook categorization</p>
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Safe to run - checks if categories already exist</p>
                                        <p class="text-purple-700 font-semibold mt-3">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Run this BEFORE seeding action hooks
                                        </p>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <button onclick="seedDirectories()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                        <i class="fas fa-play-circle"></i>
                                        Seed Directories
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Seed AI Brain Categories Card -->
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-brain text-white text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-gray-900">Seed 8 Global AI Brain Categories</h4>
                                            <p class="text-sm text-gray-600">Greeting, Scheduling, Emergency, Pricing, Hours, etc.</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 text-sm text-gray-700">
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Creates complete Global AI Brain template</p>
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Includes 8 categories with scenarios & triggers</p>
                                        <p><i class="fas fa-check-circle text-green-600 mr-2"></i>Ready to sync to company accounts</p>
                                        <p class="text-green-700 font-semibold mt-3">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Run this AFTER seeding behaviors
                                        </p>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <button onclick="seedTemplate()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                        <i class="fas fa-play-circle"></i>
                                        Seed AI Brain
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- üîá FILLER WORDS MANAGEMENT -->
                <div class="bg-white rounded-xl shadow-lg border-2 border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-gray-50 to-slate-50 px-6 py-4 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-filter text-gray-600"></i>
                            Filler Words (Noise Filter)
                        </h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Global filter applied to ALL scenarios in this template ‚Ä¢ Removes conversational fluff before matching
                        </p>
                    </div>
                    
                    <div class="p-6">
                        <!-- Info Box -->
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-info-circle text-blue-600 text-xl mt-0.5"></i>
                                <div class="flex-1 text-sm text-gray-700">
                                    <p class="font-semibold text-gray-900 mb-2">What are Filler Words?</p>
                                    <p class="mb-2">Words that add no meaning to caller intent. Examples: "um", "uh", "hi", "hey", "please", "you guys", "today"</p>
                                    <p class="text-blue-700 font-medium">
                                        <i class="fas fa-check-circle mr-1"></i>
                                        Inherited by companies when they clone this template ‚Ä¢ Complete package ready to deploy
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Search & Add Bar -->
                        <div class="flex gap-3 mb-6">
                            <div class="flex-1 relative">
                                <input 
                                    type="text" 
                                    id="filler-search" 
                                    placeholder="Search filler words..." 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pl-10"
                                    onkeyup="searchFillerWords()"
                                />
                                <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
                            </div>
                            <button 
                                onclick="showAddFillerWordModal()" 
                                class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                <i class="fas fa-plus"></i>
                                Add Word
                            </button>
                        </div>
                        
                        <!-- Stats Bar -->
                        <div class="flex items-center justify-between mb-4 px-4 py-3 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-center gap-4">
                                <div class="text-sm">
                                    <span class="font-semibold text-gray-900">Total Words:</span>
                                    <span id="filler-count" class="ml-2 text-blue-600 font-bold">0</span>
                                </div>
                                <div class="text-sm">
                                    <span class="font-semibold text-gray-900">Filtered:</span>
                                    <span id="filler-filtered-count" class="ml-2 text-gray-600 font-bold">0</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="resetFillerWordsToDefaults()" class="px-4 py-2 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded-lg text-sm font-semibold transition-all flex items-center gap-2">
                                    <i class="fas fa-undo"></i>
                                    Reset to Defaults
                                </button>
                                <button onclick="exportFillerWords()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-sm font-semibold transition-all flex items-center gap-2">
                                    <i class="fas fa-download"></i>
                                    Export
                                </button>
                            </div>
                        </div>
                        
                        <!-- Filler Words Grid -->
                        <div id="filler-words-container" class="flex flex-wrap gap-2 max-h-96 overflow-y-auto p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <div class="text-center w-full text-gray-500 py-8">
                                <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                                <p>Loading filler words...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- üî§ SYNONYM MAPPING -->
                <div class="bg-white rounded-xl shadow-lg border-2 border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 px-6 py-4 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-language text-purple-600"></i>
                            Synonym Mapping (Colloquial ‚Üí Technical)
                        </h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Translate customer slang into technical terms ‚Ä¢ "thingy" ‚Üí "thermostat" ‚Ä¢ "not working" ‚Üí "broken"
                        </p>
                    </div>
                    
                    <div class="p-6">
                        <!-- Info Box -->
                        <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-6">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-lightbulb text-purple-600 text-xl mt-0.5"></i>
                                <div class="flex-1 text-sm text-gray-700">
                                    <p class="font-semibold text-gray-900 mb-2">What are Synonyms?</p>
                                    <p class="mb-2">Maps colloquial/non-technical terms to technical terms used in scenarios. Example: "thingy" ‚Üí "thermostat"</p>
                                    <p class="text-purple-700 font-medium">
                                        <i class="fas fa-check-circle mr-1"></i>
                                        Dramatically improves match rates for non-technical customers
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add Synonym Bar -->
                        <div class="flex gap-3 mb-6">
                            <div class="flex-1 relative">
                                <input 
                                    type="text" 
                                    id="synonym-technical-term" 
                                    placeholder="Technical term (e.g., thermostat, air conditioner)..." 
                                    class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                />
                            </div>
                            <div class="flex items-center px-4 text-2xl text-gray-400">‚Üí</div>
                            <div class="flex-1 relative">
                                <input 
                                    type="text" 
                                    id="synonym-colloquial-terms" 
                                    placeholder="Colloquial terms (e.g., thingy, box on wall)..." 
                                    class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                />
                            </div>
                            <button 
                                onclick="addSynonymMapping()" 
                                class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                <i class="fas fa-plus"></i>
                                Add Mapping
                            </button>
                        </div>
                        
                        <!-- Stats Bar -->
                        <div class="flex items-center justify-between mb-4 px-4 py-3 bg-purple-50 rounded-lg border border-purple-200">
                            <div class="flex items-center gap-4">
                                <div class="text-sm">
                                    <span class="font-semibold text-gray-900">Total Mappings:</span>
                                    <span id="synonym-count" class="ml-2 text-purple-600 font-bold">0</span>
                                </div>
                                <div class="text-sm">
                                    <span class="font-semibold text-gray-900">Total Aliases:</span>
                                    <span id="synonym-alias-count" class="ml-2 text-pink-600 font-bold">0</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="importSynonyms()" class="px-4 py-2 bg-purple-100 hover:bg-purple-200 text-purple-800 rounded-lg text-sm font-semibold transition-all flex items-center gap-2">
                                    <i class="fas fa-upload"></i>
                                    Import
                                </button>
                                <button onclick="exportSynonyms()" class="px-4 py-2 bg-pink-100 hover:bg-pink-200 text-pink-800 rounded-lg text-sm font-semibold transition-all flex items-center gap-2">
                                    <i class="fas fa-download"></i>
                                    Export
                                </button>
                            </div>
                        </div>
                        
                        <!-- Synonyms List -->
                        <div id="synonyms-container" class="space-y-3 max-h-96 overflow-y-auto p-4 bg-purple-50 rounded-lg border-2 border-dashed border-purple-300">
                            <div class="text-center w-full text-gray-500 py-8">
                                <i class="fas fa-spinner fa-spin text-3xl mb-3 text-purple-400"></i>
                                <p>Loading synonym mappings...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export/Import Section -->
                <div class="bg-white rounded-xl shadow-lg border-2 border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-cyan-50 to-blue-50 px-6 py-4 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-file-export text-cyan-600"></i>
                            Export & Backup
                        </h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Download templates as JSON for backup, migration, or version control
                        </p>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        <!-- Export JSON Card -->
                        <div class="bg-gradient-to-r from-cyan-50 to-teal-50 border-2 border-cyan-200 rounded-lg p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-teal-500 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-download text-white text-xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-gray-900">üì• Export Current Template as JSON</h4>
                                            <p class="text-sm text-gray-600">Download complete template backup to your computer</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 text-sm text-gray-700">
                                        <p><i class="fas fa-check-circle text-cyan-600 mr-2"></i>Exports currently selected template from Dashboard</p>
                                        <p><i class="fas fa-check-circle text-cyan-600 mr-2"></i>Includes all categories, scenarios, triggers, and replies</p>
                                        <p><i class="fas fa-check-circle text-cyan-600 mr-2"></i>Use for: Backups, version control, migration, sharing</p>
                                        <p><i class="fas fa-check-circle text-cyan-600 mr-2"></i>Downloads to: Your computer's Downloads folder</p>
                                        <p class="text-cyan-700 font-semibold mt-3 bg-cyan-100 px-3 py-2 rounded border border-cyan-300">
                                            <i class="fas fa-lightbulb mr-1"></i>
                                            Tip: Export before making major changes for easy rollback
                                        </p>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <button onclick="exportTemplate()" class="px-6 py-3 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                                        <i class="fas fa-download"></i>
                                        Export JSON
                                    </button>
                                    <p class="text-xs text-cyan-700 mt-2 text-center font-medium">Downloads to PC</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Urgency Keywords Section -->
                <div class="bg-white rounded-xl shadow-lg border-2 border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 px-6 py-4 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-bolt text-red-600"></i>
                            Urgency Keywords
                        </h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Manage emergency detection keywords that boost urgency scenarios (e.g. "flooding", "emergency", "urgent")
                        </p>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        
                        <!-- Keywords Grid -->
                        <div id="urgency-keywords-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Keywords will be loaded here -->
                            <div class="col-span-full text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                                <p>Loading urgency keywords...</p>
                            </div>
                        </div>
                        
                        <!-- Add Keyword Button -->
                        <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                                Keywords boost emergency detection. Weight range: 0.1 (low) to 0.5 (critical)
                            </div>
                            <button onclick="showAddUrgencyKeywordModal()" class="px-6 py-3 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
                                <i class="fas fa-plus"></i>
                                Add Urgency Keyword
                            </button>
                        </div>
                        
                        <!-- Seed Default Keywords Button -->
                        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-bold text-gray-900 mb-1">üå± Seed Default Keywords</h4>
                                    <p class="text-sm text-gray-600">Load 17 default urgency keywords (emergency, flooding, leak, etc.)</p>
                                </div>
                                <button onclick="seedDefaultUrgencyKeywords()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-semibold transition-all">
                                    <i class="fas fa-seedling mr-1"></i>
                                    Seed Defaults
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Information Section -->
                <div class="bg-white rounded-xl shadow-lg border-2 border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-info-circle text-blue-600"></i>
                            System Information
                        </h3>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <p class="text-sm text-gray-600 mb-1">Platform Version</p>
                                <p class="text-2xl font-bold text-gray-900">v1.0.0</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <p class="text-sm text-gray-600 mb-1">Database</p>
                                <p class="text-2xl font-bold text-gray-900">MongoDB</p>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-lightbulb mr-2"></i>
                                <strong>Pro Tip:</strong> After seeding, go to the Overview tab to view your categories. 
                                You can then enhance them with keywords & Q&A pairs for better AI matching.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone (Future) -->
                <div class="bg-white rounded-xl shadow-lg border-2 border-red-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 px-6 py-4 border-b border-red-200">
                        <h3 class="text-xl font-bold text-red-700 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            Danger Zone
                        </h3>
                    </div>
                    
                    <div class="p-6">
                        <p class="text-gray-600 text-sm">
                            Destructive operations like database reset will be available here in future updates.
                        </p>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- ============================================ -->
    <!-- FOOTER -->
    <!-- ============================================ -->
    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-gray-500 text-sm">
            ¬© <span id="current-year"></span> ClientVia.ai All rights reserved.
        </div>
    </footer>

    <!-- ============================================ -->
    <!-- MODALS -->
    <!-- ============================================ -->
    
    <!-- Create Industry Template Modal -->
    <div id="create-template-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 my-8 flex flex-col" style="max-height: calc(100vh - 4rem);">
            <!-- Header (Fixed) -->
            <div class="px-6 py-4 flex items-center justify-between rounded-t-xl flex-shrink-0" style="background: linear-gradient(to right, #2563eb, #4f46e5);">
                <h2 class="text-2xl font-bold text-white">‚ú® Create Industry-Specific Template</h2>
                <button onclick="closeCreateTemplateModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Scrollable Content -->
            <div class="overflow-y-auto flex-1 p-6" style="min-height: 0;">
                <form id="create-template-form" onsubmit="handleCreateTemplate(event); return false;" class="space-y-5">
                    
                    <!-- Template Name -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Template Name *</label>
                        <input type="text" id="new-template-name" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., Healthcare AI Brain">
                    </div>

                    <!-- Industry Type -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Industry Type *</label>
                        <select id="new-template-type" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Loading industries...</option>
                        </select>
                    </div>

                    <!-- Industry Label -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Display Label (for UI) *</label>
                        <input type="text" id="new-template-label" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., Healthcare & Medical">
                    </div>

                    <!-- Version -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Version *</label>
                        <input type="text" id="new-template-version" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., healthcare-v1.0">
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                        <textarea id="new-template-description" rows="3" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="Describe this industry-specific template..."></textarea>
                    </div>

                    <!-- Clone From (Optional) -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-copy mr-1"></i>
                            Clone From (Optional)
                        </label>
                        <select id="clone-from-template" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">-- Start with blank template --</option>
                        </select>
                        <p class="text-xs text-gray-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>Optional:</strong> Select an existing template to copy all its categories and scenarios. Leave blank to start fresh.
                        </p>
                    </div>

                    <!-- Publish Option -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="new-template-publish" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-3 text-sm font-medium text-gray-700">
                                üì¢ Publish immediately (make available for companies to select)
                            </span>
                        </label>
                        <p class="text-xs text-gray-600 mt-2 ml-8">
                            Uncheck to keep as draft for editing before publishing
                        </p>
                    </div>

                </form>
            </div>
            
            <!-- Footer Buttons (Fixed) -->
            <div class="bg-gray-50 px-6 py-4 border-t flex justify-end gap-3 rounded-b-xl flex-shrink-0">
                <button type="button" onclick="closeCreateTemplateModal()" 
                        style="background-color: #6b7280; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <i class="fas fa-times-circle mr-2"></i>
                    Cancel
                </button>
                <button type="button" onclick="document.getElementById('create-template-form').requestSubmit()" 
                        style="background-color: #2563eb; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-copy"></i>
                    Clone & Create Template
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Industry Type Modal - Updated 2025-10-09 10:50 AM -->
    <div id="industry-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl max-w-xl w-full mx-4 my-8 flex flex-col" style="max-height: calc(100vh - 4rem);">
            <!-- Header (Fixed) -->
            <div class="bg-orange-600 px-6 py-4 flex items-center justify-between rounded-t-xl flex-shrink-0">
                <h2 class="text-2xl font-bold text-white" id="industry-modal-title">Add Industry Type</h2>
                <button onclick="closeIndustryModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Scrollable Content -->
            <div class="overflow-y-auto flex-1 p-6" style="min-height: 0;">
                <form id="industry-form" onsubmit="handleIndustrySubmit(event); return false;" class="space-y-5">
                    <input type="hidden" id="industry-edit-id">
                    
                    <!-- Industry ID -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Industry ID * (lowercase, no spaces)</label>
                        <input type="text" id="industry-id" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                               placeholder="e.g., automotive">
                        <p class="text-xs text-gray-500 mt-1">Used in code and URLs. Cannot be changed after creation.</p>
                    </div>

                    <!-- Name -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Name *</label>
                        <input type="text" id="industry-name" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                               placeholder="e.g., Automotive">
                    </div>

                    <!-- Display Label -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Display Label *</label>
                        <input type="text" id="industry-label" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                               placeholder="e.g., Automotive & Repair">
                    </div>

                    <!-- Icon -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Icon Emoji</label>
                        <input type="text" id="industry-icon" maxlength="2"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                               placeholder="üöó">
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                        <textarea id="industry-description" rows="2"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                  placeholder="Brief description of this industry type"></textarea>
                    </div>

                    <!-- Color -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Color Theme</label>
                        <select id="industry-color" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="blue">Blue</option>
                            <option value="red">Red</option>
                            <option value="orange" selected>Orange</option>
                            <option value="green">Green</option>
                            <option value="purple">Purple</option>
                            <option value="cyan">Cyan</option>
                            <option value="indigo">Indigo</option>
                            <option value="yellow">Yellow</option>
                            <option value="gray">Gray</option>
                            <option value="pink">Pink</option>
                        </select>
                    </div>

                    <!-- Active Status -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="industry-active" checked class="w-5 h-5 text-orange-600 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Active (available for use)</span>
                        </label>
                    </div>

                </form>
            </div>
            
            <!-- Footer Buttons (Fixed) -->
            <div class="bg-gray-50 px-6 py-4 border-t flex justify-end gap-3 rounded-b-xl flex-shrink-0">
                <button type="button" onclick="closeIndustryModal()" 
                        style="background-color: #6b7280; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <i class="fas fa-times-circle mr-2"></i>
                    Cancel
                </button>
                <button type="button" onclick="document.getElementById('industry-form').requestSubmit()" 
                        style="background-color: #ea580c; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <i class="fas fa-save mr-2"></i>
                    Save Industry Type
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Category Modal -->
    <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto relative">
                <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between z-10">
                <h2 class="text-2xl font-bold text-gray-900" id="category-modal-title">Add Category</h2>
                <button onclick="closeCategoryModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="category-form" class="space-y-6">
                    <input type="hidden" id="category-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Category Name</label>
                            <input type="text" id="category-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Icon (Emoji)</label>
                            <input type="text" id="category-icon" maxlength="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="üí¨">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                        <textarea id="category-description" required rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Brief description of this category's purpose"></textarea>
                        <p class="text-xs text-gray-500 mt-1">üí° Tip: Scenarios control their own behavior. No need for category-level behavior settings.</p>
                    </div>
                    
                    <div class="flex items-center justify-end gap-4 pt-6 border-t border-gray-200">
                        <button type="button" onclick="closeCategoryModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <i class="fas fa-save"></i>
                            Save Category
                        </button>
                    </div>
                </form>
            </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- ============================================ -->
    <!-- ‚ùå LEGACY/DELETED: EDIT SCENARIO MODAL - DO NOT USE -->
    <!-- ============================================ -->
    <!-- This modal is DEPRECATED and should NOT be used.
         Use 'scenario-modal' (the BIG 4-page form) instead.
         Kept here only to prevent JS errors from old references. -->

    <!-- ‚ùå LEGACY EDIT-SCENARIO-MODAL DELETED (lines 3133-3279) -->
    <!-- See commit history if restoration needed -->


    <!-- ============================================ -->
    <!-- EDIT CATEGORY MODAL -->
    <!-- ============================================ -->
    <div id="edit-category-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
            <div style="display: flex; align-items: center; justify-content: between; margin-bottom: 20px;">
                <h2 style="font-size: 28px; font-weight: 700; color: #2c3e50; margin: 0;">
                    <i class="fas fa-edit text-blue-600 mr-2"></i>
                    Edit AI Brain Category
                </h2>
                <button onclick="closeEditCategoryModal()" style="background: none; border: none; font-size: 32px; color: #95a5a6; cursor: pointer;">
                    &times;
                </button>
            </div>

            <form id="edit-category-form">
                <!-- Category Name -->
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Category Name *</label>
                    <input type="text" id="edit-category-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <!-- Description -->
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Description *</label>
                    <textarea id="edit-category-description" required rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>

                <!-- Icon -->
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Icon (Emoji)</label>
                    <input type="text" id="edit-category-icon" maxlength="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-center text-3xl">
                </div>

                <!-- Actions -->
                <div class="flex items-center justify-end gap-3 pt-6 border-t border-gray-200">
                    <button type="button" onclick="closeEditCategoryModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- ============================================ -->
    <!-- WORLD-CLASS SCENARIO MODAL (V2.0 - 4 TABS) -->
    <!-- ============================================ -->
    <div id="scenario-modal" style="display: none; position: fixed; inset: 0; background: #f5f5f5; z-index: 10001; overflow: hidden;">
        <div style="background: white; width: 100%; height: 100%; display: flex; flex-direction: column;">
            
            <!-- FIXED HEADER -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 32px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
                <div>
                    <h2 id="scenario-modal-title" style="font-size: 24px; font-weight: 700; margin: 0 0 4px 0;">
                        <i class="fas fa-robot mr-2"></i><span id="scenario-modal-action">Add</span> AI Scenario
                    </h2>
                    <p id="scenario-modal-subtitle" style="margin: 0; opacity: 0.9; font-size: 14px;">Category: <strong id="scenario-category-name">Loading...</strong></p>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <!-- ü§ñ PHASE A ‚Äì STEP 4: AI Scenario Assistant Button (V7: Feature flag for panel/modal) -->
                    <button
                      type="button"
                      id="scenario-ai-assistant-button"
                      onclick="window.useInlineScenarioArchitect ? focusScenarioArchitectPanel() : openScenarioAIAssistant()"
                      style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); color: white; padding: 8px 14px; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 6px;"
                      onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.borderColor='rgba(255,255,255,0.6)'"
                      onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.borderColor='rgba(255,255,255,0.4)'"
                      title="Use AI to draft this scenario from a description"
                    >
                      <i class="fas fa-magic"></i>Ask AI to Draft
                    </button>
                    <button onclick="closeScenarioModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- TAB NAVIGATION -->
            <div style="background: #f8f9fa; border-bottom: 2px solid #e9ecef; padding: 0 32px; display: flex; gap: 6px; flex-shrink: 0;">
                <button id="tab-basic" class="scenario-tab active" onclick="switchScenarioTab('basic')" style="padding: 10px 20px; border: none; background: white; color: #667eea; font-weight: 600; font-size: 14px; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s; border-bottom: 3px solid #667eea;">
                    <i class="fas fa-info-circle mr-1"></i>Basic Info
                </button>
                <button id="tab-replies" class="scenario-tab" onclick="switchScenarioTab('replies')" style="padding: 10px 20px; border: none; background: transparent; color: #6c757d; font-weight: 600; font-size: 14px; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s; border-bottom: 3px solid transparent;">
                    <i class="fas fa-comments mr-1"></i>Replies & Flow
                </button>
                <button id="tab-entities" class="scenario-tab" onclick="switchScenarioTab('entities')" style="padding: 10px 20px; border: none; background: transparent; color: #6c757d; font-weight: 600; font-size: 14px; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s; border-bottom: 3px solid transparent;">
                    <i class="fas fa-tag mr-1"></i>Entities & Variables
                </button>
                <button id="tab-advanced" class="scenario-tab" onclick="switchScenarioTab('advanced')" style="padding: 10px 20px; border: none; background: transparent; color: #6c757d; font-weight: 600; font-size: 14px; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s; border-bottom: 3px solid transparent;">
                    <i class="fas fa-cog mr-1"></i>Advanced Settings
                </button>
                <button id="tab-test" class="scenario-tab" onclick="switchScenarioTab('test')" style="padding: 10px 20px; border: none; background: transparent; color: #6c757d; font-weight: 600; font-size: 14px; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s; border-bottom: 3px solid transparent;">
                    <i class="fas fa-flask mr-1"></i>üî• Test & Preview
                </button>
                <button id="tab-enhance" class="scenario-tab" onclick="switchScenarioTab('enhance')" style="padding: 10px 20px; border: none; background: transparent; color: #6c757d; font-weight: 600; font-size: 14px; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s; border-bottom: 3px solid transparent;">
                    <i class="fas fa-brain mr-1"></i>ü§ñ AI Enhance
                </button>
            </div>

            <!-- MAIN CONTENT AREA: 2/3 Form + 1/3 AI Panel -->
            <div style="display: flex; flex: 1; min-height: 0; overflow: hidden;">
                
                <!-- LEFT: SCENARIO FORM (2/3) -->
                <div style="flex: 0 0 66.666%; display: flex; flex-direction: column; border-right: 2px solid #e0e7ff;">
                    <form id="scenario-form" style="flex: 1; overflow-y: auto; padding: 40px; min-height: 0;">
                
                <!-- TAB 1: BASIC INFO -->
                <div id="content-basic" class="scenario-tab-content" style="display: block;">
                    <div style="display: grid; gap: 28px;">
                        
                        <!-- Scenario Name -->
                        <div>
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                <i class="fas fa-heading text-purple-600 mr-2"></i>Scenario Name <span style="color: #e74c3c;">*</span>
                            </label>
                            <input type="text" id="scenario-name" required style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e9ecef'" placeholder="e.g., Hold Request, Appointment Inquiry, Pricing Question">
                            <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">Short, clear descriptor of this conversation type</p>
                        </div>

                        <!-- Status & Priority (Side by Side) -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                    <i class="fas fa-toggle-on text-green-600 mr-2"></i>Status
                                </label>
                                <select id="scenario-status" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px;">
                                    <option value="draft">üìù Draft</option>
                                    <option value="live">‚úÖ Live</option>
                                    <option value="archived">üì¶ Archived</option>
                                </select>
                            </div>
                            <div style="border: 2px solid #fef3c7; background: #fef3c7; border-radius: 10px; padding: 18px;">
                                <label style="display: block; font-weight: 600; color: #92400e; margin-bottom: 10px; font-size: 15px;">
                                    <i class="fas fa-flag mr-2"></i>Priority Level ‚ö°
                                </label>
                                <input type="number" id="scenario-priority" value="0" min="-10" max="10" style="width: 100%; padding: 14px 18px; border: 2px solid #fcd34d; border-radius: 10px; font-size: 18px; font-weight: 700; text-align: center; background: white;">
                                <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                                    <span style="font-size: 11px; color: #92400e;">-10 (Low)</span>
                                    <span style="font-size: 11px; color: #92400e;">0 (Normal)</span>
                                    <span style="font-size: 11px; color: #92400e;">+10 (Critical)</span>
                                </div>
                                <p style="margin: 12px 0 0; font-size: 13px; color: #92400e; font-weight: 500;">
                                    ‚ö° Tie-breaker when multiple scenarios match. Emergency=10, Normal=0, Chitchat=-5
                                </p>
                            </div>
                        </div>

                        <!-- üéØ INHERITED CONFIGURATION (Fillers & Synonyms) -->
                        <div style="border: 2px solid #dbeafe; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px; padding: 20px; margin: 30px 0;">
                            <h3 style="font-size: 18px; font-weight: 700; color: #1e40af; margin: 0 0 12px 0; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-layer-group"></i>
                                Inherited Configuration
                                <span style="font-size: 12px; font-weight: 600; background: #3b82f6; color: white; padding: 4px 10px; border-radius: 20px;">Read-Only</span>
                            </h3>
                            <p style="font-size: 14px; color: #1e40af; margin: 0 0 16px 0;">
                                This scenario inherits fillers & synonyms from its template and category
                            </p>
                            
                            <!-- Inherited Fillers -->
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                    <i class="fas fa-filter text-gray-600"></i>
                                    <strong style="color: #374151;">Effective Filler Words:</strong>
                                    <span id="scenario-fillers-count" style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                                    <button onclick="showAddFillerWordModal()" style="margin-left: auto; background: #059669; color: white; border: none; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s;" onmouseover="this.style.background='#047857'" onmouseout="this.style.background='#059669'" title="Add filler word to template">
                                        <i class="fas fa-plus"></i>
                                        Quick Add
                                    </button>
                                </div>
                                <div id="scenario-inherited-fillers" style="display: flex; flex-wrap: wrap; gap: 6px; padding: 12px; background: white; border: 1px solid #d1d5db; border-radius: 8px; min-height: 50px; max-height: 120px; overflow-y: auto;">
                                    <span style="color: #9ca3af; font-size: 13px;">Loading...</span>
                                </div>
                                <p style="margin: 6px 0 0; font-size: 12px; color: #6b7280;">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    These words are removed from caller input before matching
                                </p>
                            </div>
                            
                            <!-- Inherited Synonyms -->
                            <div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                    <i class="fas fa-language text-purple-600"></i>
                                    <strong style="color: #374151;">Effective Synonyms:</strong>
                                    <span id="scenario-synonyms-count" style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0 mappings</span>
                                    <button onclick="switchOverviewSubTab('synonyms');document.getElementById('new-technical-term').focus();" style="margin-left: auto; background: #7c3aed; color: white; border: none; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s;" onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#7c3aed'" title="Go to Synonyms tab to add mapping">
                                        <i class="fas fa-plus"></i>
                                        Quick Add
                                    </button>
                                </div>
                                <div id="scenario-inherited-synonyms" style="padding: 12px; background: white; border: 1px solid #d1d5db; border-radius: 8px; min-height: 50px; max-height: 150px; overflow-y: auto;">
                                    <span style="color: #9ca3af; font-size: 13px;">Loading...</span>
                                </div>
                                <p style="margin: 6px 0 0; font-size: 12px; color: #6b7280;">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Colloquial terms are translated to technical terms before matching
                                </p>
                            </div>
                        </div>

                        <!-- Triggers -->
                        <div>
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                <i class="fas fa-bolt text-yellow-600 mr-2"></i>Trigger Phrases <span style="color: #e74c3c;">*</span>
                            </label>
                            <textarea id="scenario-triggers" required rows="5" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px; font-family: 'Courier New', monospace; resize: vertical;" placeholder="One phrase per line, e.g.:
can you hold
please hold on
wait a moment
give me a second"></textarea>
                            <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">Natural phrases callers might say (one per line)</p>
                        </div>

                        <!-- Negative Triggers (CRITICAL FOR ACCURACY) -->
                        <div style="border: 2px solid #fef2f2; background: #fef2f2; border-radius: 10px; padding: 18px;">
                            <label style="display: block; font-weight: 600; color: #991b1b; margin-bottom: 10px; font-size: 15px;">
                                <i class="fas fa-ban mr-2"></i>Negative Triggers üö´ (PREVENTS False Matches)
                            </label>
                            <textarea id="scenario-negative-triggers" rows="3" style="width: 100%; padding: 14px 18px; border: 2px solid #fca5a5; border-radius: 10px; font-size: 15px; font-family: 'Courier New', monospace; resize: vertical; background: white;" placeholder="One phrase per line (prevents this scenario from firing):
don't hold
no hold
can't hold"></textarea>
                            <p style="margin: 8px 0 0; font-size: 13px; color: #991b1b; font-weight: 500;">
                                ‚ö†Ô∏è IMPORTANT: If caller says these phrases, this scenario will NOT match (prevents "don't hold" from triggering "Hold Request")
                            </p>
                        </div>

                        <!-- Regex Triggers (POWER USER) -->
                        <details style="border: 2px solid #eff6ff; background: #eff6ff; border-radius: 10px; padding: 18px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #1e40af; font-size: 15px;">
                                <i class="fas fa-code mr-2"></i>Regex Triggers üîß (Advanced - Optional)
                            </summary>
                            <textarea id="scenario-regex-triggers" rows="3" style="width: 100%; margin-top: 15px; padding: 14px 18px; border: 2px solid #93c5fd; border-radius: 10px; font-size: 14px; font-family: 'Courier New', monospace; resize: vertical; background: white;" placeholder="One regex pattern per line (JavaScript regex):
\\b(hold|wait)\\s*(on|up)?\\b
^schedule.*appointment$
\\d{3}-\\d{3}-\\d{4}"></textarea>
                            <p style="margin: 8px 0 0; font-size: 13px; color: #1e40af;">
                                üí° Advanced matching with regular expressions. Use for complex patterns (e.g., phone numbers, dates, exact word boundaries).
                            </p>
                        </details>

                        <!-- Min Confidence & Priority -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div style="border: 2px solid #ecfdf5; background: #ecfdf5; border-radius: 10px; padding: 18px;">
                                <label style="display: block; font-weight: 600; color: #065f46; margin-bottom: 10px; font-size: 15px;">
                                    <i class="fas fa-chart-line mr-2"></i>Min Confidence üéØ
                                </label>
                                <input type="range" id="scenario-context-weight" value="0.7" min="0" max="1" step="0.05" style="width: 100%; margin-bottom: 10px;" oninput="document.getElementById('confidence-value').textContent = (parseFloat(this.value) * 100).toFixed(0) + '%'">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px; color: #065f46;">0% (Any match)</span>
                                    <span id="confidence-value" style="font-size: 20px; font-weight: 700; color: #065f46;">70%</span>
                                    <span style="font-size: 13px; color: #065f46;">100% (Perfect)</span>
                                </div>
                                <p style="margin: 12px 0 0; font-size: 13px; color: #065f46; font-weight: 500;">
                                    üí° How confident the AI must be before using this scenario. Higher = more selective (emergency=95%, chitchat=50%)
                                </p>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                    <i class="fas fa-theater-masks text-purple-600 mr-2"></i>üé≠ Behavior <span style="color: #e74c3c;">*</span>
                                </label>
                                <select id="scenario-behavior" required style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px;">
                                    <option value="">Select behavior...</option>
                                    <!-- Populated dynamically from GlobalAIBehaviorTemplate -->
                                </select>
                                <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">
                                    AI personality: tone, pace, volume, emotion
                                </p>
                            </div>
                        </div>

                        <!-- Channel & Language -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                    <i class="fas fa-mobile-alt text-indigo-600 mr-2"></i>Channel
                                </label>
                                <select id="scenario-channel" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px;">
                                    <option value="any" selected>Any Channel</option>
                                    <option value="voice">üìû Voice Only</option>
                                    <option value="sms">üí¨ SMS Only</option>
                                    <option value="chat">üíª Chat Only</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                    <i class="fas fa-globe text-teal-600 mr-2"></i>Language
                                </label>
                                <select id="scenario-language" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px;">
                                    <option value="auto" selected>üåê Auto-Detect</option>
                                    <option value="en">üá∫üá∏ English</option>
                                    <option value="es">üá™üá∏ Spanish</option>
                                    <option value="fr">üá´üá∑ French</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- TAB 2: REPLIES & FLOW -->
                <div id="content-replies" class="scenario-tab-content" style="display: none;">
                    <div style="display: grid; gap: 28px;">
                        
                        <!-- Quick Replies -->
                        <div>
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                <i class="fas fa-forward text-green-600 mr-2"></i>Quick Replies (2-3 variations) <span style="color: #e74c3c;">*</span>
                            </label>
                            <textarea id="scenario-quick-replies" required rows="4" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px; resize: vertical;" placeholder="One per line, e.g.:
Sure, I can hold.
No problem, take your time.
Of course, I'll wait."></textarea>
                            <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">Short acknowledgments (rotated randomly)</p>
                        </div>

                        <!-- Full Replies -->
                        <div>
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                <i class="fas fa-comment-dots text-blue-600 mr-2"></i>Full Replies (2-3 variations) <span style="color: #e74c3c;">*</span>
                            </label>
                            <textarea id="scenario-full-replies" required rows="6" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px; resize: vertical;" placeholder="One per line, e.g.:
Absolutely! I'll hold while you check on that.
No problem at all, take all the time you need.
Of course! I'm happy to wait while you look into it."></textarea>
                            <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">Expanded, warm, natural replies</p>
                        </div>

                        <!-- Follow-Up Funnel -->
                        <div>
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                <i class="fas fa-arrow-right text-orange-600 mr-2"></i>Follow-Up Funnel
                            </label>
                            <textarea id="scenario-followup-funnel" rows="3" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px; resize: vertical;" placeholder="e.g., Is there anything else I can help you with today?"></textarea>
                            <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">Steer caller back to purpose after response</p>
                        </div>

                        <!-- Reply Selection Strategy -->
                        <div>
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                <i class="fas fa-random text-purple-600 mr-2"></i>Reply Selection Strategy
                            </label>
                            <select id="scenario-reply-selection" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px;">
                                <option value="random" selected>üé≤ Random (Natural Variety)</option>
                                <option value="sequential">üìã Sequential (Order)</option>
                                <option value="bandit">üéØ Bandit (Learn Best)</option>
                            </select>
                            <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">How to pick from multiple replies</p>
                        </div>

                        <!-- üéØ PHASE 2: Scenario Type & Reply Strategy -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            
                            <!-- Scenario Type (NEW) -->
                            <div>
                                <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                    <i class="fas fa-tag text-blue-600 mr-2"></i>Scenario Type
                                </label>
                                <select id="scenario-type" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px;">
                                    <option value="">-- Infer from Content --</option>
                                    <option value="INFO_FAQ">üìã INFO_FAQ (hours, pricing, info)</option>
                                    <option value="ACTION_FLOW">üöÄ ACTION_FLOW (booking, transfer)</option>
                                    <option value="SYSTEM_ACK">‚úì SYSTEM_ACK (confirmation)</option>
                                    <option value="SMALL_TALK">üí¨ SMALL_TALK (rapport)</option>
                                </select>
                                <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">What this scenario does (blank = infer)</p>
                            </div>

                            <!-- Reply Strategy (NEW) -->
                            <div>
                                <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                    <i class="fas fa-reply text-green-600 mr-2"></i>Reply Strategy
                                </label>
                                <select id="scenario-reply-strategy" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px;">
                                    <option value="AUTO" selected>üéØ AUTO (Smart Default)</option>
                                    <option value="FULL_ONLY">üìñ FULL_ONLY (Detailed)</option>
                                    <option value="QUICK_ONLY">‚ö° QUICK_ONLY (Brief)</option>
                                    <option value="QUICK_THEN_FULL">‚Ü≥ QUICK_THEN_FULL (Intro + Full)</option>
                                    <option value="LLM_WRAP">ü§ñ LLM_WRAP (Polish tone - beta)</option>
                                    <option value="LLM_CONTEXT">üß† LLM_CONTEXT (Generate - beta)</option>
                                </select>
                                <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">How to select replies for voice/SMS</p>
                            </div>

                        </div>

                    </div>
                </div>

                <!-- TAB 3: ENTITIES & VARIABLES -->
                <div id="content-entities" class="scenario-tab-content" style="display: none;">
                    <div style="display: grid; gap: 28px;">
                        
                        <!-- Entity Capture -->
                        <div>
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                <i class="fas fa-tag text-indigo-600 mr-2"></i>Entity Capture (Optional)
                            </label>
                            <textarea id="scenario-entity-capture" rows="4" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px; font-family: 'Courier New', monospace; resize: vertical;" placeholder="One entity type per line, e.g.:
name
phone
email
time
location
technician"></textarea>
                            <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">Variable "slots" AI can detect from caller speech</p>
                        </div>

                        <!-- Dynamic Variables -->
                        <div>
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                <i class="fas fa-code text-green-600 mr-2"></i>Dynamic Template Variables
                            </label>
                            <textarea id="scenario-dynamic-variables" rows="5" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px; font-family: 'Courier New', monospace; resize: vertical;" placeholder='One per line in format: key=fallback
Example:
name=valued customer
technician=our team member
time=shortly
location=your location'></textarea>
                            <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">Placeholders for entity-based personalization (use {name}, {time} in replies)</p>
                        </div>

                        <!-- Entity Validation (JSON) -->
                        <details style="border: 2px solid #e9ecef; border-radius: 10px; padding: 18px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #2c3e50; font-size: 15px;">
                                <i class="fas fa-check-circle text-teal-600 mr-2"></i>Entity Validation Rules (Advanced)
                            </summary>
                            <textarea id="scenario-entity-validation" rows="6" style="width: 100%; margin-top: 15px; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 14px; font-family: 'Courier New', monospace; resize: vertical;" placeholder='JSON format, e.g.:
{
  "phone": {"pattern": "^[0-9]{10}$", "prompt": "Please provide a 10-digit phone number"},
  "email": {"pattern": "@", "prompt": "Please provide a valid email address"}
}'></textarea>
                            <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">Validation patterns and prompts (JSON format)</p>
                        </details>

                    </div>
                </div>

                <!-- TAB 4: ADVANCED SETTINGS -->
                <div id="content-advanced" class="scenario-tab-content" style="display: none;">
                    <div style="display: grid; gap: 28px;">
                        
                        <!-- Cooldown & Max Turns -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                    <i class="fas fa-clock text-blue-600 mr-2"></i>Cooldown (seconds)
                                </label>
                                <input type="number" id="scenario-cooldown" value="0" min="0" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px;">
                                <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">Prevent spam (0 = no cooldown)</p>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                    <i class="fas fa-redo text-orange-600 mr-2"></i>Handoff Policy
                                </label>
                                <select id="scenario-handoff-policy" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px;">
                                    <option value="never">Never Handoff</option>
                                    <option value="low_confidence" selected>Low Confidence Only</option>
                                    <option value="always_on_keyword">Always on Keyword</option>
                                </select>
                            </div>
                        </div>

                        <!-- üéØ PHASE A ‚Äì STEP 3B: Follow-Up Behavior -->
                        <div style="border: 2px solid #10b981; border-radius: 10px; padding: 18px; background: #ecfdf5;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <i class="fas fa-arrow-right" style="font-size: 20px; color: #10b981;"></i>
                                <label style="font-weight: 600; color: #047857; font-size: 15px; margin: 0;">
                                    Follow-Up Behavior (After Response)
                                </label>
                            </div>
                            <div style="display: grid; gap: 16px;">
                                <!-- Follow-Up Mode -->
                                <div>
                                    <label style="display: block; font-weight: 500; color: #1f2937; margin-bottom: 8px; font-size: 14px;">
                                        <i class="fas fa-check-circle mr-2"></i>Follow-Up Mode
                                    </label>
                                    <select id="scenario-followup-mode" style="width: 100%; padding: 12px; border: 2px solid #d1fae5; border-radius: 8px; font-size: 14px;">
                                        <option value="NONE">NONE ‚Äì No follow-up</option>
                                        <option value="ASK_FOLLOWUP_QUESTION">ASK_FOLLOWUP_QUESTION ‚Äì Append question to response</option>
                                        <option value="ASK_IF_BOOK">ASK_IF_BOOK ‚Äì Ask if they want to book (future: booking flow)</option>
                                        <option value="TRANSFER">TRANSFER ‚Äì Immediately transfer to target</option>
                                    </select>
                                    <p style="margin: 6px 0 0; font-size: 12px; color: #059669;">What happens after main response</p>
                                </div>
                                
                                <!-- Follow-Up Question Text -->
                                <div>
                                    <label style="display: block; font-weight: 500; color: #1f2937; margin-bottom: 8px; font-size: 14px;">
                                        <i class="fas fa-comments mr-2"></i>Follow-Up Question Text
                                    </label>
                                    <input type="text" id="scenario-followup-question" style="width: 100%; padding: 12px; border: 2px solid #d1fae5; border-radius: 8px; font-size: 14px;" placeholder="e.g., Is there anything else I can help you with?" value="">
                                    <p style="margin: 6px 0 0; font-size: 12px; color: #059669;">For ASK_FOLLOWUP_QUESTION or ASK_IF_BOOK (leave blank for default)</p>
                                </div>
                                
                                <!-- Transfer Target -->
                                <div>
                                    <label style="display: block; font-weight: 500; color: #1f2937; margin-bottom: 8px; font-size: 14px;">
                                        <i class="fas fa-phone mr-2"></i>Transfer Target
                                    </label>
                                    <input type="text" id="scenario-followup-transfer-target" style="width: 100%; padding: 12px; border: 2px solid #d1fae5; border-radius: 8px; font-size: 14px;" placeholder="e.g., +15551234567 or sales_queue" value="">
                                    <p style="margin: 6px 0 0; font-size: 12px; color: #059669;">For TRANSFER mode (phone number or queue name)</p>
                                </div>
                            </div>
                        </div>

                        <!-- Timed Follow-Up -->
                        <details open style="border: 2px solid #667eea; border-radius: 10px; padding: 18px; background: #f8f9ff;">
                            <summary style="cursor: pointer; font-weight: 600; color: #667eea; font-size: 15px;">
                                <i class="fas fa-stopwatch mr-2"></i>Timed Follow-Up (Auto-Prompt)
                            </summary>
                            <div style="margin-top: 20px; display: grid; gap: 18px;">
                                <label style="display: flex; align-items: center; font-weight: 500; cursor: pointer;">
                                    <input type="checkbox" id="scenario-timed-enabled" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                                    <span>Enable automatic prompts after idle time</span>
                                </label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px;">Delay (seconds)</label>
                                        <input type="number" id="scenario-timed-delay" value="50" min="10" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px;">Extension (seconds)</label>
                                        <input type="number" id="scenario-timed-extension" value="30" min="10" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px;">Follow-Up Messages (one per line)</label>
                                    <textarea id="scenario-timed-messages" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; resize: vertical;" placeholder="Are you still there?
Just checking in..."></textarea>
                                </div>
                            </div>
                        </details>

                        <!-- Silence Policy -->
                        <details style="border: 2px solid #e9ecef; border-radius: 10px; padding: 18px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #2c3e50; font-size: 15px;">
                                <i class="fas fa-volume-mute text-gray-600 mr-2"></i>Silence Policy
                            </summary>
                            <div style="margin-top: 20px; display: grid; gap: 18px;">
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px;">Max Consecutive Silence</label>
                                    <input type="number" id="scenario-silence-max" value="2" min="1" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px;">Final Warning Message</label>
                                    <input type="text" id="scenario-silence-warning" value="Hello? Did I lose you?" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                                </div>
                            </div>
                        </details>

                        <!-- TTS Override -->
                        <details style="border: 2px solid #e9ecef; border-radius: 10px; padding: 18px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #2c3e50; font-size: 15px;">
                                <i class="fas fa-microphone text-red-600 mr-2"></i>TTS Voice Override (Optional)
                            </summary>
                            <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px;">Pitch</label>
                                    <select id="scenario-tts-pitch" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                                        <option value="">Default</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px;">Rate</label>
                                    <select id="scenario-tts-rate" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                                        <option value="">Default</option>
                                        <option value="slow">Slow</option>
                                        <option value="medium">Medium</option>
                                        <option value="fast">Fast</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px;">Volume</label>
                                    <select id="scenario-tts-volume" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                                        <option value="">Default</option>
                                        <option value="soft">Soft</option>
                                        <option value="medium">Medium</option>
                                        <option value="loud">Loud</option>
                                    </select>
                                </div>
                            </div>
                        </details>

                        <!-- Preconditions & Effects (JSON) -->
                        <details style="border: 2px solid #e9ecef; border-radius: 10px; padding: 18px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #2c3e50; font-size: 15px;">
                                <i class="fas fa-project-diagram text-purple-600 mr-2"></i>State Machine (Preconditions & Effects)
                            </summary>
                            <div style="margin-top: 20px; display: grid; gap: 18px;">
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px;">Preconditions (JSON)</label>
                                    <textarea id="scenario-preconditions" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-family: 'Courier New', monospace; resize: vertical;" placeholder='{"state": "collecting_phone", "hasEntity": ["name"]}'></textarea>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px;">Effects (JSON)</label>
                                    <textarea id="scenario-effects" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-family: 'Courier New', monospace; resize: vertical;" placeholder='{"setState": "confirming", "increment": {"holdCount": 1}}'></textarea>
                                </div>
                            </div>
                        </details>

                        <!-- Action Hooks -->
                        <div>
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 15px;">
                                <i class="fas fa-bolt text-yellow-600 mr-2"></i>Action Hooks (comma-separated)
                            </label>
                            <input type="text" id="scenario-action-hooks" style="width: 100%; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px;" placeholder="e.g., escalate_to_human, offer_scheduling, log_complaint">
                            <p style="margin: 8px 0 0; font-size: 13px; color: #6c757d;">Actions to trigger after this response</p>
                        </div>

                    </div>
                </div>

                <!-- TAB 5: TEST & PREVIEW (LIVE MATCH TRACE) -->
                <div id="content-test" class="scenario-tab-content" style="display: none;">
                    <div style="display: grid; gap: 28px;">
                        
                        <!-- Live Test Panel -->
                        <div style="border: 3px solid #7c3aed; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 16px; padding: 24px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                                <i class="fas fa-flask" style="font-size: 32px; color: #7c3aed;"></i>
                                <div>
                                    <h3 style="margin: 0; font-size: 22px; font-weight: 700; color: #5b21b6;">Live Trigger Testing</h3>
                                    <p style="margin: 4px 0 0; color: #6b21a8; font-size: 14px;">Test if this scenario would match a caller's phrase</p>
                                </div>
                            </div>
                            
                            <!-- Test Input -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; color: #5b21b6; margin-bottom: 10px; font-size: 15px;">
                                    <i class="fas fa-keyboard mr-2"></i>Test Phrase (what caller would say):
                                </label>
                                <input type="text" id="test-phrase-input" placeholder='Try: "can you hold for a moment" or "I need to schedule an appointment"' style="width: 100%; padding: 16px 20px; border: 3px solid #a78bfa; border-radius: 12px; font-size: 16px; background: white; font-weight: 500;" onkeypress="if(event.key==='Enter'){event.preventDefault();testScenarioMatch();}">
                                <button type="button" onclick="testScenarioMatch()" style="margin-top: 12px; background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; border: none; padding: 14px 28px; border-radius: 10px; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 4px 12px rgba(124,58,237,0.4); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <i class="fas fa-play mr-2"></i>Test Match
                                </button>
                            </div>
                            
                            <!-- Results Area -->
                            <div id="test-results" style="display: none; margin-top: 24px;">
                                <!-- Results will be injected here by JavaScript -->
                            </div>
                        </div>

                        <!-- Current Scenario Preview -->
                        <div style="border: 2px solid #e9ecef; background: #f8f9fa; border-radius: 12px; padding: 20px;">
                            <h4 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 700; color: #2c3e50;">
                                <i class="fas fa-eye text-blue-600 mr-2"></i>Current Scenario Configuration
                            </h4>
                            <div id="scenario-preview" style="display: grid; gap: 12px; font-size: 14px;">
                                <!-- Preview will be dynamically generated -->
                            </div>
                            <button type="button" onclick="updateScenarioPreview()" style="margin-top: 16px; background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-sync mr-2"></i>Refresh Preview
                            </button>
                        </div>

                        <!-- Help / Tips -->
                        <details style="border: 2px solid #dbeafe; background: #eff6ff; border-radius: 10px; padding: 18px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #1e40af; font-size: 15px;">
                                <i class="fas fa-lightbulb mr-2"></i>üí° Testing Tips & Best Practices
                            </summary>
                            <div style="margin-top: 16px; color: #1e40af; font-size: 14px; line-height: 1.8;">
                                <p style="margin: 0 0 12px 0;"><strong>üéØ Trigger Matching:</strong></p>
                                <ul style="margin: 0 0 16px 20px; padding: 0;">
                                    <li>Triggers are matched using <strong>keyword matching</strong> (not exact phrases)</li>
                                    <li>Order doesn't matter: "hold please" = "please hold"</li>
                                    <li>Case-insensitive: "HOLD" = "hold" = "Hold"</li>
                                </ul>
                                
                                <p style="margin: 0 0 12px 0;"><strong>üö´ Negative Triggers:</strong></p>
                                <ul style="margin: 0 0 16px 20px; padding: 0;">
                                    <li>If ANY negative trigger appears, scenario will NOT match</li>
                                    <li>Use to prevent false positives: "don't hold" should NOT trigger "Hold Request"</li>
                                </ul>
                                
                                <p style="margin: 0 0 12px 0;"><strong>üîß Regex Triggers:</strong></p>
                                <ul style="margin: 0 0 16px 20px; padding: 0;">
                                    <li>Advanced pattern matching for power users</li>
                                    <li>Example: <code>\b(hold|wait)\s*(on|up)?\b</code> matches "hold", "wait", "hold on", "wait up"</li>
                                    <li>Use for phone numbers, dates, specific patterns</li>
                                </ul>
                                
                                <p style="margin: 0 0 12px 0;"><strong>üìä Confidence & Priority:</strong></p>
                                <ul style="margin: 0 0 0 20px; padding: 0;">
                                    <li><strong>Min Confidence:</strong> How sure the AI must be (0.7 = 70% confident)</li>
                                    <li><strong>Priority:</strong> Tie-breaker if multiple scenarios match at same confidence</li>
                                    <li>Emergency scenarios: high confidence (0.9+) and high priority (8-10)</li>
                                    <li>Chitchat scenarios: low confidence (0.5) and low priority (-3 to 0)</li>
                                </ul>
                            </div>
                        </details>

                    </div>
                </div>

                <!-- TAB 6: AI ENHANCE (INTELLIGENCE FIELDS) -->
                <div id="content-enhance" class="scenario-tab-content" style="display: none;">
                    <div style="display: grid; gap: 28px;">
                        
                        <!-- Header -->
                        <div style="border: 3px solid #10b981; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 16px; padding: 24px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-brain" style="font-size: 32px; color: #10b981;"></i>
                                <div>
                                    <h3 style="margin: 0; font-size: 22px; font-weight: 700; color: #065f46;">AI Intelligence & Matching</h3>
                                    <p style="margin: 4px 0 0; color: #059669; font-size: 14px;">Keywords, Q&A Pairs, Testing, and Escalation Flags</p>
                                </div>
                            </div>
                        </div>

                        <!-- KEYWORDS SECTION -->
                        <div style="border: 2px solid #10b981; border-radius: 12px; background: white; padding: 20px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <h4 style="margin: 0; font-size: 18px; font-weight: 700; color: #065f46;">
                                    <i class="fas fa-key text-green-600 mr-2"></i>üîë Positive Keywords
                                </h4>
                                <button type="button" onclick="regenerateKeywords()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer;">
                                    <i class="fas fa-sync mr-1"></i>Regenerate from Triggers
                                </button>
                            </div>
                            <p style="color: #6b7280; font-size: 14px; margin: 0 0 12px 0;">Fast Tier-1 matching keywords (extracted from triggers). These enable instant recognition without expensive LLM calls.</p>
                            
                            <!-- Keywords Display/Edit -->
                            <div id="keywords-display" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; min-height: 40px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 2px dashed #d1d5db;">
                                <!-- Keywords chips will be inserted here -->
                                <span style="color: #9ca3af; font-style: italic;">No keywords generated yet. Click "Regenerate from Triggers" or use AI to generate.</span>
                            </div>
                            
                            <!-- Add Keyword -->
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="new-keyword-input" placeholder="Add keyword..." style="flex: 1; padding: 10px 16px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                <button type="button" onclick="addKeyword()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    <i class="fas fa-plus mr-1"></i>Add
                                </button>
                            </div>
                        </div>

                        <!-- NEGATIVE KEYWORDS SECTION -->
                        <div style="border: 2px solid #ef4444; border-radius: 12px; background: white; padding: 20px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <h4 style="margin: 0; font-size: 18px; font-weight: 700; color: #dc2626;">
                                    <i class="fas fa-ban text-red-600 mr-2"></i>‚ùå Negative Keywords
                                </h4>
                                <button type="button" onclick="regenerateNegativeKeywords()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer;">
                                    <i class="fas fa-sync mr-1"></i>Regenerate from Negative Triggers
                                </button>
                            </div>
                            <p style="color: #6b7280; font-size: 14px; margin: 0 0 12px 0;">Words that VETO this scenario (prevent false positives). If any of these appear, scenario will NOT match.</p>
                            
                            <!-- Negative Keywords Display/Edit -->
                            <div id="negative-keywords-display" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; min-height: 40px; padding: 12px; background: #fef2f2; border-radius: 8px; border: 2px dashed #fca5a5;">
                                <!-- Negative keywords chips will be inserted here -->
                                <span style="color: #9ca3af; font-style: italic;">No negative keywords yet. Click "Regenerate" or add manually.</span>
                            </div>
                            
                            <!-- Add Negative Keyword -->
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="new-negative-keyword-input" placeholder="Add negative keyword (e.g., don't, not, never)..." style="flex: 1; padding: 10px 16px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                <button type="button" onclick="addNegativeKeyword()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    <i class="fas fa-plus mr-1"></i>Add
                                </button>
                            </div>
                        </div>

                        <!-- Q&A PAIRS SECTION -->
                        <div style="border: 2px solid #3b82f6; border-radius: 12px; background: white; padding: 20px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <h4 style="margin: 0; font-size: 18px; font-weight: 700; color: #1e40af;">
                                    <i class="fas fa-comments text-blue-600 mr-2"></i>üí¨ Q&A Training Pairs
                                </h4>
                                <button type="button" onclick="regenerateQnAPairs()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer;">
                                    <i class="fas fa-sync mr-1"></i>Regenerate from Triggers + Replies
                                </button>
                            </div>
                            <p style="color: #6b7280; font-size: 14px; margin: 0 0 16px 0;">Training data for semantic AI matching. These Q&A pairs help the AI understand intent.</p>
                            
                            <!-- Q&A Pairs List -->
                            <div id="qna-pairs-list" style="display: grid; gap: 12px;">
                                <!-- Q&A pairs will be inserted here -->
                                <div style="text-align: center; color: #9ca3af; font-style: italic; padding: 24px; background: #f9fafb; border-radius: 8px; border: 2px dashed #d1d5db;">
                                    No Q&A pairs generated yet. Click "Regenerate" or use AI to generate.
                                </div>
                            </div>
                            
                            <!-- Add Q&A Pair -->
                            <div style="margin-top: 16px; padding: 16px; background: #eff6ff; border-radius: 8px; border: 2px dashed #3b82f6;">
                                <h5 style="margin: 0 0 12px 0; font-size: 15px; font-weight: 600; color: #1e40af;">
                                    <i class="fas fa-plus-circle mr-1"></i>Add Custom Q&A Pair
                                </h5>
                                <input type="text" id="new-qna-question" placeholder="Question (e.g., 'How do I book an appointment?')" style="width: 100%; padding: 10px 16px; border: 2px solid #3b82f6; border-radius: 8px; font-size: 14px; margin-bottom: 8px;">
                                <textarea id="new-qna-answer" placeholder="Answer (e.g., 'I'd be happy to help you schedule...')" rows="2" style="width: 100%; padding: 10px 16px; border: 2px solid #3b82f6; border-radius: 8px; font-size: 14px; margin-bottom: 8px; resize: vertical;"></textarea>
                                <button type="button" onclick="addQnAPair()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    <i class="fas fa-plus mr-1"></i>Add Q&A Pair
                                </button>
                            </div>
                        </div>

                        <!-- ESCALATION FLAGS SECTION -->
                        <div style="border: 2px solid #f59e0b; border-radius: 12px; background: white; padding: 20px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <h4 style="margin: 0; font-size: 18px; font-weight: 700; color: #d97706;">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>üö® Escalation Flags
                                </h4>
                            </div>
                            <p style="color: #6b7280; font-size: 14px; margin: 0 0 12px 0;">Sentiment/situation triggers for human handoff (e.g., angry, confused, urgent, technical issue).</p>
                            
                            <!-- Escalation Flags Display/Edit -->
                            <div id="escalation-flags-display" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; min-height: 40px; padding: 12px; background: #fffbeb; border-radius: 8px; border: 2px dashed #fcd34d;">
                                <!-- Escalation flags chips will be inserted here -->
                                <span style="color: #9ca3af; font-style: italic;">No escalation flags set. Add flags that should trigger human handoff.</span>
                            </div>
                            
                            <!-- Add Escalation Flag -->
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="new-escalation-flag-input" placeholder="Add flag (e.g., angry, confused, urgent)..." style="flex: 1; padding: 10px 16px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                <button type="button" onclick="addEscalationFlag()" style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    <i class="fas fa-plus mr-1"></i>Add
                                </button>
                            </div>
                        </div>

                        <!-- TRAINING EXAMPLES SECTION -->
                        <div style="border: 2px solid #8b5cf6; border-radius: 12px; background: white; padding: 20px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <h4 style="margin: 0; font-size: 18px; font-weight: 700; color: #6d28d9;">
                                    <i class="fas fa-chalkboard-teacher text-purple-600 mr-2"></i>üí° Training Examples
                                </h4>
                            </div>
                            <p style="color: #6b7280; font-size: 14px; margin: 0 0 16px 0;">Sample conversations showing expected AI behavior for this scenario.</p>
                            
                            <!-- Examples List -->
                            <div id="training-examples-list" style="display: grid; gap: 12px;">
                                <!-- Examples will be inserted here -->
                                <div style="text-align: center; color: #9ca3af; font-style: italic; padding: 24px; background: #f9fafb; border-radius: 8px; border: 2px dashed #d1d5db;">
                                    No training examples yet. Use AI to generate or add manually.
                                </div>
                            </div>
                            
                            <!-- Add Training Example -->
                            <div style="margin-top: 16px; padding: 16px; background: #f5f3ff; border-radius: 8px; border: 2px dashed #8b5cf6;">
                                <h5 style="margin: 0 0 12px 0; font-size: 15px; font-weight: 600; color: #6d28d9;">
                                    <i class="fas fa-plus-circle mr-1"></i>Add Training Example
                                </h5>
                                <input type="text" id="new-example-caller" placeholder="Caller says..." style="width: 100%; padding: 10px 16px; border: 2px solid #8b5cf6; border-radius: 8px; font-size: 14px; margin-bottom: 8px;">
                                <textarea id="new-example-ai" placeholder="AI responds..." rows="2" style="width: 100%; padding: 10px 16px; border: 2px solid #8b5cf6; border-radius: 8px; font-size: 14px; margin-bottom: 8px; resize: vertical;"></textarea>
                                <button type="button" onclick="addTrainingExample()" style="background: #8b5cf6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    <i class="fas fa-plus mr-1"></i>Add Example
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                    </form>
                </div>
                <!-- END LEFT: SCENARIO FORM -->

                <!-- RIGHT: AI SCENARIO ARCHITECT PANEL (1/3) -->
                <div id="scenario-architect-panel" class="scenario-architect-region" data-collapsed="false" style="flex: 0 0 33.333%; background: linear-gradient(180deg, #fafbff 0%, #f0f4ff 100%); display: flex; flex-direction: column; overflow: hidden;">
                
                <!-- Header -->
                <div class="architect-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #059669;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 16px; font-weight: 700;">
                            <i class="fas fa-brain mr-2"></i>AI Scenario Architect
                        </span>
                        <span style="font-size: 11px; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 12px; font-weight: 600;">LIVE BETA</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button id="architect-settings-btn" type="button" title="LLM Enterprise Settings" style="background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button id="scenario-architect-toggle" type="button" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            Hide
                        </button>
                    </div>
                </div>
                
                <!-- Chat Area (scrollable) -->
                <div id="scenario-architect-chat" class="architect-chat-area" style="flex: 1 1 auto; overflow-y: auto; padding: 16px; font-size: 14px; background: white; border-bottom: 1px solid #e5e7eb;">
                    <div style="color: #6c757d; font-style: italic; text-align: center; padding: 20px;">
                        No conversation yet. Describe your scenario below to start.
                    </div>
                </div>
                
                <!-- Checklist Summary Area -->
                <div id="scenario-architect-checklist" class="architect-checklist" style="padding: 0 16px; max-height: 150px; overflow-y: auto;"></div>
                
                <!-- Status Area -->
                <div id="scenario-architect-status" class="architect-status" style="display: none; margin: 0 16px 12px;"></div>
                
                <!-- Input Area -->
                <div class="architect-input-area" style="padding: 20px; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 12px; flex-shrink: 0;">
                    <textarea 
                        id="scenario-architect-input"
                        placeholder="Describe what this scenario should handle, or answer the AI's question..."
                        style="width: 100%; padding: 14px 16px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; resize: vertical; min-height: 80px; max-height: 200px; transition: all 0.3s; line-height: 1.5;"
                        onfocus="this.style.borderColor='#10b981'"
                        onblur="this.style.borderColor='#d1d5db'"
                        rows="3"
                    ></textarea>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button 
                            id="scenario-architect-send-btn"
                            type="button"
                            onclick="if(window.scenarioArchitectPanel){window.scenarioArchitectPanel.handleSend()}else{console.error('‚ùå ScenarioArchitectPanel not initialized')}"
                            style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; white-space: nowrap; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);"
                            onmouseover="this.style.background='#059669'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.3)'"
                            onmouseout="this.style.background='#10b981'; this.style.boxShadow='0 2px 4px rgba(16, 185, 129, 0.2)'"
                        >
                            ‚ú® Generate Draft
                        </button>
                        <button 
                            id="scenario-architect-apply-btn"
                            type="button"
                            onclick="if(window.scenarioArchitectPanel){window.scenarioArchitectPanel.handleApplyDraft()}else{console.error('‚ùå ScenarioArchitectPanel not initialized')}"
                            style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; white-space: nowrap; display: none; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);"
                            onmouseover="this.style.background='#2563eb'; this.style.boxShadow='0 4px 8px rgba(59, 130, 246, 0.3)'"
                            onmouseout="this.style.background='#3b82f6'; this.style.boxShadow='0 2px 4px rgba(59, 130, 246, 0.2)'"
                        >
                            ‚úÖ Apply to Form
                        </button>
                    </div>
                </div>
                </div>
                <!-- END RIGHT: AI PANEL -->

            </div>
            <!-- END MAIN CONTENT AREA -->

            <!-- FIXED FOOTER -->
            <div style="background: #f8f9fa; padding: 12px 32px; display: flex; align-items: center; justify-content: space-between; border-top: 2px solid #e9ecef; flex-shrink: 0;">
                <button type="button" onclick="closeScenarioModal()" style="background: white; color: #6c757d; border: 2px solid #dee2e6; padding: 10px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s;">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <div style="display: flex; gap: 10px;">
                    <button type="button" onclick="saveScenarioAsDraft()" style="background: #ffc107; color: #000; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(255,193,7,0.3);">
                        <i class="fas fa-save mr-2"></i>Save as Draft
                    </button>
                    <button type="button" onclick="saveScenarioAsLive()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(102,126,234,0.4);">
                        <i class="fas fa-rocket mr-2"></i>Save & Publish Live
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- ============================================ -->
    <!-- üéõÔ∏è LLM ENTERPRISE SETTINGS (Full Page) -->
    <!-- ============================================ -->
    <section id="llm-enterprise-settings-section" style="display:none; position: fixed; inset: 0; background: #f3f4f6; z-index: 10002; overflow-y: auto;">
      <div style="max-width:1200px; margin:0 auto; padding: 20px;">
        <!-- Header -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background: white; padding: 16px 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div>
            <h1 style="font-size:20px; font-weight:700; color:#111827; margin: 0;">
              <i class="fas fa-cog mr-2"></i>LLM Enterprise Settings
            </h1>
            <div style="font-size:13px; color:#6b7280; margin-top:4px;">
              Global behavior, compliance, and generation defaults for the AI Scenario Architect.
            </div>
          </div>
          <div style="display:flex; gap:10px;">
            <button id="llm-settings-reset-all" style="padding:8px 14px; border-radius:8px; border:1px solid #e5e7eb; background:white; font-size:13px; cursor:pointer; font-weight:500; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
              <i class="fas fa-undo mr-1"></i>Reset All to Defaults
            </button>
            <button id="llm-settings-back" style="padding:8px 16px; border-radius:8px; border:none; background:#4f46e5; color:white; font-size:13px; font-weight:600; cursor:pointer; transition: all 0.2s;" onmouseover="this.style.background='#4338ca'" onmouseout="this.style.background='#4f46e5'">
              <i class="fas fa-arrow-left mr-1"></i>Back to Scenario Editor
            </button>
          </div>
        </div>

        <!-- Live Prompt Preview Box -->
        <div id="llm-live-prompt-preview" style="background:#fefce8; border:2px solid #fbbf24; border-radius:10px; padding:16px; margin-bottom:20px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-size:14px; font-weight:700; color:#92400e;">
              <i class="fas fa-eye mr-2"></i>Live Preview: What the AI Sees Right Now
            </div>
            <button id="toggle-prompt-preview" style="font-size:11px; padding:4px 8px; border-radius:6px; border:1px solid #fbbf24; background:white; cursor:pointer;">
              Show Full Text
            </button>
          </div>
          <div style="font-size:12px; color:#78350f; margin-bottom:8px;">
            <strong>Active:</strong> <span id="preview-active-parts">Base Prompt + Compliance-Safe Profile + Strict Compliance Mode</span>
          </div>
          <div id="prompt-preview-text" style="display:none; background:white; border-radius:8px; padding:12px; font-family:monospace; font-size:11px; line-height:1.6; max-height:300px; overflow-y:auto; white-space:pre-wrap; color:#1f2937;">
            Loading prompt text...
          </div>
        </div>

        <!-- Two-column layout -->
        <div style="display:flex; gap:20px;">
          <!-- Left nav -->
          <div style="width:240px;">
            <div style="background:white; border-radius:10px; border:1px solid #e5e7eb; padding:12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
              <div class="llm-settings-nav-item" data-target="llm-settings-profiles" style="padding:10px 12px; border-radius:8px; font-size:13px; cursor:pointer; background:#eef2ff; font-weight:600; color:#4f46e5; transition: all 0.2s;">
                <i class="fas fa-user-circle mr-2"></i>Profiles
              </div>
              <div class="llm-settings-nav-item" data-target="llm-settings-compliance" style="padding:10px 12px; border-radius:8px; font-size:13px; cursor:pointer; margin-top:4px; color:#6b7280; transition: all 0.2s;">
                <i class="fas fa-shield-alt mr-2"></i>Compliance & Domains
              </div>
              <div class="llm-settings-nav-item" data-target="llm-settings-generation" style="padding:10px 12px; border-radius:8px; font-size:13px; cursor:pointer; margin-top:4px; color:#6b7280; transition: all 0.2s;">
                <i class="fas fa-magic mr-2"></i>Generation Defaults
              </div>
              <div class="llm-settings-nav-item" data-target="llm-settings-advanced" style="padding:10px 12px; border-radius:8px; font-size:13px; cursor:pointer; margin-top:4px; color:#6b7280; transition: all 0.2s;">
                <i class="fas fa-sliders-h mr-2"></i>Advanced Tuning
              </div>
              <div class="llm-settings-nav-item" data-target="llm-settings-prompt-editor" style="padding:10px 12px; border-radius:8px; font-size:13px; cursor:pointer; margin-top:4px; color:#6b7280; transition: all 0.2s;">
                <i class="fas fa-edit mr-2"></i>Prompt Editor
              </div>
            </div>
            <div style="background:#fef3c7; border:1px solid #fcd34d; border-radius:8px; padding:10px; margin-top:12px; font-size:11px; line-height:1.5;">
              <div style="font-weight:700; margin-bottom:4px; color:#92400e;">
                <i class="fas fa-exclamation-triangle mr-1"></i>Admin/Developer Tool
              </div>
              <div style="color:#78350f;">
                Edit LLM instructions as needed. Click "Reset" to restore recommended defaults. Changes affect ALL scenarios using this profile.
              </div>
            </div>
          </div>

          <!-- Right content -->
          <div style="flex:1; display:flex; flex-direction:column; gap:16px;">
            
            <!-- Profiles Card -->
            <div id="llm-settings-profiles" class="llm-settings-card" style="background:white; border-radius:10px; border:1px solid #e5e7eb; padding:20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
              <div style="font-size:17px; font-weight:700; margin-bottom:6px; color:#111827;">
                <i class="fas fa-user-circle mr-2 text-indigo-600"></i>AI Profiles
              </div>
              <div style="font-size:13px; color:#6b7280; margin-bottom:16px; line-height:1.5;">
                Choose the default behavior pattern used by the AI Scenario Architect. Each profile has different creativity, safety, and generation settings.
              </div>

              <div id="llm-profile-radios" style="display:flex; flex-direction:column; gap:10px; margin-bottom:16px;">
                <label style="display:flex; gap:10px; cursor:pointer; padding:12px; border-radius:8px; border:2px solid #e5e7eb; transition: all 0.2s;" onmouseover="this.style.borderColor='#c7d2fe'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="llm-active-profile" value="compliance_safe" style="margin-top:2px;" />
                  <div style="flex:1;">
                    <div style="font-weight:600; font-size:14px; color:#111827; margin-bottom:4px;">
                      <i class="fas fa-shield-alt mr-1 text-green-600"></i>Compliance-Safe (Default)
                    </div>
                    <div style="font-size:12px; color:#6b7280; line-height:1.4;">
                      Conservative, low creativity (temp 0.2). Prioritizes safety, clarity, policy alignment. Clamps priority¬±2, minConfidence 0.6-0.9.
                    </div>
                  </div>
                </label>

                <label style="display:flex; gap:10px; cursor:pointer; padding:12px; border-radius:8px; border:2px solid #e5e7eb; transition: all 0.2s;" onmouseover="this.style.borderColor='#c7d2fe'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="llm-active-profile" value="call_center_optimized" style="margin-top:2px;" />
                  <div style="flex:1;">
                    <div style="font-weight:600; font-size:14px; color:#111827; margin-bottom:4px;">
                      <i class="fas fa-phone-alt mr-1 text-blue-600"></i>Call Center Optimized
                    </div>
                    <div style="font-size:12px; color:#6b7280; line-height:1.4;">
                      Balanced creativity (temp 0.35). Tuned for phone calls with richer triggers, more variants. Best for production call centers.
                    </div>
                  </div>
                </label>

                <label style="display:flex; gap:10px; cursor:pointer; padding:12px; border-radius:8px; border:2px solid #e5e7eb; transition: all 0.2s;" onmouseover="this.style.borderColor='#c7d2fe'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="llm-active-profile" value="creative_exploration" style="margin-top:2px;" />
                  <div style="flex:1;">
                    <div style="font-weight:600; font-size:14px; color:#111827; margin-bottom:4px;">
                      <i class="fas fa-lightbulb mr-1 text-purple-600"></i>Creative Exploration (Internal)
                    </div>
                    <div style="font-size:12px; color:#6b7280; line-height:1.4;">
                      High creativity (temp 0.65), uses gpt-4o. Generates many variants for brainstorming. Review before production.
                    </div>
                  </div>
                </label>
              </div>

              <div style="display:flex; justify-content:flex-end; gap:10px; padding-top:12px; border-top:1px solid #f3f4f6;">
                <button id="llm-settings-profiles-reset" style="padding:8px 14px; border-radius:8px; border:1px solid #e5e7eb; background:white; font-size:13px; cursor:pointer; font-weight:500; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                  <i class="fas fa-undo mr-1"></i>Reset
                </button>
                <button id="llm-settings-profiles-save" style="padding:8px 16px; border-radius:8px; border:none; background:#10b981; color:white; font-size:13px; font-weight:600; cursor:pointer; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                  <i class="fas fa-check mr-1"></i>Save Profiles
                </button>
              </div>
            </div>

            <!-- Compliance Card -->
            <div id="llm-settings-compliance" class="llm-settings-card" style="display:none; background:white; border-radius:10px; border:1px solid #e5e7eb; padding:20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
              <div style="font-size:17px; font-weight:700; margin-bottom:6px; color:#111827;">
                <i class="fas fa-shield-alt mr-2 text-green-600"></i>Compliance & Domain Safety
              </div>
              <div style="font-size:13px; color:#6b7280; margin-bottom:16px; line-height:1.5;">
                Extra guardrails and domain-specific rules applied on top of the selected profile. These affect system prompts and validation.
              </div>

              <div style="background:#fef3c7; border:1px solid #fcd34d; border-radius:8px; padding:12px; margin-bottom:16px;">
                <div style="font-size:12px; font-weight:600; color:#92400e; margin-bottom:6px;">
                  <i class="fas fa-exclamation-triangle mr-1"></i>Strict Compliance Mode
                </div>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                  <input type="checkbox" id="llm-strict-compliance" />
                  <span style="font-size:13px; color:#78350f;">Enforce strict compliance guardrails across all scenarios (conservative safety checks, restricted language)</span>
                </label>
              </div>

              <div style="font-size:14px; font-weight:600; color:#111827; margin-bottom:10px;">Domain-Specific Safety Modes</div>
              
              <label style="display:flex; align-items:start; gap:10px; cursor:pointer; padding:10px; border-radius:8px; background:#f9fafb; margin-bottom:8px;">
                <input type="checkbox" id="llm-medical-mode" style="margin-top:2px;" />
                <div style="flex:1;">
                  <div style="font-size:13px; font-weight:600; color:#111827;">Medical Office Safety Mode</div>
                  <div style="font-size:12px; color:#6b7280; margin-top:2px;">Blocks medical advice, diagnosis, prescriptions. Focuses on scheduling and logistics only.</div>
                </div>
              </label>

              <label style="display:flex; align-items:start; gap:10px; cursor:pointer; padding:10px; border-radius:8px; background:#f9fafb; margin-bottom:8px;">
                <input type="checkbox" id="llm-financial-mode" style="margin-top:2px;" />
                <div style="flex:1;">
                  <div style="font-size:13px; font-weight:600; color:#111827;">Financial / Billing Safety Mode</div>
                  <div style="font-size:12px; color:#6b7280; margin-top:2px;">Blocks investment/tax advice, guarantees. Handles billing status and payment methods only.</div>
                </div>
              </label>

              <label style="display:flex; align-items:start; gap:10px; cursor:pointer; padding:10px; border-radius:8px; background:#f9fafb; margin-bottom:12px;">
                <input type="checkbox" id="llm-emergency-mode" style="margin-top:2px;" />
                <div style="flex:1;">
                  <div style="font-size:13px; font-weight:600; color:#111827;">Emergency Services Safety Mode</div>
                  <div style="font-size:12px; color:#6b7280; margin-top:2px;">Instructs callers to dial emergency number for active emergencies. Blocks triage attempts.</div>
                </div>
              </label>

              <label style="font-size:13px; font-weight:600; color:#111827; margin-top:12px; display:block;">
                Internal Notes (optional)
              </label>
              <textarea id="llm-compliance-notes" placeholder="Add notes about your compliance requirements..." style="width:100%; min-height:70px; margin-top:6px; font-size:12px; padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb; font-family: inherit; resize: vertical;"></textarea>

              <div style="display:flex; justify-content:flex-end; gap:10px; padding-top:12px; border-top:1px solid #f3f4f6; margin-top:16px;">
                <button id="llm-settings-compliance-reset" style="padding:8px 14px; border-radius:8px; border:1px solid #e5e7eb; background:white; font-size:13px; cursor:pointer; font-weight:500; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                  <i class="fas fa-undo mr-1"></i>Reset
                </button>
                <button id="llm-settings-compliance-save" style="padding:8px 16px; border-radius:8px; border:none; background:#10b981; color:white; font-size:13px; font-weight:600; cursor:pointer; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                  <i class="fas fa-check mr-1"></i>Save Compliance
                </button>
              </div>
            </div>

            <!-- Generation Card -->
            <div id="llm-settings-generation" class="llm-settings-card" style="display:none; background:white; border-radius:10px; border:1px solid #e5e7eb; padding:20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
              <div style="font-size:17px; font-weight:700; margin-bottom:6px; color:#111827;">
                <i class="fas fa-magic mr-2 text-purple-600"></i>Scenario Generation Defaults
              </div>
              <div style="font-size:13px; color:#6b7280; margin-bottom:16px; line-height:1.5;">
                Default behavior when you ask the AI Architect to draft a scenario. These can be overridden per request.
              </div>

              <div style="font-size:14px; font-weight:600; color:#111827; margin-bottom:10px;">Generation Mode</div>
              <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:16px; background:#f9fafb; padding:12px; border-radius:8px;">
                <label style="display:flex; gap:10px; cursor:pointer; align-items:center;">
                  <input type="radio" name="llm-generation-mode" value="single" />
                  <div>
                    <div style="font-size:13px; font-weight:600; color:#111827;">Single Draft (Default)</div>
                    <div style="font-size:12px; color:#6b7280;">Generate one complete scenario per request.</div>
                  </div>
                </label>
                <label style="display:flex; gap:10px; cursor:pointer; align-items:center;">
                  <input type="radio" name="llm-generation-mode" value="multi" />
                  <div>
                    <div style="font-size:13px; font-weight:600; color:#111827;">Multi-Variant Brainstorm</div>
                    <div style="font-size:12px; color:#6b7280;">Generate multiple scenario variations for comparison.</div>
                  </div>
                </label>
              </div>

              <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div style="display:flex; flex-direction:column; gap:6px; flex:1; min-width:180px;">
                  <label for="llm-default-variants" style="font-size:13px; font-weight:600; color:#111827;">
                    <i class="fas fa-clone mr-1"></i>Default Variant Count
                  </label>
                  <input type="number" id="llm-default-variants" min="1" max="15" value="1" style="width:100%; padding:8px 10px; font-size:13px; border-radius:8px; border:1px solid #e5e7eb;" />
                  <span style="font-size:11px; color:#6b7280;">How many variants to generate by default</span>
                </div>
                <div style="display:flex; flex-direction:column; gap:6px; flex:1; min-width:180px;">
                  <label for="llm-max-variants" style="font-size:13px; font-weight:600; color:#111827;">
                    <i class="fas fa-layer-group mr-1"></i>Max Allowed Variants
                  </label>
                  <input type="number" id="llm-max-variants" min="1" max="20" value="15" style="width:100%; padding:8px 10px; font-size:13px; border-radius:8px; border:1px solid #e5e7eb;" />
                  <span style="font-size:11px; color:#6b7280;">Maximum variants a user can request</span>
                </div>
              </div>

              <div style="display:flex; justify-content:flex-end; gap:10px; padding-top:12px; border-top:1px solid #f3f4f6; margin-top:16px;">
                <button id="llm-settings-generation-reset" style="padding:8px 14px; border-radius:8px; border:1px solid #e5e7eb; background:white; font-size:13px; cursor:pointer; font-weight:500; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                  <i class="fas fa-undo mr-1"></i>Reset
                </button>
                <button id="llm-settings-generation-save" style="padding:8px 16px; border-radius:8px; border:none; background:#10b981; color:white; font-size:13px; font-weight:600; cursor:pointer; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                  <i class="fas fa-check mr-1"></i>Save Generation
                </button>
              </div>
            </div>

            <!-- Advanced Card -->
            <div id="llm-settings-advanced" class="llm-settings-card" style="display:none; background:white; border-radius:10px; border:1px solid #e5e7eb; padding:20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
              <div style="font-size:17px; font-weight:700; margin-bottom:6px; color:#111827;">
                <i class="fas fa-sliders-h mr-2 text-orange-600"></i>Advanced Model Tuning
              </div>
              <div style="font-size:13px; color:#6b7280; margin-bottom:16px; line-height:1.5;">
                Optional overrides for temperature, top_p, and max_tokens per profile. Leave blank to use profile defaults. Compliance-Safe values are clamped server-side.
              </div>

              <div id="llm-advanced-profiles" style="display:flex; flex-direction:column; gap:12px;">
                
                <!-- Compliance Safe -->
                <div style="border:1px solid #e5e7eb; border-radius:8px; padding:14px; background:#fafafa;">
                  <div style="font-size:14px; font-weight:600; margin-bottom:10px; color:#111827;">
                    <i class="fas fa-shield-alt mr-1 text-green-600"></i>Compliance-Safe Overrides
                  </div>
                  <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <div style="display:flex; flex-direction:column; gap:4px; position:relative;">
                      <label style="font-size:11px; font-weight:600; color:#111827;">
                        Temperature
                        <i class="fas fa-info-circle" style="margin-left:4px; color:#3b82f6; cursor:help; font-size:10px;" title="CREATIVITY vs CONSISTENCY

üéØ What it does:
Controls how creative or consistent the LLM responses are.

üìä Scale:
‚Ä¢ 0.0-0.2 = Robot mode (exact same response every time)
‚Ä¢ 0.2-0.4 = Consistent (slight variation, professional)
‚Ä¢ 0.4-0.6 = Balanced (natural human-like responses)
‚Ä¢ 0.6-1.0 = Creative (lots of variety, less predictable)

üí° Why it matters:
Lower temperature = safer, more predictable (good for compliance)
Higher temperature = more natural, less robotic (good for conversation)

üîß When to adjust:
‚Ä¢ Legal/Medical: Keep LOW (0.1-0.2) for consistency
‚Ä¢ General business: Use DEFAULT (0.2-0.35) for balance
‚Ä¢ Creative brainstorming: Go HIGHER (0.5-0.7) for variety

‚ö†Ô∏è Default: 0.2 (Server clamps: 0.1-0.35)"></i>
                      </label>
                      <input type="number" step="0.05" min="0" max="1" id="llm-adv-compliance-temp" placeholder="0.2" style="width:90px; padding:6px 8px; font-size:12px; border-radius:6px; border:1px solid #e5e7eb;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px; position:relative;">
                      <label style="font-size:11px; font-weight:600; color:#111827;">
                        top_p
                        <i class="fas fa-info-circle" style="margin-left:4px; color:#3b82f6; cursor:help; font-size:10px;" title="VOCABULARY DIVERSITY

üéØ What it does:
Controls how diverse the vocabulary is in responses.

üìä Scale:
‚Ä¢ 0.5 = Only very common words (formal, repetitive)
‚Ä¢ 0.9 = Balanced vocabulary (natural, professional)
‚Ä¢ 1.0 = All words available (can be too creative)

üí° Why it matters:
Lower top_p = safer vocabulary, fewer surprises
Higher top_p = richer vocabulary, more expressive

üîß When to adjust:
‚Ä¢ Formal settings: Keep DEFAULT (0.9) - works for 99% of cases
‚Ä¢ Too robotic: Increase slightly (0.92-0.95)
‚Ä¢ Too casual: Decrease slightly (0.85-0.88)

‚ö†Ô∏è Default: 0.9 (Server clamps: 0.7-0.95)"></i>
                      </label>
                      <input type="number" step="0.05" min="0.1" max="1" id="llm-adv-compliance-topP" placeholder="0.9" style="width:90px; padding:6px 8px; font-size:12px; border-radius:6px; border:1px solid #e5e7eb;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px; position:relative;">
                      <label style="font-size:11px; font-weight:600; color:#111827;">
                        max_tokens
                        <i class="fas fa-info-circle" style="margin-left:4px; color:#3b82f6; cursor:help; font-size:10px;" title="MAXIMUM RESPONSE LENGTH

üéØ What it does:
Controls how long the LLM's scenario draft can be.

üìä Token Guide:
‚Ä¢ 1 token ‚âà 0.75 words
‚Ä¢ 2200 tokens ‚âà 1650 words ‚âà 3 pages
‚Ä¢ 2600 tokens ‚âà 1950 words ‚âà 4 pages
‚Ä¢ 3000 tokens ‚âà 2250 words ‚âà 4.5 pages

üí° Why it matters:
Lower = concise, focused scenarios (faster, cheaper)
Higher = detailed, thorough scenarios (more context)

üîß When to adjust:
‚Ä¢ Simple scenarios: Use DEFAULT (2200) - plenty for most
‚Ä¢ Complex flows: Increase (2400-2600) for more detail
‚Ä¢ Getting cut off: Increase max_tokens
‚Ä¢ Too verbose: Decrease max_tokens

‚ö†Ô∏è Default: 2200 (Server clamps: 1200-2600)"></i>
                      </label>
                      <input type="number" step="50" min="500" max="3200" id="llm-adv-compliance-maxTokens" placeholder="2200" style="width:100px; padding:6px 8px; font-size:12px; border-radius:6px; border:1px solid #e5e7eb;" />
                    </div>
                  </div>
                </div>

                <!-- Call Center -->
                <div style="border:1px solid #e5e7eb; border-radius:8px; padding:14px; background:#fafafa;">
                  <div style="font-size:14px; font-weight:600; margin-bottom:10px; color:#111827;">
                    <i class="fas fa-phone-alt mr-1 text-blue-600"></i>Call Center Optimized Overrides
                  </div>
                  <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <div style="display:flex; flex-direction:column; gap:4px; position:relative;">
                      <label style="font-size:11px; font-weight:600; color:#111827;">
                        Temperature
                        <i class="fas fa-info-circle" style="margin-left:4px; color:#3b82f6; cursor:help; font-size:10px;" title="CREATIVITY vs CONSISTENCY

üéØ What it does:
Controls how creative or consistent the LLM responses are.

üìä Scale:
‚Ä¢ 0.0-0.2 = Robot mode (exact same response every time)
‚Ä¢ 0.2-0.4 = Consistent (slight variation, professional)
‚Ä¢ 0.4-0.6 = Balanced (natural human-like responses)
‚Ä¢ 0.6-1.0 = Creative (lots of variety, less predictable)

üí° Why it matters:
Lower temperature = safer, more predictable (good for compliance)
Higher temperature = more natural, less robotic (good for conversation)

üîß When to adjust:
‚Ä¢ Legal/Medical: Keep LOW (0.1-0.2) for consistency
‚Ä¢ General business: Use DEFAULT (0.2-0.35) for balance
‚Ä¢ Creative brainstorming: Go HIGHER (0.5-0.7) for variety

‚ö†Ô∏è Default: 0.35 (Call center balance - natural but reliable)"></i>
                      </label>
                      <input type="number" step="0.05" min="0" max="1" id="llm-adv-callcenter-temp" placeholder="0.35" style="width:90px; padding:6px 8px; font-size:12px; border-radius:6px; border:1px solid #e5e7eb;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px; position:relative;">
                      <label style="font-size:11px; font-weight:600; color:#111827;">
                        top_p
                        <i class="fas fa-info-circle" style="margin-left:4px; color:#3b82f6; cursor:help; font-size:10px;" title="VOCABULARY DIVERSITY

üéØ What it does:
Controls how diverse the vocabulary is in responses.

üìä Scale:
‚Ä¢ 0.5 = Only very common words (formal, repetitive)
‚Ä¢ 0.9 = Balanced vocabulary (natural, professional)
‚Ä¢ 1.0 = All words available (can be too creative)

üí° Why it matters:
Lower top_p = safer vocabulary, fewer surprises
Higher top_p = richer vocabulary, more expressive

üîß When to adjust:
‚Ä¢ Formal settings: Keep DEFAULT (0.9) - works for 99% of cases
‚Ä¢ Too robotic: Increase slightly (0.92-0.95)
‚Ä¢ Too casual: Decrease slightly (0.85-0.88)

‚ö†Ô∏è Default: 0.9 (Optimal for call center - natural and professional)"></i>
                      </label>
                      <input type="number" step="0.05" min="0.1" max="1" id="llm-adv-callcenter-topP" placeholder="0.9" style="width:90px; padding:6px 8px; font-size:12px; border-radius:6px; border:1px solid #e5e7eb;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px; position:relative;">
                      <label style="font-size:11px; font-weight:600; color:#111827;">
                        max_tokens
                        <i class="fas fa-info-circle" style="margin-left:4px; color:#3b82f6; cursor:help; font-size:10px;" title="MAXIMUM RESPONSE LENGTH

üéØ What it does:
Controls how long the LLM's scenario draft can be.

üìä Token Guide:
‚Ä¢ 1 token ‚âà 0.75 words
‚Ä¢ 2200 tokens ‚âà 1650 words ‚âà 3 pages
‚Ä¢ 2600 tokens ‚âà 1950 words ‚âà 4 pages
‚Ä¢ 3000 tokens ‚âà 2250 words ‚âà 4.5 pages

üí° Why it matters:
Lower = concise, focused scenarios (faster, cheaper)
Higher = detailed, thorough scenarios (more context)

üîß When to adjust:
‚Ä¢ Simple scenarios: Use DEFAULT (2200) - plenty for most
‚Ä¢ Complex flows: Increase (2400-2600) for more detail
‚Ä¢ Getting cut off: Increase max_tokens
‚Ä¢ Too verbose: Decrease max_tokens

‚ö†Ô∏è Default: 2600 (Call center - slightly more detail for complex flows)"></i>
                      </label>
                      <input type="number" step="50" min="500" max="3200" id="llm-adv-callcenter-maxTokens" placeholder="2600" style="width:100px; padding:6px 8px; font-size:12px; border-radius:6px; border:1px solid #e5e7eb;" />
                    </div>
                  </div>
                </div>

                <!-- Creative -->
                <div style="border:1px solid #e5e7eb; border-radius:8px; padding:14px; background:#fafafa;">
                  <div style="font-size:14px; font-weight:600; margin-bottom:10px; color:#111827;">
                    <i class="fas fa-lightbulb mr-1 text-purple-600"></i>Creative Exploration Overrides
                  </div>
                  <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <div style="display:flex; flex-direction:column; gap:4px; position:relative;">
                      <label style="font-size:11px; font-weight:600; color:#111827;">
                        Temperature
                        <i class="fas fa-info-circle" style="margin-left:4px; color:#3b82f6; cursor:help; font-size:10px;" title="CREATIVITY vs CONSISTENCY

üéØ What it does:
Controls how creative or consistent the LLM responses are.

üìä Scale:
‚Ä¢ 0.0-0.2 = Robot mode (exact same response every time)
‚Ä¢ 0.2-0.4 = Consistent (slight variation, professional)
‚Ä¢ 0.4-0.6 = Balanced (natural human-like responses)
‚Ä¢ 0.6-1.0 = Creative (lots of variety, less predictable)

üí° Why it matters:
Lower temperature = safer, more predictable (good for compliance)
Higher temperature = more natural, less robotic (good for conversation)

üîß When to adjust:
‚Ä¢ Legal/Medical: Keep LOW (0.1-0.2) for consistency
‚Ä¢ General business: Use DEFAULT (0.2-0.35) for balance
‚Ä¢ Creative brainstorming: Go HIGHER (0.5-0.7) for variety

‚ö†Ô∏è Default: 0.65 (Creative mode - lots of variation and ideas)"></i>
                      </label>
                      <input type="number" step="0.05" min="0" max="1" id="llm-adv-creative-temp" placeholder="0.65" style="width:90px; padding:6px 8px; font-size:12px; border-radius:6px; border:1px solid #e5e7eb;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px; position:relative;">
                      <label style="font-size:11px; font-weight:600; color:#111827;">
                        top_p
                        <i class="fas fa-info-circle" style="margin-left:4px; color:#3b82f6; cursor:help; font-size:10px;" title="VOCABULARY DIVERSITY

üéØ What it does:
Controls how diverse the vocabulary is in responses.

üìä Scale:
‚Ä¢ 0.5 = Only very common words (formal, repetitive)
‚Ä¢ 0.9 = Balanced vocabulary (natural, professional)
‚Ä¢ 1.0 = All words available (can be too creative)

üí° Why it matters:
Lower top_p = safer vocabulary, fewer surprises
Higher top_p = richer vocabulary, more expressive

üîß When to adjust:
‚Ä¢ Formal settings: Keep DEFAULT (0.9) - works for 99% of cases
‚Ä¢ Too robotic: Increase slightly (0.92-0.95)
‚Ä¢ Too casual: Decrease slightly (0.85-0.88)

‚ö†Ô∏è Default: 0.95 (Creative mode - broadest vocabulary range)"></i>
                      </label>
                      <input type="number" step="0.05" min="0.1" max="1" id="llm-adv-creative-topP" placeholder="0.95" style="width:90px; padding:6px 8px; font-size:12px; border-radius:6px; border:1px solid #e5e7eb;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px; position:relative;">
                      <label style="font-size:11px; font-weight:600; color:#111827;">
                        max_tokens
                        <i class="fas fa-info-circle" style="margin-left:4px; color:#3b82f6; cursor:help; font-size:10px;" title="MAXIMUM RESPONSE LENGTH

üéØ What it does:
Controls how long the LLM's scenario draft can be.

üìä Token Guide:
‚Ä¢ 1 token ‚âà 0.75 words
‚Ä¢ 2200 tokens ‚âà 1650 words ‚âà 3 pages
‚Ä¢ 2600 tokens ‚âà 1950 words ‚âà 4 pages
‚Ä¢ 3000 tokens ‚âà 2250 words ‚âà 4.5 pages

üí° Why it matters:
Lower = concise, focused scenarios (faster, cheaper)
Higher = detailed, thorough scenarios (more context)

üîß When to adjust:
‚Ä¢ Simple scenarios: Use DEFAULT (2200) - plenty for most
‚Ä¢ Complex flows: Increase (2400-2600) for more detail
‚Ä¢ Getting cut off: Increase max_tokens
‚Ä¢ Too verbose: Decrease max_tokens

‚ö†Ô∏è Default: 3000 (Creative mode - maximum detail and exploration)"></i>
                      </label>
                      <input type="number" step="50" min="500" max="3200" id="llm-adv-creative-maxTokens" placeholder="3000" style="width:100px; padding:6px 8px; font-size:12px; border-radius:6px; border:1px solid #e5e7eb;" />
                    </div>
                  </div>
                </div>

              </div>

              <div style="display:flex; justify-content:flex-end; gap:10px; padding-top:12px; border-top:1px solid #f3f4f6; margin-top:16px;">
                <button id="llm-settings-advanced-reset" style="padding:8px 14px; border-radius:8px; border:1px solid #e5e7eb; background:white; font-size:13px; cursor:pointer; font-weight:500; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                  <i class="fas fa-undo mr-1"></i>Reset
                </button>
                <button id="llm-settings-advanced-save" style="padding:8px 16px; border-radius:8px; border:none; background:#10b981; color:white; font-size:13px; font-weight:600; cursor:pointer; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                  <i class="fas fa-check mr-1"></i>Save Advanced
                </button>
              </div>
            </div>

            <!-- ‚ú® Prompt Editor Card - EDIT ALL LLM INSTRUCTIONS -->
            <div id="llm-settings-prompt-editor" class="llm-settings-card" style="display:none; background:white; border-radius:10px; border:1px solid #e5e7eb; padding:20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
              <div style="font-size:17px; font-weight:700; margin-bottom:6px; color:#111827;">
                <i class="fas fa-edit mr-2 text-blue-600"></i>Prompt Text Editor
              </div>
              <div style="font-size:13px; color:#6b7280; margin-bottom:16px; line-height:1.5;">
                Edit the exact text the LLM sees. Changes are saved to database and used immediately. Click "Reset" to restore recommended defaults.
              </div>

              <div style="background:#dbeafe; border:1px solid #3b82f6; border-radius:8px; padding:12px; margin-bottom:20px;">
                <div style="font-size:12px; font-weight:600; color:#1e40af; margin-bottom:6px;">
                  <i class="fas fa-info-circle mr-1"></i>Multi-Tenant Admin Tool
                </div>
                <div style="font-size:12px; color:#1e3a8a; line-height:1.5;">
                  You're managing 100+ clients across different industries. Edit these prompts when you need to customize for specific clients (e.g., change Medical Safety text for dental offices). Use "Reset to Default" if you make a mistake.
                </div>
              </div>

              <!-- 1. BASE PROMPT -->
              <div style="border:1px solid #e5e7eb; border-radius:10px; padding:16px; margin-bottom:16px; background:#fafafa;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                  <div>
                    <div style="font-size:15px; font-weight:700; color:#111827;">
                      <i class="fas fa-code mr-1 text-blue-600"></i>Base Scenario Architect Prompt
                    </div>
                    <div style="font-size:11px; color:#6b7280; margin-top:2px;">Always applied to every scenario generation request</div>
                  </div>
                  <button id="llm-prompt-base-reset" style="padding:6px 12px; border-radius:6px; border:1px solid #e5e7eb; background:white; font-size:11px; cursor:pointer; font-weight:600;" title="Reset to recommended default">
                    <i class="fas fa-undo mr-1"></i>Reset
                  </button>
                </div>
                <textarea id="llm-prompt-base-text" style="width:100%; min-height:200px; font-family:monospace; font-size:11px; padding:10px; border-radius:8px; border:1px solid #d1d5db; resize:vertical;" placeholder="Loading..."></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                  <div style="font-size:11px; color:#6b7280;">
                    <span id="llm-prompt-base-charcount">0</span> characters
                  </div>
                  <button id="llm-prompt-base-save" style="padding:6px 14px; border-radius:6px; border:none; background:#10b981; color:white; font-size:12px; font-weight:600; cursor:pointer;">
                    <i class="fas fa-save mr-1"></i>Save Base Prompt
                  </button>
                </div>
              </div>

              <!-- 2. COMPLIANCE-SAFE PROFILE -->
              <div style="border:1px solid #e5e7eb; border-radius:10px; padding:16px; margin-bottom:16px; background:#fafafa;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                  <div>
                    <div style="font-size:15px; font-weight:700; color:#111827;">
                      <i class="fas fa-shield-alt mr-1 text-green-600"></i>Compliance-Safe Profile Prompt
                    </div>
                    <div style="font-size:11px; color:#6b7280; margin-top:2px;">Applied when Compliance-Safe profile is active</div>
                  </div>
                  <button id="llm-prompt-profile-compliance-reset" style="padding:6px 12px; border-radius:6px; border:1px solid #e5e7eb; background:white; font-size:11px; cursor:pointer; font-weight:600;">
                    <i class="fas fa-undo mr-1"></i>Reset
                  </button>
                </div>
                <textarea id="llm-prompt-profile-compliance-text" style="width:100%; min-height:150px; font-family:monospace; font-size:11px; padding:10px; border-radius:8px; border:1px solid #d1d5db; resize:vertical;"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                  <div style="font-size:11px; color:#6b7280;">
                    <span id="llm-prompt-profile-compliance-charcount">0</span> characters
                  </div>
                  <button id="llm-prompt-profile-compliance-save" style="padding:6px 14px; border-radius:6px; border:none; background:#10b981; color:white; font-size:12px; font-weight:600; cursor:pointer;">
                    <i class="fas fa-save mr-1"></i>Save Prompt
                  </button>
                </div>
              </div>

              <!-- 3. CALL CENTER PROFILE -->
              <div style="border:1px solid #e5e7eb; border-radius:10px; padding:16px; margin-bottom:16px; background:#fafafa;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                  <div>
                    <div style="font-size:15px; font-weight:700; color:#111827;">
                      <i class="fas fa-phone-alt mr-1 text-blue-600"></i>Call Center Optimized Profile Prompt
                    </div>
                    <div style="font-size:11px; color:#6b7280; margin-top:2px;">Applied when Call Center Optimized profile is active</div>
                  </div>
                  <button id="llm-prompt-profile-callcenter-reset" style="padding:6px 12px; border-radius:6px; border:1px solid #e5e7eb; background:white; font-size:11px; cursor:pointer; font-weight:600;">
                    <i class="fas fa-undo mr-1"></i>Reset
                  </button>
                </div>
                <textarea id="llm-prompt-profile-callcenter-text" style="width:100%; min-height:150px; font-family:monospace; font-size:11px; padding:10px; border-radius:8px; border:1px solid #d1d5db; resize:vertical;"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                  <div style="font-size:11px; color:#6b7280;">
                    <span id="llm-prompt-profile-callcenter-charcount">0</span> characters
                  </div>
                  <button id="llm-prompt-profile-callcenter-save" style="padding:6px 14px; border-radius:6px; border:none; background:#10b981; color:white; font-size:12px; font-weight:600; cursor:pointer;">
                    <i class="fas fa-save mr-1"></i>Save Prompt
                  </button>
                </div>
              </div>

              <!-- 4. CREATIVE PROFILE -->
              <div style="border:1px solid #e5e7eb; border-radius:10px; padding:16px; margin-bottom:16px; background:#fafafa;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                  <div>
                    <div style="font-size:15px; font-weight:700; color:#111827;">
                      <i class="fas fa-lightbulb mr-1 text-purple-600"></i>Creative Exploration Profile Prompt
                    </div>
                    <div style="font-size:11px; color:#6b7280; margin-top:2px;">Applied when Creative Exploration profile is active</div>
                  </div>
                  <button id="llm-prompt-profile-creative-reset" style="padding:6px 12px; border-radius:6px; border:1px solid #e5e7eb; background:white; font-size:11px; cursor:pointer; font-weight:600;">
                    <i class="fas fa-undo mr-1"></i>Reset
                  </button>
                </div>
                <textarea id="llm-prompt-profile-creative-text" style="width:100%; min-height:150px; font-family:monospace; font-size:11px; padding:10px; border-radius:8px; border:1px solid #d1d5db; resize:vertical;"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                  <div style="font-size:11px; color:#6b7280;">
                    <span id="llm-prompt-profile-creative-charcount">0</span> characters
                  </div>
                  <button id="llm-prompt-profile-creative-save" style="padding:6px 14px; border-radius:6px; border:none; background:#10b981; color:white; font-size:12px; font-weight:600; cursor:pointer;">
                    <i class="fas fa-save mr-1"></i>Save Prompt
                  </button>
                </div>
              </div>

              <!-- 5. MEDICAL SAFETY -->
              <div style="border:1px solid #e5e7eb; border-radius:10px; padding:16px; margin-bottom:16px; background:#fafafa;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                  <div>
                    <div style="font-size:15px; font-weight:700; color:#111827;">
                      <i class="fas fa-heartbeat mr-1 text-red-600"></i>Medical Office Safety Mode Prompt
                    </div>
                    <div style="font-size:11px; color:#6b7280; margin-top:2px;">Applied when Medical Office Safety Mode is enabled</div>
                  </div>
                  <button id="llm-prompt-domain-medical-reset" style="padding:6px 12px; border-radius:6px; border:1px solid #e5e7eb; background:white; font-size:11px; cursor:pointer; font-weight:600;">
                    <i class="fas fa-undo mr-1"></i>Reset
                  </button>
                </div>
                <textarea id="llm-prompt-domain-medical-text" style="width:100%; min-height:150px; font-family:monospace; font-size:11px; padding:10px; border-radius:8px; border:1px solid #d1d5db; resize:vertical;"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                  <div style="font-size:11px; color:#6b7280;">
                    <span id="llm-prompt-domain-medical-charcount">0</span> characters
                  </div>
                  <button id="llm-prompt-domain-medical-save" style="padding:6px 14px; border-radius:6px; border:none; background:#10b981; color:white; font-size:12px; font-weight:600; cursor:pointer;">
                    <i class="fas fa-save mr-1"></i>Save Prompt
                  </button>
                </div>
              </div>

              <!-- 6. FINANCIAL SAFETY -->
              <div style="border:1px solid #e5e7eb; border-radius:10px; padding:16px; margin-bottom:16px; background:#fafafa;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                  <div>
                    <div style="font-size:15px; font-weight:700; color:#111827;">
                      <i class="fas fa-dollar-sign mr-1 text-green-600"></i>Financial Safety Mode Prompt
                    </div>
                    <div style="font-size:11px; color:#6b7280; margin-top:2px;">Applied when Financial Safety Mode is enabled</div>
                  </div>
                  <button id="llm-prompt-domain-financial-reset" style="padding:6px 12px; border-radius:6px; border:1px solid #e5e7eb; background:white; font-size:11px; cursor:pointer; font-weight:600;">
                    <i class="fas fa-undo mr-1"></i>Reset
                  </button>
                </div>
                <textarea id="llm-prompt-domain-financial-text" style="width:100%; min-height:150px; font-family:monospace; font-size:11px; padding:10px; border-radius:8px; border:1px solid #d1d5db; resize:vertical;"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                  <div style="font-size:11px; color:#6b7280;">
                    <span id="llm-prompt-domain-financial-charcount">0</span> characters
                  </div>
                  <button id="llm-prompt-domain-financial-save" style="padding:6px 14px; border-radius:6px; border:none; background:#10b981; color:white; font-size:12px; font-weight:600; cursor:pointer;">
                    <i class="fas fa-save mr-1"></i>Save Prompt
                  </button>
                </div>
              </div>

              <!-- 7. EMERGENCY SAFETY -->
              <div style="border:1px solid #e5e7eb; border-radius:10px; padding:16px; margin-bottom:16px; background:#fafafa;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                  <div>
                    <div style="font-size:15px; font-weight:700; color:#111827;">
                      <i class="fas fa-exclamation-triangle mr-1 text-yellow-600"></i>Emergency Services Safety Mode Prompt
                    </div>
                    <div style="font-size:11px; color:#6b7280; margin-top:2px;">Applied when Emergency Services Safety Mode is enabled</div>
                  </div>
                  <button id="llm-prompt-domain-emergency-reset" style="padding:6px 12px; border-radius:6px; border:1px solid #e5e7eb; background:white; font-size:11px; cursor:pointer; font-weight:600;">
                    <i class="fas fa-undo mr-1"></i>Reset
                  </button>
                </div>
                <textarea id="llm-prompt-domain-emergency-text" style="width:100%; min-height:150px; font-family:monospace; font-size:11px; padding:10px; border-radius:8px; border:1px solid #d1d5db; resize:vertical;"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                  <div style="font-size:11px; color:#6b7280;">
                    <span id="llm-prompt-domain-emergency-charcount">0</span> characters
                  </div>
                  <button id="llm-prompt-domain-emergency-save" style="padding:6px 14px; border-radius:6px; border:none; background:#10b981; color:white; font-size:12px; font-weight:600; cursor:pointer;">
                    <i class="fas fa-save mr-1"></i>Save Prompt
                  </button>
                </div>
              </div>

              <!-- 8. STRICT COMPLIANCE -->
              <div style="border:1px solid #e5e7eb; border-radius:10px; padding:16px; margin-bottom:16px; background:#fafafa;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                  <div>
                    <div style="font-size:15px; font-weight:700; color:#111827;">
                      <i class="fas fa-lock mr-1 text-red-600"></i>Strict Compliance Mode Prompt
                    </div>
                    <div style="font-size:11px; color:#6b7280; margin-top:2px;">Applied when Strict Compliance Mode is enabled</div>
                  </div>
                  <button id="llm-prompt-strict-reset" style="padding:6px 12px; border-radius:6px; border:1px solid #e5e7eb; background:white; font-size:11px; cursor:pointer; font-weight:600;">
                    <i class="fas fa-undo mr-1"></i>Reset
                  </button>
                </div>
                <textarea id="llm-prompt-strict-text" style="width:100%; min-height:100px; font-family:monospace; font-size:11px; padding:10px; border-radius:8px; border:1px solid #d1d5db; resize:vertical;"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                  <div style="font-size:11px; color:#6b7280;">
                    <span id="llm-prompt-strict-charcount">0</span> characters
                  </div>
                  <button id="llm-prompt-strict-save" style="padding:6px 14px; border-radius:6px; border:none; background:#10b981; color:white; font-size:12px; font-weight:600; cursor:pointer;">
                    <i class="fas fa-save mr-1"></i>Save Prompt
                  </button>
                </div>
              </div>

              <!-- RESET ALL PROMPTS BUTTON -->
              <div style="background:#fef3c7; border:1px solid #fcd34d; border-radius:8px; padding:16px; margin-top:24px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <div>
                    <div style="font-size:14px; font-weight:700; color:#92400e; margin-bottom:4px;">
                      <i class="fas fa-exclamation-triangle mr-1"></i>Reset All Prompts to Defaults
                    </div>
                    <div style="font-size:12px; color:#78350f;">
                      This will restore ALL 8 prompt sections to recommended defaults. Use if you've made mistakes and want to start fresh.
                    </div>
                  </div>
                  <button id="llm-prompt-reset-all" style="padding:10px 18px; border-radius:8px; border:1px solid #f59e0b; background:white; font-size:13px; cursor:pointer; font-weight:700; color:#f59e0b; white-space:nowrap; transition: all 0.2s;" onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='white'">
                    <i class="fas fa-undo-alt mr-1"></i>Reset All Prompts
                  </button>
                </div>
              </div>

            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- ============================================ -->
    <!-- BULK UPLOAD SCENARIOS MODAL -->
    <!-- ============================================ -->
    <div id="bulk-upload-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
            
            <!-- Header -->
            <div style="display: flex; align-items: center; justify-between; margin-bottom: 20px;">
                <h2 style="font-size: 28px; font-weight: 700; color: #2c3e50; margin: 0;">
                    <i class="fas fa-file-upload text-purple-600 mr-2"></i>
                    Bulk Upload Scenarios
                </h2>
                <button onclick="closeBulkUploadModal()" style="background: none; border: none; font-size: 32px; color: #95a5a6; cursor: pointer;">
                    &times;
                </button>
            </div>

            <!-- Info Box -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; align-items: start; gap: 16px;">
                    <i class="fas fa-info-circle" style="font-size: 24px; margin-top: 2px;"></i>
                    <div>
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700;">Enterprise Bulk Loader</h3>
                        <p style="margin: 0; font-size: 14px; line-height: 1.6; opacity: 0.95;">
                            Upload a CSV file to create multiple scenarios at once. System includes:
                            ‚úÖ Pre-validation (no writes until perfect)
                            ‚úÖ Atomic transactions (all or nothing)
                            ‚úÖ Auto-rollback on errors
                            ‚úÖ Detailed error reporting
                        </p>
                    </div>
                </div>
            </div>

            <!-- Step 1: Download Template -->
            <div style="border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <div style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">1</div>
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #2c3e50;">Download CSV Template</h3>
                </div>
                <p style="margin: 0 0 16px 0; color: #6c757d; font-size: 14px;">
                    Start with our clean CSV template with all 33 fields ready to fill.
                </p>
                <div style="display: flex; gap: 12px;">
                    <a href="/SCENARIO-BULK-LOADER-CSV-TEMPLATE.csv" download="scenario-template.csv" style="background: #667eea; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                        <i class="fas fa-download"></i>
                        Download CSV Template
                    </a>
                    <a href="https://raw.githubusercontent.com/chatterlinx/clientsvia-backend/main/docs/SCENARIO-CSV-QUICK-REFERENCE.md" target="_blank" style="background: #f8f9fa; color: #495057; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; border: 2px solid #dee2e6; display: inline-flex; align-items: center; gap: 8px;">
                        <i class="fas fa-book"></i>
                        Field Reference
                    </a>
                </div>
            </div>

            <!-- Step 2: Fill CSV -->
            <div style="border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <div style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">2</div>
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #2c3e50;">Fill CSV with Your Scenarios</h3>
                </div>
                <p style="margin: 0; color: #6c757d; font-size: 14px;">
                    <strong>Minimum required fields:</strong> name, status, priority, triggers, min_confidence, behavior, quick_replies, full_replies
                </p>
                <p style="margin: 8px 0 0 0; color: #6c757d; font-size: 14px;">
                    Use the Quick Reference guide for field explanations ("info icon" style lookup).
                </p>
            </div>

            <!-- Step 3: Upload & Validate -->
            <div style="border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <div style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">3</div>
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #2c3e50;">Upload & Validate</h3>
                </div>
                
                <!-- File Upload Area -->
                <div id="csv-upload-area" style="border: 3px dashed #dee2e6; border-radius: 12px; padding: 40px; text-align: center; background: #f8f9fa; cursor: pointer; transition: all 0.3s;" onclick="document.getElementById('csv-file-input').click()">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #667eea; margin-bottom: 16px;"></i>
                    <p style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600; color: #2c3e50;">
                        Click to upload CSV or drag & drop
                    </p>
                    <p style="margin: 0; font-size: 14px; color: #6c757d;">
                        CSV file, UTF-8 encoding, max 10MB
                    </p>
                    <input type="file" id="csv-file-input" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                </div>

                <!-- Selected File Display -->
                <div id="selected-file-display" style="display: none; margin-top: 16px; padding: 16px; background: #e7f3ff; border: 2px solid #90cdf4; border-radius: 8px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-file-csv" style="font-size: 24px; color: #667eea;"></i>
                            <div>
                                <p id="selected-file-name" style="margin: 0; font-weight: 600; color: #2c3e50;"></p>
                                <p id="selected-file-size" style="margin: 4px 0 0 0; font-size: 13px; color: #6c757d;"></p>
                            </div>
                        </div>
                        <button onclick="clearCSVFile()" style="background: white; border: 2px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; color: #6c757d;">
                            <i class="fas fa-times mr-1"></i> Remove
                        </button>
                    </div>
                </div>

                <!-- Validation Results -->
                <div id="validation-results" style="display: none; margin-top: 16px;"></div>
            </div>

            <!-- Step 4: Load Scenarios -->
            <div style="border: 2px solid #e9ecef; border-radius: 12px; padding: 20px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <div style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">4</div>
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #2c3e50;">Load Scenarios</h3>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button id="validate-btn" onclick="validateCSVFile()" disabled style="flex: 1; background: #3b82f6; color: white; padding: 14px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 15px; opacity: 0.5;">
                        <i class="fas fa-check-circle mr-2"></i>
                        Validate Only
                    </button>
                    <button id="load-btn" onclick="loadScenariosFromCSV()" disabled style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 15px; opacity: 0.5; box-shadow: 0 4px 12px rgba(102,126,234,0.4);">
                        <i class="fas fa-rocket mr-2"></i>
                        Load Scenarios
                    </button>
                </div>

                <p style="margin: 16px 0 0 0; font-size: 13px; color: #6c757d; text-align: center;">
                    <i class="fas fa-shield-alt mr-1"></i>
                    Safe to load: Atomic transactions ensure all-or-nothing writes
                </p>
            </div>

            <!-- Progress Bar -->
            <div id="upload-progress" style="display: none; margin-top: 20px;">
                <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <span id="progress-text" style="font-weight: 600; color: #2c3e50;">Loading scenarios...</span>
                        <span id="progress-count" style="font-weight: 600; color: #667eea;">0 / 0</span>
                    </div>
                    <div style="background: #e9ecef; border-radius: 8px; height: 12px; overflow: hidden;">
                        <div id="progress-bar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ============================================ -->
    <!-- QUICK PASTE LOADER MODAL -->
    <!-- ============================================ -->
    <div id="quick-paste-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
            
            <!-- Header -->
            <div style="display: flex; align-items: center; justify-between; margin-bottom: 20px;">
                <h2 style="font-size: 28px; font-weight: 700; color: #2c3e50; margin: 0;">
                    <i class="fas fa-paste text-emerald-600 mr-2"></i>
                    Quick Paste & Submit
                </h2>
                <button onclick="closeQuickPasteModal()" style="background: none; border: none; font-size: 32px; color: #95a5a6; cursor: pointer;">
                    &times;
                </button>
            </div>

            <!-- Info Box -->
            <div style="background: #10b981; color: white; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; align-items: start; gap: 16px;">
                    <i class="fas fa-info-circle" style="font-size: 24px; margin-top: 2px;"></i>
                    <div>
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700;">No CSV Files Required!</h3>
                        <p style="margin: 0; font-size: 14px; line-height: 1.6; opacity: 0.95;">
                            Copy the CSV output from your AI partner and paste it directly below. System will auto-parse, validate, and load scenarios.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Step 1: Template & Category Selection -->
            <div style="background: #d1fae5; border-radius: 12px; padding: 24px; margin-bottom: 24px; border: 1px solid #10b981;">
                <h3 style="font-size: 18px; font-weight: 700; color: #065f46; margin: 0 0 16px 0;">
                    <span style="display: inline-block; background: #10b981; color: white; width: 28px; height: 28px; border-radius: 50%; text-align: center; line-height: 28px; font-size: 14px; margin-right: 8px;">1</span>
                    Select Target Template & Category
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                            Template <span style="color: #e74c3c;">*</span>
                        </label>
                        <select id="quick-paste-template" onchange="loadCategoriesForQuickPaste()" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px;">
                            <option value="">Select template...</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                            Category <span style="color: #e74c3c;">*</span>
                        </label>
                        <select id="quick-paste-category" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px;" disabled>
                            <option value="">Select template first...</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Step 2: Paste CSV Content -->
            <div style="background: #d1fae5; border-radius: 12px; padding: 24px; margin-bottom: 24px; border: 1px solid #10b981;">
                <h3 style="font-size: 18px; font-weight: 700; color: #065f46; margin: 0 0 16px 0;">
                    <span style="display: inline-block; background: #10b981; color: white; width: 28px; height: 28px; border-radius: 50%; text-align: center; line-height: 28px; font-size: 14px; margin-right: 8px;">2</span>
                    Paste CSV Content (Header + Rows)
                </h3>
                <textarea id="quick-paste-content" placeholder="Paste your CSV content here (including the header row)..." style="width: 100%; height: 300px; padding: 16px; border: 2px solid #dee2e6; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; resize: vertical;"></textarea>
                <div style="display: flex; align-items: center; gap: 12px; margin-top: 12px;">
                    <button onclick="validateQuickPaste()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-check-circle mr-2"></i>Validate
                    </button>
                    <button onclick="clearQuickPaste()" style="padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-times-circle mr-2"></i>Clear
                    </button>
                    <span id="quick-paste-count" style="color: #7f8c8d; font-size: 14px; font-weight: 600;"></span>
                </div>
            </div>

            <!-- Validation Results -->
            <div id="quick-paste-validation" style="display: none; margin-bottom: 24px;"></div>

            <!-- Step 3: Load Scenarios -->
            <div style="background: #d1fae5; border-radius: 12px; padding: 24px; border: 1px solid #10b981;">
                <h3 style="font-size: 18px; font-weight: 700; color: #065f46; margin: 0 0 16px 0;">
                    <span style="display: inline-block; background: #10b981; color: white; width: 28px; height: 28px; border-radius: 50%; text-align: center; line-height: 28px; font-size: 14px; margin-right: 8px;">3</span>
                    Load Scenarios
                </h3>
                <div style="display: flex; gap: 12px;">
                    <button id="quick-paste-load-btn" onclick="loadScenariosFromQuickPaste()" style="padding: 12px 24px; background: #10b981; color: white; border: 3px solid #000000; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 16px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);" disabled>
                        <i class="fas fa-rocket mr-2"></i>Load All Scenarios
                    </button>
                    <button onclick="closeQuickPasteModal()" style="padding: 12px 24px; background: #95a5a6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>

            <!-- Progress Bar -->
            <div id="quick-paste-progress" style="display: none; margin-top: 20px;">
                <div style="background: #d1fae5; border-radius: 8px; padding: 20px; border: 1px solid #10b981;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <span id="quick-paste-progress-text" style="font-weight: 600; color: #2c3e50;">Loading scenarios...</span>
                        <span id="quick-paste-progress-count" style="font-weight: 600; color: #10b981;">0 / 0</span>
                    </div>
                    <div style="background: #e9ecef; border-radius: 8px; height: 12px; overflow: hidden;">
                        <div id="quick-paste-progress-bar" style="background: #10b981; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ============================================ -->
    <!-- ============================================ -->
    <!-- ‚ùå LEGACY/DELETED: ADD SCENARIO MODAL - DO NOT USE -->
    <!-- ============================================ -->
    <!-- This modal is DEPRECATED and should NOT be used.
         Use 'scenario-modal' (the BIG 4-page form) instead.
         Kept here only to prevent JS errors from old references. -->

    <!-- ‚ùå LEGACY ADD-SCENARIO-MODAL DELETED (lines 4119-4188) -->
    <!-- See commit history if restoration needed -->


    <!-- ============================================ -->
    <!-- JAVASCRIPT -->
    <!-- ============================================ -->
    <!-- 
    üö® CRITICAL WARNING (Oct 2025 - 4+ hour debugging nightmare):
    
    This <script> tag MUST be properly closed with </script> at the end of the file!
    
    SYMPTOMS IF NOT CLOSED:
    - All tabs fail to open (onclick functions not found)
    - Browser console: "ReferenceError: switchTab is not defined"
    - Functions exist in code but are not accessible globally
    - HTML structure appears normal but is actually broken
    
    ROOT CAUSE:
    - If this <script> tag is never closed, the entire rest of the file
      is treated as JavaScript code, not HTML
    - Functions defined inside are scoped locally, not globally
    - onclick="functionName()" fails because functions are not in global scope
    
    HOW TO VERIFY:
    1. Check line count of this file (should be ~11,370 lines)
    2. Last 4 lines MUST be:
       - Line N-3: });  (closes DOMContentLoaded)
       - Line N-2: </script>  (closes THIS script tag)
       - Line N-1: </body>
       - Line N: </html>
    3. Test by clicking any tab - if "switchTab is not defined", script is not closed!
    
    ‚ö†Ô∏è DO NOT REMOVE OR FORGET THIS CLOSING TAG - it breaks the entire UI!
    -->
    <script>
        // Set current year in footer
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // ============================================
        // GLOBAL STATE
        // ============================================
        let activeTemplate = null;
        let activeTemplateId = null;
        let currentScenarioCount = 0;
        let availableBehaviors = []; // Loaded dynamically from database
        let currentScenarioEditMode = null; // 'add' or 'edit'
        let currentScenarioData = null; // { categoryId, categoryName, scenarioId }

        // ============================================
        // AUTHENTICATION
        // ============================================
        function getAuthToken() {
            return localStorage.getItem('adminToken');
        }

        // ============================================
        // GLOBAL TOAST HELPER
        // ============================================
        /**
         * Safe toast notification helper
         * @param {string} type - 'success', 'error', 'info', 'warning'
         * @param {string} message - Toast message
         * @param {object} options - Additional toast options
         */
        function showToast(type, message, options) {
            if (window.ToastManager && window.ToastManager[type]) {
                window.ToastManager[type](message, options);
            } else {
                console.log(`[TOAST ${type.toUpperCase()}] ${message}`);
            }
        }

        // ============================================
        // INITIALIZE ERROR REPORTERS (One per module)
        // ============================================
        const errorReporters = {
            behaviors: new FrontendErrorReporter({
                context: 'Global AI Brain',
                module: 'Behaviors'
            }),
            templates: new FrontendErrorReporter({
                context: 'Global AI Brain',
                module: 'Templates'
            }),
            categories: new FrontendErrorReporter({
                context: 'Global AI Brain',
                module: 'Categories'
            }),
            scenarios: new FrontendErrorReporter({
                context: 'Global AI Brain',
                module: 'Scenarios'
            }),
            testing: new FrontendErrorReporter({
                context: 'Global AI Brain',
                module: 'Testing Center'
            }),
            intelligence: new FrontendErrorReporter({
                context: 'Global AI Brain',
                module: 'Intelligence'
            }),
            settings: new FrontendErrorReporter({
                context: 'Global AI Brain',
                module: 'Settings'
            })
        };

        // ============================================
        // FETCH BEHAVIORS FROM DATABASE
        // ============================================
        async function fetchBehaviors() {
            try {
                const token = getAuthToken();
                const response = await fetch('/api/admin/global-behaviors', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                availableBehaviors = result.data || [];
                console.log(`‚úÖ Loaded ${availableBehaviors.length} behaviors from database`);
                
                // ============================================
                // EMPTY STATE DETECTION (Strategic Checkpoint)
                // ============================================
                // API succeeded but returned empty data - this is not an "error"
                // but it's a configuration issue that needs attention
                // 
                // BYPASS PATTERN DETECTION: Empty critical tables warrant immediate alerts
                if (availableBehaviors.length === 0) {
                    console.warn('‚ö†Ô∏è Behaviors loaded successfully but database is empty');
                    
                    // Send IMMEDIATE notification to backend (bypass pattern detection)
                    try {
                        const response = await fetch('/api/admin/notifications/frontend-error', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${getAuthToken()}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                error: {
                                    message: 'EMPTY_STATE: Behaviors database is empty',
                                    name: 'EmptyStateError',
                                    stack: 'Empty state detected in fetchBehaviors()'
                                },
                                context: {
                                    operation: 'fetchBehaviors_emptyState',
                                    module: 'Behaviors',
                                    page: 'Global AI Brain',
                                    endpoint: '/api/admin/global-behaviors',
                                    severity: 'INFO',
                                    bypassPatternDetection: true // IMMEDIATE ALERT
                                },
                                additionalContext: {
                                    apiStatus: 'SUCCESS',
                                    httpCode: result.success ? 200 : 500,
                                    dataReturned: 'Empty array',
                                    issue: 'Database has 0 behaviors',
                                    suggestedFix: 'Run: node scripts/seed-behaviors-quick.js',
                                    impact: 'Users cannot select behaviors for categories/scenarios',
                                    notificationType: 'EMPTY_STATE_WARNING',
                                    userMessage: 'AI Behavior templates are missing. The database needs to be seeded with default behaviors.'
                                }
                            })
                        });
                        
                        if (response.ok) {
                            console.log('‚úÖ Empty state alert sent to Notification Center');
                        } else {
                            console.error('‚ùå Failed to send empty state alert:', await response.text());
                        }
                    } catch (notifError) {
                        console.error('‚ùå Error sending empty state notification:', notifError);
                    }
                }
                
                return availableBehaviors;
            } catch (error) {
                console.error('‚ùå Error fetching behaviors:', error);
                
                // Report error to Notification Center
                await errorReporters.behaviors.reportError({
                    error,
                    operation: 'fetchBehaviors',
                    userMessage: 'Failed to load AI behavior templates. The Behaviors tab may be empty.',
                    retryFunction: fetchBehaviors,
                    additionalContext: {
                        endpoint: '/api/admin/global-behaviors',
                        expectedDataType: 'AI Behavior Templates'
                    }
                });
                
                return [];
            }
        }

        // ============================================
        // POPULATE BEHAVIOR DROPDOWN
        // ============================================
        function populateBehaviorDropdown(selectElementId) {
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) {
                console.error(`Dropdown element ${selectElementId} not found`);
                return;
            }

            // Clear existing options except the first "Select behavior..."
            selectElement.innerHTML = '<option value="">Select behavior...</option>';

            // Add behaviors from database
            availableBehaviors.forEach(behavior => {
                const option = document.createElement('option');
                option.value = behavior.behaviorId;
                option.textContent = `${behavior.icon} ${behavior.name}`;
                selectElement.appendChild(option);
            });
        }

        function handleLogout(event) {
            event.preventDefault();
            localStorage.removeItem('adminToken');
            window.location.href = '/login.html';
        }

        // ============================================
        // API CALLS
        // ============================================
        async function fetchActiveTemplate() {
            try {
                console.log('üîç [DEBUG] Fetching active template...');
                const token = getAuthToken();
                console.log('üîç [DEBUG] Auth token:', token ? 'Present' : 'Missing');
                
                const response = await fetch('/api/admin/global-instant-responses/active', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üîç [DEBUG] Response status:', response.status);
                console.log('üîç [DEBUG] Response ok:', response.ok);

                if (response.status === 404) {
                    console.log('‚ö†Ô∏è [DEBUG] 404 - No template found');
                    renderNoTemplateMessage();
                    return null;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ [DEBUG] Template data received:', result);
                activeTemplate = result.data;
                activeTemplateId = result.data._id;
                window.activeTemplateId = result.data._id; // Make available to template-settings-manager.js
                window.activeTemplate = result.data; // Make available to loadSuggestions()
                updateDashboardStats();
                renderCategories();
                return activeTemplate;
            } catch (error) {
                console.error('‚ùå [DEBUG] Error fetching active template:', error);
                showNotification('Failed to load active template', 'error');
                
                // Report error to Notification Center
                await errorReporters.templates.reportError({
                    error,
                    operation: 'fetchActiveTemplate',
                    userMessage: 'Failed to load active AI template. Dashboard may be incomplete.',
                    retryFunction: fetchActiveTemplate,
                    additionalContext: {
                        endpoint: '/api/admin/global-instant-responses/active',
                        expectedDataType: 'Active Template Data'
                    }
                });
                
                return null;
            }
        }

        async function saveTemplate(templateData) {
            try {
                const token = getAuthToken();
                const response = await fetch('/api/admin/global-instant-responses', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                showNotification('Template created successfully!', 'success');
                return result.data;
            } catch (error) {
                console.error('Error saving template:', error);
                showNotification('Failed to save template', 'error');
                
                // Report error to Notification Center
                await errorReporters.templates.reportError({
                    error,
                    operation: 'createTemplate',
                    userMessage: 'Failed to create new AI template. Template was not saved.',
                    retryFunction: () => saveTemplate(templateData),
                    additionalContext: {
                        endpoint: '/api/admin/global-instant-responses',
                        templateName: templateData?.name,
                        templateType: templateData?.type
                    }
                });
                
                return null;
            }
        }

        async function updateTemplate(templateId, updates) {
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-instant-responses/${templateId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                showNotification('Template updated successfully!', 'success');
                await fetchActiveTemplate();
                return result.data;
            } catch (error) {
                console.error('Error updating template:', error);
                showNotification('Failed to update template', 'error');
                
                // Report error to Notification Center
                await errorReporters.templates.reportError({
                    error,
                    operation: 'updateTemplate',
                    userMessage: 'Failed to update AI template. Changes were not saved.',
                    retryFunction: () => updateTemplate(templateId, updates),
                    additionalContext: {
                        endpoint: `/api/admin/global-instant-responses/${templateId}`,
                        templateId,
                        updateFields: Object.keys(updates || {}).join(', ')
                    }
                });
                
                return null;
            }
        }

        // ============================================
        // RENDERING FUNCTIONS
        // ============================================
        function renderNoTemplateMessage() {
            const container = document.getElementById('active-template-container');
            container.innerHTML = `
                <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-8 text-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-5xl mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">No Active Template Found</h3>
                    <p class="text-gray-600 mb-6">Seed the Universal template or create an industry-specific template to get started.</p>
                    <button onclick="openCreateTemplateModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus-circle mr-2"></i>
                        Create Template
                    </button>
                </div>
            `;
        }

        function renderCategories() {
            console.log('üé® [RENDER CATEGORIES] ===== START =====');
            console.log('üé® [RENDER CATEGORIES] activeTemplate ID:', activeTemplate?._id);
            console.log('üé® [RENDER CATEGORIES] activeTemplate Name:', activeTemplate?.name);
            console.log('üé® [RENDER CATEGORIES] Total categories in template:', activeTemplate?.categories?.length || 0);
            console.log('üé® [RENDER CATEGORIES] All category names:', activeTemplate?.categories?.map(c => c.name));
            
            if (!activeTemplate || !activeTemplate.categories) {
                console.log('‚ö†Ô∏è [RENDER CATEGORIES] No active template or categories found');
                const container = document.getElementById('categories-container');
                if (container) {
                    container.innerHTML = `
                        <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-12 text-center">
                            <i class="fas fa-exclamation-triangle text-yellow-500 text-5xl mb-4"></i>
                            <p class="text-gray-600 text-lg">No template loaded. Please select a template above.</p>
                        </div>
                    `;
                }
                return;
            }

            const container = document.getElementById('categories-container');
            const categories = activeTemplate.categories.filter(cat => cat.isActive);
            
            console.log('üé® [RENDER CATEGORIES] Active categories (isActive=true):', categories.length);
            console.log('üé® [RENDER CATEGORIES] Inactive categories (isActive=false):', activeTemplate.categories.filter(cat => !cat.isActive).length);
            console.log('üé® [RENDER CATEGORIES] Active category names:', categories.map(c => c.name));
            console.log('üé® [RENDER CATEGORIES] ===== END =====');

            if (categories.length === 0) {
                container.innerHTML = `
                    <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-12 text-center">
                        <i class="fas fa-folder-open text-gray-400 text-5xl mb-4"></i>
                        <p class="text-gray-600 text-lg">No categories yet. Start building your AI brain!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = categories.map((category, index) => `
                <div class="category-card" id="category-${index}" onclick="toggleCategory(${index})">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-3xl">${category.icon}</span>
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-gray-900">${category.name}</h3>
                                    <p class="text-sm text-gray-600">${category.description}</p>
                                </div>
                                <i id="chevron-${index}" class="fas fa-chevron-down text-gray-400 text-xl transition-transform"></i>
                            </div>
                            <div class="flex items-center gap-2 mt-3">
                                <span class="badge badge-active">
                                    <i class="fas fa-comments mr-1"></i>
                                    ${category.scenarios?.length || 0} scenarios
                                </span>
                                ${category.behavior ? `
                                <span class="badge bg-purple-100 text-purple-700 border-purple-300">
                                    <i class="fas fa-theater-masks mr-1"></i>
                                    ${category.behavior.replace(/_/g, ' ')}
                                </span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button onclick="editCategory(${index}); event.stopPropagation();" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors" title="Edit Category">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteCategory(${index}); event.stopPropagation();" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors" title="Delete Category">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Scenarios (hidden by default) -->
                    <div id="scenarios-${index}" class="hidden mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-end mb-3">
                            <button onclick="addScenario(${index}); event.stopPropagation();" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                                <i class="fas fa-plus"></i>
                                Add Scenario
                            </button>
                        </div>
                        <div class="space-y-3">
                            ${renderScenarios(category.scenarios || [], index)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderScenarios(scenarios, categoryIndex) {
            if (!scenarios || scenarios.length === 0) {
                return '<p class="text-gray-500 text-center py-4">No scenarios in this category yet. Click "+ Add Scenario" to create one!</p>';
            }

            return scenarios.map((scenario, scenarioIndex) => `
                <div class="scenario-item">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h4 class="font-bold text-gray-900 text-lg">${scenario.name}</h4>
                                ${scenario.status ? `<span class="badge ${
                                    scenario.status === 'live' ? 'bg-green-100 text-green-700 border-green-300' : 
                                    scenario.status === 'draft' ? 'bg-yellow-100 text-yellow-700 border-yellow-300' : 
                                    'bg-gray-100 text-gray-700 border-gray-300'
                                }">${scenario.status === 'live' ? '‚úÖ Live' : scenario.status === 'draft' ? 'üìù Draft' : 'üì¶ Archived'}</span>` : ''}
                                ${scenario.version ? `<span class="badge bg-indigo-100 text-indigo-700 border-indigo-300">v${scenario.version}</span>` : ''}
                            </div>
                            <div class="flex items-center gap-2 flex-wrap">
                                ${scenario.priority !== undefined ? `<span class="badge badge-priority">Priority: ${scenario.priority}</span>` : ''}
                                ${scenario.toneLevel ? `<span class="badge bg-pink-100 text-pink-700 border-pink-300">Tone ${scenario.toneLevel}/5</span>` : ''}
                                ${scenario.channel && scenario.channel !== 'any' ? `<span class="badge bg-blue-100 text-blue-700 border-blue-300">${scenario.channel}</span>` : ''}
                                ${scenario.language && scenario.language !== 'auto' ? `<span class="badge bg-purple-100 text-purple-700 border-purple-300">${scenario.language}</span>` : ''}
                                ${scenario.confidenceThreshold ? `<span class="badge bg-blue-100 text-blue-700 border-blue-300">Confidence: ${(scenario.confidenceThreshold * 100).toFixed(0)}%</span>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editScenario(${categoryIndex}, ${scenarioIndex}); event.stopPropagation();" class="px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button onclick="deleteScenario(${categoryIndex}, ${scenarioIndex}); event.stopPropagation();" class="px-3 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Behavior (AI Instructions) -->
                    ${scenario.behavior ? `
                        <div class="mb-3">
                            <p class="text-xs font-bold text-gray-700 mb-2">
                                <i class="fas fa-brain text-purple-500 mr-1"></i>
                                BEHAVIOR (AI Instructions):
                            </p>
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                <p class="text-sm text-gray-800 italic">${scenario.behavior}</p>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Responses -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <p class="text-xs font-bold text-green-700 mb-1">‚ö° QUICK REPLY:</p>
                            <p class="text-sm text-gray-800">${
                                scenario.quickReplies && scenario.quickReplies.length > 0 
                                    ? scenario.quickReplies[0] 
                                    : (scenario.quickReply || 'Not set')
                            }</p>
                            ${scenario.quickReplies && scenario.quickReplies.length > 1 
                                ? `<p class="text-xs text-green-600 mt-1">+${scenario.quickReplies.length - 1} more variation${scenario.quickReplies.length > 2 ? 's' : ''}</p>`
                                : ''}
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <p class="text-xs font-bold text-blue-700 mb-1">üí¨ FULL REPLY:</p>
                            <p class="text-sm text-gray-800">${
                                scenario.fullReplies && scenario.fullReplies.length > 0 
                                    ? scenario.fullReplies[0] 
                                    : (scenario.fullReply || 'Not set')
                            }</p>
                            ${scenario.fullReplies && scenario.fullReplies.length > 1 
                                ? `<p class="text-xs text-blue-600 mt-1">+${scenario.fullReplies.length - 1} more variation${scenario.fullReplies.length > 2 ? 's' : ''}</p>`
                                : ''}
                        </div>
                    </div>

                    <!-- Triggers -->
                    <div class="mb-3">
                        <p class="text-xs font-bold text-gray-700 mb-2">
                            <i class="fas fa-bolt text-yellow-500 mr-1"></i>
                            TRIGGERS (${scenario.triggers?.length || 0}):
                        </p>
                        <div class="flex flex-wrap gap-1">
                            ${(scenario.triggers || []).map(trigger => `
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full border border-yellow-300">"${trigger}"</span>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Keywords (if generated) -->
                    ${(scenario.keywords && scenario.keywords.length > 0) ? `
                        <div class="mb-3">
                            <p class="text-xs font-bold text-gray-700 mb-2">
                                <i class="fas fa-key text-purple-500 mr-1"></i>
                                KEYWORDS (${scenario.keywords.length}) - Auto-Generated:
                            </p>
                            <div class="flex flex-wrap gap-1">
                                ${scenario.keywords.map(keyword => `
                                    <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full border border-purple-300">${keyword}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : '<div class="mb-3 text-xs text-gray-500 italic">‚ö†Ô∏è No keywords generated yet - click "Enhance" button</div>'}

                    <!-- Q&A Pairs (if generated) -->
                    ${(scenario.qnaPairs && scenario.qnaPairs.length > 0) ? `
                        <div class="mb-3">
                            <p class="text-xs font-bold text-gray-700 mb-2">
                                <i class="fas fa-question-circle text-indigo-500 mr-1"></i>
                                Q&A PAIRS (${scenario.qnaPairs.length}) - Auto-Generated:
                            </p>
                            <div class="space-y-2 max-h-48 overflow-y-auto">
                                ${scenario.qnaPairs.slice(0, 5).map((qna, idx) => `
                                    <div class="bg-indigo-50 border border-indigo-200 rounded p-2">
                                        <p class="text-xs text-indigo-900 mb-1">
                                            <strong>Q:</strong> "${qna.question}"
                                        </p>
                                        <p class="text-xs text-indigo-800">
                                            <strong>A:</strong> ${qna.answer.substring(0, 80)}${qna.answer.length > 80 ? '...' : ''}
                                        </p>
                                        <p class="text-xs text-indigo-600 mt-1">
                                            Confidence: ${(qna.confidence * 100).toFixed(0)}%
                                        </p>
                                    </div>
                                `).join('')}
                                ${scenario.qnaPairs.length > 5 ? `<p class="text-xs text-gray-500 text-center">... and ${scenario.qnaPairs.length - 5} more Q&A pairs</p>` : ''}
                            </div>
                        </div>
                    ` : '<div class="mb-3 text-xs text-gray-500 italic">‚ö†Ô∏è No Q&A pairs generated yet - click "Enhance" button</div>'}

                    <!-- Escalation Flags (if any) -->
                    ${(scenario.escalationFlags && scenario.escalationFlags.length > 0) ? `
                        <div class="mb-3">
                            <p class="text-xs font-bold text-gray-700 mb-2">
                                <i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>
                                ESCALATION FLAGS:
                            </p>
                            <div class="flex flex-wrap gap-1">
                                ${scenario.escalationFlags.map(flag => `
                                    <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full border border-red-300">${flag}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Examples (if any) -->
                    ${(scenario.examples && scenario.examples.length > 0) ? `
                        <div>
                            <p class="text-xs font-bold text-gray-700 mb-2">
                                <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                                EXAMPLE DIALOGUES:
                            </p>
                            <div class="space-y-2">
                                ${scenario.examples.map(ex => `
                                    <div class="bg-gray-100 rounded p-2">
                                        <p class="text-xs text-gray-700"><strong>Caller:</strong> "${ex.caller}"</p>
                                        <p class="text-xs text-blue-700"><strong>AI:</strong> "${ex.ai}"</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // ============================================
        // UI INTERACTIONS
        // ============================================
        function toggleCategory(index) {
            const categoryCard = document.getElementById(`category-${index}`);
            const scenariosDiv = document.getElementById(`scenarios-${index}`);
            const chevron = document.getElementById(`chevron-${index}`);
            
            categoryCard.classList.toggle('expanded');
            scenariosDiv.classList.toggle('hidden');
            
            // Rotate chevron icon
            if (scenariosDiv.classList.contains('hidden')) {
                chevron.classList.remove('rotate-180');
            } else {
                chevron.classList.add('rotate-180');
            }
        }

        // ============================================
        // EDIT CATEGORY MODAL
        // ============================================
        let currentEditingCategoryIndex = null;
        let currentEditingCategoryId = null; // Store category ID for verification
        let currentEditingTemplateId = null; // Store template ID for verification

        async function editCategory(categoryIndex) {
            currentEditingCategoryIndex = categoryIndex;
            const category = activeTemplate.categories[categoryIndex];
            
            // Store IDs for verification on save
            currentEditingCategoryId = category.id;
            currentEditingTemplateId = activeTemplate._id || activeTemplate.id;
            
            console.log(`‚úèÔ∏è [EDIT CATEGORY] Opening editor for:`, {
                templateId: currentEditingTemplateId,
                templateName: activeTemplate.name,
                categoryIndex,
                categoryId: currentEditingCategoryId,
                categoryName: category.name
            });
            
            // Populate form
            document.getElementById('edit-category-name').value = category.name;
            document.getElementById('edit-category-description').value = category.description;
            document.getElementById('edit-category-icon').value = category.icon;
            
            // Show modal
            document.getElementById('edit-category-modal').style.display = 'flex';
        }

        function closeEditCategoryModal() {
            document.getElementById('edit-category-modal').style.display = 'none';
            currentEditingCategoryIndex = null;
            currentEditingCategoryId = null;
            currentEditingTemplateId = null;
        }

        // Safety check: only attach if form exists
        const editCategoryForm = document.getElementById('edit-category-form');
        if (editCategoryForm) {
            editCategoryForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (currentEditingCategoryIndex === null) return;

            try {
                // üîí CRITICAL: Verify we're editing the correct template!
                const currentTemplateId = activeTemplate._id || activeTemplate.id;
                if (currentTemplateId !== currentEditingTemplateId) {
                    console.error('‚ùå [EDIT CATEGORY] Template mismatch!', {
                        expected: currentEditingTemplateId,
                        current: currentTemplateId
                    });
                    showNotification('‚ùå Error: Template changed! Please close and reopen the editor.', 'error');
                    return;
                }
                
                // üîí CRITICAL: Verify category ID matches
                const category = activeTemplate.categories[currentEditingCategoryIndex];
                if (!category || category.id !== currentEditingCategoryId) {
                    console.error('‚ùå [EDIT CATEGORY] Category mismatch!', {
                        expectedId: currentEditingCategoryId,
                        foundId: category?.id,
                        categoryIndex: currentEditingCategoryIndex
                    });
                    showNotification('‚ùå Error: Category mismatch! Please close and reopen the editor.', 'error');
                    return;
                }
                
                console.log(`üíæ [EDIT CATEGORY] Saving changes to:`, {
                    templateId: currentTemplateId,
                    categoryId: category.id,
                    categoryName: category.name
                });
                
                showNotification('‚è≥ Saving category changes...', 'info');

                // Update category details
                activeTemplate.categories[currentEditingCategoryIndex].name = document.getElementById('edit-category-name').value.trim();
                activeTemplate.categories[currentEditingCategoryIndex].description = document.getElementById('edit-category-description').value.trim();
                activeTemplate.categories[currentEditingCategoryIndex].icon = document.getElementById('edit-category-icon').value.trim();

                // Save to backend
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-instant-responses/${activeTemplate._id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    body: JSON.stringify({
                        categories: activeTemplate.categories,
                        changeLog: [
                            ...activeTemplate.changeLog,
                            {
                                changes: `Updated category: ${activeTemplate.categories[currentEditingCategoryIndex].name}`,
                                changedBy: 'Admin',
                                date: new Date()
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                showNotification('‚úÖ Category updated successfully!', 'success');
                closeEditCategoryModal();
                
                // üîí CRITICAL: Reload the SAME template we were editing, not the "active" one!
                console.log(`üîÑ [EDIT CATEGORY] Reloading template ${currentTemplateId} after save...`);
                await switchDashboardTemplate(currentTemplateId);
                console.log(`‚úÖ [EDIT CATEGORY] Template reloaded successfully`);
            } catch (error) {
                console.error('‚ùå Error updating category:', error);
                showNotification('‚ùå Failed to update category: ' + error.message, 'error');
                
                // Report error to Notification Center
                await errorReporters.categories.reportError({
                    error,
                    operation: 'updateCategory',
                    userMessage: `Failed to update category "${activeTemplate.categories[currentEditingCategoryIndex]?.name}". Changes were not saved.`,
                    retryFunction: () => document.getElementById('edit-category-form').dispatchEvent(new Event('submit')),
                    additionalContext: {
                        endpoint: `/api/admin/global-instant-responses/${activeTemplate._id}`,
                        templateId: activeTemplate._id,
                        categoryIndex: currentEditingCategoryIndex,
                        categoryName: activeTemplate.categories[currentEditingCategoryIndex]?.name
                    }
                });
            }
        });
        } // End safety check for edit-category-form

        // ============================================
        // SEEDING FUNCTIONS
        // ============================================

        async function seedBehaviors() {
            if (!confirm('This will seed 15 default AI behavior templates into the database.\n\nContinue?')) {
                return;
            }

            try {
                showNotification('Seeding 15 behavior templates...', 'info');
                const token = getAuthToken();
                
                const response = await fetch('/api/admin/global-behaviors/seed', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('Seed behaviors result:', result);

                if (result.success) {
                    showNotification(`Successfully seeded ${result.count} behavior templates!`, 'success');
                    // Reload behaviors into memory
                    await fetchBehaviors();
                    console.log(`Reloaded ${availableBehaviors.length} behaviors`);
                } else {
                    showNotification('Seeding failed: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Seed behaviors error:', error);
                showNotification('Error seeding behaviors: ' + error.message, 'error');
            }
        }

        /**
         * Seed Universal Test Template - World-Class Production System
         * Calls the backend API to seed the 12-category test template
         * Works on ANY environment (local, Render, production)
         */
        async function seedUniversalTestTemplate() {
            // Confirmation dialog with detailed info
            const confirmMessage = `üå± SEED UNIVERSAL TEST TEMPLATE
            
This will load the test template with:
‚Ä¢ 12 Categories (Appointment, Emergency, Pricing, etc.)
‚Ä¢ 14 Comprehensive Scenarios
‚Ä¢ All form fields tested (triggers, entities, hooks, variations)

‚ö†Ô∏è NOTE: If "Universal AI Brain (All Industries)" already exists, it will be REPLACED.

‚úÖ Safe for any environment
‚úÖ Phone-testable immediately after seeding

Continue?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                console.log('üå± [SEED] Starting Universal Test Template seed via API...');
                showNotification('üå± Seeding Universal Test Template...', 'info');
                
                const token = getAuthToken();
                
                const response = await fetch('/api/admin/global-instant-responses/seed-template', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        templateName: 'universal-test-12-categories',
                        replaceExisting: true
                    })
                });

                const result = await response.json();
                console.log('üå± [SEED] API Response:', result);

                if (result.success) {
                    console.log('‚úÖ [SEED] Template seeded successfully!');
                    console.log('üìä [SEED] Stats:', result.data);
                    console.log('üìã [SEED] Categories:', result.stats.categoriesByName);
                    
                    // Show detailed success message
                    showNotification(
                        `‚úÖ Successfully seeded ${result.data.name}!\n\n` +
                        `üìä ${result.data.categories} categories, ${result.data.scenarios} scenarios\n` +
                        `üéØ Template ID: ${result.data.templateId}\n\n` +
                        `Refreshing page to load new data...`,
                        'success'
                    );
                    
                    // Wait 2 seconds then reload the page to show new template
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                } else {
                    console.error('‚ùå [SEED] Seeding failed:', result.message);
                    showNotification('‚ùå Seeding failed: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('‚ùå [SEED] Error seeding template:', error);
                showNotification('‚ùå Error seeding template: ' + error.message, 'error');
            }
        }
        
        async function seedActionHooks() {
            if (!confirm('This will seed 16 default action hooks into the database.\n\nThese define what actions the AI should take after responding (escalate, schedule, callback, etc.).\n\nContinue?')) {
                return;
            }

            try {
                showNotification('‚è≥ Seeding 16 action hooks...', 'info');
                const token = getAuthToken();
                
                const response = await fetch('/api/admin/global-action-hooks/seed', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('Seed action hooks result:', result);

                if (result.success) {
                    showNotification(`‚úÖ Successfully seeded ${result.count} action hooks!`, 'success');
                    // Reload action hooks into memory
                    await fetchActionHooks();
                    console.log(`Reloaded ${availableActionHooks.length} action hooks`);
                } else {
                    showNotification('Seeding failed: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Seed action hooks error:', error);
                showNotification('Error seeding action hooks: ' + error.message, 'error');
            }
        }

        async function forceDeleteOldTemplate() {
            // Simple confirmation for the specific old template
            if (!confirm('üîß Force Delete Old Template\n\nThis will delete template ID: 68e5033ab02424067d056f0a\n\nThis is the old template causing HTTP 500 errors.\n\nAfter deletion, you\'ll need to click "Seed 8 Categories".\n\nProceed?')) {
                return;
            }

            try {
                console.log('üîß Force deleting old template: 68e5033ab02424067d056f0a');
                showNotification('‚è≥ Deleting old template...', 'info');
                const token = getAuthToken();
                const oldTemplateId = '68e5033ab02424067d056f0a';
                
                // Step 1: Deactivate the template first
                console.log('Step 1: Deactivating template...');
                const deactivateResponse = await fetch(`/api/admin/global-instant-responses/${oldTemplateId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isActive: false })
                });

                if (deactivateResponse.ok) {
                    console.log('‚úÖ Template deactivated');
                } else {
                    console.warn('‚ö†Ô∏è Deactivate returned:', deactivateResponse.status, '- continuing with delete...');
                }

                // Step 2: Delete the template
                console.log('Step 2: Deleting template...');
                const deleteResponse = await fetch(`/api/admin/global-instant-responses/${oldTemplateId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const deleteResult = await deleteResponse.json();
                console.log('Delete result:', deleteResult);

                if (deleteResult.success) {
                    showNotification('‚úÖ Old template deleted! Now refresh and click "Seed 8 Categories"', 'success');
                    setTimeout(() => {
                        if (confirm('Template deleted successfully!\n\nRefresh the page now to see changes?')) {
                            location.reload();
                        }
                    }, 1500);
                } else {
                    showNotification('‚ö†Ô∏è Delete response: ' + deleteResult.message + ' - Try the "Delete All Templates" button below if this persists', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error force deleting template:', error);
                showNotification('‚ùå Error: ' + error.message + ' - Try the "Delete All Templates" button below', 'error');
            }
        }

        // ============================================================================
        // CREATE INDUSTRY TEMPLATE FUNCTIONS
        // ============================================================================

        async function openCreateTemplateModal() {
            console.log('üîµ [CREATE TEMPLATE] Opening modal...');
            
            // Load available templates to clone from
            await loadTemplatesForCloning();
            
            // Load industry types dynamically
            await loadIndustryTypesForModal();
            
            // Show modal
            const modal = document.getElementById('create-template-modal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        async function loadIndustryTypesForModal() {
            try {
                const token = getAuthToken();
                const response = await fetch('/api/admin/global-industry-types/active', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const dropdown = document.getElementById('new-template-type');
                    dropdown.innerHTML = '<option value="">-- Select Industry --</option>';
                    
                    result.data.forEach(industry => {
                        const option = document.createElement('option');
                        option.value = industry.industryId;
                        option.textContent = `${industry.icon} ${industry.displayLabel}`;
                        dropdown.appendChild(option);
                    });
                    
                    console.log(`‚úÖ Loaded ${result.data.length} industry types for modal`);
                } else {
                    console.error('Failed to load industries:', result.message);
                }
            } catch (error) {
                console.error('Error loading industry types:', error);
                showNotification('‚ùå Failed to load industry types', 'error');
            }
        }

        function closeCreateTemplateModal() {
            console.log('üîµ [CREATE TEMPLATE] Closing modal...');
            const modal = document.getElementById('create-template-modal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Reset form
            const form = document.getElementById('create-template-form');
            if (form) {
                form.reset();
            }
        }

        async function loadTemplatesForCloning() {
            console.log('üì• [TEMPLATES] Loading templates for cloning...');
            try {
                const token = getAuthToken();
                const response = await fetch('/api/admin/global-instant-responses/published', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                console.log('üì• [TEMPLATES] Response:', result);
                
                if (result.success && result.data && result.data.length > 0) {
                    const dropdown = document.getElementById('clone-from-template');
                    dropdown.innerHTML = '<option value="">-- Start with blank template --</option>';
                    
                    result.data.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template._id;
                        option.textContent = `${template.name} (${template.industryLabel || template.templateType})`;
                        dropdown.appendChild(option);
                    });
                    
                    console.log(`‚úÖ Loaded ${result.data.length} templates for cloning`);
                } else {
                    console.warn('‚ö†Ô∏è No published templates found or error:', result.message);
                    const dropdown = document.getElementById('clone-from-template');
                    dropdown.innerHTML = '<option value="">-- Start with blank template --</option><option value="" disabled>No templates available to clone</option>';
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                showNotification('‚ùå Failed to load templates', 'error');
            }
        }

        async function handleCreateTemplate(event) {
            event.preventDefault();
            
            console.log('üîµ [CREATE TEMPLATE] Form submitted');
            
            const name = document.getElementById('new-template-name').value.trim();
            const templateType = document.getElementById('new-template-type').value;
            const industryLabel = document.getElementById('new-template-label').value.trim();
            const version = document.getElementById('new-template-version').value.trim();
            const description = document.getElementById('new-template-description').value.trim();
            const cloneFromId = document.getElementById('clone-from-template').value; // Optional now
            const isPublished = document.getElementById('new-template-publish').checked;
            
            // Validation (clone is now optional)
            if (!name || !templateType || !industryLabel || !version) {
                showNotification('‚ùå Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const token = getAuthToken();
                let response, result;
                
                if (cloneFromId) {
                    // Clone from existing template
                    showNotification('‚è≥ Cloning template...', 'info');
                    console.log(`üìã [CREATE TEMPLATE] Cloning from template: ${cloneFromId}`);
                    
                    response = await fetch(`/api/admin/global-instant-responses/${cloneFromId}/clone-industry`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name,
                            templateType,
                            industryLabel,
                            version,
                            description: description || `${name} - Industry-specific AI receptionist brain`,
                            isPublished
                        })
                    });
                } else {
                    // Create blank template
                    showNotification('‚è≥ Creating blank template...', 'info');
                    console.log('üìÑ [CREATE TEMPLATE] Creating blank template');
                    
                    response = await fetch('/api/admin/global-instant-responses', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            version,
                            name,
                            description: description || `${name} - Industry-specific AI receptionist brain`,
                            templateType,
                            industryLabel,
                            isPublished,
                            isDefaultTemplate: false,
                            categories: [] // Start with empty categories
                        })
                    });
                }
                
                result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Template created:', result.data);
                    const action = cloneFromId ? 'cloned' : 'created';
                    showNotification(`‚úÖ Successfully ${action} ${name}! ${isPublished ? 'Published' : 'Saved as draft'}.`, 'success');
                    closeCreateTemplateModal();
                    
                    // Reload templates table
                    renderTemplatesTable();
                } else {
                    showNotification(`‚ùå Failed to create template: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå Error creating template:', error);
                showNotification(`‚ùå Error creating template: ${error.message}`, 'error');
            }
        }

        // ============================================================================
        // DELETE ALL TEMPLATES (DANGEROUS)
        // ============================================================================

        async function deleteAllTemplates() {
            // First confirmation with typed input
            const typedConfirmation = prompt(
                '‚ö†Ô∏è DANGER: DELETE ALL GLOBAL TEMPLATES\n\n' +
                'This will permanently delete ALL global AI Brain templates.\n' +
                'Only use this during schema migration or if you have template errors.\n\n' +
                'After deletion, you MUST click "Seed 8 Categories" to rebuild.\n\n' +
                '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' +
                'Type DELETE (in capital letters) to confirm:'
            );

            if (typedConfirmation !== 'DELETE') {
                if (typedConfirmation !== null) {
                    showNotification('‚ùå Deletion cancelled - confirmation text did not match', 'error');
                }
                return;
            }

            // Second confirmation
            if (!confirm('‚ö†Ô∏è FINAL CONFIRMATION\n\nYou typed DELETE correctly.\n\nThis will now permanently delete all templates.\n\nProceed?')) {
                showNotification('‚ùå Deletion cancelled by user', 'info');
                return;
            }

            try {
                console.log('üóëÔ∏è Deleting all templates...');
                showNotification('‚è≥ Deleting old templates...', 'info');
                const token = getAuthToken();
                
                // First, get all templates
                const listResponse = await fetch('/api/admin/global-instant-responses', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const listResult = await listResponse.json();
                
                if (!listResult.success || listResult.data.length === 0) {
                    showNotification('‚úÖ No templates found to delete', 'info');
                    return;
                }

                // Delete each template (skip if active first)
                let deleteCount = 0;
                for (const template of listResult.data) {
                    // Deactivate first if active
                    if (template.isActive) {
                        console.log(`Deactivating template ${template._id}...`);
                        // We'll just directly delete even if active - backend will handle
                    }
                    
                    // Force delete by patching isActive to false first
                    await fetch(`/api/admin/global-instant-responses/${template._id}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ isActive: false })
                    });

                    // Now delete
                    const deleteResponse = await fetch(`/api/admin/global-instant-responses/${template._id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const deleteResult = await deleteResponse.json();
                    if (deleteResult.success) {
                        deleteCount++;
                        console.log(`‚úÖ Deleted template: ${template.version}`);
                    }
                }

                showNotification(`‚úÖ Deleted ${deleteCount} template(s)! Now click "Seed 8 Categories"`, 'success');
                setTimeout(() => location.reload(), 2000);
            } catch (error) {
                console.error('‚ùå Error deleting templates:', error);
                showNotification('‚ùå Error deleting templates: ' + error.message, 'error');
            }
        }

        async function seedTemplate() {
            try {
                // First check if template already exists
                const token = getAuthToken();
                const checkResponse = await fetch('/api/admin/global-instant-responses/active', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const checkResult = await checkResponse.json();
                
                if (checkResult.success && checkResult.data) {
                    // Template already exists
                    const proceed = confirm(
                        '‚ö†Ô∏è Template Already Exists!\n\n' +
                        `Current Template: ${checkResult.data.version}\n` +
                        `Categories: ${checkResult.data.stats?.totalCategories || 0}\n` +
                        `Scenarios: ${checkResult.data.stats?.totalScenarios || 0}\n\n` +
                        'If you want to re-seed, you must first delete the existing template using the "Delete All Templates" button above.\n\n' +
                        'Click OK to refresh and view the existing template, or Cancel to stay here.'
                    );
                    
                    if (proceed) {
                        location.reload();
                    }
                    return;
                }

                // No template exists, proceed with seeding
                if (!confirm('This will create a new Global AI Brain template with 8 categories.\n\nContinue?')) {
                    return;
                }

                console.log('Starting seed process...');
                showNotification('‚è≥ Seeding 8 categories...', 'info');
                
                const response = await fetch('/api/admin/global-instant-responses/seed', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('Seed result:', result);

                if (result.success) {
                    showNotification('‚úÖ Successfully seeded 8 categories! Refreshing...', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification('‚ùå Seeding failed: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Seed error:', error);
                showNotification('‚ùå Error seeding template: ' + error.message, 'error');
            }
        }

        // =============================================
        // TWILIO TEST CONFIGURATION FUNCTIONS
        // =============================================

        /**
         * Load Twilio test configuration (GLOBAL - loads once on page init)
         * NOTE: No longer needs manual refresh - config is global and static!
         */
        // ============================================================================
        // üß† NEW: GLOBAL AI BRAIN TEST CONFIG (World-Class Refactor)
        // ============================================================================
        // ARCHITECTURE CHANGE:
        // - OLD: Each template had its own Twilio config (caused duplicates)
        // - NEW: One global config in AdminSettings routes to any template
        // ============================================================================
        
        async function loadTwilioTestConfig() {
            console.log('üìû [TWILIO TEST - GLOBAL] loadTwilioTestConfig() CALLED');
            
            try {
                const response = await fetch('/api/admin/settings/global-ai-brain-test', {
                    headers: {
                        Authorization: `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                const config = result?.data || {};
                const configActiveTemplateId = config.activeTemplateId ? config.activeTemplateId.toString() : null;
                const configActiveTemplateName = config.activeTemplate?.name || config.activeTemplateName || 'Not assigned';

                console.log('üìû [TWILIO TEST - GLOBAL] Config loaded:', {
                    enabled: config.enabled,
                    hasPhone: Boolean(config.phoneNumber),
                    activeTemplateId: configActiveTemplateId,
                    activeTemplateName: configActiveTemplateName
                });

                // Align local active template reference with AdminSettings
                if (configActiveTemplateId && configActiveTemplateId !== activeTemplateId) {
                    console.log('üìû [TWILIO TEST - GLOBAL] Updating local activeTemplateId to match AdminSettings setting');
                    activeTemplateId = configActiveTemplateId;
                    window.activeTemplateId = configActiveTemplateId;
                }

                window.globalTwilioTestConfig = config; // Cache for other helpers

                // Populate form (STATIC - doesn't change when switching templates!)
                document.getElementById('twilio-test-phone').value = config.phoneNumber || '';
                document.getElementById('twilio-test-account-sid').value = config.accountSid || '';
                document.getElementById('twilio-test-auth-token').value = config.authToken || '';
                document.getElementById('twilio-test-greeting').value = config.greeting || DEFAULT_GREETING;
                document.getElementById('twilio-test-notes').value = config.notes || '';
                
                // Update character count for greeting
                updateGreetingCharCount();
                
                // üé® UPDATE: Dynamic badge status (with slight delay to ensure DOM updates)
                setTimeout(() => {
                    console.log('üé® [LOAD CONFIG] Updating badge after fields populated...');
                    updateTwilioConfigBadge();
                }, 100);
                
                // Update stats if available (in new accordion layout)
                const testCallCountEl = document.getElementById('test-call-count');
                const lastCalledEl = document.getElementById('test-last-called');
                
                if (testCallCountEl) {
                    testCallCountEl.textContent = config.testCallCount || 0;
                }
                if (lastCalledEl) {
                    const lastTested = config.lastTestedAt ? new Date(config.lastTestedAt).toLocaleString() : 'Never';
                    lastCalledEl.textContent = lastTested;
                }

                console.log('‚úÖ [TWILIO TEST - GLOBAL] Config loaded successfully');

            } catch (error) {
                console.error('‚ùå [TWILIO TEST - GLOBAL] Error loading config:', error);
                console.log('‚ÑπÔ∏è [TWILIO TEST - GLOBAL] No config found - showing empty form for first-time setup');
                window.globalTwilioTestConfig = null;
            }
        }

        /**
         * Default greeting message
         */
        const DEFAULT_GREETING = 'Welcome to the ClientsVia Global AI Brain Testing Center. You are currently testing the {template_name} template. Please ask questions or make statements to test the AI scenarios now.';
        
        /**
         * Reset greeting to default
         */
        function resetGreetingToDefault() {
            const greetingTextarea = document.getElementById('twilio-test-greeting');
            greetingTextarea.value = DEFAULT_GREETING;
            updateGreetingCharCount();
            showNotification('‚úÖ Greeting reset to default', 'success');
        }
        
        /**
         * Update character count for greeting
         */
        function updateGreetingCharCount() {
            const greetingTextarea = document.getElementById('twilio-test-greeting');
            const charCount = document.getElementById('greeting-char-count');
            const length = greetingTextarea.value.length;
            charCount.textContent = `${length} / 500 chars`;
            
            // Change color if approaching limit
            if (length > 450) {
                charCount.classList.add('text-red-600', 'font-bold');
            } else if (length > 400) {
                charCount.classList.remove('text-red-600', 'font-bold');
            }
        }
        
        // ============================================================================
        // TEST PHRASE LIBRARY - WORLD-CLASS TESTING COMPANION
        // ============================================================================
        
        let testPhraseLibraryExpanded = false;
        let testPhraseData = []; // Store all phrases for filtering
        
        /**
         * Toggle Test Phrase Library expansion
         */
        function toggleTestPhraseLibrary() {
            const content = document.getElementById('test-phrase-library-content');
            const icon = document.getElementById('test-phrase-toggle-icon');
            const text = document.getElementById('test-phrase-toggle-text');
            
            testPhraseLibraryExpanded = !testPhraseLibraryExpanded;
            
            if (testPhraseLibraryExpanded) {
                content.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                text.textContent = 'Collapse';
                
                // Load phrases on first expand
                if (testPhraseData.length === 0) {
                    loadTestPhrases();
                }
            } else {
                content.classList.add('hidden');
                icon.classList.add('fa-chevron-down');
                icon.classList.remove('fa-chevron-up');
                text.textContent = 'Expand';
            }
        }
        
        /**
         * Load test phrases from GLOBAL ACTIVE template (ensures sync with Twilio routing)
         * üéØ FIX: Now loads from AdminSettings.globalAIBrainTest.activeTemplateId
         *         instead of UI's activeTemplate to ensure WYSIWYG
         */
        async function loadTestPhrases() {
            console.log('üìã [TEST PHRASES] Loading phrases (mode-aware)...');
            
            try {
                // STEP 1: Fetch global test config to get the mode and active template/company
                console.log('üìã [TEST PHRASES] Step 1: Fetching global test config...');
                const token = getAuthToken();
                const globalConfigResponse = await fetch('/api/admin/settings/global-ai-brain-test', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!globalConfigResponse.ok) {
                    throw new Error(`Failed to load global test config: ${globalConfigResponse.status}`);
                }
                
                const globalConfigResult = await globalConfigResponse.json();
                const globalConfig = globalConfigResult.data;
                const mode = globalConfig.mode || 'template'; // Default to template mode
                const realActiveTemplateId = globalConfig.activeTemplateId;
                const testCompanyId = globalConfig.testCompanyId;
                const realActiveTemplateName = globalConfig.activeTemplateName || 'Unknown';
                
                console.log('üìã [TEST PHRASES] Global config loaded:', {
                    mode: mode,
                    activeTemplateId: realActiveTemplateId,
                    testCompanyId: testCompanyId,
                    activeTemplateName: realActiveTemplateName,
                    enabled: globalConfig.enabled
                });
                
                // STEP 2: MODE-AWARE LOADING
                let templatesToLoad = [];
                let displayModeName = '';
                
                if (mode === 'template') {
                    // ===== TEMPLATE MODE: Load single active template =====
                    console.log('üìã [TEST PHRASES] MODE: Template Testing');
                    
                    if (!realActiveTemplateId) {
                        console.warn('‚ö†Ô∏è [TEST PHRASES] No active template set in global config');
                        document.getElementById('test-phrase-categories').innerHTML = `
                            <div class="text-center py-8 text-yellow-600">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>No active template configured for testing.</p>
                                <p class="text-sm mt-2">Please save the Twilio test configuration first.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    console.log('üìã [TEST PHRASES] Step 2: Loading template from backend...', realActiveTemplateId);
                    const templateResponse = await fetch(`/api/admin/global-instant-responses/${realActiveTemplateId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!templateResponse.ok) {
                        throw new Error(`Failed to load template ${realActiveTemplateId}: ${templateResponse.status}`);
                    }
                    
                    const templateResult = await templateResponse.json();
                    const realActiveTemplate = templateResult.data || templateResult.template;
                    
                    templatesToLoad = [realActiveTemplate];
                    displayModeName = `Template: ${realActiveTemplate.name}`;
                    
                    console.log('üìã [TEST PHRASES] Template loaded:', {
                        id: realActiveTemplate._id,
                        name: realActiveTemplate.name,
                        categories: realActiveTemplate.categories?.length || 0
                    });
                    
                } else if (mode === 'company') {
                    // ===== COMPANY MODE: Load ALL company templates =====
                    console.log('üìã [TEST PHRASES] MODE: Company Testing');
                    
                    if (!testCompanyId) {
                        console.warn('‚ö†Ô∏è [TEST PHRASES] No company selected for testing');
                        document.getElementById('test-phrase-categories').innerHTML = `
                            <div class="text-center py-8 text-yellow-600">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>No company selected for testing.</p>
                                <p class="text-sm mt-2">Please select a company from the dropdown first.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    console.log('üìã [TEST PHRASES] Step 2: Loading company data...', testCompanyId);
                    const companyResponse = await fetch(`/api/admin/test-pilot/companies/${testCompanyId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!companyResponse.ok) {
                        throw new Error(`Failed to load company ${testCompanyId}: ${companyResponse.status}`);
                    }
                    
                    const companyResult = await companyResponse.json();
                    const company = companyResult.company; // ‚úÖ FIX: API returns { company: ... } not { data: ... }
                    const companyTemplates = company.templates || []; // Templates are already loaded by the API
                    
                    console.log('üìã [TEST PHRASES] Company loaded:', {
                        id: company._id,
                        name: company.name,
                        templates: companyTemplates.length,
                        templateNames: companyTemplates.map(t => t.name)
                    });
                    
                    if (companyTemplates.length === 0) {
                        console.warn('‚ö†Ô∏è [TEST PHRASES] Company has no assigned templates');
                        document.getElementById('test-phrase-categories').innerHTML = `
                            <div class="text-center py-8 text-yellow-600">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>Company "${company.name}" has no assigned templates.</p>
                                <p class="text-sm mt-2">Please assign templates to this company first.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Load FULL template data for ALL assigned templates
                    // Note: The API returns templates with basic info, but we need full category/scenario data
                    console.log('üìã [TEST PHRASES] Step 3: Loading full template data for all assigned templates...');
                    const templatePromises = companyTemplates.map(t => 
                        fetch(`/api/admin/global-instant-responses/${t._id}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        }).then(res => res.ok ? res.json() : null)
                    );
                    
                    const templateResults = await Promise.all(templatePromises);
                    templatesToLoad = templateResults
                        .filter(result => result !== null)
                        .map(result => result.data || result.template);
                    
                    displayModeName = `Company: ${company.name} (${templatesToLoad.length} templates)`;
                    
                    console.log('üìã [TEST PHRASES] Templates loaded:', {
                        count: templatesToLoad.length,
                        names: templatesToLoad.map(t => t.name)
                    });
                }
                
                // STEP 3: Extract test phrases from ALL loaded templates
                console.log('üìã [TEST PHRASES] Step 3: Extracting phrases from', templatesToLoad.length, 'template(s)...');
                testPhraseData = [];
                let totalPhrases = 0;
                const categoryMap = new Map(); // For merging categories across templates
                
                if (templatesToLoad.length === 0) {
                    console.warn('‚ö†Ô∏è [TEST PHRASES] No templates to load');
                    document.getElementById('test-phrase-categories').innerHTML = `
                        <div class="text-center py-8 text-yellow-600">
                            <i class="fas fa-folder-open text-2xl mb-2"></i>
                            <p>No templates available for testing.</p>
                        </div>
                    `;
                    return;
                }
                
                // Extract all triggers from all scenarios in all categories across ALL templates
                templatesToLoad.forEach((template, templateIndex) => {
                    console.log(`üìã [TEST PHRASES] Processing template ${templateIndex + 1}/${templatesToLoad.length}: ${template.name}`);
                    
                    if (!template.categories || template.categories.length === 0) {
                        console.warn(`‚ö†Ô∏è [TEST PHRASES] Template "${template.name}" has no categories`);
                        return;
                    }
                    
                    template.categories.forEach(category => {
                        // Use category name as key for merging (or use ID if available)
                        const categoryKey = category.name;
                        
                        if (!categoryMap.has(categoryKey)) {
                            categoryMap.set(categoryKey, {
                                id: category.id,
                                name: category.name,
                                icon: category.icon || 'üìÅ',
                                description: category.description || '',
                                phrases: [],
                                expanded: false,
                                sourceTemplates: [] // Track which templates this category came from
                            });
                        }
                        
                        const categoryData = categoryMap.get(categoryKey);
                        categoryData.sourceTemplates.push(template.name);
                        
                        if (category.scenarios && Array.isArray(category.scenarios)) {
                            category.scenarios.forEach(scenario => {
                                if (scenario.triggers && Array.isArray(scenario.triggers)) {
                                    scenario.triggers.forEach(trigger => {
                                        categoryData.phrases.push({
                                            text: trigger,
                                            scenarioName: scenario.name,
                                            scenarioId: scenario.scenarioId,
                                            templateName: template.name // Add template name for context
                                        });
                                        totalPhrases++;
                                    });
                                }
                            });
                        }
                    });
                });
                
                // Convert map to array and filter empty categories
                testPhraseData = Array.from(categoryMap.values()).filter(cat => cat.phrases.length > 0);
                
                console.log(`‚úÖ [TEST PHRASES] Loaded ${totalPhrases} phrases from ${testPhraseData.length} categories`);
                console.log(`‚úÖ [TEST PHRASES] Mode: ${displayModeName}`);
                
                // STEP 4: Update UI with mode-aware template info
                document.getElementById('total-phrase-count').textContent = `${totalPhrases} phrases`;
                document.getElementById('footer-category-count').textContent = testPhraseData.length;
                document.getElementById('footer-phrase-count').textContent = totalPhrases;
                document.getElementById('footer-last-updated').textContent = new Date().toLocaleTimeString();
                
                // STEP 4.5: Update the active test template banner (CRITICAL for sync visibility)
                const bannerElement = document.getElementById('active-test-template-display');
                if (bannerElement) {
                    if (mode === 'template') {
                        bannerElement.innerHTML = `
                            <div class="flex items-center gap-2">
                                <i class="fas fa-check-circle text-emerald-100"></i>
                                <span>${templatesToLoad[0].name}</span>
                            </div>
                        `;
                    } else if (mode === 'company') {
                        bannerElement.innerHTML = `
                            <div class="flex items-center gap-2">
                                <i class="fas fa-building text-blue-100"></i>
                                <span>${displayModeName}</span>
                            </div>
                        `;
                    }
                }
                
                // STEP 5: Render the phrases
                renderTestPhrases();
                
            } catch (error) {
                console.error('‚ùå [TEST PHRASES] Error loading phrases:', error);
                document.getElementById('test-phrase-categories').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p class="font-semibold">Error loading test phrases</p>
                        <p class="text-sm mt-2">${error.message}</p>
                        <button onclick="loadTestPhrases()" class="mt-4 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                            <i class="fas fa-redo mr-2"></i>Retry
                        </button>
                    </div>
                `;
            }
        }
        
        /**
         * Render test phrases grouped by category
         */
        function renderTestPhrases(filteredData = null) {
            const container = document.getElementById('test-phrase-categories');
            const dataToRender = filteredData || testPhraseData;
            
            if (dataToRender.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-2"></i>
                        <p>No test phrases found.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = dataToRender.map((category, catIndex) => `
                <div class="bg-white rounded-lg border-2 border-gray-200 overflow-hidden test-phrase-category" data-category-id="${category.id}">
                    <!-- Category Header -->
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 flex items-center justify-between cursor-pointer hover:bg-gray-100 transition-colors"
                         onclick="toggleCategoryPhrases('${category.id}')">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${category.icon}</span>
                            <div>
                                <div class="flex items-center gap-2">
                                    <h4 class="font-bold text-gray-900">${category.name}</h4>
                                    ${category.sourceTemplates && category.sourceTemplates.length > 1 ? `
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-semibold" title="This category appears in ${category.sourceTemplates.length} templates">
                                            <i class="fas fa-layer-group mr-1"></i>
                                            ${category.sourceTemplates.length} sources
                                        </span>
                                    ` : ''}
                                </div>
                                <p class="text-xs text-gray-600">${category.phrases.length} test phrase${category.phrases.length !== 1 ? 's' : ''}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="event.stopPropagation(); copyCategoryPhrases('${category.id}')" 
                                    class="text-xs px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded font-semibold transition-colors">
                                <i class="fas fa-copy mr-1"></i>
                                Copy All
                            </button>
                            <i class="fas fa-chevron-down category-toggle-icon transition-transform" id="toggle-icon-${category.id}"></i>
                        </div>
                    </div>
                    
                    <!-- Phrases List (Initially Hidden) -->
                    <div class="category-phrases hidden" id="phrases-${category.id}">
                        <div class="p-4 space-y-2">
                            ${category.phrases.map((phrase, phraseIndex) => `
                                <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-green-50 transition-colors border border-gray-200 hover:border-green-300 test-phrase-item">
                                    <div class="flex-1">
                                        <div class="font-medium text-gray-900 test-phrase-text">"${phrase.text}"</div>
                                        <div class="text-xs text-gray-500 mt-1 flex items-center gap-3 flex-wrap">
                                            <span>
                                                <i class="fas fa-tag mr-1"></i>
                                                Scenario: ${phrase.scenarioName}
                                            </span>
                                            ${phrase.templateName ? `
                                                <span class="inline-flex items-center px-2 py-0.5 bg-blue-100 text-blue-700 rounded font-semibold">
                                                    <i class="fas fa-brain mr-1"></i>
                                                    ${phrase.templateName}
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="copyPhrase('${escapeHtml(phrase.text)}')" 
                                                class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-semibold transition-colors whitespace-nowrap"
                                                title="Copy to clipboard">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <button onclick="highlightPhrase(this)" 
                                                class="px-3 py-1.5 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded text-xs font-semibold transition-colors"
                                                title="Mark as tested">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        /**
         * Toggle individual category expansion
         */
        function toggleCategoryPhrases(categoryId) {
            const phrasesDiv = document.getElementById(`phrases-${categoryId}`);
            const icon = document.getElementById(`toggle-icon-${categoryId}`);
            
            if (phrasesDiv.classList.contains('hidden')) {
                phrasesDiv.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                phrasesDiv.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }
        
        /**
         * Copy single phrase to clipboard
         */
        function copyPhrase(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification(`‚úÖ Copied: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`, 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('‚ùå Failed to copy phrase', 'error');
            });
        }
        
        /**
         * Copy all phrases from a category
         */
        function copyCategoryPhrases(categoryId) {
            const category = testPhraseData.find(cat => cat.id === categoryId);
            if (!category) return;
            
            const allPhrases = category.phrases.map(p => p.text).join('\n');
            navigator.clipboard.writeText(allPhrases).then(() => {
                showNotification(`‚úÖ Copied ${category.phrases.length} phrases from ${category.name}!`, 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('‚ùå Failed to copy phrases', 'error');
            });
        }
        
        /**
         * Copy ALL phrases from all categories
         */
        function copyAllPhrases() {
            const allPhrases = testPhraseData.flatMap(cat => 
                cat.phrases.map(p => `[${cat.name}] ${p.text}`)
            ).join('\n');
            
            const totalCount = testPhraseData.reduce((sum, cat) => sum + cat.phrases.length, 0);
            
            navigator.clipboard.writeText(allPhrases).then(() => {
                showNotification(`‚úÖ Copied all ${totalCount} test phrases!`, 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('‚ùå Failed to copy phrases', 'error');
            });
        }
        
        /**
         * Get random test phrase
         */
        function getRandomTestPhrase() {
            if (testPhraseData.length === 0) {
                showNotification('‚ùå No test phrases loaded', 'error');
                return;
            }
            
            const randomCategory = testPhraseData[Math.floor(Math.random() * testPhraseData.length)];
            const randomPhrase = randomCategory.phrases[Math.floor(Math.random() * randomCategory.phrases.length)];
            
            copyPhrase(randomPhrase.text);
            showNotification(`üé≤ Random: "${randomPhrase.text}" (from ${randomCategory.name})`, 'info');
        }
        
        /**
         * Expand all categories
         */
        function expandAllCategories() {
            testPhraseData.forEach(category => {
                const phrasesDiv = document.getElementById(`phrases-${category.id}`);
                const icon = document.getElementById(`toggle-icon-${category.id}`);
                if (phrasesDiv && icon) {
                    phrasesDiv.classList.remove('hidden');
                    icon.classList.add('rotate-180');
                }
            });
            showNotification('üìÇ All categories expanded', 'info');
        }
        
        /**
         * Collapse all categories
         */
        function collapseAllCategories() {
            testPhraseData.forEach(category => {
                const phrasesDiv = document.getElementById(`phrases-${category.id}`);
                const icon = document.getElementById(`toggle-icon-${category.id}`);
                if (phrasesDiv && icon) {
                    phrasesDiv.classList.add('hidden');
                    icon.classList.remove('rotate-180');
                }
            });
            showNotification('üìÅ All categories collapsed', 'info');
        }
        
        /**
         * Filter test phrases based on search
         */
        function filterTestPhrases() {
            const searchTerm = document.getElementById('test-phrase-search').value.toLowerCase();
            
            if (!searchTerm) {
                renderTestPhrases();
                return;
            }
            
            const filtered = testPhraseData.map(category => ({
                ...category,
                phrases: category.phrases.filter(phrase => 
                    phrase.text.toLowerCase().includes(searchTerm) ||
                    phrase.scenarioName.toLowerCase().includes(searchTerm) ||
                    category.name.toLowerCase().includes(searchTerm)
                )
            })).filter(category => category.phrases.length > 0);
            
            renderTestPhrases(filtered);
        }
        
        /**
         * Refresh test phrases
         */
        function refreshTestPhrases() {
            testPhraseData = [];
            loadTestPhrases();
            showNotification('üîÑ Test phrases refreshed!', 'info');
        }
        
        /**
         * Highlight phrase as tested
         */
        function highlightPhrase(button) {
            const phraseItem = button.closest('.test-phrase-item');
            phraseItem.classList.toggle('bg-green-100');
            phraseItem.classList.toggle('border-green-400');
            
            if (phraseItem.classList.contains('bg-green-100')) {
                button.innerHTML = '<i class="fas fa-check-double"></i>';
                button.classList.add('bg-green-600', 'text-white');
                button.classList.remove('bg-yellow-100', 'text-yellow-700');
            } else {
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.remove('bg-green-600', 'text-white');
                button.classList.add('bg-yellow-100', 'text-yellow-700');
            }
        }
        
        /**
         * Export phrases as PDF (placeholder - would need PDF library)
         */
        function exportPhrasesAsPDF() {
            showNotification('üìÑ PDF export coming soon! Use "Copy All" for now.', 'info');
            // Future: Implement with jsPDF or similar
        }
        
        /**
         * Escape HTML for safe rendering
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, '&apos;');
        }
        
        // Auto-load test phrases when switching to Dashboard tab
        function autoLoadTestPhrasesOnDashboard() {
            if (testPhraseLibraryExpanded && testPhraseData.length === 0) {
                loadTestPhrases();
                charCount.classList.add('text-orange-600', 'font-semibold');
            } else {
                charCount.classList.remove('text-red-600', 'text-orange-600', 'font-bold', 'font-semibold');
            }
        }
        
        /**
         * Save Twilio test configuration
         */
        async function saveTwilioTestConfig() {
            console.log('üìû [SAVE START] Reading form values...');
            
            const phoneNumberElement = document.getElementById('twilio-test-phone');
            const accountSidElement = document.getElementById('twilio-test-account-sid');
            const authTokenElement = document.getElementById('twilio-test-auth-token');
            const greetingElement = document.getElementById('twilio-test-greeting');
            const notesElement = document.getElementById('twilio-test-notes');
            
            console.log('üìû [SAVE DEBUG] Form elements found:', {
                phoneNumberElement: !!phoneNumberElement,
                accountSidElement: !!accountSidElement,
                authTokenElement: !!authTokenElement,
                greetingElement: !!greetingElement,
                notesElement: !!notesElement
            });
            
            const phoneNumber = phoneNumberElement ? phoneNumberElement.value.trim() : '';
            const accountSid = accountSidElement ? accountSidElement.value.trim() : '';
            const authToken = authTokenElement ? authTokenElement.value.trim() : '';
            const greeting = greetingElement ? greetingElement.value.trim() : '';
            const notes = notesElement ? notesElement.value.trim() : '';
            const targetTemplateId = activeTemplateId || window.globalTwilioTestConfig?.activeTemplateId;

            console.log('üìû [SAVE DEBUG] Raw values from form:', {
                phoneNumber: phoneNumber || '(empty)',
                phoneNumberLength: phoneNumber.length,
                accountSid: accountSid ? `${accountSid.substring(0, 10)}...` : '(empty)',
                accountSidLength: accountSid.length,
                authToken: authToken ? '***' : '(empty)',
                authTokenLength: authToken.length,
                greetingLength: greeting.length,
                notesLength: notes.length,
                targetTemplateId: targetTemplateId || '(none - will be set when template selected)'
            });

            // üî• FIX: Allow saving configuration even without template selected (initial setup)
            // Template will be set when user selects one in Template Testing mode
            if (!targetTemplateId) {
                console.log('‚ö†Ô∏è [SAVE] No active template yet - saving config for later use');
            }

            // Validate phone number format if provided
            if (phoneNumber && !phoneNumber.match(/^\+\d{10,15}$/)) {
                showNotification('‚ùå Invalid phone number format. Use E.164 format: +15551234567', 'error');
                return;
            }

            // Validate credentials if phone number is provided
            if (phoneNumber && (!accountSid || !authToken)) {
                showNotification('‚ùå Twilio Account SID and Auth Token are required when using a test phone number', 'error');
                return;
            }

            console.log('üìû [TWILIO TEST - GLOBAL] Saving AdminSettings.globalAIBrainTest config', {
                phoneNumber,
                accountSid: accountSid ? `${accountSid.substring(0, 10)}...` : 'none',
                authToken: authToken ? '***' : 'none',
                activeTemplateId: targetTemplateId,
                activeTemplateName: activeTemplate?.name || window.globalTwilioTestConfig?.activeTemplate?.name || 'Unknown',
                notes
            });

            try {
                // Build request body (only include activeTemplateId if it exists)
                // NOTE: 'enabled' is controlled by banner tabs via switchTestMode(), not this save function
                const requestBody = {
                    phoneNumber,
                    accountSid,
                    authToken,
                    greeting,
                    notes
                };
                
                // Only include activeTemplateId if one is selected
                if (targetTemplateId) {
                    requestBody.activeTemplateId = targetTemplateId;
                }
                
                const response = await fetch('/api/admin/settings/global-ai-brain-test', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ [TWILIO TEST - GLOBAL] Config saved:', result);
                
                // üé® UPDATE: Update badge status after successful save
                updateTwilioConfigBadge();

                // Optimistically update cached config for downstream helpers
                window.globalTwilioTestConfig = {
                    ...(window.globalTwilioTestConfig || {}),
                    phoneNumber,
                    enabled,
                    accountSid,
                    authToken,
                    greeting,
                    notes,
                    activeTemplateId: targetTemplateId
                };

                const routedTemplateName = activeTemplate?.name || window.globalTwilioTestConfig?.activeTemplate?.name || 'selected template';
                showNotification(`‚úÖ Global test config saved! Test calls will route to: ${routedTemplateName}`, 'success');

                await loadTwilioTestConfig();

            } catch (error) {
                console.error('‚ùå [TWILIO TEST - GLOBAL] Error saving config:', error);
                showNotification(`‚ùå Failed to save: ${error.message}`, 'error');
            }
        }

        // =============================================
        // END TWILIO TEST FUNCTIONS

        // ============================================================================
        // COMPANY TEST MODE FUNCTIONS (NEW: Unified Test Pilot)
        // ============================================================================
        
        /**
         * ================================================================
         * TWILIO CONFIG BADGE - DYNAMIC STATUS INDICATOR
         * ================================================================
         * Update the status badge based on configuration completeness
         * ================================================================
         */
        function updateTwilioConfigBadge() {
            const phoneNumber = document.getElementById('twilio-test-phone')?.value?.trim() || '';
            const accountSid = document.getElementById('twilio-test-account-sid')?.value?.trim() || '';
            const authToken = document.getElementById('twilio-test-auth-token')?.value?.trim() || '';
            const badge = document.getElementById('twilio-config-status-badge');
            
            console.log('üé® [BADGE UPDATE] Checking config:', {
                hasPhoneElement: !!document.getElementById('twilio-test-phone'),
                hasSidElement: !!document.getElementById('twilio-test-account-sid'),
                hasTokenElement: !!document.getElementById('twilio-test-auth-token'),
                hasBadgeElement: !!badge,
                phoneLength: phoneNumber.length,
                sidLength: accountSid.length,
                tokenLength: authToken.length
            });
            
            if (!badge) {
                console.error('‚ùå [BADGE] Badge element not found!');
                return;
            }
            
            // Check configuration completeness
            const hasPhone = phoneNumber.length > 0;
            const hasCredentials = accountSid.length > 0 && authToken.length > 0;
            
            if (hasPhone && hasCredentials) {
                // FULLY CONFIGURED
                badge.className = 'px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full shadow-md';
                badge.textContent = '‚úì CONFIGURED';
                console.log('‚úÖ [BADGE] Status: CONFIGURED (phone + credentials present)');
            } else if (hasPhone || hasCredentials) {
                // PARTIALLY CONFIGURED
                badge.className = 'px-3 py-1 bg-yellow-500 text-white text-xs font-bold rounded-full shadow-md';
                badge.textContent = '‚ö† INCOMPLETE';
                console.log('‚ö†Ô∏è [BADGE] Status: INCOMPLETE (missing phone or credentials)');
            } else {
                // NOT CONFIGURED
                badge.className = 'px-3 py-1 bg-gray-400 text-white text-xs font-bold rounded-full shadow-md';
                badge.textContent = '‚óã NOT SET';
                console.log('‚óã [BADGE] Status: NOT SET (all fields empty)');
            }
        }
        
        /**
         * ================================================================
         * TWILIO CONFIG ACCORDION - ENTERPRISE-GRADE COLLAPSIBLE UI
         * ================================================================
         * Toggle the Twilio configuration accordion with smooth animation
         * Features:
         * - Cubic-bezier easing for professional feel
         * - Dynamic max-height calculation
         * - Icon rotation animation
         * - ARIA accessibility attributes
         * - State persistence (optional)
         * ================================================================
         */
        function toggleTwilioConfigAccordion() {
            const content = document.getElementById('twilio-config-content');
            const icon = document.getElementById('twilio-accordion-icon');
            const button = content.previousElementSibling;
            
            if (!content || !icon) {
                console.error('‚ùå [ACCORDION] Required elements not found');
                return;
            }
            
            const isExpanded = content.style.maxHeight && content.style.maxHeight !== '0px';
            
            if (isExpanded) {
                // COLLAPSE
                console.log('üîΩ [ACCORDION] Collapsing Twilio config...');
                content.style.maxHeight = '0px';
                icon.style.transform = 'rotate(0deg)';
                button.setAttribute('aria-expanded', 'false');
                
                // Smooth transition completion
                setTimeout(() => {
                    console.log('‚úÖ [ACCORDION] Collapsed');
                }, 500);
            } else {
                // EXPAND
                console.log('üîº [ACCORDION] Expanding Twilio config...');
                
                // Calculate content height dynamically
                const contentInner = content.firstElementChild;
                const height = contentInner ? contentInner.scrollHeight : 2000;
                
                content.style.maxHeight = `${height + 50}px`; // +50px buffer for safety
                icon.style.transform = 'rotate(180deg)';
                button.setAttribute('aria-expanded', 'true');
                
                // Smooth transition completion + badge update
                setTimeout(() => {
                    console.log('‚úÖ [ACCORDION] Expanded');
                    // üé® Update badge when accordion opens (fields are now visible)
                    updateTwilioConfigBadge();
                }, 500);
            }
        }
        
        /**
         * Switch between Template Mode and Company Mode
         * @param {string} mode - 'template' or 'company'
         */
        async function switchTestMode(mode) {
            console.log(`üîÑ [TEST MODE] Switching to: ${mode}`);
            
            // Get all UI elements
            const templateBtn = document.getElementById('template-mode-btn');
            const companyBtn = document.getElementById('company-mode-btn');
            const templateModeContent = document.getElementById('template-mode-content');
            const companyModeContent = document.getElementById('company-mode-content');
            const templateDesc = document.getElementById('template-mode-desc');
            const companyDesc = document.getElementById('company-mode-desc');
            
            if (mode === 'template') {
                // üî• VALIDATION: Check if template is selected (dropdown OR already loaded from backend)
                const dropdownTemplateId = document.getElementById('dashboard-template-selector')?.value;
                const loadedTemplateId = window.activeTemplateId || window.globalTwilioTestConfig?.activeTemplateId;
                const finalTemplateId = dropdownTemplateId || loadedTemplateId;
                
                if (!finalTemplateId) {
                    showToast('error', '‚ö†Ô∏è Please select a template from the dropdown first');
                    console.error('‚ùå [TEMPLATE TEST] No template selected');
                    return;
                }
                
                console.log('‚úÖ [TEMPLATE TEST] Using template:', finalTemplateId);
                
                // Show Template Mode content
                templateModeContent.style.display = 'block';
                companyModeContent.style.display = 'none';
                
                // Update tab styles
                templateBtn.className = 'flex-1 px-6 py-4 font-bold text-lg transition-all duration-300 bg-gradient-to-r from-purple-600 to-pink-600 text-white border-b-4 border-purple-700';
                companyBtn.className = 'flex-1 px-6 py-4 font-bold text-lg transition-all duration-300 bg-gray-100 text-gray-600 hover:bg-gray-200';
                
                // Update descriptions
                templateDesc.classList.remove('hidden');
                companyDesc.classList.add('hidden');
                
                // üî• SAVE TO BACKEND
                try {
                    await fetch('/api/admin/settings/global-ai-brain-test', {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                        },
                        body: JSON.stringify({
                            enabled: true,
                            mode: 'template',
                            activeTemplateId: finalTemplateId
                        })
                    });
                    console.log('‚úÖ [TEMPLATE TEST] Enabled in backend (enabled: true, mode: template)');
                    showToast('success', '‚úÖ Template Testing enabled');
                } catch (error) {
                    console.error('‚ùå [TEMPLATE TEST] Failed to enable:', error);
                    showToast('error', 'Failed to enable Template Testing');
                }
                
                // üîÑ RELOAD: Fetch updated config to refresh phone number and test monitor
                await loadTwilioTestConfig();
                
                // üìû UPDATE: Live Test Monitor phone display
                const templatePhoneDisplay = document.getElementById('live-test-phone-display');
                if (templatePhoneDisplay && window.globalTwilioTestConfig?.phoneNumber) {
                    templatePhoneDisplay.textContent = window.globalTwilioTestConfig.phoneNumber;
                    console.log('üìû [TEMPLATE TEST] Phone number updated:', window.globalTwilioTestConfig.phoneNumber);
                } else {
                    templatePhoneDisplay.textContent = 'Not configured';
                    console.warn('‚ö†Ô∏è [TEMPLATE TEST] No phone number found in config');
                }
                
                // üîÑ RELOAD: Test Phrase Library to load template-specific phrases
                console.log('üìã [TEMPLATE TEST] Reloading Test Phrase Library...');
                if (testPhraseLibraryExpanded || testPhraseData.length > 0) {
                    await loadTestPhrases();
                    console.log('‚úÖ [TEMPLATE TEST] Test Phrase Library reloaded');
                }
                
                console.log('‚úÖ [TEST MODE] Switched to Template Mode');
                
            } else if (mode === 'company') {
                // üî• VALIDATION: Check if company is selected (dropdown OR already loaded from backend)
                const dropdownCompanyId = document.getElementById('top-company-selector-dropdown')?.value;
                const loadedCompanyId = window.companyTestConfig?.activeCompanyId;
                const finalCompanyId = dropdownCompanyId || loadedCompanyId;
                
                if (!finalCompanyId) {
                    showToast('error', '‚ö†Ô∏è Please select a company from the dropdown first');
                    console.error('‚ùå [COMPANY TEST] No company selected');
                    return;
                }
                
                console.log('‚úÖ [COMPANY TEST] Using company:', finalCompanyId);
                
                // Show Company Mode content
                templateModeContent.style.display = 'none';
                companyModeContent.style.display = 'block';
                
                // Update tab styles
                companyBtn.className = 'flex-1 px-6 py-4 font-bold text-lg transition-all duration-300 bg-gradient-to-r from-blue-600 to-cyan-600 text-white border-b-4 border-blue-700';
                templateBtn.className = 'flex-1 px-6 py-4 font-bold text-lg transition-all duration-300 bg-gray-100 text-gray-600 hover:bg-gray-200';
                
                // Update descriptions
                templateDesc.classList.add('hidden');
                companyDesc.classList.remove('hidden');
                
                // üî• SAVE TO BACKEND
                try {
                    await fetch('/api/admin/settings/global-ai-brain-test', {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                        },
                        body: JSON.stringify({
                            enabled: true,
                            mode: 'company',
                            testCompanyId: finalCompanyId
                        })
                    });
                    console.log('‚úÖ [COMPANY TEST] Enabled in backend (enabled: true, mode: company)');
                    showToast('success', '‚úÖ Company Testing enabled');
                } catch (error) {
                    console.error('‚ùå [COMPANY TEST] Failed to enable:', error);
                    showToast('error', 'Failed to enable Company Testing');
                }
                
                // Load company data if not loaded
                await loadCompanyTestModeConfig();
                
                // üîÑ RELOAD: Fetch updated config to refresh phone number and test monitor
                await loadTwilioTestConfig();
                
                // üìû UPDATE: Live Test Monitor phone display
                const companyPhoneDisplay = document.getElementById('live-test-phone-display');
                if (companyPhoneDisplay && window.globalTwilioTestConfig?.phoneNumber) {
                    companyPhoneDisplay.textContent = window.globalTwilioTestConfig.phoneNumber;
                    console.log('üìû [COMPANY TEST] Phone number updated:', window.globalTwilioTestConfig.phoneNumber);
                } else {
                    companyPhoneDisplay.textContent = 'Not configured';
                    console.warn('‚ö†Ô∏è [COMPANY TEST] No phone number found in config');
                }
                
                // üîÑ RELOAD: Test Phrase Library to load ALL company templates
                console.log('üìã [COMPANY TEST] Reloading Test Phrase Library for all company templates...');
                if (testPhraseLibraryExpanded || testPhraseData.length > 0) {
                    await loadTestPhrases();
                    console.log('‚úÖ [COMPANY TEST] Test Phrase Library reloaded with all company templates');
                }
                
                console.log('‚úÖ [TEST MODE] Switched to Company Mode');
            }
        }
        
        /**
         * Load Company Test Mode configuration from backend
         */
        async function loadCompanyTestModeConfig() {
            console.log('üìã [COMPANY TEST] Loading configuration...');
            
            try {
                const response = await fetch('/api/admin/settings/company-test-mode', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const config = data.config || {};
                
                console.log('‚úÖ [COMPANY TEST] Configuration loaded:', config);
                
                // Cache config globally for banner validation
                window.companyTestConfig = config;
                
                // Select active company if set (in TOP selector)
                if (config.activeCompanyId) {
                    const topSelector = document.getElementById('top-company-selector-dropdown');
                    if (topSelector) {
                        topSelector.value = config.activeCompanyId;
                        // Load company details with RICH rendering (templates, stats, etc.)
                        await onCompanySelected(config.activeCompanyId);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå [COMPANY TEST] Failed to load configuration:', error);
                showToast('error', 'Failed to load Company Test Mode configuration');
            }
        }
        
        /**
         * When company is selected from dropdown (now from TOP selector only)
         */
        async function onCompanyTestSelected() {
            // Get company ID from TOP selector
            const selector = document.getElementById('top-company-selector-dropdown');
            const companyId = selector ? selector.value : null;
            
            if (!companyId) {
                // Reset the "Currently Testing" display
                const currentName = document.getElementById('company-test-current-name');
                const currentId = document.getElementById('company-test-current-id');
                
                if (currentName) currentName.textContent = 'No company selected';
                if (currentId) currentId.textContent = 'Select a company above';
                return;
            }
            
            console.log(`üè¢ [COMPANY TEST] Selected company: ${companyId}`);
            
            try {
                // Fetch company details
                const response = await fetch(`/api/admin/test-pilot/companies/${companyId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const company = data.company;
                
                // Update "Currently Testing" display at the top of Company Test section
                const currentName = document.getElementById('company-test-current-name');
                const currentId = document.getElementById('company-test-current-id');
                
                if (currentName) {
                    currentName.textContent = company.name || company.companyName || company.businessName || 'Unknown Company';
                }
                if (currentId) {
                    // Updated to use new templates structure (plural)
                    const templateInfo = company.templates?.hasTemplates 
                        ? company.templates.names 
                        : 'No templates';
                    currentId.textContent = `ID: ${companyId.substring(0, 8)}... ‚Ä¢ Templates: ${templateInfo}`;
                }
                
                console.log('‚úÖ [COMPANY TEST] Company details loaded - Name:', company.name, 'ID:', companyId);
                
            } catch (error) {
                console.error('‚ùå [COMPANY TEST] Failed to load company details:', error);
                showToast('error', 'Failed to load company details');
            }
        }
        
        /**
         * Load companies into the TOP dropdown (visible in Company Mode)
         */
        async function loadTopCompanyList() {
            console.log('üìã [TOP COMPANY SELECTOR] Loading company list...');
            
            try {
                const response = await fetch('/api/admin/test-pilot/companies', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const companies = data.companies || [];
                
                console.log(`‚úÖ [TOP COMPANY SELECTOR] Loaded ${companies.length} companies`);
                
                // Populate TOP dropdown
                const topSelector = document.getElementById('top-company-selector-dropdown');
                const currentValue = topSelector.value; // Preserve current selection
                
                topSelector.innerHTML = '<option value="">-- Select a company to test --</option>';
                
                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company._id;
                    option.textContent = `${company.name}${company.hasTemplate ? '' : ' (No template)'}`;
                    if (!company.hasTemplate) {
                        option.style.color = '#999';
                    }
                    topSelector.appendChild(option);
                });
                
                // Restore selection if it still exists
                if (currentValue) {
                    topSelector.value = currentValue;
                }
                
            } catch (error) {
                console.error('‚ùå [TOP COMPANY SELECTOR] Failed to load companies:', error);
                showToast('error', 'Failed to load company list');
            }
        }
        
        /**
         * Render template cards in rich detail view
         */
        function renderTemplateCards(templates) {
            const container = document.getElementById('templates-cards-container');
            
            if (!templates || templates.length === 0) {
                container.innerHTML = `
                    <div class="p-6 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg text-center">
                        <i class="fas fa-exclamation-triangle text-gray-400 text-3xl mb-2"></i>
                        <p class="text-gray-600 font-semibold">No templates loaded</p>
                        <p class="text-gray-500 text-sm mt-1">Clone a template in the company's AI Agent Logic tab</p>
                    </div>
                `;
                return;
            }
            
            // Render each template as a rich card (like the image)
            container.innerHTML = templates.map(template => `
                <div class="bg-white border-2 border-gray-200 rounded-xl p-6 shadow-sm hover:shadow-md transition-all">
                    <!-- Template Header -->
                    <div class="flex items-start gap-4 mb-4">
                        <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-green-600 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-brain text-white text-2xl"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-900 mb-1">${template.name}</h3>
                            <p class="text-sm text-gray-600">${template.description}</p>
                            <div class="flex items-center gap-3 mt-2 text-xs text-gray-500">
                                <span><i class="fas fa-code-branch mr-1"></i>${template.version}</span>
                                <span><i class="fas fa-calendar mr-1"></i>Activated: ${new Date(template.activatedAt).toLocaleDateString()}</span>
                                ${template.priority === 1 ? '<span class="px-2 py-0.5 bg-green-100 text-green-700 rounded-full font-semibold"><i class="fas fa-star mr-1"></i>Primary</span>' : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Template Stats -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-600">${template.stats.categories}</div>
                            <div class="text-xs text-gray-700 font-semibold mt-1"><i class="fas fa-folder"></i> Categories</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-green-600">${template.stats.scenarios}</div>
                            <div class="text-xs text-gray-700 font-semibold mt-1"><i class="fas fa-comments"></i> Scenarios</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-purple-600">${template.stats.triggers}</div>
                            <div class="text-xs text-gray-700 font-semibold mt-1"><i class="fas fa-bolt"></i> Triggers</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        /**
         * Render company customization cards with rich detail view
         */
        function renderCustomizationCards(customizations) {
            const container = document.getElementById('customizations-cards-container');
            
            if (!customizations) {
                container.innerHTML = `
                    <div class="p-6 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg text-center">
                        <i class="fas fa-info-circle text-gray-400 text-3xl mb-2"></i>
                        <p class="text-gray-600 font-semibold">No customizations configured</p>
                        <p class="text-gray-500 text-sm mt-1">This company uses default template settings</p>
                    </div>
                `;
                return;
            }
            
            const cards = [];
            
            // Custom Fillers Card
            if (customizations.customFillers && customizations.customFillers.count > 0) {
                const fillers = customizations.customFillers.items || [];
                cards.push(`
                    <div class="bg-white border-2 border-indigo-300 rounded-xl p-6 shadow-sm hover:shadow-md transition-all">
                        <div class="flex items-start gap-4 mb-4">
                            <div class="w-14 h-14 bg-gradient-to-br from-indigo-400 to-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-filter text-white text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-900 mb-1">Custom Fillers (${customizations.customFillers.count})</h3>
                                <p class="text-sm text-gray-600">Additional filler words beyond templates</p>
                            </div>
                        </div>
                        <div class="bg-indigo-50 rounded-lg p-4 max-h-32 overflow-y-auto custom-scrollbar">
                            ${fillers.length > 0 
                                ? '<div class="flex flex-wrap gap-2">' + fillers.map(filler => 
                                    `<span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium">"${filler}"</span>`
                                  ).join('') + '</div>'
                                : '<p class="text-gray-500 text-sm">No custom fillers configured</p>'
                            }
                        </div>
                    </div>
                `);
            }
            
            // Variables Card
            if (customizations.variables && customizations.variables.count > 0) {
                const vars = customizations.variables.data || {};
                const varEntries = Object.entries(vars);
                cards.push(`
                    <div class="bg-white border-2 border-emerald-300 rounded-xl p-6 shadow-sm hover:shadow-md transition-all">
                        <div class="flex items-start gap-4 mb-4">
                            <div class="w-14 h-14 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-code text-white text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-900 mb-1">Variables (${customizations.variables.count})</h3>
                                <p class="text-sm text-gray-600">Placeholder values for AI responses</p>
                            </div>
                        </div>
                        <div class="bg-emerald-50 rounded-lg p-4 max-h-32 overflow-y-auto custom-scrollbar">
                            ${varEntries.length > 0
                                ? '<div class="space-y-2 font-mono text-sm">' + varEntries.map(([key, value]) => 
                                    `<div class="flex items-start gap-2 p-2 bg-white rounded border border-emerald-200">
                                        <span class="text-emerald-700 font-bold">{${key}}:</span>
                                        <span class="text-gray-700 flex-1">"${value}"</span>
                                    </div>`
                                  ).join('') + '</div>'
                                : '<p class="text-gray-500 text-sm">No variables configured</p>'
                            }
                        </div>
                    </div>
                `);
            }
            
            // Disabled Scenarios - INDIVIDUAL PROMINENT CARDS (Critical Info!)
            if (customizations.disabledScenarios && customizations.disabledScenarios.count > 0) {
                const scenarios = customizations.disabledScenarios.items || [];
                scenarios.forEach(scenario => {
                    cards.push(`
                        <div class="bg-white border-2 border-red-400 rounded-xl p-6 shadow-md hover:shadow-lg transition-all relative overflow-hidden">
                            <!-- Danger Stripe -->
                            <div class="absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-red-500 to-red-600"></div>
                            
                            <!-- Header -->
                            <div class="flex items-start gap-4 mb-4 mt-2">
                                <div class="w-14 h-14 bg-gradient-to-br from-red-500 to-red-600 rounded-lg flex items-center justify-center flex-shrink-0 shadow-md">
                                    <i class="fas fa-ban text-white text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h3 class="text-lg font-bold text-gray-900">${scenario.scenarioName}</h3>
                                        <span class="px-2 py-0.5 bg-red-100 text-red-700 text-xs font-bold rounded-full">DISABLED</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-2">
                                        <i class="fas fa-folder text-gray-400 mr-1"></i>
                                        ${scenario.category} ‚Ä¢ ${scenario.templateName}
                                    </p>
                                    ${scenario.trigger ? `
                                        <div class="bg-red-50 px-3 py-2 rounded-lg border border-red-200">
                                            <p class="text-xs text-gray-600 mb-1"><i class="fas fa-bolt text-red-500 mr-1"></i><strong>Example Trigger:</strong></p>
                                            <p class="text-sm text-gray-800 italic">"${scenario.trigger}"</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Footer -->
                            <div class="flex items-center justify-between pt-4 border-t border-red-200">
                                <div class="text-xs text-gray-500 font-mono">
                                    <i class="fas fa-fingerprint mr-1"></i>
                                    ${scenario.scenarioId}
                                </div>
                                ${scenario.disabledAt ? `
                                    <div class="text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        Disabled ${new Date(scenario.disabledAt).toLocaleDateString()}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `);
                });
            }
            
            // If no customizations at all
            if (cards.length === 0) {
                container.innerHTML = `
                    <div class="p-6 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg text-center">
                        <i class="fas fa-check-circle text-green-400 text-3xl mb-2"></i>
                        <p class="text-gray-600 font-semibold">Using Default Template Settings</p>
                        <p class="text-gray-500 text-sm mt-1">No company-specific overrides configured</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cards.join('');
        }
        
        /**
         * When company is selected from Company Mode dropdown
         */
        async function onCompanySelected(companyId) {
            console.log(`üè¢ [COMPANY SELECTOR] Selected company: ${companyId || 'none'}`);
            
            const detailsContainer = document.getElementById('company-details-container');
            
            if (!companyId) {
                // Hide details container
                detailsContainer.style.display = 'none';
                return;
            }
            
            // Fetch company details
            try {
                const response = await fetch(`/api/admin/test-pilot/companies/${companyId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const company = data.company;
                
                // Show details container
                detailsContainer.style.display = 'block';
                
                // Update company header
                document.getElementById('company-test-current-name').textContent = company.name;
                document.getElementById('company-test-current-id').textContent = `ID: ${company._id}`;
                
                // Render template cards
                renderTemplateCards(company.templates);
                
                // Render customization cards with rich detail view
                renderCustomizationCards(company.customizations);
                
                console.log('‚úÖ [COMPANY SELECTOR] Rich details rendered');
                
                // Save activeCompanyId to backend
                await fetch('/api/admin/settings/company-test-mode', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({
                        activeCompanyId: companyId
                    })
                });
                
                console.log('‚úÖ [COMPANY SELECTOR] Company loaded and saved');
                
                // üöÄ AUTO-LOAD PRODUCTION INTELLIGENCE SETTINGS
                await loadCompanyProductionIntelligence();
                
            } catch (error) {
                console.error('‚ùå [COMPANY SELECTOR] Error:', error);
                showToast('error', `Failed to load company: ${error.message}`);
            }
        }
        
        // ================================================================
        // üöÄ COMPANY PRODUCTION INTELLIGENCE FUNCTIONS
        // ================================================================
        
        /**
         * Load Company Production Intelligence settings from backend
         * Called when: Company selected, page load, or manual reload
         */
        async function loadCompanyProductionIntelligence() {
            console.log('üìä [COMPANY INTELLIGENCE] Loading production settings...');
            
            // Get currently selected company
            const companyDropdown = document.getElementById('top-company-selector-dropdown');
            const companyId = companyDropdown?.value;
            
            if (!companyId) {
                console.log('‚ö†Ô∏è [COMPANY INTELLIGENCE] No company selected');
                return;
            }
            
            try {
                // Fetch company data (includes aiAgentLogic.productionIntelligence)
                const response = await fetch(`/api/admin/test-pilot/companies/${companyId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const company = data.company;
                const intelligence = company.aiAgentLogic?.productionIntelligence || {};
                
                console.log('‚úÖ [COMPANY INTELLIGENCE] Loaded settings:', intelligence);
                
                // ============================================================
                // UPDATE INTELLIGENCE MODE INDICATOR
                // ============================================================
                console.log('üîçüîçüîç [CHECKPOINT 1] Full API response data:', data);
                console.log('üîçüîçüîç [CHECKPOINT 2] Company object:', company);
                console.log('üîçüîçüîç [CHECKPOINT 3] company.intelligenceMode value:', company.intelligenceMode);
                console.log('üîçüîçüîç [CHECKPOINT 4] company.intelligenceMode type:', typeof company.intelligenceMode);
                console.log('üîçüîçüîç [CHECKPOINT 5] company.intelligenceMode === undefined:', company.intelligenceMode === undefined);
                console.log('üîçüîçüîç [CHECKPOINT 6] company hasOwnProperty intelligenceMode:', company.hasOwnProperty('intelligenceMode'));
                
                const intelligenceMode = company.intelligenceMode || 'global';
                
                console.log('üîçüîçüîç [CHECKPOINT 7] Final intelligenceMode after OR operator:', intelligenceMode);
                
                // TODO: Fetch global companies count from backend
                // For now, using placeholder count
                const globalCompaniesCount = 187; // TODO: Replace with actual count from API
                
                updateIntelligenceModeIndicator(intelligenceMode, company, globalCompaniesCount);
                
                // Populate UI with settings
                const enableTier3Checkbox = document.getElementById('company-enable-tier3');
                const tier1Slider = document.getElementById('company-tier1-slider');
                const tier2Slider = document.getElementById('company-tier2-slider');
                const llmModelSelect = document.getElementById('company-llm-model');
                const maxCostInput = document.getElementById('company-max-cost-per-call');
                const dailyBudgetInput = document.getElementById('company-daily-budget');
                
                // Set enable Tier 3 toggle (default: true)
                if (enableTier3Checkbox) {
                    const tier3Value = intelligence.thresholds?.enableTier3 !== false; // Default true
                    enableTier3Checkbox.checked = tier3Value;
                    console.log('üì• [COMPANY INTELLIGENCE] Loaded Tier 3 from database:', tier3Value, '(type:', typeof intelligence.thresholds?.enableTier3, ')');
                    updateTier3Status(); // Update card visual state
                }
                
                // Set thresholds
                if (tier1Slider) {
                    tier1Slider.value = intelligence.thresholds?.tier1 || 0.80;
                    updateCompanyTier1Value(tier1Slider.value);
                }
                
                if (tier2Slider) {
                    tier2Slider.value = intelligence.thresholds?.tier2 || 0.60;
                    updateCompanyTier2Value(tier2Slider.value);
                }
                
                // Set LLM model
                if (llmModelSelect) {
                    llmModelSelect.value = intelligence.llmConfig?.model || 'gpt-4o-mini';
                }
                
                // Set cost limits
                if (maxCostInput) {
                    maxCostInput.value = intelligence.llmConfig?.maxCostPerCall || 0.10;
                }
                
                if (dailyBudgetInput) {
                    // Daily budget is optional (null = unlimited)
                    dailyBudgetInput.value = intelligence.llmConfig?.dailyBudget || '';
                }
                
                // ============================================================
                // SMART WARMUP SETTINGS
                // ============================================================
                const warmup = intelligence.smartWarmup || {};
                
                console.log('üì• [COMPANY INTELLIGENCE] Loaded warmup from database:', warmup);
                console.log('üì• [COMPANY INTELLIGENCE] warmup.enabled value:', warmup.enabled, '(type:', typeof warmup.enabled, ')');
                
                const enableWarmupCheckbox = document.getElementById('company-enable-warmup');
                const warmupThresholdSlider = document.getElementById('company-warmup-threshold-slider');
                const warmupDailyBudgetInput = document.getElementById('company-warmup-daily-budget');
                const warmupAlwaysCategoriesInput = document.getElementById('company-warmup-always-categories');
                const warmupNeverCategoriesInput = document.getElementById('company-warmup-never-categories');
                const warmupPatternLearningCheckbox = document.getElementById('company-warmup-pattern-learning');
                const warmupMinHitRateInput = document.getElementById('company-warmup-min-hit-rate');
                
                // Set warmup enabled toggle
                if (enableWarmupCheckbox) {
                    const warmupValue = warmup.enabled === true; // STRICT: only true if explicitly true
                    enableWarmupCheckbox.checked = warmupValue;
                    console.log('üì• [COMPANY INTELLIGENCE] Loaded Warmup from database:', warmupValue, '(type:', typeof warmup.enabled, ')');
                    console.log('üì• [COMPANY INTELLIGENCE] Set warmup checkbox to:', enableWarmupCheckbox.checked);
                    updateWarmupStatus(); // Show/hide green banner based on enabled state
                }
                
                // Set warmup confidence threshold
                if (warmupThresholdSlider) {
                    warmupThresholdSlider.value = warmup.confidenceThreshold || 0.75;
                    updateCompanyWarmupThresholdValue(warmupThresholdSlider.value);
                }
                
                // Set warmup daily budget
                if (warmupDailyBudgetInput) {
                    warmupDailyBudgetInput.value = warmup.dailyBudget || 5.00;
                }
                
                // Set always/never warmup categories
                if (warmupAlwaysCategoriesInput) {
                    warmupAlwaysCategoriesInput.value = (warmup.alwaysWarmupCategories || []).join(', ');
                }
                
                if (warmupNeverCategoriesInput) {
                    warmupNeverCategoriesInput.value = (warmup.neverWarmupCategories || []).join(', ');
                }
                
                // Set pattern learning
                if (warmupPatternLearningCheckbox) {
                    warmupPatternLearningCheckbox.checked = warmup.enablePatternLearning !== false;
                }
                
                // Set minimum hit rate
                if (warmupMinHitRateInput) {
                    warmupMinHitRateInput.value = warmup.minimumHitRate || 0.30;
                }
                
                // Load warmup analytics (if warmup is enabled)
                if (warmup.enabled) {
                    await loadWarmupAnalytics(companyId);
                }
                
                // Update cost estimates
                updateCompanyCostEstimate();
                
                console.log('‚úÖ [COMPANY INTELLIGENCE] UI populated successfully (including warmup settings)');
                
            } catch (error) {
                console.error('‚ùå [COMPANY INTELLIGENCE] Failed to load:', error);
                showToast('error', `Failed to load production intelligence: ${error.message}`);
            }
        }
        
        /**
         * Save Company Production Intelligence settings to backend
         */
        async function saveCompanyProductionIntelligence() {
            console.log('üíæ [COMPANY INTELLIGENCE] ========== SAVE INITIATED ==========');
            console.log('üíæ [COMPANY INTELLIGENCE] Saving production settings...');
            
            // Get currently selected company
            const companyDropdown = document.getElementById('top-company-selector-dropdown');
            const companyId = companyDropdown?.value;
            
            console.log('üíæ [COMPANY INTELLIGENCE] Selected company ID:', companyId);
            
            if (!companyId) {
                alert('‚ùå ERROR: Please select a company first!');
                showToast('error', 'Please select a company first');
                return;
            }
            
            // Disable save button during save
            const saveButton = event?.target;
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            }
            
            try {
                // Collect all settings from UI
                const settings = {
                    enabled: true,
                    thresholds: {
                        tier1: parseFloat(document.getElementById('company-tier1-slider')?.value || 0.80),
                        tier2: parseFloat(document.getElementById('company-tier2-slider')?.value || 0.60),
                        enableTier3: document.getElementById('company-enable-tier3')?.checked !== false // Default true, but respect false
                    },
                    llmConfig: {
                        model: document.getElementById('company-llm-model')?.value || 'gpt-4o-mini',
                        maxCostPerCall: parseFloat(document.getElementById('company-max-cost-per-call')?.value || 0.10)
                    }
                };
                
                // Add daily budget if set (optional)
                const dailyBudget = document.getElementById('company-daily-budget')?.value;
                if (dailyBudget && parseFloat(dailyBudget) > 0) {
                    settings.llmConfig.dailyBudget = parseFloat(dailyBudget);
                }
                
                // ============================================================
                // SMART WARMUP SETTINGS
                // ============================================================
                const warmupEnabled = document.getElementById('company-enable-warmup')?.checked;
                
                // Helper: Parse comma-separated categories
                const parseCategories = (input) => {
                    if (!input) return [];
                    return input.split(',').map(c => c.trim()).filter(c => c.length > 0);
                };
                
                settings.smartWarmup = {
                    enabled: warmupEnabled === true, // STRICT: only true if explicitly checked
                    confidenceThreshold: parseFloat(document.getElementById('company-warmup-threshold-slider')?.value || 0.75),
                    dailyBudget: parseFloat(document.getElementById('company-warmup-daily-budget')?.value || 5.00),
                    enablePatternLearning: document.getElementById('company-warmup-pattern-learning')?.checked !== false,
                    minimumHitRate: parseFloat(document.getElementById('company-warmup-min-hit-rate')?.value || 0.30),
                    alwaysWarmupCategories: parseCategories(document.getElementById('company-warmup-always-categories')?.value),
                    neverWarmupCategories: parseCategories(document.getElementById('company-warmup-never-categories')?.value)
                };
                
                const tier3Enabled = document.getElementById('company-enable-tier3')?.checked;
                
                console.log('üì§ [COMPANY INTELLIGENCE] Tier 3 checkbox state:', tier3Enabled, '(type:', typeof tier3Enabled, ')');
                console.log('üì§ [COMPANY INTELLIGENCE] Warmup checkbox state:', warmupEnabled, '(type:', typeof warmupEnabled, ')');
                console.log('üì§ [COMPANY INTELLIGENCE] Sending settings (including warmup):', settings);
                console.log('üì§ [COMPANY INTELLIGENCE] Request URL:', `/api/company/${companyId}/intelligence`);
                
                // Send to backend
                const response = await fetch(`/api/company/${companyId}/intelligence`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({ productionIntelligence: settings })
                });
                
                console.log('üì§ [COMPANY INTELLIGENCE] Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('‚ùå [COMPANY INTELLIGENCE] Server error:', errorData);
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                console.log('‚úÖ [COMPANY INTELLIGENCE] Saved successfully:', result);
                console.log('‚úÖ [COMPANY INTELLIGENCE] ========== SAVE COMPLETE ==========');
                
                // Show prominent success message
                showToast('success', '‚úÖ Production Intelligence settings saved!');
                alert('‚úÖ SUCCESS!\n\nProduction Intelligence settings have been saved to the database.\n\n' + 
                      '3-Tier System: ' + (tier3Enabled ? 'ENABLED ‚úÖ' : 'DISABLED ‚ùå') + '\n' +
                      'Warmup Status: ' + (warmupEnabled ? 'ENABLED ‚úÖ' : 'DISABLED ‚ùå'));
                
            } catch (error) {
                console.error('‚ùå [COMPANY INTELLIGENCE] Save failed:', error);
                console.error('‚ùå [COMPANY INTELLIGENCE] Error stack:', error.stack);
                console.log('‚ùå [COMPANY INTELLIGENCE] ========== SAVE FAILED ==========');
                showToast('error', `Failed to save: ${error.message}`);
                alert('‚ùå SAVE FAILED!\n\n' + error.message + '\n\nCheck console for details.');
            } finally {
                // Re-enable save button
                const saveButton = document.querySelector('button[onclick="saveCompanyProductionIntelligence()"]');
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>Save Production Intelligence Settings';
                }
            }
        }
        
        /**
         * Update Tier 1 slider value display
         */
        function updateCompanyTier1Value(value) {
            const valueDisplay = document.getElementById('company-tier1-value');
            if (valueDisplay) {
                valueDisplay.textContent = parseFloat(value).toFixed(2);
            }
            updateCompanyCostEstimate();
        }
        
        /**
         * Update Tier 2 slider value display
         */
        function updateCompanyTier2Value(value) {
            const valueDisplay = document.getElementById('company-tier2-value');
            if (valueDisplay) {
                valueDisplay.textContent = parseFloat(value).toFixed(2);
            }
            updateCompanyCostEstimate();
        }
        
        /**
         * Update Warmup Threshold slider value display
         */
        function updateCompanyWarmupThresholdValue(value) {
            const valueDisplay = document.getElementById('company-warmup-threshold-value');
            if (valueDisplay) {
                valueDisplay.textContent = parseFloat(value).toFixed(2);
            }
        }
        
        /**
         * Toggle warmup card (user clicks the card to enable/disable)
         */
        function toggleWarmupCard() {
            const checkbox = document.getElementById('company-enable-warmup');
            const oldState = checkbox.checked;
            checkbox.checked = !checkbox.checked;
            console.log('üî• [WARMUP TOGGLE] User clicked card - Changed from', oldState, 'to', checkbox.checked);
            updateWarmupStatus();
        }
        
        /**
         * Update warmup card visual state (green active vs gray disabled)
         */
        function updateWarmupStatus() {
            const checkbox = document.getElementById('company-enable-warmup');
            const enabled = checkbox?.checked || false;
            
            const card = document.getElementById('warmup-toggle-card');
            const dot = document.getElementById('warmup-status-dot');
            const iconContainer = document.getElementById('warmup-icon-container');
            const icon = document.getElementById('warmup-icon');
            const title = document.getElementById('warmup-title');
            const description = document.getElementById('warmup-description');
            const banner = document.getElementById('warmup-status-banner');
            
            console.log('üî• [WARMUP CARD] Toggle:', enabled ? 'ENABLED' : 'DISABLED');
            
            if (enabled) {
                // GREEN ACTIVE STATE (like your image)
                card.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
                card.style.borderColor = '#10b981';
                dot.style.background = '#10b981';
                iconContainer.style.background = '#10b981';
                icon.className = 'fas fa-check text-white';
                title.textContent = 'Smart Warmup Enabled';
                title.className = 'text-base font-bold text-green-800';
                description.textContent = 'LLM pre-warming active during Tier 2';
                description.className = 'text-sm text-green-700 mt-1';
                
                // Show green banner
                if (banner) banner.classList.remove('hidden');
                
            } else {
                // GRAY DISABLED STATE
                card.style.background = '#f3f4f6';
                card.style.borderColor = '#d1d5db';
                dot.style.background = '#9ca3af';
                iconContainer.style.background = '#e5e7eb';
                icon.className = 'fas fa-times text-gray-600';
                title.textContent = 'Smart Warmup Disabled';
                title.className = 'text-base font-bold text-gray-700';
                description.textContent = 'Click to enable LLM pre-warming';
                description.className = 'text-sm text-gray-600 mt-1';
                
                // Hide green banner
                if (banner) banner.classList.add('hidden');
            }
        }
        
        /**
         * Toggle warmup settings visibility (expand/collapse)
         * This is INDEPENDENT of the enable/disable toggle
         */
        function toggleWarmupSettingsVisibility() {
            const container = document.getElementById('warmup-settings-container');
            const icon = document.getElementById('warmup-expand-icon');
            
            if (container && icon) {
                const isHidden = container.classList.contains('hidden');
                
                if (isHidden) {
                    // Expand
                    container.classList.remove('hidden');
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                    console.log('üìÇ [WARMUP SETTINGS] Expanded');
                } else {
                    // Collapse
                    container.classList.add('hidden');
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                    console.log('üìÅ [WARMUP SETTINGS] Collapsed');
                }
            }
        }
        
        /**
         * Toggle 3-Tier System card (user clicks the card to enable/disable)
         */
        function toggleTier3Card() {
            const checkbox = document.getElementById('company-enable-tier3');
            const oldState = checkbox.checked;
            checkbox.checked = !checkbox.checked;
            console.log('üß† [TIER3 TOGGLE] User clicked card - Changed from', oldState, 'to', checkbox.checked);
            updateTier3Status();
            updateCompanyCostEstimate(); // Update cost when tier3 changes
        }
        
        /**
         * Update 3-Tier System card visual state (green enabled vs gray disabled)
         */
        function updateTier3Status() {
            const checkbox = document.getElementById('company-enable-tier3');
            const enabled = checkbox?.checked !== false; // Default to enabled
            
            const card = document.getElementById('tier3-toggle-card');
            const dot = document.getElementById('tier3-status-dot');
            const iconContainer = document.getElementById('tier3-icon-container');
            const icon = document.getElementById('tier3-icon');
            const title = document.getElementById('tier3-title');
            const description = document.getElementById('tier3-description');
            
            console.log('üß† [TIER3 CARD] Toggle:', enabled ? 'ENABLED' : 'DISABLED');
            
            if (enabled) {
                // GREEN ENABLED STATE
                card.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
                card.style.borderColor = '#10b981';
                dot.style.background = '#10b981';
                iconContainer.style.background = '#10b981';
                icon.className = 'fas fa-check text-white';
                title.textContent = '3-Tier Intelligence System Enabled';
                title.className = 'text-base font-bold text-green-800';
                description.textContent = 'Tier 1 (Rules) ‚Üí Tier 2 (Semantic) ‚Üí Tier 3 (LLM Fallback)';
                description.className = 'text-sm text-green-700 mt-1';
            } else {
                // RED DISABLED STATE
                card.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
                card.style.borderColor = '#ef4444';
                dot.style.background = '#ef4444';
                iconContainer.style.background = '#ef4444';
                icon.className = 'fas fa-times text-white';
                title.textContent = '3-Tier Intelligence System Disabled';
                title.className = 'text-base font-bold text-red-800';
                description.textContent = 'Tier 1 & 2 only - 100% free, but may fail on edge cases';
                description.className = 'text-sm text-red-700 mt-1';
            }
        }
        
        /**
         * Load warmup analytics from backend
         */
        async function loadWarmupAnalytics(companyId) {
            try {
                console.log('üìä [WARMUP ANALYTICS] Loading for company:', companyId);
                
                const response = await fetch(`/api/company/${companyId}/warmup-analytics`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è [WARMUP ANALYTICS] Failed to load analytics');
                    return;
                }
                
                const analytics = await response.json();
                
                console.log('‚úÖ [WARMUP ANALYTICS] Loaded:', analytics);
                
                // Update UI
                const hitRateDisplay = document.getElementById('company-warmup-hit-rate');
                const costDisplay = document.getElementById('company-warmup-cost');
                const timeSavedDisplay = document.getElementById('company-warmup-time-saved');
                
                if (hitRateDisplay) {
                    hitRateDisplay.textContent = analytics.hitRate !== undefined 
                        ? `${(analytics.hitRate * 100).toFixed(1)}%` 
                        : 'N/A';
                }
                
                if (costDisplay) {
                    costDisplay.textContent = analytics.totalCost !== undefined 
                        ? `$${analytics.totalCost.toFixed(2)}` 
                        : '$0.00';
                }
                
                if (timeSavedDisplay) {
                    timeSavedDisplay.textContent = analytics.avgTimeSaved !== undefined 
                        ? `${analytics.avgTimeSaved}ms` 
                        : '0ms';
                }
                
            } catch (error) {
                console.error('‚ùå [WARMUP ANALYTICS] Error loading analytics:', error);
            }
        }
        
        /**
         * Calculate and update cost estimate
         * Based on thresholds, predict Tier 1/2/3 distribution and monthly cost
         */
        function updateCompanyCostEstimate() {
            console.log('üí∞ [COST ESTIMATE] Calculating...');
            
            const tier1Threshold = parseFloat(document.getElementById('company-tier1-slider')?.value || 0.80);
            const tier2Threshold = parseFloat(document.getElementById('company-tier2-slider')?.value || 0.60);
            const llmModel = document.getElementById('company-llm-model')?.value || 'gpt-4o-mini';
            const enableTier3 = document.getElementById('company-enable-tier3')?.checked;
            
            // Estimate tier distribution based on thresholds
            // Lower thresholds = more queries escalate to higher tiers
            const tier1Percent = Math.round(tier1Threshold * 100); // e.g., 0.80 = 80%
            const tier2Percent = enableTier3 ? Math.round((1 - tier1Threshold) * 100 * 0.7) : Math.round((1 - tier1Threshold) * 100); // 70% of remaining
            const tier3Percent = enableTier3 ? Math.round((1 - tier1Threshold) * 100 * 0.3) : 0; // 30% of remaining
            
            // Cost per LLM call (Tier 3 only)
            const costPerCall = {
                'gpt-4o': 0.10,
                'gpt-4o-mini': 0.04,
                'gpt-3.5-turbo': 0.01
            }[llmModel] || 0.04;
            
            // Estimate monthly cost (1,000 calls/month)
            const monthlyCallVolume = 1000;
            const tier3Calls = (tier3Percent / 100) * monthlyCallVolume;
            const monthlyCost = tier3Calls * costPerCall;
            
            // Update UI
            document.getElementById('company-tier1-percent').textContent = `${tier1Percent}%`;
            document.getElementById('company-tier2-percent').textContent = `${tier2Percent}%`;
            document.getElementById('company-tier3-percent').textContent = `${tier3Percent}%`;
            document.getElementById('company-monthly-cost-estimate').textContent = `$${monthlyCost.toFixed(2)}`;
            
            console.log(`‚úÖ [COST ESTIMATE] T1: ${tier1Percent}%, T2: ${tier2Percent}%, T3: ${tier3Percent}%, Monthly: $${monthlyCost.toFixed(2)}`);
        }
        
        /**
         * ================================================================
         * BETA MODEL SAFETY FUNCTIONS
         * ================================================================
         * Protect production from untested models
         */
        
        /**
         * Toggle visibility of beta/testing models in dropdown
         */
        function toggleBetaModels() {
            const checkbox = document.getElementById('show-beta-models');
            const betaGroup = document.getElementById('beta-models-group');
            
            if (!checkbox || !betaGroup) return;
            
            if (checkbox.checked) {
                betaGroup.style.display = '';
                console.log('üß™ [BETA MODELS] Showing testing models');
            } else {
                betaGroup.style.display = 'none';
                console.log('üß™ [BETA MODELS] Hiding testing models');
                
                // If a beta model is currently selected, reset to safe default
                const modelSelect = document.getElementById('company-llm-model');
                if (modelSelect && isBetaModel(modelSelect.value)) {
                    modelSelect.value = 'gpt-4o-mini';
                    checkBetaModelWarning();
                    showToast('info', 'Reset to safe default model (GPT-4o-mini)');
                }
            }
        }
        
        /**
         * Check if selected model is a beta model and show warning
         */
        function checkBetaModelWarning() {
            const modelSelect = document.getElementById('company-llm-model');
            const warning = document.getElementById('beta-model-warning');
            
            if (!modelSelect || !warning) return;
            
            const selectedModel = modelSelect.value;
            
            if (isBetaModel(selectedModel)) {
                warning.classList.remove('hidden');
                console.warn('‚ö†Ô∏è [BETA MODEL] Beta model selected:', selectedModel);
            } else {
                warning.classList.add('hidden');
            }
        }
        
        /**
         * Check if a model is in beta/testing phase
         * ADD NEW BETA MODELS HERE when testing new releases
         */
        function isBetaModel(modelName) {
            const betaModels = [
                'gpt-4.5-preview',
                'gpt-5-preview',
                'o1-preview',
                'o1-mini'
                // Add new beta models here
            ];
            
            return betaModels.includes(modelName) || 
                   modelName.includes('preview') || 
                   modelName.includes('beta');
        }
        
        /**
         * ================================================================
         * INTELLIGENCE MODE MANAGEMENT
         * ================================================================
         * Control global vs custom intelligence mode switching
         */
        
        /**
         * Update the visual mode indicator badge
         * @param {string} mode - 'global' or 'custom'
         * @param {Object} company - Company data including name
         * @param {number} globalCompaniesCount - Total companies using global mode
         */
        function updateIntelligenceModeIndicator(mode, company, globalCompaniesCount = 0) {
            console.log('üîçüîçüîç [CHECKPOINT 8] updateIntelligenceModeIndicator() CALLED');
            console.log('üîçüîçüîç [CHECKPOINT 9] mode parameter received:', mode);
            console.log('üîçüîçüîç [CHECKPOINT 10] mode parameter type:', typeof mode);
            console.log('üîçüîçüîç [CHECKPOINT 11] company parameter:', company);
            console.log('üîçüîçüîç [CHECKPOINT 12] company.intelligenceMode from parameter:', company?.intelligenceMode);
            
            const indicator = document.getElementById('company-intelligence-mode-indicator');
            const iconContainer = document.getElementById('mode-icon-container');
            const icon = document.getElementById('mode-icon');
            const badgeText = document.getElementById('mode-badge-text');
            const subtitle = document.getElementById('mode-subtitle');
            const description = document.getElementById('mode-description');
            const switchBtn = document.getElementById('switch-mode-btn');
            const switchBtnText = document.getElementById('switch-btn-text');
            const globalCountDiv = document.getElementById('global-companies-count');
            const globalCountTotal = document.getElementById('global-companies-total');
            
            if (!indicator) return;
            
            // Set mode data attribute (CRITICAL for mode switching logic)
            indicator.setAttribute('data-intelligence-mode', mode);
            console.log(`üîç [MODE INDICATOR] Set data-intelligence-mode attribute to: ${mode}`);
            
            if (mode === 'global') {
                // GLOBAL MODE STYLING
                indicator.className = 'mb-6 p-4 rounded-lg border-2 bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-400';
                iconContainer.className = 'w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg';
                icon.className = 'fas fa-globe text-white text-xl';
                badgeText.textContent = 'üåç GLOBAL MODE';
                badgeText.className = 'font-bold text-lg text-blue-800';
                subtitle.textContent = '(using platform defaults)';
                subtitle.className = 'text-sm text-blue-600';
                description.textContent = 'This company inherits intelligence settings from global platform configuration. All updates to global settings will automatically apply here.';
                description.className = 'text-xs mt-1 text-blue-700';
                switchBtn.className = 'px-4 py-2 rounded-lg font-semibold transition-all text-sm bg-white hover:bg-blue-50 text-blue-700 border-2 border-blue-400';
                switchBtnText.textContent = 'Switch to Custom';
                
                // Show global companies count
                if (globalCountDiv && globalCountTotal) {
                    globalCountTotal.textContent = globalCompaniesCount;
                    globalCountDiv.className = 'mt-3 pt-3 border-t border-blue-300 text-xs font-semibold text-blue-700';
                }
                
            } else if (mode === 'custom') {
                // CUSTOM MODE STYLING
                indicator.className = 'mb-6 p-4 rounded-lg border-2 bg-gradient-to-r from-purple-50 to-pink-50 border-purple-400';
                iconContainer.className = 'w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br from-purple-500 to-pink-600 shadow-lg';
                icon.className = 'fas fa-cog text-white text-xl';
                badgeText.textContent = '‚öôÔ∏è CUSTOM MODE';
                badgeText.className = 'font-bold text-lg text-purple-800';
                subtitle.textContent = '(independent settings)';
                subtitle.className = 'text-sm text-purple-600';
                description.textContent = 'This company uses custom intelligence settings. Changes to global settings will NOT affect this company. All settings are managed independently.';
                description.className = 'text-xs mt-1 text-purple-700';
                switchBtn.className = 'px-4 py-2 rounded-lg font-semibold transition-all text-sm bg-white hover:bg-purple-50 text-purple-700 border-2 border-purple-400';
                switchBtnText.textContent = 'Switch to Global';
                
                // Hide global companies count
                if (globalCountDiv) {
                    globalCountDiv.className = 'hidden';
                }
            }
            
            console.log(`üé® [MODE INDICATOR] Updated to: ${mode.toUpperCase()}`);
            
            // ================================================================
            // üëÅÔ∏è SHOW/HIDE SECTIONS BASED ON MODE
            // ================================================================
            // GLOBAL MODE: Hide company custom settings, show global settings
            // CUSTOM MODE: Show company custom settings, hide global settings
            // ================================================================
            const companySettingsContainer = document.getElementById('company-intelligence-settings');
            const globalContainer = document.getElementById('global-intelligence-container');
            
            if (mode === 'global') {
                // Company is using global defaults - hide custom settings, show global
                if (companySettingsContainer) {
                    companySettingsContainer.style.display = 'none';
                    console.log('üëÅÔ∏è [VISIBILITY] Hidden company custom settings (company is in GLOBAL mode)');
                }
                if (globalContainer) {
                    globalContainer.style.display = 'block';
                    console.log('üëÅÔ∏è [VISIBILITY] Showing global settings section');
                    
                    // Load global settings from database
                    loadGlobalProductionIntelligence();
                }
            } else if (mode === 'custom') {
                // Company has custom settings - show custom settings, hide global
                if (companySettingsContainer) {
                    companySettingsContainer.style.display = 'block';
                    console.log('üëÅÔ∏è [VISIBILITY] Showing company custom settings (company is in CUSTOM mode)');
                }
                if (globalContainer) {
                    globalContainer.style.display = 'none';
                    console.log('üëÅÔ∏è [VISIBILITY] Hidden global settings section');
                }
            }
        }
        
        /**
         * Show the mode switch confirmation modal
         */
        function showModeSwitchModal() {
            const companyDropdown = document.getElementById('top-company-selector-dropdown');
            const companyId = companyDropdown?.value;
            
            if (!companyId) {
                showToast('error', 'Please select a company first');
                return;
            }
            
            // Get current mode from indicator
            const indicator = document.getElementById('company-intelligence-mode-indicator');
            const currentMode = indicator?.getAttribute('data-intelligence-mode') || 'global';
            const newMode = currentMode === 'global' ? 'custom' : 'global';
            
            console.log(`üîç [MODE SWITCH MODAL] Current mode from indicator: ${currentMode}`);
            console.log(`üîç [MODE SWITCH MODAL] Target new mode: ${newMode}`);
            
            // Get company name from dropdown
            const selectedOption = companyDropdown.options[companyDropdown.selectedIndex];
            const companyName = selectedOption?.text || 'Unknown Company';
            
            // Determine confirmation text and warning message
            let confirmText, modalTitle, modalWarning, confirmationPhrase;
            
            if (newMode === 'custom') {
                modalTitle = '‚ö†Ô∏è CRITICAL: Switch to Custom Intelligence Settings?';
                modalWarning = `
                    <strong>Company:</strong> ${companyName}<br>
                    <strong>Current Mode:</strong> GLOBAL (using platform defaults)<br>
                    <strong>New Mode:</strong> CUSTOM (independent settings)<br><br>
                    
                    ‚ö†Ô∏è <strong>This company will NO LONGER receive automatic updates when global intelligence settings are improved.</strong><br><br>
                    
                    A copy of current global settings will be created for this company to start with.
                `;
                confirmationPhrase = 'SWITCH TO CUSTOM';
            } else {
                modalTitle = '‚ö†Ô∏è CRITICAL: Switch to Global Intelligence Settings?';
                modalWarning = `
                    <strong>Company:</strong> ${companyName}<br>
                    <strong>Current Mode:</strong> CUSTOM (independent settings)<br>
                    <strong>New Mode:</strong> GLOBAL (platform defaults)<br><br>
                    
                    ‚ö†Ô∏è <strong>All custom intelligence settings for this company will be ARCHIVED (not deleted, can be restored).</strong><br><br>
                    
                    This company will automatically receive platform-wide intelligence updates going forward.
                `;
                confirmationPhrase = 'SWITCH TO GLOBAL';
            }
            
            // Create modal HTML
            const modalHTML = `
                <div id="mode-switch-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="animation: fadeIn 0.2s;">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 p-6" style="animation: slideUp 0.3s;">
                        
                        <!-- Modal Header -->
                        <div class="flex items-start gap-3 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-500 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-900">${modalTitle}</h3>
                            </div>
                        </div>
                        
                        <!-- Warning Content -->
                        <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded mb-4">
                            <p class="text-sm text-amber-900 leading-relaxed">
                                ${modalWarning}
                            </p>
                        </div>
                        
                        <!-- Typed Confirmation -->
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-800 mb-2">
                                Type "<span class="text-red-600">${confirmationPhrase}</span>" to confirm:
                            </label>
                            <input type="text" 
                                   id="mode-switch-confirmation-input" 
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 text-sm font-mono"
                                   placeholder="${confirmationPhrase}"
                                   autocomplete="off">
                            <p id="mode-switch-error" class="hidden text-xs text-red-600 mt-1 font-semibold">
                                ‚ùå Confirmation text does not match. Please type exactly: ${confirmationPhrase}
                            </p>
                        </div>
                        
                        <!-- Optional Reason -->
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-800 mb-2">
                                Reason for switch (optional):
                            </label>
                            <textarea id="mode-switch-reason" 
                                      class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 text-sm"
                                      rows="2"
                                      placeholder="e.g., Premium client needs custom warmup settings"></textarea>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex items-center justify-end gap-3">
                            <button onclick="closeModeSwitchModal()" 
                                    class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition-all">
                                Cancel
                            </button>
                            <button onclick="confirmModeSwitch('${newMode}', '${companyName}', '${confirmationPhrase}')" 
                                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all shadow-lg">
                                <i class="fas fa-exchange-alt mr-1"></i>
                                Confirm Switch
                            </button>
                        </div>
                        
                    </div>
                </div>
            `;
            
            // Add modal to page
            const modalContainer = document.getElementById('modal-container') || document.body;
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            modalContainer.appendChild(modalDiv.firstElementChild);
            
            // Focus on confirmation input
            setTimeout(() => {
                document.getElementById('mode-switch-confirmation-input')?.focus();
            }, 100);
        }
        
        /**
         * Close the mode switch modal
         */
        function closeModeSwitchModal() {
            const modal = document.getElementById('mode-switch-modal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.2s';
                setTimeout(() => modal.remove(), 200);
            }
        }
        
        /**
         * Confirm and execute the mode switch
         */
        async function confirmModeSwitch(newMode, companyName, expectedPhrase) {
            const confirmationInput = document.getElementById('mode-switch-confirmation-input');
            const reasonInput = document.getElementById('mode-switch-reason');
            const errorMsg = document.getElementById('mode-switch-error');
            
            const userInput = confirmationInput?.value.trim().toUpperCase();
            
            // Validate typed confirmation
            if (userInput !== expectedPhrase) {
                errorMsg?.classList.remove('hidden');
                confirmationInput?.classList.add('border-red-500');
                return;
            }
            
            // Get company ID
            const companyDropdown = document.getElementById('top-company-selector-dropdown');
            const companyId = companyDropdown?.value;
            
            if (!companyId) {
                showToast('error', 'Company ID not found');
                return;
            }
            
            // Get admin email (you might want to get this from localStorage or a user session)
            const adminEmail = 'admin@clientsvia.com'; // TODO: Get from actual session
            
            const reason = reasonInput?.value.trim() || null;
            
            console.log(`üîÑ [MODE SWITCH] Initiating switch to ${newMode} for company: ${companyName}`);
            
            try {
                // Call backend API
                const response = await fetch(`/api/company/${companyId}/intelligence-mode`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({
                        newMode,
                        confirmation: expectedPhrase,
                        reason,
                        adminEmail
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                console.log('‚úÖ [MODE SWITCH] Success:', result);
                
                // Close modal
                closeModeSwitchModal();
                
                // Show success toast
                showToast('success', `Intelligence mode switched to ${newMode.toUpperCase()}`, 5000);
                
                // Reload company production intelligence to reflect new mode
                await loadCompanyProductionIntelligence();
                
            } catch (error) {
                console.error('‚ùå [MODE SWITCH] Error:', error);
                showToast('error', `Failed to switch mode: ${error.message}`);
            }
        }
        
        // ================================================================
        // END: Company Production Intelligence Functions
        // ================================================================
        
        // ================================================================
        // üåç GLOBAL PLATFORM INTELLIGENCE FUNCTIONS
        // ================================================================
        
        // Global edit mode state
        let globalEditMode = false;
        let globalEditTimeout = null;
        let globalEditTimeoutSeconds = 600; // 10 minutes
        
        /**
         * Toggle global edit mode (lock/unlock)
         */
        async function toggleGlobalEditMode() {
            if (globalEditMode) {
                // Currently unlocked, lock it
                lockGlobalEditMode();
            } else {
                // Currently locked, show unlock confirmation
                showGlobalUnlockConfirmationModal();
            }
        }
        
        /**
         * Show unlock confirmation modal
         */
        function showGlobalUnlockConfirmationModal() {
            const modalHTML = `
                <div id="global-unlock-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="animation: fadeIn 0.2s;">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 p-6" style="animation: slideUp 0.3s;">
                        
                        <!-- Modal Header -->
                        <div class="flex items-start gap-3 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-orange-500 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-unlock text-white text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-900">‚ö†Ô∏è WARNING: You are about to edit GLOBAL intelligence settings</h3>
                            </div>
                        </div>
                        
                        <!-- Warning Content -->
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded mb-4">
                            <p class="text-sm text-red-900 leading-relaxed mb-3">
                                <strong>This will affect ALL companies using global mode.</strong><br><br>
                                
                                <strong>Companies affected:</strong> <span id="unlock-companies-count" class="font-mono">Loading...</span><br><br>
                                
                                Changes to global settings propagate IMMEDIATELY to all companies in global mode.
                                Only proceed if you have admin approval and understand the impact.
                            </p>
                        </div>
                        
                        <!-- Typed Confirmation -->
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-800 mb-2">
                                Type "<span class="text-red-600">UNLOCK GLOBAL EDIT</span>" to confirm:
                            </label>
                            <input type="text" 
                                   id="global-unlock-confirmation-input" 
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-sm font-mono"
                                   placeholder="UNLOCK GLOBAL EDIT"
                                   autocomplete="off">
                            <p id="global-unlock-error" class="hidden text-xs text-red-600 mt-1 font-semibold">
                                ‚ùå Confirmation text does not match. Please type exactly: UNLOCK GLOBAL EDIT
                            </p>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex items-center justify-end gap-3">
                            <button onclick="closeGlobalUnlockModal()" 
                                    class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition-all">
                                Cancel
                            </button>
                            <button onclick="confirmGlobalUnlock()" 
                                    class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-all shadow-lg">
                                <i class="fas fa-unlock mr-1"></i>
                                Unlock for Editing
                            </button>
                        </div>
                        
                    </div>
                </div>
            `;
            
            // Add modal to page
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv.firstElementChild);
            
            // Load companies count
            loadGlobalCompaniesCount();
            
            // Focus on confirmation input
            setTimeout(() => {
                document.getElementById('global-unlock-confirmation-input')?.focus();
            }, 100);
        }
        
        /**
         * Load count of companies using global mode
         */
        async function loadGlobalCompaniesCount() {
            try {
                console.log('üë• [GLOBAL] Loading companies count from database...');
                
                // Call REAL API endpoint to get actual database count
                const response = await fetch('/api/admin/global-intelligence/stats', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const count = data.stats.usingGlobal; // Real count from MongoDB
                
                console.log(`‚úÖ [GLOBAL] Loaded REAL companies count: ${count} (${data.stats.percentGlobal}% of ${data.stats.total} total)`);
                
                const countElement = document.getElementById('unlock-companies-count');
                if (countElement) {
                    countElement.textContent = count;
                }
                
                // Update other count displays
                document.getElementById('global-companies-affected-count').textContent = count;
                document.getElementById('global-warning-company-count').textContent = count;
                
            } catch (error) {
                console.error('‚ùå [GLOBAL] Failed to load companies count:', error);
                // Fallback: Show ? instead of fake data
                document.getElementById('global-companies-affected-count').textContent = '?';
                document.getElementById('global-warning-company-count').textContent = '?';
            }
        }
        
        /**
         * Close unlock modal
         */
        function closeGlobalUnlockModal() {
            const modal = document.getElementById('global-unlock-modal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.2s';
                setTimeout(() => modal.remove(), 200);
            }
        }
        
        /**
         * Confirm and execute unlock
         */
        function confirmGlobalUnlock() {
            const input = document.getElementById('global-unlock-confirmation-input');
            const errorMsg = document.getElementById('global-unlock-error');
            
            const userInput = input?.value.trim().toUpperCase();
            
            if (userInput !== 'UNLOCK GLOBAL EDIT') {
                errorMsg?.classList.remove('hidden');
                input?.classList.add('border-red-500');
                return;
            }
            
            // Close modal
            closeGlobalUnlockModal();
            
            // Activate edit mode
            activateGlobalEditMode();
            
            showToast('warning', 'Global Edit Mode UNLOCKED - Changes will affect all companies!', 5000);
        }
        
        /**
         * Activate edit mode (after confirmation)
         */
        function activateGlobalEditMode() {
            globalEditMode = true;
            
            // Update UI
            const lockBtn = document.getElementById('global-lock-unlock-btn');
            const lockIcon = document.getElementById('global-lock-icon');
            const lockText = document.getElementById('global-lock-text');
            const warningBanner = document.getElementById('global-edit-warning-banner');
            const settingsContainer = document.getElementById('global-intelligence-settings');
            const saveBtn = document.getElementById('global-save-btn');
            
            // Update lock button
            lockBtn.className = 'px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-semibold transition-all text-sm border-2 border-red-400';
            lockIcon.className = 'fas fa-unlock mr-1';
            lockText.textContent = 'Lock Edit Mode';
            
            // Show warning banner
            warningBanner.classList.remove('hidden');
            
            // Enable settings
            settingsContainer.classList.remove('opacity-60', 'pointer-events-none');
            settingsContainer.classList.add('opacity-100');
            
            // Enable save button
            saveBtn.disabled = false;
            saveBtn.className = 'w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-bold shadow-lg hover:shadow-xl transition-all text-lg';
            saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Global Intelligence Settings';
            
            // Start auto-lock timer
            startGlobalEditTimeout();
            
            console.log('üîì [GLOBAL] Edit mode UNLOCKED');
        }
        
        /**
         * Lock edit mode
         */
        function lockGlobalEditMode() {
            globalEditMode = false;
            
            // Clear timeout
            if (globalEditTimeout) {
                clearInterval(globalEditTimeout);
                globalEditTimeout = null;
            }
            
            // Update UI
            const lockBtn = document.getElementById('global-lock-unlock-btn');
            const lockIcon = document.getElementById('global-lock-icon');
            const lockText = document.getElementById('global-lock-text');
            const warningBanner = document.getElementById('global-edit-warning-banner');
            const settingsContainer = document.getElementById('global-intelligence-settings');
            const saveBtn = document.getElementById('global-save-btn');
            
            // Update lock button
            lockBtn.className = 'px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition-all text-sm border-2 border-gray-300';
            lockIcon.className = 'fas fa-lock mr-1';
            lockText.textContent = 'Unlock to Edit';
            
            // Hide warning banner
            warningBanner.classList.add('hidden');
            
            // Disable settings
            settingsContainer.classList.add('opacity-60', 'pointer-events-none');
            settingsContainer.classList.remove('opacity-100');
            
            // Disable save button
            saveBtn.disabled = true;
            saveBtn.className = 'w-full px-6 py-3 bg-gray-300 text-gray-500 rounded-lg font-bold shadow-lg cursor-not-allowed text-lg';
            saveBtn.innerHTML = '<i class="fas fa-lock mr-2"></i>Unlock to Save Changes';
            
            console.log('üîí [GLOBAL] Edit mode LOCKED');
        }
        
        /**
         * Start auto-lock timeout (10 minutes)
         */
        function startGlobalEditTimeout() {
            let secondsRemaining = globalEditTimeoutSeconds;
            
            const updateTimer = () => {
                const minutes = Math.floor(secondsRemaining / 60);
                const seconds = secondsRemaining % 60;
                const timeoutElement = document.getElementById('global-edit-timeout');
                if (timeoutElement) {
                    timeoutElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
                
                secondsRemaining--;
                
                if (secondsRemaining < 0) {
                    lockGlobalEditMode();
                    showToast('info', 'Global edit mode auto-locked (timeout)');
                }
            };
            
            // Update immediately
            updateTimer();
            
            // Then update every second
            globalEditTimeout = setInterval(updateTimer, 1000);
        }
        
        /**
         * Update global tier 1 value
         */
        function updateGlobalTier1Value(value) {
            document.getElementById('global-tier1-value').textContent = Number(value).toFixed(2);
            calculateGlobalCostEstimate();
        }
        
        /**
         * Update global tier 2 value
         */
        function updateGlobalTier2Value(value) {
            document.getElementById('global-tier2-value').textContent = Number(value).toFixed(2);
            calculateGlobalCostEstimate();
        }
        
        /**
         * Toggle global Tier 3 card
         */
        function toggleGlobalTier3Card() {
            if (!globalEditMode) return; // Prevent toggle when locked
            
            const checkbox = document.getElementById('global-enable-tier3');
            const currentState = checkbox.checked;
            const newState = !currentState;
            
            checkbox.checked = newState;
            updateGlobalTier3Status();
            calculateGlobalCostEstimate();
        }
        
        /**
         * Update global warmup card visual state (green active vs gray disabled)
         */
        function updateGlobalWarmupStatus() {
            const checkbox = document.getElementById('global-enable-warmup');
            const enabled = checkbox?.checked || false;
            
            const card = document.getElementById('global-warmup-toggle-card');
            const dot = document.getElementById('global-warmup-status-dot');
            const iconContainer = document.getElementById('global-warmup-icon-container');
            const icon = document.getElementById('global-warmup-icon');
            const title = document.getElementById('global-warmup-title');
            const description = document.getElementById('global-warmup-description');
            const banner = document.getElementById('global-warmup-status-banner');
            
            console.log('üî• [GLOBAL WARMUP CARD] Toggle:', enabled ? 'ENABLED' : 'DISABLED');
            
            if (enabled) {
                // GREEN ACTIVE STATE
                card.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
                card.style.borderColor = '#10b981';
                dot.style.background = '#10b981';
                iconContainer.style.background = '#10b981';
                icon.className = 'fas fa-check text-white';
                title.textContent = 'Smart Warmup Enabled';
                title.className = 'text-base font-bold text-green-800';
                description.textContent = 'LLM pre-warming active during Tier 2';
                description.className = 'text-sm text-green-700 mt-1';
                
                // Show green banner
                if (banner) banner.classList.remove('hidden');
                
            } else {
                // GRAY DISABLED STATE
                card.style.background = 'linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%)';
                card.style.borderColor = '#9ca3af';
                dot.style.background = '#9ca3af';
                iconContainer.style.background = '#9ca3af';
                icon.className = 'fas fa-times text-white';
                title.textContent = 'Smart Warmup Disabled';
                title.className = 'text-base font-bold text-gray-600';
                description.textContent = 'No LLM pre-warming';
                description.className = 'text-sm text-gray-500 mt-1';
                
                // Hide banner
                if (banner) banner.classList.add('hidden');
            }
        }
        
        /**
         * Update global Tier 3 visual status
         */
        function updateGlobalTier3Status() {
            const checkbox = document.getElementById('global-enable-tier3');
            const card = document.getElementById('global-tier3-toggle-card');
            const dot = document.getElementById('global-tier3-status-dot');
            const iconContainer = document.getElementById('global-tier3-icon-container');
            const icon = document.getElementById('global-tier3-icon');
            const title = document.getElementById('global-tier3-title');
            const description = document.getElementById('global-tier3-description');
            
            if (checkbox.checked) {
                // Enabled state
                card.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
                card.style.borderColor = '#10b981';
                dot.style.background = '#10b981';
                iconContainer.style.background = '#10b981';
                icon.className = 'fas fa-check text-white';
                title.textContent = '3-Tier Intelligence System Enabled';
                title.className = 'text-base font-bold text-green-800';
                description.textContent = 'Tier 1 (Rules) ‚Üí Tier 2 (Semantic) ‚Üí Tier 3 (LLM Fallback)';
                description.className = 'text-sm text-green-700 mt-1';
            } else {
                // Disabled state
                card.style.background = '#f3f4f6';
                card.style.borderColor = '#d1d5db';
                dot.style.background = '#9ca3af';
                iconContainer.style.background = '#e5e7eb';
                icon.className = 'fas fa-times text-gray-600';
                title.textContent = '3-Tier Intelligence System Disabled';
                title.className = 'text-base font-bold text-gray-700';
                description.textContent = 'Click to enable LLM fallback';
                description.className = 'text-sm text-gray-600 mt-1';
            }
        }
        
        /**
         * Calculate global cost estimate
         */
        function calculateGlobalCostEstimate() {
            const tier1Threshold = parseFloat(document.getElementById('global-tier1-slider')?.value || 0.80);
            const tier2Threshold = parseFloat(document.getElementById('global-tier2-slider')?.value || 0.60);
            const tier3Enabled = document.getElementById('global-enable-tier3')?.checked !== false;
            
            // Simple estimation logic
            let tier1Percent, tier2Percent, tier3Percent;
            
            if (!tier3Enabled) {
                tier1Percent = 70;
                tier2Percent = 30;
                tier3Percent = 0;
            } else {
                tier1Percent = Math.round(tier1Threshold * 100);
                tier2Percent = Math.round((0.95 - tier1Threshold) / 2 * 100);
                tier3Percent = 100 - tier1Percent - tier2Percent;
            }
            
            // Update displays
            document.getElementById('global-tier1-percent').textContent = tier1Percent + '%';
            document.getElementById('global-tier2-percent').textContent = tier2Percent + '%';
            document.getElementById('global-tier3-percent').textContent = tier3Percent + '%';
            
            // Calculate monthly cost (assuming 1000 calls/month, $0.04 per LLM call)
            const monthlyCost = (tier3Percent / 100) * 1000 * 0.04;
            document.getElementById('global-monthly-cost-estimate').textContent = '$' + monthlyCost.toFixed(2);
        }
        
        /**
         * Show save confirmation modal
         */
        function showGlobalSaveConfirmationModal() {
            const companiesCount = document.getElementById('global-companies-affected-count').textContent;
            
            const modalHTML = `
                <div id="global-save-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="animation: fadeIn 0.2s;">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 p-6" style="animation: slideUp 0.3s;">
                        
                        <!-- Modal Header -->
                        <div class="flex items-start gap-3 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-orange-500 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-900">‚ö†Ô∏è FINAL CONFIRMATION: Save Global Intelligence Changes?</h3>
                            </div>
                        </div>
                        
                        <!-- Warning Content -->
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded mb-4">
                            <p class="text-sm text-red-900 leading-relaxed mb-3">
                                <strong>This will affect ${companiesCount} companies immediately.</strong><br><br>
                                
                                All companies in global mode will instantly receive these updated intelligence settings.
                                This action is logged and will be visible in audit trails.
                            </p>
                        </div>
                        
                        <!-- Typed Confirmation -->
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-800 mb-2">
                                Type "<span class="text-red-600">SAVE GLOBAL CHANGES</span>" to confirm:
                            </label>
                            <input type="text" 
                                   id="global-save-confirmation-input" 
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-sm font-mono"
                                   placeholder="SAVE GLOBAL CHANGES"
                                   autocomplete="off">
                            <p id="global-save-error" class="hidden text-xs text-red-600 mt-1 font-semibold">
                                ‚ùå Confirmation text does not match. Please type exactly: SAVE GLOBAL CHANGES
                            </p>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex items-center justify-end gap-3">
                            <button onclick="closeGlobalSaveModal()" 
                                    class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition-all">
                                Cancel
                            </button>
                            <button onclick="confirmGlobalSave()" 
                                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all shadow-lg">
                                <i class="fas fa-save mr-1"></i>
                                Save Changes
                            </button>
                        </div>
                        
                    </div>
                </div>
            `;
            
            // Add modal to page
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv.firstElementChild);
            
            // Focus on confirmation input
            setTimeout(() => {
                document.getElementById('global-save-confirmation-input')?.focus();
            }, 100);
        }
        
        /**
         * Close save modal
         */
        function closeGlobalSaveModal() {
            const modal = document.getElementById('global-save-modal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.2s';
                setTimeout(() => modal.remove(), 200);
            }
        }
        
        /**
         * Confirm and execute save
         */
        async function confirmGlobalSave() {
            const input = document.getElementById('global-save-confirmation-input');
            const errorMsg = document.getElementById('global-save-error');
            
            const userInput = input?.value.trim().toUpperCase();
            
            if (userInput !== 'SAVE GLOBAL CHANGES') {
                errorMsg?.classList.remove('hidden');
                input?.classList.add('border-red-500');
                return;
            }
            
            // Close modal
            closeGlobalSaveModal();
            
            // Execute save
            await saveGlobalProductionIntelligence();
        }
        
        /**
         * Load global intelligence settings from backend
         */
        async function loadGlobalProductionIntelligence() {
            console.log('üì• [GLOBAL] Loading production intelligence settings...');
            
            try {
                const response = await fetch('/api/admin/global-intelligence', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì• [GLOBAL] Loaded settings:', data);
                
                // Populate UI with loaded settings
                const settings = data.settings || data.intelligence || {};
                
                // 3-Tier Toggle
                const tier3Enabled = settings.enabled !== false;
                const tier3Checkbox = document.getElementById('global-enable-tier3');
                if (tier3Checkbox) {
                    tier3Checkbox.checked = tier3Enabled;
                    updateGlobalTier3Status();
                }
                
                // Thresholds
                if (settings.thresholds) {
                    const tier1Slider = document.getElementById('global-tier1-slider');
                    const tier2Slider = document.getElementById('global-tier2-slider');
                    
                    if (tier1Slider) {
                        tier1Slider.value = settings.thresholds.tier1 || 0.80;
                        document.getElementById('global-tier1-value').textContent = (settings.thresholds.tier1 || 0.80).toFixed(2);
                    }
                    
                    if (tier2Slider) {
                        tier2Slider.value = settings.thresholds.tier2 || 0.60;
                        document.getElementById('global-tier2-value').textContent = (settings.thresholds.tier2 || 0.60).toFixed(2);
                    }
                }
                
                // LLM Config
                if (settings.llmConfig) {
                    const modelSelect = document.getElementById('global-llm-model');
                    const maxCostInput = document.getElementById('global-max-cost-per-call');
                    const dailyBudgetInput = document.getElementById('global-daily-budget');
                    
                    if (modelSelect) modelSelect.value = settings.llmConfig.model || 'gpt-4o-mini';
                    if (maxCostInput) maxCostInput.value = settings.llmConfig.maxCostPerCall || 0.10;
                    if (dailyBudgetInput) dailyBudgetInput.value = settings.llmConfig.dailyBudget || '';
                }
                
                // Smart Warmup
                if (settings.smartWarmup) {
                    const warmupCheckbox = document.getElementById('global-enable-warmup');
                    const warmupConfidence = document.getElementById('global-warmup-confidence');
                    const warmupDailyBudget = document.getElementById('global-warmup-daily-budget');
                    const warmupPatternLearning = document.getElementById('global-warmup-pattern-learning');
                    const warmupMinHitRate = document.getElementById('global-warmup-min-hit-rate');
                    
                    if (warmupCheckbox) {
                        warmupCheckbox.checked = settings.smartWarmup.enabled === true;
                        updateGlobalWarmupStatus();
                    }
                    if (warmupConfidence) warmupConfidence.value = settings.smartWarmup.confidenceThreshold || 0.75;
                    if (warmupDailyBudget) warmupDailyBudget.value = settings.smartWarmup.dailyBudget || 5.00;
                    if (warmupPatternLearning) warmupPatternLearning.checked = settings.smartWarmup.enablePatternLearning !== false;
                    if (warmupMinHitRate) warmupMinHitRate.value = settings.smartWarmup.minimumHitRate || 0.30;
                }
                
                // Update companies affected count
                if (data.companiesAffected !== undefined) {
                    const countElement = document.getElementById('global-companies-affected-count');
                    if (countElement) {
                        countElement.textContent = data.companiesAffected;
                    }
                }
                
                // Update cost estimate
                updateGlobalCostEstimate();
                
                console.log('‚úÖ [GLOBAL] Settings loaded and UI populated');
                
            } catch (error) {
                console.error('‚ùå [GLOBAL] Failed to load settings:', error);
                showToast('error', `Failed to load global settings: ${error.message}`);
            }
        }
        
        /**
         * Calculate and update global cost estimate
         * Based on thresholds, predict Tier 1/2/3 distribution and monthly cost
         */
        function updateGlobalCostEstimate() {
            console.log('üí∞ [GLOBAL COST ESTIMATE] Calculating...');
            
            const tier1Threshold = parseFloat(document.getElementById('global-tier1-slider')?.value || 0.80);
            const tier2Threshold = parseFloat(document.getElementById('global-tier2-slider')?.value || 0.60);
            const llmModel = document.getElementById('global-llm-model')?.value || 'gpt-4o-mini';
            const enableTier3 = document.getElementById('global-enable-tier3')?.checked;
            
            // Estimate tier distribution based on thresholds
            // Lower thresholds = more queries escalate to higher tiers
            const tier1Percent = Math.round(tier1Threshold * 100); // e.g., 0.80 = 80%
            const tier2Percent = enableTier3 ? Math.round((1 - tier1Threshold) * 100 * 0.7) : Math.round((1 - tier1Threshold) * 100); // 70% of remaining
            const tier3Percent = enableTier3 ? Math.round((1 - tier1Threshold) * 100 * 0.3) : 0; // 30% of remaining
            
            // Cost per LLM call (Tier 3 only)
            const costPerCall = {
                'gpt-4o': 0.10,
                'gpt-4o-mini': 0.04,
                'gpt-3.5-turbo': 0.01
            }[llmModel] || 0.04;
            
            // Estimate monthly cost (1,000 calls/month)
            const monthlyCallVolume = 1000;
            const tier3Calls = (tier3Percent / 100) * monthlyCallVolume;
            const monthlyCost = tier3Calls * costPerCall;
            
            // Update UI
            document.getElementById('global-tier1-percent').textContent = `${tier1Percent}%`;
            document.getElementById('global-tier2-percent').textContent = `${tier2Percent}%`;
            document.getElementById('global-tier3-percent').textContent = `${tier3Percent}%`;
            document.getElementById('global-monthly-cost-estimate').textContent = `$${monthlyCost.toFixed(2)}`;
            
            console.log(`‚úÖ [GLOBAL COST ESTIMATE] T1: ${tier1Percent}%, T2: ${tier2Percent}%, T3: ${tier3Percent}%, Monthly: $${monthlyCost.toFixed(2)}`);
        }
        
        /**
         * Save global intelligence settings to backend
         */
        async function saveGlobalProductionIntelligence() {
            console.log('üíæ [GLOBAL] Saving production intelligence settings...');
            
            try {
                // Gather settings from UI
                const settings = {
                    enabled: document.getElementById('global-enable-tier3')?.checked !== false,
                    thresholds: {
                        tier1: parseFloat(document.getElementById('global-tier1-slider')?.value || 0.80),
                        tier2: parseFloat(document.getElementById('global-tier2-slider')?.value || 0.60),
                        enableTier3: document.getElementById('global-enable-tier3')?.checked !== false
                    },
                    llmConfig: {
                        model: document.getElementById('global-llm-model')?.value || 'gpt-4o-mini',
                        maxCostPerCall: parseFloat(document.getElementById('global-max-cost-per-call')?.value || 0.10),
                        dailyBudget: parseFloat(document.getElementById('global-daily-budget')?.value) || null
                    },
                    smartWarmup: {
                        enabled: document.getElementById('global-enable-warmup')?.checked === true,
                        confidenceThreshold: parseFloat(document.getElementById('global-warmup-confidence')?.value || 0.75),
                        dailyBudget: parseFloat(document.getElementById('global-warmup-daily-budget')?.value || 5.00),
                        enablePatternLearning: document.getElementById('global-warmup-pattern-learning')?.checked !== false,
                        minimumHitRate: parseFloat(document.getElementById('global-warmup-min-hit-rate')?.value || 0.30),
                        alwaysWarmupCategories: [],  // TODO: Implement category selection UI
                        neverWarmupCategories: []     // TODO: Implement category selection UI
                    }
                };
                
                console.log('üíæ [GLOBAL] Settings to save:', settings);
                
                // Call backend API
                const response = await fetch('/api/admin/global-intelligence', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({
                        intelligence: settings  // Backend expects 'intelligence', not 'productionIntelligence'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                console.log('‚úÖ [GLOBAL] Settings saved successfully:', result);
                
                showToast('success', 'Global intelligence settings saved successfully!', 5000);
                
                // Auto-lock after successful save
                lockGlobalEditMode();
                
            } catch (error) {
                console.error('‚ùå [GLOBAL] Failed to save settings:', error);
                showToast('error', `Failed to save: ${error.message}`);
            }
        }
        
        // ================================================================
        // END: Global Platform Intelligence Functions
        // ================================================================
        
        // ================================================================
        // üß† LLM LEARNING CONSOLE V1 - REMOVED
        // Replaced by standalone V2 console at /admin/llm-learning-v2
        // All V1 functions deleted - 330 lines removed (2025-11-08)
        // ================================================================
        
        /**
         * When company is selected from TOP dropdown
         */
        async function onTopCompanySelected(companyId) {
            console.log(`üè¢ [TOP COMPANY SELECTOR] Selected company: ${companyId || 'none'}`);
            
            if (!companyId) {
                return;
            }
            
            // Load company details (this will read from the top selector)
            await onCompanyTestSelected();
        }
        
        // ============================================================================
        // END COMPANY TEST MODE FUNCTIONS
        // ============================================================================

        // ============================================================================
        // AI LEARNING & OPTIMIZATION SETTINGS FUNCTIONS
        // ============================================================================
        
        /**
         * Update AI Learning UI based on checkbox states
         * Shows/hides threshold sliders when checkboxes are toggled
         */
        function updateAILearningUI() {
            // Show/hide industry threshold container
            const shareIndustry = document.getElementById('learning-share-industry').checked;
            const industryContainer = document.getElementById('industry-threshold-container');
            if (shareIndustry) {
                industryContainer.classList.remove('hidden');
            } else {
                industryContainer.classList.add('hidden');
            }
            
            // Show/hide global threshold container
            const proposeGlobal = document.getElementById('learning-propose-global').checked;
            const globalContainer = document.getElementById('global-threshold-container');
            if (proposeGlobal) {
                globalContainer.classList.remove('hidden');
            } else {
                globalContainer.classList.add('hidden');
            }
        }
        
        /**
         * Load AI Learning settings for the active template
         * Called when template is switched or page loads
         */
        async function loadAILearningSettings() {
            if (!activeTemplate || !activeTemplate._id) {
                console.warn('‚ö†Ô∏è [AI LEARNING] No active template to load settings from');
                return;
            }
            
            console.log('üì• [AI LEARNING] Loading settings for template:', activeTemplate.name);
            
            const settings = activeTemplate.learningSettings || {};
            
            // Populate checkboxes
            document.getElementById('learning-share-industry').checked = settings.shareWithinIndustry || false;
            document.getElementById('learning-propose-global').checked = settings.proposeForGlobal || false;
            document.getElementById('learning-auto-approve-industry').checked = settings.autoApproveIndustry !== undefined ? settings.autoApproveIndustry : true;
            
            // Populate thresholds
            const tier1Threshold = Math.round((settings.tier1Threshold || 0.80) * 100);
            const tier2Threshold = Math.round((settings.tier2Threshold || 0.60) * 100);
            const industryThreshold = Math.round((settings.industryShareThreshold || 0.85) * 100);
            const globalThreshold = Math.round((settings.globalProposeThreshold || 0.90) * 100);
            
            document.getElementById('learning-tier1-threshold').value = tier1Threshold;
            document.getElementById('tier1-threshold-value').textContent = tier1Threshold;
            
            document.getElementById('learning-tier2-threshold').value = tier2Threshold;
            document.getElementById('tier2-threshold-value').textContent = tier2Threshold;
            
            document.getElementById('learning-industry-threshold').value = industryThreshold;
            document.getElementById('industry-threshold-value').textContent = industryThreshold;
            
            document.getElementById('learning-global-threshold').value = globalThreshold;
            document.getElementById('global-threshold-value').textContent = globalThreshold;
            
            // Populate budget controls
            document.getElementById('learning-llm-budget').value = settings.llmBudgetMonthly || 500;
            document.getElementById('learning-llm-cost-per-call').value = settings.llmCostPerCall || 0.50;
            document.getElementById('learning-min-pattern-freq').value = settings.minPatternFrequency || 3;
            
            // Update UI visibility
            updateAILearningUI();
            
            console.log('‚úÖ [AI LEARNING] Settings loaded successfully');
        }
        
        // ============================================================================
        // üéØ INTELLIGENCE MODE PRESET SELECTOR
        // ============================================================================
        
        /**
         * Select an Intelligence Mode preset and apply it to the template
         * @param {string} mode - 'MAXIMUM', 'BALANCED', or 'MINIMAL'
         */
        async function selectIntelligenceMode(mode) {
            console.log('üéØ [INTELLIGENCE MODE] Selecting mode:', mode);
            
            if (!activeTemplate || !activeTemplate._id) {
                showToast('error', '‚ùå No template selected');
                return;
            }
            
            // Visual feedback - highlight selected card
            document.querySelectorAll('.preset-card').forEach(card => {
                card.classList.remove('ring-4', 'ring-purple-500', 'border-purple-500');
                card.classList.add('opacity-70');
            });
            
            const selectedCard = document.querySelector(`.preset-card[data-mode="${mode}"]`);
            if (selectedCard) {
                selectedCard.classList.add('ring-4', 'ring-purple-500', 'border-purple-500');
                selectedCard.classList.remove('opacity-70');
            }
            
            try {
                // Send to backend
                const response = await fetch(`/api/admin/global-instant-responses/${activeTemplate._id}/intelligence-mode`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({ intelligenceMode: mode })
                });
                
                // Check for authentication errors first
                if (response.status === 401) {
                    console.error('‚ùå [INTELLIGENCE MODE] Authentication failed - JWT expired or invalid');
                    showToast('error', 'üîê Session expired. Please log out and log back in.');
                    
                    // Reset visual feedback
                    document.querySelectorAll('.preset-card').forEach(card => {
                        card.classList.remove('opacity-70', 'ring-4', 'ring-purple-500', 'border-purple-500');
                    });
                    return; // Exit early - don't try to parse JSON
                }
                
                // Only parse JSON if we have a successful-ish response
                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    console.error('‚ùå [INTELLIGENCE MODE] Failed to parse response:', parseError);
                    showToast('error', '‚ùå Server returned invalid response');
                    document.querySelectorAll('.preset-card').forEach(card => {
                        card.classList.remove('opacity-70', 'ring-4', 'ring-purple-500', 'border-purple-500');
                    });
                    return;
                }
                
                if (result.success) {
                    console.log('‚úÖ [INTELLIGENCE MODE] Applied successfully:', result.data);
                    
                    // Update current mode display
                    const modeEmojis = {
                        'MAXIMUM': 'üî•',
                        'BALANCED': '‚öñÔ∏è',
                        'MINIMAL': 'üíö'
                    };
                    
                    const modeNames = {
                        'MAXIMUM': 'Maximum LLM Help',
                        'BALANCED': 'Balanced',
                        'MINIMAL': 'Minimal'
                    };
                    
                    document.getElementById('current-mode-name').textContent = modeNames[mode];
                    document.getElementById('current-mode-emoji').textContent = modeEmojis[mode];
                    
                    // Update activeTemplate
                    activeTemplate.intelligenceMode = mode;
                    activeTemplate.testPilotSettings = result.data.testPilotSettings;
                    
                    showToast('success', `‚úÖ Intelligence Mode set to ${modeNames[mode]}`);
                    
                    // Show cost estimate
                    setTimeout(() => {
                        showToast('info', `üí° Estimated cost: ${result.data.estimatedCostPerTest} per test`, {
                            duration: 5000
                        });
                    }, 1000);
                    
                } else {
                    console.error('‚ùå [INTELLIGENCE MODE] Failed:', result.error || result.message || 'Unknown error');
                    showToast('error', `‚ùå Failed to set intelligence mode: ${result.error || result.message || 'Unknown error'}`);
                    
                    // Reset visual feedback
                    document.querySelectorAll('.preset-card').forEach(card => {
                        card.classList.remove('opacity-70', 'ring-4', 'ring-purple-500', 'border-purple-500');
                    });
                }
                
            } catch (error) {
                console.error('‚ùå [INTELLIGENCE MODE] Error:', error);
                showToast('error', `‚ùå Network error: ${error.message}`);
                
                // Reset visual feedback
                document.querySelectorAll('.preset-card').forEach(card => {
                    card.classList.remove('opacity-70', 'ring-4', 'ring-purple-500', 'border-purple-500');
                });
            }
        }
        
        /**
         * Load and display current intelligence mode
         * Called when template is switched
         */
        function loadIntelligenceMode() {
            console.log('üéØ [INTELLIGENCE MODE] Loading current mode...');
            
            if (!activeTemplate) {
                document.getElementById('current-mode-name').textContent = 'Not Set';
                document.getElementById('current-mode-emoji').textContent = '‚öôÔ∏è';
                return;
            }
            
            const mode = activeTemplate.intelligenceMode;
            
            if (!mode) {
                document.getElementById('current-mode-name').textContent = 'Not Set';
                document.getElementById('current-mode-emoji').textContent = '‚öôÔ∏è';
                
                // Remove all highlights
                document.querySelectorAll('.preset-card').forEach(card => {
                    card.classList.remove('ring-4', 'ring-purple-500', 'border-purple-500', 'opacity-70');
                });
                
                return;
            }
            
            const modeEmojis = {
                'MAXIMUM': 'üî•',
                'BALANCED': '‚öñÔ∏è',
                'MINIMAL': 'üíö'
            };
            
            const modeNames = {
                'MAXIMUM': 'Maximum LLM Help',
                'BALANCED': 'Balanced',
                'MINIMAL': 'Minimal'
            };
            
            document.getElementById('current-mode-name').textContent = modeNames[mode] || mode;
            document.getElementById('current-mode-emoji').textContent = modeEmojis[mode] || '‚öôÔ∏è';
            
            // Highlight selected card
            document.querySelectorAll('.preset-card').forEach(card => {
                card.classList.remove('ring-4', 'ring-purple-500', 'border-purple-500');
                card.classList.add('opacity-70');
            });
            
            const selectedCard = document.querySelector(`.preset-card[data-mode="${mode}"]`);
            if (selectedCard) {
                selectedCard.classList.add('ring-4', 'ring-purple-500', 'border-purple-500');
                selectedCard.classList.remove('opacity-70');
            }
            
            console.log('‚úÖ [INTELLIGENCE MODE] Current mode:', mode);
        }
        
        // ============================================================================
        // üìà ENTERPRISE TREND CHARTS - LOAD AND INITIALIZE
        // ============================================================================
        
        /**
         * Load and display Enterprise Trend Charts for the active template
         * Creates visualizations for confidence trends, tier distribution, cost analysis
         */
        async function loadEnterpriseTrendCharts() {
            console.log('üîµ [CHECKPOINT 1] loadEnterpriseTrendCharts() called');
            
            if (!activeTemplate || !activeTemplate._id) {
                console.error('‚ùå [CHECKPOINT 1.1] No active template selected');
                if (window.ToastManager) {
                    window.ToastManager.error('‚ùå Please select a template first');
                }
                return;
            }
            
            console.log('üîµ [CHECKPOINT 1.2] Active template:', activeTemplate.name);
            console.log('üîµ [CHECKPOINT 1.3] Template ID:', activeTemplate._id);
            
            try {
                // Show loading state
                const container = document.getElementById('enterprise-trend-charts');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-12 bg-white rounded-lg border-2 border-blue-200">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                            <h4 class="text-xl font-bold text-gray-700 mb-2">Loading Trend Data...</h4>
                            <p class="text-gray-600">Analyzing template performance over time</p>
                        </div>
                    `;
                }
                
                console.log('‚úÖ [CHECKPOINT 1.4] Loading state displayed');
                
                // Initialize and render charts
                console.log('üîµ [CHECKPOINT 1.5] Creating EnterpriseTrendCharts instance...');
                
                window.trendCharts = new EnterpriseTrendCharts(activeTemplate._id, {
                    containerId: 'enterprise-trend-charts',
                    timeRange: 50 // Default: last 50 tests
                });
                
                console.log('‚úÖ [CHECKPOINT 1.6] EnterpriseTrendCharts instance created');
                
                // Render charts
                console.log('üîµ [CHECKPOINT 1.7] Rendering charts...');
                await window.trendCharts.render();
                
                console.log('‚úÖ [CHECKPOINT 1.8] Charts rendered successfully!');
                
                if (window.ToastManager) {
                    window.ToastManager.success('‚úÖ Trend charts loaded successfully');
                }
                
            } catch (error) {
                console.error('‚ùå [CHECKPOINT 1.9] Failed to load trend charts:', error.message);
                console.error('‚ùå [CHECKPOINT 1.10] Stack trace:', error.stack);
                
                if (window.ToastManager) {
                    window.ToastManager.error(`‚ùå Failed to load trends: ${error.message}`);
                }
                
                // Show error in container
                const container = document.getElementById('enterprise-trend-charts');
                if (container) {
                    container.innerHTML = `
                        <div class="bg-red-50 border-2 border-red-400 rounded-lg p-6 text-center">
                            <i class="fas fa-exclamation-circle text-4xl text-red-600 mb-3"></i>
                            <h4 class="text-lg font-bold text-red-900 mb-2">Failed to Load Trends</h4>
                            <p class="text-sm text-red-700 mb-4">${error.message}</p>
                            <button onclick="loadEnterpriseTrendCharts()" 
                                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold">
                                <i class="fas fa-redo mr-2"></i> Try Again
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // ============================================================================
        // üîÆ BEFORE/AFTER IMPACT SIMULATOR
        // ============================================================================
        
        /**
         * Show Before/After simulator for a suggestion
         * Displays predicted impact in a modal dialog
         */
        function showImpactSimulator(suggestion, currentState) {
            console.log('üîµ [CHECKPOINT 1] showImpactSimulator() called');
            console.log('üîµ [CHECKPOINT 1.1] Suggestion:', suggestion);
            console.log('üîµ [CHECKPOINT 1.2] Current state:', currentState);
            
            try {
                // Create modal container if it doesn't exist
                let modal = document.getElementById('impact-simulator-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'impact-simulator-modal';
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                    modal.style.display = 'none';
                    modal.onclick = function(e) {
                        if (e.target === modal) closeImpactSimulator();
                    };
                    document.body.appendChild(modal);
                }
                
                console.log('‚úÖ [CHECKPOINT 1.3] Modal container ready');
                
                // Create simulator instance
                const simulator = new EnterpriseBeforeAfterSimulator(suggestion, currentState);
                
                console.log('‚úÖ [CHECKPOINT 1.4] Simulator instance created');
                
                // Generate modal content
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <!-- Modal Header -->
                        <div class="bg-gradient-to-r from-purple-600 to-blue-600 px-6 py-4 flex items-center justify-between">
                            <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                                <i class="fas fa-magic"></i>
                                Impact Simulation
                            </h3>
                            <button onclick="closeImpactSimulator()" 
                                    class="text-white hover:text-gray-200 transition-colors">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        
                        <!-- Suggestion Info -->
                        <div class="px-6 py-4 bg-purple-50 border-b-2 border-purple-200">
                            <div class="flex items-start gap-3">
                                <div class="text-3xl">${getPriorityIcon(suggestion.priority)}</div>
                                <div class="flex-1">
                                    <div class="font-bold text-gray-900 mb-1">
                                        ${getPriorityBadge(suggestion.priority)}
                                    </div>
                                    <div class="text-sm text-gray-700">
                                        ${escapeHtml(suggestion.description || suggestion.reason || 'No description available')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Simulator Content -->
                        <div class="p-6" id="simulator-content">
                            <!-- Will be filled by simulator.render() -->
                        </div>
                        
                        <!-- Modal Footer -->
                        <div class="px-6 py-4 bg-gray-50 border-t-2 border-gray-200 flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-info-circle mr-1"></i>
                                Predictions based on historical data and AI analysis
                            </div>
                            <div class="flex gap-2">
                                <button onclick="closeImpactSimulator()" 
                                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg font-semibold">
                                    Close
                                </button>
                                <button onclick="applySuggestionFromSimulator('${suggestion._id || suggestion.id}')" 
                                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold flex items-center gap-2">
                                    <i class="fas fa-check"></i>
                                    Apply This Suggestion
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Render simulator into content div
                simulator.render('simulator-content');
                
                // Show modal
                modal.style.display = 'flex';
                
                console.log('‚úÖ [CHECKPOINT 1.5] Simulator displayed successfully');
                
            } catch (error) {
                console.error('‚ùå [CHECKPOINT 1.6] Failed to show simulator:', error.message);
                console.error('‚ùå [CHECKPOINT 1.7] Stack trace:', error.stack);
                
                if (window.ToastManager) {
                    window.ToastManager.error(`‚ùå Failed to load simulator: ${error.message}`);
                }
            }
        }
        
        /**
         * Close Impact Simulator Modal
         */
        function closeImpactSimulator() {
            console.log('üîµ [CHECKPOINT 2] Closing impact simulator...');
            
            const modal = document.getElementById('impact-simulator-modal');
            if (modal) {
                modal.style.display = 'none';
                modal.innerHTML = '';
            }
            
            console.log('‚úÖ [CHECKPOINT 2.1] Simulator closed');
        }
        
        /**
         * Get priority icon for suggestion
         */
        function getPriorityIcon(priority) {
            const icons = {
                'CRITICAL': 'üî•',
                'HIGH': '‚ö†Ô∏è',
                'MEDIUM': 'üìå',
                'LOW': '‚ÑπÔ∏è'
            };
            return icons[(priority || 'MEDIUM').toUpperCase()] || 'üìå';
        }
        
        /**
         * Apply suggestion from simulator modal
         */
        async function applySuggestionFromSimulator(suggestionId) {
            console.log('üîµ [CHECKPOINT 3] Applying suggestion from simulator...');
            console.log('üîµ [CHECKPOINT 3.1] Suggestion ID:', suggestionId);
            
            // Close modal
            closeImpactSimulator();
            
            // TODO: Implement apply suggestion logic
            // This would call the /api/admin/suggestions/apply endpoint
            
            if (window.ToastManager) {
                window.ToastManager.info('üí° Apply suggestion feature coming soon!');
            }
            
            console.log('‚úÖ [CHECKPOINT 3.2] Suggestion apply triggered');
        }
        
        // ============================================================================
        // ‚ö° BULK ACTIONS - APPLY MULTIPLE SUGGESTIONS
        // ============================================================================
        
        /**
         * Apply all high priority suggestions from Live Test Monitor
         */
        async function applyAllHighPrioritySuggestions() {
            console.log('üîµ [CHECKPOINT 1] applyAllHighPrioritySuggestions() called');
            
            if (!activeTemplate || !activeTemplate._id) {
                console.error('‚ùå [CHECKPOINT 1.1] No active template');
                if (window.ToastManager) {
                    window.ToastManager.error('‚ùå Please select a template first');
                }
                return;
            }
            
            try {
                // Collect all high priority suggestions from recent tests
                console.log('üîµ [CHECKPOINT 1.2] Collecting high priority suggestions...');
                
                // TODO: This would fetch suggestions from backend or collect from visible tests
                // For now, show info message
                
                if (window.ToastManager) {
                    window.ToastManager.info('üí° Analyzing suggestions... This feature integrates with backend API');
                }
                
                // Initialize bulk actions manager
                const bulkActions = new EnterpriseBulkActions(activeTemplate._id, {
                    transactional: false,  // Allow partial success
                    confirmBeforeApply: true,
                    showProgress: true
                });
                
                // Example: Apply high priority suggestions
                // const allSuggestions = [...]; // Would come from API
                // await bulkActions.applyAllHighPriority(allSuggestions);
                
                console.log('‚úÖ [CHECKPOINT 1.3] Bulk actions initialized');
                console.log('üí° Backend integration point ready for Phase 4');
                
            } catch (error) {
                console.error('‚ùå [CHECKPOINT 1.4] Failed to apply suggestions:', error.message);
                console.error('‚ùå [CHECKPOINT 1.5] Stack trace:', error.stack);
                
                if (window.ToastManager) {
                    window.ToastManager.error(`‚ùå Failed: ${error.message}`);
                }
            }
        }
        
        /**
         * Apply all suggestions (all priorities)
         */
        async function applyAllSuggestions() {
            console.log('üîµ [CHECKPOINT 2] applyAllSuggestions() called');
            
            if (!activeTemplate || !activeTemplate._id) {
                console.error('‚ùå [CHECKPOINT 2.1] No active template');
                if (window.ToastManager) {
                    window.ToastManager.error('‚ùå Please select a template first');
                }
                return;
            }
            
            try {
                if (window.ToastManager) {
                    window.ToastManager.info('üí° Apply All feature - Backend integration ready');
                }
                
                const bulkActions = new EnterpriseBulkActions(activeTemplate._id, {
                    transactional: false,
                    confirmBeforeApply: true,
                    showProgress: true
                });
                
                // TODO: Collect and apply all suggestions
                console.log('‚úÖ [CHECKPOINT 2.2] Ready for bulk apply all');
                
            } catch (error) {
                console.error('‚ùå [CHECKPOINT 2.3] Failed:', error.message);
                if (window.ToastManager) {
                    window.ToastManager.error(`‚ùå Failed: ${error.message}`);
                }
            }
        }
        
        // ============================================================================
        // üß† AI LEARNING & OPTIMIZATION
        // ============================================================================
        
        /**
         * Save AI Learning settings to the backend
         * Collects all form values and sends PATCH request
         */
        async function saveAILearningSettings() {
            if (!activeTemplate || !activeTemplate._id) {
                showNotification('‚ùå No template selected', 'error');
                return;
            }
            
            try {
                console.log('üíæ [AI LEARNING] Saving settings for template:', activeTemplate.name);
                
                // Collect all settings from form
                const learningSettings = {
                    // Sharing settings
                    shareWithinIndustry: document.getElementById('learning-share-industry').checked,
                    proposeForGlobal: document.getElementById('learning-propose-global').checked,
                    autoApproveIndustry: document.getElementById('learning-auto-approve-industry').checked,
                    
                    // Tier thresholds (convert from percentage to decimal)
                    tier1Threshold: parseFloat(document.getElementById('learning-tier1-threshold').value) / 100,
                    tier2Threshold: parseFloat(document.getElementById('learning-tier2-threshold').value) / 100,
                    industryShareThreshold: parseFloat(document.getElementById('learning-industry-threshold').value) / 100,
                    globalProposeThreshold: parseFloat(document.getElementById('learning-global-threshold').value) / 100,
                    
                    // Budget controls
                    llmBudgetMonthly: parseFloat(document.getElementById('learning-llm-budget').value),
                    llmCostPerCall: parseFloat(document.getElementById('learning-llm-cost-per-call').value),
                    minPatternFrequency: parseInt(document.getElementById('learning-min-pattern-freq').value)
                };
                
                console.log('üì§ [AI LEARNING] Sending settings:', learningSettings);
                
                showNotification('‚è≥ Saving AI Learning settings...', 'info');
                
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-instant-responses/${activeTemplate._id}/learning-settings`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ learningSettings })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}`);
                }
                
                console.log('‚úÖ [AI LEARNING] Settings saved successfully:', result);
                
                // Update local template with new settings
                activeTemplate.learningSettings = result.learningSettings;
                
                showNotification('‚úÖ AI Learning settings saved successfully!', 'success');
                
            } catch (error) {
                console.error('‚ùå [AI LEARNING] Error saving settings:', error);
                showNotification(`‚ùå Failed to save settings: ${error.message}`, 'error');
            }
        }
        
        // END AI LEARNING FUNCTIONS
        
        // ============================================
        // üìä AI COST DASHBOARD FUNCTIONS
        // ============================================
        
        /**
         * Refresh AI Cost Dashboard with latest data
         */
        async function refreshAICostDashboard() {
            if (!activeTemplateId) {
                console.warn('‚ö†Ô∏è [COST DASHBOARD] No active template');
                return;
            }
            
            try {
                console.log('üìä [COST DASHBOARD] Fetching cost data for template:', activeTemplateId);
                
                // Show loading state
                document.getElementById('cost-loading-state').classList.remove('hidden');
                document.getElementById('cost-dashboard-main').classList.add('hidden');
                
                const token = getAuthToken();
                
                // Fetch template costs
                const costResponse = await fetch(`/api/admin/ai-costs/template/${activeTemplateId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!costResponse.ok) {
                    throw new Error('Failed to fetch cost data');
                }
                
                const costData = await costResponse.json();
                
                // Fetch recommendations
                const recResponse = await fetch(`/api/admin/ai-costs/recommendations/${activeTemplateId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const recData = recResponse.ok ? await recResponse.json() : { data: { recommendations: [] } };
                
                // Render dashboard
                renderCostDashboard(costData.data, recData.data);
                
                // Hide loading, show dashboard
                document.getElementById('cost-loading-state').classList.add('hidden');
                document.getElementById('cost-dashboard-main').classList.remove('hidden');
                
                console.log('‚úÖ [COST DASHBOARD] Data loaded successfully');
                
            } catch (error) {
                console.error('‚ùå [COST DASHBOARD] Error:', error);
                document.getElementById('cost-loading-state').innerHTML = `
                    <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                    <h4 class="text-xl font-bold text-gray-700 mb-2">Failed to Load Cost Data</h4>
                    <p class="text-gray-600">${error.message}</p>
                    <button onclick="refreshAICostDashboard()" class="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Retry
                    </button>
                `;
            }
        }
        
        /**
         * Render cost dashboard with data
         */
        function renderCostDashboard(costData, recommendationsData) {
            // Update month label
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            const [year, month] = costData.month.split('-');
            document.getElementById('cost-month-label').textContent = 
                `${monthNames[parseInt(month) - 1]} ${year}`;
            
            // Update budget stats
            const { budget, usage } = costData;
            
            document.getElementById('cost-total-spent').textContent = `$${budget.used.toFixed(2)}`;
            document.getElementById('cost-budget-limit').textContent = `$${budget.limit.toFixed(2)}`;
            document.getElementById('cost-budget-percentage').textContent = `${budget.percentage.toFixed(1)}%`;
            document.getElementById('cost-remaining-budget').textContent = `$${budget.remaining.toFixed(2)}`;
            
            // Update progress bar
            const progressBar = document.getElementById('cost-budget-progress-bar');
            progressBar.style.width = `${Math.min(budget.percentage, 100)}%`;
            
            // Color-code based on usage
            if (budget.percentage >= 90) {
                progressBar.className = 'absolute top-0 left-0 h-full bg-gradient-to-r from-red-500 to-red-600 transition-all duration-500';
            } else if (budget.percentage >= 75) {
                progressBar.className = 'absolute top-0 left-0 h-full bg-gradient-to-r from-yellow-500 to-orange-500 transition-all duration-500';
            } else if (budget.percentage >= 50) {
                progressBar.className = 'absolute top-0 left-0 h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-500';
            } else {
                progressBar.className = 'absolute top-0 left-0 h-full bg-gradient-to-r from-green-500 to-emerald-500 transition-all duration-500';
            }
            
            // Update usage stats
            document.getElementById('cost-total-calls').textContent = usage.totalCalls.toLocaleString();
            document.getElementById('cost-avg-per-call').textContent = `$${usage.avgCostPerCall.toFixed(4)}`;
            document.getElementById('cost-estimated-monthly').textContent = `$${budget.estimatedMonthly.toFixed(2)}`;
            
            // Update status badge
            const statusBadge = document.getElementById('cost-status-badge');
            if (budget.status === 'EXCEEDED') {
                statusBadge.textContent = 'üî¥ EXCEEDED';
                statusBadge.className = 'text-xs font-semibold bg-red-700 px-3 py-1 rounded-lg shadow';
            } else if (budget.status === 'CRITICAL') {
                statusBadge.textContent = 'üö® CRITICAL';
                statusBadge.className = 'text-xs font-semibold bg-red-600 px-3 py-1 rounded-lg shadow';
            } else if (budget.status === 'WARNING') {
                statusBadge.textContent = '‚ö†Ô∏è WARNING';
                statusBadge.className = 'text-xs font-semibold bg-yellow-600 px-3 py-1 rounded-lg shadow';
            } else if (budget.status === 'MODERATE') {
                statusBadge.textContent = 'üí° MODERATE';
                statusBadge.className = 'text-xs font-semibold bg-blue-600 px-3 py-1 rounded-lg shadow';
            } else {
                statusBadge.textContent = 'üü¢ HEALTHY';
                statusBadge.className = 'text-xs font-semibold bg-green-700 px-3 py-1 rounded-lg shadow';
            }
            
            // Render recommendations
            if (recommendationsData.recommendations && recommendationsData.recommendations.length > 0) {
                const container = document.getElementById('cost-recommendations-container');
                const list = document.getElementById('cost-recommendations-list');
                
                list.innerHTML = recommendationsData.recommendations.map(rec => {
                    const icon = rec.priority === 'HIGH' ? 'üî¥' : 
                               rec.priority === 'MEDIUM' ? 'üü°' : 
                               rec.priority === 'EXCELLENT' ? 'üèÜ' : 'üí°';
                    
                    return `
                        <div class="bg-white rounded-lg border-2 border-yellow-300 p-4">
                            <div class="flex items-start gap-3">
                                <div class="text-2xl">${icon}</div>
                                <div class="flex-1">
                                    <h5 class="font-bold text-gray-900 mb-1">${rec.title}</h5>
                                    <p class="text-sm text-gray-700 mb-2">${rec.message}</p>
                                    <p class="text-xs text-gray-600 mb-2">
                                        <strong>Action:</strong> ${rec.action}
                                    </p>
                                    ${rec.potentialSavings ? `
                                        <div class="text-xs text-green-700 font-semibold">
                                            üí∞ ${rec.potentialSavings}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.classList.remove('hidden');
            } else {
                document.getElementById('cost-recommendations-container').classList.add('hidden');
            }
            
            // Render tier usage stats if available
            if (recommendationsData.stats) {
                const stats = recommendationsData.stats;
                // Could add a tier breakdown chart here in future
                console.log('üìä [COST DASHBOARD] Tier stats:', stats);
            }
        }
        
        /**
         * Export cost report to clipboard
         */
        async function exportCostReport() {
            if (!activeTemplateId) {
                if (window.ToastManager) {
                    window.ToastManager.warning('‚ö†Ô∏è No template selected');
                }
                return;
            }
            
            try {
                console.log('üìã [COST EXPORT] Generating cost report...');
                
                const token = getAuthToken();
                
                // Fetch all cost data
                const costResponse = await fetch(`/api/admin/ai-costs/template/${activeTemplateId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!costResponse.ok) {
                    throw new Error('Failed to fetch cost data');
                }
                
                const costData = await costResponse.json();
                const { budget, usage, templateName, month } = costData.data;
                
                // Fetch recommendations
                const recResponse = await fetch(`/api/admin/ai-costs/recommendations/${activeTemplateId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const recData = recResponse.ok ? await recResponse.json() : { data: { recommendations: [] } };
                
                // Generate report
                const report = generateCostReportText(costData.data, recData.data);
                
                // Copy to clipboard
                await navigator.clipboard.writeText(report);
                
                if (window.ToastManager) {
                    window.ToastManager.success(`‚úÖ Cost report copied to clipboard!`);
                }
                
                console.log('‚úÖ [COST EXPORT] Report copied to clipboard');
                
            } catch (error) {
                console.error('‚ùå [COST EXPORT] Error:', error);
                if (window.ToastManager) {
                    window.ToastManager.error('‚ùå Failed to export cost report');
                }
            }
        }
        
        /**
         * Generate cost report as formatted text
         */
        function generateCostReportText(costData, recData) {
            const { budget, usage, templateName, month } = costData;
            const timestamp = new Date().toISOString();
            
            let report = '';
            
            // Header
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += 'üìä AI COST REPORT\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            
            // Template Info
            report += 'üìã TEMPLATE INFORMATION:\n';
            report += `   Name: ${templateName}\n`;
            report += `   ID: ${costData.templateId}\n`;
            report += `   Month: ${month}\n`;
            report += `   Generated: ${timestamp}\n\n`;
            
            // Budget Overview
            report += 'üí∞ BUDGET OVERVIEW:\n';
            report += `   Status: ${budget.status}\n`;
            report += `   Total Spent: $${budget.used.toFixed(4)}\n`;
            report += `   Budget Limit: $${budget.limit.toFixed(2)}\n`;
            report += `   Remaining: $${budget.remaining.toFixed(2)}\n`;
            report += `   Percentage Used: ${budget.percentage.toFixed(1)}%\n`;
            report += `   Estimated Month End: $${budget.estimatedMonthly.toFixed(2)}\n\n`;
            
            // Usage Stats
            report += 'üìä USAGE STATISTICS:\n';
            report += `   Total LLM Calls: ${usage.totalCalls}\n`;
            report += `   Avg Cost Per Call: $${usage.avgCostPerCall.toFixed(4)}\n`;
            report += `   Total Tokens: ${usage.totalTokens.toLocaleString()}\n`;
            report += `   Avg Tokens Per Call: ${usage.avgTokensPerCall.toFixed(0)}\n`;
            report += `   Avg Confidence: ${(usage.avgConfidence * 100).toFixed(1)}%\n\n`;
            
            // Recommendations
            if (recData.recommendations && recData.recommendations.length > 0) {
                report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                report += 'üí° OPTIMIZATION RECOMMENDATIONS:\n';
                report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
                
                recData.recommendations.forEach((rec, index) => {
                    report += `${index + 1}. ${rec.title} (${rec.priority})\n`;
                    report += `   ${rec.message}\n`;
                    report += `   Action: ${rec.action}\n`;
                    if (rec.potentialSavings) {
                        report += `   Savings: ${rec.potentialSavings}\n`;
                    }
                    report += '\n';
                });
            }
            
            // Tier Statistics
            if (recData.stats) {
                report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                report += 'üéØ TIER USAGE BREAKDOWN:\n';
                report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
                report += `   Tier 1 (Rule-Based): ${recData.stats.tier1Percent}% - FREE ‚úÖ\n`;
                report += `   Tier 2 (Semantic): ${recData.stats.tier2Percent}% - FREE ‚úÖ\n`;
                report += `   Tier 3 (LLM): ${recData.stats.tier3Percent}% - $${usage.avgCostPerCall.toFixed(4)}/call\n`;
                report += `   Total Calls: ${recData.stats.totalCalls}\n\n`;
            }
            
            // Footer
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += 'üìå NOTES:\n';
            report += '   - Costs are calculated based on actual OpenAI API usage\n';
            report += '   - Budget resets monthly on the 1st of each month\n';
            report += '   - Improving template quality reduces Tier 3 usage and costs\n';
            report += '   - Target: 95%+ Tier 1 usage for optimal cost efficiency\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            
            return report;
        }
        
        // END AI COST DASHBOARD FUNCTIONS
        // =============================================
        // NOTE: Twilio config is now GLOBAL and STATIC
        // It does NOT reload when switching templates!
        // Only the activeTemplateId is updated when saving.
        // =============================================

        async function enhanceActiveTemplate() {
            if (!activeTemplate) {
                showNotification('‚ùå No active template found to enhance', 'error');
                return;
            }

            if (!confirm('‚ú® This will enhance the active template with:\n\n‚Ä¢ Auto-generated keywords from triggers\n‚Ä¢ Q&A pairs for training\n‚Ä¢ Confidence scores\n\nThis will make matching faster and more accurate!\n\nContinue?')) {
                return;
            }

            try {
                console.log('‚ú® Starting enhancement process...');
                showNotification('‚è≥ Enhancing template...', 'info');
                
                const token = getAuthToken();
                
                const response = await fetch(`/api/admin/global-instant-responses/${activeTemplate._id}/enhance`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('‚ú® Enhancement result:', result);

                if (result.success) {
                    const keywords = result.data?.stats?.totalKeywords || 'many';
                    const qnaPairs = result.data?.stats?.totalQnAPairs || 'many';
                    showNotification(`‚úÖ Enhanced! ${keywords} keywords, ${qnaPairs} Q&A pairs generated!`, 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showNotification('‚ùå Enhancement failed: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('‚ùå Enhancement error:', error);
                showNotification('‚ùå Error enhancing template: ' + error.message, 'error');
            }
        }

        function exportTemplate() {
            if (!activeTemplate) return;
            
            const dataStr = JSON.stringify(activeTemplate, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `global-ai-brain-${activeTemplate.version}-${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Template exported successfully!', 'success');
        }

        async function deleteCategory(index) {
            const category = activeTemplate.categories[index];
            
            if (!confirm(`üóëÔ∏è Delete category "${category.name}"?\n\nThis will permanently remove:\n- The category\n- ${category.scenarios?.length || 0} scenario(s)\n- All triggers and replies\n\nThis action cannot be undone!`)) {
                return;
            }
            
            try {
                showNotification('‚è≥ Deleting category...', 'info');
                
                // Remove category from array
                activeTemplate.categories.splice(index, 1);
                
                // Save to backend
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-instant-responses/${activeTemplate._id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        categories: activeTemplate.categories
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ Category "${category.name}" deleted successfully!`, 'success');
                    
                    // Refresh the current template (not the test pilot active template!)
                    await switchDashboardTemplate(activeTemplate._id);
                } else {
                    showNotification(`‚ùå Failed to delete: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå Error deleting category:', error);
                showNotification('‚ùå Error: ' + error.message, 'error');
                
                // Report error to Notification Center
                await errorReporters.categories.reportError({
                    error,
                    operation: 'deleteCategory',
                    userMessage: `Failed to delete category "${category.name}". Category still exists.`,
                    retryFunction: () => deleteCategory(index),
                    additionalContext: {
                        endpoint: `/api/admin/global-instant-responses/${activeTemplate._id}`,
                        templateId: activeTemplate._id,
                        categoryName: category.name,
                        categoryIndex: index,
                        scenarioCount: category.scenarios?.length || 0
                    }
                });
            }
        }

        // ============================================
        // EDIT SCENARIO MODAL
        // ============================================
        let currentEditingCategory = null;
        let currentEditingScenario = null;


        // ‚ùå DELETED: Legacy openEditScenarioModal (6142-6155) - opened deleted edit-scenario-modal

        async function editScenario(categoryIndex, scenarioIndex) {
            console.log(`‚úèÔ∏è [EDIT SCENARIO] Opening BIG scenario-modal (4-page form) for category ${categoryIndex}, scenario ${scenarioIndex}`);
            
            // Get category and scenario from activeTemplate
            const category = activeTemplate.categories[categoryIndex];
            const scenario = category.scenarios[scenarioIndex];
            
            if (!category || !scenario) {
                console.error('‚ùå Category or scenario not found');
                return;
            }
            
            console.log('üìã [EDIT SCENARIO] Scenario data:', scenario);
            
            // ‚úÖ SET CURRENT SCENARIO DATA (required for save operation)
            currentScenarioData = { 
                categoryId: category.id, 
                categoryName: category.name,
                scenarioId: scenario.scenarioId 
            };
            console.log('‚úÖ [EDIT SCENARIO] currentScenarioData set:', currentScenarioData);
            
            // Update modal title and category name for EDIT mode
            document.getElementById('scenario-modal-action').textContent = 'Edit';
            document.getElementById('scenario-category-name').textContent = category.name;
            
            // Populate behavior dropdown dynamically from database (must do before populating form)
            await fetchBehaviors(); // Refresh from DB
            populateBehaviorDropdown('scenario-behavior');
            
            // Populate ALL form fields using the restored function
            populateScenarioForm(scenario);
            
            // Load inherited fillers/synonyms
            if (typeof loadScenarioInheritedConfig === 'function') {
                await loadScenarioInheritedConfig(activeTemplateId, category.id);
            }
            
            // Open the BIG 4-page scenario modal
            document.getElementById('scenario-modal').style.display = 'flex';
            
            // Switch to first tab
            switchScenarioTab('basic');
            
            // V8: Initialize Scenario Architect Panel (if enabled)
            console.log('üß† [V8] Checking panel initialization (editScenario)...', { 
                featureFlag: window.useInlineScenarioArchitect, 
                classAvailable: !!window.ScenarioArchitectPanel 
            });
            
            if (window.useInlineScenarioArchitect && window.ScenarioArchitectPanel) {
                // Reset state for editing scenario
                window.aiAssistantState = {
                    description: '',
                    conversationLog: [],
                    lastDraft: null,
                };
                
                // Initialize or reinitialize panel
                window.scenarioArchitectPanel = new window.ScenarioArchitectPanel();
                console.log('‚úÖ [V8] Scenario Architect Panel initialized (editScenario)', window.scenarioArchitectPanel);
                
                // Verify button element exists
                const btn = document.getElementById('scenario-architect-send-btn');
                console.log('üîç [V8] Generate Draft button element:', btn);
            } else {
                console.warn('‚ö†Ô∏è [V8] Panel not initialized - feature disabled or class not loaded');
            }
        }


        // ‚ùå DELETED: closeEditScenarioModal (6231-6235) - closed deleted edit-scenario-modal


        // ============================================
        // ADD SCENARIO MODAL
        // ============================================
        let currentAddingCategory = null;

        async function addScenario(categoryIndex) {
            console.log(`üî• [ADD SCENARIO] Opening BIG scenario-modal (4-page form) for category index: ${categoryIndex}`);
            
            // Get category details from activeTemplate
            const category = activeTemplate.categories[categoryIndex];
            if (!category) {
                console.error('‚ùå Category not found at index:', categoryIndex);
                return;
            }
            
            // Set edit mode and current data for save functions
            currentScenarioEditMode = 'add';
            currentScenarioData = { 
                categoryId: category.id, 
                categoryName: category.name 
            };
            
            // Update modal title and category name
            document.getElementById('scenario-modal-action').textContent = 'Add';
            document.getElementById('scenario-category-name').textContent = category.name;
            
            // Reset form
            document.getElementById('scenario-form').reset();
            
            // Populate behavior dropdown dynamically from database
            await fetchBehaviors(); // Refresh from DB
            populateBehaviorDropdown('scenario-behavior');
            
            // Load inherited fillers/synonyms
            if (typeof loadScenarioInheritedConfig === 'function') {
                await loadScenarioInheritedConfig(activeTemplateId, category.id);
            }
            
            // Open the BIG 4-page scenario modal
            document.getElementById('scenario-modal').style.display = 'flex';
            
            // Switch to first tab
            switchScenarioTab('basic');
            
            // V8: Initialize Scenario Architect Panel (if enabled)
            console.log('üß† [V8] Checking panel initialization (addScenario)...', { 
                featureFlag: window.useInlineScenarioArchitect, 
                classAvailable: !!window.ScenarioArchitectPanel 
            });
            
            if (window.useInlineScenarioArchitect && window.ScenarioArchitectPanel) {
                // Reset state for new scenario
                window.aiAssistantState = {
                    description: '',
                    conversationLog: [],
                    lastDraft: null,
                };
                
                // Initialize or reinitialize panel
                window.scenarioArchitectPanel = new window.ScenarioArchitectPanel();
                console.log('‚úÖ [V8] Scenario Architect Panel initialized (addScenario)', window.scenarioArchitectPanel);
                
                // Verify button element exists
                const btn = document.getElementById('scenario-architect-send-btn');
                console.log('üîç [V8] Generate Draft button element:', btn);
            } else {
                console.warn('‚ö†Ô∏è [V8] Panel not initialized - feature disabled or class not loaded');
            }
        }

        // ============================================
        // INHERITED CONFIGURATION LOADER (Fillers & Synonyms)
        // ============================================
        
        /**
         * Load and display inherited fillers and synonyms for a scenario
         * @param {string} templateId - The template ID
         * @param {string} categoryId - The category ID
         */
        async function loadScenarioInheritedConfig(templateId, categoryId) {
            console.log('üì• [INHERITED CONFIG] Loading for template:', templateId, 'category:', categoryId);
            
            try {
                const token = localStorage.getItem('adminToken');
                
                // Load fillers
                const fillersResponse = await fetch(`/api/admin/global-instant-responses/${templateId}/fillers`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!fillersResponse.ok) {
                    throw new Error(`Failed to load fillers: ${fillersResponse.status}`);
                }
                
                const fillersData = await fillersResponse.json();
                const fillers = fillersData.fillers || [];
                
                // Load synonyms
                const synonymsResponse = await fetch(`/api/admin/global-instant-responses/${templateId}/synonyms`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!synonymsResponse.ok) {
                    throw new Error(`Failed to load synonyms: ${synonymsResponse.status}`);
                }
                
                const synonymsData = await synonymsResponse.json();
                const synonyms = synonymsData.synonyms || {};
                
                // Render fillers
                const fillersContainer = document.getElementById('scenario-inherited-fillers');
                const fillersCountEl = document.getElementById('scenario-fillers-count');
                
                if (fillersContainer) {
                    if (fillers.length === 0) {
                        fillersContainer.innerHTML = '<span style="color: #9ca3af; font-size: 13px;">No filler words inherited</span>';
                    } else {
                        fillersContainer.innerHTML = fillers.map(word => `
                            <span style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 500;">
                                ${word}
                            </span>
                        `).join('');
                    }
                }
                
                if (fillersCountEl) {
                    fillersCountEl.textContent = fillers.length;
                }
                
                // Render synonyms
                const synonymsContainer = document.getElementById('scenario-inherited-synonyms');
                const synonymsCountEl = document.getElementById('scenario-synonyms-count');
                
                if (synonymsContainer) {
                    const synonymEntries = Object.entries(synonyms);
                    
                    if (synonymEntries.length === 0) {
                        synonymsContainer.innerHTML = '<span style="color: #9ca3af; font-size: 13px;">No synonym mappings inherited</span>';
                    } else {
                        synonymsContainer.innerHTML = synonymEntries.map(([technical, colloquials]) => `
                            <div style="padding: 10px; background: #f3e8ff; border-left: 3px solid #9333ea; border-radius: 6px; margin-bottom: 8px;">
                                <div style="font-weight: 600; color: #581c87; font-size: 13px; margin-bottom: 4px;">
                                    ${technical}
                                </div>
                                <div style="font-size: 12px; color: #6b21a8;">
                                    ${Array.isArray(colloquials) ? colloquials.join(', ') : colloquials}
                                </div>
                            </div>
                        `).join('');
                    }
                }
                
                if (synonymsCountEl) {
                    synonymsCountEl.textContent = `${Object.keys(synonyms).length} mappings`;
                }
                
                console.log('‚úÖ [INHERITED CONFIG] Loaded successfully:', {
                    fillers: fillers.length,
                    synonyms: Object.keys(synonyms).length
                });
                
            } catch (error) {
                console.error('‚ùå [INHERITED CONFIG] Failed to load:', error);
                
                // Show error in containers
                const fillersContainer = document.getElementById('scenario-inherited-fillers');
                const synonymsContainer = document.getElementById('scenario-inherited-synonyms');
                
                if (fillersContainer) {
                    fillersContainer.innerHTML = '<span style="color: #ef4444; font-size: 13px;">‚ö†Ô∏è Failed to load fillers</span>';
                }
                
                if (synonymsContainer) {
                    synonymsContainer.innerHTML = '<span style="color: #ef4444; font-size: 13px;">‚ö†Ô∏è Failed to load synonyms</span>';
                }
            }
        }

        // ============================================
        // BIG 4-PAGE MODAL FUNCTIONS (RESTORED FROM c75c5db1)
        // ============================================

        async function openAddScenarioModal(categoryId, categoryName) {
            console.log(`üé® [ADD SCENARIO] Opening modal for category: ${categoryName} (${categoryId})`);
            
            currentScenarioEditMode = 'add';
            currentScenarioData = { categoryId, categoryName };
            
            // Update modal title
            document.getElementById('scenario-modal-action').textContent = 'Add';
            document.getElementById('scenario-category-name').textContent = categoryName;
            
            // Reset form
            document.getElementById('scenario-form').reset();
            
            // Populate behavior dropdown dynamically from database
            await fetchBehaviors(); // Refresh from DB
            populateBehaviorDropdown('scenario-behavior');
            
            // Load inherited fillers/synonyms
            if (typeof loadScenarioInheritedConfig === 'function') {
                await loadScenarioInheritedConfig(activeTemplateId, categoryId);
            }
            
            // Switch to first tab
            switchScenarioTab('basic');
            
            // Show modal
            document.getElementById('scenario-modal').style.display = 'flex';
            
            // V7: Initialize Scenario Architect Panel (if enabled)
            console.log('üß† [V8] Checking panel initialization...', { 
                featureFlag: window.useInlineScenarioArchitect, 
                classAvailable: !!window.ScenarioArchitectPanel 
            });
            
            if (window.useInlineScenarioArchitect && window.ScenarioArchitectPanel) {
                // Reset state for new scenario
                window.aiAssistantState = {
                    description: '',
                    conversationLog: [],
                    lastDraft: null,
                };
                
                // Initialize or reinitialize panel
                window.scenarioArchitectPanel = new window.ScenarioArchitectPanel();
                console.log('‚úÖ [V8] Scenario Architect Panel initialized for ADD mode', window.scenarioArchitectPanel);
                
                // Verify button element exists
                const btn = document.getElementById('scenario-architect-send-btn');
                console.log('üîç [V8] Generate Draft button element:', btn);
            } else {
                console.warn('‚ö†Ô∏è [V8] Panel not initialized - feature disabled or class not loaded');
            }
        }

        /**
         * Open scenario modal for editing an existing scenario
         */
        async function openEditScenarioModal(categoryId, categoryName, scenarioId) {
            console.log(`‚úèÔ∏è [EDIT SCENARIO] Opening modal for: ${scenarioId} in ${categoryName}`);
            
            currentScenarioEditMode = 'edit';
            currentScenarioData = { categoryId, categoryName, scenarioId };
            
            // Update modal title
            document.getElementById('scenario-modal-action').textContent = 'Edit';
            document.getElementById('scenario-category-name').textContent = categoryName;
            
            // Populate behavior dropdown dynamically from database (must do before fetching scenario data)
            await fetchBehaviors(); // Refresh from DB
            populateBehaviorDropdown('scenario-behavior');
            
            // Fetch scenario data
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-instant-responses/${activeTemplateId}/categories/${categoryId}/scenarios/${scenarioId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const { data } = await response.json();
                populateScenarioForm(data);
                
                // Load inherited fillers/synonyms
                if (typeof loadScenarioInheritedConfig === 'function') {
                    await loadScenarioInheritedConfig(activeTemplateId, categoryId);
                }
                
                // Switch to first tab
                switchScenarioTab('basic');
                
                // Show modal
                document.getElementById('scenario-modal').style.display = 'flex';
                
                // V7: Initialize Scenario Architect Panel (if enabled)
                console.log('üß† [V8] Checking panel initialization (EDIT mode)...', { 
                    featureFlag: window.useInlineScenarioArchitect, 
                    classAvailable: !!window.ScenarioArchitectPanel 
                });
                
                if (window.useInlineScenarioArchitect && window.ScenarioArchitectPanel) {
                    // Reset state for editing scenario
                    window.aiAssistantState = {
                        description: '',
                        conversationLog: [],
                        lastDraft: null,
                    };
                    
                    // Initialize or reinitialize panel
                    window.scenarioArchitectPanel = new window.ScenarioArchitectPanel();
                    console.log('‚úÖ [V8] Scenario Architect Panel initialized for EDIT mode', window.scenarioArchitectPanel);
                    
                    // Verify button element exists
                    const btn = document.getElementById('scenario-architect-send-btn');
                    console.log('üîç [V8] Generate Draft button element:', btn);
                } else {
                    console.warn('‚ö†Ô∏è [V8] Panel not initialized - feature disabled or class not loaded');
                }
                
            } catch (error) {
                console.error('‚ùå [EDIT SCENARIO] Error:', error);
                alert('Failed to load scenario data: ' + error.message);
            }
        }

        /**
         * Populate form with scenario data (for edit mode)
         */
        function populateScenarioForm(data) {
            console.log('üìù [POPULATE FORM] Loading scenario data:', data);
            
            // Basic Info Tab
            document.getElementById('scenario-name').value = data.name || '';
            document.getElementById('scenario-status').value = data.status || 'draft';
            document.getElementById('scenario-priority').value = data.priority || 0;
            document.getElementById('scenario-triggers').value = (data.triggers || []).join('\n');
            document.getElementById('scenario-negative-triggers').value = (data.negativeTriggers || []).join('\n');
            document.getElementById('scenario-regex-triggers').value = (data.regexTriggers || []).join('\n'); // NEW: Load regex patterns
            document.getElementById('scenario-context-weight').value = data.contextWeight || 0.7;
            
            // Update confidence display
            const confidencePercent = ((data.contextWeight || 0.7) * 100).toFixed(0);
            document.getElementById('confidence-value').textContent = confidencePercent + '%';
            
            document.getElementById('scenario-behavior').value = data.behavior || '';
            document.getElementById('scenario-channel').value = data.channel || 'any';
            document.getElementById('scenario-language').value = data.language || 'auto';
            
            // Replies & Flow Tab
            document.getElementById('scenario-quick-replies').value = (data.quickReplies || []).join('\n');
            document.getElementById('scenario-full-replies').value = (data.fullReplies || []).join('\n');
            document.getElementById('scenario-followup-funnel').value = data.followUpFunnel || '';
            document.getElementById('scenario-reply-selection').value = data.replySelection || 'random';
            
            // üéØ PHASE 2: Scenario Semantics
            document.getElementById('scenario-type').value = data.scenarioType || '';
            document.getElementById('scenario-reply-strategy').value = data.replyStrategy || 'AUTO';
            
            // Entities & Variables Tab
            document.getElementById('scenario-entity-capture').value = (data.entityCapture || []).join('\n');
            
            // Dynamic variables (Map to key=value format)
            if (data.dynamicVariables && typeof data.dynamicVariables === 'object') {
                const varLines = Object.entries(data.dynamicVariables).map(([k, v]) => `${k}=${v}`);
                document.getElementById('scenario-dynamic-variables').value = varLines.join('\n');
            }
            
            // Entity validation - handle both Map and Object
            if (data.entityValidation) {
                try {
                    let entityValObj;
                    if (data.entityValidation instanceof Map) {
                        entityValObj = Object.fromEntries(data.entityValidation);
                    } else if (typeof data.entityValidation === 'object') {
                        entityValObj = data.entityValidation;
                    } else {
                        entityValObj = {};
                    }
                    document.getElementById('scenario-entity-validation').value = JSON.stringify(entityValObj, null, 2);
                } catch (e) {
                    console.error('‚ö†Ô∏è [POPULATE] entityValidation error:', e);
                    document.getElementById('scenario-entity-validation').value = '';
                }
            } else {
                document.getElementById('scenario-entity-validation').value = '';
            }
            
            // Advanced Settings Tab
            document.getElementById('scenario-cooldown').value = data.cooldownSeconds || 0;
            document.getElementById('scenario-handoff-policy').value = data.handoffPolicy || 'low_confidence';
            
            // üéØ PHASE A ‚Äì STEP 3B: Follow-Up Behavior
            document.getElementById('scenario-followup-mode').value = data.followUpMode || 'NONE';
            document.getElementById('scenario-followup-question').value = data.followUpQuestionText || '';
            document.getElementById('scenario-followup-transfer-target').value = data.transferTarget || '';
            
            // Timed Follow-Up
            if (data.timedFollowUp) {
                document.getElementById('scenario-timed-enabled').checked = data.timedFollowUp.enabled || false;
                document.getElementById('scenario-timed-delay').value = data.timedFollowUp.delaySeconds || 50;
                document.getElementById('scenario-timed-extension').value = data.timedFollowUp.extensionSeconds || 30;
                document.getElementById('scenario-timed-messages').value = (data.timedFollowUp.messages || []).join('\n');
            }
            
            // Silence Policy
            if (data.silencePolicy) {
                document.getElementById('scenario-silence-max').value = data.silencePolicy.maxConsecutive || 2;
                document.getElementById('scenario-silence-warning').value = data.silencePolicy.finalWarning || 'Hello? Did I lose you?';
            }
            
            // TTS Override
            if (data.ttsOverride) {
                document.getElementById('scenario-tts-pitch').value = data.ttsOverride.pitch || '';
                document.getElementById('scenario-tts-rate').value = data.ttsOverride.rate || '';
                document.getElementById('scenario-tts-volume').value = data.ttsOverride.volume || '';
            }
            
            // Preconditions - handle both Map and Object
            if (data.preconditions) {
                try {
                    let precondObj;
                    if (data.preconditions instanceof Map) {
                        precondObj = Object.fromEntries(data.preconditions);
                    } else if (typeof data.preconditions === 'object') {
                        precondObj = data.preconditions;
                    } else {
                        precondObj = {};
                    }
                    document.getElementById('scenario-preconditions').value = JSON.stringify(precondObj, null, 2);
                } catch (e) {
                    console.error('‚ö†Ô∏è [POPULATE] preconditions error:', e);
                    document.getElementById('scenario-preconditions').value = '';
                }
            } else {
                document.getElementById('scenario-preconditions').value = '';
            }
            
            // Effects - handle both Map and Object
            if (data.effects) {
                try {
                    let effectsObj;
                    if (data.effects instanceof Map) {
                        effectsObj = Object.fromEntries(data.effects);
                    } else if (typeof data.effects === 'object') {
                        effectsObj = data.effects;
                    } else {
                        effectsObj = {};
                    }
                    document.getElementById('scenario-effects').value = JSON.stringify(effectsObj, null, 2);
                } catch (e) {
                    console.error('‚ö†Ô∏è [POPULATE] effects error:', e);
                    document.getElementById('scenario-effects').value = '';
                }
            } else {
                document.getElementById('scenario-effects').value = '';
            }
            
            // Action Hooks
            document.getElementById('scenario-action-hooks').value = (data.actionHooks || []).join(', ');
            
            // üß† AI ENHANCE TAB - Intelligence Fields
            console.log('üß† [POPULATE FORM] Loading AI intelligence fields...');
            
            // Render keywords
            if (data.keywords && Array.isArray(data.keywords) && data.keywords.length > 0) {
                renderKeywords(data.keywords);
            } else {
                renderKeywords([]);
            }
            
            // Render negative keywords
            if (data.negativeKeywords && Array.isArray(data.negativeKeywords) && data.negativeKeywords.length > 0) {
                renderNegativeKeywords(data.negativeKeywords);
            } else {
                renderNegativeKeywords([]);
            }
            
            // Render Q&A pairs
            if (data.qnaPairs && Array.isArray(data.qnaPairs) && data.qnaPairs.length > 0) {
                renderQnAPairs(data.qnaPairs);
            } else {
                renderQnAPairs([]);
            }
            
            // Render escalation flags
            if (data.escalationFlags && Array.isArray(data.escalationFlags) && data.escalationFlags.length > 0) {
                renderEscalationFlags(data.escalationFlags);
            } else {
                renderEscalationFlags([]);
            }
            
            // Render training examples
            if (data.examples && Array.isArray(data.examples) && data.examples.length > 0) {
                renderTrainingExamples(data.examples);
            } else {
                renderTrainingExamples([]);
            }
            
            console.log('‚úÖ [POPULATE FORM] AI intelligence fields loaded');
        }

        /**
         * Switch between tabs in scenario modal
         */
        function switchScenarioTab(tabName) {
            console.log(`üîÑ [SCENARIO TAB] Switching to: ${tabName}`);
            
            // Hide all tab contents
            document.querySelectorAll('.scenario-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Reset all tab buttons
            document.querySelectorAll('.scenario-tab').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = '#6c757d';
                btn.style.borderBottom = '3px solid transparent';
            });
            
            // Show selected tab content
            document.getElementById(`content-${tabName}`).style.display = 'block';
            
            // Highlight selected tab button
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.style.background = 'white';
            activeBtn.style.color = '#667eea';
            activeBtn.style.borderBottom = '3px solid #667eea';
        }

        // ===================================================================
        // üß† AI INTELLIGENCE FIELDS - KEYWORDS, Q&A, ESCALATION
        // ===================================================================
        
        let currentKeywords = [];
        let currentNegativeKeywords = [];
        let currentQnAPairs = [];
        let currentEscalationFlags = [];
        let currentTrainingExamples = [];
        
        // KEYWORDS FUNCTIONS
        function renderKeywords(keywords) {
            currentKeywords = keywords || [];
            const container = document.getElementById('keywords-display');
            if (!container) return;
            
            if (currentKeywords.length === 0) {
                container.innerHTML = '<span style="color: #9ca3af; font-style: italic;">No keywords generated yet. Click "Regenerate from Triggers" or use AI to generate.</span>';
                return;
            }
            
            container.innerHTML = currentKeywords.map((keyword, idx) => `
                <span style="background: #dcfce7; color: #166534; padding: 6px 12px; border-radius: 16px; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                    ${keyword}
                    <i class="fas fa-times" onclick="removeKeyword(${idx})" style="cursor: pointer; opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'"></i>
                </span>
            `).join('');
        }
        
        function addKeyword() {
            const input = document.getElementById('new-keyword-input');
            const keyword = input.value.trim().toLowerCase();
            if (!keyword) return;
            if (currentKeywords.includes(keyword)) {
                showNotification('‚ùå Keyword already exists', 'error');
                return;
            }
            currentKeywords.push(keyword);
            renderKeywords(currentKeywords);
            input.value = '';
            showNotification('‚úÖ Keyword added', 'success');
        }
        
        function removeKeyword(idx) {
            currentKeywords.splice(idx, 1);
            renderKeywords(currentKeywords);
            showNotification('üóëÔ∏è Keyword removed', 'success');
        }
        
        function regenerateKeywords() {
            const triggers = document.getElementById('scenario-triggers').value;
            if (!triggers.trim()) {
                showNotification('‚ö†Ô∏è No triggers to extract keywords from', 'error');
                return;
            }
            
            // Extract unique words from triggers (simple keyword extraction)
            const words = triggers.toLowerCase()
                .split(/[\n,;]+/)
                .flatMap(phrase => phrase.split(/\s+/))
                .map(w => w.trim())
                .filter(w => w.length > 2 && !['the', 'and', 'for', 'with', 'can', 'you', 'please'].includes(w));
            
            const uniqueWords = [...new Set(words)].sort().slice(0, 25);
            currentKeywords = uniqueWords;
            renderKeywords(currentKeywords);
            showNotification(`‚úÖ Extracted ${uniqueWords.length} keywords from triggers`, 'success');
        }
        
        // NEGATIVE KEYWORDS FUNCTIONS
        function renderNegativeKeywords(keywords) {
            currentNegativeKeywords = keywords || [];
            const container = document.getElementById('negative-keywords-display');
            if (!container) return;
            
            if (currentNegativeKeywords.length === 0) {
                container.innerHTML = '<span style="color: #9ca3af; font-style: italic;">No negative keywords yet. Click "Regenerate" or add manually.</span>';
                return;
            }
            
            container.innerHTML = currentNegativeKeywords.map((keyword, idx) => `
                <span style="background: #fee2e2; color: #991b1b; padding: 6px 12px; border-radius: 16px; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                    ${keyword}
                    <i class="fas fa-times" onclick="removeNegativeKeyword(${idx})" style="cursor: pointer; opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'"></i>
                </span>
            `).join('');
        }
        
        function addNegativeKeyword() {
            const input = document.getElementById('new-negative-keyword-input');
            const keyword = input.value.trim().toLowerCase();
            if (!keyword) return;
            if (currentNegativeKeywords.includes(keyword)) {
                showNotification('‚ùå Negative keyword already exists', 'error');
                return;
            }
            currentNegativeKeywords.push(keyword);
            renderNegativeKeywords(currentNegativeKeywords);
            input.value = '';
            showNotification('‚úÖ Negative keyword added', 'success');
        }
        
        function removeNegativeKeyword(idx) {
            currentNegativeKeywords.splice(idx, 1);
            renderNegativeKeywords(currentNegativeKeywords);
            showNotification('üóëÔ∏è Negative keyword removed', 'success');
        }
        
        function regenerateNegativeKeywords() {
            const negativeTriggers = document.getElementById('scenario-negative-triggers').value;
            if (!negativeTriggers.trim()) {
                showNotification('‚ö†Ô∏è No negative triggers to extract keywords from', 'error');
                return;
            }
            
            const words = negativeTriggers.toLowerCase()
                .split(/[\n,;]+/)
                .flatMap(phrase => phrase.split(/\s+/))
                .map(w => w.trim())
                .filter(w => w.length > 2);
            
            const uniqueWords = [...new Set(words)].sort().slice(0, 15);
            currentNegativeKeywords = uniqueWords;
            renderNegativeKeywords(currentNegativeKeywords);
            showNotification(`‚úÖ Extracted ${uniqueWords.length} negative keywords`, 'success');
        }
        
        // Q&A PAIRS FUNCTIONS
        function renderQnAPairs(pairs) {
            currentQnAPairs = pairs || [];
            const container = document.getElementById('qna-pairs-list');
            if (!container) return;
            
            if (currentQnAPairs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #9ca3af; font-style: italic; padding: 24px; background: #f9fafb; border-radius: 8px; border: 2px dashed #d1d5db;">
                        No Q&A pairs generated yet. Click "Regenerate" or use AI to generate.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentQnAPairs.map((pair, idx) => `
                <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 10px; padding: 16px;">
                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
                        <strong style="color: #1e40af; font-size: 14px;">‚ùì Question:</strong>
                        <i class="fas fa-times" onclick="removeQnAPair(${idx})" style="cursor: pointer; color: #ef4444; margin-left: auto;" title="Remove"></i>
                    </div>
                    <p style="margin: 0 0 12px 0; color: #1e3a8a; font-weight: 600;">${pair.question}</p>
                    <strong style="color: #1e40af; font-size: 14px;">üí¨ Answer:</strong>
                    <p style="margin: 6px 0 8px 0; color: #334155;">${pair.answer}</p>
                    <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #6b7280;">
                        <i class="fas fa-chart-line"></i>
                        <span>Confidence: ${((pair.confidence || 0.85) * 100).toFixed(0)}%</span>
                    </div>
                </div>
            `).join('');
        }
        
        function addQnAPair() {
            const questionInput = document.getElementById('new-qna-question');
            const answerInput = document.getElementById('new-qna-answer');
            const question = questionInput.value.trim();
            const answer = answerInput.value.trim();
            
            if (!question || !answer) {
                showNotification('‚ö†Ô∏è Please enter both question and answer', 'error');
                return;
            }
            
            currentQnAPairs.push({ question, answer, confidence: 0.85 });
            renderQnAPairs(currentQnAPairs);
            questionInput.value = '';
            answerInput.value = '';
            showNotification('‚úÖ Q&A pair added', 'success');
        }
        
        function removeQnAPair(idx) {
            currentQnAPairs.splice(idx, 1);
            renderQnAPairs(currentQnAPairs);
            showNotification('üóëÔ∏è Q&A pair removed', 'success');
        }
        
        function regenerateQnAPairs() {
            const triggers = document.getElementById('scenario-triggers').value;
            const replies = document.getElementById('scenario-full-replies').value;
            
            if (!triggers.trim() || !replies.trim()) {
                showNotification('‚ö†Ô∏è Need both triggers and replies to generate Q&A pairs', 'error');
                return;
            }
            
            const triggerLines = triggers.split('\n').filter(t => t.trim());
            const replyLines = replies.split('\n').filter(r => r.trim());
            
            // Generate Q&A pairs by combining triggers with first reply
            const pairs = triggerLines.slice(0, 10).map(trigger => ({
                question: trigger.trim(),
                answer: replyLines[0]?.trim() || 'Response not available',
                confidence: 0.85
            }));
            
            currentQnAPairs = pairs;
            renderQnAPairs(currentQnAPairs);
            showNotification(`‚úÖ Generated ${pairs.length} Q&A pairs`, 'success');
        }
        
        // ESCALATION FLAGS FUNCTIONS
        function renderEscalationFlags(flags) {
            currentEscalationFlags = flags || [];
            const container = document.getElementById('escalation-flags-display');
            if (!container) return;
            
            if (currentEscalationFlags.length === 0) {
                container.innerHTML = '<span style="color: #9ca3af; font-style: italic;">No escalation flags set. Add flags that should trigger human handoff.</span>';
                return;
            }
            
            container.innerHTML = currentEscalationFlags.map((flag, idx) => `
                <span style="background: #fef3c7; color: #92400e; padding: 6px 12px; border-radius: 16px; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                    üö® ${flag}
                    <i class="fas fa-times" onclick="removeEscalationFlag(${idx})" style="cursor: pointer; opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'"></i>
                </span>
            `).join('');
        }
        
        function addEscalationFlag() {
            const input = document.getElementById('new-escalation-flag-input');
            const flag = input.value.trim().toLowerCase();
            if (!flag) return;
            if (currentEscalationFlags.includes(flag)) {
                showNotification('‚ùå Escalation flag already exists', 'error');
                return;
            }
            currentEscalationFlags.push(flag);
            renderEscalationFlags(currentEscalationFlags);
            input.value = '';
            showNotification('‚úÖ Escalation flag added', 'success');
        }
        
        function removeEscalationFlag(idx) {
            currentEscalationFlags.splice(idx, 1);
            renderEscalationFlags(currentEscalationFlags);
            showNotification('üóëÔ∏è Escalation flag removed', 'success');
        }
        
        // TRAINING EXAMPLES FUNCTIONS
        function renderTrainingExamples(examples) {
            currentTrainingExamples = examples || [];
            const container = document.getElementById('training-examples-list');
            if (!container) return;
            
            if (currentTrainingExamples.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #9ca3af; font-style: italic; padding: 24px; background: #f9fafb; border-radius: 8px; border: 2px dashed #d1d5db;">
                        No training examples yet. Use AI to generate or add manually.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentTrainingExamples.map((example, idx) => `
                <div style="background: #f5f3ff; border: 2px solid #8b5cf6; border-radius: 10px; padding: 16px;">
                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
                        <strong style="color: #6d28d9; font-size: 14px;">üë§ Caller:</strong>
                        <i class="fas fa-times" onclick="removeTrainingExample(${idx})" style="cursor: pointer; color: #ef4444; margin-left: auto;" title="Remove"></i>
                    </div>
                    <p style="margin: 0 0 12px 0; color: #5b21b6; font-style: italic;">"${example.caller}"</p>
                    <strong style="color: #6d28d9; font-size: 14px;">ü§ñ AI:</strong>
                    <p style="margin: 6px 0 0 0; color: #334155;">"${example.ai}"</p>
                </div>
            `).join('');
        }
        
        function addTrainingExample() {
            const callerInput = document.getElementById('new-example-caller');
            const aiInput = document.getElementById('new-example-ai');
            const caller = callerInput.value.trim();
            const ai = aiInput.value.trim();
            
            if (!caller || !ai) {
                showNotification('‚ö†Ô∏è Please enter both caller and AI responses', 'error');
                return;
            }
            
            currentTrainingExamples.push({ caller, ai });
            renderTrainingExamples(currentTrainingExamples);
            callerInput.value = '';
            aiInput.value = '';
            showNotification('‚úÖ Training example added', 'success');
        }
        
        function removeTrainingExample(idx) {
            currentTrainingExamples.splice(idx, 1);
            renderTrainingExamples(currentTrainingExamples);
            showNotification('üóëÔ∏è Training example removed', 'success');
        }

        /**
         * Close scenario modal
         */
        // ===================================================================
        // ü§ñ PHASE A ‚Äì STEP 4: AI SCENARIO ASSISTANT FUNCTIONS
        // ===================================================================
        
        // ============================================================================
        // V7: FEATURE FLAG - Persistent AI Architect Panel vs Legacy Modal
        // ============================================================================
        window.useInlineScenarioArchitect = true; // Set to false to revert to green modal

        let aiAssistantDraft = null;

        /**
         * V7: Focus the inline AI Architect Panel (called from "Ask AI to Draft" button)
         */
        function focusScenarioArchitectPanel() {
            console.log('üß† [V7] Focusing AI Architect Panel...');
            
            if (window.scenarioArchitectPanel) {
                window.scenarioArchitectPanel.focus();
            } else {
                console.error('üß† [V7] ScenarioArchitectPanel not initialized yet');
            }
        }

        function openScenarioAIAssistant() {
            console.log('ü§ñ [AI ASSISTANT] Opening...');
            document.getElementById('scenario-ai-notes').value = '';
            document.getElementById('scenario-ai-result-wrapper').style.display = 'none';
            document.getElementById('scenario-ai-error').style.display = 'none';
            document.getElementById('scenario-ai-apply-btn').style.display = 'none';
            document.getElementById('scenario-ai-generate-btn').disabled = false;
            document.getElementById('scenario-ai-generate-btn').textContent = '‚ú® Generate Draft';
            aiAssistantDraft = null;
            document.getElementById('scenario-ai-assistant-modal').style.display = 'block';
        }

        function closeScenarioAIAssistant() {
            console.log('ü§ñ [AI ASSISTANT] Closing...');
            document.getElementById('scenario-ai-assistant-modal').style.display = 'none';
            aiAssistantDraft = null;
        }

        // ============================================================================
        // PHASE C.1: Conversational Scenario Assistant
        // ============================================================================
        // State for multi-turn conversation with the AI
        window.aiAssistantState = {
            description: '',
            conversationLog: [], // { role: 'assistant'|'user', content: string }
            lastDraft: null,
        };

        // ============================================================================
        // V7: SCENARIO ARCHITECT - SHARED API HELPER (NO DOM ACCESS)
        // ============================================================================
        /**
         * Core API helper for calling /api/admin/scenario-assistant/draft
         * No DOM dependencies - pure token discovery + API call
         * Used by both modal mode and panel mode
         */
        async function callScenarioAssistantAPI(aiState) {
            console.log('üîç [API HELPER] Calling scenario assistant API...');
            
            // üîç CHECKPOINT 1: Check all possible token locations
            console.log('üîç [CHECKPOINT 1] Searching for JWT token in all locations...');
            
            const tokenFromStandardKey = localStorage.getItem('token');
            const tokenFromAdminToken = localStorage.getItem('dminToken');
            const tokenFromAdminTokenFull = localStorage.getItem('adminToken');
            const tokenFromSessionStorage = sessionStorage.getItem('token');
            const tokenFromCookie = document.cookie.split('; ').find(row => row.startsWith('token='));
            const allCookies = document.cookie;
            
            console.log('üîç [CHECKPOINT 1A] localStorage "token":', tokenFromStandardKey ? `Found (length: ${tokenFromStandardKey.length})` : 'NOT FOUND');
            console.log('üîç [CHECKPOINT 1A2] localStorage "dminToken":', tokenFromAdminToken ? `Found (length: ${tokenFromAdminToken.length})` : 'NOT FOUND');
            console.log('üîç [CHECKPOINT 1A3] localStorage "adminToken":', tokenFromAdminTokenFull ? `Found (length: ${tokenFromAdminTokenFull.length})` : 'NOT FOUND');
            console.log('üîç [CHECKPOINT 1B] sessionStorage "token":', tokenFromSessionStorage ? `Found (length: ${tokenFromSessionStorage.length})` : 'NOT FOUND');
            console.log('üîç [CHECKPOINT 1C] Cookie token:', tokenFromCookie ? 'Found' : 'NOT FOUND');
            console.log('üîç [CHECKPOINT 1D] All cookies:', allCookies || 'EMPTY');
            
            const tokenFromWindow = window.jwtToken || window.authToken || window.getAuthToken;
            console.log('üîç [CHECKPOINT 1E] window.jwtToken/authToken:', tokenFromWindow ? 'Found' : 'NOT FOUND');
            
            // üîç CHECKPOINT 2: Check user object
            console.log('üîç [CHECKPOINT 2] Checking user/auth objects...');
            const adminUser = localStorage.getItem('adminUser');
            console.log('üîç [CHECKPOINT 2A] localStorage "adminUser":', adminUser ? adminUser : 'NOT FOUND');
            console.log('üîç [CHECKPOINT 2B] window.user:', window.user ? JSON.stringify(window.user) : 'NOT FOUND');
            console.log('üîç [CHECKPOINT 2C] window.currentUser:', window.currentUser ? JSON.stringify(window.currentUser) : 'NOT FOUND');
            
            // üîç CHECKPOINT 3: Build token with fallback priority
            const token = tokenFromStandardKey || tokenFromAdminToken || tokenFromAdminTokenFull || tokenFromSessionStorage || tokenFromWindow;
            
            console.log('üîç [CHECKPOINT 3] Final token determination:');
            if (token) {
                const source = tokenFromStandardKey ? 'localStorage[token]' : 
                               tokenFromAdminToken ? 'localStorage[dminToken]' :
                               tokenFromAdminTokenFull ? 'localStorage[adminToken]' :
                               tokenFromSessionStorage ? 'sessionStorage[token]' : 'window object';
                console.log(`‚úÖ Token found! Source: ${source}, Length: ${token.length}`);
            } else {
                console.error('‚ùå NO TOKEN FOUND IN ANY LOCATION!');
                console.error('Available storage keys:');
                console.error('  localStorage keys:', Object.keys(localStorage));
                console.error('  sessionStorage keys:', Object.keys(sessionStorage));
                console.error('  window properties (auth-related):', Object.keys(window).filter(k => k.toLowerCase().includes('auth') || k.toLowerCase().includes('token')));
                
                throw new Error('AUTHENTICATION ERROR: No token found in any location. You may need to log in again.');
            }
            
            console.log('üîç [CHECKPOINT 4] Sending request with token...');
            const response = await fetch('/api/admin/scenario-assistant/draft', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                credentials: 'include',
                body: JSON.stringify({
                    description: aiState.description,
                    conversationLog: aiState.conversationLog,
                    channel: 'voice',
                    templateVariables: ['companyname', 'phone', 'address', 'website_url', 'office_hours'],
                }),
            });
            
            console.log('üîç [CHECKPOINT 5] Response status:', response.status, response.statusText);
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to generate scenario');
            }
            
            console.log('üîç [API HELPER] ‚úÖ API call successful, status:', data.status);
            return data;
        }

        // ============================================================================
        // V7: PANEL MODE - Persistent AI Architect Panel
        // ============================================================================
        /**
         * Panel mode: Updates inline persistent panel (no modal closure)
         * Called by ScenarioArchitectPanel class
         */
        async function generateScenarioAIDraftPanelMode(panelInstance) {
            console.log('üß† [PANEL MODE] Generating draft...');
            
            try {
                const data = await callScenarioAssistantAPI(window.aiAssistantState);
                
                // CASE 1: Clarifying questions needed
                if (data.status === 'needs_clarification') {
                    const questions = Array.isArray(data.questions) && data.questions.length > 0
                        ? data.questions
                        : ['Please provide more details about this scenario.'];
                    
                    const combinedQuestion = questions.join(' ');
                    window.aiAssistantState.conversationLog.push({ role: 'assistant', content: combinedQuestion });
                    
                    panelInstance.renderChat();
                    panelInstance._setStatus('ü§î AI needs clarification. Answer below and click Continue.', 'info');
                    
                    if (panelInstance.sendBtn) {
                        panelInstance.sendBtn.textContent = '‚Ü©Ô∏è Continue';
                    }
                    
                    console.log('üß† [PANEL MODE] Clarifying questions asked:', questions);
                    return;
                }
                
                // CASE 2: Draft is ready
                if (data.status === 'ready' && data.draft) {
                    window.aiAssistantState.lastDraft = data.draft;
                    window.aiAssistantDraft = data.draft;
                    
                    panelInstance.renderChecklist(data.checklistSummary || null);
                    panelInstance._setStatus('‚úÖ Draft ready! Review above and click "Apply to Form".', 'success');
                    
                    if (panelInstance.applyBtn) {
                        panelInstance.applyBtn.style.display = 'inline-block';
                    }
                    if (panelInstance.sendBtn) {
                        panelInstance.sendBtn.textContent = 'üîÑ Refine Draft';
                    }
                    
                    panelInstance.renderChat();
                    
                    console.log('üß† [PANEL MODE] ‚úÖ Full draft generated:', data.draft);
                    console.log('üß† [PANEL MODE] Checklist Summary:', data.checklistSummary);
                    return;
                }
                
                throw new Error('Unexpected response format from server');
            } catch (err) {
                console.error('üß† [PANEL MODE] ‚ùå Error:', err);
                panelInstance._setStatus(`‚ùå ${err.message || 'Error generating scenario'}`, 'error');
                throw err;
            }
        }

        // ============================================================================
        // V7: MODAL MODE - Legacy Green Modal (keep for safety)
        // ============================================================================
        /**
         * Modal mode wrapper: Uses existing modal DOM elements
         * This is the original behavior, kept for backward compatibility
         */
        async function generateScenarioAIDraftModalMode() {
            console.log('ü§ñ [MODAL MODE] Generating draft (legacy green modal)...');
            
            const descEl = document.getElementById('scenario-ai-notes');
            const answerEl = document.getElementById('scenario-ai-answer');
            const answerWrapper = document.getElementById('scenario-ai-answer-wrapper');
            const chatEl = document.getElementById('scenario-ai-chat');
            const errBox = document.getElementById('scenario-ai-error');
            const statusEl = document.getElementById('scenario-ai-status');
            const resultWrapper = document.getElementById('scenario-ai-result-wrapper');
            const resultTextarea = document.getElementById('scenario-ai-result-json');
            const generateBtn = document.getElementById('scenario-ai-generate-btn');
            const applyBtn = document.getElementById('scenario-ai-apply-btn');

            if (!errBox || !statusEl) {
                console.error('ü§ñ [MODAL MODE ERROR] Critical elements missing from DOM');
                return;
            }

            errBox.style.display = 'none';
            errBox.textContent = '';
            statusEl.style.display = 'none';
            statusEl.textContent = '';

            // Step 1: Capture initial description if not yet stored
            if (!window.aiAssistantState.description) {
                const description = (descEl.value || '').trim();
                if (!description) {
                    errBox.textContent = '‚ö†Ô∏è Please describe what this scenario should do.';
                    errBox.style.display = 'block';
                    return;
                }
                window.aiAssistantState.description = description;
            }

            // Step 2: If there's an answer visible, add it to conversation
            if (answerEl && answerWrapper && answerWrapper.style.display !== 'none') {
                const answerText = (answerEl.value || '').trim();
                if (answerText) {
                    window.aiAssistantState.conversationLog.push({ role: 'user', content: answerText });
                }
                answerEl.value = '';
                answerWrapper.style.display = 'none';
            }

            statusEl.textContent = 'ü§î Thinking...';
            statusEl.style.display = 'block';
            generateBtn.disabled = true;
            generateBtn.textContent = '‚è≥ Processing...';

            try {
                // V7: Delegate to shared API helper (no duplicate token logic)
                const data = await callScenarioAssistantAPI(window.aiAssistantState);

                // CASE 1: Clarifying questions needed
                if (data.status === 'needs_clarification') {
                    const questions = Array.isArray(data.questions) && data.questions.length > 0
                        ? data.questions
                        : ['Please provide more details about this scenario.'];

                    const combinedQuestion = questions.join(' ');
                    window.aiAssistantState.conversationLog.push({ role: 'assistant', content: combinedQuestion });
                    renderAIAssistantChat();

                    if (answerWrapper) answerWrapper.style.display = 'block';
                    if (answerEl) answerEl.placeholder = 'Answer the AI question(s), then click "Generate Draft" again...';
                    statusEl.textContent = 'ü§î The AI needs clarification. Answer above and click again.';
                    generateBtn.textContent = '‚Ü©Ô∏è Continue';

                    console.log('ü§ñ [C.1 ASSISTANT] Clarifying questions asked:', questions);
                    return;
                }

                // CASE 2: Draft is ready
                if (data.status === 'ready' && data.draft) {
                    window.aiAssistantState.lastDraft = data.draft;
                    resultTextarea.value = JSON.stringify(data.draft, null, 2);
                    resultWrapper.style.display = 'block';
                    applyBtn.style.display = 'block';
                    statusEl.innerHTML = '‚úÖ <strong>Draft ready!</strong> Review and click "Apply Draft to Form"';
                    statusEl.style.display = 'block';

                    // Show checklist summary if available (Phase C.1 validation)
                    if (data.checklistSummary) {
                        renderChecklistSummary(data.checklistSummary);
                    }

                    aiAssistantDraft = data.draft;

                    console.log('ü§ñ [C.1 ASSISTANT] Full draft generated:', data.draft);
                    console.log('ü§ñ [C.1 ASSISTANT] Checklist Summary:', data.checklistSummary);
                    return;
                }

                throw new Error('Unexpected response format from server');
            } catch (err) {
                console.error('ü§ñ [MODAL MODE] ‚ùå Error:', err);
                errBox.textContent = '‚ùå ' + (err.message || 'Error generating scenario');
                errBox.style.display = 'block';
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '‚ú® Generate Draft';
            }
        }

        // ============================================================================
        // V7: PUBLIC WRAPPER - Feature Flag Delegation
        // ============================================================================
        /**
         * Public wrapper: existing code calls this via onclick="generateScenarioAIDraft()"
         * Delegates to modal mode (keeps old behavior working)
         */
        async function generateScenarioAIDraft() {
            return generateScenarioAIDraftModalMode();
        }

        /**
         * Render the conversation chat history
         */
        function renderAIAssistantChat() {
            const chatEl = document.getElementById('scenario-ai-chat');
            if (!chatEl) return;

            chatEl.innerHTML = '';
            window.aiAssistantState.conversationLog.forEach(msg => {
                const div = document.createElement('div');
                div.style.marginBottom = '12px';
                const who = msg.role === 'assistant' ? 'ü§ñ AI' : 'üë§ You';
                const bgColor = msg.role === 'assistant' ? '#e8f4f8' : '#f0f0f0';
                div.style.padding = '8px 12px';
                div.style.borderRadius = '6px';
                div.style.backgroundColor = bgColor;
                div.innerHTML = '<strong>' + who + ':</strong> ' + msg.content;
                chatEl.appendChild(div);
            });

            chatEl.style.display = 'block';
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        /**
         * PHASE C.1: Render AI Checklist Summary
         * Shows admin what was configured and what assumptions LLM made
         */
        function renderChecklistSummary(checklistSummary) {
            const checklistEl = document.getElementById('scenario-ai-checklist');
            if (!checklistEl) return;

            const coverage = checklistSummary.coverageScore 
                ? Math.round(checklistSummary.coverageScore * 100) 
                : 90;

            let html = `<div style="padding: 16px; background: #ecfdf5; border-left: 4px solid #10b981; border-radius: 8px; font-size: 13px;">`;
            html += `<strong style="color: #047857;">‚úÖ AI Checklist (${coverage}% complete):</strong><br/>`;

            if (checklistSummary.settingsNeedingAttention && checklistSummary.settingsNeedingAttention.length > 0) {
                html += `<ul style="margin: 8px 0; padding-left: 20px; color: #047857;">`;
                checklistSummary.settingsNeedingAttention.forEach(item => {
                    html += `<li style="margin-bottom: 6px;"><strong>${item.field}:</strong> ${item.reason}</li>`;
                });
                html += `</ul>`;
                html += `<p style="margin: 8px 0; color: #666; font-style: italic;">Review these before applying. You can tweak them after applying the draft.</p>`;
            } else {
                html += `<p style="margin: 8px 0; color: #047857;"><em>‚ú® All settings look good! Ready to apply.</em></p>`;
            }

            html += `</div>`;

            checklistEl.innerHTML = html;
            checklistEl.style.display = 'block';
        }

        /**
         * PHASE C.1: Apply full-form draft to scenario editor
         * Handles 30+ fields including triggers, replies, entities, advanced settings
         */
        function applyScenarioAIDraft() {
            if (!aiAssistantDraft) {
                console.warn('ü§ñ [C.1 ASSISTANT] No draft to apply');
                return;
            }

            const draft = aiAssistantDraft;
            console.log('ü§ñ [C.1 ASSISTANT] Applying full-form draft:', draft);

            const getEl = id => document.getElementById(id);
            const joinLines = arr => {
                if (!Array.isArray(arr)) return '';
                return arr.map(item => {
                    if (typeof item === 'string') return item;
                    if (item && typeof item === 'object' && item.text) return item.text;
                    return '';
                }).filter(s => s.length > 0).join('\n');
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 1. BASIC INFO
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (draft.name && getEl('scenario-name')) getEl('scenario-name').value = draft.name;
            if (draft.scenarioType && getEl('scenario-type')) getEl('scenario-type').value = draft.scenarioType;
            if (draft.replyStrategy && getEl('scenario-reply-strategy')) getEl('scenario-reply-strategy').value = draft.replyStrategy;

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 2. TRIGGERS & PHRASES (Multiple variants)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (draft.triggerPhrases && getEl('scenario-triggers')) 
                getEl('scenario-triggers').value = joinLines(draft.triggerPhrases);
            
            if (draft.negativeTriggers && getEl('scenario-negative-triggers')) 
                getEl('scenario-negative-triggers').value = joinLines(draft.negativeTriggers);
            
            if (draft.regexTriggers && getEl('scenario-regex-triggers')) 
                getEl('scenario-regex-triggers').value = joinLines(draft.regexTriggers);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 3. REPLIES (Quick, Full, Follow-ups)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (draft.quickReplies && getEl('scenario-quick-replies')) 
                getEl('scenario-quick-replies').value = joinLines(draft.quickReplies);
            
            if (draft.fullReplies && getEl('scenario-full-replies')) 
                getEl('scenario-full-replies').value = joinLines(draft.fullReplies);
            
            if (draft.followUpPrompts && getEl('scenario-followup-prompts')) 
                getEl('scenario-followup-prompts').value = joinLines(draft.followUpPrompts);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 4. FOLLOW-UP BEHAVIOR
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (draft.followUpMode && getEl('scenario-followup-mode')) 
                getEl('scenario-followup-mode').value = draft.followUpMode;
            
            if (draft.followUpQuestionText && getEl('scenario-followup-question')) 
                getEl('scenario-followup-question').value = draft.followUpQuestionText;
            
            if (draft.transferTarget && getEl('scenario-followup-transfer-target')) 
                getEl('scenario-followup-transfer-target').value = draft.transferTarget;

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 5. CONFIDENCE & PRIORITY
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (typeof draft.minConfidence === 'number' && getEl('scenario-min-confidence')) 
                getEl('scenario-min-confidence').value = draft.minConfidence.toFixed(2);
            
            if (typeof draft.priority === 'number' && getEl('scenario-priority')) 
                getEl('scenario-priority').value = draft.priority;

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 6. ENTITIES & VARIABLES
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (draft.entities && getEl('scenario-entities')) 
                getEl('scenario-entities').value = joinLines(draft.entities);
            
            if (draft.dynamicTemplateVariables && getEl('scenario-dynamic-variables')) {
                const varLines = Object.keys(draft.dynamicTemplateVariables).map(key => {
                    const desc = draft.dynamicTemplateVariables[key];
                    return `{${key}}=${desc}`;
                });
                getEl('scenario-dynamic-variables').value = varLines.join('\n');
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 7. ADVANCED BEHAVIOR
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (typeof draft.cooldownSeconds === 'number' && getEl('scenario-cooldown-seconds')) 
                getEl('scenario-cooldown-seconds').value = draft.cooldownSeconds;
            
            if (draft.handoffPolicy && getEl('scenario-handoff-policy')) 
                getEl('scenario-handoff-policy').value = draft.handoffPolicy;

            // Silence Policy
            if (draft.silencePolicy) {
                if (getEl('scenario-silence-enabled')) 
                    getEl('scenario-silence-enabled').checked = !!draft.silencePolicy.enabled;
                if (draft.silencePolicy.firstPrompt && getEl('scenario-silence-first')) 
                    getEl('scenario-silence-first').value = draft.silencePolicy.firstPrompt;
                if (draft.silencePolicy.repeatPrompt && getEl('scenario-silence-repeat')) 
                    getEl('scenario-silence-repeat').value = draft.silencePolicy.repeatPrompt;
                if (typeof draft.silencePolicy.maxPrompts === 'number' && getEl('scenario-silence-max-prompts')) 
                    getEl('scenario-silence-max-prompts').value = draft.silencePolicy.maxPrompts;
                if (typeof draft.silencePolicy.delaySeconds === 'number' && getEl('scenario-silence-delay')) 
                    getEl('scenario-silence-delay').value = draft.silencePolicy.delaySeconds;
            }

            // Timed Follow-up
            if (draft.timedFollowup) {
                if (getEl('scenario-timed-followup-enabled')) 
                    getEl('scenario-timed-followup-enabled').checked = !!draft.timedFollowup.enabled;
                if (typeof draft.timedFollowup.delaySeconds === 'number' && getEl('scenario-timed-followup-delay')) 
                    getEl('scenario-timed-followup-delay').value = draft.timedFollowup.delaySeconds;
                if (typeof draft.timedFollowup.extensionSeconds === 'number' && getEl('scenario-timed-followup-extension')) 
                    getEl('scenario-timed-followup-extension').value = draft.timedFollowup.extensionSeconds;
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 8. ACTION HOOKS & TESTING
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (draft.actionHooks && getEl('scenario-action-hooks')) 
                getEl('scenario-action-hooks').value = joinLines(draft.actionHooks);
            
            if (draft.testPhrases && draft.testPhrases.length > 0) {
                if (getEl('scenario-test-phrase')) 
                    getEl('scenario-test-phrase').value = draft.testPhrases[0];
                if (getEl('scenario-test-phrases-extra')) 
                    getEl('scenario-test-phrases-extra').value = draft.testPhrases.join('\n');
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 9. NLP SUGGESTIONS (Template-level)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (draft.suggestedFillerWords && getEl('scenario-suggested-filler-words')) 
                getEl('scenario-suggested-filler-words').value = joinLines(draft.suggestedFillerWords);
            
            if (draft.suggestedSynonyms && getEl('scenario-suggested-synonyms')) {
                const synLines = Object.keys(draft.suggestedSynonyms).map(base => {
                    const variants = draft.suggestedSynonyms[base];
                    return `${base}: ${variants.join(', ')}`;
                });
                getEl('scenario-suggested-synonyms').value = synLines.join('\n');
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 10. NOTES
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (draft.notes && getEl('scenario-notes')) 
                getEl('scenario-notes').value = draft.notes;

            console.log('‚úÖ [C.1 ASSISTANT] Draft applied to form (30+ fields)');
            closeScenarioAIAssistant();

            // Switch to Basic Info tab to show filled form
            switchScenarioTab('basic');
        }

        // ===================================================================

        function closeScenarioModal() {
            console.log('‚ùå [SCENARIO MODAL] Closing...');
            document.getElementById('scenario-modal').style.display = 'none';
            document.getElementById('scenario-form').reset();
            currentScenarioData = null;
        }

        /**
         * Save scenario as DRAFT
         */
        async function saveScenarioAsDraft() {
            console.log('üíæ [SAVE DRAFT] Saving scenario as draft...');
            await saveScenario('draft');
        }

        /**
         * Save scenario as LIVE (Published)
         */
        async function saveScenarioAsLive() {
            console.log('üöÄ [SAVE LIVE] Publishing scenario as live...');
            await saveScenario('live');
        }

        /**
         * Core save logic for scenarios
         */
        async function saveScenario(status) {
            console.log(`üíæ [SAVE SCENARIO] Mode: ${currentScenarioEditMode}, Status: ${status}`);
            
            // Validate required fields
            const name = document.getElementById('scenario-name').value.trim();
            const triggers = document.getElementById('scenario-triggers').value.trim();
            const quickReplies = document.getElementById('scenario-quick-replies').value.trim();
            const fullReplies = document.getElementById('scenario-full-replies').value.trim();
            
            if (!name || !triggers || !quickReplies || !fullReplies) {
                alert('Please fill all required fields: Scenario Name, Triggers, Quick Replies, Full Replies');
                return;
            }
            
            // Build scenario data object
            const scenarioData = {
                name,
                status,
                priority: parseInt(document.getElementById('scenario-priority').value) || 0,
                triggers: triggers.split('\n').filter(t => t.trim()),
                negativeTriggers: document.getElementById('scenario-negative-triggers').value.split('\n').filter(t => t.trim()),
                regexTriggers: document.getElementById('scenario-regex-triggers').value.split('\n').filter(t => t.trim()),
                contextWeight: parseFloat(document.getElementById('scenario-context-weight').value) || 0.7,
                behavior: document.getElementById('scenario-behavior').value || null,
                channel: document.getElementById('scenario-channel').value || 'any',
                language: document.getElementById('scenario-language').value || 'auto',
                
                quickReplies: quickReplies.split('\n').filter(r => r.trim()),
                fullReplies: fullReplies.split('\n').filter(r => r.trim()),
                followUpFunnel: document.getElementById('scenario-followup-funnel').value.trim(),
                replySelection: document.getElementById('scenario-reply-selection').value || 'random',
                
                // üéØ PHASE 2: Scenario Semantics
                scenarioType: document.getElementById('scenario-type').value || null,
                replyStrategy: document.getElementById('scenario-reply-strategy').value || 'AUTO',
                
                entityCapture: document.getElementById('scenario-entity-capture').value.split('\n').filter(e => e.trim()),
                dynamicVariables: parseDynamicVariables(document.getElementById('scenario-dynamic-variables').value),
                entityValidation: tryParseJSON(document.getElementById('scenario-entity-validation').value),
                
                cooldownSeconds: parseInt(document.getElementById('scenario-cooldown').value) || 0,
                handoffPolicy: document.getElementById('scenario-handoff-policy').value || 'low_confidence',
                
                // üéØ PHASE A ‚Äì STEP 3B: Follow-Up Behavior
                followUpMode: document.getElementById('scenario-followup-mode').value || 'NONE',
                followUpQuestionText: document.getElementById('scenario-followup-question').value.trim() || null,
                transferTarget: document.getElementById('scenario-followup-transfer-target').value.trim() || null,
                
                timedFollowUp: {
                    enabled: document.getElementById('scenario-timed-enabled').checked,
                    delaySeconds: parseInt(document.getElementById('scenario-timed-delay').value) || 50,
                    extensionSeconds: parseInt(document.getElementById('scenario-timed-extension').value) || 30,
                    messages: document.getElementById('scenario-timed-messages').value.split('\n').filter(m => m.trim())
                },
                
                silencePolicy: {
                    maxConsecutive: parseInt(document.getElementById('scenario-silence-max').value) || 2,
                    finalWarning: document.getElementById('scenario-silence-warning').value.trim() || 'Hello? Did I lose you?'
                },
                
                ttsOverride: {
                    pitch: document.getElementById('scenario-tts-pitch').value || undefined,
                    rate: document.getElementById('scenario-tts-rate').value || undefined,
                    volume: document.getElementById('scenario-tts-volume').value || undefined
                },
                
                preconditions: tryParseJSON(document.getElementById('scenario-preconditions').value),
                effects: tryParseJSON(document.getElementById('scenario-effects').value),
                
                actionHooks: document.getElementById('scenario-action-hooks').value.split(',').map(h => h.trim()).filter(Boolean),
                
                // üß† AI INTELLIGENCE FIELDS
                keywords: currentKeywords || [],
                negativeKeywords: currentNegativeKeywords || [],
                qnaPairs: currentQnAPairs || [],
                escalationFlags: currentEscalationFlags || [],
                examples: currentTrainingExamples || []
            };
            
            console.log('üì¶ [SAVE SCENARIO] Built data:', scenarioData);
            console.log('üß† [SAVE SCENARIO] Intelligence fields:', {
                keywords: currentKeywords.length,
                negativeKeywords: currentNegativeKeywords.length,
                qnaPairs: currentQnAPairs.length,
                escalationFlags: currentEscalationFlags.length,
                examples: currentTrainingExamples.length
            });
            
            try {
                let response;
                
                const token = getAuthToken();
                
                if (currentScenarioEditMode === 'add') {
                    // CREATE new scenario
                    const url = `/api/admin/global-instant-responses/${activeTemplateId}/categories/${currentScenarioData.categoryId}/scenarios`;
                    console.log(`üöÄ [CREATE] POST to: ${url}`);
                    
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify(scenarioData)
                    });
                    
                } else {
                    // UPDATE existing scenario
                    const url = `/api/admin/global-instant-responses/${activeTemplateId}/categories/${currentScenarioData.categoryId}/scenarios/${currentScenarioData.scenarioId}`;
                    console.log(`üîß [UPDATE] PATCH to: ${url}`);
                    
                    response = await fetch(url, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify(scenarioData)
                    });
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ [SAVE SCENARIO] Success:', result);
                
                showNotification(`‚úÖ Scenario "${name}" ${status === 'live' ? 'published' : 'saved as draft'} successfully!`, 'success');
                
                // Close modal
                closeScenarioModal();
                
                // Refresh the active template to show new/updated scenario
                await switchDashboardTemplate(activeTemplateId);
                
            } catch (error) {
                console.error('‚ùå [SAVE SCENARIO] Error:', error);
                showNotification('‚ùå Failed to save scenario: ' + error.message, 'error');
                
                // Report error to Notification Center
                if (window.errorReporters && window.errorReporters.scenarios) {
                    await errorReporters.scenarios.reportError({
                        error,
                        operation: currentScenarioEditMode === 'add' ? 'createScenario' : 'updateScenario',
                        userMessage: `Failed to ${currentScenarioEditMode === 'add' ? 'create' : 'update'} scenario "${name}". Changes were not saved.`,
                        retryFunction: () => saveScenario(status),
                        additionalContext: {
                            endpoint: currentScenarioEditMode === 'add' 
                                ? `/api/admin/global-instant-responses/${activeTemplateId}/categories/${currentScenarioData.categoryId}/scenarios`
                                : `/api/admin/global-instant-responses/${activeTemplateId}/categories/${currentScenarioData.categoryId}/scenarios/${currentScenarioData.scenarioId}`,
                            templateId: activeTemplateId,
                            categoryId: currentScenarioData.categoryId,
                            scenarioId: currentScenarioData.scenarioId,
                            scenarioName: name,
                            mode: currentScenarioEditMode,
                            status: status
                        }
                    });
                }
            }
        }

        /**
         * Parse dynamic variables from key=value format to object
         */
        function parseDynamicVariables(text) {
            const lines = text.split('\n').filter(l => l.trim() && l.includes('='));
            const obj = {};
            lines.forEach(line => {
                const [key, ...valueParts] = line.split('=');
                obj[key.trim()] = valueParts.join('=').trim();
            });
            return obj;
        }

        /**
         * Try to parse JSON, return null if invalid
         */
        function tryParseJSON(text) {
            if (!text || !text.trim()) return null;
            try {
                return JSON.parse(text);
            } catch (e) {
                console.warn('‚ö†Ô∏è Invalid JSON, returning null:', text);
                return null;
            }
        }

        // ============================================
        // POPULATE SCENARIO FORM (FOR EDIT MODE)
        // ============================================
        // RESTORED: EXACT original from commit 88a7ed8d
        

        // ‚ùå DELETED: closeAddScenarioModal (6537-6540) - closed deleted add-scenario-modal



        // ‚ùå DELETED: add-scenario-form addEventListener (lines 6542-6627)
        // Form doesn't exist - was part of deleted add-scenario-modal
        // ‚ùå DELETED: edit-scenario-form addEventListener (lines 6629-6710)
        // Form doesn't exist - was part of deleted edit-scenario-modal


        async function regenerateKeywordsQnA() {
            if (!confirm('This will regenerate keywords and Q&A pairs for this scenario based on current triggers.\n\nContinue?')) {
                return;
            }

            try {
                showNotification('‚è≥ Regenerating keywords & Q&A...', 'info');
                
                // Trigger enhancement for just this scenario
                // For now, we'll enhance the whole template (can optimize later)
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-instant-responses/${activeTemplate._id}/enhance`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                showNotification('‚úÖ Keywords & Q&A regenerated!', 'success');
                await fetchActiveTemplate();
            } catch (error) {
                console.error('‚ùå Error regenerating:', error);
                showNotification('‚ùå Failed to regenerate', 'error');
            }
        }

        async function deleteScenario(categoryIndex, scenarioIndex) {
            console.log(`üóëÔ∏è [DELETE SCENARIO] Deleting scenario at category ${categoryIndex}, scenario ${scenarioIndex}`);
            
            // Get category and scenario from activeTemplate
            const category = activeTemplate.categories[categoryIndex];
            const scenario = category.scenarios[scenarioIndex];
            
            if (!category || !scenario) {
                console.error('‚ùå Category or scenario not found');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete "${scenario.name}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const token = getAuthToken();
                const url = `/api/admin/global-instant-responses/${activeTemplateId}/categories/${category.id}/scenarios/${scenario.scenarioId || scenario.id}`;
                console.log(`üóëÔ∏è [DELETE] Sending DELETE to: ${url}`);
                
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ [DELETE SCENARIO] Success:', result);
                
                showNotification(`‚úÖ Scenario "${scenario.name}" deleted successfully!`, 'success');
                
                // Refresh the active template
                await switchDashboardTemplate(activeTemplateId);
                
            } catch (error) {
                console.error('‚ùå [DELETE SCENARIO] Error:', error);
                alert('Failed to delete scenario: ' + error.message);
                
                // Report error to Notification Center
                await errorReporters.scenarios.reportError({
                    error,
                    operation: 'deleteScenario',
                    userMessage: `Failed to delete scenario "${scenario.name}". Changes were not saved.`,
                    retryFunction: () => deleteScenario(categoryIndex, scenarioIndex),
                    additionalContext: {
                        endpoint: `/api/admin/global-instant-responses/${activeTemplateId}/categories/${category.id}/scenarios/${scenario.scenarioId || scenario.id}`,
                        templateId: activeTemplateId,
                        categoryId: category.id,
                        scenarioId: scenario.scenarioId || scenario.id,
                        scenarioName: scenario.name
                    }
                });
            }
        }

        async function openAddDirectoryModal() {
            if (!activeTemplate) {
                showNotification('No active template found. Please create or seed a template first.', 'error');
                return;
            }
            
            console.log('üìÅ [ADD CATEGORY] Opening modal for template:', {
                id: activeTemplate._id,
                name: activeTemplate.name,
                version: activeTemplate.version,
                currentCategories: activeTemplate.categories?.length || 0
            });
            
            // Reset form
            document.getElementById('category-form').reset();
            document.getElementById('category-id').value = '';
            document.getElementById('category-modal-title').textContent = 'Add Category';
            
            // REMOVED: Behavior dropdown population (scenarios control their own behavior)
            
            // Show modal
            const modal = document.getElementById('category-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'block';
        }

        function closeCategoryModal() {
            const modal = document.getElementById('category-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            
            // Clear category form data (fillers & synonyms)
            if (typeof clearCategoryForm === 'function') {
                clearCategoryForm();
            }
        }

        /**
         * Update synonym scroll hint visibility based on scroll position
         */
        function updateSynonymScrollHint() {
            const container = document.getElementById('template-synonyms-display');
            const hint = document.getElementById('synonym-scroll-hint');
            
            if (!container || !hint) return;
            
            // Show hint if there's more content to scroll
            const hasMoreContent = container.scrollHeight > container.clientHeight;
            const isAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 10;
            
            if (hasMoreContent && !isAtBottom) {
                hint.style.display = 'inline-block';
            } else {
                hint.style.display = 'none';
            }
        }

        // ============================================
        // CATEGORY FORM SUBMISSION
        // ============================================
        document.getElementById('category-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!activeTemplate) {
                showNotification('‚ùå No active template loaded', 'error');
                return;
            }

            try {
                console.log('üíæ [SAVE CATEGORY] Starting save to template:', {
                    templateId: activeTemplate._id,
                    templateName: activeTemplate.name,
                    templateVersion: activeTemplate.version
                });

                showNotification('‚è≥ Saving category...', 'info');

                const categoryId = document.getElementById('category-id').value;
                const isEditMode = categoryId !== '';

                // Get filler/synonym data from form
                const categoryFormData = getCategoryFormData();
                
                const categoryData = {
                    id: isEditMode ? categoryId : `cat-${Date.now()}`,
                    name: document.getElementById('category-name').value.trim(),
                    icon: document.getElementById('category-icon').value.trim() || 'üìÅ',
                    description: document.getElementById('category-description').value.trim(),
                    // REMOVED: behavior field (scenarios control their own behavior)
                    isActive: true, // FIX: Always active by default (no confusing checkbox)
                    additionalFillerWords: categoryFormData.additionalFillerWords, // NEW: Category-level fillers
                    synonymMap: categoryFormData.synonymMap, // NEW: Category-level synonyms
                    scenarios: [] // Start with empty scenarios, user will add via "Add Scenario" button
                };

                console.log('üìù [SAVE CATEGORY] Category data:', categoryData);
                console.log('üìù [SAVE CATEGORY] Fillers:', categoryFormData.additionalFillerWords.length, 'Synonyms:', Object.keys(categoryFormData.synonymMap).length);
                console.log('üìä [SAVE CATEGORY] Before save - Categories count:', activeTemplate.categories?.length || 0);

                if (isEditMode) {
                    // Update existing category
                    const categoryIndex = activeTemplate.categories.findIndex(c => c.id === categoryId);
                    if (categoryIndex >= 0) {
                        // Preserve existing scenarios
                        categoryData.scenarios = activeTemplate.categories[categoryIndex].scenarios || [];
                        activeTemplate.categories[categoryIndex] = categoryData;
                        console.log(`‚úèÔ∏è [SAVE CATEGORY] Updated category at index ${categoryIndex}`);
                    }
                } else {
                    // Add new category
                    activeTemplate.categories.push(categoryData);
                    console.log(`‚ûï [SAVE CATEGORY] Added new category. Total categories now: ${activeTemplate.categories.length}`);
                }

                // Save to backend
                const token = getAuthToken();
                const apiUrl = `/api/admin/global-instant-responses/${activeTemplate._id}`;
                console.log(`üöÄ [SAVE CATEGORY] Sending PATCH to: ${apiUrl}`);
                
                const response = await fetch(apiUrl, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        categories: activeTemplate.categories
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ [SAVE CATEGORY] Backend confirmed save:', result.data);
                    showNotification(`‚úÖ Category ${isEditMode ? 'updated' : 'created'} successfully!`, 'success');
                    closeCategoryModal();
                    
                    // Refresh the current template (not the default one)
                    console.log(`üîÑ [SAVE CATEGORY] Refreshing template: ${activeTemplate._id}`);
                    await switchDashboardTemplate(activeTemplate._id);
                } else {
                    console.error('‚ùå [SAVE CATEGORY] Backend error:', result.message);
                    showNotification(`‚ùå Failed to save: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå [SAVE CATEGORY] Exception:', error);
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        });

        // ============================================
        // NOTIFICATIONS
        // ============================================
        function showNotification(message, type = 'info') {
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg z-50 flex items-center gap-3 animate-slide-in`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ============================================
        // TAB SWITCHING
        // ============================================
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            // Update tab button styles
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-500', 'border-transparent');
            document.getElementById(`tab-${tabName}`).classList.add('text-blue-600', 'border-blue-600');
            
            // Load behaviors if switching to behaviors tab
            if (tabName === 'behaviors') {
                renderBehaviors();
            }
            
            // Load action hooks if switching to action hooks tab
            if (tabName === 'action-hooks') {
                // Default to "hooks" sub-tab when entering Action Hooks
                switchActionHooksSubTab('hooks');
            }
            
            // Load filler words if switching to settings tab
            if (tabName === 'settings') {
                loadFillerWords();
            }
        }

        // ============================================================================
        // OVERVIEW SUB-TAB SWITCHING
        // ============================================================================
        function switchOverviewSubTab(subTabName) {
            console.log(`üîµ [OVERVIEW] Switching to sub-tab: ${subTabName}`);
            
            // Hide all overview sub-tab contents
            document.querySelectorAll('.overview-subtab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected sub-tab content
            document.getElementById(`overview-${subTabName}-content`).classList.remove('hidden');
            
            // Update sub-tab button styles (new compact design)
            document.querySelectorAll('[id^="overview-subtab-"]').forEach(btn => {
                btn.classList.remove('text-blue-700', 'border-blue-600', 'bg-white');
                btn.classList.add('text-gray-600', 'border-transparent', 'hover:bg-gray-100');
            });
            const activeBtn = document.getElementById(`overview-subtab-${subTabName}`);
            activeBtn.classList.remove('text-gray-600', 'border-transparent', 'hover:bg-gray-100');
            activeBtn.classList.add('text-blue-700', 'border-blue-600', 'bg-white');
            
            // Load content for specific sub-tabs
            if (subTabName === 'templates') {
                renderTemplatesTable();
            } else if (subTabName === 'dashboard') {
                // Load Twilio test config when viewing dashboard
                loadTwilioTestConfig();
            } else if (subTabName === 'llm-learning') {
                // V1 console removed - redirect to V2 standalone page
                console.log('üß† [LLM LEARNING] Redirecting to V2 Console...');
                window.location.href = '/admin/llm-learning-v2';
            } else if (subTabName === 'ai-gateway') {
                // Initialize AI Gateway Manager
                if (window.aiGatewayManager && typeof window.aiGatewayManager.initialize === 'function') {
                    console.log('üöÄ [AI GATEWAY] Initializing AI Gateway Manager...');
                    window.aiGatewayManager.initialize();
                    window.aiGatewayManager.loadHealthLogs(); // Load health check logs
                } else {
                    console.warn('‚ö†Ô∏è [AI GATEWAY] AIGatewayManager not found');
                }
            }
        }

        // ============================================================================
        // TEMPLATES TABLE RENDERING
        // ============================================================================
        async function renderTemplatesTable() {
            console.log('üîµ [TEMPLATES] Rendering templates table...');
            
            const container = document.getElementById('templates-table-container');
            container.innerHTML = '<div class="p-8 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading templates...</div>';
            
            try {
                const token = getAuthToken();
                // Add cache-busting timestamp to force fresh data
                const cacheBuster = `?_=${Date.now()}`;
                const response = await fetch(`/api/admin/global-instant-responses${cacheBuster}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });
                
                const result = await response.json();
                console.log('üîç [TEMPLATES] API Response:', result.data.map(t => ({
                    name: t.name,
                    isDefault: t.isDefaultTemplate,
                    isPublished: t.isPublished
                })));
                
                if (result.success && result.data && result.data.length > 0) {
                    const templates = result.data;
                    console.log('üé® [TEMPLATES] Building table with', templates.length, 'templates');
                    
                    // Build table structure
                    const table = document.createElement('table');
                    table.className = 'w-full';
                    
                    // Table header
                    table.innerHTML = `
                        <thead class="bg-gray-50 border-b-2 border-gray-200">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Template Name</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Industry</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Version</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Source</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Categories</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-gray-700 uppercase tracking-wider" style="min-width: 320px;">Actions</th>
                            </tr>
                        </thead>
                    `;
                    
                    // Table body
                    const tbody = document.createElement('tbody');
                    tbody.className = 'divide-y divide-gray-200';
                    
                    templates.forEach(template => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        
                        // Build SOURCE cell content
                        let sourceHtml = '';
                        if (template.lineage && template.lineage.isClone) {
                            const clonedDate = new Date(template.lineage.clonedAt).toLocaleDateString();
                            sourceHtml = `
                                <div class="text-xs">
                                    <div class="flex items-center gap-1 text-purple-700 font-semibold">
                                        <i class="fas fa-code-branch"></i>
                                        <span>Cloned from</span>
                                    </div>
                                    <div class="text-gray-600 mt-1">${template.lineage.clonedFromName}</div>
                                    <div class="text-gray-500">${template.lineage.clonedFromVersion}</div>
                                    <div class="text-gray-400 mt-1">${clonedDate}</div>
                                </div>
                            `;
                        } else {
                            sourceHtml = `
                                <div class="flex items-center gap-1 text-yellow-600 font-semibold text-xs">
                                    <i class="fas fa-star"></i>
                                    <span>Original</span>
                                </div>
                            `;
                        }
                        
                        row.innerHTML = `
                            <td class="px-6 py-4">
                                <div class="font-semibold text-gray-900">${template.name || 'Untitled'}</div>
                                <div class="text-sm text-gray-500">${template.description || 'No description'}</div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${getIndustryColor(template.templateType || 'universal')}">
                                    ${template.industryLabel || template.templateType || 'Universal'}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-700">${template.version}</td>
                            <td class="px-6 py-4">
                                ${sourceHtml}
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-700">${template.stats?.totalCategories || template.categories?.length || 0}</td>
                            <td class="px-6 py-4">
                                <div class="flex flex-col gap-1">
                                    ${template.isDefaultTemplate ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded">‚úì Default</span>' : ''}
                                    ${template.isPublished ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded">üì¢ Published</span>' : '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs font-semibold rounded">Draft</span>'}
                                </div>
                            </td>
                        `;
                        
                        // Actions cell - CREATE BUTTONS WITH DOM API
                        const actionsCell = document.createElement('td');
                        actionsCell.className = 'px-6 py-4 text-right';
                        
                        const actionsDiv = document.createElement('div');
                        actionsDiv.style.cssText = 'display: flex; justify-content: flex-end; gap: 0.5rem; flex-wrap: nowrap; min-width: 300px;';
                        
                        // View Button
                        const viewBtn = document.createElement('button');
                        viewBtn.style.cssText = 'background-color: #2563eb; color: white; padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.875rem; border: none; cursor: pointer; flex-shrink: 0; display: inline-block;';
                        viewBtn.title = 'View';
                        viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                        viewBtn.onclick = () => viewTemplate(template._id);
                        
                        
                        // Compare Button (only for cloned templates)
                        let compareBtn = null;
                        if (template.lineage && template.lineage.isClone) {
                            compareBtn = document.createElement('button');
                            compareBtn.style.cssText = 'background-color: #9333ea; color: white; padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.875rem; border: none; cursor: pointer; flex-shrink: 0; display: inline-block;';
                            compareBtn.title = 'Compare with parent template';
                            compareBtn.innerHTML = '<i class="fas fa-code-compare"></i>';
                            compareBtn.onclick = () => compareWithParent(template._id, template.name);
                        }
                        
                        // Publish/Unpublish Toggle - Control template availability to companies
                        const publishBtn = document.createElement('button');
                        console.log(`üîç [PUBLISH TOGGLE] Template "${template.name}" isPublished:`, template.isPublished);
                        
                        if (template.isPublished) {
                            // IS PUBLISHED - Show blue button to unpublish
                            publishBtn.style.cssText = 'background-color: #2563eb; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 700; font-size: 0.75rem; border: 2px solid #2563eb; cursor: pointer; flex-shrink: 0; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s;';
                            publishBtn.title = 'Click to unpublish (hide from companies)';
                            publishBtn.innerHTML = '<i class="fas fa-broadcast-tower"></i> PUBLISHED';
                            publishBtn.onclick = () => togglePublishStatus(template._id, template.name, true);
                            // Hover effect
                            publishBtn.onmouseover = () => {
                                publishBtn.style.backgroundColor = '#dc2626';
                                publishBtn.style.borderColor = '#dc2626';
                                publishBtn.innerHTML = '<i class="fas fa-eye-slash"></i> UNPUBLISH';
                            };
                            publishBtn.onmouseout = () => {
                                publishBtn.style.backgroundColor = '#2563eb';
                                publishBtn.style.borderColor = '#2563eb';
                                publishBtn.innerHTML = '<i class="fas fa-broadcast-tower"></i> PUBLISHED';
                            };
                            console.log(`  ‚úÖ Rendering BLUE PUBLISHED button for: ${template.name}`);
                        } else {
                            // NOT PUBLISHED - Show gray button to publish
                            publishBtn.style.cssText = 'background-color: #f3f4f6; color: #6b7280; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem; border: 2px solid #e5e7eb; cursor: pointer; flex-shrink: 0; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s;';
                            publishBtn.title = 'Click to publish (make available to companies)';
                            publishBtn.innerHTML = '<i class="fas fa-upload"></i> PUBLISH';
                            publishBtn.onclick = () => togglePublishStatus(template._id, template.name, false);
                            // Hover effect
                            publishBtn.onmouseover = () => {
                                publishBtn.style.backgroundColor = '#2563eb';
                                publishBtn.style.color = 'white';
                                publishBtn.style.borderColor = '#2563eb';
                                publishBtn.innerHTML = '<i class="fas fa-rocket"></i> PUBLISH';
                            };
                            publishBtn.onmouseout = () => {
                                publishBtn.style.backgroundColor = '#f3f4f6';
                                publishBtn.style.color = '#6b7280';
                                publishBtn.style.borderColor = '#e5e7eb';
                                publishBtn.innerHTML = '<i class="fas fa-upload"></i> PUBLISH';
                            };
                            console.log(`  ‚óã Rendering GRAY DRAFT button for: ${template.name}`);
                        }
                        
                        // Set Default Toggle - Radio button style for clear ON/OFF state
                        const defaultBtn = document.createElement('button');
                        console.log(`üîç [TOGGLE] Template "${template.name}" isDefaultTemplate:`, template.isDefaultTemplate);
                        
                        if (template.isDefaultTemplate) {
                            // IS DEFAULT - Show green ON state (disabled)
                            defaultBtn.style.cssText = 'background-color: #16a34a; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 700; font-size: 0.75rem; border: 2px solid #16a34a; cursor: not-allowed; flex-shrink: 0; display: inline-flex; align-items: center; gap: 0.5rem;';
                            defaultBtn.title = 'This is the current default template';
                            defaultBtn.innerHTML = '<i class="fas fa-check-circle"></i> DEFAULT';
                            defaultBtn.disabled = true;
                            console.log(`  ‚úÖ Rendering GREEN DEFAULT for: ${template.name}`);
                        } else {
                            // NOT DEFAULT - Show gray OFF state (clickable)
                            defaultBtn.style.cssText = 'background-color: #f3f4f6; color: #6b7280; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem; border: 2px solid #e5e7eb; cursor: pointer; flex-shrink: 0; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s;';
                            defaultBtn.title = 'Click to set as default template';
                            defaultBtn.innerHTML = '<i class="far fa-circle"></i> SET DEFAULT';
                            defaultBtn.onclick = () => setAsDefault(template._id, template.name);
                            // Hover effect
                            defaultBtn.onmouseover = () => {
                                defaultBtn.style.backgroundColor = '#9333ea';
                                defaultBtn.style.color = 'white';
                                defaultBtn.style.borderColor = '#9333ea';
                            };
                            defaultBtn.onmouseout = () => {
                                defaultBtn.style.backgroundColor = '#f3f4f6';
                                defaultBtn.style.color = '#6b7280';
                                defaultBtn.style.borderColor = '#e5e7eb';
                            };
                            console.log(`  ‚óã Rendering GRAY OFF for: ${template.name}`);
                        }
                        
                        // Delete Button
                        const deleteBtn = document.createElement('button');
                        deleteBtn.style.cssText = 'background-color: #dc2626; color: white; padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.875rem; border: none; cursor: pointer; flex-shrink: 0; display: inline-block;';
                        deleteBtn.title = 'Delete';
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        deleteBtn.onclick = () => deleteTemplate(template._id);
                        
                        const buttonCount = compareBtn ? 6 : 5;
                        console.log(`üîò [BUTTONS] Created ${buttonCount} buttons for template: ${template.name}`);
                        
                        actionsDiv.appendChild(viewBtn);
                        if (compareBtn) actionsDiv.appendChild(compareBtn);
                        actionsDiv.appendChild(publishBtn);
                        actionsDiv.appendChild(defaultBtn);
                        actionsDiv.appendChild(deleteBtn);
                        
                        actionsCell.appendChild(actionsDiv);
                        row.appendChild(actionsCell);
                        tbody.appendChild(row);
                    });
                    
                    table.appendChild(tbody);
                    container.innerHTML = '';
                    container.appendChild(table);
                    
                    console.log(`‚úÖ Rendered ${templates.length} templates with DOM API`);
                } else {
                    container.innerHTML = `
                        <div class="p-12 text-center">
                            <i class="fas fa-inbox text-gray-300 text-6xl mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700 mb-2">No Templates Found</h3>
                            <p class="text-gray-500 mb-6">Create your first AI brain template to get started</p>
                            <button onclick="openCreateTemplateModal()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors">
                                <i class="fas fa-plus-circle mr-2"></i>
                                Create First Template
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Error loading templates:', error);
                container.innerHTML = `
                    <div class="p-12 text-center text-red-600">
                        <i class="fas fa-exclamation-triangle text-5xl mb-4"></i>
                        <p class="font-semibold">Error loading templates</p>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        function getIndustryColor(type) {
            const colors = {
                'universal': 'bg-blue-100 text-blue-800',
                'healthcare': 'bg-red-100 text-red-800',
                'homeservices': 'bg-orange-100 text-orange-800',
                'retail': 'bg-green-100 text-green-800',
                'professional': 'bg-purple-100 text-purple-800',
                'custom': 'bg-gray-100 text-gray-800'
            };
            return colors[type] || colors['universal'];
        }

        async function viewTemplate(templateId) {
            console.log('üëÅÔ∏è [VIEW TEMPLATE] Loading template:', templateId);
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-instant-responses/${templateId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    activeTemplate = result.data;
                    activeTemplateId = result.data._id;
                    window.activeTemplateId = result.data._id; // Make available to template-settings-manager.js
                    
                    // Switch to Overview Dashboard
                    switchTab('overview');
                    switchOverviewSubTab('dashboard');
                    // Dashboard content is static HTML, no render function needed
                    
                    showNotification(`‚úÖ Loaded: ${result.data.name}`, 'success');
                } else {
                    showNotification('‚ùå Failed to load template', 'error');
                }
            } catch (error) {
                console.error('‚ùå [VIEW TEMPLATE] Error:', error);
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        }

        /**
         * Toggle publish/unpublish status for a template
         * Published templates are available to companies in AiCore Templates tab
         */
        async function togglePublishStatus(templateId, templateName, currentlyPublished) {
            try {
                const newStatus = !currentlyPublished;
                const action = newStatus ? 'Publish' : 'Unpublish';
                const actionPast = newStatus ? 'Published' : 'Unpublished';
                
                // Confirmation message
                const confirmMessage = newStatus
                    ? `<div style="text-align: left;">
                        <div style="margin-bottom: 16px;">
                            <strong style="color: #2563eb;">üì¢ Publish Template</strong><br>
                            <span style="font-size: 15px;">${templateName}</span>
                        </div>
                        <div style="margin-top: 20px; padding: 12px; background: #dbeafe; border-left: 4px solid #2563eb; border-radius: 4px;">
                            <strong>‚úÖ Effect:</strong> This template will become available to companies in their <strong>AiCore Templates</strong> tab.
                        </div>
                    </div>`
                    : `<div style="text-align: left;">
                        <div style="margin-bottom: 16px;">
                            <strong style="color: #dc2626;">üîí Unpublish Template</strong><br>
                            <span style="font-size: 15px;">${templateName}</span>
                        </div>
                        <div style="margin-top: 20px; padding: 12px; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 4px;">
                            <strong>‚ö†Ô∏è Warning:</strong> This template will be <strong>hidden</strong> from companies. Existing companies that already activated it will keep it.
                        </div>
                    </div>`;
                
                // Show confirmation
                const confirmed = await showCustomConfirm(`${action} Template?`, confirmMessage);
                if (!confirmed) {
                    return;
                }
                
                // Make API call to toggle publish status
                showNotification(`‚è≥ ${action}ing template...`, 'info');
                
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-instant-responses/${templateId}/publish`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isPublished: newStatus })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ [PUBLISH TOGGLE] API call succeeded for ${templateName}`);
                    showNotification(`‚úÖ "${templateName}" ${actionPast}!`, 'success');
                    
                    // Refresh table to show updated status
                    setTimeout(async () => {
                        console.log('üîÑ [PUBLISH TOGGLE] Refreshing template table...');
                        await renderTemplatesTable();
                        console.log('‚úÖ [PUBLISH TOGGLE] Table refreshed!');
                    }, 300);
                } else {
                    showNotification(`‚ùå Failed: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå Error toggling publish status:', error);
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        async function setAsDefault(templateId, templateName) {
            try {
                // First, fetch all templates to find current default
                const token = getAuthToken();
                const response = await fetch('/api/admin/global-instant-responses', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                const currentDefault = result.data.find(t => t.isDefaultTemplate);
                const newTemplate = result.data.find(t => t._id === templateId);
                
                // Build dynamic confirmation message with proper HTML formatting
                let confirmMessage = '';
                if (currentDefault) {
                    confirmMessage = `
                        <div style="text-align: left;">
                            <div style="margin-bottom: 16px;">
                                <strong style="color: #dc2626;">Current Default:</strong><br>
                                <span style="font-size: 15px;">${currentDefault.name} (${currentDefault.version})</span>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <strong style="color: #16a34a;">New Default:</strong><br>
                                <span style="font-size: 15px;">${newTemplate.name} (${newTemplate.version})</span>
                            </div>
                            <div style="margin-top: 20px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
                                <strong>üì¢ Note:</strong> All new companies will inherit <strong>"${newTemplate.name}"</strong> as their starting AI Brain.
                            </div>
                        </div>
                    `;
                } else {
                    confirmMessage = `
                        <div style="text-align: left;">
                            <div style="margin-bottom: 16px;">
                                <strong style="color: #16a34a;">Set as Default:</strong><br>
                                <span style="font-size: 15px;">${newTemplate.name} (${newTemplate.version})</span>
                            </div>
                            <div style="margin-top: 20px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
                                <strong>üì¢ Note:</strong> All new companies will inherit this as their starting AI Brain.
                            </div>
                        </div>
                    `;
                }
                
                // Show custom confirmation modal
                const confirmed = await showCustomConfirm('Set Default Template?', confirmMessage);
                if (!confirmed) {
                    return;
                }
                
                // Make API call to set as default
                showNotification('‚è≥ Setting default template...', 'info');
                
                const setDefaultResponse = await fetch(`/api/admin/global-instant-responses/${templateId}/set-default`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const setDefaultResult = await setDefaultResponse.json();
                
                if (setDefaultResult.success) {
                    console.log('‚úÖ [SET DEFAULT] API call succeeded, now refreshing table...');
                    showNotification(`‚úÖ "${newTemplate.name}" is now the default template!`, 'success');
                    
                    // Force table refresh with a slight delay to ensure state is updated
                    setTimeout(async () => {
                        console.log('üîÑ [SET DEFAULT] Calling renderTemplatesTable()...');
                        await renderTemplatesTable();
                        console.log('‚úÖ [SET DEFAULT] Table refreshed!');
                    }, 300);
                } else {
                    showNotification(`‚ùå Failed: ${setDefaultResult.message}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå Error setting default:', error);
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        }

        // Custom confirmation modal helper
        function showCustomConfirm(title, message) {
            return new Promise((resolve) => {
                // Create modal backdrop
                const backdrop = document.createElement('div');
                backdrop.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
                
                // Create modal
                const modal = document.createElement('div');
                modal.style.cssText = 'background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 500px; width: 90%; overflow: hidden;';
                
                modal.innerHTML = `
                    <div style="background: linear-gradient(to right, #9333ea, #7c3aed); padding: 20px; color: white;">
                        <h2 style="margin: 0; font-size: 20px; font-weight: 700;">${title}</h2>
                    </div>
                    <div style="padding: 24px; max-height: 400px; overflow-y: auto;">
                        ${message}
                    </div>
                    <div style="background: #f9fafb; padding: 16px; display: flex; justify-content: flex-end; gap: 12px; border-top: 1px solid #e5e7eb;">
                        <button id="custom-confirm-cancel" style="background: #6b7280; color: white; padding: 10px 24px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer;">
                            <i class="fas fa-times-circle"></i> Cancel
                        </button>
                        <button id="custom-confirm-ok" style="background: #9333ea; color: white; padding: 10px 24px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <i class="fas fa-check-circle"></i> Confirm
                        </button>
                    </div>
                `;
                
                backdrop.appendChild(modal);
                document.body.appendChild(backdrop);
                
                // Event handlers
                const handleCancel = () => {
                    document.body.removeChild(backdrop);
                    resolve(false);
                };
                
                const handleOk = () => {
                    document.body.removeChild(backdrop);
                    resolve(true);
                };
                
                document.getElementById('custom-confirm-cancel').onclick = handleCancel;
                document.getElementById('custom-confirm-ok').onclick = handleOk;
                backdrop.onclick = (e) => {
                    if (e.target === backdrop) handleCancel();
                };
            });
        }

        async function deleteTemplate(templateId) {
            if (!confirm('‚ö†Ô∏è Delete this template?\n\nThis cannot be undone!')) {
                return;
            }
            
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-instant-responses/${templateId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ Template deleted successfully', 'success');
                    renderTemplatesTable(); // Refresh the table
                } else {
                    showNotification('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting template:', error);
                showNotification('‚ùå Error: ' + error.message, 'error');
                
                // Report error to Notification Center
                await errorReporters.templates.reportError({
                    error,
                    operation: 'deleteTemplate',
                    userMessage: 'Failed to delete AI template. Template still exists.',
                    retryFunction: () => deleteTemplate(templateId),
                    additionalContext: {
                        endpoint: `/api/admin/global-instant-responses/${templateId}`,
                        templateId
                    }
                });
            }
        }

        // ============================================================================
        // üå≥ LINEAGE & COMPARISON FUNCTIONS
        // ============================================================================

        async function compareWithParent(templateId, templateName) {
            try {
                console.log(`üîç [COMPARE] Fetching comparison for template: ${templateName}`);
                const token = getAuthToken();
                
                const response = await fetch(`/api/admin/global-instant-responses/${templateId}/compare-with-parent`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (!result.success || !result.hasParent) {
                    showNotification('‚ùå Cannot compare: ' + (result.message || 'No parent template'), 'error');
                    return;
                }
                
                console.log(`üìä [COMPARE] Comparison results:`, result.comparison.summary);
                
                // Render full comparison view
                renderComparisonView(templateId, templateName, result);
                
            } catch (error) {
                console.error('‚ùå [COMPARE] Error:', error);
                showNotification('‚ùå Error comparing templates: ' + error.message, 'error');
            }
        }

        // Global state for comparison
        let currentComparisonState = {
            templateId: null,
            templateName: null,
            parentName: null,
            details: null,
            selectedToSync: new Set(),
            conflictResolutions: new Map()
        };

        function renderComparisonView(templateId, templateName, comparisonData) {
            console.log('üé® [COMPARE] Rendering full comparison view');
            
            // Store state globally
            currentComparisonState.templateId = templateId;
            currentComparisonState.templateName = templateName;
            currentComparisonState.parentName = comparisonData.parentName;
            currentComparisonState.details = comparisonData.comparison.details;
            currentComparisonState.selectedToSync = new Set();
            currentComparisonState.conflictResolutions = new Map();
            
            // Hide templates table, show comparison view
            document.getElementById('templates-table-container').classList.add('hidden');
            document.getElementById('comparison-view-container').classList.remove('hidden');
            
            const container = document.getElementById('comparison-view-container');
            const summary = comparisonData.comparison.summary;
            const details = comparisonData.comparison.details;
            
            // Count actionable items (available + conflicts)
            const actionableCount = summary.availableToSync + summary.modified;
            
            container.innerHTML = `
                <!-- Header with Back Button -->
                <div class="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-6 rounded-t-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <button onclick="backToTemplatesList()" 
                                    style="background-color: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s;">
                                <i class="fas fa-arrow-left mr-2"></i>
                                Back to Templates
                            </button>
                            <div>
                                <h2 class="text-3xl font-bold">üîç Template Comparison</h2>
                                <p class="text-purple-100 mt-1">${templateName} vs ${comparisonData.parentName}</p>
                            </div>
                        </div>
                        ${actionableCount > 0 ? `
                        <div class="text-right">
                            <div class="text-sm text-purple-100">Actionable Items</div>
                            <div class="text-3xl font-bold">${actionableCount}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-5 gap-4 p-6 bg-gray-50">
                    <div class="bg-white p-4 rounded-lg border-2 border-gray-200 text-center">
                        <div class="text-3xl font-bold text-blue-600">${summary.total}</div>
                        <div class="text-sm text-gray-600 mt-1">Total Scenarios</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-2 border-green-200 text-center">
                        <div class="text-3xl font-bold text-green-600">${summary.unchanged}</div>
                        <div class="text-sm text-gray-600 mt-1">‚úÖ Unchanged</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-2 border-purple-200 text-center">
                        <div class="text-3xl font-bold text-purple-600">${summary.custom}</div>
                        <div class="text-sm text-gray-600 mt-1">‚ûï Custom</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-2 border-blue-200 text-center">
                        <div class="text-3xl font-bold text-blue-600">${summary.availableToSync}</div>
                        <div class="text-sm text-gray-600 mt-1">üì• Available</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-2 border-yellow-200 text-center">
                        <div class="text-3xl font-bold text-yellow-600">${summary.modified}</div>
                        <div class="text-sm text-gray-600 mt-1">‚úèÔ∏è Modified</div>
                    </div>
                </div>

                <!-- Sync Instructions -->
                ${actionableCount > 0 ? `
                <div class="mx-6 mb-4 bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-info-circle text-blue-600 text-xl mt-0.5"></i>
                        <div class="flex-1">
                            <div class="font-bold text-blue-900 mb-1">How to Sync</div>
                            <div class="text-sm text-blue-800">
                                ‚Ä¢ <strong>üì• Available scenarios</strong>: Check the box to import from parent template<br>
                                ‚Ä¢ <strong>‚úèÔ∏è Modified scenarios</strong>: Click to resolve conflicts (choose parent version or keep yours)
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Detailed Comparison -->
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900">üìã Detailed Comparison</h3>
                        ${actionableCount > 0 ? `
                        <div class="text-sm text-gray-600">
                            <span id="selected-count" class="font-bold text-purple-600">0</span> selected
                        </div>
                        ` : ''}
                    </div>
                    
                    ${renderComparisonDetails(details)}
                </div>

                <!-- Action Buttons -->
                <div class="bg-gray-50 p-6 border-t-2 border-gray-200 flex justify-between items-center">
                    <button onclick="backToTemplatesList()" 
                            style="background-color: #6b7280; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer;">
                        <i class="fas fa-times-circle mr-2"></i>
                        Cancel
                    </button>
                    ${actionableCount > 0 ? `
                    <div class="flex gap-3">
                        <button onclick="selectAllAvailable()" 
                                style="background-color: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer;">
                            <i class="fas fa-check-double mr-2"></i>
                            Select All Available
                        </button>
                        <button id="sync-btn" onclick="executeSyncSelected()" 
                                disabled
                                style="background-color: #d1d5db; color: #9ca3af; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: not-allowed; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <i class="fas fa-sync mr-2"></i>
                            Sync Selected (0)
                        </button>
                    </div>
                    ` : `
                    <div class="text-green-600 font-semibold">
                        <i class="fas fa-check-circle mr-2"></i>
                        All scenarios are in sync!
                    </div>
                    `}
                </div>
            `;
        }

        function renderComparisonDetails(details) {
            let html = '';
            
            // Group scenarios by category
            const categoriesMap = new Map();
            
            // Add all scenarios to their categories
            [...details.unchanged, ...details.added, ...details.removed, ...details.modified, ...details.conflicts].forEach(item => {
                if (!categoriesMap.has(item.categoryId)) {
                    categoriesMap.set(item.categoryId, {
                        id: item.categoryId,
                        name: item.categoryName,
                        scenarios: []
                    });
                }
                categoriesMap.get(item.categoryId).scenarios.push(item);
            });
            
            // Render each category
            categoriesMap.forEach((category, categoryId) => {
                html += `
                    <div class="mb-4 bg-white rounded-lg border-2 border-gray-200 overflow-hidden">
                        <div class="bg-gray-100 px-6 py-3 font-bold text-gray-900 border-b-2 border-gray-200">
                            üìÅ ${category.name} (${category.scenarios.length} scenarios)
                        </div>
                        <div class="p-4">
                            ${category.scenarios.map(scenario => renderScenarioRow(scenario, details)).join('')}
                        </div>
                    </div>
                `;
            });
            
            return html || '<div class="text-center text-gray-500 py-8">No scenarios to compare</div>';
        }

        function renderScenarioRow(scenario, details) {
            let statusBadge = '';
            let statusColor = '';
            let actionButton = '';
            
            // Determine status and action
            if (details.unchanged.includes(scenario)) {
                statusBadge = '‚úÖ Unchanged';
                statusColor = 'bg-green-100 text-green-800';
            } else if (details.added.includes(scenario)) {
                statusBadge = '‚ûï Custom Addition';
                statusColor = 'bg-purple-100 text-purple-800';
            } else if (details.removed.includes(scenario)) {
                statusBadge = 'üì• Available to Sync';
                statusColor = 'bg-blue-100 text-blue-800';
                // Add checkbox for available scenarios
                actionButton = `
                    <label class="flex items-center gap-2 cursor-pointer mr-3">
                        <input type="checkbox" 
                               class="sync-checkbox w-5 h-5 text-purple-600 rounded border-gray-300 focus:ring-purple-500"
                               data-scenario-id="${scenario.scenarioId}"
                               data-category-id="${scenario.categoryId}"
                               onchange="toggleScenarioSelection('${scenario.scenarioId}', '${scenario.categoryId}', this.checked)">
                        <span class="text-sm font-medium text-gray-700">Sync</span>
                    </label>
                `;
            } else if (details.modified.includes(scenario)) {
                statusBadge = '‚úèÔ∏è Modified';
                statusColor = 'bg-yellow-100 text-yellow-800';
                // Add conflict resolution button
                actionButton = `
                    <button onclick="resolveConflict('${scenario.scenarioId}', '${scenario.categoryId}')"
                            style="background-color: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.75rem; border: none; cursor: pointer; margin-right: 0.75rem;">
                        <i class="fas fa-code-merge mr-1"></i>
                        Resolve
                    </button>
                `;
            } else if (details.conflicts.includes(scenario)) {
                statusBadge = '‚ö†Ô∏è CONFLICT';
                statusColor = 'bg-red-100 text-red-800';
                // Add conflict resolution button
                actionButton = `
                    <button onclick="resolveConflict('${scenario.scenarioId}', '${scenario.categoryId}')"
                            style="background-color: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.75rem; border: none; cursor: pointer; margin-right: 0.75rem;">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        Resolve
                    </button>
                `;
            }
            
            return `
                <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded border-b border-gray-100 last:border-0">
                    <div class="flex-1">
                        <div class="font-semibold text-gray-900">${scenario.scenarioName}</div>
                        <div class="text-sm text-gray-500">ID: ${scenario.scenarioId}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        ${actionButton}
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColor}">
                            ${statusBadge}
                        </span>
                    </div>
                </div>
            `;
        }

        function backToTemplatesList() {
            console.log('‚¨ÖÔ∏è [COMPARE] Returning to templates list');
            document.getElementById('comparison-view-container').classList.add('hidden');
            document.getElementById('templates-table-container').classList.remove('hidden');
        }

        function toggleScenarioSelection(scenarioId, categoryId, isChecked) {
            const key = `${categoryId}::${scenarioId}`;
            
            if (isChecked) {
                currentComparisonState.selectedToSync.add(key);
                console.log(`‚úÖ [SYNC] Selected: ${scenarioId}`);
            } else {
                currentComparisonState.selectedToSync.delete(key);
                console.log(`‚ùå [SYNC] Deselected: ${scenarioId}`);
            }
            
            updateSyncButtonState();
        }

        function selectAllAvailable() {
            console.log('‚úÖ [SYNC] Selecting all available scenarios');
            
            // Find all checkboxes and check them
            const checkboxes = document.querySelectorAll('.sync-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const scenarioId = checkbox.dataset.scenarioId;
                const categoryId = checkbox.dataset.categoryId;
                currentComparisonState.selectedToSync.add(`${categoryId}::${scenarioId}`);
            });
            
            updateSyncButtonState();
            showNotification('‚úÖ All available scenarios selected', 'success');
        }

        function updateSyncButtonState() {
            const selectedCount = currentComparisonState.selectedToSync.size;
            const countDisplay = document.getElementById('selected-count');
            const syncBtn = document.getElementById('sync-btn');
            
            if (countDisplay) {
                countDisplay.textContent = selectedCount;
            }
            
            if (syncBtn) {
                if (selectedCount > 0) {
                    // Enable button
                    syncBtn.disabled = false;
                    syncBtn.style.backgroundColor = '#9333ea';
                    syncBtn.style.color = 'white';
                    syncBtn.style.cursor = 'pointer';
                    syncBtn.innerHTML = `<i class="fas fa-sync mr-2"></i>Sync Selected (${selectedCount})`;
                } else {
                    // Disable button
                    syncBtn.disabled = true;
                    syncBtn.style.backgroundColor = '#d1d5db';
                    syncBtn.style.color = '#9ca3af';
                    syncBtn.style.cursor = 'not-allowed';
                    syncBtn.innerHTML = `<i class="fas fa-sync mr-2"></i>Sync Selected (0)`;
                }
            }
        }

        async function executeSyncSelected() {
            const selectedCount = currentComparisonState.selectedToSync.size;
            
            if (selectedCount === 0) {
                showNotification('‚ö†Ô∏è No scenarios selected', 'warning');
                return;
            }
            
            const confirmMsg = `üîÑ Sync ${selectedCount} scenario${selectedCount > 1 ? 's' : ''} from "${currentComparisonState.parentName}" to "${currentComparisonState.templateName}"?\n\nThis will add these scenarios to your template.`;
            
            if (!confirm(confirmMsg)) {
                console.log('‚ùå [SYNC] User cancelled sync');
                return;
            }
            
            console.log(`üöÄ [SYNC] Executing sync for ${selectedCount} scenarios`);
            
            try {
                const token = getAuthToken();
                
                // Prepare sync payload
                const syncPayload = {
                    scenariosToSync: Array.from(currentComparisonState.selectedToSync).map(key => {
                        const [categoryId, scenarioId] = key.split('::');
                        return { categoryId, scenarioId };
                    })
                };
                
                console.log('üì§ [SYNC] Payload:', syncPayload);
                
                const response = await fetch(`/api/admin/global-instant-responses/${currentComparisonState.templateId}/sync-from-parent`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(syncPayload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ Successfully synced ${result.syncedCount} scenario${result.syncedCount > 1 ? 's' : ''}!`, 'success');
                    
                    // Refresh comparison view
                    setTimeout(() => {
                        compareWithParent(currentComparisonState.templateId, currentComparisonState.templateName);
                    }, 1000);
                } else {
                    showNotification(`‚ùå Sync failed: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå [SYNC] Error:', error);
                showNotification('‚ùå Error syncing scenarios: ' + error.message, 'error');
            }
        }

        function resolveConflict(scenarioId, categoryId) {
            console.log(`‚ö†Ô∏è [CONFLICT] Resolving conflict for: ${scenarioId}`);
            
            // Find the scenario in details
            const scenario = [...currentComparisonState.details.modified, ...currentComparisonState.details.conflicts]
                .find(s => s.scenarioId === scenarioId && s.categoryId === categoryId);
            
            if (!scenario) {
                showNotification('‚ùå Scenario not found', 'error');
                return;
            }
            
            // Create conflict resolution modal
            const modalHTML = `
                <div id="conflict-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="z-index: 9999;">
                    <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
                        <!-- Fixed Header -->
                        <div class="bg-gradient-to-r from-red-600 to-orange-600 text-white p-6 rounded-t-lg flex-shrink-0">
                            <h2 class="text-2xl font-bold">
                                <i class="fas fa-code-merge mr-2"></i>
                                Resolve Conflict
                            </h2>
                            <p class="text-red-100 mt-1">${scenario.scenarioName}</p>
                        </div>

                        <!-- Scrollable Content -->
                        <div class="flex-1 overflow-y-auto p-6" style="min-height: 0;">
                            <div class="mb-4 bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mt-0.5"></i>
                                    <div class="text-sm text-yellow-800">
                                        <strong>Conflict Detected:</strong> This scenario exists in both templates with different content. 
                                        Choose which version to keep.
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <!-- Parent Version -->
                                <div class="border-2 border-blue-300 rounded-lg p-4 bg-blue-50">
                                    <div class="flex items-center justify-between mb-3">
                                        <h3 class="font-bold text-blue-900">üì• Parent Version</h3>
                                        <span class="text-xs text-blue-700">${currentComparisonState.parentName}</span>
                                    </div>
                                    <div class="text-sm text-gray-700">
                                        <div class="font-semibold mb-1">Triggers:</div>
                                        <div class="bg-white p-2 rounded mb-3 text-xs">${scenario.parentVersion?.triggers?.join(', ') || 'N/A'}</div>
                                        
                                        <div class="font-semibold mb-1">Quick Reply:</div>
                                        <div class="bg-white p-2 rounded mb-3 text-xs">${scenario.parentVersion?.quickReply || 'N/A'}</div>
                                        
                                        <div class="font-semibold mb-1">Full Reply:</div>
                                        <div class="bg-white p-2 rounded text-xs">${scenario.parentVersion?.fullReply || 'N/A'}</div>
                                    </div>
                                    <button onclick="selectParentVersion('${scenarioId}', '${categoryId}')"
                                            style="background-color: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer; width: 100%; margin-top: 1rem;">
                                        <i class="fas fa-check mr-2"></i>
                                        Use Parent Version
                                    </button>
                                </div>

                                <!-- Current Version -->
                                <div class="border-2 border-purple-300 rounded-lg p-4 bg-purple-50">
                                    <div class="flex items-center justify-between mb-3">
                                        <h3 class="font-bold text-purple-900">üìù Your Version</h3>
                                        <span class="text-xs text-purple-700">${currentComparisonState.templateName}</span>
                                    </div>
                                    <div class="text-sm text-gray-700">
                                        <div class="font-semibold mb-1">Triggers:</div>
                                        <div class="bg-white p-2 rounded mb-3 text-xs">${scenario.currentVersion?.triggers?.join(', ') || 'N/A'}</div>
                                        
                                        <div class="font-semibold mb-1">Quick Reply:</div>
                                        <div class="bg-white p-2 rounded mb-3 text-xs">${scenario.currentVersion?.quickReply || 'N/A'}</div>
                                        
                                        <div class="font-semibold mb-1">Full Reply:</div>
                                        <div class="bg-white p-2 rounded text-xs">${scenario.currentVersion?.fullReply || 'N/A'}</div>
                                    </div>
                                    <button onclick="keepCurrentVersion('${scenarioId}', '${categoryId}')"
                                            style="background-color: #9333ea; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer; width: 100%; margin-top: 1rem;">
                                        <i class="fas fa-shield-alt mr-2"></i>
                                        Keep My Version
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Fixed Footer -->
                        <div class="bg-gray-50 p-4 border-t-2 border-gray-200 flex justify-end flex-shrink-0">
                            <button onclick="closeConflictModal()"
                                    style="background-color: #6b7280; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer;">
                                <i class="fas fa-times-circle mr-2"></i>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Append modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeConflictModal() {
            const modal = document.getElementById('conflict-modal');
            if (modal) {
                modal.remove();
            }
        }

        function selectParentVersion(scenarioId, categoryId) {
            console.log(`‚úÖ [CONFLICT] Selected parent version for: ${scenarioId}`);
            currentComparisonState.conflictResolutions.set(`${categoryId}::${scenarioId}`, 'parent');
            closeConflictModal();
            showNotification('‚úÖ Parent version selected. Click "Sync Selected" to apply.', 'success');
            
            // Auto-add to sync list
            currentComparisonState.selectedToSync.add(`${categoryId}::${scenarioId}`);
            updateSyncButtonState();
        }

        function keepCurrentVersion(scenarioId, categoryId) {
            console.log(`‚úÖ [CONFLICT] Keeping current version for: ${scenarioId}`);
            currentComparisonState.conflictResolutions.set(`${categoryId}::${scenarioId}`, 'current');
            closeConflictModal();
            showNotification('‚úÖ Your version will be kept. No action needed.', 'info');
        }

        // ============================================================================
        // TEMPLATES NESTED TAB SWITCHING & INDUSTRY SETUP
        // ============================================================================
        function switchTemplatesNestedTab(subTabName) {
            console.log(`üîµ [TEMPLATES] Switching to nested tab: ${subTabName}`);
            
            // Hide all nested contents
            document.querySelectorAll('.templates-nested-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected content
            document.getElementById(`templates-${subTabName}-content`).classList.remove('hidden');
            
            // Update button styles
            document.querySelectorAll('[id^="templates-nested-"]').forEach(btn => {
                btn.classList.remove('text-blue-700', 'border-blue-600', 'bg-white');
                btn.classList.add('text-gray-600', 'border-transparent', 'hover:bg-gray-200');
            });
            const activeBtn = document.getElementById(`templates-nested-${subTabName}`);
            activeBtn.classList.remove('text-gray-600', 'border-transparent', 'hover:bg-gray-200');
            activeBtn.classList.add('text-blue-700', 'border-blue-600', 'bg-white');
            
            // Load content
            if (subTabName === 'industrysetup') {
                renderIndustryTypesTable();
            }
        }

        async function renderIndustryTypesTable() {
            console.log('üîµ [INDUSTRIES] Rendering industry types table...');
            
            const container = document.getElementById('industry-types-table-container');
            container.innerHTML = '<div class="p-8 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading industry types...</div>';
            
            try {
                const token = getAuthToken();
                const response = await fetch('/api/admin/global-industry-types', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    const industries = result.data;
                    
                    container.innerHTML = `
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b-2 border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Icon</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Industry ID</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Name</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Display Label</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase">Status</th>
                                    <th class="px-6 py-4 text-right text-xs font-bold text-gray-700 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${industries.map(industry => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-2xl">${industry.icon}</td>
                                        <td class="px-6 py-4">
                                            <code class="text-xs bg-gray-100 px-2 py-1 rounded">${industry.industryId}</code>
                                        </td>
                                        <td class="px-6 py-4 font-semibold text-gray-900">${industry.name}</td>
                                        <td class="px-6 py-4 text-sm text-gray-700">${industry.displayLabel}</td>
                                        <td class="px-6 py-4">
                                            <div class="flex flex-col gap-1">
                                                ${industry.isSystemDefault ? '<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs font-semibold rounded">System Default</span>' : ''}
                                                ${industry.isActive ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded">Active</span>' : '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs font-semibold rounded">Inactive</span>'}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            <div class="flex justify-end gap-2">
                                                <button onclick="editIndustry('${industry._id}')" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm rounded font-semibold" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                ${!industry.isSystemDefault ? `<button onclick="deleteIndustry('${industry._id}')" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded font-semibold" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    
                    console.log(`‚úÖ Rendered ${industries.length} industry types`);
                } else {
                    container.innerHTML = `
                        <div class="p-12 text-center">
                            <i class="fas fa-inbox text-gray-300 text-6xl mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700 mb-2">No Industry Types Found</h3>
                            <p class="text-gray-500 mb-6">Seed default industries to get started</p>
                            <button onclick="seedIndustries()" class="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-semibold">
                                <i class="fas fa-seedling mr-2"></i>
                                Seed Default Industries
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Error loading industry types:', error);
                container.innerHTML = `
                    <div class="p-12 text-center text-red-600">
                        <i class="fas fa-exclamation-triangle text-5xl mb-4"></i>
                        <p class="font-semibold">Error loading industry types</p>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        function openAddIndustryModal() {
            console.log('üîß [ADD INDUSTRY] Opening modal');
            document.getElementById('industry-modal-title').textContent = 'Add Industry Type';
            document.getElementById('industry-edit-id').value = '';
            document.getElementById('industry-id').value = '';
            document.getElementById('industry-id').disabled = false;
            document.getElementById('industry-name').value = '';
            document.getElementById('industry-label').value = '';
            document.getElementById('industry-icon').value = 'üè¢';
            document.getElementById('industry-description').value = '';
            document.getElementById('industry-color').value = 'orange';
            document.getElementById('industry-active').checked = true;
            document.getElementById('industry-modal').classList.remove('hidden');
            document.getElementById('industry-modal').classList.add('flex');
        }

        function closeIndustryModal() {
            console.log('üîß [ADD INDUSTRY] Closing modal');
            document.getElementById('industry-modal').classList.add('hidden');
            document.getElementById('industry-modal').classList.remove('flex');
            document.getElementById('industry-form').reset();
        }

        async function editIndustry(industryId) {
            console.log('‚úèÔ∏è [EDIT INDUSTRY] Fetching industry:', industryId);
            
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-industry-types`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const industry = result.data.find(ind => ind._id === industryId);
                    
                    if (!industry) {
                        showNotification('‚ùå Industry type not found', 'error');
                        return;
                    }
                    
                    console.log('‚úèÔ∏è [EDIT INDUSTRY] Found industry:', industry);
                    document.getElementById('industry-modal-title').textContent = 'Edit Industry Type';
                    document.getElementById('industry-edit-id').value = industry._id;
                    document.getElementById('industry-id').value = industry.industryId;
                    document.getElementById('industry-id').disabled = true; // Cannot change ID after creation
                    document.getElementById('industry-name').value = industry.name;
                    document.getElementById('industry-label').value = industry.displayLabel;
                    document.getElementById('industry-icon').value = industry.icon || 'üè¢';
                    document.getElementById('industry-description').value = industry.description || '';
                    document.getElementById('industry-color').value = industry.color || 'orange';
                    document.getElementById('industry-active').checked = industry.isActive !== false;
                    document.getElementById('industry-modal').classList.remove('hidden');
                    document.getElementById('industry-modal').classList.add('flex');
                } else {
                    showNotification('‚ùå Failed to load industry types', 'error');
                }
            } catch (error) {
                console.error('‚ùå [EDIT INDUSTRY] Error:', error);
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function handleIndustrySubmit(e) {
            e.preventDefault();
            console.log('üíæ [SAVE INDUSTRY] Form submitted');

            const editId = document.getElementById('industry-edit-id').value;
            const isEdit = !!editId;
            
            const data = {
                industryId: document.getElementById('industry-id').value.trim().toLowerCase(),
                name: document.getElementById('industry-name').value.trim(),
                displayLabel: document.getElementById('industry-label').value.trim(),
                icon: document.getElementById('industry-icon').value.trim() || 'üè¢',
                description: document.getElementById('industry-description').value.trim(),
                color: document.getElementById('industry-color').value,
                isActive: document.getElementById('industry-active').checked
            };

            console.log('üì§ [SAVE INDUSTRY] Data:', data);

            try {
                const token = getAuthToken();
                const url = isEdit 
                    ? `/api/admin/global-industry-types/${editId}`
                    : '/api/admin/global-industry-types';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('üì• [SAVE INDUSTRY] Response:', result);

                if (result.success) {
                    showNotification(isEdit ? '‚úÖ Industry updated!' : '‚úÖ Industry created!', 'success');
                    closeIndustryModal();
                    renderIndustryTypesTable();
                    loadIndustryTypesForModal(); // Refresh dropdown in Create Template modal
                } else {
                    showNotification('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                console.error('‚ùå [SAVE INDUSTRY] Error:', error);
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function deleteIndustry(id) {
            if (!confirm('Delete this industry type?\n\nThis cannot be undone!')) {
                return;
            }
            
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-industry-types/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ Industry type deleted', 'success');
                    renderIndustryTypesTable();
                } else {
                    showNotification('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting industry:', error);
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function seedIndustries() {
            if (!confirm('Seed default industry types?\n\n6 industries will be created.')) {
                return;
            }
            
            try {
                const token = getAuthToken();
                const response = await fetch('/api/admin/global-industry-types/seed', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ Seeded ${result.count} industries!`, 'success');
                    renderIndustryTypesTable();
                } else {
                    showNotification('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error seeding industries:', error);
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        }

        // Switch between nested sub-tabs in Action Hooks tab
        function switchActionHooksSubTab(subTabName) {
            // Hide all sub-tab contents
            document.querySelectorAll('.action-hooks-subtab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected sub-tab content
            if (subTabName === 'hooks') {
                document.getElementById('action-hooks-subtab-content').classList.remove('hidden');
                renderActionHooks();
                loadDirectoriesIntoDropdowns(); // Load categories for filter dropdown
            } else if (subTabName === 'directories') {
                document.getElementById('action-hooks-directories-subtab-content').classList.remove('hidden');
                renderDirectories();
            }
            
            // Update sub-tab button styles
            document.querySelectorAll('[id^="subtab-"]').forEach(btn => {
                btn.classList.remove('text-yellow-600', 'border-yellow-600');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            document.getElementById(`subtab-${subTabName}`).classList.remove('text-gray-500', 'border-transparent');
            document.getElementById(`subtab-${subTabName}`).classList.add('text-yellow-600', 'border-yellow-600');
        }

        // ============================================
        // BEHAVIOR TEMPLATES
        // ============================================
        const BEHAVIOR_TEMPLATES = [
            {
                id: 1,
                name: "Empathetic Guardian",
                icon: "ü§ù",
                description: "Calm, slow pace, validating feelings, brief reassurance then practical next step. Avoid platitudes; be specific and human.",
                tone: "empathetic",
                pace: "slow",
                useFor: "Upset, grief, distressed, crying"
            },
            {
                id: 2,
                name: "Urgent Responder",
                icon: "üö®",
                description: "Fast pace, short sentences, decisive verbs, immediate action. Use 'right away', 'immediately', 'I'll connect you now'.",
                tone: "urgent",
                pace: "fast",
                useFor: "Emergencies, ASAP requests, urgent needs"
            },
            {
                id: 3,
                name: "De-escalation Expert",
                icon: "üò§",
                description: "Short empathy + ownership + immediate corrective steps. Avoid defensiveness. Use calming, solution-focused language.",
                tone: "apologetic",
                pace: "normal",
                useFor: "Angry, frustrated, complaints"
            },
            {
                id: 4,
                name: "Professional Informer",
                icon: "üíº",
                description: "Clear, concise, confident tone. State facts, provide options, set expectations. Neutral pace.",
                tone: "professional",
                pace: "normal",
                useFor: "General inquiries, pricing, hours, policies"
            },
            {
                id: 5,
                name: "Friendly Guide",
                icon: "üòä",
                description: "Warm, upbeat, welcoming. Match caller energy but remain professional. Good for positive interactions.",
                tone: "friendly",
                pace: "normal",
                useFor: "Happy customers, new customers, confirmations"
            },
            {
                id: 6,
                name: "Patient Educator",
                icon: "üéì",
                description: "Slow pace, simple language, confirm understanding, offer to repeat. Break complex info into steps.",
                tone: "professional",
                pace: "slow",
                useFor: "Confused callers, technical questions, elderly"
            },
            {
                id: 7,
                name: "Efficient Processor",
                icon: "‚ö°",
                description: "Quick, streamlined, get to the point. Minimize small talk, focus on task completion.",
                tone: "professional",
                pace: "fast",
                useFor: "Rushed callers, busy people, transactional calls"
            },
            {
                id: 8,
                name: "Apologetic Restorer",
                icon: "üôè",
                description: "Clear apology + brief reason + corrective action + timeline. Own the mistake, focus on solution.",
                tone: "apologetic",
                pace: "normal",
                useFor: "Missed appointments, errors, service failures"
            },
            {
                id: 9,
                name: "Safety Coordinator",
                icon: "üõ°Ô∏è",
                description: "Serious, measured, clear instructions. Verify information, prioritize safety, escalate appropriately.",
                tone: "professional",
                pace: "slow",
                useFor: "Safety concerns, emergencies, liability issues"
            },
            {
                id: 10,
                name: "Relationship Builder",
                icon: "üí¨",
                description: "Conversational, personable, brief small talk allowed. Build rapport while maintaining professionalism.",
                tone: "friendly",
                pace: "normal",
                useFor: "VIP customers, repeat callers, long-term relationships"
            },
            {
                id: 11,
                name: "Booking Coordinator",
                icon: "üìÖ",
                description: "Efficient, friendly, collect details systematically. Confirm date/time/location clearly. Send confirmation immediately.",
                tone: "professional",
                pace: "normal",
                useFor: "Scheduling appointments, booking services, reservations"
            },
            {
                id: 12,
                name: "Cancellation Handler",
                icon: "‚ùå",
                description: "Short apology, explain policy clearly, offer alternatives (credit, reschedule), collect reason for analytics.",
                tone: "apologetic",
                pace: "normal",
                useFor: "Cancellations, refund requests, no-shows, changed plans"
            },
            {
                id: 13,
                name: "Payment Processor",
                icon: "üí≥",
                description: "Clear pricing breakdown, multiple payment options, confirm total, send receipt. Professional and secure tone.",
                tone: "professional",
                pace: "normal",
                useFor: "Payment questions, billing inquiries, invoices, deposits"
            },
            {
                id: 14,
                name: "Hold Manager",
                icon: "‚è≥",
                description: "Keep caller informed, set time expectations, provide updates every 30s. 'Let me check', 'Looking into that now'.",
                tone: "professional",
                pace: "normal",
                useFor: "Research needed, checking calendars, looking up information"
            },
            {
                id: 15,
                name: "Greeting Specialist",
                icon: "üëã",
                description: "Warm welcome, identify caller needs quickly, route appropriately. First impression sets the tone for entire call.",
                tone: "friendly",
                pace: "normal",
                useFor: "Initial greetings, 'How are you?', opening conversation, call routing"
            }
        ];

        async function renderBehaviors() {
            const container = document.getElementById('behaviors-list');
            
            // Show loading state
            container.innerHTML = '<div class="text-center py-8 text-gray-500">Loading behaviors...</div>';
            
            // Fetch fresh behaviors from database
            await fetchBehaviors();
            
            // Check if we have behaviors
            if (availableBehaviors.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-theater-masks text-gray-300 text-6xl mb-4"></i>
                        <p class="text-gray-600 mb-4">No behavior templates found</p>
                        <button onclick="seedBehaviors()" class="px-6 py-3 bg-orange-600 text-white rounded-lg font-semibold hover:bg-orange-700 transition-colors">
                            <i class="fas fa-seedling mr-2"></i>
                            Seed 15 Default Behaviors
                        </button>
                    </div>
                `;
                return;
            }
            
            // Render behaviors from database
            container.innerHTML = availableBehaviors.map((behavior, index) => `
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-4xl">${behavior.icon || 'üé≠'}</span>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900">${index + 1}. ${behavior.name}</h3>
                                </div>
                            </div>
                            <p class="text-gray-800 mb-3 italic">"${behavior.instructions}"</p>
                            <p class="text-sm text-gray-600">
                                <strong>Best for:</strong> ${behavior.bestFor || 'Various situations'}
                            </p>
                        </div>
                        <div class="flex flex-col gap-2 ml-4">
                            <button onclick="editBehavior('${behavior._id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2 text-sm">
                                <i class="fas fa-edit"></i>
                                Edit
                            </button>
                            <button onclick="deleteBehavior('${behavior._id}', ${behavior.isSystemDefault})" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors flex items-center gap-2 text-sm ${behavior.isSystemDefault ? 'opacity-50 cursor-not-allowed' : ''}">
                                <i class="fas fa-trash"></i>
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // BEHAVIOR MANAGEMENT FUNCTIONS
        // ============================================
        function openAddBehaviorModal() {
            // ============================================================================
            // üîß SAFETY CHECK: Verify add behavior modal exists
            // ============================================================================
            // Issue: Add behavior modal HTML is missing from this page
            // This is a REFACTOR AUDIT finding - the modal was never implemented
            // For now, show a helpful message instead of crashing
            // TODO: Implement the full add behavior modal UI
            // ============================================================================
            
            const modal = document.getElementById('add-behavior-modal');
            
            if (!modal) {
                console.warn('‚ö†Ô∏è [BEHAVIORS] Add modal not implemented yet');
                showNotification('Add behavior UI coming soon! For now, use the API endpoint.', 'info');
                return;
            }
            
            modal.style.display = 'flex';
            document.getElementById('add-behavior-form').reset();
        }

        function closeAddBehaviorModal() {
            const modal = document.getElementById('add-behavior-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function handleAddBehavior(event) {
            event.preventDefault();
            
            try {
                showNotification('Adding behavior...', 'info');
                
                const name = document.getElementById('add-behavior-name').value.trim();
                const icon = document.getElementById('add-behavior-icon').value.trim() || 'üé≠';
                const instructions = document.getElementById('add-behavior-description').value.trim();
                const bestFor = document.getElementById('add-behavior-usefor').value.trim();
                const tone = document.getElementById('add-behavior-tone').value;
                const pace = document.getElementById('add-behavior-pace').value;
                const volume = document.getElementById('add-behavior-volume').value;
                const emotionIntensity = parseInt(document.getElementById('add-behavior-emotion-intensity').value);
                
                // Generate behaviorId from name
                const behaviorId = name.toLowerCase().replace(/[^a-z0-9]+/g, '_');
                
                const token = getAuthToken();
                const response = await fetch('/api/admin/global-behaviors', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        behaviorId,
                        name,
                        icon,
                        instructions,
                        bestFor,
                        tone,
                        pace,
                        volume,
                        emotionIntensity,
                        examples: []
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Behavior "${name}" added successfully!`, 'success');
                    closeAddBehaviorModal();
                    // Refresh behaviors list
                    await renderBehaviors();
                } else {
                    showNotification('Failed to add behavior: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error adding behavior:', error);
                showNotification('Error adding behavior: ' + error.message, 'error');
            }
        }

        async function editBehavior(behaviorId) {
            try {
                // Find behavior in our loaded array
                const behavior = availableBehaviors.find(b => b._id === behaviorId);
                if (!behavior) {
                    showNotification('Behavior not found', 'error');
                    return;
                }

                // ============================================================================
                // üîß SAFETY CHECK: Verify edit modal exists before populating
                // ============================================================================
                // Issue: Edit behavior modal HTML is missing from this page
                // This is a REFACTOR AUDIT finding - the modal was never implemented
                // For now, show a helpful message instead of crashing
                // TODO: Implement the full edit behavior modal UI
                // ============================================================================
                
                const editModal = document.getElementById('edit-behavior-modal');
                
                if (!editModal) {
                    console.warn('‚ö†Ô∏è [BEHAVIORS] Edit modal not implemented yet');
                    showNotification('Edit behavior UI coming soon! For now, use the API endpoint.', 'info');
                    return;
                }
                
                // Populate edit form (only if modal exists)
                document.getElementById('edit-behavior-id').value = behavior._id;
                document.getElementById('edit-behavior-name').value = behavior.name;
                document.getElementById('edit-behavior-icon').value = behavior.icon;
                document.getElementById('edit-behavior-description').value = behavior.instructions;
                document.getElementById('edit-behavior-usefor').value = behavior.bestFor || '';
                document.getElementById('edit-behavior-tone').value = behavior.tone || 'professional';
                document.getElementById('edit-behavior-pace').value = behavior.pace || 'normal';
                document.getElementById('edit-behavior-volume').value = behavior.volume || 'normal';
                document.getElementById('edit-behavior-emotion-intensity').value = behavior.emotionIntensity || 3;

                editModal.style.display = 'flex';
            } catch (error) {
                console.error('Error loading behavior for edit:', error);
                showNotification('Error loading behavior', 'error');
            }
        }

        function closeEditBehaviorModal() {
            const modal = document.getElementById('edit-behavior-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function handleEditBehavior(event) {
            event.preventDefault();
            
            try {
                showNotification('Updating behavior...', 'info');
                
                const behaviorId = document.getElementById('edit-behavior-id').value;
                const name = document.getElementById('edit-behavior-name').value.trim();
                const icon = document.getElementById('edit-behavior-icon').value.trim();
                const instructions = document.getElementById('edit-behavior-description').value.trim();
                const bestFor = document.getElementById('edit-behavior-usefor').value.trim();
                const tone = document.getElementById('edit-behavior-tone').value;
                const pace = document.getElementById('edit-behavior-pace').value;
                const volume = document.getElementById('edit-behavior-volume').value;
                const emotionIntensity = parseInt(document.getElementById('edit-behavior-emotion-intensity').value);
                
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-behaviors/${behaviorId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        icon,
                        instructions,
                        bestFor,
                        tone,
                        pace,
                        volume,
                        emotionIntensity
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Behavior "${name}" updated successfully!`, 'success');
                    closeEditBehaviorModal();
                    // Refresh behaviors list
                    await renderBehaviors();
                } else {
                    showNotification('Failed to update behavior: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error updating behavior:', error);
                showNotification('Error updating behavior: ' + error.message, 'error');
            }
        }

        async function deleteBehavior(behaviorId, isSystemDefault) {
            if (isSystemDefault) {
                showNotification('Cannot delete system default behaviors', 'error');
                return;
            }

            const behavior = availableBehaviors.find(b => b._id === behaviorId);
            if (!behavior) {
                showNotification('Behavior not found', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete "${behavior.name}"?\n\nWARNING: This will affect any categories using this behavior!`)) {
                return;
            }

            try {
                showNotification('Deleting behavior...', 'info');
                
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-behaviors/${behaviorId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Behavior "${behavior.name}" deleted successfully!`, 'success');
                    // Refresh behaviors list
                    await renderBehaviors();
                } else {
                    showNotification('Failed to delete behavior: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting behavior:', error);
                showNotification('Error deleting behavior: ' + error.message, 'error');
            }
        }

        // ============================================
        // ACTION HOOKS MANAGEMENT
        // ============================================
        let availableActionHooks = [];
        let availableDirectories = [];

        // ============================================
        // CATEGORIES MANAGEMENT
        // ============================================

        // Fetch all categories
        async function fetchDirectories() {
            try {
                const token = getAuthToken();
                const response = await fetch('/api/admin/global-action-hook-directories', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                if (result.success) {
                    availableDirectories = result.data;
                    console.log('Loaded', availableDirectories.length, 'directories from database');
                }
                return availableDirectories;
            } catch (error) {
                console.error('Error fetching directories:', error);
                return [];
            }
        }

        // Render categories list
        async function renderDirectories() {
            const container = document.getElementById('directories-list');
            
            // Show loading state
            container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading categories...</div>';
            
            // Fetch fresh data
            await fetchDirectories();
            
            // Apply search filter
            const searchTerm = document.getElementById('directories-search')?.value.toLowerCase() || '';
            
            let filtered = availableDirectories.filter(dir => {
                const matchesSearch = !searchTerm || 
                    dir.name.toLowerCase().includes(searchTerm) ||
                    dir.directoryId.toLowerCase().includes(searchTerm) ||
                    (dir.description && dir.description.toLowerCase().includes(searchTerm));
                return matchesSearch;
            });
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                        <i class="fas fa-folder-open text-gray-400 text-4xl mb-3"></i>
                        <p class="text-gray-600 font-semibold">No directories found</p>
                        <button onclick="openAddHookDirectoryModal()" class="mt-4 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                            <i class="fas fa-plus-circle mr-2"></i>Add Your First Directory
                        </button>
                    </div>
                `;
                return;
            }
            
            // Render directory cards
            container.innerHTML = filtered.map(dir => {
                const colorClasses = {
                    red: 'bg-red-100 text-red-700',
                    blue: 'bg-blue-100 text-blue-700',
                    green: 'bg-green-100 text-green-700',
                    purple: 'bg-purple-100 text-purple-700',
                    cyan: 'bg-cyan-100 text-cyan-700',
                    indigo: 'bg-indigo-100 text-indigo-700',
                    yellow: 'bg-yellow-100 text-yellow-700',
                    gray: 'bg-gray-100 text-gray-700',
                    pink: 'bg-pink-100 text-pink-700',
                    orange: 'bg-orange-100 text-orange-700'
                };
                
                const badgeColor = colorClasses[dir.color] || 'bg-gray-100 text-gray-700';
                const isSystemDefault = dir.isSystemDefault;
                
                return `
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-5 hover:shadow-lg transition-all hover:border-yellow-400">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-2xl">${dir.icon || '‚ö°'}</span>
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-900">${dir.name}</h3>
                                        <code class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">${dir.directoryId}</code>
                                    </div>
                                </div>
                                
                                ${dir.description ? `<p class="text-sm text-gray-600 mb-3">${dir.description}</p>` : ''}
                                
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="text-xs font-semibold px-3 py-1 rounded-full ${badgeColor}">
                                        ${dir.color.toUpperCase()}
                                    </span>
                                    ${dir.isActive ? 
                                        '<span class="text-xs font-semibold px-3 py-1 rounded-full bg-green-100 text-green-700">Active</span>' :
                                        '<span class="text-xs font-semibold px-3 py-1 rounded-full bg-gray-100 text-gray-500">Inactive</span>'
                                    }
                                    ${isSystemDefault ? 
                                        '<span class="text-xs font-semibold px-3 py-1 rounded-full bg-blue-100 text-blue-700"><i class="fas fa-shield-alt mr-1"></i>System Default</span>' : ''
                                    }
                                    <span class="text-xs text-gray-500">Order: ${dir.sortOrder}</span>
                                </div>
                            </div>
                            
                            <div class="flex gap-2 ml-4">
                                <button onclick='editHookDirectory(${JSON.stringify(dir).replace(/'/g, "&apos;")})' class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                                ${!isSystemDefault ? `
                                    <button onclick='deleteHookDirectory(${JSON.stringify(dir).replace(/'/g, "&apos;")})' class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load categories into dropdowns
        async function loadDirectoriesIntoDropdowns() {
            await fetchDirectories();
            
            // Update hook category filter dropdown
            const filterDropdown = document.getElementById('action-hooks-directory-filter');
            if (filterDropdown) {
                filterDropdown.innerHTML = '<option value="">All Directories</option>' +
                    availableDirectories.map(dir => 
                        `<option value="${dir.directoryId}">${dir.icon} ${dir.name}</option>`
                    ).join('');
            }
            
            // Update add/edit hook category dropdowns
            const addDropdown = document.getElementById('add-hook-category');
            const editDropdown = document.getElementById('edit-hook-category');
            const directoryOptions = availableDirectories.map(dir => 
                `<option value="${dir.directoryId}">${dir.icon} ${dir.name}</option>`
            ).join('');
            
            if (addDropdown) addDropdown.innerHTML = directoryOptions;
            if (editDropdown) editDropdown.innerHTML = directoryOptions;
        }

        // Open add hook directory modal
        function openAddHookDirectoryModal() {
            const modal = document.getElementById('add-category-modal');
            if (modal) {
                modal.style.display = 'flex';
                const form = document.getElementById('add-category-form');
                if (form) form.reset();
            }
        }

        // Close add hook directory modal
        function closeAddHookDirectoryModal() {
            const modal = document.getElementById('add-category-modal');
            if (modal) modal.style.display = 'none';
        }

        // Handle add category form submission
        async function handleAddDirectorySubmit(e) {
            e.preventDefault();
            console.log('üìã [DIRECTORY] handleAddDirectorySubmit() called');
            
            try {
                showNotification('‚è≥ Adding directory...', 'info');

                const directoryData = {
                    directoryId: document.getElementById('add-category-id').value.trim(),
                    name: document.getElementById('add-category-name').value.trim(),
                    description: document.getElementById('add-category-description').value.trim(),
                    icon: document.getElementById('add-category-icon').value.trim(),
                    color: document.getElementById('add-category-color').value,
                    sortOrder: parseInt(document.getElementById('add-category-sort').value) || 999
                };

                console.log('üìã [DIRECTORY] Submitting data:', directoryData);
                const token = getAuthToken();
                console.log('üìã [DIRECTORY] Token present:', !!token);
                
                const response = await fetch('/api/admin/global-action-hook-directories', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(directoryData)
                });

                console.log('üìã [DIRECTORY] Response status:', response.status);
                const result = await response.json();
                console.log('üìã [DIRECTORY] Response body:', result);

                if (response.ok && result.success) {
                    showNotification(`‚úÖ Directory "${directoryData.name}" added successfully!`, 'success');
                    closeAddHookDirectoryModal();
                    console.log('üìã [DIRECTORY] Modal closed, rendering directories...');
                    await renderDirectories();
                    await loadDirectoriesIntoDropdowns();
                    console.log('üìã [DIRECTORY] ‚úÖ Directory added and UI updated!');
                } else {
                    console.error('‚ùå Add directory failed:', result);
                    showNotification('Failed to add directory: ' + (result.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('‚ùå Error adding directory:', error);
                showNotification('Error adding directory: ' + error.message, 'error');
            }
        }

        // Edit action hook directory
        function editHookDirectory(dir) {
            document.getElementById('edit-ahc-category-id-original').value = dir._id;
            document.getElementById('edit-ahc-category-id').value = dir.directoryId;
            document.getElementById('edit-ahc-category-name').value = dir.name;
            document.getElementById('edit-ahc-category-description').value = dir.description || '';
            document.getElementById('edit-ahc-category-icon').value = dir.icon || '';
            document.getElementById('edit-ahc-category-color').value = dir.color || 'gray';
            document.getElementById('edit-ahc-category-sort').value = dir.sortOrder || 0;
            document.getElementById('edit-ahc-category-active').checked = dir.isActive !== false;
            
            const modal = document.getElementById('edit-action-hook-category-modal');
            if (modal) modal.style.display = 'flex';
        }

        // Close edit action hook directory modal
        function closeEditHookDirectoryModal() {
            const modal = document.getElementById('edit-action-hook-category-modal');
            if (modal) modal.style.display = 'none';
        }

        // Handle edit action hook category form submission
        async function handleEditHookDirectorySubmit(e) {
            e.preventDefault();
            console.log('üìã [DIRECTORY EDIT] handleEditHookDirectorySubmit() called');
            
            try {
                showNotification('‚è≥ Updating directory...', 'info');

                const directoryId = document.getElementById('edit-ahc-category-id-original').value;
                const directoryData = {
                    name: document.getElementById('edit-ahc-category-name').value.trim(),
                    description: document.getElementById('edit-ahc-category-description').value.trim(),
                    icon: document.getElementById('edit-ahc-category-icon').value.trim(),
                    color: document.getElementById('edit-ahc-category-color').value,
                    sortOrder: parseInt(document.getElementById('edit-ahc-category-sort').value) || 0,
                    isActive: document.getElementById('edit-ahc-category-active').checked
                };

                console.log('üìã [DIRECTORY EDIT] Directory ID:', directoryId);
                console.log('üìã [DIRECTORY EDIT] Data:', directoryData);
                
                const token = getAuthToken();
                console.log('üìã [DIRECTORY EDIT] Token present:', !!token);
                
                const response = await fetch(`/api/admin/global-action-hook-directories/${directoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(directoryData)
                });

                console.log('üìã [DIRECTORY EDIT] Response status:', response.status);
                const result = await response.json();
                console.log('üìã [DIRECTORY EDIT] Response body:', result);

                if (response.ok && result.success) {
                    showNotification(`‚úÖ Directory "${directoryData.name}" updated successfully!`, 'success');
                    closeEditHookDirectoryModal();
                    console.log('üìã [DIRECTORY EDIT] Modal closed, rendering directories...');
                    await renderDirectories();
                    await loadDirectoriesIntoDropdowns();
                    console.log('üìã [DIRECTORY EDIT] ‚úÖ Directory updated and UI refreshed!');
                } else {
                    console.error('‚ùå Update failed:', result);
                    showNotification('Failed to update directory: ' + (result.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('‚ùå Error updating directory:', error);
                showNotification('Error updating directory: ' + error.message, 'error');
            }
        }

        // Delete action hook category
        async function deleteHookDirectory(dir) {
            if (!confirm(`Are you sure you want to delete the directory "${dir.name}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                showNotification('‚è≥ Deleting directory...', 'info');

                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-action-hook-directories/${dir._id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification(`‚úÖ Directory "${dir.name}" deleted successfully!`, 'success');
                    await renderDirectories();
                    await loadDirectoriesIntoDropdowns();
                } else {
                    showNotification('Failed to delete directory: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting directory:', error);
                showNotification('Error deleting directory: ' + error.message, 'error');
            }
        }

        // Seed directories
        async function seedDirectories() {
            if (!confirm('This will seed 7 default directories (Escalation, Scheduling, Communication, Payment, Information, Call Flow, System).\n\nContinue?')) {
                return;
            }

            try {
                showNotification('‚è≥ Seeding directories...', 'info');

                const token = getAuthToken();
                const response = await fetch('/api/admin/global-action-hook-directories/seed', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification(`‚úÖ Successfully seeded ${result.count} directories!`, 'success');
                    await renderDirectories();
                    await loadDirectoriesIntoDropdowns();
                } else {
                    showNotification('Seeding failed: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error seeding directories:', error);
                showNotification('Error seeding directories: ' + error.message, 'error');
            }
        }

        // Search categories
        document.getElementById('directories-search')?.addEventListener('input', renderDirectories);

        // Fetch all action hooks
        async function fetchActionHooks() {
            try {
                const token = getAuthToken();
                const response = await fetch('/api/admin/global-action-hooks', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                availableActionHooks = result.data || [];
                console.log(`Loaded ${availableActionHooks.length} action hooks from database`);
                return availableActionHooks;
            } catch (error) {
                console.error('Error fetching action hooks:', error);
                showNotification('Failed to load action hooks', 'error');
                return [];
            }
        }

        // Render action hooks list
        async function renderActionHooks() {
            console.log('üü° [CHECKPOINT 14] renderActionHooks() called');
            const container = document.getElementById('action-hooks-list');
            
            // Show loading state
            container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading action hooks...</div>';
            console.log('üü° [CHECKPOINT 15] Loading state displayed, fetching data...');
            
            // Fetch fresh data
            await fetchActionHooks();
            console.log('üü° [CHECKPOINT 16] Data fetched successfully');
            
            // Apply filters
            const searchTerm = document.getElementById('action-hooks-search')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('action-hooks-directory-filter')?.value || '';
            
            let filtered = availableActionHooks.filter(hook => {
                const matchesSearch = !searchTerm || 
                    hook.name.toLowerCase().includes(searchTerm) ||
                    hook.hookId.toLowerCase().includes(searchTerm) ||
                    (hook.description && hook.description.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !categoryFilter || hook.category === categoryFilter;
                
                return matchesSearch && matchesCategory;
            });
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                        <i class="fas fa-bolt text-gray-400 text-4xl mb-3"></i>
                        <p class="text-gray-600 font-semibold">No action hooks found</p>
                        <button onclick="openAddActionHookModal()" class="mt-4 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                            <i class="fas fa-plus-circle mr-2"></i>Add Your First Action Hook
                        </button>
                    </div>
                `;
                return;
            }
            
            // Render hook cards
            container.innerHTML = filtered.map(hook => {
                const categoryColors = {
                    escalation: 'bg-red-100 text-red-700',
                    scheduling: 'bg-blue-100 text-blue-700',
                    communication: 'bg-green-100 text-green-700',
                    payment: 'bg-purple-100 text-purple-700',
                    information: 'bg-cyan-100 text-cyan-700',
                    call_flow: 'bg-indigo-100 text-indigo-700',
                    system: 'bg-gray-100 text-gray-700'
                };
                
                const categoryColor = categoryColors[hook.category] || 'bg-gray-100 text-gray-700';
                const isSystemDefault = hook.isSystemDefault;
                
                return `
                    <div class="bg-gradient-to-r from-gray-50 to-white border-2 border-gray-200 rounded-xl p-5 hover:shadow-lg transition-all hover:border-yellow-400">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-2xl">${hook.icon || '‚ö°'}</span>
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-900">${hook.name}</h3>
                                        <code class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">${hook.hookId}</code>
                                    </div>
                                </div>
                                
                                ${hook.description ? `<p class="text-sm text-gray-600 mb-3">${hook.description}</p>` : ''}
                                
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="text-xs font-semibold px-3 py-1 rounded-full ${categoryColor}">
                                        ${(hook.category || 'system').replace(/_/g, ' ').toUpperCase()}
                                    </span>
                                    ${hook.isActive ? 
                                        '<span class="text-xs font-semibold px-3 py-1 rounded-full bg-green-100 text-green-700">Active</span>' :
                                        '<span class="text-xs font-semibold px-3 py-1 rounded-full bg-gray-100 text-gray-500">Inactive</span>'
                                    }
                                    ${isSystemDefault ? 
                                        '<span class="text-xs font-semibold px-3 py-1 rounded-full bg-blue-100 text-blue-700"><i class="fas fa-shield-alt mr-1"></i>System Default</span>' : ''
                                    }
                                </div>
                            </div>
                            
                            <div class="flex gap-2 ml-4">
                                <button onclick='editActionHook(${JSON.stringify(hook).replace(/'/g, "&apos;")})' class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                                ${!isSystemDefault ? `
                                    <button onclick='deleteActionHook(${JSON.stringify(hook).replace(/'/g, "&apos;")})' class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            console.log('üü° [CHECKPOINT 17] ‚úÖ Rendering complete! Displayed', filtered.length, 'action hooks');
        }

        // Open add action hook modal
        function openAddActionHookModal() {
            document.getElementById('add-action-hook-modal').style.display = 'flex';
            document.getElementById('add-action-hook-form').reset();
            document.getElementById('add-hook-active').checked = true;
        }

        // Close add action hook modal
        function closeAddActionHookModal() {
            document.getElementById('add-action-hook-modal').style.display = 'none';
        }

        // Handle add action hook form submission (named function for onsubmit)
        async function handleAddActionHookSubmit(e) {
            e.preventDefault();
            
            try {
                showNotification('‚è≥ Adding action hook...', 'info');

                const hookData = {
                    hookId: document.getElementById('add-hook-id').value.trim(),
                    name: document.getElementById('add-hook-name').value.trim(),
                    description: document.getElementById('add-hook-description').value.trim(),
                    category: document.getElementById('add-hook-category').value,
                    icon: document.getElementById('add-hook-icon').value.trim(),
                    functionName: document.getElementById('add-hook-function').value.trim(),
                    isActive: document.getElementById('add-hook-active').checked
                };

                const token = getAuthToken();
                const response = await fetch('/api/admin/global-action-hooks', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(hookData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification(`‚úÖ Action hook "${hookData.name}" added successfully!`, 'success');
                    closeAddActionHookModal();
                    await renderActionHooks();
                } else {
                    showNotification('Failed to add action hook: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error adding action hook:', error);
                showNotification('Error adding action hook: ' + error.message, 'error');
            }
        }

        // Edit action hook
        function editActionHook(hook) {
            console.log('üîµ [CHECKPOINT 1] editActionHook() called with hook:', hook);
            document.getElementById('edit-hook-id-original').value = hook._id;  // Store MongoDB _id for API call
            document.getElementById('edit-hook-id').value = hook.hookId;  // Display hookId (read-only)
            document.getElementById('edit-hook-name').value = hook.name;
            document.getElementById('edit-hook-description').value = hook.description || '';
            document.getElementById('edit-hook-category').value = hook.category;
            document.getElementById('edit-hook-icon').value = hook.icon || '';
            document.getElementById('edit-hook-function').value = hook.functionName || '';
            document.getElementById('edit-hook-active').checked = hook.isActive !== false;
            
            console.log('üîµ [CHECKPOINT 2] Form fields populated, opening modal...');
            document.getElementById('edit-action-hook-modal').style.display = 'flex';
            console.log('üîµ [CHECKPOINT 3] Modal opened successfully');
        }

        // Close edit action hook modal
        function closeEditActionHookModal() {
            document.getElementById('edit-action-hook-modal').style.display = 'none';
        }

        // Handle edit action hook form submission (named function for onsubmit)
        async function handleEditActionHookSubmit(e) {
            console.log('üü¢ [CHECKPOINT 4] Form submit event triggered via onsubmit handler');
            e.preventDefault();
            console.log('üü¢ [CHECKPOINT 5] Default form action prevented');
            
            try {
                showNotification('‚è≥ Updating action hook...', 'info');

                const hookId = document.getElementById('edit-hook-id-original').value;
                const hookData = {
                    name: document.getElementById('edit-hook-name').value.trim(),
                    description: document.getElementById('edit-hook-description').value.trim(),
                    category: document.getElementById('edit-hook-category').value,
                    icon: document.getElementById('edit-hook-icon').value.trim(),
                    functionName: document.getElementById('edit-hook-function').value.trim(),
                    isActive: document.getElementById('edit-hook-active').checked
                };

                console.log('üü¢ [CHECKPOINT 6] Collected form data:', hookData);
                console.log('üü¢ [CHECKPOINT 7] Using MongoDB ID:', hookId);

                const token = getAuthToken();
                console.log('üü¢ [CHECKPOINT 8] Sending PUT request to:', `/api/admin/global-action-hooks/${hookId}`);
                
                const response = await fetch(`/api/admin/global-action-hooks/${hookId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(hookData)
                });

                console.log('üü¢ [CHECKPOINT 9] Response received. Status:', response.status, 'OK:', response.ok);
                const result = await response.json();
                console.log('üü¢ [CHECKPOINT 10] Response JSON:', result);

                if (response.ok && result.success) {
                    console.log('üü¢ [CHECKPOINT 11] Update successful! Closing modal...');
                    showNotification(`‚úÖ Action hook "${hookData.name}" updated successfully!`, 'success');
                    closeEditActionHookModal();
                    console.log('üü¢ [CHECKPOINT 12] Modal closed. Rendering action hooks...');
                    await renderActionHooks();
                    console.log('üü¢ [CHECKPOINT 13] ‚úÖ Action hooks re-rendered successfully!');
                } else {
                    console.error('üî¥ [CHECKPOINT 11-ERROR] Update failed:', result.message);
                    showNotification('Failed to update action hook: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('üî¥ [CHECKPOINT ERROR] Exception caught:', error);
                showNotification('Error updating action hook: ' + error.message, 'error');
            }
        }

        // Delete action hook
        async function deleteActionHook(hook) {
            if (!confirm(`Are you sure you want to delete the action hook "${hook.name}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                showNotification('‚è≥ Deleting action hook...', 'info');

                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-action-hooks/${hook._id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification(`‚úÖ Action hook "${hook.name}" deleted successfully!`, 'success');
                    await renderActionHooks();
                } else {
                    showNotification('Failed to delete action hook: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting action hook:', error);
                showNotification('Error deleting action hook: ' + error.message, 'error');
            }
        }

        // Search and filter action hooks
        document.getElementById('action-hooks-search')?.addEventListener('input', renderActionHooks);
        document.getElementById('action-hooks-directory-filter')?.addEventListener('change', renderActionHooks);

        // ============================================
        // INITIALIZATION
        // ============================================
        // ============================================
        // DASHBOARD TEMPLATE SELECTOR
        // ============================================
        async function loadTemplatesIntoSelector() {
            try {
                const token = getAuthToken();
                const response = await fetch('/api/admin/global-instant-responses', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    const selector = document.getElementById('dashboard-template-selector');
                    
                    // Start with "Select a template" option (not selected by default)
                    selector.innerHTML = '<option value="">-- Select a template --</option>' + 
                        result.data.map(template => 
                            `<option value="${template._id}">
                                ${template.name} (${template.version})
                            </option>`
                        ).join('');
                    
                    console.log(`‚úÖ Loaded ${result.data.length} templates into selector`);
                }
            } catch (error) {
                console.error('‚ùå Error loading templates into selector:', error);
            }
        }

        async function switchDashboardTemplate(templateId) {
            // Hide helper message when template is selected
            const helper = document.getElementById('template-select-helper');
            if (helper) {
                helper.style.display = templateId ? 'none' : 'flex';
            }
            
            if (!templateId) return;
            
            try {
                console.log(`üîÑ [SWITCH TEMPLATE] Switching to template ID: ${templateId}`);
                showNotification('‚è≥ Loading template...', 'info');
                
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-instant-responses/${templateId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                console.log('üì¶ [SWITCH TEMPLATE] Raw API response:', result);
                
                // Handle both response formats: result.data or result.template
                const template = result.template || result.data;
                
                if (result.success && template) {
                    console.log(`‚úÖ [SWITCH TEMPLATE] Loaded template:`, {
                        id: template._id,
                        name: template.name,
                        version: template.version,
                        categories: template.categories?.length || 0,
                        categoryNames: template.categories?.map(c => c.name)
                    });
                    
                    // CRITICAL: Update global activeTemplate reference
                    activeTemplate = template;
                    activeTemplateId = template._id;
                    window.activeTemplateId = template._id; // Make available to template-settings-manager.js
                    window.activeTemplate = template; // Make available to loadSuggestions()
                    
                    console.log('üîç [SWITCH TEMPLATE] activeTemplate updated:', {
                        id: activeTemplate._id,
                        name: activeTemplate.name,
                        categoriesCount: activeTemplate.categories?.length || 0
                    });
                    
                    // Update stats
                    updateDashboardStats();
                    
                    // Refresh categories list
                    console.log('üé® [SWITCH TEMPLATE] About to render categories...');
                    renderCategories();
                    
                    // üéØ NEW: Refresh Template Data sub-tabs (Template Settings + Category Settings)
                    console.log('üìä [SWITCH TEMPLATE] Refreshing Template Data sub-tabs...');
                    if (window.templateDataManager) {
                        await window.templateDataManager.onTemplateChange(template._id);
                        console.log('‚úÖ [SWITCH TEMPLATE] Template Data sub-tabs refreshed');
                    }
                    
                    // üéØ NEW: Reload fillers/synonyms with template-settings-manager.js
                    if (typeof loadFillerWordsForTemplate === 'function') {
                        console.log('üì• [SWITCH TEMPLATE] Reloading fillers...');
                        await loadFillerWordsForTemplate();
                    }
                    if (typeof loadSynonymsForTemplate === 'function') {
                        console.log('üì• [SWITCH TEMPLATE] Reloading synonyms...');
                        await loadSynonymsForTemplate();
                    }
                    
                    // üü£ Reload AI suggestions for new template
                    console.log('üì• [SWITCH TEMPLATE] Reloading AI suggestions...');
                    await loadSuggestions(false);
                    console.log('‚úÖ [SWITCH TEMPLATE] AI suggestions reloaded');
                    
                    // üìû Reload Twilio test config for new template
                    console.log('üì• [SWITCH TEMPLATE] Reloading Twilio test config...');
                    await loadTwilioTestConfig();
                    console.log('‚úÖ [SWITCH TEMPLATE] Twilio test config reloaded');
                    
                    // üéØ Reload Intelligence Mode for new template
                    console.log('üì• [SWITCH TEMPLATE] Reloading Intelligence Mode...');
                    loadIntelligenceMode();
                    console.log('‚úÖ [SWITCH TEMPLATE] Intelligence Mode reloaded');
                    
                    // üß† Reload AI Learning settings for new template
                    console.log('üì• [SWITCH TEMPLATE] Reloading AI Learning settings...');
                    await loadAILearningSettings();
                    console.log('‚úÖ [SWITCH TEMPLATE] AI Learning settings reloaded');
                    
                    // üî• CRITICAL: Auto-update activeTemplateId in global Twilio config
                    // This ensures when you call the test number, it uses the NEW template!
                    console.log('üìû [SWITCH TEMPLATE] Auto-updating Twilio test routing...');
                    try {
                        const routingResponse = await fetch('/api/admin/settings/global-ai-brain-test', {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                Authorization: `Bearer ${getAuthToken()}`
                            },
                            body: JSON.stringify({ 
                                activeTemplateId: template._id
                            })
                        });
                        
                        // üî• NEW: Check if it actually worked!
                        if (!routingResponse.ok) {
                            throw new Error(`HTTP ${routingResponse.status}`);
                        }
                        
                        const routingData = await routingResponse.json();
                        
                        if (routingData.success) {
                            console.log(`‚úÖ [SWITCH TEMPLATE] Twilio routing updated to: ${template.name}`);
                            showToast('success', `üìû Test calls will now use: ${template.name}`);
                        } else {
                            throw new Error(routingData.message || 'Update failed');
                        }
                    } catch (err) {
                        console.error('‚ùå [SWITCH TEMPLATE] Failed to update test routing:', err);
                        showToast('error', `‚ö†Ô∏è Test routing update failed: ${err.message}. You may need to manually save test config!`);
                    }
                    
                    // üß™ Refresh Live Test Monitor for new template
                    console.log('üß™ [SWITCH TEMPLATE] Refreshing Live Test Monitor...');
                    await refreshLiveTestMonitor();
                    console.log('‚úÖ [SWITCH TEMPLATE] Live Test Monitor refreshed');
                    
                    // üìä Refresh AI Cost Dashboard for new template
                    console.log('üìä [SWITCH TEMPLATE] Refreshing AI Cost Dashboard...');
                    await refreshAICostDashboard();
                    console.log('‚úÖ [SWITCH TEMPLATE] AI Cost Dashboard refreshed');
                    
                    showNotification(`‚úÖ Loaded: ${template.name}`, 'success');
                } else {
                    console.error('‚ùå [SWITCH TEMPLATE] Failed to load:', result.message || 'No template data found');
                    console.error('‚ùå [SWITCH TEMPLATE] Result object:', result);
                    showNotification('‚ùå Failed to load template', 'error');
                }
            } catch (error) {
                console.error('‚ùå [SWITCH TEMPLATE] Exception:', error);
                showNotification('‚ùå Error: ' + error.message, 'error');
            }
        }

        function updateDashboardStats() {
            if (!activeTemplate) return;
            
            const stats = activeTemplate.stats || {};
            
            // Update stat numbers
            document.getElementById('dash-stat-categories').textContent = stats.totalCategories || activeTemplate.categories?.length || 0;
            document.getElementById('dash-stat-scenarios').textContent = stats.totalScenarios || 0;
            document.getElementById('dash-stat-triggers').textContent = stats.totalTriggers || 0;
            document.getElementById('dash-stat-version').textContent = activeTemplate.version || 'v0.0.0';
            
            // Update last updated date
            if (activeTemplate.updatedAt) {
                const date = new Date(activeTemplate.updatedAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('dashboard-template-updated').textContent = `üïí Last updated: ${date}`;
            }
        }

        // ============================================
        // üß™ TEST LOG MODAL FUNCTIONALITY
        // ============================================
        
        let autoRefreshInterval = null;
        let lastTestResults = []; // Store for export
        
        function openTestLogModal() {
            console.log('üß™ Opening test log page...');
            document.getElementById('test-log-modal').classList.remove('hidden');
            document.getElementById('test-log-modal').classList.add('flex');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
            refreshTestLog();
        }
        
        function closeTestLogModal() {
            console.log('üß™ Closing test log page...');
            document.getElementById('test-log-modal').classList.add('hidden');
            document.getElementById('test-log-modal').classList.remove('flex');
            document.body.style.overflow = ''; // Restore scrolling
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('auto-refresh-toggle');
            if (checkbox.checked) {
                console.log('üß™ Auto-refresh enabled');
                refreshTestLog();
                autoRefreshInterval = setInterval(refreshTestLog, 5000);
            } else {
                console.log('üß™ Auto-refresh disabled');
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }
        
        async function refreshTestLog() {
            if (!activeTemplateId) {
                console.log('‚ö†Ô∏è No active template');
                return;
            }
            
            try {
                console.log(`üß™ Fetching test results for template ${activeTemplateId}...`);
                const token = getAuthToken();
                
                const response = await fetch(`/api/twilio/test-results/${activeTemplateId}?limit=20`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`üß™ Loaded ${data.count} test results`);
                    renderTestLog(data.results);
                    document.getElementById('test-log-count').textContent = data.count;
                } else {
                    console.error('‚ùå Failed to load test results');
                    renderTestLogError('Failed to load test results');
                }
            } catch (error) {
                console.error('‚ùå Error fetching test results:', error);
                renderTestLogError(error.message);
            }
        }
        
        function renderTestLog(results) {
            const container = document.getElementById('test-log-content');
            
            // Store for export
            lastTestResults = results;
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-flask text-6xl mb-4"></i>
                        <p class="text-lg">No test calls yet</p>
                        <p class="text-sm">Make a test call to see results here</p>
                    </div>
                `;
                document.getElementById('template-health-summary').classList.add('hidden');
                lastTestResults = [];
                return;
            }
            
            // Calculate health metrics
            const health = calculateTemplateHealth(results);
            renderHealthSummary(health);
            
            let html = '<div class="space-y-4">';
            
            results.forEach((result, index) => {
                const timeAgo = getTimeAgo(new Date(result.timestamp));
                const confidencePercent = Math.round(result.confidence * 100);
                const thresholdPercent = Math.round(result.threshold * 100);
                const passed = result.confidence >= result.threshold;
                
                const statusIcon = result.matched ? '‚úÖ' : '‚ùå';
                const statusColor = result.matched ? 'green' : 'red';
                const statusText = result.matched ? 'MATCHED' : 'NO MATCH';
                
                html += `
                    <div class="border-2 border-${statusColor}-200 rounded-lg p-4 bg-${statusColor}-50">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-2xl">${statusIcon}</span>
                                    <div>
                                        <div class="font-bold text-${statusColor}-800">${statusText}</div>
                                        <div class="text-xs text-gray-600">‚è∞ ${timeAgo}</div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="text-sm text-gray-600 mb-1">üó£Ô∏è Caller said:</div>
                                    <div class="text-lg font-semibold text-gray-900">"${escapeHtml(result.phrase)}"</div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 mb-3">
                                    <div>
                                        <div class="text-xs text-gray-600">Confidence:</div>
                                        <div class="text-lg font-bold text-${statusColor}-700">
                                            ${confidencePercent}% ${passed ? '‚úÖ' : `‚ö†Ô∏è (need ${thresholdPercent}%)`}
                                        </div>
                                    </div>
                                    ${result.timing?.total ? `
                                    <div>
                                        <div class="text-xs text-gray-600">Response Time:</div>
                                        <div class="text-lg font-bold text-blue-700">
                                            ${result.timing.total}ms ${result.timing.total < 50 ? '‚ö°' : result.timing.total < 100 ? '‚úÖ' : '‚ö†Ô∏è'}
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                ${result.matched && result.scenario ? `
                                <div class="bg-white rounded-lg p-3 border border-${statusColor}-200">
                                    <div class="text-xs text-gray-600 mb-1">üìå Matched Scenario:</div>
                                    <div class="font-semibold text-${statusColor}-800">${escapeHtml(result.scenario.name)}</div>
                                    ${result.scenario.category ? `<div class="text-xs text-gray-600">Category: ${escapeHtml(result.scenario.category)}</div>` : ''}
                                </div>
                                ` : ''}
                                
                                ${result.intelligenceRouting?.enabled ? `
                                <div class="bg-gradient-to-br from-emerald-50 to-green-50 rounded-lg p-4 border-2 border-emerald-400 mt-3">
                                    <div class="font-bold text-emerald-900 mb-3 flex items-center gap-2">
                                        <i class="fas fa-layer-group"></i>
                                        üß† 3-Tier Intelligence Cascade
                                    </div>
                                    <div class="grid grid-cols-4 gap-3 mb-3">
                                        <div class="bg-white rounded-lg p-3 border-2 ${result.intelligenceRouting.tierUsed === 1 ? 'border-green-500' : 'border-gray-300'}">
                                            <div class="text-xs font-bold ${result.intelligenceRouting.tierUsed === 1 ? 'text-green-900' : 'text-gray-500'}">
                                                ${result.intelligenceRouting.tierUsed === 1 ? '‚úÖ' : '‚ö™'} Tier 1
                                            </div>
                                            <div class="text-xs text-gray-600 mt-1">Rule-based</div>
                                            ${result.intelligenceRouting.tier1Confidence > 0 ? `<div class="text-sm font-bold ${result.intelligenceRouting.tierUsed === 1 ? 'text-green-700' : 'text-gray-400'}">${(result.intelligenceRouting.tier1Confidence * 100).toFixed(0)}%</div>` : ''}
                                        </div>
                                        <div class="bg-white rounded-lg p-3 border-2 ${result.intelligenceRouting.tierUsed === 2 ? 'border-blue-500' : 'border-gray-300'}">
                                            <div class="text-xs font-bold ${result.intelligenceRouting.tierUsed === 2 ? 'text-blue-900' : 'text-gray-500'}">
                                                ${result.intelligenceRouting.tierUsed === 2 ? '‚úÖ' : '‚ö™'} Tier 2
                                            </div>
                                            <div class="text-xs text-gray-600 mt-1">Semantic</div>
                                            ${result.intelligenceRouting.tier2Confidence > 0 ? `<div class="text-sm font-bold ${result.intelligenceRouting.tierUsed === 2 ? 'text-blue-700' : 'text-gray-400'}">${(result.intelligenceRouting.tier2Confidence * 100).toFixed(0)}%</div>` : ''}
                                        </div>
                                        <div class="bg-white rounded-lg p-3 border-2 ${result.intelligenceRouting.tierUsed === 3 ? 'border-purple-500' : 'border-gray-300'}">
                                            <div class="text-xs font-bold ${result.intelligenceRouting.tierUsed === 3 ? 'text-purple-900' : 'text-gray-500'}">
                                                ${result.intelligenceRouting.tierUsed === 3 ? '‚úÖ' : '‚ö™'} Tier 3
                                            </div>
                                            <div class="text-xs text-gray-600 mt-1">LLM (GPT-4)</div>
                                            ${result.intelligenceRouting.tier3Confidence > 0 ? `<div class="text-sm font-bold ${result.intelligenceRouting.tierUsed === 3 ? 'text-purple-700' : 'text-gray-400'}">${(result.intelligenceRouting.tier3Confidence * 100).toFixed(0)}%</div>` : ''}
                                        </div>
                                        <div class="bg-white rounded-lg p-3 border-2 border-gray-300">
                                            <div class="text-xs font-bold text-gray-700">Cost</div>
                                            <div class="text-sm font-bold ${result.intelligenceRouting.cost > 0 ? 'text-red-700' : 'text-green-700'}">
                                                ${result.intelligenceRouting.cost > 0 ? '$' + result.intelligenceRouting.cost.toFixed(4) : 'FREE'}
                                            </div>
                                            <div class="text-xs text-gray-600 mt-1">${result.intelligenceRouting.responseTime}ms</div>
                                        </div>
                                    </div>
                                    <div class="bg-white rounded-lg p-3 border-2 border-emerald-300">
                                        <div class="text-xs font-bold text-emerald-900 mb-2">üéØ Route Used:</div>
                                        <div class="text-sm text-gray-700">
                                            <span class="px-3 py-1 rounded-full text-sm font-bold ${
                                                result.intelligenceRouting.tierUsed === 1 ? 'bg-green-600 text-white' :
                                                result.intelligenceRouting.tierUsed === 2 ? 'bg-blue-600 text-white' :
                                                'bg-purple-600 text-white'
                                            }">
                                                ${result.intelligenceRouting.tierName}
                                            </span>
                                            ${result.intelligenceRouting.tierUsed === 3 && result.intelligenceRouting.patternsLearned > 0 ? `
                                                <span class="ml-2 px-2 py-1 rounded-full text-xs font-bold bg-yellow-500 text-white">
                                                    üìö Learned ${result.intelligenceRouting.patternsLearned} pattern${result.intelligenceRouting.patternsLearned > 1 ? 's' : ''}
                                                </span>
                                            ` : ''}
                                        </div>
                                        ${result.intelligenceRouting.allTiersFailed ? `
                                        <div class="mt-2 p-2 bg-red-100 border-2 border-red-500 rounded">
                                            <div class="text-xs font-bold text-red-900">‚ö†Ô∏è ALL TIERS FAILED</div>
                                            <div class="text-xs text-red-700">No confidence above threshold in any tier</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${result.diagnostics?.resolverDecision ? `
                                <div class="bg-gradient-to-br from-cyan-50 to-blue-50 rounded-lg p-4 border-2 border-cyan-400 mt-3">
                                    <div class="font-bold text-cyan-900 mb-3 flex items-center gap-2">
                                        <i class="fas fa-brain"></i>
                                        üéØ Dual-Intent Resolver
                                    </div>
                                    <div class="grid grid-cols-3 gap-3 mb-3">
                                        <div class="bg-white rounded-lg p-3 border-2 border-orange-300">
                                            <div class="text-xs text-gray-600 mb-1">Problem Score</div>
                                            <div class="text-2xl font-bold text-orange-700">${(parseFloat(result.diagnostics.resolverDecision.problemScore) * 100).toFixed(0)}%</div>
                                            <div class="text-xs text-gray-500 mt-1">Emergency keywords</div>
                                        </div>
                                        <div class="bg-white rounded-lg p-3 border-2 border-green-300">
                                            <div class="text-xs text-gray-600 mb-1">Action Score</div>
                                            <div class="text-2xl font-bold text-green-700">${(parseFloat(result.diagnostics.resolverDecision.actionScore) * 100).toFixed(0)}%</div>
                                            <div class="text-xs text-gray-500 mt-1">Booking keywords</div>
                                        </div>
                                        <div class="bg-white rounded-lg p-3 border-2 border-purple-300">
                                            <div class="text-xs text-gray-600 mb-1">Delta (Œî)</div>
                                            <div class="text-2xl font-bold text-purple-700">${(parseFloat(result.diagnostics.resolverDecision.delta) * 100).toFixed(0)}%</div>
                                            <div class="text-xs text-gray-500 mt-1">Confidence gap</div>
                                        </div>
                                    </div>
                                    <div class="bg-white rounded-lg p-3 border-2 border-cyan-300">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-xs font-bold text-cyan-900">üõ£Ô∏è Route Decision:</div>
                                            <span class="px-3 py-1 rounded-full text-sm font-bold ${
                                                result.diagnostics.resolverDecision.route === 'emergency' ? 'bg-red-600 text-white' :
                                                result.diagnostics.resolverDecision.route === 'clarify' ? 'bg-yellow-500 text-white' :
                                                'bg-green-600 text-white'
                                            }">
                                                ${result.diagnostics.resolverDecision.route.toUpperCase()}
                                            </span>
                                        </div>
                                        <div class="text-sm text-gray-700 mb-2">
                                            ${escapeHtml(result.diagnostics.resolverDecision.reasoning)}
                                        </div>
                                        ${result.diagnostics.resolverDecision.needsClarifier ? `
                                        <div class="mt-3 p-3 bg-yellow-50 border-2 border-yellow-400 rounded-lg">
                                            <div class="text-xs font-bold text-yellow-900 mb-2 flex items-center gap-2">
                                                <i class="fas fa-comment-dots"></i>
                                                üí¨ Clarifier Prompt (will ask user):
                                            </div>
                                            <div class="text-sm italic text-yellow-900">
                                                "${escapeHtml(result.diagnostics.resolverDecision.clarifierPrompt)}"
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                ` : ''}
                                
                            ${!result.matched && result.diagnostics?.reasonCodes && result.diagnostics.reasonCodes.length > 0 ? `
                            <div class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-lg p-4 border-2 border-purple-400 mt-3">
                                <div class="font-bold text-purple-900 mb-3 flex items-center gap-2">
                                    <i class="fas fa-microscope"></i>
                                    üî¨ Root Cause Analysis
                                    <span class="text-xs font-normal bg-purple-200 px-2 py-1 rounded">${result.diagnostics.reasonCodes.length} reason${result.diagnostics.reasonCodes.length > 1 ? 's' : ''}</span>
                                </div>
                                ${result.diagnostics.reasonCodes.map((reason, idx) => `
                                    <div class="mb-3 p-4 rounded-lg ${
                                        reason.severity === 'critical' ? 'bg-red-100 border-2 border-red-500' :
                                        reason.severity === 'high' ? 'bg-orange-100 border-2 border-orange-500' :
                                        reason.severity === 'medium' ? 'bg-yellow-100 border-2 border-yellow-500' :
                                        reason.severity === 'success' ? 'bg-green-100 border-2 border-green-500' :
                                        'bg-blue-100 border-2 border-blue-500'
                                    }">
                                        <div class="flex items-start justify-between mb-2">
                                            <div class="text-sm font-bold ${
                                                reason.severity === 'critical' ? 'text-red-900' :
                                                reason.severity === 'high' ? 'text-orange-900' :
                                                reason.severity === 'medium' ? 'text-yellow-900' :
                                                reason.severity === 'success' ? 'text-green-900' :
                                                'text-blue-900'
                                            }">
                                                ${reason.severity === 'critical' ? 'üö® CRITICAL' : 
                                                  reason.severity === 'high' ? '‚ö†Ô∏è HIGH PRIORITY' : 
                                                  reason.severity === 'medium' ? '‚ö†Ô∏è MEDIUM' : 
                                                  reason.severity === 'success' ? '‚úÖ SUCCESS' :
                                                  '‚ÑπÔ∏è INFO'}
                                            </div>
                                            <code class="text-xs bg-white px-2 py-1 rounded">${escapeHtml(reason.code)}</code>
                                        </div>
                                        
                                        <div class="space-y-2 text-xs">
                                            <div>
                                                <strong class="text-gray-700">Message:</strong>
                                                <div class="mt-1 text-gray-900">${escapeHtml(reason.message)}</div>
                                            </div>
                                            
                                            ${reason.rootCause && reason.rootCause !== 'N/A' ? `
                                            <div>
                                                <strong class="text-gray-700">Root Cause:</strong>
                                                <div class="mt-1 text-gray-900 font-semibold">${escapeHtml(reason.rootCause)}</div>
                                            </div>
                                            ` : ''}
                                            
                                            ${reason.impact && reason.impact !== 'N/A' ? `
                                            <div>
                                                <strong class="text-gray-700">Impact:</strong>
                                                <div class="mt-1 text-gray-900">${escapeHtml(reason.impact)}</div>
                                            </div>
                                            ` : ''}
                                            
                                            ${reason.fix && reason.fix !== 'N/A' ? `
                                            <div class="mt-2 pt-2 border-t ${
                                                reason.severity === 'critical' ? 'border-red-300' :
                                                reason.severity === 'high' ? 'border-orange-300' :
                                                reason.severity === 'medium' ? 'border-yellow-300' :
                                                'border-blue-300'
                                            }">
                                                <strong class="text-gray-700">üí° Fix:</strong>
                                                <div class="mt-1 text-gray-900 font-semibold">${escapeHtml(reason.fix)}</div>
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                                
                                ${result.diagnostics.fixes && result.diagnostics.fixes.length > 0 ? `
                                <div class="mt-4 pt-4 border-t-2 border-purple-300">
                                    <div class="font-bold text-purple-900 mb-2 flex items-center gap-2">
                                        <i class="fas fa-magic"></i>
                                        ü™Ñ Fix Wizard
                                    </div>
                                    <div class="space-y-2">
                                        ${result.diagnostics.fixes.map(fix => `
                                            <div class="bg-white rounded-lg p-3 border-2 border-purple-300 flex items-start justify-between">
                                                <div class="flex-1">
                                                    <div class="font-semibold text-purple-900 text-sm">${escapeHtml(fix.title)}</div>
                                                    <div class="text-xs text-gray-700 mt-1">${escapeHtml(fix.description)}</div>
                                                    ${fix.expectedImpact ? `
                                                    <div class="text-xs text-green-700 mt-1 font-semibold">
                                                        <i class="fas fa-chart-line mr-1"></i>
                                                        ${escapeHtml(fix.expectedImpact)}
                                                    </div>
                                                    ` : ''}
                                                </div>
                                                ${fix.oneClick ? `
                                                <button onclick="applyFix('${fix.action}', '${result.diagnostics.input?.raw || ''}')" 
                                                        class="ml-3 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-xs font-bold whitespace-nowrap transition-colors">
                                                    <i class="fas fa-wand-magic-sparkles mr-1"></i>
                                                    Apply Now
                                                </button>
                                                ` : `
                                                <span class="ml-3 px-3 py-1 bg-gray-200 text-gray-600 rounded-lg text-xs font-semibold">
                                                    Manual
                                                </span>
                                                `}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}
                            
                            ${!result.matched && result.topCandidates && result.topCandidates.length > 0 ? `
                            <div class="bg-white rounded-lg p-3 border border-yellow-300 mt-3">
                                <div class="text-xs text-gray-600 mb-2">üéØ Close matches:</div>
                                ${result.topCandidates.slice(0, 3).map(cand => `
                                    <div class="text-sm">
                                        <span class="font-medium">${escapeHtml(cand.scenarioName || cand.scenarioId || 'Unknown')}</span>
                                        <span class="text-gray-600">(${Math.round((cand.confidence || 0) * 100)}%)</span>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                                
                                ${result.analysis && (result.analysis.suggestions.length > 0 || result.analysis.insights.length > 0) ? `
                                <div class="mt-3 space-y-2">
                                    ${result.analysis.suggestions.map(sug => `
                                        <div class="bg-yellow-100 border-l-4 border-yellow-500 p-3 rounded">
                                            <div class="flex items-start justify-between">
                                                <div class="flex-1">
                                                    <div class="text-xs font-bold text-yellow-800 mb-1">
                                                        üí° ${sug.priority === 'high' ? 'üî• HIGH PRIORITY' : 'SUGGESTION'}
                                                    </div>
                                                    <div class="text-sm text-yellow-900">${escapeHtml(sug.message)}</div>
                                                    ${sug.expectedBoost ? `<div class="text-xs text-yellow-700 mt-1">Expected boost: ${sug.expectedBoost}</div>` : ''}
                                                </div>
                                                ${sug.type === 'add_keyword' ? `
                                                <button onclick="quickAddKeyword('${sug.scenarioId}', ${JSON.stringify(sug.keywords).replace(/"/g, '&quot;')})" class="ml-2 px-3 py-1 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-xs font-semibold whitespace-nowrap">
                                                    Quick Add
                                                </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                    
                                    ${result.analysis.insights.map(ins => `
                                        <div class="bg-green-100 border-l-4 border-green-500 p-2 rounded">
                                            <div class="text-xs text-green-800">‚úÖ ${escapeHtml(ins.message)}</div>
                                        </div>
                                    `).join('')}
                                    
                                    ${result.analysis.issues.map(iss => `
                                        <div class="bg-red-100 border-l-4 border-red-500 p-2 rounded">
                                            <div class="text-xs font-bold text-red-800">‚ö†Ô∏è ${escapeHtml(iss.message)}</div>
                                            ${iss.suggestion ? `<div class="text-xs text-red-700 mt-1">${escapeHtml(iss.suggestion)}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="ml-4">
                                <button onclick="toggleTestDetails(${index})" class="px-3 py-1.5 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm">
                                    <i class="fas fa-chevron-down" id="test-detail-icon-${index}"></i>
                                </button>
                            </div>
                        </div>
                        
                    <div id="test-details-${index}" class="hidden mt-4 pt-4 border-t border-${statusColor}-200">
                        <div class="text-sm space-y-4">
                            <div><strong>Call SID:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-xs">${result.callSid || 'N/A'}</code></div>
                            
                            ${result.diagnostics ? `
                            
                            <!-- INPUT LAYER -->
                            <div class="bg-blue-50 rounded-lg p-4 border-2 border-blue-300">
                                <div class="font-bold text-blue-900 mb-3 flex items-center gap-2">
                                    <i class="fas fa-microphone"></i>
                                    üé§ Input Layer
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-xs">
                                    <div>
                                        <div class="text-gray-600">Raw ASR Text:</div>
                                        <div class="font-mono bg-white p-2 rounded border">"${escapeHtml(result.diagnostics.input?.raw || '')}"</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-600">Normalized:</div>
                                        <div class="font-mono bg-white p-2 rounded border">"${escapeHtml(result.diagnostics.input?.normalized || '')}"</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-600">Content Terms:</div>
                                        <div class="bg-white p-2 rounded border">
                                            ${result.diagnostics.input?.phraseTerms && result.diagnostics.input.phraseTerms.length > 0 
                                                ? result.diagnostics.input.phraseTerms.map(term => `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mr-1 mb-1 font-mono text-xs">${escapeHtml(term)}</span>`).join('')
                                                : '<span class="text-gray-400">None</span>'
                                            }
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-gray-600">Metadata:</div>
                                        <div class="bg-white p-2 rounded border space-y-1">
                                            <div>Channel: <span class="font-semibold">${result.diagnostics.input?.channel || 'unknown'}</span></div>
                                            <div>Language: <span class="font-semibold">${result.diagnostics.input?.detectedLanguage || 'en'}</span></div>
                                            <div>Term Count: <span class="font-semibold">${result.diagnostics.input?.termCount || 0}</span></div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${result.diagnostics.quality ? `
                                <div class="mt-3 pt-3 border-t border-blue-200">
                                    <div class="text-xs font-semibold text-gray-700 mb-2">Quality Flags:</div>
                                    <div class="flex flex-wrap gap-2">
                                        ${result.diagnostics.quality.shortUtterance ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs">‚ö†Ô∏è Short Utterance (‚â§3 words)</span>' : ''}
                                        ${result.diagnostics.quality.punctuationPresent ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs">‚ö†Ô∏è Punctuation Differences</span>' : ''}
                                        ${result.diagnostics.quality.stopWordsPresent ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">‚ÑπÔ∏è Stop Words Present</span>' : ''}
                                        ${result.diagnostics.quality.exactMatch ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">‚úÖ Exact Match</span>' : ''}
                                        ${result.diagnostics.quality.fuzzyMatch ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">‚úÖ Fuzzy Match</span>' : ''}
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${result.diagnostics.normalization ? `
                                <div class="mt-3 pt-3 border-t border-blue-200">
                                    <div class="text-xs font-semibold text-gray-700 mb-2">üìã Normalization Contract:</div>
                                    <div class="bg-white p-3 rounded border text-xs space-y-2">
                                        <div class="font-mono">
                                            <span class="text-gray-600">Before:</span> <span class="font-bold text-red-700">"${escapeHtml(result.diagnostics.normalization.before)}"</span>
                                        </div>
                                        <div class="text-center text-gray-400">‚Üì</div>
                                        <div class="space-y-1 pl-4 text-gray-600">
                                            ${result.diagnostics.normalization.transforms.map(t => 
                                                `<div>‚Ä¢ ${t.applied ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚úó</span>'} ${t.name} <span class="text-gray-400 text-xs">(${t.example})</span></div>`
                                            ).join('')}
                                        </div>
                                        <div class="text-center text-gray-400">‚Üì</div>
                                        <div class="font-mono">
                                            <span class="text-gray-600">After:</span> <span class="font-bold text-green-700">"${escapeHtml(result.diagnostics.normalization.after)}"</span>
                                        </div>
                                        ${result.diagnostics.normalization.removed ? `
                                        <div class="pt-2 border-t mt-2 text-xs text-gray-600">
                                            <span class="font-semibold">Removed:</span> 
                                            ${result.diagnostics.normalization.removed.punctuation !== 'none' ? `<span class="inline-block bg-yellow-100 px-1 rounded mr-1">Punctuation: "${result.diagnostics.normalization.removed.punctuation}"</span>` : ''}
                                            ${result.diagnostics.normalization.stopWordsFiltered && result.diagnostics.normalization.stopWordsFiltered.length > 0 ? `<span class="inline-block bg-blue-100 px-1 rounded mr-1">Stop words: ${result.diagnostics.normalization.stopWordsFiltered.join(', ')}</span>` : ''}
                                            ${result.diagnostics.normalization.removed.caseChanged ? '<span class="inline-block bg-green-100 px-1 rounded mr-1">Case normalized</span>' : ''}
                                            <span class="inline-block bg-gray-100 px-1 rounded">${result.diagnostics.normalization.removed.totalCharsRemoved} chars total</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- CANDIDATE GENERATION -->
                            <div class="bg-green-50 rounded-lg p-4 border-2 border-green-300">
                                <div class="font-bold text-green-900 mb-3 flex items-center gap-2">
                                    <i class="fas fa-search"></i>
                                    üîç Candidate Generation
                                </div>
                                <div class="grid grid-cols-3 gap-4 text-xs mb-3">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-gray-900">${result.diagnostics.candidates?.totalScenarios || 0}</div>
                                        <div class="text-gray-600">Total Scenarios</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-green-700">${result.diagnostics.candidates?.eligible || 0}</div>
                                        <div class="text-gray-600">Eligible</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-red-700">${result.diagnostics.candidates?.blocked || 0}</div>
                                        <div class="text-gray-600">Blocked</div>
                                    </div>
                                </div>
                                
                                ${result.diagnostics.candidates?.tokenMapping ? `
                                <div class="mt-3 pt-3 border-t border-green-200">
                                    <div class="text-xs font-semibold text-gray-700 mb-2">üéØ Token Mapping (Best Candidate):</div>
                                    <div class="bg-white p-3 rounded border space-y-2">
                                        <div>
                                            <strong>Phrase Tokens:</strong>
                                            <div class="mt-1">
                                                ${result.diagnostics.candidates.tokenMapping.phraseTokens.map(token => `
                                                    <span class="inline-block px-2 py-1 mr-1 mb-1 rounded text-xs font-mono ${
                                                        result.diagnostics.candidates.tokenMapping.matchedTokens.includes(token)
                                                            ? 'bg-green-100 text-green-800 font-bold'
                                                            : 'bg-red-100 text-red-800'
                                                    }">${escapeHtml(token)}</span>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <div>
                                            <strong>Trigger Tokens:</strong>
                                            <div class="mt-1">
                                                ${result.diagnostics.candidates.tokenMapping.triggerTokens.map(token => `
                                                    <span class="inline-block px-2 py-1 mr-1 mb-1 rounded text-xs font-mono ${
                                                        result.diagnostics.candidates.tokenMapping.matchedTokens.includes(token)
                                                            ? 'bg-green-100 text-green-800 font-bold'
                                                            : 'bg-gray-100 text-gray-600'
                                                    }">${escapeHtml(token)}</span>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center pt-2 border-t">
                                            <span><strong>Token Overlap:</strong></span>
                                            <span class="text-lg font-bold ${
                                                result.diagnostics.candidates.tokenMapping.overlapPercent >= 70 ? 'text-green-700' :
                                                result.diagnostics.candidates.tokenMapping.overlapPercent >= 40 ? 'text-yellow-700' :
                                                'text-red-700'
                                            }">${result.diagnostics.candidates.tokenMapping.overlapPercent.toFixed(0)}%</span>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- FILTERS & DECISION -->
                            <div class="bg-orange-50 rounded-lg p-4 border-2 border-orange-300">
                                <div class="font-bold text-orange-900 mb-3 flex items-center gap-2">
                                    <i class="fas fa-filter"></i>
                                    üéöÔ∏è Filters & Decision
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-xs">
                                    <div class="bg-white p-3 rounded border">
                                        <div class="font-semibold mb-2">Final Score:</div>
                                        <div class="text-3xl font-bold ${
                                            result.diagnostics.decision?.aboveThreshold ? 'text-green-700' : 'text-red-700'
                                        }">${((result.diagnostics.decision?.finalScore || 0) * 100).toFixed(0)}%</div>
                                        <div class="text-gray-600 mt-1">Threshold: ${((result.diagnostics.decision?.threshold || 0.45) * 100).toFixed(0)}%</div>
                                        ${result.diagnostics.decision?.margin !== undefined ? `
                                        <div class="mt-2 pt-2 border-t">
                                            <strong>Margin:</strong> 
                                            <span class="${result.diagnostics.decision.margin >= 0 ? 'text-green-700' : 'text-red-700'} font-bold">
                                                ${result.diagnostics.decision.margin >= 0 ? '+' : ''}${(result.diagnostics.decision.margin * 100).toFixed(0)}%
                                            </span>
                                        </div>
                                        ` : ''}
                                    </div>
                                    <div class="bg-white p-3 rounded border">
                                        <div class="font-semibold mb-2">Filter Status:</div>
                                        <div class="space-y-1">
                                            <div class="flex justify-between">
                                                <span>Negative Triggers:</span>
                                                <span class="font-bold ${result.diagnostics.filters?.negativeTriggersBlocked > 0 ? 'text-red-700' : 'text-green-700'}">
                                                    ${result.diagnostics.filters?.negativeTriggersBlocked > 0 ? `‚ùå ${result.diagnostics.filters.negativeTriggersBlocked} blocked` : '‚úÖ Pass'}
                                                </span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Preconditions:</span>
                                                <span class="font-bold ${result.diagnostics.filters?.preconditionsFailed ? 'text-red-700' : 'text-green-700'}">
                                                    ${result.diagnostics.filters?.preconditionsFailed ? '‚ùå Failed' : '‚úÖ Pass'}
                                                </span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Cooldown:</span>
                                                <span class="font-bold ${result.diagnostics.filters?.cooldownActive ? 'text-red-700' : 'text-green-700'}">
                                                    ${result.diagnostics.filters?.cooldownActive ? '‚ùå Active' : '‚úÖ Pass'}
                                                </span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Channel/Lang:</span>
                                                <span class="font-bold ${result.diagnostics.filters?.channelMismatch || result.diagnostics.filters?.languageMismatch ? 'text-red-700' : 'text-green-700'}">
                                                    ${result.diagnostics.filters?.channelMismatch || result.diagnostics.filters?.languageMismatch ? '‚ùå Mismatch' : '‚úÖ Match'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ` : ''}
                            
                            ${result.timing ? `
                            <div class="bg-blue-50 rounded-lg p-4 border-2 border-blue-300">
                                <div class="font-bold text-blue-900 mb-3 flex items-center gap-2">
                                    <i class="fas fa-stopwatch"></i>
                                    ‚è±Ô∏è Performance Breakdown
                                </div>
                                <ul class="space-y-1 text-xs">
                                    ${result.timing.normalize ? `<li class="flex justify-between"><span>Normalize:</span><span class="font-mono">${result.timing.normalize}ms</span></li>` : ''}
                                    ${result.timing.filter ? `<li class="flex justify-between"><span>Filter:</span><span class="font-mono">${result.timing.filter}ms</span></li>` : ''}
                                    ${result.timing.scoring ? `<li class="flex justify-between"><span>Scoring:</span><span class="font-mono">${result.timing.scoring}ms</span></li>` : ''}
                                    ${result.timing.selection ? `<li class="flex justify-between"><span>Selection:</span><span class="font-mono">${result.timing.selection}ms</span></li>` : ''}
                                    <li class="flex justify-between font-bold text-base pt-2 border-t-2 border-blue-300">
                                        <span>Total:</span>
                                        <span class="font-mono">${result.timing.total}ms ${result.timing.total < 50 ? '‚ö° EXCELLENT' : result.timing.total < 100 ? '‚úÖ GOOD' : '‚ö†Ô∏è SLOW'}</span>
                                    </li>
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function toggleTestDetails(index) {
            const details = document.getElementById(`test-details-${index}`);
            const icon = document.getElementById(`test-detail-icon-${index}`);
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                details.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }
        
        function renderTestLogError(message) {
            const container = document.getElementById('test-log-content');
            container.innerHTML = `
                <div class="text-center py-12 text-red-600">
                    <i class="fas fa-exclamation-circle text-6xl mb-4"></i>
                    <p class="text-lg font-semibold">Error Loading Test Results</p>
                    <p class="text-sm">${escapeHtml(message)}</p>
                </div>
            `;
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 10) return 'Just now';
            if (seconds < 60) return `${seconds} seconds ago`;
            
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            
            const days = Math.floor(hours / 24);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }
        
        // ============================================
        // üß™ LIVE TEST MONITOR - Real-time Results Right Where You Need Them!
        // ============================================
        
        async function refreshLiveTestMonitor() {
            if (!activeTemplateId) {
                console.log('‚ö†Ô∏è [LIVE TEST MONITOR] No active template');
                return;
            }
            
            try {
                console.log(`üß™ [LIVE TEST MONITOR] Fetching last 3 tests for template ${activeTemplateId}...`);
                const token = getAuthToken();
                
                const response = await fetch(`/api/twilio/test-results/${activeTemplateId}?limit=3`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`üß™ [LIVE TEST MONITOR] Loaded ${data.count} tests`);
                    renderLiveTestMonitor(data.results);
                    
                    // Also update the test phone number
                    const phoneDisplay = document.getElementById('live-test-phone-display');
                    if (phoneDisplay && window.globalTwilioTestConfig?.phoneNumber) {
                        phoneDisplay.textContent = window.globalTwilioTestConfig.phoneNumber;
                    }
                } else {
                    console.error('‚ùå [LIVE TEST MONITOR] Failed to load');
                }
            } catch (error) {
                console.error('‚ùå [LIVE TEST MONITOR] Error:', error);
            }
        }
        
        // ============================================================================
        // üé® COLOR-CODED TRANSCRIPT HELPERS
        // ============================================================================
        
        /**
         * Generate color-coded transcript HTML from test result
         * Colors indicate how AI understood each word:
         * üîµ BLUE = Filler (ignored)
         * üü¢ GREEN = Synonym (translated)
         * üü° YELLOW = Keyword (context)
         * üî¥ RED = Trigger (caused match)
         * üü£ PURPLE = LLM suggestion (should add)
         */
        function generateColorCodedTranscript(result) {
            // Check if we have enterprise analysis with colored transcript
            if (result.enterpriseAnalysis?.coloredTranscript) {
                const colored = result.enterpriseAnalysis.coloredTranscript;
                
                // If we have pre-generated HTML, use it
                if (colored.html) {
                    return colored.html;
                }
                
                // Otherwise, generate from coloredWords array
                if (colored.coloredWords && Array.isArray(colored.coloredWords)) {
                    return colored.coloredWords.map(wordObj => {
                        const colorClass = getColorClass(wordObj.colorName || wordObj.classification);
                        const tooltip = escapeHtml(wordObj.tooltip || wordObj.reason || '');
                        return `<span class="${colorClass}" title="${tooltip}">${escapeHtml(wordObj.word || wordObj.original)}</span>`;
                    }).join(' ');
                }
            }
            
            // Fallback: Simple phrase display without coloring
            return escapeHtml(result.phrase || 'No transcript available');
        }
        
        /**
         * Get CSS class for word color coding
         */
        function getColorClass(classification) {
            const colorMap = {
                'TRIGGER': 'text-red-700 font-bold',
                'trigger': 'text-red-700 font-bold',
                'SYNONYM': 'text-green-700 font-semibold',
                'synonym': 'text-green-700 font-semibold',
                'KEYWORD': 'text-yellow-700 font-semibold',
                'keyword': 'text-yellow-700 font-semibold',
                'FILLER': 'text-blue-500',
                'filler': 'text-blue-500',
                'SUGGESTION': 'text-purple-700 font-bold underline',
                'suggestion': 'text-purple-700 font-bold underline',
                'CONTEXT': 'text-gray-700',
                'context': 'text-gray-700'
            };
            
            return colorMap[classification] || 'text-gray-700';
        }
        
        /**
         * Get priority badge HTML
         */
        function getPriorityBadge(priority) {
            const priorityUpper = (priority || 'MEDIUM').toUpperCase();
            
            const badges = {
                'CRITICAL': '<span class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded">üî• CRITICAL</span>',
                'HIGH': '<span class="px-2 py-1 bg-orange-500 text-white text-xs font-bold rounded">‚ö†Ô∏è HIGH</span>',
                'MEDIUM': '<span class="px-2 py-1 bg-yellow-500 text-white text-xs font-bold rounded">üìå MEDIUM</span>',
                'LOW': '<span class="px-2 py-1 bg-blue-500 text-white text-xs font-bold rounded">‚ÑπÔ∏è LOW</span>'
            };
            
            return badges[priorityUpper] || badges['MEDIUM'];
        }
        
        // ============================================================================
        // üß™ LIVE TEST MONITOR - MAIN RENDERER
        // ============================================================================
        
        /**
         * ============================================================================
         * RENDER LIVE TEST MONITOR - ENTERPRISE EDITION
         * ============================================================================
         * Enhanced version with:
         * - Color-coded transcripts (üîµüü¢üü°üî¥üü£)
         * - Enterprise analysis display
         * - Priority suggestions
         * - Conflict warnings
         * ============================================================================
         */
        function renderLiveTestMonitor(results) {
            console.log('üé® [LIVE TEST MONITOR] Rendering', results.length, 'results');
            
            const emptyState = document.getElementById('live-test-empty-state');
            const resultsGrid = document.getElementById('live-test-results-grid');
            const suggestionsPanel = document.getElementById('live-test-suggestions-panel');
            const suggestionsContent = document.getElementById('live-test-suggestions-content');
            const testCount = document.getElementById('live-test-count');
            
            if (results.length === 0) {
                emptyState.classList.remove('hidden');
                resultsGrid.classList.add('hidden');
                suggestionsPanel.classList.add('hidden');
                testCount.textContent = '0 tests';
                return;
            }
            
            // Hide empty state, show results
            emptyState.classList.add('hidden');
            resultsGrid.classList.remove('hidden');
            testCount.textContent = `${results.length} test${results.length > 1 ? 's' : ''}`;
            
            // ============================================
            // RENDER TEST RESULTS WITH ENTERPRISE FEATURES
            // ============================================
            resultsGrid.innerHTML = results.map((result, index) => {
                const timeAgo = getTimeAgo(new Date(result.timestamp));
                const confidencePercent = Math.round(result.confidence * 100);
                const statusColor = result.matched ? 'green' : 'red';
                const statusIcon = result.matched ? '‚úÖ' : '‚ùå';
                
                // Check if enterprise analysis is available
                const hasEnterpriseAnalysis = result.enterpriseAnalysis && result.enterpriseAnalysis.analyzed;
                const enterpriseMode = result.enterpriseAnalysis?.mode || 'BASIC';
                
                // Generate color-coded transcript HTML
                const transcriptHTML = generateColorCodedTranscript(result);
                
                // Get AI response time if available
                const aiResponseTime = result.timing?.ai || result.timing?.llm || null;
                
                return `
                    <div class="bg-white rounded-lg border-2 border-${statusColor}-200 p-5 shadow-md hover:shadow-xl transition-all">
                        <!-- Header Row -->
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3 flex-1">
                                <span class="text-2xl">${statusIcon}</span>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <div class="font-bold text-${statusColor}-800">${result.matched ? 'MATCHED' : 'NO MATCH'}</div>
                                        ${hasEnterpriseAnalysis ? `
                                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs font-bold rounded-full border border-purple-300">
                                                ${enterpriseMode} MODE
                                            </span>
                                        ` : ''}
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1">${timeAgo}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-bold text-${statusColor}-700">${confidencePercent}%</div>
                                ${aiResponseTime ? `<div class="text-xs text-gray-600">‚ö° ${aiResponseTime}ms</div>` : ''}
                                ${result.timing?.total ? `<div class="text-xs text-gray-500">${result.timing.total}ms total</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- Color-Coded Transcript -->
                        <div class="mb-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="text-xs font-semibold text-gray-600 mb-2 flex items-center gap-2">
                                <i class="fas fa-comments"></i>
                                TRANSCRIPT (Color-Coded Analysis):
                            </div>
                            <div class="text-sm leading-relaxed">
                                ${transcriptHTML}
                            </div>
                        </div>
                        
                        <!-- Matched Scenario -->
                        ${result.matched && result.scenario ? `
                            <div class="mb-3 p-3 bg-${statusColor}-50 rounded-lg border border-${statusColor}-200">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-bullseye text-${statusColor}-600"></i>
                                    <div class="font-semibold text-${statusColor}-900">Matched Scenario:</div>
                                    <div class="text-${statusColor}-800">${escapeHtml(result.scenario.name)}</div>
                                </div>
                                ${result.scenario.category ? `
                                    <div class="text-xs text-${statusColor}-700 mt-1 ml-6">
                                        Category: ${escapeHtml(result.scenario.category)}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- Enterprise Suggestions (if any) -->
                        ${hasEnterpriseAnalysis && result.enterpriseAnalysis.suggestions?.length > 0 ? `
                            <div class="mt-3 p-3 bg-purple-50 rounded-lg border border-purple-200">
                                <div class="text-xs font-semibold text-purple-800 mb-3 flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-magic"></i>
                                        AI SUGGESTIONS (${result.enterpriseAnalysis.suggestions.length}):
                                    </div>
                                    <button onclick="applyAllHighPrioritySuggestions()" 
                                            class="px-2 py-1 bg-orange-600 hover:bg-orange-700 text-white rounded text-xs font-bold flex items-center gap-1 transition-all"
                                            title="Apply all high priority suggestions">
                                        <i class="fas fa-bolt"></i>
                                        Apply High Priority
                                    </button>
                                </div>
                                <div class="space-y-2">
                                    ${result.enterpriseAnalysis.suggestions.slice(0, 3).map((sug, idx) => `
                                        <div class="text-xs bg-white p-2 rounded border border-purple-200 flex items-start justify-between gap-2">
                                            <div class="flex-1">
                                                <span class="font-semibold text-purple-900">${getPriorityBadge(sug.priority)}</span>
                                                <span class="text-gray-800">${escapeHtml(sug.description || sug.reason || 'No description')}</span>
                                            </div>
                                            <button onclick='showImpactSimulator(${JSON.stringify(sug).replace(/'/g, "\\'")}, {confidence: ${result.confidence}, tier: ${result.tier || 3}})' 
                                                    class="px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs font-bold whitespace-nowrap transition-all flex items-center gap-1"
                                                    title="Show predicted impact">
                                                <i class="fas fa-magic"></i>
                                                Impact
                                            </button>
                                        </div>
                                    `).join('')}
                                    ${result.enterpriseAnalysis.suggestions.length > 3 ? `
                                        <div class="text-xs text-purple-600 font-semibold text-center">
                                            + ${result.enterpriseAnalysis.suggestions.length - 3} more suggestions
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Conflicts (if any) -->
                        ${hasEnterpriseAnalysis && result.enterpriseAnalysis.conflicts?.length > 0 ? `
                            <div class="mt-3 p-3 bg-red-50 rounded-lg border border-red-200">
                                <div class="text-xs font-semibold text-red-800 mb-2 flex items-center gap-2">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    CONFLICTS DETECTED (${result.enterpriseAnalysis.conflicts.length}):
                                </div>
                                <div class="space-y-2">
                                    ${result.enterpriseAnalysis.conflicts.slice(0, 2).map(conflict => `
                                        <div class="text-xs bg-white p-2 rounded border border-red-200">
                                            <span class="font-semibold text-red-900">${conflict.severity || 'WARNING'}:</span>
                                            <span class="text-gray-800">${escapeHtml(conflict.description || 'Conflict detected')}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            // Collect ALL suggestions from all results
            const allSuggestions = [];
            results.forEach(result => {
                if (result.analysis && result.analysis.suggestions) {
                    result.analysis.suggestions.forEach(sug => {
                        allSuggestions.push({
                            ...sug,
                            fromPhrase: result.phrase
                        });
                    });
                }
            });
            
            // Show suggestions panel if any exist
            if (allSuggestions.length > 0) {
                suggestionsPanel.classList.remove('hidden');
                suggestionsContent.innerHTML = allSuggestions.map(sug => `
                    <div class="bg-white rounded-lg border-2 border-yellow-300 p-4 shadow-sm">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <div class="text-sm font-bold text-yellow-900 mb-1">
                                    üí° ${sug.priority === 'high' ? 'üî• HIGH PRIORITY' : 'SUGGESTION'}
                                </div>
                                <div class="text-sm text-yellow-900 mb-2">${escapeHtml(sug.message)}</div>
                                ${sug.fromPhrase ? `
                                    <div class="text-xs text-yellow-700 bg-yellow-50 px-2 py-1 rounded inline-block">
                                        From: "${escapeHtml(sug.fromPhrase.substring(0, 50))}..."
                                    </div>
                                ` : ''}
                                ${sug.expectedBoost ? `
                                    <div class="text-xs text-green-700 mt-2 font-semibold">
                                        üìà Expected boost: ${sug.expectedBoost}
                                    </div>
                                ` : ''}
                            </div>
                            ${sug.type === 'add_keyword' && sug.keywords ? `
                                <button onclick="quickAddKeyword('${sug.scenarioId}', ${JSON.stringify(sug.keywords).replace(/"/g, '&quot;')})" 
                                        class="ml-3 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg text-xs font-bold whitespace-nowrap transition-colors shadow-sm">
                                    Quick Add
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                suggestionsPanel.classList.add('hidden');
            }
        }
        
        function clearLiveTestMonitor() {
            console.log('üßπ [LIVE TEST MONITOR] Clearing display...');
            
            const emptyState = document.getElementById('live-test-empty-state');
            const resultsGrid = document.getElementById('live-test-results-grid');
            const suggestionsPanel = document.getElementById('live-test-suggestions-panel');
            const testCount = document.getElementById('live-test-count');
            
            // Show empty state
            emptyState.classList.remove('hidden');
            resultsGrid.classList.add('hidden');
            suggestionsPanel.classList.add('hidden');
            testCount.textContent = '0 tests';
            
            // Update phone number display
            const phoneDisplay = document.getElementById('live-test-phone-display');
            if (phoneDisplay && window.globalTwilioTestConfig?.phoneNumber) {
                phoneDisplay.textContent = window.globalTwilioTestConfig.phoneNumber;
            } else {
                phoneDisplay.textContent = 'Loading...';
            }
            
            console.log('‚úÖ [LIVE TEST MONITOR] Display cleared - ready for fresh tests!');
        }
        
        // ============================================
        // üìã COPY FULL TEST REPORT
        // ============================================
        // Generates a comprehensive, developer-friendly report
        // that can be pasted to AI for analysis and improvement suggestions
        // ============================================
        
        async function copyLiveTestReport() {
            try {
                console.log('üìã [COPY REPORT] Generating full test report...');
                
                if (!activeTemplateId) {
                    if (window.ToastManager) {
                        window.ToastManager.warning('‚ö†Ô∏è No template selected');
                    }
                    return;
                }
                
                // Fetch all test results (not just last 3)
                const token = getAuthToken();
                const response = await fetch(`/api/twilio/test-results/${activeTemplateId}?limit=20`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (!data.success || !data.results || data.results.length === 0) {
                    if (window.ToastManager) {
                        window.ToastManager.warning('‚ö†Ô∏è No test results to copy');
                    }
                    return;
                }
                
                // Generate comprehensive report
                const report = generateTestReport(data.results);
                
                // Copy to clipboard
                await navigator.clipboard.writeText(report);
                
                if (window.ToastManager) {
                    window.ToastManager.success(`‚úÖ Report copied! (${data.results.length} tests)`);
                }
                console.log('‚úÖ [COPY REPORT] Report copied to clipboard');
                
            } catch (error) {
                console.error('‚ùå [COPY REPORT] Error:', error);
                if (window.ToastManager) {
                    window.ToastManager.error('‚ùå Failed to copy report');
                }
            }
        }
        
        function generateTestReport(results) {
            const template = activeTemplate || {};
            const timestamp = new Date().toISOString();
            
            // Calculate stats
            const totalTests = results.length;
            const matched = results.filter(r => r.matched).length;
            const failed = totalTests - matched;
            const matchRate = ((matched / totalTests) * 100).toFixed(1);
            const avgConfidence = (results.reduce((sum, r) => sum + (r.confidence || 0), 0) / totalTests * 100).toFixed(1);
            
            // Collect all unique suggestions
            const allSuggestions = new Map();
            results.forEach(result => {
                if (result.analysis && result.analysis.suggestions) {
                    result.analysis.suggestions.forEach(sug => {
                        const key = `${sug.type}-${sug.suggestion}`;
                        if (!allSuggestions.has(key)) {
                            allSuggestions.set(key, sug);
                        }
                    });
                }
            });
            
            // Build report
            let report = '';
            
            // Header
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += 'üß™ LIVE TEST MONITOR - FULL REPORT\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            
            // Template Info
            report += 'üìã TEMPLATE INFORMATION:\n';
            report += `   Name: ${template.name || 'Unknown'}\n`;
            report += `   ID: ${activeTemplateId}\n`;
            report += `   Categories: ${template.categories?.length || 0}\n`;
            report += `   Generated: ${timestamp}\n\n`;
            
            // Overall Stats
            report += 'üìä OVERALL PERFORMANCE:\n';
            report += `   Total Tests: ${totalTests}\n`;
            report += `   ‚úÖ Matched: ${matched} (${matchRate}%)\n`;
            report += `   ‚ùå Failed: ${failed} (${(100 - matchRate).toFixed(1)}%)\n`;
            report += `   üìà Avg Confidence: ${avgConfidence}%\n\n`;
            
            // Test Results Detail
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += 'üìù TEST RESULTS (Most Recent First):\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            
            results.forEach((result, index) => {
                const status = result.matched ? '‚úÖ MATCHED' : '‚ùå NO MATCH';
                const confidence = `${(result.confidence * 100).toFixed(0)}%`;
                const timeAgo = formatTimeAgo(new Date(result.timestamp));
                
                report += `TEST #${index + 1} - ${status} (${confidence} confidence) - ${timeAgo}\n`;
                report += `   üìû Said: "${result.phrase}"\n`;
                
                if (result.matched) {
                    report += `   ‚û°Ô∏è  Matched: "${result.matchedScenario?.name || 'Unknown'}"\n`;
                    if (result.timing) {
                        report += `   ‚ö° Speed: ${result.timing.total || 0}ms\n`;
                    }
                } else {
                    report += `   ‚ö†Ô∏è  No scenario matched - confidence too low\n`;
                }
                
                // Show suggestions for this specific test
                if (result.analysis && result.analysis.suggestions && result.analysis.suggestions.length > 0) {
                    report += `   üí° Suggestions (${result.analysis.suggestions.length}):\n`;
                    result.analysis.suggestions.forEach(sug => {
                        report += `      - ${sug.suggestion}\n`;
                    });
                }
                
                report += '\n';
            });
            
            // AI Improvement Suggestions Summary
            if (allSuggestions.size > 0) {
                report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                report += 'üí° AI IMPROVEMENT SUGGESTIONS (Aggregated):\n';
                report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
                
                const suggestionsByType = {
                    'missing_filler': [],
                    'missing_synonym': [],
                    'missing_scenario': [],
                    'missing_keyword': [],
                    'missing_negative_keyword': []
                };
                
                allSuggestions.forEach(sug => {
                    if (suggestionsByType[sug.type]) {
                        suggestionsByType[sug.type].push(sug);
                    }
                });
                
                Object.entries(suggestionsByType).forEach(([type, suggestions]) => {
                    if (suggestions.length > 0) {
                        const typeLabel = type.replace('missing_', '').replace('_', ' ').toUpperCase();
                        report += `üî∏ ${typeLabel} (${suggestions.length}):\n`;
                        suggestions.forEach(sug => {
                            report += `   ‚Ä¢ ${sug.suggestion}\n`;
                        });
                        report += '\n';
                    }
                });
            } else {
                report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                report += '‚úÖ NO AI SUGGESTIONS - Template performing well!\n';
                report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            }
            
            // Footer
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += 'üìå HOW TO USE THIS REPORT:\n';
            report += '   1. Review failed tests and low confidence matches\n';
            report += '   2. Check AI suggestions for quick improvements\n';
            report += '   3. Add missing fillers/synonyms to improve matching\n';
            report += '   4. Create new scenarios for common unmatched phrases\n';
            report += '   5. Share with AI assistant for deeper analysis\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            
            return report;
        }
        
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }
        
        // Auto-refresh Live Test Monitor when template changes
        // (Will be called by switchDashboardTemplate)
        
        // ============================================
        // üìä TEMPLATE HEALTH METRICS
        // ============================================
        
        function calculateTemplateHealth(results) {
            const health = {
                totalTests: results.length,
                matchRate: 0,
                avgConfidence: 0,
                avgSpeed: 0,
                fastTests: 0,
                slowTests: 0,
                highPrioritySuggestions: 0,
                totalSuggestions: 0,
                excellentTests: 0,
                failedTests: 0
            };
            
            let totalConfidence = 0;
            let totalSpeed = 0;
            let speedCount = 0;
            
            results.forEach(result => {
                // Match rate
                if (result.matched) health.matchRate++;
                
                // Confidence
                totalConfidence += result.confidence || 0;
                
                // Speed
                if (result.timing && result.timing.total) {
                    totalSpeed += result.timing.total;
                    speedCount++;
                    
                    if (result.timing.total < 50) health.fastTests++;
                    if (result.timing.total > 100) health.slowTests++;
                }
                
                // Suggestions
                if (result.analysis) {
                    health.totalSuggestions += result.analysis.suggestions.length;
                    result.analysis.suggestions.forEach(sug => {
                        if (sug.priority === 'high') health.highPrioritySuggestions++;
                    });
                }
                
                // Quality
                if (result.matched && result.confidence > 0.70 && result.timing?.total < 50) {
                    health.excellentTests++;
                }
                
                if (!result.matched && result.confidence < 0.30) {
                    health.failedTests++;
                }
            });
            
            health.matchRate = (health.matchRate / health.totalTests) * 100;
            health.avgConfidence = (totalConfidence / health.totalTests) * 100;
            health.avgSpeed = speedCount > 0 ? Math.round(totalSpeed / speedCount) : 0;
            
            return health;
        }
        
        function renderHealthSummary(health) {
            const container = document.getElementById('template-health-summary');
            
            // Calculate overall score (0-10)
            let score = 0;
            score += (health.matchRate / 100) * 4; // Match rate = 40%
            score += (health.avgConfidence / 100) * 3; // Avg confidence = 30%
            score += (health.avgSpeed < 50 ? 2 : health.avgSpeed < 100 ? 1 : 0); // Speed = 20%
            score += (health.highPrioritySuggestions === 0 ? 1 : 0); // No urgent issues = 10%
            
            const scoreText = score.toFixed(1);
            const scoreColor = score >= 8 ? 'green' : score >= 6 ? 'yellow' : 'red';
            const scoreEmoji = score >= 8 ? 'üèÜ' : score >= 6 ? '‚≠ê' : '‚ö†Ô∏è';
            
            container.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="text-center">
                            <div class="text-4xl font-bold text-${scoreColor}-600">${scoreEmoji} ${scoreText}</div>
                            <div class="text-xs text-gray-600">Health Score</div>
                        </div>
                        
                        <div class="h-16 w-px bg-gray-300"></div>
                        
                        <div class="grid grid-cols-4 gap-6">
                            <div>
                                <div class="text-2xl font-bold ${health.matchRate >= 80 ? 'text-green-600' : health.matchRate >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${Math.round(health.matchRate)}%
                                </div>
                                <div class="text-xs text-gray-600">Match Rate</div>
                            </div>
                            
                            <div>
                                <div class="text-2xl font-bold ${health.avgConfidence >= 60 ? 'text-green-600' : health.avgConfidence >= 45 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${Math.round(health.avgConfidence)}%
                                </div>
                                <div class="text-xs text-gray-600">Avg Confidence</div>
                            </div>
                            
                            <div>
                                <div class="text-2xl font-bold ${health.avgSpeed < 50 ? 'text-green-600' : health.avgSpeed < 100 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${health.avgSpeed}ms
                                </div>
                                <div class="text-xs text-gray-600">Avg Speed ${health.avgSpeed < 50 ? '‚ö°' : health.avgSpeed < 100 ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                            </div>
                            
                            <div>
                                <div class="text-2xl font-bold ${health.highPrioritySuggestions === 0 ? 'text-green-600' : health.highPrioritySuggestions <= 2 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${health.highPrioritySuggestions}
                                </div>
                                <div class="text-xs text-gray-600">High Priority Issues</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-right">
                        <div class="text-sm space-y-1">
                            <div class="${health.excellentTests > 0 ? 'text-green-600' : 'text-gray-400'}">
                                <i class="fas fa-star"></i> ${health.excellentTests} excellent tests
                            </div>
                            <div class="${health.fastTests > health.slowTests ? 'text-green-600' : 'text-gray-600'}">
                                <i class="fas fa-bolt"></i> ${health.fastTests} fast / ${health.slowTests} slow
                            </div>
                            ${health.totalSuggestions > 0 ? `
                            <div class="text-yellow-600">
                                <i class="fas fa-lightbulb"></i> ${health.totalSuggestions} suggestions
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            container.classList.remove('hidden');
        }
        
        // ============================================
        // ü§ñ AI QUICK FIX ACTIONS
        // ============================================
        
        function quickAddKeyword(scenarioId, keywords) {
            console.log(`ü§ñ Quick add keywords to scenario ${scenarioId}:`, keywords);
            
            if (confirm(`Add these keywords to the scenario?\n\n${keywords.join(', ')}\n\nThis will help improve matching!`)) {
                showNotification(`‚úÖ Adding keywords: ${keywords.join(', ')}`, 'info');
                
                // TODO: Implement actual keyword addition
                // For now, just show success
                setTimeout(() => {
                    showNotification(`üéØ Keywords added! Test again to see improvement.`, 'success');
                    closeTestLogModal();
                    // Navigate to scenario to show changes
                    switchMainTab('categories');
                }, 1000);
            }
        }
        
        // ============================================
        // üì§ EXPORT FULL REPORT
        // ============================================
        
        function exportFullReport() {
            if (!lastTestResults || lastTestResults.length === 0) {
                showNotification('No test results to export', 'warning');
                return;
            }
            
            console.log('üì§ Exporting full diagnostic report...');
            
            const template = activeTemplate;
            const timestamp = new Date().toISOString();
            const health = calculateTemplateHealth(lastTestResults);
            
            // Calculate pipeline integrity metrics
            const hasValidDiagnostics = lastTestResults.filter(r => r.diagnostics && r.diagnostics.input).length;
            const diagnosticsCompleteness = lastTestResults.length > 0 
                ? ((hasValidDiagnostics / lastTestResults.length) * 100).toFixed(0) 
                : 0;
            
            const totalScenarios = lastTestResults[0]?.diagnostics?.candidates?.totalScenarios || template?.stats?.totalScenarios || 0;
            const hasReasonCodes = lastTestResults.filter(r => r.diagnostics?.reasonCodes?.length > 0).length;
            
            let report = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    üß™ GLOBAL AI BRAIN TEST REPORT                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìã TEMPLATE: ${template?.name || 'Unknown'}
üî¢ VERSION: ${template?.version || 'N/A'}
üìÖ GENERATED: ${new Date(timestamp).toLocaleString()}
üß™ TOTAL TESTS: ${lastTestResults.length}

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                      üîß PIPELINE INTEGRITY CHECK                               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Matcher:             ${totalScenarios > 0 ? `‚úÖ Loaded ${totalScenarios} scenarios` : '‚ö†Ô∏è Scenario count unknown'}
Diagnostics Capture: ${diagnosticsCompleteness >= 100 ? '‚úÖ' : diagnosticsCompleteness >= 75 ? '‚ö†Ô∏è' : '‚ùå'} ${diagnosticsCompleteness}% complete (${hasValidDiagnostics}/${lastTestResults.length} tests)
Reason Codes:        ${hasReasonCodes > 0 ? `‚úÖ ${hasReasonCodes} tests analyzed` : '‚ö†Ô∏è No root cause analysis'}
Normalization:       ${diagnosticsCompleteness >= 100 ? '‚úÖ Active (lowercase, punctuation stripped)' : '‚ö†Ô∏è Incomplete data'}
Speed P95:           ${health.avgSpeed}ms ${health.avgSpeed < 50 ? '‚úÖ' : health.avgSpeed < 100 ? '‚ö†Ô∏è' : '‚ùå'} (target: ‚â§50ms)

${diagnosticsCompleteness < 100 ? `‚ö†Ô∏è  WARNING: ${100 - diagnosticsCompleteness}% of tests have incomplete diagnostics. This indicates:\n   - Async timing issue (diagnostics logged before capture completes)\n   - Scenario cache miss (data not loaded from database)\n   - Fix: Ensure scenario data loads before test calls begin\n` : ''}

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                           üìä HEALTH SUMMARY                                    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Overall Health Score: ${health.totalTests > 0 ? calculateHealthScore(health).toFixed(1) : 'N/A'}/10
Match Rate: ${Math.round(health.matchRate)}%
Avg Confidence: ${Math.round(health.avgConfidence)}%
Avg Speed: ${health.avgSpeed}ms ${health.avgSpeed < 50 ? '‚ö° EXCELLENT' : health.avgSpeed < 100 ? '‚úÖ GOOD' : '‚ö†Ô∏è SLOW'}
High Priority Issues: ${health.highPrioritySuggestions}
Total Suggestions: ${health.totalSuggestions}

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                         üß™ DETAILED TEST RESULTS                               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

`;
            
            lastTestResults.forEach((result, index) => {
                const timeAgo = getTimeAgo(new Date(result.timestamp));
                const confidencePercent = Math.round(result.confidence * 100);
                const thresholdPercent = Math.round(result.threshold * 100);
                
                report += `
${'='.repeat(80)}
TEST #${index + 1} - ${result.matched ? '‚úÖ MATCHED' : '‚ùå NO MATCH'} (${timeAgo})
${'='.repeat(80)}

üó£Ô∏è  CALLER PHRASE:
    "${result.phrase}"

üìä METRICS:
    Confidence: ${confidencePercent}% ${result.confidence >= result.threshold ? '‚úÖ' : '‚ö†Ô∏è'} (threshold: ${thresholdPercent}%)
    Response Time: ${result.timing?.total || 'N/A'}ms ${result.timing?.total < 50 ? '‚ö°' : result.timing?.total < 100 ? '‚úÖ' : '‚ö†Ô∏è'}
    Call SID: ${result.callSid || 'N/A'}

`;
                
                // Matched scenario info
                if (result.matched && result.scenario) {
                    report += `‚úÖ MATCHED SCENARIO:
    Name: ${result.scenario.name}
    Category: ${result.scenario.category || 'N/A'}
    Scenario ID: ${result.scenario.scenarioId || 'N/A'}

`;
                }
                
                // Diagnostics
                if (result.diagnostics) {
                    report += `üî¨ DIAGNOSTICS:
    Original Phrase: "${result.diagnostics.input?.raw || result.diagnostics.phrase || result.phrase}"
    Normalized: "${result.diagnostics.input?.normalized || result.diagnostics.normalizedPhrase || 'N/A'}"
    Total Scenarios: ${result.diagnostics.candidates?.totalScenarios || result.diagnostics.totalScenarios || 'N/A'}
    Evaluated: ${result.diagnostics.candidates?.eligible || result.diagnostics.eligibleScenarios || 'N/A'}
    Blocked: ${result.diagnostics.candidates?.blocked || result.diagnostics.blockedScenarios || 0}

`;
                    
                    if (result.diagnostics.matchBreakdown) {
                        report += `üìà SCORE BREAKDOWN:
    BM25 (Keyword): ${(result.diagnostics.matchBreakdown.bm25Score * 100).toFixed(1)}%
    Semantic (Meaning): ${(result.diagnostics.matchBreakdown.semanticScore * 100).toFixed(1)}% (not impl.)
    Regex (Pattern): ${(result.diagnostics.matchBreakdown.regexScore * 100).toFixed(1)}% (not impl.)
    TOTAL: ${(result.diagnostics.matchBreakdown.totalScore * 100).toFixed(1)}%

`;
                    }
                    
                    // NEW: Use reason codes if available
                    if (result.diagnostics.reasonCodes && result.diagnostics.reasonCodes.length > 0) {
                        report += `‚ö†Ô∏è  ROOT CAUSE ANALYSIS:\n`;
                        result.diagnostics.reasonCodes.forEach(reason => {
                            const icon = reason.severity === 'critical' ? 'üö®' : reason.severity === 'high' ? '‚ö†Ô∏è' : reason.severity === 'medium' ? '‚ö†Ô∏è' : reason.severity === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
                            report += `    ${icon} [${reason.severity.toUpperCase()}] ${reason.code}\n`;
                            report += `       Message: ${reason.message}\n`;
                            if (reason.rootCause && reason.rootCause !== 'N/A') {
                                report += `       Root Cause: ${reason.rootCause}\n`;
                            }
                            if (reason.fix && reason.fix !== 'N/A') {
                                report += `       üí° Fix: ${reason.fix}\n`;
                            }
                        });
                        report += '\n';
                    }
                    // FALLBACK: Old structure
                    else if (result.diagnostics.failureReason && result.diagnostics.failureReason.length > 0) {
                        report += `‚ö†Ô∏è  FAILURE REASONS:\n`;
                        result.diagnostics.failureReason.forEach(reason => {
                            const icon = reason.severity === 'critical' ? 'üö®' : reason.severity === 'high' ? '‚ö†Ô∏è' : reason.severity === 'medium' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                            report += `    ${icon} [${reason.severity.toUpperCase()}] ${reason.message}\n`;
                            report += `       üí° Fix: ${reason.fix}\n`;
                        });
                        report += '\n';
                    }
                    
                    // Resolver Decision
                    if (result.diagnostics.resolverDecision) {
                        const rd = result.diagnostics.resolverDecision;
                        report += `üéØ DUAL-INTENT RESOLVER:
    Problem Score: ${(parseFloat(rd.problemScore) * 100).toFixed(0)}% (emergency keywords)
    Action Score: ${(parseFloat(rd.actionScore) * 100).toFixed(0)}% (booking keywords)
    Delta (Œî): ${(parseFloat(rd.delta) * 100).toFixed(0)}%
    Route Decision: ${rd.route.toUpperCase()}
    Reasoning: ${rd.reasoning}
`;
                        if (rd.needsClarifier) {
                            report += `    üí¨ Clarifier Needed: YES
    Clarifier Prompt: "${rd.clarifierPrompt}"
`;
                        }
                        report += '\n';
                    }
                }
                
                // AI Analysis
                if (result.analysis) {
                    if (result.analysis.suggestions && result.analysis.suggestions.length > 0) {
                        report += `üí° AI SUGGESTIONS:\n`;
                        result.analysis.suggestions.forEach(sug => {
                            const priority = sug.priority === 'high' ? 'üî• HIGH PRIORITY' : 'SUGGESTION';
                            report += `    [${priority}] ${sug.message}\n`;
                            if (sug.expectedBoost) report += `       Expected boost: ${sug.expectedBoost}\n`;
                        });
                        report += '\n';
                    }
                    
                    if (result.analysis.insights && result.analysis.insights.length > 0) {
                        report += `‚úÖ POSITIVE INSIGHTS:\n`;
                        result.analysis.insights.forEach(ins => {
                            report += `    ${ins.message}\n`;
                        });
                        report += '\n';
                    }
                    
                    if (result.analysis.issues && result.analysis.issues.length > 0) {
                        report += `üö® ISSUES:\n`;
                        result.analysis.issues.forEach(iss => {
                            report += `    ${iss.message}\n`;
                            if (iss.suggestion) report += `       ‚Üí ${iss.suggestion}\n`;
                        });
                        report += '\n';
                    }
                }
                
                // Close matches
                if (!result.matched && result.topCandidates && result.topCandidates.length > 0) {
                    report += `üéØ CLOSE MATCHES:\n`;
                    result.topCandidates.slice(0, 5).forEach(cand => {
                        report += `    ${Math.round((cand.confidence || 0) * 100)}% - ${cand.scenarioName || cand.scenarioId || 'Unknown'}\n`;
                    });
                    report += '\n';
                }
                
                // Performance breakdown
                if (result.timing) {
                    report += `‚è±Ô∏è  PERFORMANCE:\n`;
                    if (result.timing.normalize) report += `    Normalize: ${result.timing.normalize}ms\n`;
                    if (result.timing.filter) report += `    Filter: ${result.timing.filter}ms\n`;
                    if (result.timing.scoring) report += `    Scoring: ${result.timing.scoring}ms\n`;
                    if (result.timing.selection) report += `    Selection: ${result.timing.selection}ms\n`;
                    report += `    TOTAL: ${result.timing.total}ms\n\n`;
                }
            });
            
            report += `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                              END OF REPORT                                     ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Generated by ClientVia.ai Global AI Brain Testing System
Template: ${template?.name || 'Unknown'} (v${template?.version || 'N/A'})
Timestamp: ${new Date(timestamp).toISOString()}
`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(report).then(() => {
                showNotification('üìã Full report copied to clipboard!', 'success');
                document.getElementById('export-status').textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    document.getElementById('export-status').textContent = '';
                }, 3000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy report', 'error');
            });
        }
        
        function calculateHealthScore(health) {
            let score = 0;
            score += (health.matchRate / 100) * 4; // 40%
            score += (health.avgConfidence / 100) * 3; // 30%
            score += (health.avgSpeed < 50 ? 2 : health.avgSpeed < 100 ? 1 : 0); // 20%
            score += (health.highPrioritySuggestions === 0 ? 1 : 0); // 10%
            return score;
        }
        
        // ============================================
        // üìä QUALITY DASHBOARD - PHASE 3
        // ============================================
        
        async function openQualityDashboard() {
            if (!activeTemplateId) {
                showNotification('No active template selected', 'warning');
                return;
            }
            
            console.log('üìä Opening Quality Dashboard...');
            document.getElementById('quality-dashboard-modal').classList.remove('hidden');
            document.getElementById('quality-dashboard-modal').classList.add('flex');
            
            await loadQualityReport();
        }
        
        function closeQualityDashboard() {
            console.log('üìä Closing Quality Dashboard...');
            document.getElementById('quality-dashboard-modal').classList.add('hidden');
            document.getElementById('quality-dashboard-modal').classList.remove('flex');
        }
        
        async function loadQualityReport() {
            const container = document.getElementById('quality-dashboard-content');
            
            try {
                console.log(`üìä Fetching quality report for template ${activeTemplateId}...`);
                const token = getAuthToken();
                
                const response = await fetch(`/api/twilio/quality-report/${activeTemplateId}?limit=100`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`üìä Quality report loaded:`, data.report);
                    renderQualityReport(data.report);
                } else {
                    container.innerHTML = `
                        <div class="text-center py-12 text-red-600">
                            <i class="fas fa-exclamation-circle text-6xl mb-4"></i>
                            <p class="text-lg font-semibold">Failed to load quality report</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Error loading quality report:', error);
                container.innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-circle text-6xl mb-4"></i>
                        <p class="text-lg font-semibold">Error: ${escapeHtml(error.message)}</p>
                    </div>
                `;
            }
        }
        
        function renderQualityReport(report) {
            const container = document.getElementById('quality-dashboard-content');
            
            if (report.totalTests === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-chart-line text-6xl mb-4"></i>
                        <p class="text-lg">No test data available</p>
                        <p class="text-sm">Make some test calls to generate quality metrics</p>
                    </div>
                `;
                return;
            }
            
            const matchRatePercent = (report.precision * 100).toFixed(1);
            const recallPercent = (report.recall * 100).toFixed(1);
            
            let html = `
                <div class="space-y-6">
                    
                    <!-- ========================================================================== -->
                    <!-- OVERVIEW METRICS -->
                    <!-- ========================================================================== -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="bg-white rounded-lg p-6 border-2 border-blue-200 shadow-lg">
                            <div class="text-sm text-gray-600 mb-1">Total Tests</div>
                            <div class="text-4xl font-bold text-blue-600">${report.totalTests}</div>
                            <div class="text-xs text-gray-500 mt-1">Last 100 calls</div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-6 border-2 ${matchRatePercent >= 80 ? 'border-green-300' : matchRatePercent >= 60 ? 'border-yellow-300' : 'border-red-300'} shadow-lg">
                            <div class="text-sm text-gray-600 mb-1">Match Rate</div>
                            <div class="text-4xl font-bold ${matchRatePercent >= 80 ? 'text-green-600' : matchRatePercent >= 60 ? 'text-yellow-600' : 'text-red-600'}">${matchRatePercent}%</div>
                            <div class="text-xs text-gray-500 mt-1">${report.matched} matched / ${report.noMatch} no-match</div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-6 border-2 border-purple-200 shadow-lg">
                            <div class="text-sm text-gray-600 mb-1">Avg Confidence</div>
                            <div class="text-4xl font-bold text-purple-600">${report.avgConfidence.toFixed(0)}%</div>
                            <div class="text-xs text-gray-500 mt-1">Across all tests</div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-6 border-2 ${report.avgSpeed < 50 ? 'border-green-300' : report.avgSpeed < 100 ? 'border-yellow-300' : 'border-red-300'} shadow-lg">
                            <div class="text-sm text-gray-600 mb-1">Avg Speed</div>
                            <div class="text-4xl font-bold ${report.avgSpeed < 50 ? 'text-green-600' : report.avgSpeed < 100 ? 'text-yellow-600' : 'text-red-600'}">${report.avgSpeed}ms</div>
                            <div class="text-xs text-gray-500 mt-1">${report.avgSpeed < 50 ? '‚ö° Excellent' : report.avgSpeed < 100 ? '‚úÖ Good' : '‚ö†Ô∏è Slow'}</div>
                        </div>
                    </div>
                    
                    <!-- ========================================================================== -->
                    <!-- REASON CODE LEADERBOARD -->
                    <!-- ========================================================================== -->
                    <div class="bg-white rounded-lg p-6 border-2 border-orange-300 shadow-lg">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <i class="fas fa-trophy text-orange-500"></i>
                            üèÜ Failure Reason Leaderboard
                        </h3>
                        
                        ${Object.keys(report.reasonCodeBreakdown).length > 0 ? `
                            <div class="space-y-3">
                                ${Object.entries(report.reasonCodeBreakdown)
                                    .sort((a, b) => b[1] - a[1])
                                    .slice(0, 10)
                                    .map(([code, count]) => {
                                        const percent = ((count / report.totalTests) * 100).toFixed(1);
                                        return `
                                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                <div class="flex-1">
                                                    <code class="text-sm font-mono bg-gray-200 px-2 py-1 rounded">${escapeHtml(code)}</code>
                                                    <div class="text-xs text-gray-600 mt-1">${count} occurrence${count > 1 ? 's' : ''}</div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-2xl font-bold ${
                                                        percent > 30 ? 'text-red-600' :
                                                        percent > 15 ? 'text-yellow-600' :
                                                        'text-blue-600'
                                                    }">${percent}%</div>
                                                    <div class="text-xs text-gray-500">of total</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                            </div>
                        ` : `
                            <p class="text-gray-500 text-center py-4">No failure reason data available</p>
                        `}
                    </div>
                    
                    <!-- ========================================================================== -->
                    <!-- RECOMMENDATIONS -->
                    <!-- ========================================================================== -->
                    ${report.recommendations && report.recommendations.length > 0 ? `
                    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-lg p-6 border-2 border-yellow-400 shadow-lg">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <i class="fas fa-lightbulb text-yellow-500"></i>
                            üí° Actionable Recommendations
                        </h3>
                        
                        <div class="space-y-3">
                            ${report.recommendations.map(rec => `
                                <div class="bg-white rounded-lg p-4 border-l-4 ${
                                    rec.priority === 'high' ? 'border-red-500' :
                                    rec.priority === 'medium' ? 'border-yellow-500' :
                                    'border-blue-500'
                                }">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="font-bold text-sm ${
                                                rec.priority === 'high' ? 'text-red-900' :
                                                rec.priority === 'medium' ? 'text-yellow-900' :
                                                'text-blue-900'
                                            } mb-1">
                                                ${rec.priority === 'high' ? 'üî• HIGH PRIORITY' : rec.priority === 'medium' ? '‚ö†Ô∏è MEDIUM' : '‚ÑπÔ∏è INFO'}
                                            </div>
                                            <div class="text-sm text-gray-900 mb-2">
                                                <strong>Issue:</strong> ${escapeHtml(rec.issue)}
                                            </div>
                                            <div class="text-sm text-gray-700 mb-2">
                                                <strong>Action:</strong> ${escapeHtml(rec.action)}
                                            </div>
                                            <div class="text-sm text-green-700 font-semibold">
                                                <i class="fas fa-chart-line mr-1"></i>
                                                Expected Impact: ${escapeHtml(rec.expectedImpact)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- ========================================================================== -->
                    <!-- QUALITY SCORE -->
                    <!-- ========================================================================== -->
                    <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg p-6 border-2 border-indigo-400 shadow-lg text-center">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">üéØ Overall Template Quality</h3>
                        <div class="text-6xl font-bold ${
                            report.precision >= 0.85 ? 'text-green-600' :
                            report.precision >= 0.70 ? 'text-yellow-600' :
                            'text-red-600'
                        } mb-2">${(report.precision * 10).toFixed(1)}/10</div>
                        <div class="text-sm text-gray-600">
                            ${report.precision >= 0.85 ? 'üèÜ Excellent - Production Ready' :
                              report.precision >= 0.70 ? '‚ö†Ô∏è Good - Needs Tuning' :
                              'üö® Poor - Requires Attention'}
                        </div>
                        
                        <div class="mt-6 grid grid-cols-2 gap-4 text-left">
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-xs text-gray-600 mb-1">Precision</div>
                                <div class="text-2xl font-bold text-indigo-600">${matchRatePercent}%</div>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-xs text-gray-600 mb-1">Recall</div>
                                <div class="text-2xl font-bold text-indigo-600">${recallPercent}%</div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ============================================
        // ü™Ñ ONE-CLICK FIX WIZARD
        // ============================================
        
        function applyFix(action, phrase) {
            console.log(`ü™Ñ [FIX WIZARD] Applying fix: ${action} for phrase: "${phrase}"`);
            
            // Map action to user-friendly message
            const fixActions = {
                'enable_normalization': {
                    title: 'Enable Full Normalization',
                    description: 'Strip punctuation from all triggers to prevent mismatches',
                    confirm: 'This will normalize all triggers in the template by removing punctuation. Continue?'
                },
                'lower_threshold': {
                    title: 'Lower Confidence Threshold',
                    description: 'Reduce threshold from 45% to 38-40% to capture near-misses',
                    confirm: 'This will lower the confidence threshold for all scenarios. Continue?'
                },
                'narrow_negative': {
                    title: 'Narrow Negative Triggers',
                    description: 'Add word boundaries to negative triggers to prevent false blocks',
                    confirm: 'This will update negative triggers to use word boundaries (\\b). Continue?'
                },
                'add_semantic_anchor': {
                    title: 'Add Semantic Anchors',
                    description: 'Create synonym bundles for this category',
                    confirm: 'This will require manual configuration of semantic anchors. Open settings?'
                },
                'enable_short_utterance_boost': {
                    title: 'Enable Short Utterance Boost',
                    description: 'Add score boost for phrases with 1-3 content words',
                    confirm: 'This will boost confidence for short but valid phrases. Continue?'
                },
                'remove_redundant_triggers': {
                    title: 'Remove Redundant Triggers',
                    description: 'Clean up duplicate triggers after normalization',
                    confirm: 'This will scan and remove redundant triggers. Continue?'
                }
            };
            
            const fix = fixActions[action];
            
            if (!fix) {
                showNotification(`Unknown fix action: ${action}`, 'error');
                return;
            }
            
            if (confirm(`${fix.title}\n\n${fix.description}\n\n${fix.confirm}`)) {
                showNotification(`ü™Ñ Applying ${fix.title}...`, 'info');
                
                // TODO: Implement actual fix application via API
                // For now, just show success
                setTimeout(() => {
                    showNotification(`‚úÖ ${fix.title} applied successfully!`, 'success');
                    
                    // Show recommendation to re-test
                    setTimeout(() => {
                        if (confirm('Fix applied! Would you like to close the test log and make a new test call?')) {
                            closeTestLogModal();
                        }
                    }, 1500);
                }, 1000);
            }
        }

        // ============================================================================
        // üü£ AI SUGGESTIONS BANNER - ALWAYS-VISIBLE INTELLIGENCE
        // ============================================================================
        // Purpose: Show pending AI suggestions at top of page for immediate visibility
        // Auto-loads on page load and refreshes every 30 seconds
        // ============================================================================
        
        let suggestionsBannerRefreshInterval = null;
        
        /**
         * Load and display AI suggestions banner
         */
        async function loadSuggestionsBanner() {
            try {
                const templateId = window.activeTemplateId || currentTemplateIdForSettings;
                
                if (!templateId) {
                    console.log('‚ö†Ô∏è [SUGGESTIONS BANNER] No template selected, hiding banner');
                    hideSuggestionsBanner();
                    return;
                }
                
                console.log('üìä [SUGGESTIONS BANNER] Loading suggestions for template:', templateId);
                
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-instant-responses/${templateId}/suggestions?status=pending`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load suggestions');
                }
                
                const suggestions = result.suggestions || [];
                const summary = result.summary || { high: 0, medium: 0, low: 0, total: 0 };
                
                console.log('‚úÖ [SUGGESTIONS BANNER] Loaded', suggestions.length, 'suggestions');
                
                // If no suggestions, hide banner
                if (suggestions.length === 0 || summary.total === 0) {
                    hideSuggestionsBanner();
                    return;
                }
                
                // Update banner content
                updateSuggestionsBannerContent(suggestions, summary);
                
                // Show banner
                showSuggestionsBanner();
                
            } catch (error) {
                console.error('‚ùå [SUGGESTIONS BANNER] Error loading suggestions:', error);
                hideSuggestionsBanner();
                
                // Send error notification to Notification Center
                try {
                    await fetch('/api/admin/notifications/frontend-error', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${getAuthToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            code: 'SUGGESTIONS_BANNER_LOAD_FAILED',
                            severity: 'WARNING',
                            context: 'AI Suggestions Banner',
                            operation: 'loadSuggestionsBanner',
                            error: error.message,
                            userMessage: 'Failed to load AI suggestions banner. Intelligence tab may be unavailable.'
                        })
                    });
                } catch (notifError) {
                    console.error('Failed to send error notification:', notifError);
                }
            }
        }
        
        /**
         * Update banner content with suggestions data
         */
        function updateSuggestionsBannerContent(suggestions, summary) {
            // Update counts
            document.getElementById('suggestions-banner-count').textContent = summary.total || suggestions.length;
            document.getElementById('suggestions-banner-plural').textContent = summary.total === 1 ? '' : 's';
            document.getElementById('suggestions-banner-high').textContent = summary.high || 0;
            document.getElementById('suggestions-banner-medium').textContent = summary.medium || 0;
            document.getElementById('suggestions-banner-low').textContent = summary.low || 0;
            
            // Calculate total estimated impact
            const totalImpact = suggestions.reduce((sum, s) => sum + (s.estimatedImpact || 0), 0);
            const avgImpact = suggestions.length > 0 ? Math.round(totalImpact / suggestions.length) : 0;
            document.getElementById('suggestions-banner-impact').textContent = avgImpact;
            
            // Render preview (top 3 high-priority suggestions)
            const highPriority = suggestions.filter(s => s.priority === 'high').slice(0, 3);
            const previewHtml = highPriority.map(s => renderSuggestionPreview(s)).join('');
            document.getElementById('suggestions-banner-preview').innerHTML = previewHtml || 
                '<div class="text-sm text-gray-600 text-center py-2">Click "Review & Approve All" to see details</div>';
        }
        
        /**
         * Render a single suggestion preview
         */
        function renderSuggestionPreview(suggestion) {
            const typeIcons = {
                filler: 'üîá',
                synonym: 'üî§',
                keyword: 'üéØ',
                negative_keyword: '‚ö†Ô∏è'
            };
            
            const typeNames = {
                filler: 'Filler',
                synonym: 'Synonym',
                keyword: 'Keyword',
                negative_keyword: 'Negative Keyword'
            };
            
            let preview = '';
            if (suggestion.type === 'synonym') {
                preview = `"${suggestion.colloquialTerm || '?'}" ‚Üí "${suggestion.technicalTerm || '?'}"`;
            } else if (suggestion.type === 'filler') {
                preview = `Add "${suggestion.fillerWord || suggestion.word || '?'}" to filter list`;
            } else if (suggestion.type === 'keyword') {
                preview = `Add "${suggestion.keyword || '?'}" to scenario`;
            }
            
            return `
                <div class="flex items-center gap-3 bg-white rounded-lg border border-purple-200 p-3">
                    <div class="text-2xl">${typeIcons[suggestion.type] || 'üìã'}</div>
                    <div class="flex-1">
                        <div class="text-sm font-semibold text-gray-900">${typeNames[suggestion.type] || 'Unknown'}</div>
                        <div class="text-sm text-gray-600">${preview}</div>
                    </div>
                    <div class="text-sm font-bold text-purple-600">${(suggestion.confidence * 100).toFixed(0)}%</div>
                </div>
            `;
        }
        
        /**
         * Show the suggestions banner
         */
        function showSuggestionsBanner() {
            const banner = document.getElementById('ai-suggestions-banner');
            if (banner) {
                banner.classList.remove('hidden');
                console.log('‚úÖ [SUGGESTIONS BANNER] Shown');
            }
        }
        
        /**
         * Hide the suggestions banner
         */
        function hideSuggestionsBanner() {
            const banner = document.getElementById('ai-suggestions-banner');
            if (banner) {
                banner.classList.add('hidden');
                console.log('üìç [SUGGESTIONS BANNER] Hidden (no suggestions)');
            }
        }
        
        /**
         * Open Intelligence tab (from banner button)
         */
        function openIntelligenceTab() {
            switchTab('intelligence');
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        /**
         * Quick apply all high-confidence suggestions (90%+)
         */
        async function applyHighConfidenceSuggestions() {
            if (!confirm('Apply ALL suggestions with 90%+ confidence?\n\nThis will update your template immediately.')) {
                return;
            }
            
            try {
                const templateId = window.activeTemplateId || currentTemplateIdForSettings;
                
                showNotification('üîÑ Applying high-confidence suggestions...', 'info');
                
                const token = getAuthToken();
                const response = await fetch(`/api/admin/global-instant-responses/${templateId}/suggestions/apply-all-high`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ Applied ${result.applied || 0} suggestions!`, 'success');
                    // Reload banner
                    await loadSuggestionsBanner();
                } else {
                    throw new Error(result.error || 'Failed to apply suggestions');
                }
                
            } catch (error) {
                console.error('‚ùå [SUGGESTIONS BANNER] Failed to apply:', error);
                showNotification(`‚ùå Failed: ${error.message}`, 'error');
            }
        }
        
        /**
         * Dismiss banner for 24 hours
         */
        function dismissSuggestionsBanner() {
            hideSuggestionsBanner();
            
            // Store dismissal timestamp
            localStorage.setItem('suggestionsBannerDismissedUntil', Date.now() + (24 * 60 * 60 * 1000));
            
            showNotification('‚ÑπÔ∏è Suggestions banner dismissed for 24 hours', 'info');
        }
        
        /**
         * Check if banner is currently dismissed
         */
        function isSuggestionsBannerDismissed() {
            const dismissedUntil = localStorage.getItem('suggestionsBannerDismissedUntil');
            if (!dismissedUntil) return false;
            
            const now = Date.now();
            if (now < parseInt(dismissedUntil)) {
                console.log('üìç [SUGGESTIONS BANNER] Dismissed until', new Date(parseInt(dismissedUntil)));
                return true;
            }
            
            // Expired, clear it
            localStorage.removeItem('suggestionsBannerDismissedUntil');
            return false;
        }
        
        /**
         * Start auto-refresh interval for suggestions banner
         */
        function startSuggestionsBannerAutoRefresh() {
            // Clear existing interval
            if (suggestionsBannerRefreshInterval) {
                clearInterval(suggestionsBannerRefreshInterval);
            }
            
            // Refresh every 30 seconds
            suggestionsBannerRefreshInterval = setInterval(() => {
                if (!isSuggestionsBannerDismissed()) {
                    loadSuggestionsBanner();
                }
            }, 30000);
            
            console.log('‚úÖ [SUGGESTIONS BANNER] Auto-refresh started (30s interval)');
        }
        
        /**
         * Stop auto-refresh interval
         */
        function stopSuggestionsBannerAutoRefresh() {
            if (suggestionsBannerRefreshInterval) {
                clearInterval(suggestionsBannerRefreshInterval);
                suggestionsBannerRefreshInterval = null;
                console.log('üìç [SUGGESTIONS BANNER] Auto-refresh stopped');
            }
        }

        // ============================================================================
        // üü£ AI SUGGESTIONS MANAGEMENT - INTEGRATION LAYER
        // ============================================================================
        
        let currentSuggestions = [];
        let suggestionsAutoRefreshInterval = null;
        
        /**
         * Load suggestions for current template
         */
        async function loadSuggestions(showLoading = true) {
            console.log('üü£ [SUGGESTIONS CHECKPOINT 1] loadSuggestions() called', { showLoading });
            
            try {
                // Check if section exists
                const sectionElement = document.getElementById('ai-suggestions-section');
                console.log('üü£ [SUGGESTIONS CHECKPOINT 2] Section element:', sectionElement ? 'FOUND' : 'NOT FOUND');
                
                if (!sectionElement) {
                    console.error('üî¥ [SUGGESTIONS ERROR] ai-suggestions-section element not found in DOM!');
                    return;
                }
                
                const activeTemplate = window.activeTemplate;
                const templateId = activeTemplate?._id || window.activeTemplateId;
                
                console.log('üü£ [SUGGESTIONS CHECKPOINT 3] Template info:', {
                    activeTemplate: activeTemplate ? 'exists' : 'null',
                    activeTemplateId: activeTemplate?._id,
                    windowActiveTemplateId: window.activeTemplateId,
                    finalTemplateId: templateId
                });
                
                if (!templateId) {
                    console.warn('üî¥ [SUGGESTIONS] No active template - exiting');
                    return;
                }
                
                console.log('üü£ [SUGGESTIONS CHECKPOINT 4] Loading suggestions for template:', templateId);
                
                // Show loading state
                if (showLoading) {
                    document.getElementById('suggestions-loading-state').classList.remove('hidden');
                    document.getElementById('suggestions-cards-container').classList.add('hidden');
                    document.getElementById('suggestions-empty-state').classList.add('hidden');
                    console.log('üü£ [SUGGESTIONS CHECKPOINT 5] Loading state displayed');
                }
                
                // Fetch suggestions
                console.log('üü£ [SUGGESTIONS CHECKPOINT 6] Fetching from API...');
                const response = await fetch(`/api/admin/global-instant-responses/${templateId}/suggestions`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üü£ [SUGGESTIONS CHECKPOINT 7] API response received:', {
                    status: response.status,
                    ok: response.ok
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to load suggestions: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                console.log('üü£ [SUGGESTIONS CHECKPOINT 8] API data parsed:', {
                    success: data.success,
                    suggestionsCount: data.suggestions?.length || 0,
                    summary: data.summary
                });
                
                if (!data.success) {
                    throw new Error('Failed to load suggestions');
                }
                
                currentSuggestions = data.suggestions || [];
                
                console.log('üü£ [SUGGESTIONS CHECKPOINT 9] Current suggestions set:', currentSuggestions.length);
                
                // Update UI
                updateSuggestionsSummary(data.summary);
                renderSuggestionsCards(currentSuggestions);
                
                // Section is ALWAYS VISIBLE (no auto-hide)
                console.log('üü£ [SUGGESTIONS CHECKPOINT 10] Section is ALWAYS VISIBLE:', {
                    suggestionsCount: currentSuggestions.length,
                    display: currentSuggestions.length > 0 ? 'Showing suggestion cards' : 'Showing empty state'
                });
                
                console.log('üü£ [SUGGESTIONS CHECKPOINT 11] Load complete!', {
                    count: currentSuggestions.length,
                    summary: data.summary
                });
                
            } catch (error) {
                console.error('[SUGGESTIONS] Error loading:', error);
                
                // Hide loading, show empty state
                document.getElementById('suggestions-loading-state').classList.add('hidden');
                document.getElementById('suggestions-empty-state').classList.remove('hidden');
                document.getElementById('suggestions-empty-state').innerHTML = `
                    <i class="fas fa-exclamation-triangle text-red-500 text-6xl mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Error Loading Suggestions</h3>
                    <p class="text-gray-600">${error.message}</p>
                `;
                
                // Send error notification
                try {
                    await window.FrontendErrorReporter?.reportError({
                        component: 'AISuggestions',
                        operation: 'loadSuggestions',
                        error: error.message,
                        userMessage: 'Failed to load AI suggestions. Please refresh the page.'
                    });
                } catch (notifError) {
                    console.error('[SUGGESTIONS] Failed to send error notification:', notifError);
                }
            }
        }
        
        /**
         * Update suggestions summary badges
         */
        function updateSuggestionsSummary(summary) {
            document.getElementById('suggestions-count-badge').textContent = summary.total || 0;
            document.getElementById('suggestions-high-count').textContent = summary.high || 0;
            document.getElementById('suggestions-medium-count').textContent = summary.medium || 0;
            document.getElementById('suggestions-low-count').textContent = summary.low || 0;
        }
        
        /**
         * Render suggestion cards using SuggestionRenderer
         */
        function renderSuggestionsCards(suggestions) {
            const container = document.getElementById('suggestions-cards-container');
            const loadingState = document.getElementById('suggestions-loading-state');
            const emptyState = document.getElementById('suggestions-empty-state');
            
            // Hide loading
            loadingState.classList.add('hidden');
            
            if (suggestions.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            // Clear container
            container.innerHTML = '';
            container.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            // Render each card
            suggestions.forEach(suggestion => {
                const card = window.SuggestionRenderer.renderSuggestionCard(suggestion);
                container.appendChild(card);
            });
        }
        
        /**
         * Apply a single suggestion
         */
        async function applySuggestion(suggestionId) {
            try {
                const templateId = window.activeTemplateId || window.activeTemplate?._id;
                if (!templateId) {
                    throw new Error('No active template');
                }
                
                const response = await fetch(`/api/admin/global-instant-responses/${templateId}/suggestions/${suggestionId}/apply`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to apply suggestion: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to apply suggestion');
                }
                
                // Show success toast
                if (window.ToastManager) {
                    window.ToastManager.success('Suggestion applied successfully!');
                }
                
                // Reload suggestions
                await loadSuggestions(false);
                
                console.log('[SUGGESTIONS] Applied successfully', { suggestionId });
                
            } catch (error) {
                console.error('[SUGGESTIONS] Error applying:', error);
                
                if (window.ToastManager) {
                    window.ToastManager.error(`Failed to apply: ${error.message}`);
                }
                
                // Send error notification
                try {
                    await window.FrontendErrorReporter?.reportError({
                        component: 'AISuggestions',
                        operation: 'applySuggestion',
                        error: error.message,
                        userMessage: 'Failed to apply suggestion. Please try again.'
                    });
                } catch (notifError) {
                    console.error('[SUGGESTIONS] Failed to send error notification:', notifError);
                }
            }
        }
        
        /**
         * Ignore a single suggestion
         */
        async function ignoreSuggestion(suggestionId, reason = 'Not applicable') {
            try {
                const templateId = window.activeTemplateId || window.activeTemplate?._id;
                if (!templateId) {
                    throw new Error('No active template');
                }
                
                const response = await fetch(`/api/admin/global-instant-responses/${templateId}/suggestions/${suggestionId}/ignore`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to ignore suggestion: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to ignore suggestion');
                }
                
                // Show success toast
                if (window.ToastManager) {
                    window.ToastManager.info('Suggestion ignored');
                }
                
                // Reload suggestions
                await loadSuggestions(false);
                
                console.log('[SUGGESTIONS] Ignored successfully', { suggestionId });
                
            } catch (error) {
                console.error('[SUGGESTIONS] Error ignoring:', error);
                
                if (window.ToastManager) {
                    window.ToastManager.error(`Failed to ignore: ${error.message}`);
                }
            }
        }
        
        /**
         * Apply all high-confidence suggestions (90%+)
         */
        async function applyAllHighConfidenceSuggestions() {
            try {
                const templateId = window.activeTemplateId || window.activeTemplate?._id;
                if (!templateId) {
                    throw new Error('No active template');
                }
                
                const highConfSuggestions = currentSuggestions.filter(s => s.confidence >= 0.9);
                
                if (highConfSuggestions.length === 0) {
                    if (window.ToastManager) {
                        window.ToastManager.info('No high-confidence suggestions found (90%+)');
                    }
                    return;
                }
                
                const confirmed = confirm(`Apply ${highConfSuggestions.length} high-confidence suggestions automatically?`);
                if (!confirmed) return;
                
                const response = await fetch(`/api/admin/global-instant-responses/${templateId}/suggestions/apply-all-high`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to apply suggestions: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to apply suggestions');
                }
                
                // Show success toast
                if (window.ToastManager) {
                    window.ToastManager.success(`Applied ${data.applied} of ${highConfSuggestions.length} suggestions!`);
                }
                
                // Reload suggestions
                await loadSuggestions(false);
                
                console.log('[SUGGESTIONS] Bulk apply complete', data);
                
            } catch (error) {
                console.error('[SUGGESTIONS] Error applying all:', error);
                
                if (window.ToastManager) {
                    window.ToastManager.error(`Failed to apply: ${error.message}`);
                }
            }
        }
        
        /**
         * Refresh suggestions
         */
        async function refreshSuggestions() {
            await loadSuggestions(true);
        }
        
        /**
         * Dismiss low priority suggestions
         */
        async function dismissLowPriority() {
            const lowPrioritySuggestions = currentSuggestions.filter(s => s.priority === 'low');
            
            if (lowPrioritySuggestions.length === 0) {
                if (window.ToastManager) {
                    window.ToastManager.info('No low-priority suggestions to dismiss');
                }
                return;
            }
            
            const confirmed = confirm(`Dismiss ${lowPrioritySuggestions.length} low-priority suggestions?`);
            if (!confirmed) return;
            
            // Ignore each low-priority suggestion
            for (const suggestion of lowPrioritySuggestions) {
                await ignoreSuggestion(suggestion._id, 'Low priority - dismissed in bulk');
            }
            
            if (window.ToastManager) {
                window.ToastManager.success(`Dismissed ${lowPrioritySuggestions.length} suggestions`);
            }
        }
        
        // dismissSuggestions() function removed - section is now always visible
        
        /**
         * Start auto-refresh for suggestions
         */
        function startSuggestionsAutoRefresh() {
            // Refresh every 5 minutes
            suggestionsAutoRefreshInterval = setInterval(async () => {
                console.log('[SUGGESTIONS] Auto-refreshing...');
                await loadSuggestions(false);
            }, 5 * 60 * 1000);
            
            console.log('[SUGGESTIONS] Auto-refresh started (5 min interval)');
        }
        
        /**
         * Stop auto-refresh
         */
        function stopSuggestionsAutoRefresh() {
            if (suggestionsAutoRefreshInterval) {
                clearInterval(suggestionsAutoRefreshInterval);
                suggestionsAutoRefreshInterval = null;
                console.log('[SUGGESTIONS] Auto-refresh stopped');
            }
        }
        
        // ============================================================================
        // DIAGNOSTIC ERROR LOG FUNCTIONS
        // ============================================================================
        
        let lastDiagnosticReport = null;
        
        async function refreshDiagnostics() {
            console.log('üîÑ [DIAGNOSTICS] Refreshing system diagnostics...');
            showNotification('Running system diagnostics...', 'info');
            
            // Trigger a full health check
            if (window.aiGatewayManager && window.aiGatewayManager.testOpenAIConnection) {
                await window.aiGatewayManager.testOpenAIConnection();
            } else {
                showNotification('AI Gateway not initialized', 'error');
            }
        }
        
        function toggleDiagnosticErrors() {
            const errorLog = document.getElementById('diagnostic-error-log');
            const button = event?.target?.closest('button');
            const icon = button?.querySelector('i.fa-chevron-down, i.fa-chevron-up');
            
            if (errorLog) {
                const isHidden = errorLog.classList.contains('hidden');
                errorLog.classList.toggle('hidden');
                
                // Update button text and icon
                if (button) {
                    if (isHidden) {
                        button.innerHTML = 'Hide Details <i class="fas fa-chevron-up ml-2"></i>';
                    } else {
                        button.innerHTML = 'View Details <i class="fas fa-chevron-down ml-2"></i>';
                    }
                }
                
                console.log(`üìä [DIAGNOSTICS] Detailed report ${isHidden ? 'expanded' : 'collapsed'}`);
            }
        }
        
        function closeDiagnostics() {
            // Hide both the status banner and detailed report
            const statusBanner = document.getElementById('diagnostic-status-banner');
            const errorLog = document.getElementById('diagnostic-error-log');
            
            if (statusBanner) {
                statusBanner.classList.add('hidden');
            }
            
            if (errorLog) {
                errorLog.classList.add('hidden');
            }
            
            console.log('üóëÔ∏è [DIAGNOSTICS] Diagnostics closed');
        }
        
        async function copyDiagnosticErrors() {
            if (!lastDiagnosticReport) {
                showNotification('No diagnostic data available', 'error');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(lastDiagnosticReport);
                showNotification('Diagnostic report copied to clipboard!', 'success');
                console.log('‚úÖ [DIAGNOSTICS] Report copied to clipboard');
            } catch (error) {
                console.error('‚ùå [DIAGNOSTICS] Failed to copy:', error);
                showNotification('Failed to copy report', 'error');
            }
        }
        
        function showDiagnosticErrors(healthData) {
            console.log('üìä [DIAGNOSTICS] Displaying error log...', healthData);
            
            // ============================================================================
            // üéØ STEP 1: Show detailed compact status banner
            // ============================================================================
            const statusBanner = document.getElementById('diagnostic-status-banner');
            const statusCard = document.getElementById('diagnostic-status-card');
            const statusIcon = document.getElementById('status-icon');
            const statusTitle = document.getElementById('status-title');
            const statusIssues = document.getElementById('status-issues');
            
            if (statusBanner && statusCard && statusIcon && statusTitle) {
                // Determine overall status styling
                let cardClass, icon, title;
                let issueCount = 0;
                let issueList = [];
                
                // Handle both 'HEALTHY' and 'ALL_HEALTHY' status values
                if (healthData.overallStatus === 'HEALTHY' || healthData.overallStatus === 'ALL_HEALTHY') {
                    cardClass = 'bg-green-50 border-green-300 text-green-900';
                    icon = '‚úÖ';
                    title = 'All Systems Operational';
                } else if (healthData.overallStatus === 'DEGRADED') {
                    cardClass = 'bg-yellow-50 border-yellow-300 text-yellow-900';
                    icon = '‚ö†Ô∏è';
                    title = 'System Partially Operational';
                } else if (!healthData.overallStatus) {
                    // Loading state - no status yet
                    cardClass = 'bg-gray-50 border-gray-300 text-gray-900';
                    icon = '‚è≥';
                    title = 'Checking Systems...';
                } else {
                    // Only show error if we have a status and it's bad
                    cardClass = 'bg-red-50 border-red-300 text-red-900';
                    icon = '‚ùå';
                    title = 'System Issues Detected';
                }
                
                // Apply header styling
                statusCard.className = `rounded-lg p-4 border-2 shadow-sm ${cardClass}`;
                statusIcon.textContent = icon;
                statusTitle.textContent = title;
                
                // Update OpenAI status
                const openaiIcon = document.getElementById('openai-status-icon');
                const openaiText = document.getElementById('openai-status-text');
                const openaiRow = document.getElementById('openai-status-row');
                if (openaiIcon && openaiText && openaiRow) {
                    if (healthData.openai?.status === 'HEALTHY') {
                        openaiIcon.textContent = '‚úÖ';
                        openaiText.textContent = `OK (${healthData.openai.responseTime}ms)`;
                        openaiText.className = 'font-mono font-bold text-green-700';
                        openaiRow.className = 'flex items-center gap-2 p-2 rounded bg-green-100 bg-opacity-50';
                    } else if (healthData.openai?.status === 'UNKNOWN') {
                        openaiIcon.textContent = '‚ö™';
                        openaiText.textContent = 'UNKNOWN';
                        openaiText.className = 'font-mono font-bold text-gray-700';
                        openaiRow.className = 'flex items-center gap-2 p-2 rounded bg-gray-100 bg-opacity-50';
                        issueCount++;
                        issueList.push('OpenAI not responding');
                    } else {
                        openaiIcon.textContent = '‚ùå';
                        openaiText.textContent = 'ERROR';
                        openaiText.className = 'font-mono font-bold text-red-700';
                        openaiRow.className = 'flex items-center gap-2 p-2 rounded bg-red-100 bg-opacity-50';
                        issueCount++;
                        issueList.push('OpenAI connection failed');
                    }
                }
                
                // Update MongoDB status
                const mongoIcon = document.getElementById('mongodb-status-icon');
                const mongoText = document.getElementById('mongodb-status-text');
                const mongoRow = document.getElementById('mongodb-status-row');
                if (mongoIcon && mongoText && mongoRow) {
                    if (healthData.mongodb?.status === 'HEALTHY') {
                        mongoIcon.textContent = '‚úÖ';
                        mongoText.textContent = `OK (${healthData.mongodb.queryTime || healthData.mongodb.responseTime}ms)`;
                        mongoText.className = 'font-mono font-bold text-green-700';
                        mongoRow.className = 'flex items-center gap-2 p-2 rounded bg-green-100 bg-opacity-50';
                    } else if (healthData.mongodb?.status === 'UNKNOWN') {
                        mongoIcon.textContent = '‚ö™';
                        mongoText.textContent = 'UNKNOWN';
                        mongoText.className = 'font-mono font-bold text-gray-700';
                        mongoRow.className = 'flex items-center gap-2 p-2 rounded bg-gray-100 bg-opacity-50';
                        issueCount++;
                        issueList.push('MongoDB not responding');
                    } else {
                        mongoIcon.textContent = '‚ùå';
                        mongoText.textContent = 'ERROR';
                        mongoText.className = 'font-mono font-bold text-red-700';
                        mongoRow.className = 'flex items-center gap-2 p-2 rounded bg-red-100 bg-opacity-50';
                        issueCount++;
                        issueList.push('MongoDB connection failed');
                    }
                }
                
                // Update Redis status
                const redisIcon = document.getElementById('redis-status-icon');
                const redisText = document.getElementById('redis-status-text');
                const redisRow = document.getElementById('redis-status-row');
                if (redisIcon && redisText && redisRow) {
                    if (healthData.redis?.status === 'HEALTHY') {
                        redisIcon.textContent = '‚úÖ';
                        redisText.textContent = `OK (${healthData.redis.latency || 0}ms)`;
                        redisText.className = 'font-mono font-bold text-green-700';
                        redisRow.className = 'flex items-center gap-2 p-2 rounded bg-green-100 bg-opacity-50';
                    } else if (healthData.redis?.status === 'UNKNOWN') {
                        redisIcon.textContent = '‚ö†Ô∏è';
                        redisText.textContent = 'COLD START';
                        redisText.className = 'font-mono font-bold text-yellow-700';
                        redisRow.className = 'flex items-center gap-2 p-2 rounded bg-yellow-100 bg-opacity-50';
                        issueCount++;
                        issueList.push('Redis initializing (cold start)');
                    } else {
                        redisIcon.textContent = '‚ùå';
                        redisText.textContent = 'ERROR';
                        redisText.className = 'font-mono font-bold text-red-700';
                        redisRow.className = 'flex items-center gap-2 p-2 rounded bg-red-100 bg-opacity-50';
                        issueCount++;
                        issueList.push('Redis connection failed');
                    }
                }
                
                // Update 3-Tier status
                const tier3Icon = document.getElementById('tier3-status-icon');
                const tier3Text = document.getElementById('tier3-status-text');
                const tier3Row = document.getElementById('tier3-status-row');
                if (tier3Icon && tier3Text && tier3Row) {
                    if (healthData.tier3System?.status === 'ENABLED' || healthData.tier3System?.enabled) {
                        tier3Icon.textContent = '‚úÖ';
                        tier3Text.textContent = 'ENABLED';
                        tier3Text.className = 'font-mono font-bold text-green-700';
                        tier3Row.className = 'flex items-center gap-2 p-2 rounded bg-green-100 bg-opacity-50';
                    } else if (healthData.tier3System?.status === 'DISABLED') {
                        tier3Icon.textContent = '‚ö†Ô∏è';
                        tier3Text.textContent = 'DISABLED';
                        tier3Text.className = 'font-mono font-bold text-yellow-700';
                        tier3Row.className = 'flex items-center gap-2 p-2 rounded bg-yellow-100 bg-opacity-50';
                        issueCount++;
                        issueList.push('3-Tier AI is disabled');
                    } else {
                        tier3Icon.textContent = '‚ö™';
                        tier3Text.textContent = 'UNKNOWN';
                        tier3Text.className = 'font-mono font-bold text-gray-700';
                        tier3Row.className = 'flex items-center gap-2 p-2 rounded bg-gray-100 bg-opacity-50';
                    }
                }
                
                // Update issue summary
                if (statusIssues) {
                    if (issueCount > 0) {
                        statusIssues.innerHTML = `<strong>${issueCount} issue${issueCount > 1 ? 's' : ''} detected:</strong> ${issueList.join(', ')}`;
                        statusIssues.classList.remove('hidden');
                    } else {
                        statusIssues.innerHTML = '<strong>All systems operational</strong> ‚Ä¢ No issues detected';
                        statusIssues.classList.remove('hidden');
                    }
                }
                
                // Show the banner
                statusBanner.classList.remove('hidden');
                console.log(`‚úÖ [DIAGNOSTICS] Status banner displayed (${issueCount} issues)`);
            }
            
            // ============================================================================
            // üéØ STEP 2: Build comprehensive diagnostic report (detailed)
            // ============================================================================
            // Build comprehensive diagnostic report
            let report = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    SYSTEM DIAGNOSTIC REPORT                                  ‚ïë
‚ïë                    Dashboard Test Pilot Area                                 ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìÖ REPORT TIMESTAMP: ${new Date().toLocaleString()}
üñ•Ô∏è  LOCATION: Settings Tab ‚Üí System Diagnostics

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìä SYSTEM COMPONENT STATUS:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
`;

            // Add component statuses
            if (healthData.openai) {
                report += `
ü§ñ OPENAI API (Tier 3 LLM):
   Status: ${healthData.openai.status || 'UNKNOWN'}
   ${healthData.openai.responseTime ? `Response Time: ${healthData.openai.responseTime}ms` : ''}
   ${healthData.openai.model ? `Model: ${healthData.openai.model}` : ''}
   ${healthData.openai.error ? `‚ö†Ô∏è  ERROR: ${healthData.openai.error}` : ''}
`;
            }

            if (healthData.mongodb) {
                report += `
üóÑÔ∏è  MONGODB DATABASE:
   Status: ${healthData.mongodb.status || 'UNKNOWN'}
   ${healthData.mongodb.responseTime ? `Response Time: ${healthData.mongodb.responseTime}ms` : ''}
   ${healthData.mongodb.error ? `‚ö†Ô∏è  ERROR: ${healthData.mongodb.error}` : ''}
`;
            }

            if (healthData.redis) {
                report += `
üíæ REDIS CACHE:
   Status: ${healthData.redis.status || 'UNKNOWN'}
   ${healthData.redis.status === 'UNKNOWN' ? '‚ö†Ô∏è  WARNING: Redis not initialized (cold start issue)' : ''}
   ${healthData.redis.error ? `‚ö†Ô∏è  ERROR: ${healthData.redis.error}` : ''}
   ${healthData.redis.message ? `Info: ${healthData.redis.message}` : ''}
`;
            }

            if (healthData.tier3System) {
                report += `
üß† 3-TIER INTELLIGENCE SYSTEM:
   Status: ${healthData.tier3System.status || 'UNKNOWN'}
   ${healthData.tier3System.message ? `Info: ${healthData.tier3System.message}` : ''}
`;
            }

            // Add error summary
            if (healthData.overallStatus) {
                report += `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üéØ OVERALL STATUS: ${healthData.overallStatus}
`;
            }

            // Add recommendations
            report += `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚úÖ RECOMMENDED ACTIONS:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
`;

            if (healthData.redis?.status === 'UNKNOWN') {
                report += `1. REDIS ISSUE: Check Redis connection configuration\n`;
                report += `   - Verify REDIS_URL environment variable\n`;
                report += `   - Check if Redis service is running\n`;
                report += `   - Review server startup logs for Redis errors\n\n`;
            }

            if (healthData.openai?.status === 'UNHEALTHY') {
                report += `2. OPENAI ISSUE: Check OpenAI API configuration\n`;
                report += `   - Verify OPENAI_API_KEY environment variable\n`;
                report += `   - Check API quota/billing status\n`;
                report += `   - Test API key manually\n\n`;
            }

            report += `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üîß RAW TECHNICAL DATA (for debugging):
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${JSON.stringify(healthData, null, 2)}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìù REPORT GENERATED BY: ClientsVia System Diagnostics
üîó NEXT STEP: Copy this report and share with development team
‚è∞ GENERATED: ${new Date().toLocaleString()}

‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
`;

            // Store report globally
            lastDiagnosticReport = report;
            
            // Display in UI
            const errorList = document.getElementById('diagnostic-error-list');
            const errorLog = document.getElementById('diagnostic-error-log');
            
            if (errorList && errorLog) {
                errorList.textContent = report;
                errorLog.classList.remove('hidden');
                console.log('‚úÖ [DIAGNOSTICS] Error log displayed');
            }
        }

        // ============================================================================
        // PAGE INITIALIZATION
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ [PAGE INIT] DOMContentLoaded event fired - Global AI Brain Management - Initializing...');
            
            // CHECKPOINT: Verify AI Suggestions section exists in DOM
            const suggestionsSectionCheck = document.getElementById('ai-suggestions-section');
            console.log('üü£ [DOM CHECK] AI Suggestions section exists:', suggestionsSectionCheck ? 'YES ‚úÖ' : 'NO ‚ùå');
            if (!suggestionsSectionCheck) {
                console.error('üî¥ CRITICAL: ai-suggestions-section NOT FOUND in HTML! Check if it was removed or renamed.');
            }
            
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // PAGE INIT: Load initial data for BOTH testing modes
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            
            // üîß Load templates into selector on page load
            await loadTemplatesIntoSelector();
            
            // üîß Load Twilio test configuration (phone number, credentials, etc.)
            await loadTwilioTestConfig();
            
            // üîß Load company list and test mode configuration
            await loadCompanyTestModeConfig();
            await loadTopCompanyList();
            
            // üé® Add real-time badge update listeners for Twilio config
            const twilioPhoneInput = document.getElementById('twilio-test-phone');
            const twilioSidInput = document.getElementById('twilio-test-account-sid');
            const twilioTokenInput = document.getElementById('twilio-test-auth-token');
            
            if (twilioPhoneInput) {
                twilioPhoneInput.addEventListener('input', updateTwilioConfigBadge);
                twilioPhoneInput.addEventListener('change', updateTwilioConfigBadge);
                twilioPhoneInput.addEventListener('blur', updateTwilioConfigBadge);
                twilioPhoneInput.addEventListener('keyup', updateTwilioConfigBadge);
            }
            if (twilioSidInput) {
                twilioSidInput.addEventListener('input', updateTwilioConfigBadge);
                twilioSidInput.addEventListener('change', updateTwilioConfigBadge);
                twilioSidInput.addEventListener('blur', updateTwilioConfigBadge);
                twilioSidInput.addEventListener('keyup', updateTwilioConfigBadge);
            }
            if (twilioTokenInput) {
                twilioTokenInput.addEventListener('input', updateTwilioConfigBadge);
                twilioTokenInput.addEventListener('change', updateTwilioConfigBadge);
                twilioTokenInput.addEventListener('blur', updateTwilioConfigBadge);
                twilioTokenInput.addEventListener('keyup', updateTwilioConfigBadge);
            }
            
            console.log('‚úÖ [BADGE] Real-time update listeners attached to Twilio config fields');
            
            // üé® Initial badge update after short delay to ensure fields are populated
            setTimeout(() => {
                console.log('üé® [BADGE] Running initial status check...');
                updateTwilioConfigBadge();
            }, 500);
            
            // üéØ UX: Always show "Select a template" helper message on initial load
            const helper = document.getElementById('template-select-helper');
            if (helper) {
                helper.style.display = 'flex';
                console.log('üí° [PAGE INIT] Showing template selection helper message');
            }
            
            console.log('‚úÖ [PAGE INIT] Page initialization complete (both Template and Company modes loaded)');
        });


        // ============================================================================
        // üéõÔ∏è LLM ENTERPRISE SETTINGS PAGE CONTROLLER
        // ============================================================================
        const LLMSettingsPage = {
            state: null,

            async open() {
                console.log('üéõÔ∏è [LLM SETTINGS] Opening settings page...');
                document.getElementById('llm-enterprise-settings-section').style.display = 'block';
                const scenarioModal = document.getElementById('big-scenario-modal');
                if (scenarioModal) scenarioModal.classList.add('hidden');
                
                // Populate textareas with fallback data immediately (so user sees text right away)
                this.populateTextareasWithFallback();
                
                // Show preview immediately with fallbacks
                this.updatePromptPreview();
                
                // Then load from API (which will update if available)
                await this.load();
            },
            
            populateTextareasWithFallback() {
                console.log('üéõÔ∏è [LLM SETTINGS] Populating textareas with fallback data...');
                const fallbackPrompts = this.getFallbackPrompts();
                if (!fallbackPrompts) return;
                
                // Base prompt
                document.getElementById('llm-prompt-base-text').value = fallbackPrompts.base || '';
                
                // Profile prompts
                document.getElementById('llm-prompt-profile-compliance-text').value = 
                    fallbackPrompts.profiles?.compliance_safe || '';
                document.getElementById('llm-prompt-profile-callcenter-text').value = 
                    fallbackPrompts.profiles?.call_center_optimized || '';
                document.getElementById('llm-prompt-profile-creative-text').value = 
                    fallbackPrompts.profiles?.creative_exploration || '';
                
                // Domain safety prompts
                document.getElementById('llm-prompt-domain-medical-text').value = 
                    fallbackPrompts.domains?.medicalOfficeMode || '';
                document.getElementById('llm-prompt-domain-financial-text').value = 
                    fallbackPrompts.domains?.financialMode || '';
                document.getElementById('llm-prompt-domain-emergency-text').value = 
                    fallbackPrompts.domains?.emergencyServicesMode || '';
                
                // Strict compliance
                document.getElementById('llm-prompt-strict-text').value = 
                    fallbackPrompts.strictCompliance || '';
                
                // Advanced Tuning - populate with defaults immediately
                const profileDefaults = {
                    compliance_safe: { temperature: 0.2, topP: 0.9, maxTokens: 2200 },
                    call_center_optimized: { temperature: 0.35, topP: 0.9, maxTokens: 2600 },
                    creative_exploration: { temperature: 0.65, topP: 0.95, maxTokens: 3000 }
                };
                
                document.getElementById('llm-adv-compliance-temp').value = profileDefaults.compliance_safe.temperature;
                document.getElementById('llm-adv-compliance-topP').value = profileDefaults.compliance_safe.topP;
                document.getElementById('llm-adv-compliance-maxTokens').value = profileDefaults.compliance_safe.maxTokens;
                
                document.getElementById('llm-adv-callcenter-temp').value = profileDefaults.call_center_optimized.temperature;
                document.getElementById('llm-adv-callcenter-topP').value = profileDefaults.call_center_optimized.topP;
                document.getElementById('llm-adv-callcenter-maxTokens').value = profileDefaults.call_center_optimized.maxTokens;
                
                document.getElementById('llm-adv-creative-temp').value = profileDefaults.creative_exploration.temperature;
                document.getElementById('llm-adv-creative-topP').value = profileDefaults.creative_exploration.topP;
                document.getElementById('llm-adv-creative-maxTokens').value = profileDefaults.creative_exploration.maxTokens;
                    
                console.log('‚úÖ [LLM SETTINGS] Textareas and Advanced Tuning populated with fallback defaults');
            },

            close() {
                console.log('üéõÔ∏è [LLM SETTINGS] Closing settings page...');
                document.getElementById('llm-enterprise-settings-section').style.display = 'none';
                const scenarioModal = document.getElementById('big-scenario-modal');
                if (scenarioModal) scenarioModal.classList.remove('hidden');
            },

            async load() {
                console.log('üéõÔ∏è [LLM SETTINGS] Loading settings from API...');
                try {
                    const token = getAuthToken();
                    const res = await fetch('/api/admin/llm-settings', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Failed to load settings');
                    this.state = data.settings;
                    this.applyToUI();
                    console.log('‚úÖ [LLM SETTINGS] Settings loaded successfully', this.state);
                } catch (err) {
                    console.error('‚ùå [LLM SETTINGS] Load failed', err);
                    if (typeof ToastManager !== 'undefined' && ToastManager.show) {
                        ToastManager.show('Failed to load LLM settings', 'error');
                    }
                }
            },

            applyToUI() {
                if (!this.state) return;
                console.log('üé® [LLM SETTINGS] Applying settings to UI...', this.state);

                // Store promptParts and profiles for prompt preview
                this.promptParts = this.state.promptParts || null;
                this.profiles = this.state.profiles || {};

                // Profiles - active profile selection
                const active = this.state.defaults?.activeProfile || 'compliance_safe';
                document.querySelectorAll('input[name="llm-active-profile"]').forEach((input) => {
                    const profileKey = input.value;
                    const profile = this.profiles[profileKey];
                    
                    input.checked = input.value === active;
                    
                    // Update description with model info if available
                    if (profile) {
                        const descDiv = input.closest('label')?.querySelector('[style*="font-size:12px"]');
                        if (descDiv && profile.description && !descDiv.textContent.includes('Model:')) {
                            descDiv.textContent = `${profile.description} | Model: ${profile.model}`;
                        }
                    }
                    
                    // Update parent label border for checked state
                    if (input.checked) {
                        input.closest('label').style.borderColor = '#a5b4fc';
                        input.closest('label').style.background = '#eef2ff';
                    } else {
                        input.closest('label').style.borderColor = '#e5e7eb';
                        input.closest('label').style.background = 'white';
                    }
                });

                // Compliance checkboxes
                const compliance = this.state.compliance || {};
                document.getElementById('llm-strict-compliance').checked = !!compliance.strictComplianceMode;
                document.getElementById('llm-medical-mode').checked = !!compliance.medicalOfficeMode;
                document.getElementById('llm-financial-mode').checked = !!compliance.financialMode;
                document.getElementById('llm-emergency-mode').checked = !!compliance.emergencyServicesMode;
                document.getElementById('llm-compliance-notes').value = compliance.notes || '';

                // Generation defaults
                const genMode = this.state.defaults?.generationMode || 'single';
                document.querySelectorAll('input[name="llm-generation-mode"]').forEach((input) => {
                    input.checked = input.value === genMode;
                });
                document.getElementById('llm-default-variants').value = this.state.defaults?.defaultVariantCount ?? 1;
                document.getElementById('llm-max-variants').value = this.state.defaults?.maxVariantCount ?? 15;

                // Advanced overrides - Show defaults from profiles, not empty strings
                const overrides = this.state.overrides || {};
                
                // Get default values from profiles
                const profileDefaults = {
                    compliance_safe: { temperature: 0.2, topP: 0.9, maxTokens: 2200 },
                    call_center_optimized: { temperature: 0.35, topP: 0.9, maxTokens: 2600 },
                    creative_exploration: { temperature: 0.65, topP: 0.95, maxTokens: 3000 }
                };
                
                // Compliance-safe - show defaults if not overridden
                const oCompliance = overrides.compliance_safe || {};
                document.getElementById('llm-adv-compliance-temp').value = oCompliance.temperature ?? profileDefaults.compliance_safe.temperature;
                document.getElementById('llm-adv-compliance-topP').value = oCompliance.topP ?? profileDefaults.compliance_safe.topP;
                document.getElementById('llm-adv-compliance-maxTokens').value = oCompliance.maxTokens ?? profileDefaults.compliance_safe.maxTokens;

                // Call center - show defaults if not overridden
                const oCallCenter = overrides.call_center_optimized || {};
                document.getElementById('llm-adv-callcenter-temp').value = oCallCenter.temperature ?? profileDefaults.call_center_optimized.temperature;
                document.getElementById('llm-adv-callcenter-topP').value = oCallCenter.topP ?? profileDefaults.call_center_optimized.topP;
                document.getElementById('llm-adv-callcenter-maxTokens').value = oCallCenter.maxTokens ?? profileDefaults.call_center_optimized.maxTokens;

                // Creative - show defaults if not overridden
                const oCreative = overrides.creative_exploration || {};
                document.getElementById('llm-adv-creative-temp').value = oCreative.temperature ?? profileDefaults.creative_exploration.temperature;
                document.getElementById('llm-adv-creative-topP').value = oCreative.topP ?? profileDefaults.creative_exploration.topP;
                document.getElementById('llm-adv-creative-maxTokens').value = oCreative.maxTokens ?? profileDefaults.creative_exploration.maxTokens;

                // Populate Prompt Editor textareas (use state.promptText for saved data, promptParts as fallback)
                const promptParts = this.promptParts || this.getFallbackPrompts();
                const promptText = this.state.promptText || {};
                
                if (promptParts) {
                    // Base prompt - USE promptText.base (saved data), fallback to promptParts.base (display data)
                    document.getElementById('llm-prompt-base-text').value = 
                        promptText.base || promptParts.base || '';
                    
                    // Profile prompts - USE promptText.profiles (saved data), fallback to promptParts.profiles
                    const profiles = promptText.profiles || {};
                    document.getElementById('llm-prompt-profile-compliance-text').value = 
                        profiles.compliance_safe || promptParts.profiles?.compliance_safe || '';
                    document.getElementById('llm-prompt-profile-callcenter-text').value = 
                        profiles.call_center_optimized || promptParts.profiles?.call_center_optimized || '';
                    document.getElementById('llm-prompt-profile-creative-text').value = 
                        profiles.creative_exploration || promptParts.profiles?.creative_exploration || '';
                    
                    // Domain safety prompts - USE promptText.domainSafety (saved data), fallback to promptParts.domains
                    const domains = promptText.domainSafety || {};
                    document.getElementById('llm-prompt-domain-medical-text').value = 
                        domains.medicalOffice || promptParts.domains?.medicalOfficeMode || '';
                    document.getElementById('llm-prompt-domain-financial-text').value = 
                        domains.financial || promptParts.domains?.financialMode || '';
                    document.getElementById('llm-prompt-domain-emergency-text').value = 
                        domains.emergency || promptParts.domains?.emergencyServicesMode || '';
                    
                    // Strict compliance - USE promptText.strictCompliance (saved data), fallback to promptParts
                    document.getElementById('llm-prompt-strict-text').value = 
                        promptText.strictCompliance || promptParts.strictCompliance || '';
                        
                    console.log('‚úÖ [LLM SETTINGS] Prompt Editor textareas populated', { 
                        hasPromptText: !!this.state.promptText, 
                        hasPromptParts: !!this.promptParts 
                    });
                }

                console.log('‚úÖ [LLM SETTINGS] UI updated with current settings');
                
                // Update prompt preview
                this.updatePromptPreview();
            },

            updatePromptPreview() {
                // Use fallback prompts if API didn't load yet
                const promptParts = this.promptParts || this.getFallbackPrompts();
                const state = this.state || this.getFallbackState();
                
                if (!promptParts) return;

                // Build active parts summary
                const activeParts = [];
                activeParts.push('Base Prompt');
                
                const profileKey = state.defaults?.activeProfile || 'compliance_safe';
                // Use fallback function since this.profiles may not be loaded yet
                const profileName = this.getProfileLabel(profileKey);
                activeParts.push(profileName);

                const compliance = state.compliance || {};
                if (compliance.strictComplianceMode && profileKey !== 'compliance_safe') {
                    activeParts.push('Strict Compliance Override');
                }
                if (compliance.medicalOfficeMode) activeParts.push('Medical Safety');
                if (compliance.financialMode) activeParts.push('Financial Safety');
                if (compliance.emergencyServicesMode) activeParts.push('Emergency Safety');

                // Update summary
                const summaryEl = document.getElementById('preview-active-parts');
                if (summaryEl) {
                    summaryEl.textContent = activeParts.join(' + ');
                }

                // Build full prompt text
                let fullPrompt = '';
                
                // Add base
                if (promptParts.base) {
                    fullPrompt += '===== BASE SCENARIO ARCHITECT PROMPT (ALWAYS APPLIED) =====\n\n';
                    fullPrompt += promptParts.base + '\n\n';
                }

                // Add profile
                if (promptParts.profile) {
                    fullPrompt += `===== ACTIVE PROFILE: ${profileName.toUpperCase()} =====\n\n`;
                    fullPrompt += promptParts.profile + '\n\n';
                }

                // Add domain safety prompts
                if (promptParts.domains) {
                    if (promptParts.domains.medicalOfficeMode) {
                        fullPrompt += '===== DOMAIN SAFETY: MEDICAL OFFICE =====\n\n';
                        fullPrompt += promptParts.domains.medicalOfficeMode + '\n\n';
                    }
                    if (promptParts.domains.financialMode) {
                        fullPrompt += '===== DOMAIN SAFETY: FINANCIAL & BILLING =====\n\n';
                        fullPrompt += promptParts.domains.financialMode + '\n\n';
                    }
                    if (promptParts.domains.emergencyServicesMode) {
                        fullPrompt += '===== DOMAIN SAFETY: EMERGENCY SERVICES =====\n\n';
                        fullPrompt += promptParts.domains.emergencyServicesMode + '\n\n';
                    }
                }

                // Add strict compliance
                if (promptParts.strictCompliance) {
                    fullPrompt += '===== STRICT COMPLIANCE MODE =====\n\n';
                    fullPrompt += promptParts.strictCompliance + '\n\n';
                }

                fullPrompt += '\n===== END OF SYSTEM PROMPT =====\n';
                fullPrompt += `\nTotal length: ${fullPrompt.length} characters`;

                // Update preview text
                const previewEl = document.getElementById('prompt-preview-text');
                if (previewEl) {
                    previewEl.textContent = fullPrompt;
                }
            },

            // Fallback prompts if API fails - show actual text immediately
            getFallbackPrompts() {
                const profileKey = (this.state?.defaults?.activeProfile) || 'compliance_safe';
                return {
                    base: `You are the AI Scenario Architect for ClientVia.ai.

Your job is to help admins configure phone call scenarios for real businesses.
You do NOT talk directly to end users. You only produce structured JSON drafts
that describe how the call-handling AI should behave.

ALWAYS follow these rules:

1) Output format
   - You MUST respond with VALID JSON ONLY.
   - No prose, no markdown, no comments, no explanations outside the JSON.
   - The JSON must match the expected "scenarioDraft" schema exactly.

2) Role and perspective
   - You are a senior contact-center architect, not a sales or marketing bot.
   - Think like someone designing flows for thousands of calls per day.
   - Prioritize clarity, safety, caller experience, and easy maintenance.

3) Scenario coverage
   - Design for what MOST callers will say, but also include edge cases.
   - Include strong trigger phrases, negative triggers, and test phrases.
   - Always consider: recognition (triggers), response (replies), follow-up,
     escalation/handoff, silence handling, and QA testing.

4) No real-world actions
   - You never book real appointments or change any external system.
   - You only design the SCRIPT and SETTINGS for another AI to follow.

5) Company-specific facts
   - Do NOT invent prices, policies, guarantees, legal terms, or service areas.
   - When details are missing, either:
     - Ask clarifying questions (if allowed), or
     - Use neutral wording and mark the assumption in the checklistSummary.

6) Safety
   - Avoid medical, legal, and financial advice unless explicitly scoped and
     covered by domain safety instructions.
   - Never collect highly sensitive data unless explicitly allowed by a
     domain safety mode and clearly documented in the checklistSummary.

Your output must always include a checklistSummary explaining key assumptions,
risks, and anything the human admin should double-check before going live.`,
                    profile: this.getProfilePrompt(profileKey),
                    // Add profiles object with all 3 profiles for textarea population
                    profiles: {
                        compliance_safe: this.getProfilePrompt('compliance_safe'),
                        call_center_optimized: this.getProfilePrompt('call_center_optimized'),
                        creative_exploration: this.getProfilePrompt('creative_exploration')
                    },
                    domains: {
                        medicalOfficeMode: `DOMAIN SAFETY: MEDICAL OFFICE

You are configuring scenarios for medical, dental, or healthcare contexts.

Hard rules:
- DO NOT provide medical advice, diagnosis, or treatment recommendations.
- DO NOT interpret symptoms, lab results, or imaging.
- DO NOT suggest medications, dosages, or changes to treatment plans.
- DO NOT triage emergencies or decide if a situation is urgent.

Allowed:
- You may help with logistics: scheduling, rescheduling, canceling appointments,
  collecting basic contact information, and routing calls.
- You may provide generic, non-clinical information such as office hours,
  directions, parking, and which departments handle which issues.

Emergency handling:
- If callers describe severe symptoms or emergencies, the scenario MUST instruct them
  to contact local emergency services or their clinician directly. Do not attempt
  to assess or resolve the situation in the call script.`,
                        financialMode: `DOMAIN SAFETY: FINANCIAL & BILLING

You are configuring scenarios for billing, payments, or financial questions.

Hard rules:
- DO NOT provide investment advice, tax advice, or legal opinions.
- DO NOT promise eligibility, approval, refunds, or fee waivers.
- DO NOT quote exact prices, interest rates, or balances unless explicitly provided
  as variables by the admin.

Allowed:
- You may help with logistics: checking status (in generic language), routing calls
  to billing teams, explaining how to contact support, and capturing contact details.

Language:
- Use cautious phrasing: "our team can review this", "we can check the status for you",
  "a representative will confirm the details", rather than hard guarantees.`,
                        emergencyServicesMode: `DOMAIN SAFETY: EMERGENCY SERVICES

You are configuring scenarios where callers may be in active danger or urgent need.

Hard rules:
- The AI scenario must NOT attempt to diagnose or triage emergencies.
- The AI must NEVER delay or discourage contacting official emergency services.
- For any description of immediate danger to life, health, or property, the scenario
  should quickly instruct the caller to hang up and dial the local emergency number.

Design:
- Keep scripts extremely clear and short.
- Avoid jokes, small talk, or anything that could be perceived as minimizing the situation.
- Ensure escalation/handoff to human responders is built into the scenario where applicable.`
                    },
                    strictCompliance: `GLOBAL OVERRIDE: STRICT COMPLIANCE MODE IS ON.

When in doubt, behave like the Compliance-Safe profile and ask clarifying questions
instead of guessing. Avoid strong promises, avoid risky or ambiguous flows, and
prefer escalation or neutral wording when requirements are unclear.`
                };
            },

            getProfilePrompt(profileKey) {
                const prompts = {
                    compliance_safe: `PROFILE: COMPLIANCE-SAFE

Behavior:
- Be conservative and low-creativity.
- Ask clarifying questions instead of guessing when requirements are unclear.
- Avoid strong claims or promises on behalf of the business.
- Prefer neutral, professional, and respectful language.

Scenario design rules:
- Use modest priority values. This profile is for stable, non-emergency flows.
- Choose minConfidence between 0.60 and 0.90.
- Prefer shorter lists of well-chosen triggers and replies over huge lists.
- Encourage clear escalation paths instead of trying to handle everything with automation.

Sensitive areas:
- DO NOT provide medical, legal, or investment advice.
- DO NOT invent policies, guarantees, or fees.
- DO NOT design flows that handle emergencies solely by AI; always escalate or
  instruct callers to use official emergency channels when appropriate.`,
                    call_center_optimized: `PROFILE: CALL CENTER OPTIMIZED

Behavior:
- Balanced creativity with strong structure.
- Generate richer trigger phrases and reply variations that sound natural on the phone.
- Keep tone friendly, courteous, and concise.

Scenario design rules:
- Use moderate priorities when appropriate so high-traffic intents are recognized.
- Generate more testPhrases to support QA and regression tests.
- Design replies that sound like live agents: short, direct, with clear next steps.

Sensitive areas:
- Still avoid medical/legal/financial advice.
- Still do not invent specific policies, fees, or guarantees; ask the admin to confirm.`,
                    creative_exploration: `PROFILE: CREATIVE EXPLORATION (INTERNAL USE ONLY)

Behavior:
- High creativity and breadth. Generate many alternative phrasings and ideas.
- This profile is for brainstorming and internal review, NOT direct production.
- You may propose unconventional flows and conversation styles,
  but they must still be safe and respectful.

Scenario design rules:
- Emphasize variety in triggers, replies, and test phrases.
- Include more notes and suggestions in the checklistSummary for the admin
  to review before turning anything live.

Safety:
- All safety and compliance rules still apply.
- Flag anything that might be risky, confusing, or too informal for production.`
                };
                return prompts[profileKey] || prompts.compliance_safe;
            },

            getFallbackState() {
                return {
                    defaults: {
                        activeProfile: 'compliance_safe',
                        generationMode: 'single',
                        defaultVariantCount: 1,
                        maxVariantCount: 15
                    },
                    compliance: {
                        strictComplianceMode: true,
                        medicalOfficeMode: false,
                        financialMode: false,
                        emergencyServicesMode: false,
                        notes: ''
                    },
                    overrides: {}
                };
            },

            getProfileLabel(profileKey) {
                const labels = {
                    compliance_safe: 'Compliance-Safe (Default)',
                    call_center_optimized: 'Call Center Optimized',
                    creative_exploration: 'Creative Exploration (Internal)'
                };
                return labels[profileKey] || 'Unknown Profile';
            },

            async saveProfiles() {
                console.log('üíæ [LLM SETTINGS] Saving profiles...');
                const activeInput = document.querySelector('input[name="llm-active-profile"]:checked');
                const activeProfile = activeInput?.value || 'compliance_safe';

                const payload = {
                    defaults: {
                        activeProfile
                    }
                };

                await this.save(payload, 'Profile settings saved successfully');
            },

            async saveCompliance() {
                console.log('üíæ [LLM SETTINGS] Saving compliance...');
                const payload = {
                    compliance: {
                        strictComplianceMode: document.getElementById('llm-strict-compliance').checked,
                        medicalOfficeMode: document.getElementById('llm-medical-mode').checked,
                        financialMode: document.getElementById('llm-financial-mode').checked,
                        emergencyServicesMode: document.getElementById('llm-emergency-mode').checked,
                        notes: document.getElementById('llm-compliance-notes').value || ''
                    }
                };
                await this.save(payload, 'Compliance settings saved successfully');
            },

            async saveGeneration() {
                console.log('üíæ [LLM SETTINGS] Saving generation defaults...');
                const modeInput = document.querySelector('input[name="llm-generation-mode"]:checked');
                const generationMode = modeInput?.value || 'single';
                const defaultVariantCount = parseInt(document.getElementById('llm-default-variants').value, 10);
                const maxVariantCount = parseInt(document.getElementById('llm-max-variants').value, 10);

                const payload = {
                    defaults: {
                        generationMode,
                        defaultVariantCount: defaultVariantCount || 1,
                        maxVariantCount: maxVariantCount || 15
                    }
                };
                await this.save(payload, 'Generation defaults saved successfully');
            },

            async saveAdvanced() {
                console.log('üíæ [LLM SETTINGS] Saving advanced tuning...');
                const payload = {
                    overrides: {
                        compliance_safe: {
                            temperature: this._readNumberOrNull('llm-adv-compliance-temp'),
                            topP: this._readNumberOrNull('llm-adv-compliance-topP'),
                            maxTokens: this._readNumberOrNull('llm-adv-compliance-maxTokens')
                        },
                        call_center_optimized: {
                            temperature: this._readNumberOrNull('llm-adv-callcenter-temp'),
                            topP: this._readNumberOrNull('llm-adv-callcenter-topP'),
                            maxTokens: this._readNumberOrNull('llm-adv-callcenter-maxTokens')
                        },
                        creative_exploration: {
                            temperature: this._readNumberOrNull('llm-adv-creative-temp'),
                            topP: this._readNumberOrNull('llm-adv-creative-topP'),
                            maxTokens: this._readNumberOrNull('llm-adv-creative-maxTokens')
                        }
                    }
                };
                await this.save(payload, 'Advanced tuning saved successfully');
            },

            _readNumberOrNull(id) {
                const el = document.getElementById(id);
                if (!el) return null;
                const val = el.value.trim();
                if (val === '') return null;
                const n = Number(val);
                return Number.isFinite(n) ? n : null;
            },

            async save(partial, successMessage) {
                try {
                    const token = getAuthToken();
                    const res = await fetch('/api/admin/llm-settings', {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(partial)
                    });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Save failed');
                    this.state = data.settings;
                    this.applyToUI();
                    console.log('‚úÖ [LLM SETTINGS] Save successful', data.settings);
                    if (typeof ToastManager !== 'undefined' && ToastManager.show) {
                        ToastManager.show(successMessage, 'success');
                    }
                } catch (err) {
                    console.error('‚ùå [LLM SETTINGS] Save failed', err);
                    if (typeof ToastManager !== 'undefined' && ToastManager.show) {
                        ToastManager.show('Failed to save settings', 'error');
                    }
                }
            },

            async reset(scope) {
                console.log('üîÑ [LLM SETTINGS] Resetting scope:', scope);
                try {
                    const token = getAuthToken();
                    const res = await fetch('/api/admin/llm-settings/reset', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({ scope })
                    });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Reset failed');
                    this.state = data.settings;
                    this.applyToUI();
                    console.log('‚úÖ [LLM SETTINGS] Reset successful', data.settings);
                    if (typeof ToastManager !== 'undefined' && ToastManager.show) {
                        ToastManager.show('Settings reset to defaults', 'success');
                    }
                } catch (err) {
                    console.error('‚ùå [LLM SETTINGS] Reset failed', err);
                    if (typeof ToastManager !== 'undefined' && ToastManager.show) {
                        ToastManager.show('Failed to reset settings', 'error');
                    }
                }
            },

            // PROMPT EDITOR: Save individual prompt section
            async savePromptSection(section, textareaId) {
                console.log(`üíæ [PROMPT EDITOR] Saving section: ${section}`);
                try {
                    const textarea = document.getElementById(textareaId);
                    if (!textarea) {
                        throw new Error(`Textarea ${textareaId} not found`);
                    }

                    const newText = textarea.value.trim();
                    if (!newText) {
                        if (typeof ToastManager !== 'undefined' && ToastManager.show) {
                            ToastManager.show('Prompt text cannot be empty', 'error');
                        }
                        return;
                    }

                    // Build nested promptText object
                    const parts = section.split('.');
                    const promptText = {};
                    
                    if (parts.length === 1) {
                        // Top-level: base, strictCompliance
                        promptText[parts[0]] = newText;
                    } else if (parts.length === 2) {
                        // Nested: profiles.compliance_safe, domains.medicalOfficeMode
                        promptText[parts[0]] = { [parts[1]]: newText };
                    }

                    const payload = { promptText };
                    console.log('üíæ [PROMPT EDITOR] Payload:', payload);

                    await this.save(payload, `${section} prompt saved successfully`);
                    
                    // Update prompt preview
                    await this.updatePromptPreview();
                    
                    console.log(`‚úÖ [PROMPT EDITOR] ${section} saved`);
                } catch (err) {
                    console.error(`‚ùå [PROMPT EDITOR] Save failed for ${section}:`, err);
                    if (typeof ToastManager !== 'undefined' && ToastManager.show) {
                        ToastManager.show('Failed to save prompt text', 'error');
                    }
                }
            },

            // PROMPT EDITOR: Reset individual prompt section
            async resetPromptSection(section, textareaId) {
                console.log(`üîÑ [PROMPT EDITOR] Resetting section: ${section}`);
                try {
                    const token = getAuthToken();
                    const res = await fetch('/api/admin/llm-settings/reset', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({ scope: `promptText.${section}` })
                    });
                    
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Reset failed');
                    
                    this.state = data.settings;
                    
                    // Get fallback text and update textarea
                    const fallbackPrompts = this.getFallbackPrompts();
                    const textarea = document.getElementById(textareaId);
                    
                    if (textarea) {
                        const parts = section.split('.');
                        let defaultText = '';
                        
                        if (parts.length === 1) {
                            defaultText = fallbackPrompts[parts[0]] || '';
                        } else if (parts.length === 2 && fallbackPrompts[parts[0]]) {
                            defaultText = fallbackPrompts[parts[0]][parts[1]] || '';
                        }
                        
                        textarea.value = defaultText;
                        
                        // Update character count
                        const charCountId = textareaId.replace('-text', '-charcount');
                        const charCountEl = document.getElementById(charCountId);
                        if (charCountEl) {
                            charCountEl.textContent = defaultText.length;
                        }
                    }
                    
                    // Update prompt preview
                    await this.updatePromptPreview();
                    
                    if (typeof ToastManager !== 'undefined' && ToastManager.show) {
                        ToastManager.show(`${section} prompt reset to default`, 'success');
                    }
                    
                    console.log(`‚úÖ [PROMPT EDITOR] ${section} reset`);
                } catch (err) {
                    console.error(`‚ùå [PROMPT EDITOR] Reset failed for ${section}:`, err);
                    if (typeof ToastManager !== 'undefined' && ToastManager.show) {
                        ToastManager.show('Failed to reset prompt text', 'error');
                    }
                }
            },

            // PROMPT EDITOR: Reset all prompts
            async resetAllPrompts() {
                console.log('üîÑ [PROMPT EDITOR] Resetting all prompt text...');
                try {
                    const token = getAuthToken();
                    const res = await fetch('/api/admin/llm-settings/reset', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({ scope: 'promptText' })
                    });
                    
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Reset failed');
                    
                    this.state = data.settings;
                    this.promptParts = data.promptParts;
                    this.profiles = data.profiles;
                    
                    // Repopulate all textareas with defaults
                    this.populateTextareasWithFallback();
                    
                    // Update prompt preview
                    await this.updatePromptPreview();
                    
                    if (typeof ToastManager !== 'undefined' && ToastManager.show) {
                        ToastManager.show('All prompt text reset to defaults', 'success');
                    }
                    
                    console.log('‚úÖ [PROMPT EDITOR] All prompts reset');
                } catch (err) {
                    console.error('‚ùå [PROMPT EDITOR] Reset all failed:', err);
                    if (typeof ToastManager !== 'undefined' && ToastManager.show) {
                        ToastManager.show('Failed to reset prompt text', 'error');
                    }
                }
            }
        };

        // Wire up LLM Settings buttons
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéõÔ∏è [LLM SETTINGS] Wiring up event listeners...');

            // Gear button in AI Architect header
            const gearBtn = document.getElementById('architect-settings-btn');
            if (gearBtn) {
                gearBtn.addEventListener('click', () => LLMSettingsPage.open());
                console.log('‚úÖ [LLM SETTINGS] Gear button wired');
            }

            // Back button
            const backBtn = document.getElementById('llm-settings-back');
            if (backBtn) {
                backBtn.addEventListener('click', () => LLMSettingsPage.close());
                console.log('‚úÖ [LLM SETTINGS] Back button wired');
            }

            // Reset all button
            const resetAllBtn = document.getElementById('llm-settings-reset-all');
            if (resetAllBtn) {
                resetAllBtn.addEventListener('click', () => {
                    if (confirm('Reset ALL LLM settings to recommended defaults? This will affect profiles, compliance, generation, and advanced tuning.')) {
                        LLMSettingsPage.reset('all');
                    }
                });
                console.log('‚úÖ [LLM SETTINGS] Reset all button wired');
            }

            // Save buttons
            const saveButtons = [
                { id: 'llm-settings-profiles-save', handler: () => LLMSettingsPage.saveProfiles() },
                { id: 'llm-settings-compliance-save', handler: () => LLMSettingsPage.saveCompliance() },
                { id: 'llm-settings-generation-save', handler: () => LLMSettingsPage.saveGeneration() },
                { id: 'llm-settings-advanced-save', handler: () => LLMSettingsPage.saveAdvanced() }
            ];

            saveButtons.forEach(({ id, handler }) => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener('click', handler);
                    console.log(`‚úÖ [LLM SETTINGS] ${id} wired`);
                }
            });

            // Reset section buttons
            const resetButtons = [
                { id: 'llm-settings-profiles-reset', scope: 'profiles' },
                { id: 'llm-settings-compliance-reset', scope: 'compliance' },
                { id: 'llm-settings-generation-reset', scope: 'generation' },
                { id: 'llm-settings-advanced-reset', scope: 'advanced' }
            ];

            resetButtons.forEach(({ id, scope }) => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener('click', () => LLMSettingsPage.reset(scope));
                    console.log(`‚úÖ [LLM SETTINGS] ${id} wired`);
                }
            });

            // Left nav switching
            document.querySelectorAll('.llm-settings-nav-item').forEach((item) => {
                item.addEventListener('click', () => {
                    const targetId = item.getAttribute('data-target');
                    console.log('üéØ [LLM SETTINGS] Switching to tab:', targetId);
                    
                    // Hide all cards
                    document.querySelectorAll('.llm-settings-card').forEach((card) => {
                        card.style.display = card.id === targetId ? 'block' : 'none';
                    });
                    
                    // Update nav item styles
                    document.querySelectorAll('.llm-settings-nav-item').forEach((nav) => {
                        if (nav === item) {
                            nav.style.background = '#eef2ff';
                            nav.style.fontWeight = '600';
                            nav.style.color = '#4f46e5';
                        } else {
                            nav.style.background = 'transparent';
                            nav.style.fontWeight = '400';
                            nav.style.color = '#6b7280';
                        }
                    });
                });
            });

            // Toggle prompt preview button
            const toggleBtn = document.getElementById('toggle-prompt-preview');
            const previewText = document.getElementById('prompt-preview-text');
            if (toggleBtn && previewText) {
                toggleBtn.addEventListener('click', () => {
                    const isVisible = previewText.style.display !== 'none';
                    previewText.style.display = isVisible ? 'none' : 'block';
                    toggleBtn.textContent = isVisible ? 'Show Full Text' : 'Hide Full Text';
                });
                console.log('‚úÖ [LLM SETTINGS] Prompt preview toggle wired');
            }

            // PROMPT EDITOR: Individual Save Buttons
            const promptSaveButtons = [
                { id: 'llm-prompt-base-save', section: 'base', textarea: 'llm-prompt-base-text' },
                { id: 'llm-prompt-profile-compliance-save', section: 'profiles.compliance_safe', textarea: 'llm-prompt-profile-compliance-text' },
                { id: 'llm-prompt-profile-callcenter-save', section: 'profiles.call_center_optimized', textarea: 'llm-prompt-profile-callcenter-text' },
                { id: 'llm-prompt-profile-creative-save', section: 'profiles.creative_exploration', textarea: 'llm-prompt-profile-creative-text' },
                { id: 'llm-prompt-domain-medical-save', section: 'domains.medicalOfficeMode', textarea: 'llm-prompt-domain-medical-text' },
                { id: 'llm-prompt-domain-financial-save', section: 'domains.financialMode', textarea: 'llm-prompt-domain-financial-text' },
                { id: 'llm-prompt-domain-emergency-save', section: 'domains.emergencyServicesMode', textarea: 'llm-prompt-domain-emergency-text' },
                { id: 'llm-prompt-strict-save', section: 'strictCompliance', textarea: 'llm-prompt-strict-text' }
            ];

            promptSaveButtons.forEach(({ id, section, textarea }) => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener('click', async () => {
                        console.log(`üíæ [PROMPT EDITOR] Saving ${section}...`);
                        await LLMSettingsPage.savePromptSection(section, textarea);
                    });
                    console.log(`‚úÖ [PROMPT EDITOR] ${id} save button wired`);
                }
            });

            // PROMPT EDITOR: Individual Reset Buttons
            const promptResetButtons = [
                { id: 'llm-prompt-base-reset', section: 'base', textarea: 'llm-prompt-base-text' },
                { id: 'llm-prompt-profile-compliance-reset', section: 'profiles.compliance_safe', textarea: 'llm-prompt-profile-compliance-text' },
                { id: 'llm-prompt-profile-callcenter-reset', section: 'profiles.call_center_optimized', textarea: 'llm-prompt-profile-callcenter-text' },
                { id: 'llm-prompt-profile-creative-reset', section: 'profiles.creative_exploration', textarea: 'llm-prompt-profile-creative-text' },
                { id: 'llm-prompt-domain-medical-reset', section: 'domains.medicalOfficeMode', textarea: 'llm-prompt-domain-medical-text' },
                { id: 'llm-prompt-domain-financial-reset', section: 'domains.financialMode', textarea: 'llm-prompt-domain-financial-text' },
                { id: 'llm-prompt-domain-emergency-reset', section: 'domains.emergencyServicesMode', textarea: 'llm-prompt-domain-emergency-text' },
                { id: 'llm-prompt-strict-reset', section: 'strictCompliance', textarea: 'llm-prompt-strict-text' }
            ];

            promptResetButtons.forEach(({ id, section, textarea }) => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener('click', async () => {
                        if (confirm(`Reset this prompt to default?`)) {
                            console.log(`üîÑ [PROMPT EDITOR] Resetting ${section}...`);
                            await LLMSettingsPage.resetPromptSection(section, textarea);
                        }
                    });
                    console.log(`‚úÖ [PROMPT EDITOR] ${id} reset button wired`);
                }
            });

            // PROMPT EDITOR: Reset All Prompts Button
            const resetAllPromptsBtn = document.getElementById('llm-prompt-reset-all');
            if (resetAllPromptsBtn) {
                resetAllPromptsBtn.addEventListener('click', async () => {
                    if (confirm('‚ö†Ô∏è Reset ALL prompt text to defaults? This will reset base prompt, all profile prompts, domain safety prompts, and strict compliance prompt.')) {
                        console.log('üîÑ [PROMPT EDITOR] Resetting all prompts...');
                        await LLMSettingsPage.resetAllPrompts();
                    }
                });
                console.log('‚úÖ [PROMPT EDITOR] Reset all prompts button wired');
            }

            // PROMPT EDITOR: Character count updates
            const promptTextareas = [
                { textarea: 'llm-prompt-base-text', counter: 'llm-prompt-base-charcount' },
                { textarea: 'llm-prompt-profile-compliance-text', counter: 'llm-prompt-profile-compliance-charcount' },
                { textarea: 'llm-prompt-profile-callcenter-text', counter: 'llm-prompt-profile-callcenter-charcount' },
                { textarea: 'llm-prompt-profile-creative-text', counter: 'llm-prompt-profile-creative-charcount' },
                { textarea: 'llm-prompt-domain-medical-text', counter: 'llm-prompt-domain-medical-charcount' },
                { textarea: 'llm-prompt-domain-financial-text', counter: 'llm-prompt-domain-financial-charcount' },
                { textarea: 'llm-prompt-domain-emergency-text', counter: 'llm-prompt-domain-emergency-charcount' },
                { textarea: 'llm-prompt-strict-text', counter: 'llm-prompt-strict-charcount' }
            ];

            promptTextareas.forEach(({ textarea, counter }) => {
                const textareaEl = document.getElementById(textarea);
                const counterEl = document.getElementById(counter);
                if (textareaEl && counterEl) {
                    textareaEl.addEventListener('input', () => {
                        counterEl.textContent = textareaEl.value.length;
                    });
                    // Initialize count
                    counterEl.textContent = textareaEl.value.length;
                }
            });
            console.log('‚úÖ [PROMPT EDITOR] Character counters wired');

            console.log('‚úÖ [LLM SETTINGS] All event listeners initialized');
        });

        // Make LLMSettingsPage globally accessible
        window.LLMSettingsPage = LLMSettingsPage;
        console.log('‚úÖ [LLM SETTINGS] Controller loaded and available globally');
        
    </script>
    <!-- 
    ‚úÖ CRITICAL VERIFICATION CHECKPOINT:
    - If you see this comment, the <script> tag is properly closed above! ‚úÖ
    - This is line ~11,398 (last line of HTML)
    - DO NOT DELETE this closing </script> tag (line above)
    - If tabs don't work, check if </script> was accidentally removed
    -->

    <!-- ========================================================================== -->
    <!-- üß™ TEST LOG MODAL - Full-Screen Test Call History -->
    <!-- ========================================================================== -->
    <div id="test-log-modal" class="fixed inset-0 bg-white z-50 hidden flex-col">
        <!-- Header -->
        <div class="bg-green-600 px-6 py-4 flex items-center justify-between shadow-lg flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                    <i class="fas fa-flask text-green-600 text-2xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-white">üß™ Test Call Log</h2>
                    <p class="text-sm text-green-100">Last 20 test calls with detailed analysis</p>
                </div>
            </div>
            <button onclick="closeTestLogModal()" class="bg-red-600 hover:bg-red-700 text-white rounded-lg px-4 py-2 font-semibold transition-colors flex items-center gap-2">
                <i class="fas fa-times text-xl"></i>
                Close
            </button>
        </div>
            
        <!-- Controls -->
        <div class="px-6 py-3 border-b flex items-center justify-between bg-gray-100 flex-shrink-0">
            <div class="flex items-center gap-3">
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()" class="w-4 h-4">
                    <span class="text-sm font-medium text-gray-700">Auto-refresh (5s)</span>
                </label>
                <button onclick="refreshTestLog()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold transition-colors">
                    <i class="fas fa-sync mr-1"></i>
                    Refresh Now
                </button>
                <button onclick="exportFullReport()" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-semibold transition-colors">
                    <i class="fas fa-file-export mr-1"></i>
                    Export Full Report
                </button>
            </div>
            <div class="text-sm text-gray-600 flex items-center gap-3">
                <span><span id="test-log-count">0</span> tests recorded</span>
                <span class="text-xs text-gray-400">|</span>
                <span class="text-xs" id="export-status"></span>
            </div>
        </div>
        
        <!-- Template Health Summary -->
        <div id="template-health-summary" class="px-6 py-4 bg-blue-50 border-b-2 hidden flex-shrink-0">
            <!-- Will be populated by JS -->
        </div>
        
        <!-- Test Log Content - FULL PAGE SCROLLING -->
        <div id="test-log-content" class="flex-1 overflow-y-auto p-6 bg-gray-50">
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-flask text-6xl mb-4"></i>
                <p class="text-lg">Loading test results...</p>
            </div>
        </div>
    </div>

    <!-- ========================================================================== -->
    <!-- üìä QUALITY DASHBOARD MODAL - Template Performance Analytics -->
    <!-- ========================================================================== -->
    <div id="quality-dashboard-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-7xl w-full max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 rounded-t-2xl flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-blue-600 text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white">üìä Quality Dashboard</h2>
                        <p class="text-sm text-blue-100">Aggregate intelligence from last 100 test calls</p>
                    </div>
                </div>
                <button onclick="closeQualityDashboard()" class="bg-red-600 hover:bg-red-700 text-white rounded-lg px-4 py-2 font-semibold transition-colors flex items-center gap-2">
                    <i class="fas fa-times text-xl"></i>
                    Close
                </button>
            </div>
            
            <!-- Content -->
            <div id="quality-dashboard-content" class="flex-1 overflow-y-auto p-6 bg-gray-50">
                <div class="text-center py-12 text-gray-400">
                    <i class="fas fa-chart-line text-6xl mb-4"></i>
                    <p class="text-lg">Loading quality report...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ü§ñ PHASE A ‚Äì STEP 4: AI SCENARIO ASSISTANT MODAL -->
    <div id="scenario-ai-assistant-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10002; overflow-y: auto; padding: 40px 20px;">
        <div style="background: white; border-radius: 16px; max-width: 700px; width: 100%; margin: 0 auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 24px 32px; border-radius: 16px 16px 0 0; display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="margin: 0; font-size: 24px; font-weight: 700;">
                        <i class="fas fa-magic mr-2"></i>AI Scenario Assistant
                    </h3>
                    <p style="margin: 6px 0 0; font-size: 14px; opacity: 0.9;">Describe what this scenario should handle, and AI will draft the configuration</p>
                </div>
                <button type="button" onclick="closeScenarioAIAssistant()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Content -->
            <div style="padding: 32px;">
                <!-- Instructions -->
                <div style="background: #ecfdf5; border-left: 4px solid #10b981; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                    <p style="margin: 0; font-size: 14px; color: #047857;">
                        <strong>üí° Tip:</strong> Describe the scenario in natural language. Example: <em>"This is for business hours inquiries. Callers ask when we're open and closed. After answering, invite them to ask something else."</em>
                    </p>
                </div>

                <!-- Input -->
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 14px;">
                        <i class="fas fa-pen-fancy mr-2"></i>Describe the Scenario
                    </label>
                    <textarea id="scenario-ai-notes" style="width: 100%; padding: 12px; border: 2px solid #d1fae5; border-radius: 8px; font-size: 14px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; resize: vertical; min-height: 100px;" placeholder="What should this scenario do? Who calls? What information should the AI provide? What should happen after?"></textarea>
                </div>

                <!-- Conversation Area (for multi-turn Q&A) -->
                <div id="scenario-ai-chat" style="display: none; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 24px; max-height: 250px; overflow-y: auto; font-size: 13px;"></div>

                <!-- Status/Info Box -->
                <div id="scenario-ai-status" style="display: none; background: #ecfdf5; border-left: 4px solid #10b981; padding: 12px; border-radius: 8px; margin-bottom: 24px; font-size: 13px; color: #047857;"></div>

                <!-- Answer Box (shown when AI asks clarifying questions) -->
                <div style="margin-bottom: 24px; display: none;" id="scenario-ai-answer-wrapper">
                    <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 14px;">
                        <i class="fas fa-reply mr-2"></i>Your Answer
                    </label>
                    <textarea id="scenario-ai-answer" style="width: 100%; padding: 12px; border: 2px solid #fef3c7; border-radius: 8px; font-size: 14px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; resize: vertical; min-height: 80px;" placeholder="Answer the AI's question, then click Continue..."></textarea>
                </div>

                <!-- Result Area (hidden by default) -->
                <div id="scenario-ai-result-wrapper" style="display: none; margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 14px;">
                        <i class="fas fa-check-circle mr-2"></i>AI Draft (JSON)
                    </label>
                    <textarea id="scenario-ai-result-json" style="width: 100%; padding: 12px; border: 2px solid #dbeafe; border-radius: 8px; font-size: 12px; font-family: 'Courier New', monospace; background: #f0f9ff; color: #0369a1; resize: vertical; min-height: 120px; max-height: 300px;" readonly></textarea>
                    <p style="margin: 8px 0 0; font-size: 12px; color: #6b7280;">Review this draft. You can still edit any field after applying.</p>
                </div>

                <!-- Checklist Summary (shown after draft is ready) -->
                <div id="scenario-ai-checklist" style="display: none; margin-bottom: 24px;"></div>

                <!-- Error Area (hidden by default) -->
                <div id="scenario-ai-error" style="display: none; background: #fee2e2; border: 2px solid #f87171; color: #991b1b; padding: 12px; border-radius: 8px; margin-bottom: 24px; font-size: 14px;"></div>

                <!-- Buttons -->
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" onclick="closeScenarioAIAssistant()" style="background: #e5e7eb; color: #374151; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#d1d5db'" onmouseout="this.style.background='#e5e7eb'">
                        Close
                    </button>
                    <button type="button" id="scenario-ai-apply-btn" onclick="applyScenarioAIDraft()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; display: none;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                        Apply Draft to Form
                    </button>
                    <button type="button" id="scenario-ai-generate-btn" onclick="generateScenarioAIDraft()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                        <i class="fas fa-magic mr-2"></i>Generate Draft
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- ============================================ -->
    <!-- ADD BEHAVIOR MODAL (RESTORED FROM COMMIT 2255acd8) -->
    <!-- ============================================ -->
    <div id="add-behavior-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                <h2 style="font-size: 28px; font-weight: 700; color: #2c3e50; margin: 0;">
                    <i class="fas fa-plus-circle text-purple-600 mr-2"></i>
                    Add New Behavior Template
                </h2>
                <button onclick="closeAddBehaviorModal()" style="background: none; border: none; font-size: 32px; color: #95a5a6; cursor: pointer;">
                    &times;
                </button>
            </div>

            <form id="add-behavior-form" onsubmit="handleAddBehavior(event)">
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Behavior Name *</label>
                    <input type="text" id="add-behavior-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="e.g., Booking Coordinator">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Icon (Emoji)</label>
                    <input type="text" id="add-behavior-icon" maxlength="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-center text-3xl" placeholder="üìÖ">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Instructions * <span class="text-xs font-normal text-gray-500">(This is what the AI follows - ONE source of truth)</span></label>
                    <textarea id="add-behavior-description" required rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="e.g., Calm, slow pace, validating feelings, brief reassurance then practical next step. Avoid platitudes; be specific and human."></textarea>
                    <p class="text-xs text-gray-500 mt-1">Write in plain English how the AI should behave. Include tone, pace, structure - everything in this one field.</p>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Best For * <span class="text-xs font-normal text-gray-500">(When to use this behavior)</span></label>
                    <input type="text" id="add-behavior-usefor" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="e.g., Scheduling appointments, booking services, reservations">
                </div>

                <!-- Vocal Characteristics Section -->
                <div class="mb-6 border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-volume-up text-purple-600"></i>
                        Vocal Characteristics (for non-LLM AI voice synthesis)
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Tone *</label>
                            <select id="add-behavior-tone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <optgroup label="Professional & Business">
                                    <option value="professional">Professional</option>
                                    <option value="authoritative">Authoritative</option>
                                    <option value="business_casual">Business Casual</option>
                                    <option value="confident">Confident</option>
                                    <option value="executive">Executive</option>
                                </optgroup>
                                <optgroup label="Warm & Supportive">
                                    <option value="warm">Warm</option>
                                    <option value="empathetic">Empathetic</option>
                                    <option value="compassionate">Compassionate</option>
                                    <option value="reassuring">Reassuring</option>
                                    <option value="nurturing">Nurturing</option>
                                    <option value="caring">Caring</option>
                                </optgroup>
                                <optgroup label="Friendly & Upbeat">
                                    <option value="friendly">Friendly</option>
                                    <option value="cheerful">Cheerful</option>
                                    <option value="enthusiastic">Enthusiastic</option>
                                    <option value="energetic">Energetic</option>
                                    <option value="upbeat">Upbeat</option>
                                    <option value="playful">Playful</option>
                                </optgroup>
                                <optgroup label="Calm & Steady">
                                    <option value="calm" selected>Calm (default)</option>
                                    <option value="soothing">Soothing</option>
                                    <option value="gentle">Gentle</option>
                                    <option value="patient">Patient</option>
                                    <option value="relaxed">Relaxed</option>
                                    <option value="steady">Steady</option>
                                </optgroup>
                                <optgroup label="Urgent & Direct">
                                    <option value="urgent">Urgent</option>
                                    <option value="firm">Firm</option>
                                    <option value="direct">Direct</option>
                                    <option value="assertive">Assertive</option>
                                    <option value="serious">Serious</option>
                                </optgroup>
                                <optgroup label="Apologetic & Humble">
                                    <option value="apologetic">Apologetic</option>
                                    <option value="humble">Humble</option>
                                    <option value="regretful">Regretful</option>
                                    <option value="sincere">Sincere</option>
                                </optgroup>
                                <optgroup label="Neutral">
                                    <option value="neutral">Neutral</option>
                                    <option value="matter_of_fact">Matter-of-Fact</option>
                                </optgroup>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">How the AI should sound emotionally</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Pace *</label>
                            <select id="add-behavior-pace" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="very_slow">Very Slow (0.75x)</option>
                                <option value="slow">Slow (0.85x)</option>
                                <option value="slightly_slow">Slightly Slower than Normal (0.95x)</option>
                                <option value="normal" selected>Normal (1.0x - default)</option>
                                <option value="slightly_fast">Slightly Faster than Normal (1.1x)</option>
                                <option value="fast">Fast (1.25x)</option>
                                <option value="very_fast">Very Fast (1.5x)</option>
                                <option value="rapid">Rapid (1.75x)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Speed of speech</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Volume *</label>
                            <select id="add-behavior-volume" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="whisper">Whisper (Very Soft)</option>
                                <option value="very_soft">Very Soft</option>
                                <option value="soft">Soft</option>
                                <option value="slightly_soft">Slightly Below Normal</option>
                                <option value="normal" selected>Normal (default)</option>
                                <option value="slightly_above_normal">Slightly Above Normal</option>
                                <option value="moderate">Moderate</option>
                                <option value="firm">Firm</option>
                                <option value="strong">Strong</option>
                                <option value="loud">Loud</option>
                                <option value="very_loud">Very Loud (Commanding)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Loudness/intensity of voice</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Emotion Intensity * <span class="text-xs font-normal">(1=mild, 5=severe)</span></label>
                            <select id="add-behavior-emotion-intensity" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="3">3 - Moderate (default)</option>
                                <option value="1">1 - Very Mild</option>
                                <option value="2">2 - Mild</option>
                                <option value="4">4 - Strong</option>
                                <option value="5">5 - Very Strong</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">How strong is the emotional context</p>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-end gap-3 pt-6 border-t border-gray-200">
                    <button type="button" onclick="closeAddBehaviorModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold hover:shadow-lg transition-all flex items-center gap-2">
                        <i class="fas fa-plus-circle"></i>
                        Add Behavior
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- EDIT BEHAVIOR MODAL (RESTORED FROM COMMIT 2255acd8) -->
    <!-- ============================================ -->
    <div id="edit-behavior-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                <h2 style="font-size: 28px; font-weight: 700; color: #2c3e50; margin: 0;">
                    <i class="fas fa-edit text-blue-600 mr-2"></i>
                    Edit Behavior Template
                </h2>
                <button onclick="closeEditBehaviorModal()" style="background: none; border: none; font-size: 32px; color: #95a5a6; cursor: pointer;">
                    &times;
                </button>
            </div>

            <form id="edit-behavior-form" onsubmit="handleEditBehavior(event)">
                <input type="hidden" id="edit-behavior-id">
                
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Behavior Name *</label>
                    <input type="text" id="edit-behavior-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Icon (Emoji)</label>
                    <input type="text" id="edit-behavior-icon" maxlength="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-center text-3xl">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Description * <span class="text-xs font-normal text-gray-500">(This is what the AI follows)</span></label>
                    <textarea id="edit-behavior-description" required rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Best For * <span class="text-xs font-normal text-gray-500">(When to use this behavior)</span></label>
                    <input type="text" id="edit-behavior-usefor" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Vocal Characteristics Section -->
                <div class="mb-6 border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-volume-up text-blue-600"></i>
                        Vocal Characteristics (for non-LLM AI voice synthesis)
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Tone *</label>
                            <select id="edit-behavior-tone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <optgroup label="Professional & Business">
                                    <option value="professional">Professional</option>
                                    <option value="authoritative">Authoritative</option>
                                    <option value="business_casual">Business Casual</option>
                                    <option value="confident">Confident</option>
                                    <option value="executive">Executive</option>
                                </optgroup>
                                <optgroup label="Warm & Supportive">
                                    <option value="warm">Warm</option>
                                    <option value="empathetic">Empathetic</option>
                                    <option value="compassionate">Compassionate</option>
                                    <option value="reassuring">Reassuring</option>
                                    <option value="nurturing">Nurturing</option>
                                    <option value="caring">Caring</option>
                                </optgroup>
                                <optgroup label="Friendly & Upbeat">
                                    <option value="friendly">Friendly</option>
                                    <option value="cheerful">Cheerful</option>
                                    <option value="enthusiastic">Enthusiastic</option>
                                    <option value="energetic">Energetic</option>
                                    <option value="upbeat">Upbeat</option>
                                    <option value="playful">Playful</option>
                                </optgroup>
                                <optgroup label="Calm & Steady">
                                    <option value="calm">Calm (default)</option>
                                    <option value="soothing">Soothing</option>
                                    <option value="gentle">Gentle</option>
                                    <option value="patient">Patient</option>
                                    <option value="relaxed">Relaxed</option>
                                    <option value="steady">Steady</option>
                                </optgroup>
                                <optgroup label="Urgent & Direct">
                                    <option value="urgent">Urgent</option>
                                    <option value="firm">Firm</option>
                                    <option value="direct">Direct</option>
                                    <option value="assertive">Assertive</option>
                                    <option value="serious">Serious</option>
                                </optgroup>
                                <optgroup label="Apologetic & Humble">
                                    <option value="apologetic">Apologetic</option>
                                    <option value="humble">Humble</option>
                                    <option value="regretful">Regretful</option>
                                    <option value="sincere">Sincere</option>
                                </optgroup>
                                <optgroup label="Neutral">
                                    <option value="neutral">Neutral</option>
                                    <option value="matter_of_fact">Matter-of-Fact</option>
                                </optgroup>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">How the AI should sound emotionally</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Pace *</label>
                            <select id="edit-behavior-pace" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="very_slow">Very Slow (0.75x)</option>
                                <option value="slow">Slow (0.85x)</option>
                                <option value="slightly_slow">Slightly Slower than Normal (0.95x)</option>
                                <option value="normal">Normal (1.0x - default)</option>
                                <option value="slightly_fast">Slightly Faster than Normal (1.1x)</option>
                                <option value="fast">Fast (1.25x)</option>
                                <option value="very_fast">Very Fast (1.5x)</option>
                                <option value="rapid">Rapid (1.75x)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Speed of speech</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Volume *</label>
                            <select id="edit-behavior-volume" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="whisper">Whisper (Very Soft)</option>
                                <option value="very_soft">Very Soft</option>
                                <option value="soft">Soft</option>
                                <option value="slightly_soft">Slightly Below Normal</option>
                                <option value="normal">Normal (default)</option>
                                <option value="slightly_above_normal">Slightly Above Normal</option>
                                <option value="moderate">Moderate</option>
                                <option value="firm">Firm</option>
                                <option value="strong">Strong</option>
                                <option value="loud">Loud</option>
                                <option value="very_loud">Very Loud (Commanding)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Loudness/intensity of voice</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Emotion Intensity * <span class="text-xs font-normal">(1=mild, 5=severe)</span></label>
                            <select id="edit-behavior-emotion-intensity" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="3">3 - Moderate (default)</option>
                                <option value="1">1 - Very Mild</option>
                                <option value="2">2 - Mild</option>
                                <option value="4">4 - Strong</option>
                                <option value="5">5 - Very Strong</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">How strong is the emotional context</p>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-end gap-3 pt-6 border-t border-gray-200">
                    <button type="button" onclick="closeEditBehaviorModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- ACTION HOOKS MODALS (RESTORED FROM COMMIT e0bc6b17) -->
    <!-- ============================================ -->
    
    <!-- ADD ACTION HOOK MODAL -->
    <div id="add-action-hook-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
            <div style="display: flex; align-items: center; justify-between; margin-bottom: 20px;">
                <h2 style="font-size: 28px; font-weight: 700; color: #2c3e50; margin: 0;">
                    <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                    Add Action Hook
                </h2>
                <button onclick="closeAddActionHookModal()" style="background: none; border: none; font-size: 32px; color: #95a5a6; cursor: pointer;">
                    &times;
                </button>
            </div>

            <form id="add-action-hook-form" class="space-y-4" onsubmit="handleAddActionHookSubmit(event); return false;">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Hook ID *</label>
                        <input type="text" id="add-hook-id" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="escalate_to_human">
                        <p class="text-xs text-gray-500 mt-1">Unique identifier (snake_case)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Category *</label>
                        <select id="add-hook-category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                            <option value="escalation">Escalation</option>
                            <option value="scheduling">Scheduling</option>
                            <option value="communication">Communication</option>
                            <option value="payment">Payment</option>
                            <option value="information">Information</option>
                            <option value="call_flow">Call Flow</option>
                            <option value="system">System</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Display Name *</label>
                    <input type="text" id="add-hook-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="Escalate to Human Agent">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Description</label>
                    <textarea id="add-hook-description" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="Transfer call to live agent when AI cannot help"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Icon (emoji)</label>
                    <input type="text" id="add-hook-icon" maxlength="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="üìû">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Function Name</label>
                    <input type="text" id="add-hook-function" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="escalateToHuman">
                    <p class="text-xs text-gray-500 mt-1">Backend function to execute (camelCase)</p>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="add-hook-active" checked class="w-5 h-5 text-yellow-500 border-gray-300 rounded focus:ring-yellow-500 mr-2">
                    <label class="text-sm font-bold text-gray-700">Active</label>
                </div>

                <div class="flex items-center justify-end gap-3 pt-6 border-t border-gray-200">
                    <button type="button" onclick="closeAddActionHookModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all flex items-center gap-2">
                        <i class="fas fa-plus-circle"></i>
                        Add Action Hook
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- EDIT ACTION HOOK MODAL -->
    <div id="edit-action-hook-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
            <div style="display: flex; align-items: center; justify-between; margin-bottom: 20px;">
                <h2 style="font-size: 28px; font-weight: 700; color: #2c3e50; margin: 0;">
                    <i class="fas fa-edit text-yellow-500 mr-2"></i>
                    Edit Action Hook
                </h2>
                <button onclick="closeEditActionHookModal()" style="background: none; border: none; font-size: 32px; color: #95a5a6; cursor: pointer;">
                    &times;
                </button>
            </div>

            <form id="edit-action-hook-form" class="space-y-4" onsubmit="handleEditActionHookSubmit(event); return false;">
                <input type="hidden" id="edit-hook-id-original">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Hook ID *</label>
                        <input type="text" id="edit-hook-id" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 bg-gray-100" readonly>
                        <p class="text-xs text-gray-500 mt-1">Cannot be changed</p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Category *</label>
                        <select id="edit-hook-category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                            <option value="escalation">Escalation</option>
                            <option value="scheduling">Scheduling</option>
                            <option value="communication">Communication</option>
                            <option value="payment">Payment</option>
                            <option value="information">Information</option>
                            <option value="call_flow">Call Flow</option>
                            <option value="system">System</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Display Name *</label>
                    <input type="text" id="edit-hook-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Description</label>
                    <textarea id="edit-hook-description" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Icon (emoji)</label>
                    <input type="text" id="edit-hook-icon" maxlength="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Function Name</label>
                    <input type="text" id="edit-hook-function" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="edit-hook-active" class="w-5 h-5 text-yellow-500 border-gray-300 rounded focus:ring-yellow-500 mr-2">
                    <label class="text-sm font-bold text-gray-700">Active</label>
                </div>

                <div class="flex items-center justify-end gap-3 pt-6 border-t border-gray-200">
                    <button type="button" onclick="closeEditActionHookModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD CATEGORY MODAL (Action Hooks ‚Üí Directories Tab) -->
    <div id="add-category-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                <h2 style="font-size: 28px; font-weight: 700; color: #2c3e50; margin: 0;">
                    <i class="fas fa-folder-plus text-yellow-500 mr-2"></i>
                    Add New Directory
                </h2>
                <button onclick="closeAddHookDirectoryModal()" style="background: none; border: none; font-size: 32px; color: #95a5a6; cursor: pointer;">
                    &times;
                </button>
            </div>

            <form id="add-category-form" class="space-y-4" onsubmit="handleAddDirectorySubmit(event); return false;">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Category ID *</label>
                        <input type="text" id="add-category-id" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="phone_transfer">
                        <p class="text-xs text-gray-500 mt-1">Unique identifier (snake_case)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Display Name *</label>
                        <input type="text" id="add-category-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="Phone Transfer">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Description</label>
                    <textarea id="add-category-description" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="What hooks in this category do..."></textarea>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Icon (emoji)</label>
                        <input type="text" id="add-category-icon" maxlength="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 text-center text-3xl" placeholder="üìû">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Badge Color *</label>
                        <select id="add-category-color" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                            <option value="red">Red</option>
                            <option value="blue">Blue</option>
                            <option value="green">Green</option>
                            <option value="purple">Purple</option>
                            <option value="cyan">Cyan</option>
                            <option value="indigo">Indigo</option>
                            <option value="yellow">Yellow</option>
                            <option value="gray" selected>Gray</option>
                            <option value="pink">Pink</option>
                            <option value="orange">Orange</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Sort Order</label>
                        <input type="number" id="add-category-sort" value="999" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                    </div>
                </div>

                <div class="flex items-center justify-end gap-3 pt-6 border-t border-gray-200">
                    <button type="button" onclick="closeAddHookDirectoryModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all flex items-center gap-2">
                        <i class="fas fa-plus-circle"></i>
                        Add Directory
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- EDIT CATEGORY MODAL (Action Hooks ‚Üí Directories Tab) -->
    <div id="edit-action-hook-category-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                <h2 style="font-size: 28px; font-weight: 700; color: #2c3e50; margin: 0;">
                    <i class="fas fa-edit text-yellow-500 mr-2"></i>
                    Edit Directory
                </h2>
                <button onclick="closeEditActionHookCategoryModal()" style="background: none; border: none; font-size: 32px; color: #95a5a6; cursor: pointer;">
                    &times;
                </button>
            </div>

            <form id="edit-action-hook-category-form" class="space-y-4" onsubmit="handleEditHookDirectorySubmit(event); return false;">
                <input type="hidden" id="edit-ahc-category-id-original">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Category ID *</label>
                        <input type="text" id="edit-ahc-category-id" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 bg-gray-100" readonly>
                        <p class="text-xs text-gray-500 mt-1">Cannot be changed</p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Display Name *</label>
                        <input type="text" id="edit-ahc-category-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Description</label>
                    <textarea id="edit-ahc-category-description" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500"></textarea>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Icon (emoji)</label>
                        <input type="text" id="edit-ahc-category-icon" maxlength="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 text-center text-3xl">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Badge Color *</label>
                        <select id="edit-ahc-category-color" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                            <option value="red">Red</option>
                            <option value="blue">Blue</option>
                            <option value="green">Green</option>
                            <option value="purple">Purple</option>
                            <option value="cyan">Cyan</option>
                            <option value="indigo">Indigo</option>
                            <option value="yellow">Yellow</option>
                            <option value="gray">Gray</option>
                            <option value="pink">Pink</option>
                            <option value="orange">Orange</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Sort Order</label>
                        <input type="number" id="edit-ahc-category-sort" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                    </div>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="edit-ahc-category-active" class="w-5 h-5 text-yellow-500 border-gray-300 rounded focus:ring-yellow-500 mr-2">
                    <label class="text-sm font-bold text-gray-700">Active</label>
                </div>

                <div class="flex items-center justify-end gap-3 pt-6 border-t border-gray-200">
                    <button type="button" onclick="closeEditHookDirectoryModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>