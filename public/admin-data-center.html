<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Center - ClientsVia Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/output.css?v=2.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
        }

        /* Navigation */
        .nav-bar {
            background: white;
            border-bottom: 2px solid #e2e8f0;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-link {
            text-decoration: none;
            color: #4a5568;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link:hover {
            background: #edf2f7;
            color: #2b6cb0;
        }

        .nav-link.active {
            background: #3182ce;
            color: white;
        }

        .logout-btn {
            background: #f56565;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #e53e3e;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Header */
        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-description {
            color: #718096;
            font-size: 1rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: #4a5568;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #2b6cb0;
            background: #edf2f7;
        }

        .tab.active {
            color: #3182ce;
            border-bottom-color: #3182ce;
        }

        /* Search & Filters */
        .search-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #3182ce;
        }

        .search-btn {
            padding: 0.75rem 2rem;
            background: #3182ce;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-btn:hover {
            background: #2c5282;
        }

        /* Action Buttons - SOLID VIBRANT COLORS */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #3182ce;
            color: white;
        }

        .btn-primary:hover {
            background: #2c5282;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-warning {
            background: #ea580c;
            color: white;
        }

        .btn-warning:hover {
            background: #c2410c;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        /* Company Drawer */
        .drawer {
            position: fixed;
            top: 0;
            right: -600px;
            width: 600px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.2);
            transition: right 0.3s;
            z-index: 1000;
            overflow-y: auto;
        }

        .drawer.open {
            right: 0;
        }

        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }

        .drawer-overlay.open {
            display: block;
        }

        .drawer-header {
            padding: 1.5rem;
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .drawer-close {
            background: #ef4444;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s;
        }

        .drawer-close:hover {
            background: #dc2626;
        }

        .drawer-body {
            padding: 1.5rem;
        }

        .drawer-tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }

        .drawer-tab {
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            color: #6b7280;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .drawer-tab:hover {
            color: #3182ce;
        }

        .drawer-tab.active {
            color: #3182ce;
            border-bottom-color: #3182ce;
        }

        /* Filter Chips */
        .filter-chips {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .chip {
            padding: 0.5rem 1rem;
            background: #edf2f7;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .chip:hover {
            background: #e2e8f0;
        }

        .chip.active {
            background: #3182ce;
            color: white;
            border-color: #3182ce;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        tbody tr[data-company-id] {
            cursor: pointer;
            transition: all 0.2s;
        }

        tbody tr[data-company-id]:hover {
            background: #f7fafc;
        }

        .health-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .health-badge.green {
            background: #c6f6d5;
            color: #22543d;
        }

        .health-badge.yellow {
            background: #fef5e7;
            color: #744210;
        }

        .health-badge.red {
            background: #fed7d7;
            color: #742a2a;
        }

        .health-badge.blue {
            background: #bee3f8;
            color: #2c5282;
        }

        /* Action Buttons */
        .action-btn {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #4a5568;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #718096;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: #3182ce;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #718096;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div class="nav-bar">
        <div class="nav-links">
            <a href="/directory.html" class="nav-link">
                <i class="fas fa-list"></i> Directory
            </a>
            <a href="/add-company.html" class="nav-link">
                <i class="fas fa-plus"></i> Add Company
            </a>
            <a href="/admin-data-center.html" class="nav-link active">
                <i class="fas fa-database"></i> Data Center
            </a>
            <a href="/admin-call-archives.html" class="nav-link">
                <i class="fas fa-phone-volume"></i> Call Archives
            </a>
            <a href="/admin-notification-center.html" class="nav-link admin-nav">
                <i class="fas fa-bell"></i> Notification Center
            </a>
            <a href="/v2global-trade-categories.html" class="nav-link">
                <i class="fas fa-tags"></i> Global Trade Categories
            </a>
            <a href="/admin-global-instant-responses.html" class="nav-link">
                <i class="fas fa-brain"></i> Global AI Brain
            </a>
        </div>
        <a href="/login.html" class="logout-btn" onclick="localStorage.clear()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-database"></i>
                Data Center
            </h1>
            <p class="page-description">
                Comprehensive admin operations: search, analyze, cleanup, and export company data
            </p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="companies">
                Companies <span id="total-count">(0)</span>
            </button>
            <button class="tab" data-tab="trash">
                Trash <span id="trash-count">(0)</span>
            </button>
            <button class="tab" data-tab="reports">
                Reports
            </button>
            <button class="tab" data-tab="settings">
                Settings
            </button>
        </div>

        <!-- Tab Content: Companies -->
        <div id="companies-tab" class="tab-content">
            <!-- Live Summary Counters -->
            <div style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-bottom:12px;">
                <div style="background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;">
                    <div style="font-size:12px;color:#6b7280;">Total Companies</div>
                    <div id="count-total" style="font-size:22px;font-weight:700;">0</div>
                </div>
                <div style="background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;">
                    <div style="font-size:12px;color:#6b7280;">Live</div>
                    <div id="count-live" style="font-size:22px;font-weight:700;">0</div>
                </div>
                <div style="background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;">
                    <div style="font-size:12px;color:#6b7280;">Deleted</div>
                    <div id="count-deleted" style="font-size:22px;font-weight:700;">0</div>
                </div>
                <div style="background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;">
                    <div style="font-size:12px;color:#6b7280;">Never Live</div>
                    <div id="count-never-live" style="font-size:22px;font-weight:700;">0</div>
                </div>
            </div>

            <!-- Search & Filters -->
            <div class="search-section">
                <div class="search-bar">
                    <input 
                        type="text" 
                        id="search-input" 
                        class="search-input" 
                        placeholder="Search by name, ID, phone, email, or domain..."
                    >
                    <button class="search-btn" onclick="search()">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>

                <div class="filter-chips">
                    <div class="chip" data-filter="all">
                        All Companies
                    </div>
                    <div class="chip" data-filter="live">
                        Live Only
                    </div>
                    <div class="chip" data-filter="deleted">
                        Deleted Only
                    </div>
                    <div class="chip" data-filter="never-live">
                        Never Live
                    </div>
                    <div class="chip" data-filter="stale">
                        Stale >60d
                    </div>
                    <div class="chip" data-filter="test">
                        Test Accounts
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Company ID</th>
                            <th>Status</th>
                            <th>Health</th>
                            <th>Calls</th>
                            <th>Scenarios</th>
                            <th>Last Activity</th>
                            <th>Created</th>
                            <th>Quick Actions</th>
                        </tr>
                    </thead>
                    <tbody id="companies-table-body">
                        <tr>
                            <td colspan="9" class="loading">
                                <div class="spinner"></div>
                                <p>Loading companies...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab Content: Trash -->
        <div id="trash-tab" class="tab-content" style="display: none;">
            <!-- Trash will be loaded dynamically -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Deleted Date</th>
                            <th>Reason</th>
                            <th>Auto-Purge In</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="trash-table-body">
                        <tr>
                            <td colspan="5" class="loading">
                                <div class="spinner"></div>
                                <p>Loading deleted companies...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab Content: Reports -->
        <div id="reports-tab" class="tab-content" style="display: none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                <h3 style="font-weight:700;">Environment Scan</h3>
                <button class="btn btn-primary" onclick="runScan()"><i class="fas fa-sync"></i> Scan Now</button>
            </div>
            <pre id="scan-output" style="background:#0b1020;color:#e6edf3;padding:1rem;border-radius:6px;overflow:auto;max-height:420px;">Click "Scan Now" to inspect MongoDB and Redis‚Ä¶</pre>
        </div>

        <!-- Tab Content: Settings -->
        <div id="settings-tab" class="tab-content" style="display: none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                <h3 style="font-weight:700;">E2E Fixtures</h3>
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-success" onclick="seedE2E()"><i class="fas fa-seedling"></i> Seed Fixtures</button>
                    <button class="btn btn-danger" onclick="wipeE2E()"><i class="fas fa-eraser"></i> Wipe Fixtures</button>
                </div>
            </div>
            <div id="settings-banner" style="display:none;margin-bottom:8px;padding:10px;border-radius:6px;"></div>
            <pre id="settings-output" style="background:#0b1020;color:#e6edf3;padding:1rem;border-radius:6px;overflow:auto;max-height:360px;">Use the buttons above to seed or wipe fixtures.</pre>
        </div>
    </div>

    <!-- Company Details Drawer -->
    <div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawer()"></div>
    <div class="drawer" id="company-drawer">
        <div class="drawer-header">
            <div>
                <h2 id="drawer-company-name" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem;">Company Name</h2>
                <p id="drawer-company-email" style="color: #6b7280;">email@example.com</p>
            </div>
            <button class="drawer-close" onclick="closeDrawer()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="drawer-body">
            <!-- Drawer Tabs -->
            <div class="drawer-tabs">
                <button class="drawer-tab active" data-drawer-tab="overview" onclick="switchDrawerTab('overview')">
                    <i class="fas fa-info-circle"></i> Overview
                </button>
                <button class="drawer-tab" data-drawer-tab="inventory" onclick="switchDrawerTab('inventory')">
                    <i class="fas fa-database"></i> Inventory
                </button>
                <button class="drawer-tab" data-drawer-tab="customers" onclick="switchDrawerTab('customers')">
                    <i class="fas fa-users"></i> Customers
                </button>
                <button class="drawer-tab" data-drawer-tab="actions" onclick="switchDrawerTab('actions')">
                    <i class="fas fa-cog"></i> Actions
                </button>
            </div>

            <!-- Drawer Tab Content: Overview -->
            <div id="drawer-overview" class="drawer-tab-content">
                <div id="drawer-overview-content">
                    <p style="color: #6b7280;">Loading...</p>
                </div>
            </div>

            <!-- Drawer Tab Content: Inventory -->
            <div id="drawer-inventory" class="drawer-tab-content" style="display: none;">
                <div id="drawer-inventory-content">
                    <p style="color: #6b7280;">Loading...</p>
                </div>
            </div>

            <!-- Drawer Tab Content: Customers -->
            <div id="drawer-customers" class="drawer-tab-content" style="display: none;">
                <div id="drawer-customers-content">
                    <p style="color: #6b7280;">Loading...</p>
                </div>
            </div>

            <!-- Drawer Tab Content: Actions -->
            <div id="drawer-actions" class="drawer-tab-content" style="display: none;">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button class="btn btn-primary" onclick="exportCustomers()">
                        <i class="fas fa-download"></i> Export Customers CSV
                    </button>
                    <button class="btn btn-primary" onclick="exportTranscripts()">
                        <i class="fas fa-download"></i> Export Transcripts CSV
                    </button>
                    <button class="btn btn-warning" onclick="viewCompanyProfile()">
                        <i class="fas fa-external-link-alt"></i> Open Company Profile
                    </button>
                    <hr style="border-color: #e2e8f0;">
                    <button class="btn btn-danger" id="drawer-soft-delete-btn" onclick="confirmSoftDelete()">
                        <i class="fas fa-trash"></i> Soft Delete Company
                    </button>
                    <button class="btn btn-success" id="drawer-restore-btn" onclick="confirmRestore()" style="display: none;">
                        <i class="fas fa-undo"></i> Restore Company
                    </button>
                    <button class="btn btn-danger" id="drawer-hard-delete-btn" onclick="confirmHardDelete()" style="display: none; background: #7f1d1d; border-color: #7f1d1d;">
                        <i class="fas fa-skull-crossbones"></i> Hard Delete (Permanent)
                    </button>
                    <button class="btn btn-primary" id="drawer-download-btn" onclick="downloadCompanyData()">
                        <i class="fas fa-download"></i> Download Company Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // GLOBAL STATE
        // ============================================================================
        let currentFilter = 'all';
        let companies = [];
        let currentCompany = null; // Company currently open in drawer

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[DATA CENTER] üöÄ Initializing Data Center...');
            
            // Activate default filter chip
            const allChip = document.querySelector('[data-filter="all"]');
            if (allChip) {
                allChip.classList.add('active');
                console.log('[DATA CENTER] ‚úÖ Default "All Companies" chip activated');
            }
            
            refreshSummary();
            loadCompanies();
            setupEventListeners();
            
            console.log('[DATA CENTER] ‚úÖ Initialization complete');
        });

        function setupEventListeners() {
            console.log('[DATA CENTER] üéß Setting up event listeners...');
            
            // Tab switching
            const tabs = document.querySelectorAll('.tab');
            console.log('[DATA CENTER] üìë Found', tabs.length, 'tabs');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    console.log('[DATA CENTER] üìë Tab clicked:', tabName);
                    switchTab(tabName);
                });
            });

            // Search on Enter key
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        console.log('[DATA CENTER] üîç Enter key pressed, searching...');
                        search();
                    }
                });
                console.log('[DATA CENTER] ‚úÖ Search input listener attached');
            }
            
            // Filter chips - attach click listeners
            const chips = document.querySelectorAll('.chip');
            console.log('[DATA CENTER] üè∑Ô∏è Found', chips.length, 'filter chips');
            chips.forEach(chip => {
                const filter = chip.dataset.filter;
                console.log('[DATA CENTER] üè∑Ô∏è Chip:', filter);
                chip.addEventListener('click', () => {
                    console.log('[DATA CENTER] üè∑Ô∏è Chip clicked via listener:', filter);
                    applyFilter(filter);
                });
            });
            
            console.log('[DATA CENTER] ‚úÖ Event listeners setup complete');
        }

        async function refreshSummary() {
            try {
                const token = localStorage.getItem('adminToken');
                const res = await fetch('/api/admin/data-center/summary', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const s = await res.json();
                document.getElementById('count-total').textContent = s.total.toLocaleString();
                document.getElementById('count-live').textContent = s.live.toLocaleString();
                document.getElementById('count-deleted').textContent = s.deleted.toLocaleString();
                document.getElementById('count-never-live').textContent = s.neverLive.toLocaleString();
            } catch (e) {
                console.error('[DATA CENTER] Summary error', e);
            }
        }

        // ============================================================================
        // TAB MANAGEMENT
        // ============================================================================
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(`${tabName}-tab`).style.display = 'block';

            // Load data for specific tabs
            if (tabName === 'trash') {
                loadTrash();
            }
            if (tabName === 'reports') {
                const out = document.getElementById('scan-output');
                if (out && out.textContent.includes('Click "Scan Now"')) {
                    runScan();
                }
            }
            if (tabName === 'settings') {
                // No-op; settings actions are manual
            }
        }

        async function loadCompanies(query = '', state = 'all') {
            console.log('[DATA CENTER] üì° Loading companies:', { query, state });
            
            try {
                const token = localStorage.getItem('adminToken');
                const params = new URLSearchParams({ query, state, page: 1, pageSize: 100 });
                
                console.log('[DATA CENTER] üåê Fetching:', `/api/admin/data-center/companies?${params}`);
                
                const response = await fetch(`/api/admin/data-center/companies?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    console.error('[DATA CENTER] ‚ùå HTTP Error:', response.status);
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('[DATA CENTER] ‚úÖ Received data:', {
                    total: data.total,
                    resultsCount: data.results.length,
                    page: data.page
                });
                
                companies = data.results;
                
                renderCompanies(companies);
                updateCounts(data.total);

            } catch (error) {
                console.error('[DATA CENTER] ‚ùå Error loading companies:', error);
                showError('Failed to load companies');
            }
        }

        function renderCompanies(companies) {
            console.log('[DATA CENTER] üé® Rendering companies:', companies.length);
            const tbody = document.getElementById('companies-table-body');
            
            if (companies.length === 0) {
                console.log('[DATA CENTER] ‚ö†Ô∏è No companies to display');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-search"></i>
                            <h3>No Companies Found</h3>
                            <p>Try adjusting your search or filters</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = companies.map(company => `
                <tr data-company-id="${company.companyId}">
                    <td onclick="viewCompany('${company.companyId}')" style="cursor: pointer;">
                        <strong>${company.companyName}</strong>
                        <br>
                        <small style="color: #718096;">${company.ownerEmail || ''}</small>
                    </td>
                    <td onclick="viewCompany('${company.companyId}')" style="cursor: pointer;">
                        <code style="font-size: 0.75rem; background: #f7fafc; padding: 0.25rem 0.5rem; border-radius: 4px; color: #2d3748; font-family: 'Courier New', monospace;">${company.companyId}</code>
                    </td>
                    <td onclick="viewCompany('${company.companyId}')" style="cursor: pointer;">
                        <span class="health-badge ${company.healthBadge.color}">
                            ${company.healthBadge.icon} ${company.healthBadge.label}
                        </span>
                    </td>
                    <td onclick="viewCompany('${company.companyId}')" style="cursor: pointer;">${company.healthScore}/100</td>
                    <td onclick="viewCompany('${company.companyId}')" style="cursor: pointer;">${company.calls.toLocaleString()}</td>
                    <td onclick="viewCompany('${company.companyId}')" style="cursor: pointer;">${company.scenarios}</td>
                    <td onclick="viewCompany('${company.companyId}')" style="cursor: pointer;">${company.lastActivityFormatted || 'Never'}</td>
                    <td onclick="viewCompany('${company.companyId}')" style="cursor: pointer;">${new Date(company.createdAt).toLocaleDateString()}</td>
                    <td style="padding: 0.5rem;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="viewCallHistory('${company.companyId}')" class="action-btn" title="View Call History">
                                <i class="fas fa-phone-volume"></i>
                            </button>
                            <button onclick="viewAIPerformance('${company.companyId}')" class="action-btn" title="AI Performance">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            <button onclick="manageSpamFilter('${company.companyId}')" class="action-btn" title="Spam Filter">
                                <i class="fas fa-shield-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            console.log('[DATA CENTER] ‚úÖ Render complete');
        }

        // Quick Action Functions
        function viewCallHistory(companyId) {
            console.log('[DATA CENTER] üìû Opening Call History for:', companyId);
            window.location.href = `/admin-call-archives.html?companyId=${companyId}`;
        }

        function viewAIPerformance(companyId) {
            console.log('[DATA CENTER] üìä Opening AI Performance for:', companyId);
            window.location.href = `/company-profile.html?id=${companyId}#ai-performance`;
        }

        function manageSpamFilter(companyId) {
            console.log('[DATA CENTER] üõ°Ô∏è Opening Spam Filter for:', companyId);
            // For now, just navigate to company profile - later we can add a dedicated spam management page
            window.location.href = `/company-profile.html?id=${companyId}#configuration`;
        }

        function updateCounts(total) {
            document.getElementById('total-count').textContent = `(${total})`;
        }

        function search() {
            const query = document.getElementById('search-input').value;
            loadCompanies(query, currentFilter === 'all' ? 'all' : 'live');
        }

        function applyFilter(filter) {
            console.log('[DATA CENTER] üîç Filter clicked:', filter);
            currentFilter = filter;
            
            // Update chip UI
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            const selectedChip = document.querySelector(`[data-filter="${filter}"]`);
            if (selectedChip) {
                selectedChip.classList.add('active');
                console.log('[DATA CENTER] ‚úÖ Chip activated:', filter);
            } else {
                console.error('[DATA CENTER] ‚ùå Chip not found for filter:', filter);
            }

            // Apply filter
            const query = document.getElementById('search-input').value;

            // Server-side filters
            if (filter === 'live' || filter === 'all' || filter === 'deleted') {
                const state = filter === 'deleted' ? 'deleted' : (filter === 'live' ? 'live' : 'all');
                console.log('[DATA CENTER] üåê Reloading from server with state:', state);
                return loadCompanies(query, state);
            }

            // Client-side filters on already loaded data
            let filtered = [...companies];
            if (filter === 'never-live') {
                filtered = filtered.filter(c => (c.calls || 0) === 0 && (c.scenarios || 0) === 0 && (!c.lastActivity || c.lastActivityFormatted === 'Never'));
                console.log('[DATA CENTER] üìä Applied client-side NEVER LIVE filter:', filtered.length);
            } else if (filter === 'stale') {
                filtered = filtered.filter(c => c.lastActivityFormatted === 'Never' || /\b(\d+\s*days|Never)\b/i.test(c.lastActivityFormatted || 'Never'));
                console.log('[DATA CENTER] üìä Applied client-side STALE filter:', filtered.length);
            } else if (filter === 'test') {
                filtered = filtered.filter(c => /test|demo|sample|qa/i.test(c.companyName || '') || /test|demo|sample|qa/i.test(c.ownerEmail || ''));
                console.log('[DATA CENTER] üìä Applied client-side TEST filter:', filtered.length);
            }

            renderCompanies(filtered);
        }

        // ============================================================================
        // COMPANY DRAWER MANAGEMENT
        // ============================================================================
        async function runScan() {
            const out = document.getElementById('scan-output');
            if (!out) return;
            out.textContent = 'Scanning‚Ä¶';
            try {
                const token = localStorage.getItem('adminToken');
                const res = await fetch('/api/admin/data-center/scan', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                out.textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                out.textContent = 'Scan failed: ' + e.message;
                console.error('[DATA CENTER] Scan error', e);
            }
        }

        async function viewCompany(companyId) {
            currentCompany = companies.find(c => c.companyId === companyId);
            if (!currentCompany) {
                console.error('Company not found:', companyId);
                return;
            }

            // Update drawer header
            document.getElementById('drawer-company-name').textContent = currentCompany.companyName;
            document.getElementById('drawer-company-email').textContent = currentCompany.ownerEmail || '';

            // Show/hide restore/delete buttons based on status
            if (currentCompany.isDeleted) {
                // Soft deleted company - show restore and hard delete, hide soft delete
                document.getElementById('drawer-soft-delete-btn').style.display = 'none';
                document.getElementById('drawer-restore-btn').style.display = 'block';
                document.getElementById('drawer-hard-delete-btn').style.display = 'block';
            } else {
                // Active company - show soft delete, hide restore and hard delete
                document.getElementById('drawer-soft-delete-btn').style.display = 'block';
                document.getElementById('drawer-restore-btn').style.display = 'none';
                document.getElementById('drawer-hard-delete-btn').style.display = 'none';
            }

            // Open drawer
            document.getElementById('drawer-overlay').classList.add('open');
            document.getElementById('company-drawer').classList.add('open');

            // Load overview tab
            await loadDrawerOverview();
        }

        function closeDrawer() {
            document.getElementById('drawer-overlay').classList.remove('open');
            document.getElementById('company-drawer').classList.remove('open');
            currentCompany = null;
        }

        function switchDrawerTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-drawer-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.drawer-tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(`drawer-${tabName}`).style.display = 'block';

            // Load data for specific tabs
            if (tabName === 'inventory' && currentCompany) {
                loadDrawerInventory();
            } else if (tabName === 'customers' && currentCompany) {
                loadDrawerCustomers();
            }
        }

        async function loadDrawerOverview() {
            const content = document.getElementById('drawer-overview-content');
            content.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <div style="background: #f7fafc; padding: 1rem; border-radius: 6px;">
                        <h3 style="font-weight: 600; margin-bottom: 0.5rem;">Status</h3>
                        <span class="health-badge ${currentCompany.healthBadge.color}">
                            ${currentCompany.healthBadge.icon} ${currentCompany.healthBadge.label}
                        </span>
                    </div>
                    <div style="background: #f7fafc; padding: 1rem; border-radius: 6px;">
                        <h3 style="font-weight: 600; margin-bottom: 0.5rem;">Health Score</h3>
                        <p style="font-size: 2rem; font-weight: 700; color: #3182ce;">${currentCompany.healthScore}/100</p>
                    </div>
                    <div style="background: #f7fafc; padding: 1rem; border-radius: 6px;">
                        <h3 style="font-weight: 600; margin-bottom: 0.5rem;">Metrics</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 0.5rem;"><strong>Calls:</strong> ${currentCompany.calls.toLocaleString()}</li>
                            <li style="margin-bottom: 0.5rem;"><strong>Scenarios:</strong> ${currentCompany.scenarios}</li>
                            <li style="margin-bottom: 0.5rem;"><strong>Customers:</strong> ${currentCompany.customers}</li>
                            <li style="margin-bottom: 0.5rem;"><strong>Last Activity:</strong> ${currentCompany.lastActivityFormatted}</li>
                            <li style="margin-bottom: 0.5rem;"><strong>Created:</strong> ${new Date(currentCompany.createdAt).toLocaleDateString()}</li>
                        </ul>
                    </div>
                    ${currentCompany.flags.length > 0 ? `
                        <div style="background: #fef5e7; padding: 1rem; border-radius: 6px; border-left: 4px solid #ea580c;">
                            <h3 style="font-weight: 600; margin-bottom: 0.5rem; color: #ea580c;">‚ö†Ô∏è Flags</h3>
                            <ul style="list-style: none; padding: 0;">
                                ${currentCompany.flags.map(flag => `<li style="margin-bottom: 0.25rem;">‚Ä¢ ${flag}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function loadDrawerInventory() {
            console.log('[DATA CENTER] üì¶ Loading inventory for:', currentCompany.companyId);
            const content = document.getElementById('drawer-inventory-content');
            content.innerHTML = '<p style="color: #6b7280;">Loading inventory...</p>';

            try {
                const token = localStorage.getItem('adminToken');
                const url = `/api/admin/data-center/companies/${currentCompany.companyId}/inventory`;
                console.log('[DATA CENTER] üåê Fetching inventory:', url);
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                console.log('[DATA CENTER] üì¶ Inventory response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[DATA CENTER] ‚ùå Inventory error response:', errorText);
                    throw new Error(`Failed to load inventory: ${response.status}`);
                }

                const inventory = await response.json();
                console.log('[DATA CENTER] ‚úÖ Inventory loaded:', inventory);

                content.innerHTML = `
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: #f7fafc; padding: 1rem; border-radius: 6px;">
                            <h3 style="font-weight: 600; margin-bottom: 0.5rem;">Collections</h3>
                            <ul style="list-style: none; padding: 0;">
                                <li style="margin-bottom: 0.5rem;"><strong>Calls:</strong> ${inventory.collections.calls.toLocaleString()}</li>
                                <li style="margin-bottom: 0.5rem;"><strong>Contacts:</strong> ${inventory.collections.contacts.toLocaleString()}</li>
                                <li style="margin-bottom: 0.5rem;"><strong>Notifications:</strong> ${inventory.collections.notifications.toLocaleString()}</li>
                                <li style="margin-bottom: 0.5rem;"><strong>Scenarios:</strong> ${inventory.collections.scenarios.toLocaleString()}</li>
                            </ul>
                        </div>
                        <div style="background: #f7fafc; padding: 1rem; border-radius: 6px;">
                            <h3 style="font-weight: 600; margin-bottom: 0.5rem;">Estimated Storage</h3>
                            <p style="font-size: 1.5rem; font-weight: 700; color: #3182ce;">${inventory.estimates.totalFormatted}</p>
                        </div>
                        ${inventory.externals.twilioNumbers.length > 0 ? `
                            <div style="background: #f7fafc; padding: 1rem; border-radius: 6px;">
                                <h3 style="font-weight: 600; margin-bottom: 0.5rem;">Twilio Numbers</h3>
                                <ul style="list-style: none; padding: 0;">
                                    ${inventory.externals.twilioNumbers.map(num => `<li style="margin-bottom: 0.25rem;">${num}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('[DATA CENTER] ‚ùå Error loading inventory:', error);
                content.innerHTML = `
                    <div style="background: #fee; padding: 1rem; border-radius: 6px; border-left: 4px solid #ef4444;">
                        <h3 style="color: #ef4444; font-weight: 600; margin-bottom: 0.5rem;">‚ùå Failed to Load Inventory</h3>
                        <p style="color: #6b7280; margin-bottom: 0.5rem;">${error.message}</p>
                        <button onclick="loadDrawerInventory()" style="background: #3b82f6; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
            }
        }

        async function loadDrawerCustomers() {
            const content = document.getElementById('drawer-customers-content');
            content.innerHTML = '<p style="color: #6b7280;">Loading customers...</p>';

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/data-center/companies/${currentCompany.companyId}/customers?pageSize=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load customers');

                const data = await response.json();

                if (data.results.length === 0) {
                    content.innerHTML = '<p style="color: #6b7280;">No customers found</p>';
                    return;
                }

                content.innerHTML = `
                    <p style="margin-bottom: 1rem; color: #6b7280;">Showing ${data.results.length} of ${data.total} customers</p>
                    <div style="display: grid; gap: 0.75rem;">
                        ${data.results.map(customer => `
                            <div style="background: #f7fafc; padding: 1rem; border-radius: 6px;">
                                <p style="font-weight: 600;">${customer.phoneNumber || customer.name || 'Unknown'}</p>
                                ${customer.email ? `<p style="font-size: 0.875rem; color: #6b7280;">${customer.email}</p>` : ''}
                                ${customer.lastContacted ? `<p style="font-size: 0.875rem; color: #6b7280;">Last contacted: ${new Date(customer.lastContacted).toLocaleDateString()}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading customers:', error);
                content.innerHTML = '<p style="color: #ef4444;">Failed to load customers</p>';
            }
        }

        // ============================================================================
        // TRASH TAB MANAGEMENT
        // ============================================================================
        async function loadTrash() {
            const tbody = document.getElementById('trash-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="loading"><div class="spinner"></div><p>Loading deleted companies...</p></td></tr>';

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/data-center/companies?state=deleted&pageSize=50', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load trash');

                const data = await response.json();

                if (data.results.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><i class="fas fa-trash"></i><h3>Trash is Empty</h3><p>No deleted companies found</p></td></tr>';
                    document.getElementById('trash-count').textContent = '(0)';
                    return;
                }

                tbody.innerHTML = data.results.map(company => `
                    <tr>
                        <td>
                            <strong>${company.companyName}</strong><br>
                            <small style="color: #718096;">${company.ownerEmail || ''}</small>
                        </td>
                        <td>${company.deletedAt ? new Date(company.deletedAt).toLocaleDateString() : 'N/A'}</td>
                        <td>${company.deleteReason || 'No reason'}</td>
                        <td>
                            ${company.daysUntilPurge !== null ? 
                                `<strong style="color: ${company.daysUntilPurge <= 7 ? '#ef4444' : '#ea580c'};">${company.daysUntilPurge} days</strong>` : 
                                'N/A'}
                        </td>
                        <td>
                            <button class="btn btn-success" onclick="restoreCompany('${company.companyId}')">
                                <i class="fas fa-undo"></i> Restore
                            </button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('trash-count').textContent = `(${data.results.length})`;

            } catch (error) {
                console.error('Error loading trash:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #ef4444;">Failed to load deleted companies</td></tr>';
            }
        }

        // ============================================================================
        // COMPANY ACTIONS
        // ============================================================================
        async function confirmSoftDelete() {
            if (!currentCompany) return;

            const reason = prompt(`‚ö†Ô∏è SOFT DELETE: "${currentCompany.companyName}"\n\n‚úÖ Data will be retained INDEFINITELY (no expiration)\n‚úÖ Can be RESTORED anytime\n‚úÖ Can download data for recordkeeping\n\nFor PERMANENT deletion, use "Hard Delete" after soft delete.\n\nEnter reason for deletion:`);
            if (!reason) return;

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/data-center/companies/${currentCompany.companyId}/soft-delete`, {
                    method: 'PATCH',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason, notes: `Soft deleted from Data Center on ${new Date().toISOString()}` })
                });

                if (!response.ok) throw new Error('Failed to delete company');

                const result = await response.json();
                alert(`‚úÖ SOFT DELETE SUCCESS!\n\nCompany "${currentCompany.companyName}" has been marked as deleted.\n\n‚úÖ Data retained indefinitely\n‚úÖ Can be restored anytime\n‚úÖ Can download data for recordkeeping\n\nFor permanent deletion, use "Hard Delete" button.`);
                closeDrawer();
                loadCompanies(document.getElementById('search-input').value, currentFilter);
                refreshSummary(); // Refresh counts

            } catch (error) {
                console.error('Error deleting company:', error);
                alert('‚ùå Failed to delete company: ' + error.message);
            }
        }

        async function confirmRestore() {
            if (!currentCompany) return;

            if (!confirm(`Are you sure you want to restore "${currentCompany.companyName}"?`)) return;

            await restoreCompany(currentCompany.companyId);
            closeDrawer();
        }

        async function restoreCompany(companyId) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/data-center/companies/${companyId}/restore`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to restore company');

                alert('‚úÖ Company restored successfully!\n\nThe company is now active and visible in the directory.');
                loadCompanies(document.getElementById('search-input').value, currentFilter);
                loadTrash(); // Refresh trash if open
                refreshSummary(); // Refresh counts

            } catch (error) {
                console.error('Error restoring company:', error);
                alert('‚ùå Failed to restore company: ' + error.message);
            }
        }

        async function confirmHardDelete() {
            if (!currentCompany) return;

            // First confirmation
            const confirmed1 = confirm(
                `‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è PERMANENT DELETION WARNING ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\n` +
                `Company: ${currentCompany.companyName}\n` +
                `ID: ${currentCompany.companyId}\n\n` +
                `This will PERMANENTLY delete:\n` +
                `‚Ä¢ Company profile and settings\n` +
                `‚Ä¢ All call logs and transcripts\n` +
                `‚Ä¢ All contacts and customer data\n` +
                `‚Ä¢ All Q&A and knowledge base\n` +
                `‚Ä¢ All notifications and templates\n` +
                `‚Ä¢ All Redis cache data\n\n` +
                `‚ö†Ô∏è THIS ACTION CANNOT BE UNDONE!\n` +
                `‚ö†Ô∏è DATA WILL BE LOST FOREVER!\n\n` +
                `Are you ABSOLUTELY SURE you want to proceed?`
            );
            
            if (!confirmed1) return;

            // Second confirmation - type company name
            const typedName = prompt(
                `‚ö†Ô∏è FINAL CONFIRMATION\n\n` +
                `To confirm PERMANENT deletion, please type the company name EXACTLY:\n\n` +
                `"${currentCompany.companyName}"\n\n` +
                `This is your last chance to cancel!`
            );
            
            if (typedName !== currentCompany.companyName) {
                alert('‚ùå Company name does not match. Hard delete cancelled for safety.');
                return;
            }

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/data-center/companies/${currentCompany.companyId}/hard-delete`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ confirmDelete: true })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to delete company');
                }

                const result = await response.json();
                
                alert(
                    `üíÄ PERMANENT DELETION COMPLETE\n\n` +
                    `Company: ${result.companyName}\n` +
                    `Records Deleted: ${result.deletedRecords?.total || 'N/A'}\n\n` +
                    `‚ö†Ô∏è This action cannot be undone!\n` +
                    `All data has been permanently removed.`
                );
                
                closeDrawer();
                loadCompanies(document.getElementById('search-input').value, currentFilter);
                loadTrash(); // Refresh trash if open
                refreshSummary(); // Refresh counts

            } catch (error) {
                console.error('Error hard deleting company:', error);
                alert('‚ùå Failed to permanently delete company: ' + error.message);
            }
        }

        function viewCompanyProfile() {
            if (!currentCompany) return;
            window.open(`/company-profile.html?id=${currentCompany.companyId}`, '_blank');
        }

        async function downloadCompanyData() {
            if (!currentCompany) return;

            try {
                // Show loading state
                const btn = document.getElementById('drawer-download-btn');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';

                const token = localStorage.getItem('adminToken');
                
                // Fetch company data
                const response = await fetch(`/api/company/${currentCompany.companyId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to fetch company data');

                const companyData = await response.json();
                
                // Create comprehensive export
                const exportData = {
                    exportedAt: new Date().toISOString(),
                    exportedBy: 'Data Center Admin',
                    company: {
                        id: companyData._id,
                        name: companyData.companyName || companyData.businessName,
                        email: companyData.ownerEmail,
                        phone: companyData.businessPhone,
                        status: companyData.accountStatus?.status,
                        isDeleted: companyData.isDeleted,
                        deletedAt: companyData.deletedAt,
                        deletedBy: companyData.deletedBy,
                        deleteReason: companyData.deleteReason,
                        createdAt: companyData.createdAt,
                        updatedAt: companyData.updatedAt
                    },
                    aiAgent: {
                        voiceSettings: companyData.aiAgentLogic?.voiceSettings,
                        connectionMessages: companyData.connectionMessages,
                        placeholders: companyData.aiAgentLogic?.placeholders,
                        instantResponses: companyData.aiAgentLogic?.instantResponses
                    },
                    configuration: companyData.configuration,
                    twilioConfig: {
                        phoneNumbers: companyData.twilioConfig?.phoneNumbers,
                        primaryPhone: companyData.twilioConfig?.phoneNumber
                    },
                    tradeCategories: companyData.tradeCategories,
                    notes: companyData.notes
                };

                // Download as JSON
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${companyData.companyName || 'company'}-data-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert(`‚úÖ Company data downloaded successfully!\n\nFile: ${a.download}\n\nYou can use this file for recordkeeping or to restore data later.`);

                // Reset button
                btn.disabled = false;
                btn.innerHTML = originalText;

            } catch (error) {
                console.error('Error downloading company data:', error);
                alert('‚ùå Failed to download company data: ' + error.message);
                
                // Reset button
                const btn = document.getElementById('drawer-download-btn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download"></i> Download Company Data';
            }
        }

        // ============================================================================
        // CSV EXPORT FUNCTIONS
        // ============================================================================
        async function exportCustomers() {
            if (!currentCompany) return;

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/data-center/companies/${currentCompany.companyId}/customers?pageSize=10000`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to fetch customers');

                const data = await response.json();
                
                // Convert to CSV
                const csv = convertToCSV(data.results, ['phoneNumber', 'name', 'email', 'lastContacted']);
                downloadCSV(csv, `${currentCompany.companyName}-customers.csv`);

            } catch (error) {
                console.error('Error exporting customers:', error);
                alert('Failed to export customers');
            }
        }

        async function exportTranscripts() {
            if (!currentCompany) return;

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/data-center/companies/${currentCompany.companyId}/transcripts?pageSize=10000`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to fetch transcripts');

                const data = await response.json();
                
                // Convert to CSV
                const csv = convertToCSV(data.results, ['timestamp', 'callerNumber', 'duration', 'status']);
                downloadCSV(csv, `${currentCompany.companyName}-transcripts.csv`);

            } catch (error) {
                console.error('Error exporting transcripts:', error);
                alert('Failed to export transcripts');
            }
        }

        function convertToCSV(data, fields) {
            if (data.length === 0) return '';

            const headers = fields.join(',');
            const rows = data.map(item => {
                return fields.map(field => {
                    const value = item[field] || '';
                    // Escape quotes and wrap in quotes if contains comma
                    return typeof value === 'string' && value.includes(',') ? `"${value.replace(/"/g, '""')}"` : value;
                }).join(',');
            });

            return [headers, ...rows].join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        async function seedE2E() {
            const token = localStorage.getItem('adminToken');
            const out = document.getElementById('settings-output');
            const banner = document.getElementById('settings-banner');
            try {
                out.textContent = 'Seeding‚Ä¶';
                const res = await fetch('/api/admin/data-center/seed/e2e', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || data.ok === false) {
                    throw new Error(data.error || `HTTP ${res.status}`);
                }
                out.textContent = JSON.stringify(data, null, 2);
                showSettingsBanner('‚úÖ Seeded fixtures successfully. Refreshing summary and companies‚Ä¶', 'success');
                await refreshSummary();
                await loadCompanies('', 'all');
                // Switch to Deleted to show the seeded deleted company
                applyFilter('deleted');
            } catch (e) {
                out.textContent = `Seed failed: ${e.message}`;
                showSettingsBanner('‚ùå Seed failed: ' + e.message, 'error');
            }
        }

        async function wipeE2E() {
            const token = localStorage.getItem('adminToken');
            const out = document.getElementById('settings-output');
            try {
                out.textContent = 'Wiping‚Ä¶';
                const res = await fetch('/api/admin/data-center/seed/e2e/wipe', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || data.ok === false) {
                    throw new Error(data.error || `HTTP ${res.status}`);
                }
                out.textContent = JSON.stringify(data, null, 2);
                showSettingsBanner('‚úÖ Wiped fixtures successfully. Refreshing summary and companies‚Ä¶', 'success');
                await refreshSummary();
                await loadCompanies('', 'all');
                applyFilter('all');
            } catch (e) {
                out.textContent = `Wipe failed: ${e.message}`;
                showSettingsBanner('‚ùå Wipe failed: ' + e.message, 'error');
            }
        }

        function showSettingsBanner(message, type) {
            const banner = document.getElementById('settings-banner');
            if (!banner) return;
            banner.style.display = 'block';
            banner.textContent = message;
            banner.style.background = type === 'success' ? '#ecfdf5' : '#fef2f2';
            banner.style.border = '1px solid ' + (type === 'success' ? '#10b981' : '#ef4444');
            banner.style.color = type === 'success' ? '#065f46' : '#7f1d1d';
        }
        function showError(message) {
            alert(message);
        }
    </script>
</body>
</html>

