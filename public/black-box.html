<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Box Recorder | ClientsVia</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-hover: #22222e;
            --border-color: #2a2a38;
            --text-primary: #e5e5e5;
            --text-secondary: #a0a0b0;
            --text-muted: #6b6b7b;
            --accent-red: #ef4444;
            --accent-orange: #f97316;
            --accent-yellow: #eab308;
            --accent-green: #22c55e;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           NAVIGATION BAR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .nav-bar {
            background: #000;
            padding: 0 24px;
            display: flex;
            align-items: center;
            height: 56px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-bar a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 16px 20px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .nav-bar a:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.05);
        }

        .nav-bar a.active {
            color: var(--accent-red);
            border-bottom-color: var(--accent-red);
        }

        .nav-back {
            background: var(--accent-blue) !important;
            color: white !important;
            border-radius: 6px;
            padding: 8px 16px !important;
            margin-right: 20px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PAGE HEADER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .page-header {
            padding: 32px 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title span {
            color: var(--accent-red);
        }

        .page-subtitle {
            color: var(--text-secondary);
            margin-top: 8px;
            font-size: 14px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           STATS BAR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .stats-bar {
            display: flex;
            gap: 24px;
            padding: 20px 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px 24px;
            min-width: 140px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .stat-card.critical .stat-value { color: var(--accent-red); }
        .stat-card.warning .stat-value { color: var(--accent-orange); }
        .stat-card.success .stat-value { color: var(--accent-green); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FILTERS BAR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .filters-bar {
            display: flex;
            gap: 16px;
            padding: 20px 40px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input[type="text"], input[type="date"] {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .toggle-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: var(--bg-hover);
        }

        .toggle-btn.active {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
        }

        .search-input {
            width: 220px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• PHASE 2.5: BREAKDOWN BAR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .breakdown-bar {
            padding: 12px 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 32px;
            flex-wrap: wrap;
        }
        
        .breakdown-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .breakdown-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .breakdown-chip {
            font-size: 12px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .breakdown-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        /* Source chips */
        .source-voice { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        .source-test { background: rgba(139, 92, 246, 0.15); color: var(--accent-purple); }
        .source-sms { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        .source-web { background: rgba(249, 115, 22, 0.15); color: var(--accent-orange); }
        
        /* Mode chips */
        .mode-discovery { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        .mode-booking { background: rgba(234, 179, 8, 0.15); color: var(--accent-yellow); }
        .mode-complete { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        
        /* Booking state chips */
        .booking-locked { background: rgba(234, 179, 8, 0.15); color: var(--accent-yellow); }
        .booking-started { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        .booking-none { background: rgba(255, 255, 255, 0.05); color: var(--text-muted); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CALL LIST
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .call-list {
            padding: 24px 40px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .call-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .call-card:hover {
            background: var(--bg-hover);
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }

        .call-card.has-problems {
            border-left: 4px solid var(--accent-red);
        }

        .call-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .call-phones {
            font-size: 16px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .call-phones .arrow {
            color: var(--text-muted);
            margin: 0 8px;
        }

        /* ğŸ†• PHASE 2: Source tag styles */
        .source-tag {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
            text-transform: uppercase;
        }
        
        .source-voice { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .source-test { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }
        .source-sms { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .source-web { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        
        .mode-tag {
            font-weight: 500;
        }
        
        .mode-tag strong {
            color: var(--accent-blue);
        }
        
        /* ğŸ†• PHASE 2: Locks display */
        .call-locks {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .lock-chip {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
        }
        
        .lock-chip.lock-active {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
        }
        
        .lock-chip.lock-locked {
            background: rgba(234, 179, 8, 0.15);
            color: var(--accent-yellow);
        }

        .call-meta {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .call-outcome {
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .outcome-COMPLETED { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .outcome-TRANSFERRED { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }
        .outcome-HUNG_UP { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .outcome-ABANDONED { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        .outcome-ERROR { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }

        .call-details {
            display: flex;
            gap: 24px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .call-details strong {
            color: var(--text-primary);
        }

        .call-flags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .flag-chip {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .flag-loopDetected { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        .flag-bailoutTriggered { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .flag-bookingIgnored { background: rgba(234, 179, 8, 0.2); color: var(--accent-yellow); }
        .flag-slowResponse { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .flag-noTriageMatch { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }
        .flag-customerFrustrated { background: rgba(236, 72, 153, 0.2); color: var(--accent-pink); }

        .call-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-refresh {
            background: #334155 !important;
            color: #f1f5f9 !important;
            border: 2px solid #64748b !important;
            font-weight: 600;
        }

        .btn-refresh:hover {
            background: #475569 !important;
            border-color: #94a3b8 !important;
            transform: scale(1.02);
        }

        .btn-refresh:active {
            transform: scale(0.98);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LOADING & EMPTY STATES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .loading-state, .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: var(--text-secondary);
        }

        .loading-state .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PAGINATION
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 24px;
        }

        .pagination button {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <a href="#" class="nav-back" id="navBack">â† Back to Profile</a>
        <a href="#" id="navControlPlane">ClientsVia Control Plane</a>
        <a href="#" id="navAiCore">AiCore Control Center</a>
        <a href="#" id="navCompanyOps">CompanyOps Console</a>
        <a href="#" id="navBlackBox" class="active">Black Box Recorder</a>
    </nav>

    <!-- Page Header -->
    <header class="page-header">
        <h1 class="page-title">
            ğŸ“¼ <span>Black Box</span> Recorder
        </h1>
        <p class="page-subtitle">
            Enterprise Call Flight Recorder â€¢ Every decision, every millisecond, every branch taken
        </p>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar" id="statsBar">
        <div class="stat-card">
            <div class="stat-value" id="statTotalCalls">-</div>
            <div class="stat-label">Total Calls (7d)</div>
        </div>
        <div class="stat-card critical">
            <div class="stat-value" id="statProblems">-</div>
            <div class="stat-label">Problems Detected</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-value" id="statLoops">-</div>
            <div class="stat-label">Loops</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-value" id="statBailouts">-</div>
            <div class="stat-label">Bailouts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statAvgTurnTime">-</div>
            <div class="stat-label">Avg Turn Time</div>
        </div>
    </div>
    
    <!-- ğŸ†• PHASE 2.5: Source Breakdown Bar -->
    <div class="breakdown-bar" id="breakdownBar">
        <div class="breakdown-section">
            <span class="breakdown-title">ğŸ“¡ By Source:</span>
            <span class="breakdown-chip source-voice" id="breakdownVoice">ğŸ“ Voice: -</span>
            <span class="breakdown-chip source-test" id="breakdownTest">ğŸ§ª Test: -</span>
            <span class="breakdown-chip source-sms" id="breakdownSms">ğŸ’¬ SMS: -</span>
            <span class="breakdown-chip source-web" id="breakdownWeb">ğŸŒ Web: -</span>
        </div>
        <div class="breakdown-section">
            <span class="breakdown-title">ğŸ¯ By Mode:</span>
            <span class="breakdown-chip mode-discovery" id="breakdownDiscovery">ğŸ” Discovery: -</span>
            <span class="breakdown-chip mode-booking" id="breakdownBooking">ğŸ“‹ Booking: -</span>
            <span class="breakdown-chip mode-complete" id="breakdownComplete">âœ… Complete: -</span>
        </div>
        <div class="breakdown-section">
            <span class="breakdown-title">ğŸ”’ Booking State:</span>
            <span class="breakdown-chip booking-locked" id="breakdownLocked">ğŸ”’ Locked: -</span>
            <span class="breakdown-chip booking-started" id="breakdownStarted">ğŸ“ Started: -</span>
            <span class="breakdown-chip booking-none" id="breakdownNone">â³ None: -</span>
        </div>
    </div>

    <!-- Filters Bar -->
    <div class="filters-bar">
        <div class="filter-group">
            <span class="filter-label">Period</span>
            <select id="filterPeriod">
                <option value="1">Last 24 Hours</option>
                <option value="7" selected>Last 7 Days</option>
                <option value="30">Last 30 Days</option>
                <option value="90">Last 90 Days</option>
            </select>
        </div>

        <div class="filter-group">
            <span class="filter-label">Flag</span>
            <select id="filterFlag">
                <option value="">All Calls</option>
                <option value="loopDetected">Loops</option>
                <option value="bailoutTriggered">Bailouts</option>
                <option value="bookingIgnored">Booking Ignored</option>
                <option value="slowResponse">Slow Response</option>
                <option value="noTriageMatch">No Triage Match</option>
                <option value="customerFrustrated">Frustrated Customer</option>
            </select>
        </div>
        
        <!-- ğŸ†• PHASE 2.5: Source Filter -->
        <div class="filter-group">
            <span class="filter-label">Source</span>
            <select id="filterSource">
                <option value="">All Sources</option>
                <option value="voice">ğŸ“ Voice</option>
                <option value="test">ğŸ§ª Test Console</option>
                <option value="sms">ğŸ’¬ SMS</option>
                <option value="web">ğŸŒ Web Chat</option>
            </select>
        </div>
        
        <!-- ğŸ†• PHASE 2.5: Mode Filter -->
        <div class="filter-group">
            <span class="filter-label">Mode</span>
            <select id="filterMode">
                <option value="">All Modes</option>
                <option value="DISCOVERY">ğŸ” Discovery</option>
                <option value="BOOKING">ğŸ“‹ Booking</option>
                <option value="COMPLETE">âœ… Complete</option>
                <option value="ERROR">âŒ Error</option>
            </select>
        </div>
        
        <!-- ğŸ†• PHASE 2.5: Booking Lock Filter -->
        <div class="filter-group">
            <span class="filter-label">Booking</span>
            <select id="filterBookingLock">
                <option value="">All States</option>
                <option value="locked">ğŸ”’ Locked</option>
                <option value="started">ğŸ“ Started</option>
                <option value="none">â³ Not Started</option>
            </select>
        </div>

        <div class="filter-group">
            <input type="text" id="filterSearch" class="search-input" placeholder="Search by phone or CallSid...">
        </div>

        <button class="toggle-btn" id="toggleProblematic">
            ğŸš¨ Only Problematic
        </button>

        <button class="btn btn-refresh" onclick="refreshData()">
            ğŸ”„ Refresh
        </button>
    </div>

    <!-- Call List -->
    <div class="call-list" id="callList">
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading call recordings...</p>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" id="pagination" style="display: none;">
        <button id="prevPage">â† Previous</button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage">Next â†’</button>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let companyId = null;
        let currentPage = 0;
        const pageSize = 20;
        let totalCalls = 0;
        let onlyProblematic = false;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('DOMContentLoaded', async () => {
            // Get companyId from URL
            const params = new URLSearchParams(window.location.search);
            companyId = params.get('companyId');

            if (!companyId) {
                showError('No company ID provided');
                return;
            }

            // Update nav links with companyId
            updateNavLinks();
            
            // ğŸ†• PHASE 2.5: Restore filters from URL
            restoreFiltersFromURL();

            // Load stats and calls
            await Promise.all([
                loadStats(),
                loadCalls()
            ]);

            // Setup event listeners
            setupEventListeners();
        });

        function updateNavLinks() {
            // Back to Profile - goes to company profile page
            document.getElementById('navBack').href = `company-profile.html?companyId=${companyId}`;
            
            // Control Plane V2 - main control plane
            document.getElementById('navControlPlane').href = `control-plane-v2.html?companyId=${companyId}`;
            
            // AiCore Control Center - it's a tab within Control Plane V2
            document.getElementById('navAiCore').href = `control-plane-v2.html?companyId=${companyId}&tab=aicore`;
            
            // CompanyOps Console - it's a tab within Control Plane V2
            document.getElementById('navCompanyOps').href = `control-plane-v2.html?companyId=${companyId}&tab=companyops`;
            
            // Black Box Recorder - current page
            document.getElementById('navBlackBox').href = `black-box.html?companyId=${companyId}`;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DATA LOADING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadStats() {
            try {
                const days = document.getElementById('filterPeriod').value;
                const token = localStorage.getItem('adminToken');
                
                const response = await fetch(`/api/company/${companyId}/blackbox/stats?days=${days}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load stats');

                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('statTotalCalls').textContent = data.stats.totalCalls;
                    document.getElementById('statProblems').textContent = 
                        data.stats.loopsDetected + data.stats.bailoutsTriggered + 
                        data.stats.bookingsIgnored + data.stats.slowResponses;
                    document.getElementById('statLoops').textContent = data.stats.loopsDetected;
                    document.getElementById('statBailouts').textContent = data.stats.bailoutsTriggered;
                    document.getElementById('statAvgTurnTime').textContent = 
                        data.stats.avgTurnTimeMs ? `${(data.stats.avgTurnTimeMs / 1000).toFixed(1)}s` : '-';
                    
                    // ğŸ†• PHASE 2.5: Update breakdown bar
                    if (data.breakdown) {
                        const { bySource, byMode, byBooking } = data.breakdown;
                        
                        // Source breakdown (clickable to filter)
                        document.getElementById('breakdownVoice').textContent = `ğŸ“ Voice: ${bySource.voice || 0}`;
                        document.getElementById('breakdownVoice').onclick = () => setFilter('filterSource', 'voice');
                        document.getElementById('breakdownTest').textContent = `ğŸ§ª Test: ${bySource.test || 0}`;
                        document.getElementById('breakdownTest').onclick = () => setFilter('filterSource', 'test');
                        document.getElementById('breakdownSms').textContent = `ğŸ’¬ SMS: ${bySource.sms || 0}`;
                        document.getElementById('breakdownSms').onclick = () => setFilter('filterSource', 'sms');
                        document.getElementById('breakdownWeb').textContent = `ğŸŒ Web: ${bySource.web || 0}`;
                        document.getElementById('breakdownWeb').onclick = () => setFilter('filterSource', 'web');
                        
                        // Mode breakdown (clickable to filter)
                        document.getElementById('breakdownDiscovery').textContent = `ğŸ” Discovery: ${byMode.DISCOVERY || 0}`;
                        document.getElementById('breakdownDiscovery').onclick = () => setFilter('filterMode', 'DISCOVERY');
                        document.getElementById('breakdownBooking').textContent = `ğŸ“‹ Booking: ${byMode.BOOKING || 0}`;
                        document.getElementById('breakdownBooking').onclick = () => setFilter('filterMode', 'BOOKING');
                        document.getElementById('breakdownComplete').textContent = `âœ… Complete: ${byMode.COMPLETE || 0}`;
                        document.getElementById('breakdownComplete').onclick = () => setFilter('filterMode', 'COMPLETE');
                        
                        // Booking state breakdown (clickable to filter)
                        document.getElementById('breakdownLocked').textContent = `ğŸ”’ Locked: ${byBooking.locked || 0}`;
                        document.getElementById('breakdownLocked').onclick = () => setFilter('filterBookingLock', 'locked');
                        document.getElementById('breakdownStarted').textContent = `ğŸ“ Started: ${byBooking.started || 0}`;
                        document.getElementById('breakdownStarted').onclick = () => setFilter('filterBookingLock', 'started');
                        document.getElementById('breakdownNone').textContent = `â³ None: ${byBooking.none || 0}`;
                        document.getElementById('breakdownNone').onclick = () => setFilter('filterBookingLock', 'none');
                    }
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadCalls() {
            try {
                const token = localStorage.getItem('adminToken');
                const flag = document.getElementById('filterFlag').value;
                const search = document.getElementById('filterSearch').value;
                const days = document.getElementById('filterPeriod').value;
                
                // ğŸ†• PHASE 2.5: New filter values
                const source = document.getElementById('filterSource').value;
                const mode = document.getElementById('filterMode').value;
                const bookingLock = document.getElementById('filterBookingLock').value;
                
                const fromDate = new Date();
                fromDate.setDate(fromDate.getDate() - parseInt(days));
                
                let url = `/api/company/${companyId}/blackbox/list?limit=${pageSize}&skip=${currentPage * pageSize}`;
                url += `&fromDate=${fromDate.toISOString()}`;
                if (flag) url += `&flag=${flag}`;
                if (search) url += `&phone=${encodeURIComponent(search)}`;
                if (onlyProblematic) url += `&onlyProblematic=true`;
                
                // ğŸ†• PHASE 2.5: Add new filter params
                if (source) url += `&source=${source}`;
                if (mode) url += `&mode=${mode}`;
                if (bookingLock) url += `&bookingLock=${bookingLock}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load calls');

                const data = await response.json();
                
                if (data.success) {
                    totalCalls = data.total;
                    renderCalls(data.calls);
                    updatePagination();
                }
            } catch (error) {
                console.error('Failed to load calls:', error);
                showError('Failed to load calls: ' + error.message);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDERING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderCalls(calls) {
            const container = document.getElementById('callList');
            
            if (calls.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“¼</div>
                        <h3>No recordings found</h3>
                        <p>Call recordings will appear here once calls are made.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = calls.map(call => renderCallCard(call)).join('');
        }

        function renderCallCard(call) {
            const hasProblems = call.flags && Object.values(call.flags).some(v => v);
            const startDate = new Date(call.startedAt);
            const duration = call.durationMs ? formatDuration(call.durationMs) : '-';
            
            const flags = [];
            if (call.flags?.loopDetected) flags.push({ key: 'loopDetected', label: 'ğŸ”„ LOOP' });
            if (call.flags?.bailoutTriggered) flags.push({ key: 'bailoutTriggered', label: 'ğŸš¨ BAILOUT' });
            if (call.flags?.bookingIgnored) flags.push({ key: 'bookingIgnored', label: 'ğŸ“… BOOKING IGNORED' });
            if (call.flags?.slowResponse) flags.push({ key: 'slowResponse', label: 'ğŸ¢ SLOW' });
            if (call.flags?.noTriageMatch) flags.push({ key: 'noTriageMatch', label: 'âŒ NO TRIAGE' });
            if (call.flags?.customerFrustrated) flags.push({ key: 'customerFrustrated', label: 'ğŸ˜¤ FRUSTRATED' });

            // ğŸ†• PHASE 2: Source tag (voice/test/sms/web)
            const sourceIcons = { voice: 'ğŸ“', test: 'ğŸ§ª', sms: 'ğŸ’¬', web: 'ğŸŒ' };
            const sourceIcon = sourceIcons[call.source] || 'ğŸ“';
            const sourceLabel = call.source || 'voice';
            
            // ğŸ†• PHASE 2: Mode/Phase display
            const modeDisplay = call.sessionSnapshot?.mode || '-';
            const locksDisplay = call.sessionSnapshot?.locks;
            
            return `
                <div class="call-card ${hasProblems ? 'has-problems' : ''}" onclick="viewCall('${call.callId}')">
                    <div class="call-header">
                        <div>
                            <div class="call-phones">
                                ${sourceIcon} ${formatPhone(call.from)} <span class="arrow">â†’</span> ${formatPhone(call.to)}
                                <span class="source-tag source-${sourceLabel}">${sourceLabel.toUpperCase()}</span>
                            </div>
                        </div>
                        <span class="call-outcome outcome-${call.callOutcome}">${call.callOutcome}</span>
                    </div>
                    
                    <div class="call-meta">
                        <span>ğŸ“… ${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString()}</span>
                        <span>â±ï¸ ${duration}</span>
                        <span class="mode-tag">Mode: <strong>${modeDisplay}</strong></span>
                    </div>
                    
                    <div class="call-details">
                        <span>Intent: <strong>${call.primaryIntent || 'unknown'}</strong> ${call.primaryIntentConfidence ? `(${(call.primaryIntentConfidence * 100).toFixed(0)}%)` : ''}</span>
                        <span>Turns: <strong>${call.performance?.totalTurns || 0}</strong></span>
                        <span>Avg Turn: <strong>${call.performance?.avgTurnTimeMs ? `${(call.performance.avgTurnTimeMs / 1000).toFixed(1)}s` : '-'}</strong></span>
                    </div>
                    
                    ${locksDisplay ? `
                        <div class="call-locks">
                            ${locksDisplay.greeted ? '<span class="lock-chip lock-active">âœ“ Greeted</span>' : ''}
                            ${locksDisplay.issueCaptured ? '<span class="lock-chip lock-active">âœ“ Issue</span>' : ''}
                            ${locksDisplay.bookingStarted ? '<span class="lock-chip lock-active">âœ“ Booking</span>' : ''}
                            ${locksDisplay.bookingLocked ? '<span class="lock-chip lock-locked">ğŸ”’ Locked</span>' : ''}
                        </div>
                    ` : ''}
                    
                    ${flags.length > 0 ? `
                        <div class="call-flags">
                            ${flags.map(f => `<span class="flag-chip flag-${f.key}">${f.label}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="call-actions" onclick="event.stopPropagation()">
                        <button class="btn btn-primary" onclick="viewCall('${call.callId}')">View Details</button>
                        <button class="btn btn-secondary" onclick="copySnapshot('${call.callId}')">Copy for Engineering</button>
                    </div>
                </div>
            `;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ACTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function viewCall(callId) {
            window.location.href = `black-box-detail.html?companyId=${companyId}&callId=${callId}`;
        }

        async function copySnapshot(callId) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/company/${companyId}/blackbox/call/${callId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load call');

                const data = await response.json();
                
                if (data.success && data.snapshot) {
                    await navigator.clipboard.writeText(data.snapshot);
                    alert('âœ… Engineering snapshot copied to clipboard!');
                }
            } catch (error) {
                console.error('Failed to copy snapshot:', error);
                alert('Failed to copy snapshot: ' + error.message);
            }
        }

        async function refreshData() {
            // Show loading state
            const callList = document.getElementById('callList');
            const refreshBtn = document.querySelector('.btn-refresh');
            
            // Visual feedback
            refreshBtn.innerHTML = 'â³ Loading...';
            refreshBtn.disabled = true;
            callList.innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Refreshing call recordings...</p>
                </div>
            `;
            
            currentPage = 0;
            
            try {
                await Promise.all([loadStats(), loadCalls()]);
            } catch (error) {
                console.error('Refresh failed:', error);
            } finally {
                // Restore button
                refreshBtn.innerHTML = 'ğŸ”„ Refresh';
                refreshBtn.disabled = false;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PAGINATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(totalCalls / pageSize);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} of ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage === 0;
            document.getElementById('nextPage').disabled = currentPage >= totalPages - 1;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EVENT LISTENERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setupEventListeners() {
            document.getElementById('filterPeriod').addEventListener('change', () => {
                currentPage = 0;
                loadStats();
                loadCalls();
            });

            document.getElementById('filterFlag').addEventListener('change', () => {
                currentPage = 0;
                loadCalls();
            });
            
            // ğŸ†• PHASE 2.5: New filter event listeners
            document.getElementById('filterSource').addEventListener('change', () => {
                currentPage = 0;
                loadCalls();
                saveFiltersToURL();
            });
            
            document.getElementById('filterMode').addEventListener('change', () => {
                currentPage = 0;
                loadCalls();
                saveFiltersToURL();
            });
            
            document.getElementById('filterBookingLock').addEventListener('change', () => {
                currentPage = 0;
                loadCalls();
                saveFiltersToURL();
            });

            let searchTimeout;
            document.getElementById('filterSearch').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 0;
                    loadCalls();
                }, 300);
            });

            document.getElementById('toggleProblematic').addEventListener('click', (e) => {
                onlyProblematic = !onlyProblematic;
                e.target.classList.toggle('active', onlyProblematic);
                currentPage = 0;
                loadCalls();
            });

            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 0) {
                    currentPage--;
                    loadCalls();
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                const totalPages = Math.ceil(totalCalls / pageSize);
                if (currentPage < totalPages - 1) {
                    currentPage++;
                    loadCalls();
                }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• PHASE 2.5: URL STATE MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function saveFiltersToURL() {
            const params = new URLSearchParams(window.location.search);
            
            const source = document.getElementById('filterSource').value;
            const mode = document.getElementById('filterMode').value;
            const bookingLock = document.getElementById('filterBookingLock').value;
            
            if (source) params.set('source', source);
            else params.delete('source');
            
            if (mode) params.set('mode', mode);
            else params.delete('mode');
            
            if (bookingLock) params.set('bookingLock', bookingLock);
            else params.delete('bookingLock');
            
            const newURL = `${window.location.pathname}?${params.toString()}`;
            window.history.replaceState({}, '', newURL);
        }
        
        function restoreFiltersFromURL() {
            const params = new URLSearchParams(window.location.search);
            
            const source = params.get('source');
            const mode = params.get('mode');
            const bookingLock = params.get('bookingLock');
            
            if (source) document.getElementById('filterSource').value = source;
            if (mode) document.getElementById('filterMode').value = mode;
            if (bookingLock) document.getElementById('filterBookingLock').value = bookingLock;
        }
        
        // ğŸ†• PHASE 2.5: Helper to set filter and reload
        function setFilter(filterId, value) {
            document.getElementById(filterId).value = value;
            currentPage = 0;
            loadCalls();
            saveFiltersToURL();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HELPERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function formatPhone(phone) {
            if (!phone) return '-';
            const digits = phone.replace(/\D/g, '');
            if (digits.length === 11 && digits.startsWith('1')) {
                return `+1 ${digits.slice(1,4)}-${digits.slice(4,7)}-${digits.slice(7)}`;
            }
            return phone;
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${String(secs).padStart(2, '0')}`;
        }

        function showError(message) {
            const container = document.getElementById('callList');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">âŒ</div>
                    <h3>Error</h3>
                    <p>${message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>

