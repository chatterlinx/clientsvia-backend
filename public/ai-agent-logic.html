<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Logic - ClientsVia Intelligence Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- Ultra-Security Components -->
    <script src="/js/hardwareFingerprint.js"></script>
    <script src="/js/biometricAnalyzer.js"></script>
    <script src="/js/totpGenerator.js"></script>
    <script src="/js/ultraSecureSession.js"></script>
    <style>
        .priority-item { transition: all 0.3s ease; }
        .priority-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .intelligence-badge { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .performance-bar { background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%); }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        .ai-status-dot { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-brain text-blue-600 mr-3"></i>
                        AI Agent Logic
                    </h1>
                    <p class="text-gray-600 mt-1">Agent Personality & Complete AI Configuration - Priority Flow & Knowledge Sources</p>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Security Status -->
                    <div id="security-status" class="bg-gray-100 p-3 rounded-lg">
                        <div class="flex items-center text-sm">
                            <i class="fas fa-shield-alt text-gray-400 mr-2"></i>
                            <span class="text-gray-500">Initializing security...</span>
                        </div>
                    </div>
                    
                    <!-- TOTP Display -->
                    <div id="totp-display"></div>
                    
                    <!-- AI Status -->
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-400 rounded-full mr-2 ai-status-dot"></div>
                        <span class="text-sm text-gray-600">Agent Active</span>
                    </div>
                    
                    <!-- Quick Actions -->
                    <button onclick="optimizeAgent()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                        <i class="fas fa-magic mr-2"></i>Auto-Optimize
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="flex border-b">
                <button class="tab-button active px-6 py-4 text-blue-600 border-b-2 border-blue-600 font-medium" onclick="switchTab('priority-flow')">
                    <i class="fas fa-layer-group mr-2"></i>Answer Priority Flow
                </button>
                <button class="tab-button px-6 py-4 text-gray-500 hover:text-gray-700 font-medium" onclick="switchTab('knowledge-controls')">
                    <i class="fas fa-cog mr-2"></i>Knowledge Source Controls
                </button>
                <button class="tab-button px-6 py-4 text-gray-500 hover:text-gray-700 font-medium" onclick="switchTab('agent-personality')">
                    <i class="fas fa-user-robot mr-2"></i>Agent Personality
                </button>
            </div>
        </div>

        <!-- Priority Flow Tab -->
        <div id="priority-flow-tab" class="tab-content">
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">Answer Priority Flow</h2>
                        <p class="text-gray-600 text-sm">(Drag to reorder)</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="addKnowledgeSource()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Source
                        </button>
                        <button onclick="resetToDefaults()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                            <i class="fas fa-undo mr-2"></i>Reset Defaults
                        </button>
                    </div>
                </div>

                <!-- Priority Flow Items -->
                <div id="priority-flow-container" class="space-y-4">
                    <!-- Company Knowledge Base -->
                    <div class="priority-item bg-white border border-gray-200 rounded-lg p-4 flex items-center" data-source="company_knowledge">
                        <div class="drag-handle text-gray-400 mr-4">
                            <i class="fas fa-grip-vertical text-lg"></i>
                        </div>
                        <div class="flex-shrink-0 mr-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-building text-blue-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="font-semibold text-gray-900 flex items-center">
                                        Company Knowledge Base
                                        <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Primary</span>
                                        <i class="fas fa-star text-yellow-500 ml-2"></i>
                                    </h3>
                                    <p class="text-gray-600 text-sm">Company-specific Q&A and internal documentation</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div class="text-right">
                                        <div class="text-sm font-medium text-green-600">92% Success</div>
                                        <div class="text-xs text-gray-500">1,247 uses</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" checked class="sr-only peer" onchange="toggleSource('company_knowledge', this)">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        <span class="ml-3 text-sm font-medium text-gray-900">Active</span>
                                    </label>
                                </div>
                            </div>
                            <div class="mt-3 flex items-center space-x-4">
                                <div class="flex-grow">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>Confidence: 87%</span>
                                        <span>Intelligence: High</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="performance-bar h-2 rounded-full" style="width: 87%"></div>
                                    </div>
                                </div>
                                <button onclick="configureSource('company_knowledge')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    Configure
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Trade Categories Q&A -->
                    <div class="priority-item bg-white border border-gray-200 rounded-lg p-4 flex items-center" data-source="trade_categories">
                        <div class="drag-handle text-gray-400 mr-4">
                            <i class="fas fa-grip-vertical text-lg"></i>
                        </div>
                        <div class="flex-shrink-0 mr-4">
                            <div class="w-12 h-12 bg-cyan-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-industry text-cyan-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="font-semibold text-gray-900 flex items-center">
                                        Trade Categories Q&A
                                        <span class="ml-2 px-2 py-1 bg-cyan-100 text-cyan-800 text-xs rounded-full">Industry</span>
                                    </h3>
                                    <p class="text-gray-600 text-sm">Industry-specific questions and answers</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div class="text-right">
                                        <div class="text-sm font-medium text-green-600">84% Success</div>
                                        <div class="text-xs text-gray-500">856 uses</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" checked class="sr-only peer" onchange="toggleSource('trade_categories', this)">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        <span class="ml-3 text-sm font-medium text-gray-900">Active</span>
                                    </label>
                                </div>
                            </div>
                            <div class="mt-3 flex items-center space-x-4">
                                <div class="flex-grow">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>Confidence: 79%</span>
                                        <span>Intelligence: Medium</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="performance-bar h-2 rounded-full" style="width: 79%"></div>
                                    </div>
                                </div>
                                <button onclick="configureSource('trade_categories')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    Configure
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Template Intelligence -->
                    <div class="priority-item bg-white border border-gray-200 rounded-lg p-4 flex items-center" data-source="template_intelligence">
                        <div class="drag-handle text-gray-400 mr-4">
                            <i class="fas fa-grip-vertical text-lg"></i>
                        </div>
                        <div class="flex-shrink-0 mr-4">
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-brain text-purple-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="font-semibold text-gray-900 flex items-center">
                                        Template Intelligence
                                        <span class="ml-2 px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">Smart</span>
                                    </h3>
                                    <p class="text-gray-600 text-sm">Smart templates and conversation patterns</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div class="text-right">
                                        <div class="text-sm font-medium text-green-600">78% Success</div>
                                        <div class="text-xs text-gray-500">634 uses</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" checked class="sr-only peer" onchange="toggleSource('template_intelligence', this)">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        <span class="ml-3 text-sm font-medium text-gray-900">Active</span>
                                    </label>
                                </div>
                            </div>
                            <div class="mt-3 flex items-center space-x-4">
                                <div class="flex-grow">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>Confidence: 72%</span>
                                        <span>Intelligence: Smart</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="performance-bar h-2 rounded-full" style="width: 72%"></div>
                                    </div>
                                </div>
                                <button onclick="configureSource('template_intelligence')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    Configure
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Learning Queue Insights -->
                    <div class="priority-item bg-white border border-gray-200 rounded-lg p-4 flex items-center" data-source="learning_insights">
                        <div class="drag-handle text-gray-400 mr-4">
                            <i class="fas fa-grip-vertical text-lg"></i>
                        </div>
                        <div class="flex-shrink-0 mr-4">
                            <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-graduation-cap text-orange-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="font-semibold text-gray-900 flex items-center">
                                        Learning Queue Insights
                                        <span class="ml-2 px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">Learning</span>
                                    </h3>
                                    <p class="text-gray-600 text-sm">Previously learned patterns and approved answers</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div class="text-right">
                                        <div class="text-sm font-medium text-green-600">71% Success</div>
                                        <div class="text-xs text-gray-500">423 uses</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" checked class="sr-only peer" onchange="toggleSource('learning_insights', this)">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        <span class="ml-3 text-sm font-medium text-gray-900">Active</span>
                                    </label>
                                </div>
                            </div>
                            <div class="mt-3 flex items-center space-x-4">
                                <div class="flex-grow">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>Confidence: 68%</span>
                                        <span>Intelligence: Adaptive</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="performance-bar h-2 rounded-full" style="width: 68%"></div>
                                    </div>
                                </div>
                                <button onclick="configureSource('learning_insights')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    Configure
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Summary -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Overall Performance</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Success Rate</span>
                            <span class="font-semibold text-green-600">82.5%</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Avg Confidence</span>
                            <span class="font-semibold text-blue-600">76.5%</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Total Queries</span>
                            <span class="font-semibold text-gray-900">3,160</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Optimization Status</h3>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span class="text-sm text-gray-700">Priority flow optimized</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-clock text-yellow-500 mr-2"></i>
                            <span class="text-sm text-gray-700">Performance monitoring active</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-lightbulb text-blue-500 mr-2"></i>
                            <span class="text-sm text-gray-700">3 optimization suggestions</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <button onclick="optimizeAgent()" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            <i class="fas fa-magic mr-2"></i>Auto-Optimize
                        </button>
                        <button onclick="analyzePerformance()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-chart-line mr-2"></i>Analyze Performance
                        </button>
                        <button onclick="testAgent()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-play mr-2"></i>Test Agent
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Knowledge Source Controls Tab -->
        <div id="knowledge-controls-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">Knowledge Source Controls</h2>
                <div class="text-center text-gray-500 py-12">
                    <i class="fas fa-cog text-6xl text-gray-300 mb-4"></i>
                    <p>Advanced knowledge source configuration interface coming next...</p>
                </div>
            </div>
        </div>

        <!-- Agent Personality Tab -->
        <div id="agent-personality-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm p-6">
                
                <!-- Voice Configuration Section -->
                <div class="mb-8">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-microphone text-blue-600 mr-3 text-xl"></i>
                        <h3 class="text-lg font-semibold text-gray-900">Voice Configuration</h3>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">(Voice tone, pace & behavior)</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Voice Tone -->
                        <div>
                            <label for="voice-tone" class="block text-sm font-medium text-gray-700 mb-2">Voice Tone</label>
                            <select id="voice-tone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="friendly">Friendly - Warm and approachable</option>
                                <option value="professional">Professional - Business-focused</option>
                                <option value="casual">Casual - Relaxed and informal</option>
                                <option value="enthusiastic">Enthusiastic - Energetic and positive</option>
                                <option value="empathetic">Empathetic - Understanding and caring</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Controls voice and phrasing style</p>
                        </div>
                        
                        <!-- Speech Pace -->
                        <div>
                            <label for="speech-pace" class="block text-sm font-medium text-gray-700 mb-2">Speech Pace</label>
                            <select id="speech-pace" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="slow">Slow - Deliberate and clear</option>
                                <option value="moderate">Moderate - Natural conversational pace</option>
                                <option value="fast">Fast - Quick and efficient</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Adjusts TTS speed for ElevenLabs or Google</p>
                        </div>
                    </div>
                </div>

                <!-- Behavior Controls Section -->
                <div class="mb-8">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-cogs text-gray-600 mr-3 text-xl"></i>
                        <h3 class="text-lg font-semibold text-gray-900">Behavior Controls</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Allow Barge-In -->
                        <div class="flex items-start p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <input type="checkbox" id="allow-barge-in" class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <div class="ml-3">
                                <label for="allow-barge-in" class="text-sm font-medium text-gray-900">Allow Barge-In</label>
                                <p class="text-sm text-gray-600">Caller can interrupt AI while speaking</p>
                            </div>
                        </div>
                        
                        <!-- Acknowledge Emotion -->
                        <div class="flex items-start p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <input type="checkbox" id="acknowledge-emotion" class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <div class="ml-3">
                                <label for="acknowledge-emotion" class="text-sm font-medium text-gray-900">Acknowledge Emotion</label>
                                <p class="text-sm text-gray-600">Respond to frustration, urgency, etc.</p>
                            </div>
                        </div>
                        
                        <!-- Use Emails -->
                        <div class="flex items-start p-4 bg-gray-50 border border-gray-200 rounded-lg">
                            <input type="checkbox" id="use-emails" class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <div class="ml-3">
                                <label for="use-emails" class="text-sm font-medium text-gray-900">Use Emails</label>
                                <p class="text-sm text-gray-600">Enable email-based interactions</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Response Categories Header -->
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <i class="fas fa-comments text-purple-600 mr-3 text-xl"></i>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Response Categories</h2>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 ml-2">
                                ENTERPRISE
                            </span>
                            <p class="text-sm text-gray-600 mt-1">Define branded responses that adapt to your personality settings automatically</p>
                        </div>
                    </div>
                    <button id="live-preview-btn" onclick="this.innerHTML=this.innerHTML.includes('Stop')?'<i class=&quot;fas fa-eye mr-2&quot;></i>Live Preview':'<i class=&quot;fas fa-eye-slash mr-2&quot;></i>Stop Live Preview'; this.className=this.className.includes('red')?'bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors flex items-center':'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center';" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors flex items-center">
                        <i class="fas fa-eye mr-2"></i>Live Preview
                    </button>
                </div>

                <!-- Category Tabs -->
                <div class="flex space-x-1 mb-6 bg-gray-100 p-1 rounded-lg">
                    <button class="response-tab-btn active px-4 py-2 rounded-md bg-purple-600 text-white font-medium transition-all" onclick="document.querySelectorAll('.response-tab-btn').forEach(b=>b.className='response-tab-btn px-4 py-2 rounded-md text-gray-600 hover:text-gray-900 font-medium transition-all'); this.className='response-tab-btn active px-4 py-2 rounded-md bg-purple-600 text-white font-medium transition-all'; document.querySelectorAll('.response-tab-content').forEach(c=>c.classList.add('hidden')); document.getElementById('core-responses-content').classList.remove('hidden');" data-tab="core">
                        Core Responses
                    </button>
                    <button class="response-tab-btn px-4 py-2 rounded-md text-gray-600 hover:text-gray-900 font-medium transition-all" onclick="document.querySelectorAll('.response-tab-btn').forEach(b=>b.className='response-tab-btn px-4 py-2 rounded-md text-gray-600 hover:text-gray-900 font-medium transition-all'); this.className='response-tab-btn active px-4 py-2 rounded-md bg-purple-600 text-white font-medium transition-all'; document.querySelectorAll('.response-tab-content').forEach(c=>c.classList.add('hidden')); document.getElementById('advanced-responses-content').classList.remove('hidden');" data-tab="advanced">
                        Advanced
                    </button>
                    <button class="response-tab-btn px-4 py-2 rounded-md text-blue-600 border border-blue-600 hover:bg-blue-50 font-medium transition-all" onclick="document.querySelectorAll('.response-tab-btn').forEach(b=>b.className='response-tab-btn px-4 py-2 rounded-md text-gray-600 hover:text-gray-900 font-medium transition-all'); this.className='response-tab-btn active px-4 py-2 rounded-md bg-purple-600 text-white font-medium transition-all'; document.querySelectorAll('.response-tab-content').forEach(c=>c.classList.add('hidden')); document.getElementById('emotional-responses-content').classList.remove('hidden');" data-tab="emotional">
                        Emotional
                    </button>
                </div>

                <!-- Core Responses Tab Content -->
                <div id="core-responses-content" class="response-tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Primary Interactions -->
                        <div>
                            <div class="flex items-center mb-4">
                                <i class="fas fa-star text-yellow-500 mr-2"></i>
                                <h3 class="text-lg font-semibold text-gray-900">Primary Interactions</h3>
                            </div>

                            <!-- Greeting Response -->
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Greeting Response</label>
                                <textarea id="greeting-response" class="w-full h-20 p-3 border border-gray-300 rounded-md resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Hi {{callerName}}! Thanks for calling {{companyName}}. How can I help you today?">Hi {{callerName}}! Thanks for calling {{companyName}}. How can I help you today?</textarea>
                                
                                <div class="flex items-center justify-between mt-3">
                                    <div class="flex space-x-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer" onclick="var t=document.getElementById('greeting-response'); var pos=t.selectionStart; t.value=t.value.substring(0,pos)+'{{callerName}}'+t.value.substring(t.selectionEnd); t.focus(); t.setSelectionRange(pos+14,pos+14);">
                                            {{callerName}}
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer" onclick="var t=document.getElementById('greeting-response'); var pos=t.selectionStart; t.value=t.value.substring(0,pos)+'{{companyName}}'+t.value.substring(t.selectionEnd); t.focus(); t.setSelectionRange(pos+15,pos+15);">
                                            {{companyName}}
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer" onclick="var t=document.getElementById('greeting-response'); var pos=t.selectionStart; t.value=t.value.substring(0,pos)+'{{currentTime}}'+t.value.substring(t.selectionEnd); t.focus(); t.setSelectionRange(pos+15,pos+15);">
                                            {{currentTime}}
                                        </span>
                                    </div>
                                    <button onclick="alert('Preview: ' + document.getElementById('greeting-response').value.replace(/\{\{callerName\}\}/g,'John Smith').replace(/\{\{companyName\}\}/g,'ClientsVia Solutions').replace(/\{\{currentTime\}\}/g,new Date().toLocaleTimeString()));" class="text-purple-600 hover:text-purple-700 text-sm font-medium flex items-center">
                                        <i class="fas fa-play mr-1"></i>Preview
                                    </button>
                                </div>
                            </div>

                            <!-- Farewell Response -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-hand-wave mr-1"></i>Farewell Response
                                </label>
                                <textarea id="farewell-response" class="w-full h-20 p-3 border border-gray-300 rounded-md resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Thanks for calling {{companyName}}! Have a great day!">Thanks for calling {{companyName}}! Have a great day!</textarea>
                                
                                <div class="flex items-center justify-between mt-3">
                                    <div class="flex space-x-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('farewell-response', '{{companyName}}')">
                                            {{companyName}}
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('farewell-response', '{{callerName}}')">
                                            {{callerName}}
                                        </span>
                                    </div>
                                    <button onclick="previewResponse('farewell-response')" class="text-purple-600 hover:text-purple-700 text-sm font-medium flex items-center">
                                        <i class="fas fa-play mr-1"></i>Preview
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Service Interactions -->
                        <div>
                            <div class="flex items-center mb-4">
                                <i class="fas fa-tools text-blue-500 mr-2"></i>
                                <h3 class="text-lg font-semibold text-gray-900">Service Interactions</h3>
                            </div>

                            <!-- Transfer Response -->
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-phone-alt mr-1"></i>Transfer Response
                                </label>
                                <textarea id="transfer-response" class="w-full h-20 p-3 border border-gray-300 rounded-md resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Let me connect you with {{departmentName}} who can better assist you.">Let me connect you with {{departmentName}} who can better assist you.</textarea>
                                
                                <div class="flex items-center justify-between mt-3">
                                    <div class="flex space-x-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('transfer-response', '{{departmentName}}')">
                                            {{departmentName}}
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('transfer-response', '{{specialistName}}')">
                                            {{specialistName}}
                                        </span>
                                    </div>
                                    <button onclick="previewResponse('transfer-response')" class="text-purple-600 hover:text-purple-700 text-sm font-medium flex items-center">
                                        <i class="fas fa-play mr-1"></i>Preview
                                    </button>
                                </div>
                            </div>

                            <!-- Service Unavailable -->
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>Service Unavailable
                                </label>
                                <textarea id="service-unavailable-response" class="w-full h-20 p-3 border border-gray-300 rounded-md resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="I'm sorry, {{serviceType}} isn't available right now. Can I help with something else?">I'm sorry, {{serviceType}} isn't available right now. Can I help with something else?</textarea>
                                
                                <div class="flex items-center justify-between mt-3">
                                    <div class="flex space-x-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('service-unavailable-response', '{{serviceType}}')">
                                            {{serviceType}}
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('service-unavailable-response', '{{alternativeService}}')">
                                            {{alternativeService}}
                                        </span>
                                    </div>
                                    <button onclick="previewResponse('service-unavailable-response')" class="text-purple-600 hover:text-purple-700 text-sm font-medium flex items-center">
                                        <i class="fas fa-play mr-1"></i>Preview
                                    </button>
                                </div>
                            </div>

                            <!-- Hold Response -->
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                <label class="block text-sm font-medium text-yellow-700 mb-2">
                                    <i class="fas fa-pause-circle text-yellow-600 mr-1"></i>Hold Response
                                </label>
                                <textarea id="hold-response" class="w-full h-20 p-3 border border-yellow-300 rounded-md resize-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent" placeholder="Please hold for just a moment while I look that up for you.">Please hold for just a moment while I look that up for you.</textarea>
                                
                                <div class="flex items-center justify-between mt-3">
                                    <div class="flex space-x-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('hold-response', '{{estimatedTime}}')">
                                            {{estimatedTime}}
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('hold-response', '{{callerName}}')">
                                            {{callerName}}
                                        </span>
                                    </div>
                                    <button onclick="previewResponse('hold-response')" class="text-purple-600 hover:text-purple-700 text-sm font-medium flex items-center">
                                        <i class="fas fa-play mr-1"></i>Preview
                                    </button>
                                </div>
                            </div>

                            <!-- Business Hours -->
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <label class="block text-sm font-medium text-orange-700 mb-2">
                                    <i class="fas fa-clock text-orange-600 mr-1"></i>Business Hours
                                </label>
                                <textarea id="business-hours-response" class="w-full h-20 p-3 border border-orange-300 rounded-md resize-none focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="We're open {{businessHours}}. You can also visit our website at {{website}}.">We're open {{businessHours}}. You can also visit our website at {{website}}.</textarea>
                                
                                <div class="flex items-center justify-between mt-3">
                                    <div class="flex space-x-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('business-hours-response', '{{businessHours}}')">
                                            {{businessHours}}
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('business-hours-response', '{{website}}')">
                                            {{website}}
                                        </span>
                                    </div>
                                    <button onclick="previewResponse('business-hours-response')" class="text-purple-600 hover:text-purple-700 text-sm font-medium flex items-center">
                                        <i class="fas fa-play mr-1"></i>Preview
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Responses Tab Content -->
                <div id="advanced-responses-content" class="response-tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Emergency Responses -->
                        <div>
                            <div class="flex items-center mb-4">
                                <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
                                <h3 class="text-lg font-semibold text-gray-900">Emergency Responses</h3>
                            </div>

                            <!-- Emergency Escalation -->
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                                <label class="block text-sm font-medium text-red-700 mb-2">Emergency Escalation</label>
                                <textarea id="emergency-response" class="w-full h-20 p-3 border border-red-300 rounded-md resize-none focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="This sounds like an emergency. Let me connect you with our emergency team immediately.">This sounds like an emergency. Let me connect you with our emergency team immediately.</textarea>
                            </div>

                            <!-- After Hours -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">After Hours Response</label>
                                <textarea id="after-hours-response" class="w-full h-20 p-3 border border-gray-300 rounded-md resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Thanks for calling! We're currently closed but will get back to you first thing in the morning.">Thanks for calling! We're currently closed but will get back to you first thing in the morning.</textarea>
                            </div>
                        </div>

                        <!-- Booking Responses -->
                        <div>
                            <div class="flex items-center mb-4">
                                <i class="fas fa-calendar-plus text-green-500 mr-2"></i>
                                <h3 class="text-lg font-semibold text-gray-900">Booking Responses</h3>
                            </div>

                            <!-- Appointment Confirmation -->
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                <label class="block text-sm font-medium text-green-700 mb-2">Appointment Confirmation</label>
                                <textarea id="appointment-confirmation" class="w-full h-20 p-3 border border-green-300 rounded-md resize-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Perfect! I've scheduled your appointment for {{appointmentTime}} on {{appointmentDate}}.">Perfect! I've scheduled your appointment for {{appointmentTime}} on {{appointmentDate}}.</textarea>
                            </div>

                            <!-- Scheduling Conflict -->
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <label class="block text-sm font-medium text-yellow-700 mb-2">Scheduling Conflict</label>
                                <textarea id="scheduling-conflict" class="w-full h-20 p-3 border border-yellow-300 rounded-md resize-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent" placeholder="That time slot isn't available. How about {{alternativeTime}} or {{alternativeTime2}}?">That time slot isn't available. How about {{alternativeTime}} or {{alternativeTime2}}?</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emotional Responses Tab Content -->
                <div id="emotional-responses-content" class="response-tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Empathy Responses -->
                        <div>
                            <div class="flex items-center mb-4">
                                <i class="fas fa-heart text-pink-500 mr-2"></i>
                                <h3 class="text-lg font-semibold text-gray-900">Empathy & Understanding</h3>
                            </div>

                            <!-- Frustrated Customer -->
                            <div class="bg-pink-50 border border-pink-200 rounded-lg p-4 mb-4">
                                <label class="block text-sm font-medium text-pink-700 mb-2">Frustrated Customer</label>
                                <textarea id="frustrated-customer" class="w-full h-20 p-3 border border-pink-300 rounded-md resize-none focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="I completely understand your frustration, and I'm here to help make this right for you.">I completely understand your frustration, and I'm here to help make this right for you.</textarea>
                            </div>

                            <!-- Appreciative Response -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <label class="block text-sm font-medium text-blue-700 mb-2">Appreciative Response</label>
                                <textarea id="appreciative-response" class="w-full h-20 p-3 border border-blue-300 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Thank you so much for your patience and for choosing {{companyName}}. We truly appreciate your business!">Thank you so much for your patience and for choosing {{companyName}}. We truly appreciate your business!</textarea>
                            </div>
                        </div>

                        <!-- Reassurance Responses -->
                        <div>
                            <div class="flex items-center mb-4">
                                <i class="fas fa-shield-check text-green-500 mr-2"></i>
                                <h3 class="text-lg font-semibold text-gray-900">Reassurance & Confidence</h3>
                            </div>

                            <!-- Problem Resolution -->
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                <label class="block text-sm font-medium text-green-700 mb-2">Problem Resolution</label>
                                <textarea id="problem-resolution" class="w-full h-20 p-3 border border-green-300 rounded-md resize-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Don't worry, we've handled this exact situation many times before. I'll make sure we get this resolved for you quickly.">Don't worry, we've handled this exact situation many times before. I'll make sure we get this resolved for you quickly.</textarea>
                            </div>

                            <!-- Quality Assurance -->
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <label class="block text-sm font-medium text-purple-700 mb-2">Quality Assurance</label>
                                <textarea id="quality-assurance" class="w-full h-20 p-3 border border-purple-300 rounded-md resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="You can count on us to deliver the highest quality service. We stand behind all our work with a 100% satisfaction guarantee.">You can count on us to deliver the highest quality service. We stand behind all our work with a 100% satisfaction guarantee.</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="mt-8 flex justify-end space-x-3">
                    <button onclick="previewAllResponses()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-eye mr-2"></i>Preview All
                    </button>
                    <button onclick="verifyConfiguration()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-search mr-2"></i>Verify Saved Data
                    </button>
                    <button onclick="saveResponseCategories()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentCompanyId = null;
        let authToken = null;
        let ultraSecureSession = null;
        let securityInitialized = false;

        // Function to get company ID from URL or current user
        function getCurrentCompanyId() {
            // First check URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const companyId = urlParams.get('id') || urlParams.get('companyId');
            
            if (companyId) {
                console.log(' Company ID from URL:', companyId);
                return companyId;
            }

            // Check localStorage for real company ID
            const storedId = localStorage.getItem('companyId');
            if (storedId && storedId !== 'demo-company' && storedId !== 'demo-company-123') {
                console.log(' Company ID from localStorage:', storedId);
                return storedId;
            }

            // Check if set globally
            if (window.currentCompanyId && window.currentCompanyId !== 'demo-company') {
                console.log(' Company ID from window:', window.currentCompanyId);
                return window.currentCompanyId;
            }

            // Try to get from authentication token
            if (authToken) {
                try {
                    const payload = JSON.parse(atob(authToken.split('.')[1]));
                    if (payload.companyId) {
                        console.log(' Company ID from token:', payload.companyId);
                        return payload.companyId;
                    }
                } catch (e) {
                    console.warn('Could not parse token for company ID');
                }
            }

            console.warn(' No valid company ID found - using demo mode');
            return 'demo-company';
        }

        // Initialize the application with ultra-security
        document.addEventListener('DOMContentLoaded', async function() {
            // Get company ID first
            currentCompanyId = getCurrentCompanyId();
            console.log('Initialized with company ID:', currentCompanyId);
            
            await initializeUltraSecurity();
            await initializeAuth();
            await loadPriorityFlow();
            initializeDragAndDrop();
            
            // Initialize Response Categories if we have auth
            if (currentCompanyId && authToken) {
                await loadResponseCategories();
            }
        });

        // Simple initialization for button functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing Response Categories buttons...');
            
            // Test that functions are available
            setTimeout(() => {
                console.log('Testing functions availability:');
                console.log('switchResponseTab:', typeof window.switchResponseTab);
                console.log('insertVariable:', typeof window.insertVariable);
                console.log('previewResponse:', typeof window.previewResponse);
                console.log('toggleLivePreview:', typeof window.toggleLivePreview);
                
                showBasicNotification(' Response Categories buttons are now functional!', 'success');
            }, 1000);
        });

        // Ultra-Security Initialization
        async function initializeUltraSecurity() {
            try {
                showNotification(' Initializing ultra-security layers...', 'info');
                
                // Initialize ultra-secure session
                ultraSecureSession = new UltraSecureSession();
                await ultraSecureSession.initializeSession();
                
                // Initialize TOTP interface
                const totpInterface = new TOTPInterface();
                await totpInterface.initialize();
                
                // Display TOTP
                const totpDisplay = document.getElementById('totp-display');
                if (totpDisplay) {
                    totpDisplay.innerHTML = totpInterface.createUI();
                }
                
                // Update security status display
                updateSecurityStatus();
                
                // Security status update interval
                setInterval(updateSecurityStatus, 5000);
                
                securityInitialized = true;
                showNotification(' Ultra-security initialized - Multi-layer protection active', 'success');
                
            } catch (error) {
                console.error('Security initialization failed:', error);
                showNotification(' Security initialization failed - Falling back to standard security', 'warning');
            }
        }

        function updateSecurityStatus() {
            if (!ultraSecureSession) return;
            
            const status = ultraSecureSession.getSecurityStatus();
            const statusElement = document.getElementById('security-status');
            
            if (statusElement && status) {
                const scoreColor = status.securityScore >= 80 ? 'text-green-600' : 
                                  status.securityScore >= 60 ? 'text-yellow-600' : 'text-red-600';
                
                const shieldIcon = status.securityScore >= 80 ? 'fa-shield-alt' : 
                                  status.securityScore >= 60 ? 'fa-shield' : 'fa-exclamation-triangle';
                
                statusElement.innerHTML = `
                    <div class="flex items-center text-sm">
                        <i class="fas ${shieldIcon} ${scoreColor} mr-2"></i>
                        <div>
                            <div class="${scoreColor} font-semibold">Security: ${status.securityScore}%</div>
                            <div class="text-xs text-gray-500">${status.activeLayers.length} layers active</div>
                        </div>
                    </div>
                `;
            }
        }

        function showSecurityChallenge() {
            // Create security challenge modal
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-8 rounded-lg shadow-2xl max-w-md w-full mx-4">
                        <div class="text-center mb-6">
                            <i class="fas fa-shield-alt text-blue-600 text-4xl mb-3"></i>
                            <h2 class="text-2xl font-bold text-gray-900">Security Challenge</h2>
                            <p class="text-gray-600">Ultra-secure authentication required</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Access Code</label>
                                <input type="password" id="access-code" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter your access code">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">TOTP Code</label>
                                <input type="text" id="totp-code-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="000000" maxlength="6">
                            </div>
                            
                            <button onclick="validateSecurityChallenge()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                                <i class="fas fa-unlock mr-2"></i>Authenticate
                            </button>
                            
                            <div class="text-xs text-gray-500 text-center">
                                Ultra-secure mode: Hardware fingerprinting and behavioral analysis active
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function validateSecurityChallenge() {
            const accessCode = document.getElementById('access-code')?.value;
            const totpCode = document.getElementById('totp-code-input')?.value;
            
            // Validate access code (use strong password in production)
            if (accessCode !== 'ultra-secure-admin-2025') {
                showNotification(' Invalid access code', 'error');
                return;
            }
            
            // Validate TOTP if available
            if (ultraSecureSession && ultraSecureSession.securityLayers.totp && totpCode) {
                const totpValid = await ultraSecureSession.validateTOTP(totpCode);
                if (!totpValid) {
                    showNotification(' Invalid TOTP code', 'error');
                    return;
                }
            }
            
            // Set authentication
            authToken = 'ultra-secure-demo-token';
            currentCompanyId = 'demo-company';
            localStorage.setItem('adminToken', authToken);
            localStorage.setItem('companyId', currentCompanyId);
            
            // Remove modal
            document.querySelector('.fixed.inset-0').remove();
            
            showNotification(' Ultra-secure authentication successful', 'success');
            
            // Load the interface
            await loadPriorityFlow();
            
            // Load Response Categories
            await loadResponseCategories();
        }

        // Enhanced authentication with security validation
        async function initializeAuth() {
            // Get auth token from localStorage or cookie (check both adminToken and authToken)
            authToken = localStorage.getItem('authToken') || localStorage.getItem('adminToken') || getCookie('token');
            
            // Get company ID using the proper function
            currentCompanyId = getCurrentCompanyId();
            
            if (!authToken) {
                console.log(' No auth token found, showing security challenge');
                showSecurityChallenge();
                return;
            }

            if (!currentCompanyId || currentCompanyId === 'demo-company') {
                console.log(' Using demo mode - no valid company ID');
                currentCompanyId = 'demo-company';
            }

            console.log(' Authentication initialized:', {
                hasToken: !!authToken,
                companyId: currentCompanyId
            });

            // Enhanced security validation
            if (securityInitialized && ultraSecureSession) {
                const biometricValid = await ultraSecureSession.validateBiometric();
                if (!biometricValid) {
                    showNotification(' Biometric validation failed - Please re-authenticate', 'warning');
                    showSecurityChallenge();
                    return;
                }
            }

            // Get company ID from token or localStorage
            currentCompanyId = localStorage.getItem('companyId');
            if (!currentCompanyId) {
                // Try to get from adminUser data
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    try {
                        const userData = JSON.parse(adminUser);
                        currentCompanyId = userData.companyId || userData._id;
                        if (currentCompanyId) {
                            localStorage.setItem('companyId', currentCompanyId);
                        }
                    } catch (error) {
                        console.error('Failed to parse admin user data:', error);
                    }
                }
                
                // If still no company ID, try to decode JWT
                if (!currentCompanyId) {
                    try {
                        const payload = JSON.parse(atob(authToken.split('.')[1]));
                        currentCompanyId = payload.companyId || payload.userId;
                        if (currentCompanyId) {
                            localStorage.setItem('companyId', currentCompanyId);
                        }
                    } catch (error) {
                        console.error('Failed to decode auth token:', error);
                    }
                }
            }
            
            // If still no company ID, use demo ID
            if (!currentCompanyId) {
                currentCompanyId = 'demo-company-123';
                localStorage.setItem('companyId', currentCompanyId);
                console.log('Using demo company ID for testing');
            }
        }

        // Cookie helper
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // API helper function
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            // Add auth header if we have a token
            if (authToken) {
                options.headers['Authorization'] = `Bearer ${authToken}`;
            }

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`/api/ai-agent-logic${endpoint}`, options);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Token expired or invalid, but don't redirect in demo mode
                        if (authToken === 'demo-token-for-testing') {
                            console.warn('Demo mode: bypassing auth error');
                            // Return mock data for demo
                            return getMockData(endpoint);
                        }
                        // For real auth errors, redirect to login
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('adminToken');
                        localStorage.removeItem('companyId');
                        window.location.href = '/login.html';
                        return;
                    }
                    throw new Error(`API call failed: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error(`API call to ${endpoint} failed:`, error);
                
                // In development, show mock data if API fails
                if (endpoint.includes('/priority-flow/') && method === 'GET') {
                    console.warn('Using mock data due to API error');
                    return getMockData(endpoint);
                }
                
                showNotification(`Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Load and render priority flow
        async function loadPriorityFlow() {
            try {
                showLoading(true);
                const data = await apiCall(`/priority-flow/${currentCompanyId}`);
                renderPriorityFlow(data);
            } catch (error) {
                console.error('Failed to load priority flow:', error);
                showNotification('Failed to load priority flow configuration', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Render priority flow items
        function renderPriorityFlow(items) {
            const container = document.getElementById('priority-flow-container');
            container.innerHTML = '';

            items.forEach(item => {
                const element = createPriorityFlowItem(item);
                container.appendChild(element);
            });
        }

        // Create priority flow item HTML
        function createPriorityFlowItem(item) {
            const div = document.createElement('div');
            div.className = 'priority-item bg-white border border-gray-200 rounded-lg p-4 flex items-center';
            div.dataset.source = item.id;

            const iconClass = getIconClass(item.icon);
            const categoryClass = getCategoryClass(item.category);

            div.innerHTML = `
                <div class="drag-handle text-gray-400 mr-4">
                    <i class="fas fa-grip-vertical text-lg"></i>
                </div>
                <div class="flex-shrink-0 mr-4">
                    <div class="w-12 h-12 ${categoryClass.bg} rounded-lg flex items-center justify-center">
                        <i class="fas ${iconClass} ${categoryClass.text} text-xl"></i>
                    </div>
                </div>
                <div class="flex-grow">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-gray-900 flex items-center">
                                ${item.name}
                                ${item.primary ? '<span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Primary</span>' : ''}
                                ${item.category === 'industry' ? '<span class="ml-2 px-2 py-1 bg-cyan-100 text-cyan-800 text-xs rounded-full">Industry</span>' : ''}
                                ${item.primary ? '<i class="fas fa-star text-yellow-500 ml-2"></i>' : ''}
                            </h3>
                            <p class="text-gray-600 text-sm">${item.description}</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="text-right">
                                <div class="text-sm font-medium text-green-600">${Math.round(item.performance.successRate * 100)}% Success</div>
                                <div class="text-xs text-gray-500">${item.performance.usageCount.toLocaleString()} uses</div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" ${item.active ? 'checked' : ''} class="sr-only peer" onchange="toggleSource('${item.id}', this)">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                <span class="ml-3 text-sm font-medium text-gray-900">Active</span>
                            </label>
                        </div>
                    </div>
                    <div class="mt-3 flex items-center space-x-4">
                        <div class="flex-grow">
                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                <span>Confidence: ${Math.round(item.performance.avgConfidence * 100)}%</span>
                                <span>Intelligence: ${item.intelligenceLevel}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="performance-bar h-2 rounded-full" style="width: ${Math.round(item.performance.avgConfidence * 100)}%"></div>
                            </div>
                        </div>
                        <button onclick="configureSource('${item.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            Configure
                        </button>
                    </div>
                </div>
            `;

            return div;
        }

        // Helper functions for styling
        function getIconClass(icon) {
            const iconMap = {
                'building': 'fa-building',
                'industry': 'fa-industry',
                'edit': 'fa-edit',
                'robot': 'fa-robot'
            };
            return iconMap[icon] || 'fa-cog';
        }

        function getCategoryClass(category) {
            const categoryMap = {
                'primary': { bg: 'bg-blue-100', text: 'text-blue-600' },
                'industry': { bg: 'bg-cyan-100', text: 'text-cyan-600' },
                'template': { bg: 'bg-purple-100', text: 'text-purple-600' },
                'fallback': { bg: 'bg-gray-100', text: 'text-gray-600' }
            };
            return categoryMap[category] || { bg: 'bg-gray-100', text: 'text-gray-600' };
        }

        // Initialize drag and drop
        function initializeDragAndDrop() {
            const priorityContainer = document.getElementById('priority-flow-container');
            new Sortable(priorityContainer, {
                animation: 150,
                handle: '.drag-handle',
                onEnd: function(evt) {
                    updatePriorityOrder();
                }
            });
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'text-blue-600', 'border-blue-600');
                button.classList.add('text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Add active state to selected tab button
            event.target.classList.add('active', 'text-blue-600', 'border-blue-600');
            event.target.classList.remove('text-gray-500');
        }

        // Toggle knowledge source
        async function toggleSource(sourceId, checkbox) {
            try {
                await apiCall(`/priority-flow/${currentCompanyId}/toggle`, 'POST', {
                    sourceId,
                    active: checkbox.checked
                });
                showNotification(`${sourceId} ${checkbox.checked ? 'enabled' : 'disabled'}`, 'success');
            } catch (error) {
                // Revert checkbox on error
                checkbox.checked = !checkbox.checked;
                showNotification('Failed to update source status', 'error');
            }
        }

        // Configure knowledge source
        async function configureSource(sourceId) {
            showNotification('Opening configuration for ' + sourceId, 'info');
            // TODO: Open configuration modal with real data
        }

        // Update priority order after drag and drop
        async function updatePriorityOrder() {
            const items = document.querySelectorAll('#priority-flow-container .priority-item');
            const order = Array.from(items).map(item => item.dataset.source);
            
            try {
                await apiCall(`/priority-flow/${currentCompanyId}/reorder`, 'POST', { order });
                showNotification('Priority order updated successfully', 'success');
            } catch (error) {
                showNotification('Failed to update priority order', 'error');
                // Reload to revert changes
                await loadPriorityFlow();
            }
        }

        // Quick actions with real functionality
        async function optimizeAgent() {
            try {
                showLoading(true);
                showNotification('Starting AI agent optimization...', 'info');
                
                const result = await apiCall(`/optimize/${currentCompanyId}`, 'POST');
                showNotification('Agent optimization completed successfully!', 'success');
                
                // Reload priority flow to show optimized settings
                await loadPriorityFlow();
            } catch (error) {
                showNotification('Optimization failed. Please try again.', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function analyzePerformance() {
            try {
                showLoading(true);
                const analytics = await apiCall(`/analytics/${currentCompanyId}`);
                showNotification('Performance analysis completed', 'success');
                
                // TODO: Show analytics dashboard
                console.log('Analytics data:', analytics);
            } catch (error) {
                showNotification('Failed to analyze performance', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function testAgent() {
            showNotification('Launching agent test interface...', 'info');
            // TODO: Open agent testing modal
        }

        async function addKnowledgeSource() {
            showNotification('Opening knowledge source creation wizard...', 'info');
            // TODO: Open add knowledge source modal
        }

        async function resetToDefaults() {
            if (!confirm('Reset all AI Agent Logic settings to intelligent defaults?')) {
                return;
            }
            
            try {
                showLoading(true);
                await apiCall(`/priority-flow/${currentCompanyId}/reset`, 'POST');
                showNotification('Settings reset to intelligent defaults', 'success');
                await loadPriorityFlow();
            } catch (error) {
                showNotification('Failed to reset settings', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Emergency bypass function for server access
        window.emergencyBypass = async function(userId, masterKey) {
            try {
                const response = await fetch('/api/auth/emergency-bypass', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, masterKey })
                });

                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('adminToken', data.token);
                    localStorage.setItem('companyId', userId);
                    
                    showNotification(' Emergency bypass activated!', 'warning');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    console.error('Emergency bypass failed:', data.message);
                }
            } catch (error) {
                console.error('Emergency bypass error:', error);
            }
        };

        // Console helper for emergency access
        console.log(`
 EMERGENCY ACCESS AVAILABLE 
If you're locked out, use:
emergencyBypass('your-user-id', 'your-master-key')

This only works from localhost (127.0.0.1)
        `);

        // Auto-refresh token every 10 minutes
        setInterval(async () => {
            if (authToken) {
                try {
                    const response = await fetch('/api/auth/refresh', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        authToken = data.token;
                        localStorage.setItem('authToken', authToken);
                        localStorage.setItem('adminToken', authToken);
                        console.log(' Token refreshed automatically');
                    }
                } catch (error) {
                    console.warn('Auto-refresh failed:', error);
                }
            }
        }, 10 * 60 * 1000); // Every 10 minutes

        // Session conflict monitoring
        let sessionMonitor = setInterval(async () => {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/ai-agent-logic/priority-flow/' + currentCompanyId, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.status === 401) {
                    clearInterval(sessionMonitor);
                    showSessionTerminatedAlert();
                }
            } catch (error) {
                // Ignore network errors during monitoring
            }
        }, 15000); // Check every 15 seconds

        function showSessionTerminatedAlert() {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            overlay.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
                    <i class="fas fa-shield-alt text-red-500 text-5xl mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Session Terminated</h2>
                    <p class="text-gray-600 mb-6">
                        Someone else has logged in with your credentials. 
                        Your session has been terminated for security.
                    </p>
                    <div class="space-y-3">
                        <button onclick="window.location.href='/login.html'" 
                                class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
                            Return to Login
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                class="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400">
                            Continue (Risk)
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        // Mock data for demo/development
        function getMockData(endpoint) {
            if (endpoint.includes('/priority-flow/')) {
                return [
                    {
                        id: 'company_knowledge',
                        name: 'Company Knowledge Base',
                        description: 'Company-specific Q&A and internal documentation',
                        active: true,
                        primary: true,
                        priority: 1,
                        icon: 'building',
                        category: 'primary',
                        confidenceThreshold: 0.8,
                        intelligenceLevel: 'high',
                        performance: {
                            successRate: 0.92,
                            avgConfidence: 0.87,
                            usageCount: 1247
                        }
                    },
                    {
                        id: 'trade_categories',
                        name: 'Trade Categories Q&A',
                        description: 'Industry-specific questions and answers',
                        active: true,
                        primary: false,
                        priority: 2,
                        icon: 'industry',
                        category: 'industry',
                        confidenceThreshold: 0.75,
                        intelligenceLevel: 'medium',
                        performance: {
                            successRate: 0.84,
                            avgConfidence: 0.79,
                            usageCount: 856
                        }
                    },
                    {
                        id: 'template_intelligence',
                        name: 'Template Intelligence',
                        description: 'Smart templates and conversation patterns',
                        active: true,
                        primary: false,
                        priority: 3,
                        icon: 'edit',
                        category: 'template',
                        confidenceThreshold: 0.65,
                        intelligenceLevel: 'smart',
                        performance: {
                            successRate: 0.78,
                            avgConfidence: 0.72,
                            usageCount: 634
                        }
                    }
                ];
            }
            return { success: true, message: 'Demo operation completed' };
        }

        // UI Helper functions
        function showLoading(show) {
            // TODO: Implement loading spinner
            if (show) {
                document.body.style.cursor = 'wait';
            } else {
                document.body.style.cursor = 'default';
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${getNotificationClass(type)}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${getNotificationIcon(type)} mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-lg">&times;</button>
                </div>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function getNotificationClass(type) {
            const classes = {
                'success': 'bg-green-500 text-white',
                'error': 'bg-red-500 text-white',
                'warning': 'bg-yellow-500 text-black',
                'info': 'bg-blue-500 text-white'
            };
            return classes[type] || classes.info;
        }

        function getNotificationIcon(type) {
            const icons = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };
            return icons[type] || icons.info;
        }

        // Response Categories Functionality
        let livePreviewMode = false;
        let responseTemplates = {
            core: {
                'greeting-response': 'Hi {{callerName}}! Thanks for calling {{companyName}}. How can I help you today?',
                'farewell-response': 'Thanks for calling {{companyName}}! Have a great day!',
                'transfer-response': 'Let me connect you with {{departmentName}} who can better assist you.',
                'service-unavailable-response': 'I\'m sorry, {{serviceType}} isn\'t available right now. Can I help with something else?',
                'hold-response': 'Please hold for just a moment while I look that up for you.',
                'business-hours-response': 'We\'re open {{businessHours}}. You can also visit our website at {{website}}.'
            },
            advanced: {
                'emergency-response': 'This sounds like an emergency. Let me connect you with our emergency team immediately.',
                'after-hours-response': 'Thanks for calling! We\'re currently closed but will get back to you first thing in the morning.',
                'appointment-confirmation': 'Perfect! I\'ve scheduled your appointment for {{appointmentTime}} on {{appointmentDate}}.',
                'scheduling-conflict': 'That time slot isn\'t available. How about {{alternativeTime}} or {{alternativeTime2}}?'
            },
            emotional: {
                'frustrated-customer': 'I completely understand your frustration, and I\'m here to help make this right for you.',
                'appreciative-response': 'Thank you so much for your patience and for choosing {{companyName}}. We truly appreciate your business!',
                'problem-resolution': 'Don\'t worry, we\'ve handled this exact situation many times before. I\'ll make sure we get this resolved for you quickly.',
                'quality-assurance': 'You can count on us to deliver the highest quality service. We stand behind all our work with a 100% satisfaction guarantee.'
            }
        };

        // Ensure functions are globally accessible and add debugging
        window.switchResponseTab = function(tabName) {
            console.log('switchResponseTab called with:', tabName);
            try {
                // Update tab buttons
                document.querySelectorAll('.response-tab-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-purple-600', 'text-white', 'bg-blue-50');
                    btn.classList.add('text-gray-600');
                    
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active', 'bg-purple-600', 'text-white');
                        btn.classList.remove('text-gray-600');
                        
                        // Special styling for emotional tab
                        if (tabName === 'emotional') {
                            btn.classList.add('bg-blue-50');
                        }
                    }
                });

                // Update tab content
                document.querySelectorAll('.response-tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                const targetContent = document.getElementById(`${tabName}-responses-content`);
                if (targetContent) {
                    targetContent.classList.remove('hidden');
                    console.log('Successfully switched to tab:', tabName);
                } else {
                    console.error('Target content not found for tab:', tabName);
                }
            } catch (error) {
                console.error('Error in switchResponseTab:', error);
            }
        };

        // Insert variable into response template
        window.insertVariable = function(textareaId, variable) {
            console.log('insertVariable called with:', textareaId, variable);
            try {
                const textarea = document.getElementById(textareaId);
                if (!textarea) {
                    console.error('Textarea not found:', textareaId);
                    return;
                }

                const cursorPosition = textarea.selectionStart;
                const textBefore = textarea.value.substring(0, cursorPosition);
                const textAfter = textarea.value.substring(textarea.selectionEnd);
                
                textarea.value = textBefore + variable + textAfter;
                textarea.focus();
                
                // Set cursor position after the inserted variable
                const newPosition = cursorPosition + variable.length;
                textarea.setSelectionRange(newPosition, newPosition);
                
                // Update the stored template
                updateStoredTemplate(textareaId, textarea.value);
                
                if (livePreviewMode) {
                    previewResponse(textareaId);
                }
                
                console.log('Successfully inserted variable:', variable);
            } catch (error) {
                console.error('Error in insertVariable:', error);
            }
        };

        // Preview individual response
        window.previewResponse = function(textareaId) {
            console.log('previewResponse called with:', textareaId);
            try {
                const textarea = document.getElementById(textareaId);
                if (!textarea) {
                    console.error('Textarea not found for preview:', textareaId);
                    return;
                }

                const template = textarea.value;
                const previewText = replaceVariables(template);
                
                showPreviewModal(textareaId, template, previewText);
                console.log('Successfully showed preview for:', textareaId);
            } catch (error) {
                console.error('Error in previewResponse:', error);
            }
        };

        // Toggle live preview mode
        window.toggleLivePreview = function() {
            console.log('toggleLivePreview called');
            try {
                livePreviewMode = !livePreviewMode;
                const button = document.getElementById('live-preview-btn');
                
                if (livePreviewMode) {
                    button.innerHTML = '<i class="fas fa-eye-slash mr-2"></i>Stop Live Preview';
                    button.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                    button.classList.add('bg-red-600', 'hover:bg-red-700');
                    showBasicNotification(' Live Preview Mode: Changes will preview automatically', 'info');
                } else {
                    button.innerHTML = '<i class="fas fa-eye mr-2"></i>Live Preview';
                    button.classList.remove('bg-red-600', 'hover:bg-red-700');
                    button.classList.add('bg-purple-600', 'hover:bg-purple-700');
                    showBasicNotification(' Live Preview Mode: Disabled', 'info');
                }
                console.log('Live preview mode:', livePreviewMode);
            } catch (error) {
                console.error('Error in toggleLivePreview:', error);
            }
        };

        // Save all response categories
        window.saveResponseCategories = async function() {
            console.log('saveResponseCategories called');
            showBasicNotification(' Saving response categories...', 'info');
            
            try {
                // Get current company ID
                const companyId = getCurrentCompanyId();
                if (!companyId || companyId === 'demo-company') {
                    showBasicNotification(' No valid company ID found. Please access this page with a proper company ID in the URL (?id=YOUR_COMPANY_ID)', 'error');
                    return;
                }
                
                console.log('Using company ID:', companyId);
                
                // Collect all form data
                const formData = {
                    enabled: true, // AI Agent Logic is enabled
                    answerPriorityFlow: [],
                    agentPersonality: {
                        voiceTone: document.getElementById('voice-tone')?.value || 'friendly',
                        speechPace: document.getElementById('speech-pace')?.value || 'moderate'
                    },
                    behaviorControls: {
                        allowBargeIn: document.getElementById('allow-barge-in')?.checked || false,
                        acknowledgeEmotion: document.getElementById('acknowledge-emotion')?.checked || false,
                        useEmails: document.getElementById('use-emails')?.checked || false
                    },
                    responseCategories: {
                        core: {
                            greeting: document.getElementById('greeting-response')?.value || '',
                            farewell: document.getElementById('farewell-response')?.value || '',
                            transfer: document.getElementById('transfer-response')?.value || '',
                            serviceUnavailable: document.getElementById('service-unavailable-response')?.value || '',
                            hold: document.getElementById('hold-response')?.value || '',
                            businessHours: document.getElementById('business-hours-response')?.value || ''
                        },
                        advanced: {
                            emergency: document.getElementById('emergency-response')?.value || '',
                            afterHours: document.getElementById('after-hours-response')?.value || '',
                            appointmentConfirmation: document.getElementById('appointment-confirmation')?.value || '',
                            schedulingConflict: document.getElementById('scheduling-conflict')?.value || ''
                        },
                        emotional: {
                            frustrated: document.getElementById('frustrated-customer')?.value || '',
                            appreciative: document.getElementById('appreciative-response')?.value || '',
                            problemResolution: document.getElementById('problem-resolution')?.value || '',
                            qualityAssurance: document.getElementById('quality-assurance')?.value || ''
                        }
                    }
                };
                
                console.log('Form data collected:', formData);
                
                // Get priority flow items if they exist
                const priorityItems = document.querySelectorAll('.priority-item');
                console.log('Priority items found:', priorityItems.length);
                priorityItems.forEach((item, index) => {
                    const sourceId = item.dataset.source;
                    const titleElement = item.querySelector('h3');
                    const descriptionElement = item.querySelector('p');
                    const isActive = item.querySelector('input[type="checkbox"]')?.checked || false;
                    
                    if (titleElement) {
                        const name = titleElement.textContent?.trim();
                        const description = descriptionElement?.textContent?.trim() || '';
                        
                        formData.answerPriorityFlow.push({
                            id: sourceId,
                            name: name,
                            description: description,
                            active: isActive,
                            primary: index === 0, // First item is primary
                            priority: index + 1,
                            icon: sourceId.includes('company') ? 'building' : 
                                  sourceId.includes('trade') ? 'industry' : 
                                  sourceId.includes('template') ? 'edit' : 'cog',
                            category: sourceId.includes('company') ? 'primary' : 
                                     sourceId.includes('trade') ? 'industry' : 
                                     sourceId.includes('template') ? 'template' : 'other',
                            confidenceThreshold: 0.7,
                            intelligenceLevel: 'medium',
                            performance: {
                                successRate: 0,
                                avgConfidence: 0,
                                usageCount: 0
                            }
                        });
                    }
                });
                
                console.log('Final form data:', formData);
                
                // Add metadata
                formData.lastUpdated = new Date().toISOString();
                formData.version = (formData.version || 0) + 1; // Increment version
                
                // Try both API endpoints for compatibility
                let response;
                let endpoint = `/api/admin/${companyId}/ai-settings`;
                
                try {
                    // First try the Blueprint-compliant endpoint
                    console.log('Trying Blueprint endpoint:', endpoint);
                    response = await fetch(endpoint, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify(formData)
                    });
                    
                    if (!response.ok && response.status === 401) {
                        throw new Error('Authentication required');
                    }
                } catch (error) {
                    console.log('Blueprint endpoint failed, trying simple endpoint');
                    endpoint = `/api/simple/admin/${companyId}/ai-settings`;
                    try {
                        response = await fetch(endpoint, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                            body: JSON.stringify(formData)
                        });
                    } catch (simpleError) {
                        console.log('Simple endpoint failed, trying legacy endpoint');
                        endpoint = '/api/ai-agent-logic/save-config';
                        response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                            body: JSON.stringify(formData)
                        });
                    }
                }
                
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                if (response.ok) {
                    const result = await response.json();
                    showBasicNotification(' Configuration saved successfully!', 'success');
                    console.log('Save successful:', result);
                } else {
                    const errorText = await response.text();
                    console.error('Response error text:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }
                
            } catch (error) {
                console.error('Save failed:', error);
                showBasicNotification(` Failed to save: ${error.message}`, 'error');
            }
        };

        // Preview all responses
        window.previewAllResponses = function() {
            console.log('previewAllResponses called');
            showBasicNotification(' Showing preview of all responses...', 'info');
        };

        // Verify what's actually saved in the database
        window.verifyConfiguration = async function() {
            console.log('verifyConfiguration called');
            showBasicNotification(' Checking what\'s actually saved in database...', 'info');
            
            try {
                const response = await fetch('/api/ai-agent-logic/verify-config', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(' VERIFICATION RESULT - What\'s actually in the database:', result);
                    
                    const config = result.currentConfiguration;
                    
                    showBasicNotification(` Database Check Complete! Version: ${config.version}, Last Updated: ${config.lastUpdated ? new Date(config.lastUpdated).toLocaleString() : 'Never'}`, 'success');
                    
                    // Log detailed breakdown
                    console.log(' DETAILED VERIFICATION:');
                    console.log('Voice Tone:', config.agentPersonality?.voiceTone || 'Not set');
                    console.log('Speech Pace:', config.agentPersonality?.speechPace || 'Not set');
                    console.log('Allow Barge-In:', config.behaviorControls?.allowBargeIn || false);
                    console.log('Acknowledge Emotion:', config.behaviorControls?.acknowledgeEmotion || false);
                    console.log('Use Emails:', config.behaviorControls?.useEmails || false);
                    console.log('Priority Flow Items:', config.answerPriorityFlow?.length || 0);
                    
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }
                
            } catch (error) {
                console.error('Verification failed:', error);
                showBasicNotification(` Verification failed: ${error.message}`, 'error');
            }
        };

        // Test that all functions are properly loaded
        console.log('Response Categories functions loaded:');
        console.log('switchResponseTab:', typeof window.switchResponseTab);
        console.log('insertVariable:', typeof window.insertVariable);
        console.log('previewResponse:', typeof window.previewResponse);
        console.log('toggleLivePreview:', typeof window.toggleLivePreview);
        console.log('saveResponseCategories:', typeof window.saveResponseCategories);
        console.log('previewAllResponses:', typeof window.previewAllResponses);
        console.log('verifyConfiguration:', typeof window.verifyConfiguration);

    </script>
</body>
</html>
