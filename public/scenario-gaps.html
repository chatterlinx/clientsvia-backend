<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scenario Gaps - ClientsVia AI Intelligence</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-pink: #f472b6;
            --accent-purple: #a78bfa;
            --accent-blue: #60a5fa;
            --accent-green: #34d399;
            --accent-yellow: #fbbf24;
            --accent-red: #f87171;
            --border-color: #334155;
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, #2d1f4e 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            border-color: var(--accent-purple);
            color: white;
            transform: translateX(-1px);
        }
        
        .header-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .header-title h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-title p {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .period-selector {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 4px;
        }
        
        .period-btn {
            padding: 8px 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .period-btn.active {
            background: var(--accent-purple);
            color: white;
        }
        
        .refresh-btn {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .refresh-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-purple);
        }
        
        /* Main Content */
        .main-content {
            padding: 32px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }
        
        .summary-card.highlight {
            border-color: var(--accent-pink);
            background: linear-gradient(135deg, rgba(244, 114, 182, 0.1) 0%, rgba(167, 139, 250, 0.1) 100%);
        }
        
        .summary-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .summary-value.pink { color: var(--accent-pink); }
        .summary-value.purple { color: var(--accent-purple); }
        .summary-value.green { color: var(--accent-green); }
        .summary-value.yellow { color: var(--accent-yellow); }
        .summary-value.blue { color: var(--accent-blue); }
        
        .summary-label {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Priority Sections */
        .priority-section {
            margin-bottom: 32px;
        }
        
        .priority-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .priority-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-badge.high {
            background: rgba(248, 113, 113, 0.2);
            color: var(--accent-red);
        }
        
        .priority-badge.medium {
            background: rgba(251, 191, 36, 0.2);
            color: var(--accent-yellow);
        }
        
        .priority-badge.low {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
        }
        
        .priority-count {
            color: var(--text-muted);
            font-size: 14px;
        }
        
        /* Gap Cards */
        .gaps-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .gap-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s;
        }
        
        .gap-card:hover {
            border-color: var(--accent-purple);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .gap-card.high {
            border-left: 4px solid var(--accent-red);
        }
        
        .gap-card.medium {
            border-left: 4px solid var(--accent-yellow);
        }
        
        .gap-card.low {
            border-left: 4px solid var(--text-muted);
        }
        
        .gap-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .gap-phrase {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .gap-phrase i {
            color: var(--accent-pink);
        }
        
        .gap-stats {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .gap-stat {
            text-align: center;
        }
        
        .gap-stat-value {
            font-size: 20px;
            font-weight: 700;
        }
        
        .gap-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .gap-examples {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .gap-examples-title {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .gap-example {
            color: var(--text-secondary);
            font-size: 14px;
            padding: 4px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .gap-example:last-child {
            border-bottom: none;
        }
        
        .gap-example::before {
            content: '"';
            color: var(--accent-purple);
        }
        
        .gap-example::after {
            content: '"';
            color: var(--accent-purple);
        }
        
        .gap-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
            color: white;
        }
        
        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(244, 114, 182, 0.4);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            border-color: var(--accent-purple);
        }
        
        .btn-ghost {
            background: none;
            color: var(--text-muted);
        }
        
        .btn-ghost:hover {
            color: var(--text-primary);
        }
        
        /* Savings Badge */
        .savings-badge {
            background: rgba(52, 211, 153, 0.15);
            color: var(--accent-green);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 64px 32px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px dashed var(--border-color);
        }
        
        .empty-state i {
            font-size: 64px;
            color: var(--accent-green);
            margin-bottom: 24px;
        }
        
        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .empty-state p {
            color: var(--text-secondary);
        }
        
        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 64px;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--accent-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow: auto;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .modal-header h2 i {
            color: var(--accent-pink);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .form-label .badge {
            font-size: 10px;
            background: var(--accent-purple);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .mode-selector {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .mode-btn:hover {
            border-color: var(--accent-purple);
            color: var(--text-primary);
        }
        
        .mode-btn.active {
            border-color: var(--accent-pink);
            background: rgba(244, 114, 182, 0.15);
            color: var(--accent-pink);
        }
        
        .triggers-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .trigger-tag {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .trigger-tag button {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            font-size: 14px;
        }
        
        .trigger-tag button:hover {
            color: var(--accent-red);
        }
        
        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* Calls Preview Modal */
        .call-preview-item {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .call-preview-item:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-purple);
        }
        
        .call-preview-header {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
        }
        
        .call-date {
            color: var(--text-secondary);
        }
        
        .call-phone {
            color: var(--accent-pink);
            font-weight: 500;
        }
        
        .call-duration {
            color: var(--text-muted);
            margin-left: auto;
        }
        
        .call-preview-text {
            color: var(--text-primary);
            font-size: 14px;
            font-style: italic;
        }
        
        /* Preview Sections */
        .preview-section {
            margin-bottom: 16px;
        }
        
        .preview-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .preview-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .preview-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .preview-reply {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-radius: 8px;
            color: var(--text-secondary);
            font-style: italic;
            line-height: 1.5;
        }
        
        .info-box {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .info-box i {
            color: var(--accent-purple);
            font-size: 20px;
            margin-top: 2px;
        }
        
        .info-box strong {
            color: var(--accent-pink);
        }
        
        .btn-large {
            padding: 14px 28px !important;
            font-size: 16px !important;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-lg);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            border-color: var(--accent-green);
        }
        
        .toast.error {
            border-color: var(--accent-red);
        }
        
        .toast i {
            font-size: 20px;
        }
        
        .toast.success i { color: var(--accent-green); }
        .toast.error i { color: var(--accent-red); }
        
        /* Sub-tabs Navigation */
        .sub-tabs {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 32px;
            display: flex;
            gap: 8px;
        }
        
        .sub-tab {
            padding: 16px 24px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sub-tab:hover {
            color: var(--text-primary);
        }
        
        .sub-tab.active {
            color: var(--accent-purple);
            border-bottom-color: var(--accent-purple);
        }
        
        .sub-tab .badge {
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .sub-tab.active .badge {
            background: rgba(167, 139, 250, 0.2);
            color: var(--accent-purple);
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Audit Section Styles */
        .audit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .audit-actions {
            display: flex;
            gap: 12px;
        }
        
        .run-audit-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .run-audit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(167, 139, 250, 0.4);
        }
        
        .run-audit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .health-score-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            margin-bottom: 24px;
        }
        
        .health-score {
            font-size: 72px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .health-score.excellent { color: var(--accent-green); }
        .health-score.good { color: var(--accent-blue); }
        .health-score.fair { color: var(--accent-yellow); }
        .health-score.poor { color: var(--accent-red); }
        
        .health-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .health-stats {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 16px;
        }
        
        .health-stat {
            text-align: center;
        }
        
        .health-stat-value {
            font-size: 24px;
            font-weight: 600;
        }
        
        .health-stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .violations-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .violation-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
        }
        
        .violation-card.error {
            border-left: 4px solid var(--accent-red);
        }
        
        .violation-card.warning {
            border-left: 4px solid var(--accent-yellow);
        }
        
        .violation-card.info {
            border-left: 4px solid var(--accent-blue);
        }
        
        .violation-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .violation-scenario {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .violation-severity {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .violation-severity.error {
            background: rgba(248, 113, 113, 0.2);
            color: var(--accent-red);
        }
        
        .violation-severity.warning {
            background: rgba(251, 191, 36, 0.2);
            color: var(--accent-yellow);
        }
        
        .violation-severity.info {
            background: rgba(96, 165, 250, 0.2);
            color: var(--accent-blue);
        }
        
        .violation-message {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .violation-field {
            font-family: monospace;
            font-size: 12px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .violation-suggestion {
            font-size: 13px;
            color: var(--accent-green);
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(52, 211, 153, 0.1);
            border-radius: 6px;
        }
        
        .violation-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .fix-btn {
            padding: 6px 14px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .fix-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(167, 139, 250, 0.4);
        }
        
        .fix-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .fix-preview {
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-purple);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .fix-preview-label {
            font-size: 11px;
            color: var(--accent-purple);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .fix-preview-content {
            font-family: monospace;
            font-size: 13px;
            color: var(--accent-green);
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .fix-preview-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .apply-fix-btn {
            padding: 8px 16px;
            background: var(--accent-green);
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        
        .apply-fix-btn:hover {
            background: #22c55e;
        }
        
        .cancel-fix-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .audit-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .audit-empty i {
            font-size: 48px;
            color: var(--accent-green);
            margin-bottom: 16px;
        }
        
        .audit-empty h3 {
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .manual-builder {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .manual-builder h3 {
            margin: 0 0 6px 0;
        }

        .manual-builder summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .manual-builder summary::-webkit-details-marker {
            display: none;
        }

        .manual-builder textarea {
            width: 100%;
            min-height: 90px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            resize: vertical;
        }

        .manual-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .manual-row select {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 10px;
            color: var(--text-primary);
        }

        .manual-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 12px;
        }

        .manual-actions .btn {
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            font-weight: 600;
        }

        .manual-actions .btn-primary {
            background: var(--accent-purple);
            color: #fff;
        }

        .manual-actions .btn-secondary {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        .manual-actions .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .manual-preview,
        .manual-validation {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="back-btn" onclick="goBackToControlPlane()">
                <i class="fas fa-arrow-left"></i>
                Back to Control Plane
            </button>
            <div class="header-icon">ðŸŽ¯</div>
            <div class="header-title">
                <h1>Scenario Gaps</h1>
                <p id="company-name">Loading...</p>
            </div>
        </div>
        <div class="header-right">
            <div class="period-selector">
                <button class="period-btn" data-days="7">7 Days</button>
                <button class="period-btn active" data-days="14">14 Days</button>
                <button class="period-btn" data-days="30">30 Days</button>
            </div>
            <button class="refresh-btn" onclick="copyPageSummary()" title="Copy summary for discussion">
                <i class="fas fa-copy"></i>
                Copy
            </button>
            <button class="refresh-btn" onclick="loadGaps()">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
        </div>
    </header>
    
    <!-- Sub-tabs Navigation -->
    <nav class="sub-tabs">
        <button class="sub-tab active" data-tab="gaps" onclick="switchTab('gaps')">
            <i class="fas fa-search"></i>
            Gap Fill
            <span class="badge" id="gaps-count">0</span>
        </button>
        <button class="sub-tab" data-tab="audit" onclick="switchTab('audit')">
            <i class="fas fa-clipboard-check"></i>
            Template Audit
            <span class="badge" id="health-badge">--</span>
        </button>
        <button class="sub-tab" data-tab="blueprint" onclick="switchTab('blueprint')">
            <i class="fas fa-drafting-compass"></i>
            Blueprint Builder
            <span class="badge" id="blueprint-badge" style="background: #8b5cf6;">NEW</span>
        </button>
        <button class="sub-tab" data-tab="company-local" onclick="switchTab('company-local')">
            <i class="fas fa-building"></i>
            Company Local
            <span class="badge" id="company-local-badge" style="background: #f59e0b;">0</span>
        </button>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- TAB 1: Gap Fill (existing content) -->
        <div class="tab-content active" id="tab-gaps">
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 ADD NEW SCENARIO (Manual Scenario Builder)
                 Proactively create scenarios via GPT-4 without waiting for gaps
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="manual-builder" id="manual-builder" style="
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(59, 130, 246, 0.08) 100%);
                border: 1px solid rgba(16, 185, 129, 0.3);
                border-radius: 16px;
                padding: 24px;
                margin-bottom: 24px;
            ">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <div style="
                        width: 48px;
                        height: 48px;
                        background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 24px;
                    ">âž•</div>
                    <div>
                        <h3 style="color: var(--text-primary); margin: 0; font-size: 18px;">Add New Scenario</h3>
                        <div style="font-size: 13px; color: var(--text-muted);">
                            GPT-4 generates a complete scenario from your description
                        </div>
                    </div>
                    <div id="manual-template-info" style="
                        margin-left: auto;
                        background: rgba(0,0,0,0.2);
                        padding: 8px 16px;
                        border-radius: 8px;
                        font-size: 12px;
                        color: var(--text-muted);
                    ">
                        <span id="manual-template-name">Loading template...</span>
                        <span id="manual-category-count" style="color: #10b981; margin-left: 8px;"></span>
                    </div>
                </div>

                <!-- Input Section -->
                <div style="display: grid; gap: 16px;">
                    <!-- Question Input -->
                    <div>
                        <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px; display: block;">
                            What did the caller ask? <span style="color: #ef4444;">*</span>
                        </label>
                        <textarea id="manual-question" placeholder="Example: How much is an AC tune-up?" style="
                            width: 100%;
                            min-height: 80px;
                            padding: 12px;
                            border: 1px solid var(--border-color);
                            border-radius: 8px;
                            background: var(--card-bg);
                            color: var(--text-primary);
                            font-size: 14px;
                            resize: vertical;
                        "></textarea>
                    </div>
                    
                    <!-- Options Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <!-- Category Dropdown -->
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px; display: block;">
                                Category
                            </label>
                            <select id="manual-category" style="
                                width: 100%;
                                padding: 10px 12px;
                                border: 1px solid var(--border-color);
                                border-radius: 8px;
                                background: var(--card-bg);
                                color: var(--text-primary);
                                font-size: 13px;
                            ">
                                <option value="">Auto (let AI choose)</option>
                            </select>
                        </div>
                        
                        <!-- Scenario Type -->
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px; display: block;">
                                Scenario Type
                            </label>
                            <select id="manual-type" style="
                                width: 100%;
                                padding: 10px 12px;
                                border: 1px solid var(--border-color);
                                border-radius: 8px;
                                background: var(--card-bg);
                                color: var(--text-primary);
                                font-size: 13px;
                            ">
                                <option value="">Auto (let AI choose)</option>
                                <option value="FAQ">FAQ</option>
                                <option value="BOOKING">BOOKING</option>
                                <option value="EMERGENCY">EMERGENCY</option>
                                <option value="TROUBLESHOOT">TROUBLESHOOT</option>
                                <option value="BILLING">BILLING</option>
                                <option value="TRANSFER">TRANSFER</option>
                                <option value="SMALL_TALK">SMALL_TALK</option>
                                <option value="AFTER_HOURS">AFTER_HOURS</option>
                                <option value="MAINTENANCE">MAINTENANCE</option>
                            </select>
                        </div>
                        
                        <!-- Trade (hidden by default) -->
                        <div id="manual-trade-row" style="display: none;">
                            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px; display: block;">
                                Trade
                            </label>
                            <select id="manual-trade" style="
                                width: 100%;
                                padding: 10px 12px;
                                border: 1px solid var(--border-color);
                                border-radius: 8px;
                                background: var(--card-bg);
                                color: var(--text-primary);
                                font-size: 13px;
                            "></select>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 8px;">
                        <label style="font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="manual-allow-warnings" style="width: 16px; height: 16px;" />
                            Allow saving with warnings
                        </label>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" id="manual-generate-btn" onclick="generateManualScenario()" style="
                                background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
                                border: none;
                                padding: 12px 24px;
                                font-weight: 600;
                            ">
                                <i class="fas fa-wand-magic-sparkles"></i> Generate with GPT-4
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Generated Scenario Preview (hidden until generated) -->
                <div id="manual-result" style="display: none; margin-top: 24px; border-top: 1px solid var(--border-color); padding-top: 24px;">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-grid" id="summary-grid">
            <div class="summary-card">
                <div class="summary-value pink" id="total-tier3">--</div>
                <div class="summary-label">Tier 3 Calls</div>
            </div>
            <div class="summary-card">
                <div class="summary-value purple" id="unique-gaps">--</div>
                <div class="summary-label">Unique Gaps</div>
            </div>
            <div class="summary-card highlight">
                <div class="summary-value green" id="potential-savings">--</div>
                <div class="summary-label">Est. Weekly Savings</div>
            </div>
            <div class="summary-card">
                <div class="summary-value yellow" id="high-priority">--</div>
                <div class="summary-label">High Priority</div>
            </div>
        </div>
        
        <!-- AI Settings Panel (Collapsible) -->
        <details class="ai-settings-panel" id="ai-settings-panel" style="
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            margin-bottom: 24px;
            overflow: hidden;
        ">
            <summary style="
                padding: 14px 20px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: rgba(139, 92, 246, 0.1);
                font-weight: 600;
                color: var(--text-primary);
            ">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-brain" style="color: var(--accent-purple);"></i>
                    <span>AI Generation Settings</span>
                    <span style="
                        background: rgba(34, 197, 94, 0.2);
                        color: #22c55e;
                        font-size: 11px;
                        padding: 2px 8px;
                        border-radius: 4px;
                        font-weight: 500;
                    " id="ai-model-badge">GPT-4o</span>
                </div>
                <i class="fas fa-chevron-down" style="color: var(--text-muted); transition: transform 0.2s;"></i>
            </summary>
            <div style="padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <!-- Model -->
                <div style="background: var(--bg-secondary); padding: 14px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Model</div>
                    <div style="font-size: 15px; font-weight: 600; color: var(--accent-green);">
                        <i class="fas fa-microchip" style="margin-right: 6px;"></i>GPT-4o
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Highest quality generation</div>
                </div>
                
                <!-- Temperature -->
                <div style="background: var(--bg-secondary); padding: 14px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Temperature</div>
                    <div style="font-size: 15px; font-weight: 600; color: var(--accent-yellow);">
                        <i class="fas fa-thermometer-half" style="margin-right: 6px;"></i>0.7
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Balanced creativity</div>
                </div>
                
                <!-- Max Tokens -->
                <div style="background: var(--bg-secondary); padding: 14px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Max Tokens</div>
                    <div style="font-size: 15px; font-weight: 600; color: var(--accent-blue);">
                        <i class="fas fa-text-width" style="margin-right: 6px;"></i>4,000
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Response limit</div>
                </div>
                
                <!-- Settings Count (derived from registry) -->
                <div style="background: var(--bg-secondary); padding: 14px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Content Settings</div>
                    <div id="ai-settings-count" style="font-size: 15px; font-weight: 600; color: var(--accent-purple);">
                        <i class="fas fa-list-check" style="margin-right: 6px;"></i><span id="content-field-count">--</span> fields
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">WHAT to say (not behavior)</div>
                </div>
                
                <!-- Duplicate Detection -->
                <div style="background: var(--bg-secondary); padding: 14px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Duplicate Detection</div>
                    <div style="font-size: 15px; font-weight: 600; color: var(--accent-green);">
                        <i class="fas fa-shield-check" style="margin-right: 6px;"></i>Enabled
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">60% similarity threshold</div>
                </div>
                
                <!-- Tone Examples -->
                <div style="background: var(--bg-secondary); padding: 14px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Tone Learning</div>
                    <div style="font-size: 15px; font-weight: 600; color: var(--accent-pink);">
                        <i class="fas fa-graduation-cap" style="margin-right: 6px;"></i>Enabled
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Learns from existing scenarios</div>
                </div>
            </div>
            
            <!-- Generation Rules Summary -->
            <div style="padding: 0 20px 20px 20px;">
                <div style="background: var(--bg-tertiary); padding: 14px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                        <i class="fas fa-gavel" style="color: var(--accent-yellow); margin-right: 6px;"></i>
                        Generation Rules
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 11px;">
                        <span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 8px; border-radius: 4px;">5-7 Quick Replies</span>
                        <span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 8px; border-radius: 4px;">4-5 Full Replies</span>
                        <span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 8px; border-radius: 4px;">10-15 Triggers</span>
                        <span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 8px; border-radius: 4px;">2-4 Regex Patterns</span>
                        <span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 8px; border-radius: 4px;">{callerName} Required</span>
                        <span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 8px; border-radius: 4px;">_noName Variants</span>
                        <span style="background: rgba(248, 113, 113, 0.2); color: #f87171; padding: 4px 8px; border-radius: 4px;">No Chatbot Phrases</span>
                        <span style="background: rgba(248, 113, 113, 0.2); color: #f87171; padding: 4px 8px; border-radius: 4px;">No Troubleshooting</span>
                        <span style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; padding: 4px 8px; border-radius: 4px;">Dispatcher Tone</span>
                        <span style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; padding: 4px 8px; border-radius: 4px;">Max 20 Words</span>
                    </div>
                </div>
            </div>
        </details>
        
        <!-- Gaps Content -->
        <div id="gaps-content">
            <div class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 16px; color: var(--text-secondary);">Analyzing call patterns...</p>
            </div>
        </div>
        </div><!-- END tab-gaps -->
        
        <!-- TAB 2: Template Audit -->
        <div class="tab-content" id="tab-audit">
            <div class="audit-header">
                <div>
                    <h2 style="margin-bottom: 4px;">Template Health Check</h2>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        Audit scenario content against dispatcher rules (ownership-aware)
                    </p>
                </div>
                <div class="audit-actions" style="display: flex; gap: 12px;">
                    <button class="run-audit-btn" onclick="runAudit()" id="run-audit-btn">
                        <i class="fas fa-play"></i>
                        Run Audit
                    </button>
                    <button class="run-audit-btn" onclick="runDeepAudit()" id="run-deep-audit-btn"
                        style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);"
                        title="GPT-4 powered comprehensive review - catches nuanced issues rules miss">
                        <i class="fas fa-brain"></i>
                        Deep Audit (AI)
                    </button>
                </div>
            </div>
            
            <!-- Health Score (hidden until audit runs) -->
            <div id="audit-results" style="display: none;">
                <div class="health-score-card">
                    <div class="health-score" id="audit-health-score">--</div>
                    <div class="health-label">Company Audit Score</div>
                    <div class="health-stats">
                        <div class="health-stat">
                            <div class="health-stat-value" id="audit-total" style="color: var(--accent-purple);">--</div>
                            <div class="health-stat-label">Scenarios</div>
                        </div>
                        <div class="health-stat" title="Scenarios with 0 errors (warnings allowed)">
                            <div class="health-stat-value" id="audit-passing" style="color: var(--accent-green);">--</div>
                            <div class="health-stat-label">No Errors</div>
                        </div>
                        <div class="health-stat" title="Scenarios with 0 errors AND 0 warnings (perfect)">
                            <div class="health-stat-value" id="audit-perfect" style="color: #22d3ee;">--</div>
                            <div class="health-stat-label">Perfect</div>
                        </div>
                        <div class="health-stat" title="Scenarios with 1+ errors (must fix)">
                            <div class="health-stat-value" id="audit-errors" style="color: var(--accent-red);">--</div>
                            <div class="health-stat-label">Failing</div>
                        </div>
                        <div class="health-stat" title="Total warning count across all scenarios">
                            <div class="health-stat-value" id="audit-warnings" style="color: var(--accent-yellow);">--</div>
                            <div class="health-stat-label">Warnings</div>
                        </div>
                    </div>
                </div>
                
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     SERVICE-AWARE AUDIT SCOPE
                     Shows what's actually audited (matches runtime truth)
                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div id="audit-scope-panel" style="display: none; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: var(--text-primary);">
                            <i class="fas fa-layer-group"></i> Audit Scope
                        </span>
                        <span style="font-size: 12px; color: var(--text-muted);">
                            Matches runtime: Template + Company Local + Service Toggles
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <!-- Main Template Bucket -->
                        <div id="bucket-main-template" style="
                            background: rgba(139, 92, 246, 0.1);
                            border: 1px solid rgba(139, 92, 246, 0.3);
                            border-radius: 12px;
                            padding: 16px;
                        ">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 18px;">ðŸ“‹</span>
                                <span style="font-weight: 600; color: var(--text-primary);">Main Template</span>
                            </div>
                            <div style="font-size: 28px; font-weight: 700; color: #8b5cf6;" id="bucket-main-count">0</div>
                            <div style="font-size: 12px; color: var(--text-muted);">scenarios audited</div>
                            <div style="margin-top: 8px; font-size: 11px;">
                                <span style="color: var(--accent-green);" id="bucket-main-passing">0 passing</span> â€¢ 
                                <span style="color: var(--accent-red);" id="bucket-main-failing">0 failing</span>
                            </div>
                        </div>
                        
                        <!-- Company Local Bucket -->
                        <div id="bucket-company-local" style="
                            background: rgba(245, 158, 11, 0.1);
                            border: 1px solid rgba(245, 158, 11, 0.3);
                            border-radius: 12px;
                            padding: 16px;
                        ">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 18px;">ðŸ¢</span>
                                <span style="font-weight: 600; color: var(--text-primary);">Company Local</span>
                            </div>
                            <div style="font-size: 28px; font-weight: 700; color: #f59e0b;" id="bucket-local-count">0</div>
                            <div style="font-size: 12px; color: var(--text-muted);">scenarios audited</div>
                            <div style="margin-top: 8px; font-size: 11px;">
                                <span style="color: var(--accent-green);" id="bucket-local-passing">0 passing</span> â€¢ 
                                <span style="color: var(--accent-red);" id="bucket-local-failing">0 failing</span>
                            </div>
                        </div>
                        
                        <!-- Disabled Services Bucket -->
                        <div id="bucket-disabled" style="
                            background: rgba(107, 114, 128, 0.1);
                            border: 1px dashed rgba(107, 114, 128, 0.4);
                            border-radius: 12px;
                            padding: 16px;
                        ">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 18px;">ðŸ”‡</span>
                                <span style="font-weight: 600; color: var(--text-muted);">Disabled Services</span>
                            </div>
                            <div style="font-size: 28px; font-weight: 700; color: #6b7280;" id="bucket-disabled-count">0</div>
                            <div style="font-size: 12px; color: var(--text-muted);">scenarios excluded</div>
                            <div style="margin-top: 8px; font-size: 11px; color: var(--text-muted);" id="bucket-disabled-services">
                                <!-- Service names listed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Rules Checked (Transparency) -->
                <div class="rules-checked-section" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px; cursor: pointer;" onclick="toggleRulesChecked()">
                        <i class="fas fa-clipboard-check" style="color: var(--accent-green);"></i>
                        Rules Checked
                        <span id="rules-checked-count" style="color: var(--text-muted); font-weight: normal; font-size: 14px;"></span>
                        <i class="fas fa-chevron-down" id="rules-toggle-icon" style="margin-left: auto; font-size: 12px;"></i>
                    </h3>
                    <div id="rules-checked-list" style="display: none;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Violations List -->
                <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-exclamation-triangle" style="color: var(--accent-yellow);"></i>
                    Issues Found
                    <span id="violations-count" style="color: var(--text-muted); font-weight: normal; font-size: 14px;"></span>
                </h3>
                <div class="violations-list" id="violations-list">
                    <!-- Violations will be populated here -->
                </div>
            </div>
            
            <!-- ðŸŽ¯ SETTINGS COVERAGE REGISTRY -->
            <!-- ðŸŽ¯ RUNTIME CONTRACT - Single Source of Truth -->
            <div id="settings-registry" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid var(--accent-purple); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="display: flex; align-items: center; gap: 8px; margin: 0; color: #fff;">
                        <i class="fas fa-file-contract" style="color: var(--accent-purple);"></i>
                        Runtime Contract
                        <span style="font-size: 12px; background: var(--accent-green); color: #000; padding: 2px 8px; border-radius: 12px; font-weight: 700;">SINGLE SOURCE OF TRUTH</span>
                    </h3>
                    <button onclick="loadSettingsRegistry()" style="background: var(--accent-purple); border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                
                <!-- Main Count: The ONE Number -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div style="background: linear-gradient(135deg, rgba(168,85,247,0.3) 0%, rgba(168,85,247,0.1) 100%); padding: 16px; border-radius: 12px; text-align: center; border: 2px solid var(--accent-purple);">
                        <div style="font-size: 36px; font-weight: bold; color: #fff;" id="reg-contract-total">--</div>
                        <div style="font-size: 13px; color: var(--text-primary); font-weight: 600;">Runtime Contract</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Settings Audit + Agent Use</div>
                    </div>
                    <div style="background: rgba(52,211,153,0.2); padding: 16px; border-radius: 12px; text-align: center; border: 1px solid var(--accent-green);">
                        <div style="font-size: 36px; font-weight: bold; color: var(--accent-green);" id="reg-ai-generates">--</div>
                        <div style="font-size: 13px; color: var(--text-primary); font-weight: 600;">AI Generates</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Gap Fill creates these</div>
                    </div>
                    <div style="background: rgba(251,191,36,0.2); padding: 16px; border-radius: 12px; text-align: center; border: 1px solid var(--accent-yellow);">
                        <div style="font-size: 36px; font-weight: bold; color: var(--accent-yellow);" id="reg-admin-configures">--</div>
                        <div style="font-size: 13px; color: var(--text-primary); font-weight: 600;">Admin Configures</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Manual setup required</div>
                    </div>
                </div>
                
                <!-- Perfect Alignment Banner -->
                <div id="registry-status" style="background: rgba(16,185,129,0.15); border: 1px solid var(--accent-green); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">âœ…</span>
                        <div>
                            <div style="font-weight: 600; color: var(--accent-green);">PERFECT ALIGNMENT</div>
                            <div style="font-size: 12px; color: #6ee7b7;" id="reg-status-message">
                                Single source of truth - no drift between Audit, Gap Fill, and Agent
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Breakdown -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">Runtime Settings Breakdown</div>
                        <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">
                            <span style="color: var(--text-secondary);">ðŸŽ¯ Auto (AI generates)</span>
                            <span style="color: #fff; font-weight: 600;" id="reg-auto-count">--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 13px;">
                            <span style="color: var(--text-secondary);">ðŸ”§ Manual (admin configures)</span>
                            <span style="color: #fff; font-weight: 600;" id="reg-manual-count">--</span>
                        </div>
                    </div>
                    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">Other Settings</div>
                        <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">
                            <span style="color: var(--text-secondary);">âš™ï¸ System (auto-computed)</span>
                            <span style="color: #fff; font-weight: 600;" id="reg-system-count">--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 13px;">
                            <span style="color: var(--text-secondary);">ðŸ”® Future (planned)</span>
                            <span style="color: #fff; font-weight: 600;" id="reg-future-count">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ðŸŽ¯ SCENARIO POOL ALIGNMENT - Single Source of Truth for Scenarios -->
            <div id="scenario-pool-alignment" style="background: linear-gradient(135deg, #1a2e1a 0%, #162e16 100%); border: 2px solid var(--accent-green); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="display: flex; align-items: center; gap: 8px; margin: 0; color: #fff;">
                        <i class="fas fa-sync-alt" style="color: var(--accent-green);"></i>
                        Scenario Pool Alignment
                        <span style="font-size: 12px; background: var(--accent-green); color: #000; padding: 2px 8px; border-radius: 12px; font-weight: 700;">SINGLE SOURCE OF TRUTH</span>
                    </h3>
                    <button onclick="loadScenarioPoolAlignment()" style="background: var(--accent-green); border: none; color: #000; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                
                <!-- Alignment Summary -->
                <div id="scenario-alignment-summary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #fff;" id="align-total">--</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Total in Templates</div>
                    </div>
                    <div style="background: rgba(96,165,250,0.2); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid var(--accent-blue);">
                        <div style="font-size: 24px; font-weight: bold; color: var(--accent-blue);" id="align-active">--</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Active Scenarios</div>
                    </div>
                    <div style="background: rgba(244,114,182,0.2); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid var(--accent-pink);">
                        <div style="font-size: 24px; font-weight: bold; color: var(--accent-pink);" id="align-disabled">--</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Disabled by Company</div>
                    </div>
                    <div style="background: rgba(52,211,153,0.2); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid var(--accent-green);">
                        <div style="font-size: 24px; font-weight: bold; color: var(--accent-green);" id="align-agent">--</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Agent Can See</div>
                    </div>
                </div>
                
                <!-- Alignment Status -->
                <div id="scenario-alignment-status" style="display: none; margin-bottom: 16px;">
                    <!-- Populated by JS -->
                </div>
                
                <!-- System Harmony Check -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                        <strong style="color: #fff;">System Harmony Check:</strong> All three systems should work with the same scenario pool
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="align-gapfill-icon" style="font-size: 16px;">â³</span>
                            <div>
                                <div style="font-size: 13px; font-weight: 600; color: #fff;">Gap Fill (GPT-4)</div>
                                <div style="font-size: 11px; color: var(--text-muted);" id="align-gapfill-count">-- scenarios</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="align-audit-icon" style="font-size: 16px;">â³</span>
                            <div>
                                <div style="font-size: 13px; font-weight: 600; color: #fff;">Audit Engine</div>
                                <div style="font-size: 11px; color: var(--text-muted);" id="align-audit-count">-- scenarios</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="align-runtime-icon" style="font-size: 16px;">â³</span>
                            <div>
                                <div style="font-size: 13px; font-weight: 600; color: #fff;">LLM Agent (Runtime)</div>
                                <div style="font-size: 11px; color: var(--text-muted);" id="align-runtime-count">-- scenarios</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Audit Rules Checklist (always visible) -->
            <div style="background: linear-gradient(135deg, #1e1e2e 0%, #252538 100%); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 24px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="display: flex; align-items: center; gap: 10px; margin: 0; color: #fff; font-size: 18px;">
                        <i class="fas fa-clipboard-check" style="color: #8b5cf6;"></i>
                        Company Audit Engine
                        <span style="background: rgba(16, 185, 129, 0.2); color: #34d399; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">SERVICE-AWARE</span>
                    </h3>
                    <button onclick="toggleChecklist()" style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.3); color: #a78bfa; cursor: pointer; font-size: 12px; padding: 6px 12px; border-radius: 6px;">
                        <i class="fas fa-chevron-down" id="checklist-toggle-icon"></i> Toggle
                    </button>
                </div>
                
                <!-- Service-Aware Scope Explanation -->
                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="font-size: 24px;">ðŸŽ¯</div>
                        <div>
                            <div style="font-weight: 700; color: #34d399; margin-bottom: 6px; font-size: 14px;">
                                Audit = Runtime Truth
                            </div>
                            <div style="font-size: 13px; color: #e2e8f0; line-height: 1.6;">
                                This audit matches exactly what the AI agent uses at runtime:
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                <span style="background: rgba(139, 92, 246, 0.2); color: #a78bfa; padding: 4px 10px; border-radius: 6px; font-size: 12px;">
                                    ðŸ“‹ Main Template (enabled services only)
                                </span>
                                <span style="background: rgba(245, 158, 11, 0.2); color: #fbbf24; padding: 4px 10px; border-radius: 6px; font-size: 12px;">
                                    ðŸ¢ Company Local Scenarios
                                </span>
                                <span style="background: rgba(107, 114, 128, 0.2); color: #9ca3af; padding: 4px 10px; border-radius: 6px; font-size: 12px;">
                                    ðŸ”‡ Disabled Services = Excluded
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
                    <strong>9 Deterministic Rules</strong> check every scenario for quality, consistency, and proper wiring:
                </div>
                
                <div id="audit-checklist" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                    
                    <!-- Rule 1: Completeness -->
                    <div style="background: rgba(59, 130, 246, 0.15); padding: 16px; border-radius: 12px; border-left: 4px solid #3b82f6;">
                        <div style="font-weight: 700; color: #60a5fa; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-check-circle"></i> Completeness
                        </div>
                        <ul style="font-size: 13px; color: #e2e8f0; margin: 0; padding-left: 18px; line-height: 1.7;">
                            <li>Scenario name is present</li>
                            <li>triggers[] has at least 1 item</li>
                            <li>quickReplies[] has at least 1 item</li>
                            <li>scenarioType is not UNKNOWN</li>
                            <li>behavior is set and valid</li>
                            <li>4-7 quickReplies variations</li>
                            <li>4-5 fullReplies variations</li>
                        </ul>
                    </div>
                    
                    <!-- Rule 2: Banned Phrases (ERROR severity) -->
                    <div style="background: rgba(239, 68, 68, 0.15); padding: 16px; border-radius: 12px; border-left: 4px solid #ef4444;">
                        <div style="font-weight: 700; color: #f87171; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-ban"></i> Banned Phrases
                        </div>
                        <ul style="font-size: 13px; color: #e2e8f0; margin: 0; padding-left: 18px; line-height: 1.7;">
                            <li><strong style="color: #fca5a5;">Chatbot:</strong> "we're here to help", "thank you for reaching out"</li>
                            <li><strong style="color: #fca5a5;">Help desk:</strong> "got it", "no problem", "absolutely"</li>
                            <li><strong style="color: #fca5a5;">Troubleshooting:</strong> "have you tried", "have you checked"</li>
                            <li>Checks all reply fields</li>
                        </ul>
                    </div>
                    
                    <!-- Rule 3: Structure -->
                    <div style="background: rgba(234, 179, 8, 0.15); padding: 16px; border-radius: 12px; border-left: 4px solid #eab308;">
                        <div style="font-weight: 700; color: #fde047; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-sitemap"></i> Response Structure
                        </div>
                        <ul style="font-size: 13px; color: #e2e8f0; margin: 0; padding-left: 18px; line-height: 1.7;">
                            <li>quickReplies = classify (diagnostic Qs)</li>
                            <li>fullReplies = book (move forward)</li>
                            <li>No booking language in quickReplies</li>
                            <li>No stacked acknowledgments</li>
                            <li>Only ONE question per reply</li>
                        </ul>
                    </div>
                    
                    <!-- Rule 4: Personalization -->
                    <div style="background: rgba(34, 197, 94, 0.15); padding: 16px; border-radius: 12px; border-left: 4px solid #22c55e;">
                        <div style="font-weight: 700; color: #4ade80; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-user-check"></i> Personalization
                        </div>
                        <ul style="font-size: 13px; color: #e2e8f0; margin: 0; padding-left: 18px; line-height: 1.7;">
                            <li>{callerName} used in replies</li>
                            <li>_noName variants exist</li>
                            <li>No deprecated placeholders</li>
                            <li>Valid placeholder format</li>
                        </ul>
                    </div>
                    
                    <!-- Rule 5: Response Length -->
                    <div style="background: rgba(139, 92, 246, 0.15); padding: 16px; border-radius: 12px; border-left: 4px solid #8b5cf6;">
                        <div style="font-weight: 700; color: #a78bfa; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-text-width"></i> Response Length
                        </div>
                        <ul style="font-size: 13px; color: #e2e8f0; margin: 0; padding-left: 18px; line-height: 1.7;">
                            <li>quickReplies â‰¤ 20 words</li>
                            <li>fullReplies â‰¤ 25 words</li>
                            <li>_noName variants same limits</li>
                        </ul>
                    </div>
                    
                    <!-- Rule 6: Triggers -->
                    <div style="background: rgba(6, 182, 212, 0.15); padding: 16px; border-radius: 12px; border-left: 4px solid #06b6d4;">
                        <div style="font-weight: 700; color: #22d3ee; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-bolt"></i> Triggers
                        </div>
                        <ul style="font-size: 13px; color: #e2e8f0; margin: 0; padding-left: 18px; line-height: 1.7;">
                            <li>3-20 triggers per scenario</li>
                            <li>No generic ("yes", "ok", "hello")</li>
                            <li>Mix of short + long triggers</li>
                            <li>regexTriggers[] compile cleanly</li>
                        </ul>
                    </div>
                    
                    <!-- Rule 7: Wiring -->
                    <div style="background: rgba(236, 72, 153, 0.15); padding: 16px; border-radius: 12px; border-left: 4px solid #ec4899;">
                        <div style="font-weight: 700; color: #f472b6; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-plug"></i> Wiring
                        </div>
                        <ul style="font-size: 13px; color: #e2e8f0; margin: 0; padding-left: 18px; line-height: 1.7;">
                            <li>bookingIntent = true for BOOKING/EMERGENCY</li>
                            <li>bookingIntent = false for FAQ/BILLING</li>
                            <li>Type matches intent flag</li>
                        </ul>
                    </div>
                    
                    <!-- Rule 8: Priority -->
                    <div style="background: rgba(249, 115, 22, 0.15); padding: 16px; border-radius: 12px; border-left: 4px solid #f97316;">
                        <div style="font-weight: 700; color: #fb923c; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-sort-numeric-up"></i> Priority Ranges
                        </div>
                        <ul style="font-size: 13px; color: #e2e8f0; margin: 0; padding-left: 18px; line-height: 1.7;">
                            <li>EMERGENCY: 90-100</li>
                            <li>BOOKING: 70-85</li>
                            <li>FAQ/BILLING: 40-60</li>
                            <li>SMALL_TALK: -5 to 10</li>
                        </ul>
                    </div>
                    
                    <!-- Rule 9: Content Integrity -->
                    <div style="background: rgba(148, 163, 184, 0.15); padding: 16px; border-radius: 12px; border-left: 4px solid #94a3b8;">
                        <div style="font-weight: 700; color: #cbd5e1; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-shield-alt"></i> Content Integrity
                        </div>
                        <ul style="font-size: 13px; color: #e2e8f0; margin: 0; padding-left: 18px; line-height: 1.7;">
                            <li>isActive = true, status = valid</li>
                            <li>No conflicting negativeTriggers</li>
                            <li>Valid entityCapture[] types</li>
                            <li>minConfidence in range</li>
                            <li>Non-content fields = INFO only</li>
                        </ul>
                    </div>
                    
                </div>
            </div>
            
            <!-- Agent Wiring Status (what the agent actually uses) -->
            <div style="background: linear-gradient(135deg, #1a2332 0%, #1e293b 100%); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 16px; padding: 24px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="display: flex; align-items: center; gap: 10px; margin: 0; color: #fff; font-size: 18px;">
                        <i class="fas fa-plug" style="color: #22c55e;"></i>
                        Agent Wiring Status
                        <span style="background: rgba(34, 197, 94, 0.2); color: #4ade80; padding: 4px 10px; border-radius: 20px; font-size: 13px; font-weight: 600;" id="wiring-active-count">18/22 Active</span>
                    </h3>
                    <button onclick="toggleWiringStatus()" style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.3); color: #4ade80; cursor: pointer; font-size: 12px; padding: 6px 12px; border-radius: 6px;">
                        <i class="fas fa-chevron-down" id="wiring-toggle-icon"></i> Details
                    </button>
                </div>
                
                <!-- Summary bar -->
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <div style="flex: 1; background: rgba(34, 197, 94, 0.15); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #4ade80;">18</div>
                        <div style="font-size: 12px; color: #86efac;">Scenario Fields</div>
                    </div>
                    <div style="flex: 1; background: rgba(16, 185, 129, 0.15); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #34d399;" id="wiring-services-count">--</div>
                        <div style="font-size: 12px; color: #6ee7b7;">Services Enabled</div>
                    </div>
                    <div style="flex: 1; background: rgba(245, 158, 11, 0.15); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #fbbf24;" id="wiring-local-count">--</div>
                        <div style="font-size: 12px; color: #fcd34d;">Company Local</div>
                    </div>
                    <div style="flex: 1; background: rgba(148, 163, 184, 0.15); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #94a3b8;">4</div>
                        <div style="font-size: 12px; color: #cbd5e1;">Future Features</div>
                    </div>
                </div>
                
                <!-- Expandable details -->
                <div id="wiring-status-details" style="display: none;">
                    
                    <!-- Service-Aware Architecture (NEW) -->
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-weight: 600; color: #34d399; margin-bottom: 12px; font-size: 14px;">
                            <i class="fas fa-layer-group"></i> Service-Aware Architecture
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div style="background: rgba(139, 92, 246, 0.15); border-radius: 8px; padding: 12px;">
                                <div style="font-size: 12px; color: #a78bfa; font-weight: 600; margin-bottom: 4px;">Main Template</div>
                                <div style="font-size: 11px; color: #e2e8f0;">Scenarios from enabled service categories only</div>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.15); border-radius: 8px; padding: 12px;">
                                <div style="font-size: 12px; color: #fbbf24; font-weight: 600; margin-bottom: 4px;">Company Local</div>
                                <div style="font-size: 11px; color: #e2e8f0;">Custom scenarios for this company (merged)</div>
                            </div>
                            <div style="background: rgba(239, 68, 68, 0.15); border-radius: 8px; padding: 12px;">
                                <div style="font-size: 12px; color: #f87171; font-weight: 600; margin-bottom: 4px;">Disabled Services</div>
                                <div style="font-size: 11px; color: #e2e8f0;">Deterministic decline (no LLM cost)</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 11px; color: #6ee7b7;">
                            <i class="fas fa-info-circle"></i> ServiceIntentDetector runs <strong>before</strong> scenario matching. If caller asks about disabled service â†’ instant decline, no hallucination.
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <!-- Wired settings -->
                        <div style="background: rgba(34, 197, 94, 0.1); border-radius: 12px; padding: 16px; border-left: 4px solid #22c55e;">
                            <div style="font-weight: 600; color: #4ade80; margin-bottom: 12px; font-size: 14px;">
                                <i class="fas fa-check-circle"></i> Scenario Fields (Active)
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 12px; color: #e2e8f0;">
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> triggers</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> negativeTriggers</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> regexTriggers</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> quickReplies</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> fullReplies</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> quickReplies_noName</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> fullReplies_noName</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> replyStrategy</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> behavior</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> bookingIntent</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> priority</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> minConfidence</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> followUpMode</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> followUpQuestionText</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> actionType</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> handoffPolicy</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> cooldownSeconds</div>
                                <div><i class="fas fa-check" style="color: #22c55e; width: 14px;"></i> entityCapture</div>
                            </div>
                        </div>
                        
                        <!-- Not wired settings -->
                        <div style="background: rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 16px; border-left: 4px solid #64748b;">
                            <div style="font-weight: 600; color: #94a3b8; margin-bottom: 12px; font-size: 14px;">
                                <i class="fas fa-clock"></i> Planned (Not Active)
                            </div>
                            <div style="font-size: 12px; color: #94a3b8;">
                                <div style="margin-bottom: 8px;"><i class="fas fa-minus" style="width: 14px;"></i> replySelection <span style="color: #64748b;">- defaults to random</span></div>
                                <div style="margin-bottom: 8px;"><i class="fas fa-minus" style="width: 14px;"></i> replyBundles <span style="color: #64748b;">- future feature</span></div>
                                <div style="margin-bottom: 8px;"><i class="fas fa-minus" style="width: 14px;"></i> replyPolicy <span style="color: #64748b;">- future feature</span></div>
                                <div><i class="fas fa-minus" style="width: 14px;"></i> entityValidation <span style="color: #64748b;">- defined but not enforced</span></div>
                            </div>
                            <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(148, 163, 184, 0.2); font-size: 11px; color: #64748b;">
                                These fields are safe to configure but won't affect agent behavior until wired.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Call flow (UPDATED) -->
                    <div style="margin-top: 16px; background: rgba(139, 92, 246, 0.1); border-radius: 12px; padding: 16px;">
                        <div style="font-weight: 600; color: #a78bfa; margin-bottom: 10px; font-size: 13px;">
                            <i class="fas fa-route"></i> Runtime Call Flow (Service-Aware)
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap; font-size: 11px;">
                            <span style="background: rgba(139, 92, 246, 0.3); color: #c4b5fd; padding: 4px 8px; border-radius: 4px;">v2AIAgentRuntime</span>
                            <i class="fas fa-arrow-right" style="color: #6366f1;"></i>
                            <span style="background: rgba(139, 92, 246, 0.3); color: #c4b5fd; padding: 4px 8px; border-radius: 4px;">AIBrain3tierllm</span>
                            <i class="fas fa-arrow-right" style="color: #6366f1;"></i>
                            <span style="background: rgba(139, 92, 246, 0.3); color: #c4b5fd; padding: 4px 8px; border-radius: 4px;">IntelligentRouter</span>
                            <i class="fas fa-arrow-right" style="color: #6366f1;"></i>
                            <span style="background: rgba(16, 185, 129, 0.4); color: #6ee7b7; padding: 4px 8px; border-radius: 4px; border: 1px solid #10b981;" title="NEW: Checks if caller intent matches disabled service">
                                <i class="fas fa-shield-alt"></i> ServiceIntentDetector
                            </span>
                            <i class="fas fa-arrow-right" style="color: #6366f1;"></i>
                            <span style="background: rgba(139, 92, 246, 0.3); color: #c4b5fd; padding: 4px 8px; border-radius: 4px;">HybridScenarioSelector</span>
                            <i class="fas fa-arrow-right" style="color: #6366f1;"></i>
                            <span style="background: rgba(139, 92, 246, 0.3); color: #c4b5fd; padding: 4px 8px; border-radius: 4px;">ResponseEngine</span>
                        </div>
                        <div style="margin-top: 10px; font-size: 11px; color: #94a3b8;">
                            <strong style="color: #6ee7b7;">ServiceIntentDetector</strong>: If disabled service detected â†’ deterministic decline (no LLM), else â†’ continue to scenario matching
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Empty state (shown before audit) -->
            <div id="audit-empty" class="audit-empty">
                <i class="fas fa-clipboard-check"></i>
                <h3>Ready to Audit</h3>
                <p>Click "Run Audit" to check all scenarios against deterministic rules (free, instant).</p>
                <p style="font-size: 13px; color: var(--text-muted); margin-top: 8px;">
                    Or use <strong>Deep Audit (AI)</strong> for GPT-4 powered comprehensive review.
                </p>
            </div>
            
            <!-- Deep Audit Results (separate view) -->
            <div id="deep-audit-results" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #8b5cf6;">
                        <i class="fas fa-brain"></i> Deep Audit Results (GPT-4)
                    </h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" onclick="copyAuditJSON()" style="padding: 8px 16px; background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; color: #22c55e;" title="Copy full audit results as JSON">
                            <i class="fas fa-copy"></i> Copy JSON
                        </button>
                        <button class="btn" onclick="downloadAuditJSON()" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; color: #3b82f6;" title="Download audit results as JSON file">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button class="btn" onclick="hideDeepAuditResults()" style="padding: 8px 16px;">
                            <i class="fas fa-arrow-left"></i> Back to Rules Audit
                        </button>
                    </div>
                </div>
                
                <!-- Deep Audit Summary -->
                <div id="deep-audit-summary" style="
                    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);
                    border: 1px solid rgba(139, 92, 246, 0.3);
                    border-radius: 12px;
                    padding: 20px;
                    margin-bottom: 20px;
                    display: grid;
                    grid-template-columns: repeat(5, 1fr);
                    gap: 16px;
                    text-align: center;
                ">
                    <div>
                        <div id="deep-avg-score" style="font-size: 32px; font-weight: bold; color: #8b5cf6;">-</div>
                        <div style="color: var(--text-muted); font-size: 12px;">Avg Score</div>
                    </div>
                    <div>
                        <div id="deep-total" style="font-size: 24px; font-weight: bold; color: white;">-</div>
                        <div style="color: var(--text-muted); font-size: 12px;">Reviewed</div>
                    </div>
                    <div>
                        <div id="deep-perfect" style="font-size: 24px; font-weight: bold; color: #10b981;">-</div>
                        <div style="color: var(--text-muted); font-size: 12px;">Perfect (9-10)</div>
                    </div>
                    <div>
                        <div id="deep-needs-work" style="font-size: 24px; font-weight: bold; color: #f59e0b;">-</div>
                        <div style="color: var(--text-muted); font-size: 12px;">Needs Work</div>
                    </div>
                    <div>
                        <div id="deep-cost" style="font-size: 18px; font-weight: bold; color: var(--text-muted);">-</div>
                        <div style="color: var(--text-muted); font-size: 12px;">API Cost</div>
                    </div>
                </div>
                
                <!-- Deep Audit Scenario List -->
                <div id="deep-audit-list" style="display: flex; flex-direction: column; gap: 12px;"></div>
            </div>
        </div><!-- END tab-audit -->
        
        <!-- TAB 3: Blueprint Builder -->
        <div class="tab-content" id="tab-blueprint">
            <div class="audit-header">
                <div>
                    <h2 style="margin-bottom: 4px;"><i class="fas fa-drafting-compass"></i> Blueprint Builder</h2>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        Generate scenarios from industry blueprints - mass-create 200+ content-only scenarios
                    </p>
                </div>
                <div class="audit-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <select id="blueprint-select" style="padding: 10px 16px; border-radius: 8px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.1); color: white; font-size: 14px;">
                        <option value="hvac">ðŸ”§ HVAC Blueprint</option>
                        <option value="plumbing" disabled>ðŸ”§ Plumbing (Coming Soon)</option>
                        <option value="electrical" disabled>âš¡ Electrical (Coming Soon)</option>
                        <option value="accounting" disabled>ðŸ“Š Accounting (Coming Soon)</option>
                    </select>
                    <button class="run-audit-btn" onclick="runBlueprintAssessment()" id="run-blueprint-btn">
                        <i class="fas fa-chart-pie"></i>
                        Assess Coverage
                    </button>
                    <div style="display: flex; gap: 4px;">
                        <!-- Spec dropdown -->
                        <div style="position: relative;" class="json-dropdown">
                            <button onclick="toggleDropdown('spec-dropdown')" style="padding: 10px 12px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer; font-size: 13px;" title="Blueprint Spec JSON">
                                <i class="fas fa-file-code"></i> Spec <i class="fas fa-caret-down" style="margin-left: 4px; font-size: 10px;"></i>
                            </button>
                            <div id="spec-dropdown" class="dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 4px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; overflow: hidden; z-index: 100; min-width: 140px;">
                                <button onclick="copyBlueprintSpec(); hideDropdowns();" style="display: block; width: 100%; padding: 10px 16px; background: transparent; border: none; color: white; cursor: pointer; text-align: left; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button onclick="downloadBlueprintSpec(); hideDropdowns();" style="display: block; width: 100%; padding: 10px 16px; background: transparent; border: none; color: white; cursor: pointer; text-align: left; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>
                        <!-- Assess dropdown -->
                        <div style="position: relative;" class="json-dropdown">
                            <button onclick="toggleDropdown('assess-dropdown')" style="padding: 10px 12px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer; font-size: 13px;" title="Assessment JSON">
                                <i class="fas fa-clipboard-list"></i> Assess <i class="fas fa-caret-down" style="margin-left: 4px; font-size: 10px;"></i>
                            </button>
                            <div id="assess-dropdown" class="dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 4px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; overflow: hidden; z-index: 100; min-width: 140px;">
                                <button onclick="copyBlueprintAssess(); hideDropdowns();" style="display: block; width: 100%; padding: 10px 16px; background: transparent; border: none; color: white; cursor: pointer; text-align: left; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button onclick="downloadBlueprintAssess(); hideDropdowns();" style="display: block; width: 100%; padding: 10px 16px; background: transparent; border: none; color: white; cursor: pointer; text-align: left; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>
                        <!-- Results dropdown -->
                        <div style="position: relative;" class="json-dropdown">
                            <button onclick="toggleDropdown('results-dropdown')" style="padding: 10px 12px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer; font-size: 13px;" title="Full Results JSON">
                                <i class="fas fa-file-export"></i> Results <i class="fas fa-caret-down" style="margin-left: 4px; font-size: 10px;"></i>
                            </button>
                            <div id="results-dropdown" class="dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 4px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; overflow: hidden; z-index: 100; min-width: 140px;">
                                <button onclick="copyResultsJson(); hideDropdowns();" style="display: block; width: 100%; padding: 10px 16px; background: transparent; border: none; color: white; cursor: pointer; text-align: left; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button onclick="downloadResultsJson(); hideDropdowns();" style="display: block; width: 100%; padding: 10px 16px; background: transparent; border: none; color: white; cursor: pointer; text-align: left; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>
                        <!-- Import button -->
                        <button onclick="openImportBlueprintModal()" style="padding: 10px 12px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 13px;" title="Import Blueprint JSON">
                            <i class="fas fa-upload"></i> Import
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Blueprint Coverage Summary -->
            <div id="blueprint-summary" style="display: none;">
                <!-- Mode Banner (populated by JS) -->
                <div id="blueprint-mode-banner" style="display: none;"></div>
                
                <!-- Coverage Stats -->
                <div class="health-score-card" style="margin-bottom: 24px;">
                    <div class="health-score" id="blueprint-coverage-score">--%</div>
                    <div class="health-label">Blueprint Coverage</div>
                    <div class="health-stats">
                        <div class="health-stat">
                            <div class="health-stat-value" id="bp-total" style="color: var(--accent-purple);">--</div>
                            <div class="health-stat-label">Total in Blueprint</div>
                        </div>
                        <div class="health-stat" title="Scenarios matched to blueprint items">
                            <div class="health-stat-value" id="bp-covered" style="color: var(--accent-green);">--</div>
                            <div class="health-stat-label">Covered</div>
                        </div>
                        <div class="health-stat" title="Blueprint items without matching scenarios">
                            <div class="health-stat-value" id="bp-missing" style="color: var(--accent-red);">--</div>
                            <div class="health-stat-label">Missing</div>
                        </div>
                        <div class="health-stat" title="Required items missing">
                            <div class="health-stat-value" id="bp-required-missing" style="color: var(--accent-yellow);">--</div>
                            <div class="health-stat-label">Required Missing</div>
                        </div>
                    </div>
                </div>
                
                <!-- Generate Missing Button -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3 style="margin: 0; font-size: 16px;"><i class="fas fa-list-check"></i> Missing Scenarios</h3>
                        <p style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">
                            Select items to generate scenario cards
                        </p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="selectAllMissing()" style="padding: 8px 16px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; cursor: pointer; font-size: 13px;">
                            <i class="fas fa-check-double"></i> Select All Required
                        </button>
                        <button onclick="generateSelectedCards()" id="generate-cards-btn" style="padding: 10px 20px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600;" disabled>
                            <i class="fas fa-magic"></i> Generate Selected (<span id="selected-count">0</span>)
                        </button>
                    </div>
                </div>
                
                <!-- Missing Items List -->
                <div id="missing-items-list" style="max-height: 500px; overflow-y: auto;">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Generated Cards Review -->
            <div id="blueprint-cards-review" style="display: none; margin-top: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 16px; background: rgba(139, 92, 246, 0.1); border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.3);">
                    <div>
                        <h3 style="margin: 0; font-size: 16px; color: #a78bfa;"><i class="fas fa-sparkles"></i> Generated Scenario Cards</h3>
                        <p style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">
                            Review and load into your template
                        </p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="clearGeneratedCards()" style="padding: 8px 16px; background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: var(--text-muted); cursor: pointer; font-size: 13px;">
                            <i class="fas fa-times"></i> Clear All
                        </button>
                    </div>
                </div>
                
                <!-- Generated Cards Grid -->
                <div id="generated-cards-grid" class="gaps-grid">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Initial State -->
            <div id="blueprint-initial" style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                <i class="fas fa-drafting-compass" style="font-size: 64px; color: #8b5cf6; margin-bottom: 24px; opacity: 0.5;"></i>
                <h3 style="font-size: 20px; margin-bottom: 12px; color: white;">Blueprint-Based Scenario Generation</h3>
                <p style="max-width: 500px; margin: 0 auto 24px; line-height: 1.6;">
                    Select a blueprint and click "Assess Coverage" to compare your template against industry-standard scenario requirements.
                </p>
                <div style="background: rgba(139, 92, 246, 0.1); padding: 16px 24px; border-radius: 12px; display: inline-block; text-align: left;">
                    <div style="font-weight: 600; color: #a78bfa; margin-bottom: 8px;">How it works:</div>
                    <ol style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 14px; line-height: 1.8;">
                        <li>Select a blueprint (HVAC, Plumbing, etc.)</li>
                        <li>Click "Assess Coverage" to see what's missing</li>
                        <li>Select missing items to generate</li>
                        <li>Review generated cards</li>
                        <li>Load into your template with one click</li>
                    </ol>
                </div>
            </div>
        </div><!-- END tab-blueprint -->
        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             TAB 4: Company Local Scenarios
             Custom scenarios specific to this company - separate from global template
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="tab-content" id="tab-company-local">
            <div class="audit-header">
                <div>
                    <h2 style="margin-bottom: 4px;"><i class="fas fa-building"></i> Company Local Scenarios</h2>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        Custom scenarios specific to this company - separate from the global template
                    </p>
                </div>
            </div>
            
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 SERVICES OFFERED - Toggle which services this company provides
                 Runtime filters scenarios + deterministic decline for disabled services
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="services-offered-card" style="
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 16px;
                padding: 24px;
                margin-bottom: 24px;
            ">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            border-radius: 10px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 18px;
                        ">ðŸ”§</div>
                        <div>
                            <h3 style="color: var(--text-primary); margin: 0; font-size: 16px;">Services Offered</h3>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 2px 0 0 0;">
                                Toggle which services this company provides
                            </p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="viewServicesConfig()" style="
                            padding: 8px 12px;
                            background: var(--bg-tertiary);
                            border: 1px solid var(--border-color);
                            border-radius: 6px;
                            color: var(--text-secondary);
                            cursor: pointer;
                            font-size: 12px;
                        " title="View config JSON for debugging">
                            <i class="fas fa-code"></i> View Config
                        </button>
                        <button onclick="saveServicesConfig()" id="save-services-btn" style="
                            padding: 8px 16px;
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            border: none;
                            border-radius: 6px;
                            color: white;
                            cursor: pointer;
                            font-size: 12px;
                            font-weight: 600;
                        ">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                </div>
                
                <!-- Services List -->
                <div id="services-list" style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-spinner fa-spin"></i> Loading services...
                    </div>
                </div>
                
                <!-- Summary -->
                <div id="services-summary" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; gap: 24px; font-size: 13px;">
                        <span style="color: var(--text-muted);">
                            <span id="services-enabled-count" style="color: #10b981; font-weight: 600;">0</span> enabled
                        </span>
                        <span style="color: var(--text-muted);">
                            <span id="services-disabled-count" style="color: #ef4444; font-weight: 600;">0</span> disabled
                        </span>
                        <span style="color: var(--text-muted);">
                            <span id="services-custom-count" style="color: #8b5cf6; font-weight: 600;">0</span> with custom responses
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Service Context Card - PROMINENT -->
            <div id="service-context-card" style="
                background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(249, 115, 22, 0.10) 100%);
                border: 2px solid rgba(245, 158, 11, 0.4);
                border-radius: 16px;
                padding: 24px;
                margin-bottom: 24px;
            ">
                <div style="display: flex; align-items: flex-start; gap: 16px;">
                    <div style="
                        width: 48px;
                        height: 48px;
                        min-width: 48px;
                        background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 22px;
                    ">ðŸŽ¯</div>
                    <div style="flex: 1;">
                        <h3 style="color: var(--text-primary); margin: 0 0 4px 0; font-size: 16px;">
                            Service Context
                            <span style="font-size: 12px; color: #f59e0b; font-weight: normal; margin-left: 8px;">
                                Required for GPT-4 generation
                            </span>
                        </h3>
                        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">
                            Describe what custom services this company offers. GPT-4 uses this context to generate accurate scenarios.
                        </p>
                        <textarea id="company-service-context" placeholder="Example: Fixture installation including chandeliers, ceiling fans, decorative lighting, and custom electrical work. Also provides smart home device installation and outdoor lighting design." style="
                            width: 100%;
                            min-height: 80px;
                            padding: 12px;
                            border: 1px solid rgba(245, 158, 11, 0.3);
                            border-radius: 8px;
                            background: rgba(0,0,0,0.2);
                            color: var(--text-primary);
                            font-size: 14px;
                            resize: vertical;
                        "></textarea>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                            <span id="context-save-status" style="font-size: 12px; color: var(--text-muted);"></span>
                            <button onclick="saveServiceContext()" style="
                                background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
                                border: none;
                                color: white;
                                padding: 8px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                font-weight: 600;
                            ">
                                <i class="fas fa-save"></i> Save Context
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Template Assignment Card -->
            <div style="
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 16px;
                padding: 24px;
                margin-bottom: 24px;
            ">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
                            border-radius: 10px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 18px;
                        ">ðŸ“‹</div>
                        <div>
                            <h3 style="color: var(--text-primary); margin: 0; font-size: 15px;">Custom Template Assignment</h3>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 2px 0 0 0;">
                                Select a template from Global Brain to store this company's local scenarios
                            </p>
                        </div>
                    </div>
                    <a href="/admin-global-instant-responses.html" target="_blank" style="
                        font-size: 12px;
                        color: var(--accent-purple);
                        text-decoration: none;
                    ">
                        <i class="fas fa-external-link-alt"></i> Open Global Brain
                    </a>
                </div>
                
                <div style="display: flex; gap: 12px; align-items: center;">
                    <select id="custom-template-select" onchange="selectCustomTemplate()" style="
                        flex: 1;
                        padding: 12px 16px;
                        border-radius: 8px;
                        background: var(--bg-tertiary);
                        border: 1px solid var(--border-color);
                        color: var(--text-primary);
                        font-size: 14px;
                        cursor: pointer;
                    ">
                        <option value="">-- Select a custom template --</option>
                    </select>
                    <button onclick="refreshCustomTemplates()" style="
                        padding: 12px;
                        background: var(--bg-tertiary);
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        color: var(--text-primary);
                        cursor: pointer;
                    " title="Refresh template list">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <!-- Template Info (shown when selected) -->
                <div id="custom-template-info" style="display: none; margin-top: 16px; padding: 16px; background: rgba(139, 92, 246, 0.1); border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);" id="custom-template-name">Template Name</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;" id="custom-template-desc">Description</div>
                        </div>
                        <div style="display: flex; gap: 20px; text-align: center;">
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: #8b5cf6;" id="custom-template-categories">0</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Categories</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: #10b981;" id="custom-template-scenarios">0</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Scenarios</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Add Scenario Section (shown when template selected) -->
            <div id="company-local-builder" style="display: none;">
                <div style="
                    background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
                    border: 1px solid rgba(16, 185, 129, 0.3);
                    border-radius: 16px;
                    padding: 24px;
                    margin-bottom: 24px;
                ">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                        <div style="
                            width: 48px;
                            height: 48px;
                            background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%);
                            border-radius: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 24px;
                        ">âž•</div>
                        <div>
                            <h3 style="color: var(--text-primary); margin: 0; font-size: 18px;">Add Local Scenario</h3>
                            <div style="font-size: 13px; color: var(--text-muted);">
                                GPT-4 generates a scenario using your Service Context
                            </div>
                        </div>
                    </div>

                    <!-- Question Input -->
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px; display: block;">
                            What did the caller ask? <span style="color: #ef4444;">*</span>
                        </label>
                        <textarea id="local-scenario-question" placeholder="Example: How much to hang a chandelier?" style="
                            width: 100%;
                            min-height: 80px;
                            padding: 12px;
                            border: 1px solid var(--border-color);
                            border-radius: 8px;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            font-size: 14px;
                            resize: vertical;
                        "></textarea>
                    </div>
                    
                    <!-- Options Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px; display: block;">Category</label>
                            <select id="local-category-select" style="
                                width: 100%;
                                padding: 10px 12px;
                                border-radius: 8px;
                                background: var(--bg-secondary);
                                border: 1px solid var(--border-color);
                                color: var(--text-primary);
                                font-size: 14px;
                            ">
                                <option value="">Auto (let AI choose)</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px; display: block;">Scenario Type</label>
                            <select id="local-type-select" style="
                                width: 100%;
                                padding: 10px 12px;
                                border-radius: 8px;
                                background: var(--bg-secondary);
                                border: 1px solid var(--border-color);
                                color: var(--text-primary);
                                font-size: 14px;
                            ">
                                <option value="">Auto (let AI choose)</option>
                                <option value="FAQ">FAQ</option>
                                <option value="Booking">Booking</option>
                                <option value="Objection">Objection</option>
                                <option value="Transfer">Transfer</option>
                                <option value="Emergency">Emergency</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Generate Button -->
                    <div style="display: flex; justify-content: flex-end; align-items: center; gap: 12px;">
                        <label style="font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="local-allow-warnings"> Allow saving with warnings
                        </label>
                        <button id="generate-local-btn" onclick="generateLocalScenario()" style="
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            border: none;
                            color: white;
                            padding: 12px 24px;
                            border-radius: 10px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        ">
                            <i class="fas fa-magic"></i> Generate with GPT-4
                        </button>
                    </div>
                </div>
                
                <!-- Generated Scenario Preview -->
                <div id="local-scenario-preview" style="display: none;"></div>
                
                <!-- Existing Local Scenarios List -->
                <div style="
                    background: var(--bg-secondary);
                    border: 1px solid var(--border-color);
                    border-radius: 16px;
                    padding: 24px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="color: var(--text-primary); margin: 0; font-size: 16px;">
                            <i class="fas fa-list"></i> Local Scenarios
                        </h3>
                        <button onclick="refreshLocalScenarios()" style="
                            padding: 8px 12px;
                            background: var(--bg-tertiary);
                            border: 1px solid var(--border-color);
                            border-radius: 6px;
                            color: var(--text-primary);
                            cursor: pointer;
                            font-size: 12px;
                        ">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div id="local-scenarios-list" style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-folder-open fa-2x" style="margin-bottom: 12px; opacity: 0.5;"></i>
                            <p>Select a custom template to view scenarios</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- No Template Selected State -->
            <div id="no-template-selected" style="
                text-align: center;
                padding: 60px 20px;
                background: var(--bg-secondary);
                border: 1px dashed var(--border-color);
                border-radius: 16px;
            ">
                <i class="fas fa-folder-plus fa-3x" style="color: var(--text-muted); margin-bottom: 16px;"></i>
                <h3 style="color: var(--text-primary); margin-bottom: 8px;">No Custom Template Selected</h3>
                <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">
                    Select an existing custom template from the dropdown above, or create a new one in Global Brain.
                </p>
                <a href="/admin-global-instant-responses.html" target="_blank" style="
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 10px;
                    text-decoration: none;
                    font-weight: 600;
                ">
                    <i class="fas fa-plus"></i> Create Template in Global Brain
                </a>
            </div>
        </div><!-- END tab-company-local -->
    </main>
    
    <!-- Create Scenario Modal - SIMPLIFIED: Preview + Open Global Brain -->
    <div class="modal-overlay" id="create-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fas fa-magic"></i> AI-Generated Scenario</h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="btn btn-ghost" onclick="copyScenarioPreview()" title="Copy scenario for discussion" style="padding: 6px 12px; font-size: 12px;">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <!-- Loading State -->
                <div id="preview-loading" class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 12px; color: var(--text-secondary);">AI is analyzing and generating scenario...</p>
                </div>
                
                <!-- Preview Content (hidden until loaded) -->
                <div id="preview-content" style="display: none;">
                    <!-- Health Count Banner - Compact -->
                    <div id="health-count-banner" style="
                        background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.1));
                        border: 1px solid rgba(34, 197, 94, 0.3);
                        border-radius: 12px;
                        padding: 12px 16px;
                        margin-bottom: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    ">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="
                                width: 40px;
                                height: 40px;
                                background: rgba(34, 197, 94, 0.2);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <i class="fas fa-check-circle" style="color: #22c55e; font-size: 18px;"></i>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 2px;">Content Settings (from Registry)</div>
                                <div style="font-size: 20px; font-weight: 700; color: #22c55e;">
                                    <span id="health-count-generated">0</span><span style="color: var(--text-muted);">/</span><span id="health-count-total">--</span>
                                </div>
                                <div id="health-missing" style="margin-top: 4px; font-size: 11px; color: var(--text-muted);"></div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-size: 11px; color: var(--text-muted);">Runtime Ready</span>
                                <span id="health-runtime-badge" style="
                                    background: rgba(34, 197, 94, 0.2);
                                    color: #22c55e;
                                    font-size: 11px;
                                    font-weight: 600;
                                    padding: 2px 8px;
                                    border-radius: 4px;
                                ">100%</span>
                            </div>
                            <div style="
                                width: 120px;
                                height: 6px;
                                background: rgba(255, 255, 255, 0.1);
                                border-radius: 3px;
                                overflow: hidden;
                            ">
                                <div id="health-progress-bar" style="
                                    height: 100%;
                                    width: 100%;
                                    background: linear-gradient(90deg, #22c55e, #10b981);
                                    border-radius: 3px;
                                    transition: width 0.3s ease;
                                "></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ðŸŽ¯ TWO-COLUMN SETTINGS TABLE -->
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; margin-bottom: 16px;">
                        <div style="background: var(--bg-tertiary); padding: 10px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between;">
                            <span style="font-size: 13px; font-weight: 600; color: var(--text-primary);">Setting</span>
                            <span style="font-size: 13px; font-weight: 600; color: var(--text-primary);">Value</span>
                        </div>
                        <div id="settings-table" style="max-height: 400px; overflow-y: auto;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Triggers Preview (expandable) -->
                    <details style="margin-bottom: 12px;">
                        <summary style="cursor: pointer; padding: 10px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--text-primary);">
                            <i class="fas fa-bolt" style="color: var(--accent-yellow); margin-right: 8px;"></i>
                            Triggers <span class="badge" id="trigger-count" style="margin-left: 8px;">0</span>
                        </summary>
                        <div style="padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px;">
                            <div class="triggers-list" id="preview-triggers"></div>
                        </div>
                    </details>
                    
                    <!-- Regex Triggers (expandable) -->
                    <details id="regex-section" style="margin-bottom: 12px; display: none;">
                        <summary style="cursor: pointer; padding: 10px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--text-primary);">
                            <i class="fas fa-code" style="color: var(--accent-orange); margin-right: 8px;"></i>
                            Regex Patterns
                        </summary>
                        <div style="padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px;">
                            <div id="preview-regex" style="font-family: 'Courier New', monospace; font-size: 12px; color: #f59e0b;"></div>
                        </div>
                    </details>
                    
                    <!-- Quick Replies (expandable) -->
                    <details style="margin-bottom: 12px;">
                        <summary style="cursor: pointer; padding: 10px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--text-primary);">
                            <i class="fas fa-comment" style="color: var(--accent-green); margin-right: 8px;"></i>
                            Quick Replies
                        </summary>
                        <div style="padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px;">
                            <div id="preview-quick-replies" style="display: flex; flex-direction: column; gap: 8px;"></div>
                        </div>
                    </details>
                    
                    <!-- Full Replies (expandable) -->
                    <details style="margin-bottom: 12px;">
                        <summary style="cursor: pointer; padding: 10px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--text-primary);">
                            <i class="fas fa-comments" style="color: var(--accent-blue); margin-right: 8px;"></i>
                            Full Replies
                        </summary>
                        <div style="padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px;">
                            <div id="preview-full-replies" style="display: flex; flex-direction: column; gap: 8px;"></div>
                        </div>
                    </details>
                    
                    <!-- Info box -->
                    <div class="info-box">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Next step:</strong> Click "Open in Global Brain" to review the full form, 
                            select the category, and save. All fields will be pre-filled!
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary btn-large" onclick="openInGlobalBrain()" id="create-btn">
                    <i class="fas fa-external-link-alt"></i> Open in Global Brain
                </button>
            </div>
        </div>
    </div>
    
    <!-- Calls Preview Modal -->
    <div class="modal-overlay" id="calls-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-phone-alt"></i> Calls with this phrase</h2>
                <button class="modal-close" onclick="closeCallsModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <div id="calls-modal-content">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCallsModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Import Blueprint Modal -->
    <div class="modal-overlay" id="import-blueprint-modal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2><i class="fas fa-upload"></i> Import Blueprint JSON</h2>
                <button class="modal-close" onclick="closeImportBlueprintModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <p style="color: var(--text-secondary); margin-bottom: 16px;">
                    Paste a BlueprintSpecV1 JSON to load it into the builder. 
                    This allows importing custom or modified blueprints.
                </p>
                <textarea id="import-blueprint-json" 
                    style="width: 100%; height: 300px; background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; padding: 12px; resize: vertical;"
                    placeholder='Paste BlueprintSpecV1 JSON here...'></textarea>
                <div id="import-blueprint-error" style="color: var(--accent-red); margin-top: 8px; font-size: 13px; display: none;"></div>
                <div id="import-blueprint-success" style="color: var(--accent-green); margin-top: 8px; font-size: 13px; display: none;"></div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button onclick="validateImportedBlueprint()" style="padding: 10px 20px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer;">
                    <i class="fas fa-check-circle"></i> Validate
                </button>
                <div style="display: flex; gap: 8px;">
                    <button onclick="closeImportBlueprintModal()" style="padding: 10px 20px; background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: var(--text-muted); cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="loadImportedBlueprint()" id="btn-load-imported" style="padding: 10px 20px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;" disabled>
                        <i class="fas fa-download"></i> Load Blueprint
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scenario Review Modal (2-column) -->
    <div class="modal-overlay" id="scenario-review-modal">
        <div class="modal" style="max-width: 1100px; width: 95%;">
            <div class="modal-header">
                <h2><i class="fas fa-clipboard-check"></i> <span id="review-scenario-name">Scenario Review</span></h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button onclick="copyAuditToClipboard(event)" style="background: #6366f1; border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 6px;" title="Copy audit data to clipboard">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="modal-close" onclick="closeScenarioReview()">&times;</button>
                </div>
            </div>
            <div class="modal-body" style="padding: 0; max-height: 70vh; overflow-y: auto;">
                <!-- Two Column Layout -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; min-height: 400px;">
                    <!-- Left Column: Current Data -->
                    <div style="padding: 20px; border-right: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);">
                        <h3 style="margin-bottom: 16px; font-size: 13px; color: #a78bfa; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700;">
                            <i class="fas fa-file-alt"></i> Current Scenario Data
                        </h3>
                        <div id="review-current-data">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Right Column: Audit Results -->
                    <div style="padding: 20px; background: rgba(239, 68, 68, 0.05);">
                        <h3 style="margin-bottom: 16px; font-size: 13px; color: #f87171; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700;">
                            <i class="fas fa-exclamation-circle"></i> Issues to Fix
                        </h3>
                        <div id="review-audit-results">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 13px; color: var(--text-muted);">
                    <span id="review-issue-count">0 issues</span> in this scenario
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="skipScenarioReview()">
                        <i class="fas fa-forward"></i> Skip
                    </button>
                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         REVIEW & FIX IN GLOBAL BRAIN (mirrors Gap Fill flow)
                         - Generates fixes via GPT-4 WITHOUT saving
                         - Opens Global Brain with prefilled fixed scenario
                         - Admin reviews and manually saves
                         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <button class="btn btn-large" onclick="reviewAndFixInGlobalBrain()" id="review-in-gb-btn"
                        style="background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); border: none;">
                        <i class="fas fa-external-link-alt"></i> Review & Fix in Global Brain
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Success!</span>
    </div>
    
    <script>
        // ========================================
        // STATE
        // ========================================
        let companyId = null;
        let currentGaps = [];
        let currentGap = null;
        let currentPreview = null;
        let selectedDays = 14;
        let lastAuditResult = null;
        let currentReviewScenarioIdx = null;
        
        // Blueprint Builder State
        let blueprintAssessment = null;
        let selectedBlueprintItems = new Set();
        let generatedBlueprintCards = [];
        
        // Blueprint JSON for copy/export (populated after fetch)
        window.__lastBlueprintSpec = null;
        window.__lastBlueprintAssess = null;
        window.__lastGeneratorConfig = null;
        window.__lastGeneratedCards = null;
        window.__lastValidationReport = null;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // REGISTRY (Single Source of Truth)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // This is loaded from the backend - NO HARDCODED VALUES ALLOWED
        // All counts, field lists, and ownership derive from this
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let REGISTRY = null;
        
        async function loadRegistry() {
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/registry`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 401) {
                    console.error('âŒ [REGISTRY] Authentication required');
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    REGISTRY = data;
                    console.log('âœ… [REGISTRY] Loaded ownership model:', {
                        content: REGISTRY.ownership.content.count,
                        runtime: REGISTRY.ownership.runtime.count,
                        admin: REGISTRY.ownership.admin.count
                    });
                    updateUIFromRegistry();
                } else {
                    console.error('âŒ [REGISTRY] Failed to load:', data.error);
                }
            } catch (err) {
                console.error('âŒ [REGISTRY] Network error:', err);
            }
        }
        
        function updateUIFromRegistry() {
            if (!REGISTRY) return;
            
            // Update all counts from the registry (no hardcoded values)
            const contentCount = REGISTRY.ownership.content.count;
            const runtimeCount = REGISTRY.ownership.runtime.count;
            const adminCount = REGISTRY.ownership.admin.count;
            
            // Update the AI Settings Panel count
            const contentFieldCount = document.getElementById('content-field-count');
            if (contentFieldCount) {
                contentFieldCount.textContent = contentCount;
            }
            
            // Update the health count total
            const healthTotal = document.getElementById('health-count-total');
            if (healthTotal) {
                healthTotal.textContent = contentCount;
            }
            
            // Update AI Model badge to show ownership breakdown
            const modelBadge = document.getElementById('ai-model-badge');
            if (modelBadge) {
                modelBadge.title = `Content: ${contentCount} | Runtime: ${runtimeCount} | Admin: ${adminCount}`;
            }
            
            console.log('âœ… [REGISTRY] UI updated:', { content: contentCount, runtime: runtimeCount, admin: adminCount });
        }
        
        // Helper to check if a field is content-owned (for validation)
        function isContentField(fieldName) {
            if (!REGISTRY) return true; // Default to allowing if registry not loaded
            return REGISTRY.contentFields.includes(fieldName);
        }
        
        // Helper to check if a field is runtime-owned
        function isRuntimeField(fieldName) {
            if (!REGISTRY) return false;
            return REGISTRY.runtimeFields.includes(fieldName);
        }
        
        // Helper to check if a field is admin-owned
        function isAdminField(fieldName) {
            if (!REGISTRY) return false;
            return REGISTRY.adminFields.includes(fieldName);
        }
        
        // ========================================
        // TAB SWITCHING
        // ========================================
        function toggleChecklist() {
            const checklist = document.getElementById('audit-checklist');
            const icon = document.getElementById('checklist-toggle-icon');
            if (checklist.style.display === 'none') {
                checklist.style.display = 'grid';
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            } else {
                checklist.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        }
        
        function toggleWiringStatus() {
            const details = document.getElementById('wiring-status-details');
            const icon = document.getElementById('wiring-toggle-icon');
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-up');
            } else {
                details.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }
        
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.sub-tab').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Load alignment data when switching to audit tab
            if (tabName === 'audit') {
                loadSettingsRegistry();
                loadScenarioPoolAlignment();
            }
            
            // Load company local data when switching to that tab
            if (tabName === 'company-local') {
                loadCompanyLocalData();
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // COMPANY LOCAL SCENARIOS TAB
        // Custom scenarios specific to this company - stored in a separate template
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let companyLocalState = {
            customTemplateId: null,
            customTemplate: null,
            serviceContext: '',
            availableTemplates: [],
            servicesConfig: null,      // Full services config from API
            serviceChanges: {},        // Pending changes to save
            initialized: false
        };
        
        async function loadCompanyLocalData() {
            if (companyLocalState.initialized) return;
            
            console.log('[COMPANY LOCAL] Loading data for company:', companyId);
            
            try {
                // Load available templates, company settings, and services in parallel
                await Promise.all([
                    refreshCustomTemplates(),
                    loadServiceContext(),
                    loadServicesConfig()
                ]);
                
                companyLocalState.initialized = true;
            } catch (error) {
                console.error('[COMPANY LOCAL] Error loading data:', error);
                showToast('Failed to load company local data', 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SERVICES OFFERED - Toggle which services this company provides
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function loadServicesConfig() {
            const listEl = document.getElementById('services-list');
            
            try {
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/services-config`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load services config');
                }
                
                const config = await response.json();
                companyLocalState.servicesConfig = config;
                companyLocalState.serviceChanges = {}; // Reset pending changes
                
                renderServicesUI(config);
                
            } catch (error) {
                console.error('[SERVICES] Error loading config:', error);
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                        <p style="margin-top: 8px;">Failed to load services. Make sure a template is assigned.</p>
                    </div>
                `;
            }
        }
        
        function renderServicesUI(config) {
            const listEl = document.getElementById('services-list');
            const summaryEl = document.getElementById('services-summary');
            
            if (!config.toggleableCategories || config.toggleableCategories.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-info-circle"></i>
                        <p style="margin-top: 8px;">No toggleable services found in the assigned template.</p>
                        <p style="font-size: 12px;">Template categories need serviceKey and isToggleable: true to appear here.</p>
                    </div>
                `;
                summaryEl.style.display = 'none';
                return;
            }
            
            // Render service toggles
            listEl.innerHTML = config.toggleableCategories.map(cat => {
                const service = config.services[cat.serviceKey] || {};
                const isEnabled = service.enabled !== false;
                const hasOverrides = service.hasOverrides;
                
                return `
                    <div class="service-item" data-service-key="${cat.serviceKey}" style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 12px 16px;
                        background: ${isEnabled ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'};
                        border: 1px solid ${isEnabled ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};
                        border-radius: 10px;
                        transition: all 0.2s;
                    ">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label class="toggle-switch" style="position: relative; display: inline-block; width: 44px; height: 24px;">
                                <input type="checkbox" 
                                    ${isEnabled ? 'checked' : ''} 
                                    onchange="toggleService('${cat.serviceKey}', this.checked)"
                                    style="opacity: 0; width: 0; height: 0;">
                                <span style="
                                    position: absolute;
                                    cursor: pointer;
                                    top: 0; left: 0; right: 0; bottom: 0;
                                    background-color: ${isEnabled ? '#10b981' : '#6b7280'};
                                    transition: 0.3s;
                                    border-radius: 24px;
                                "></span>
                                <span style="
                                    position: absolute;
                                    content: '';
                                    height: 18px;
                                    width: 18px;
                                    left: ${isEnabled ? '23px' : '3px'};
                                    bottom: 3px;
                                    background-color: white;
                                    transition: 0.3s;
                                    border-radius: 50%;
                                "></span>
                            </label>
                            <div>
                                <div style="font-size: 14px; font-weight: 500; color: var(--text-primary);">
                                    ${cat.categoryIcon} ${escapeHtml(cat.categoryName)}
                                    ${hasOverrides ? '<span style="color: #8b5cf6; font-size: 11px; margin-left: 6px;">âœŽ custom</span>' : ''}
                                </div>
                                <div style="font-size: 11px; color: var(--text-muted);">
                                    ${cat.intent.keywords.slice(0, 3).join(', ')}${cat.intent.keywords.length > 3 ? '...' : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="
                                font-size: 11px;
                                padding: 2px 8px;
                                border-radius: 4px;
                                background: ${isEnabled ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
                                color: ${isEnabled ? '#10b981' : '#ef4444'};
                            ">${isEnabled ? 'ON' : 'OFF'}</span>
                            <button onclick="editServiceDecline('${cat.serviceKey}')" style="
                                padding: 4px 8px;
                                background: transparent;
                                border: 1px solid var(--border-color);
                                border-radius: 4px;
                                color: var(--text-muted);
                                cursor: pointer;
                                font-size: 11px;
                            " title="Edit decline message">
                                <i class="fas fa-comment-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update summary
            summaryEl.style.display = 'block';
            document.getElementById('services-enabled-count').textContent = config.enabledServiceKeys.length;
            document.getElementById('services-disabled-count').textContent = config.disabledServiceKeys.length;
            document.getElementById('services-custom-count').textContent = config.summary?.withOverrides || 0;
            
            // Also update the Wiring Status panel (Template Audit tab)
            updateWiringServiceCounts(config.enabledServiceKeys.length);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UPDATE WIRING STATUS PANEL
        // Called when services config loads or when company local template changes
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function updateWiringServiceCounts(enabledServices) {
            const servicesEl = document.getElementById('wiring-services-count');
            if (servicesEl) {
                servicesEl.textContent = enabledServices ?? '--';
            }
        }
        
        function updateWiringLocalCount(localCount) {
            const localEl = document.getElementById('wiring-local-count');
            if (localEl) {
                localEl.textContent = localCount ?? '--';
            }
        }
        
        function toggleService(serviceKey, enabled) {
            // Track change
            if (!companyLocalState.serviceChanges[serviceKey]) {
                companyLocalState.serviceChanges[serviceKey] = {};
            }
            companyLocalState.serviceChanges[serviceKey].enabled = enabled;
            
            // Update UI immediately
            const item = document.querySelector(`[data-service-key="${serviceKey}"]`);
            if (item) {
                item.style.background = enabled ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                item.style.borderColor = enabled ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)';
                
                const statusBadge = item.querySelector('span[style*="border-radius: 4px"]');
                if (statusBadge) {
                    statusBadge.textContent = enabled ? 'ON' : 'OFF';
                    statusBadge.style.background = enabled ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                    statusBadge.style.color = enabled ? '#10b981' : '#ef4444';
                }
                
                // Update toggle visual
                const toggleSpan = item.querySelector('.toggle-switch span:first-of-type');
                const toggleKnob = item.querySelector('.toggle-switch span:last-of-type');
                if (toggleSpan) toggleSpan.style.backgroundColor = enabled ? '#10b981' : '#6b7280';
                if (toggleKnob) toggleKnob.style.left = enabled ? '23px' : '3px';
            }
            
            // Update summary counts
            const config = companyLocalState.servicesConfig;
            let enabledCount = 0;
            let disabledCount = 0;
            
            for (const cat of config.toggleableCategories) {
                const change = companyLocalState.serviceChanges[cat.serviceKey];
                const original = config.services[cat.serviceKey];
                const isEnabled = change?.enabled !== undefined ? change.enabled : original?.enabled !== false;
                if (isEnabled) enabledCount++;
                else disabledCount++;
            }
            
            document.getElementById('services-enabled-count').textContent = enabledCount;
            document.getElementById('services-disabled-count').textContent = disabledCount;
            
            console.log('[SERVICES] Toggle:', serviceKey, enabled);
        }
        
        function editServiceDecline(serviceKey) {
            const config = companyLocalState.servicesConfig;
            const service = config.services[serviceKey] || {};
            const category = config.toggleableCategories.find(c => c.serviceKey === serviceKey);
            
            const currentMessage = companyLocalState.serviceChanges[serviceKey]?.overrideDeclineMessage 
                || service.declineMessage 
                || '';
            
            const newMessage = prompt(
                `Decline message for "${category?.categoryName || serviceKey}":\n\n(Leave empty to use template default)`,
                currentMessage
            );
            
            if (newMessage !== null) {
                if (!companyLocalState.serviceChanges[serviceKey]) {
                    companyLocalState.serviceChanges[serviceKey] = {};
                }
                companyLocalState.serviceChanges[serviceKey].overrideDeclineMessage = newMessage || null;
                
                // Update UI to show custom badge if needed
                const item = document.querySelector(`[data-service-key="${serviceKey}"]`);
                if (item && newMessage) {
                    const nameDiv = item.querySelector('div[style*="font-weight: 500"]');
                    if (nameDiv && !nameDiv.innerHTML.includes('custom')) {
                        nameDiv.innerHTML += '<span style="color: #8b5cf6; font-size: 11px; margin-left: 6px;">âœŽ custom</span>';
                    }
                }
                
                showToast('Decline message updated. Click Save to apply.', 'info');
            }
        }
        
        async function saveServicesConfig() {
            if (Object.keys(companyLocalState.serviceChanges).length === 0) {
                showToast('No changes to save', 'info');
                return;
            }
            
            const btn = document.getElementById('save-services-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                // Merge changes with existing config
                const currentServices = companyLocalState.servicesConfig?.services || {};
                const updatedServices = {};
                
                // Copy existing services
                for (const [key, value] of Object.entries(currentServices)) {
                    updatedServices[key] = {
                        enabled: value.enabled,
                        overrideKeywords: value.overrideKeywords || [],
                        overrideDeclineMessage: value.declineMessage
                    };
                }
                
                // Apply changes
                for (const [key, changes] of Object.entries(companyLocalState.serviceChanges)) {
                    if (!updatedServices[key]) {
                        updatedServices[key] = { enabled: true };
                    }
                    if (changes.enabled !== undefined) {
                        updatedServices[key].enabled = changes.enabled;
                    }
                    if (changes.overrideDeclineMessage !== undefined) {
                        updatedServices[key].overrideDeclineMessage = changes.overrideDeclineMessage;
                    }
                }
                
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/services-config`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ services: updatedServices })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save services config');
                }
                
                companyLocalState.serviceChanges = {};
                showToast('Services configuration saved!', 'success');
                
                // Reload to get fresh data
                await loadServicesConfig();
                
            } catch (error) {
                console.error('[SERVICES] Save error:', error);
                showToast('Failed to save services: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Save';
            }
        }
        
        function viewServicesConfig() {
            const config = companyLocalState.servicesConfig;
            if (!config) {
                showToast('No services config loaded', 'warning');
                return;
            }
            
            // Build debug view
            const debugData = {
                company: config.company,
                template: config.template,
                services: config.services,
                summary: config.summary,
                pendingChanges: companyLocalState.serviceChanges
            };
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'services-config-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            modal.innerHTML = `
                <div style="
                    background: var(--bg-secondary);
                    border-radius: 16px;
                    padding: 24px;
                    max-width: 700px;
                    max-height: 80vh;
                    overflow: auto;
                    width: 90%;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="color: var(--text-primary); margin: 0;">
                            <i class="fas fa-code"></i> Services Config (Debug)
                        </h3>
                        <button onclick="document.getElementById('services-config-modal').remove()" style="
                            background: none;
                            border: none;
                            color: var(--text-muted);
                            cursor: pointer;
                            font-size: 20px;
                        ">&times;</button>
                    </div>
                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
                        Copy this JSON when reporting issues. It contains all service toggle configuration.
                    </p>
                    <pre style="
                        background: var(--bg-tertiary);
                        padding: 16px;
                        border-radius: 8px;
                        overflow: auto;
                        font-size: 12px;
                        color: #10b981;
                        max-height: 400px;
                    ">${JSON.stringify(debugData, null, 2)}</pre>
                    <button onclick="navigator.clipboard.writeText(JSON.stringify(${JSON.stringify(debugData).replace(/"/g, '&quot;')}, null, 2)); showToast('Copied to clipboard', 'success');" style="
                        margin-top: 16px;
                        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
                        border: none;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                    ">
                        <i class="fas fa-copy"></i> Copy to Clipboard
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        async function refreshCustomTemplates() {
            const select = document.getElementById('custom-template-select');
            select.innerHTML = '<option value="">Loading templates...</option>';
            
            try {
                // Fetch all templates from Global Brain API
                const response = await fetch('/api/admin/global-instant-responses', {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load templates');
                
                const result = await response.json();
                const templates = result.data || [];
                companyLocalState.availableTemplates = templates;
                
                // Build dropdown - show all templates except the primary one
                select.innerHTML = '<option value="">-- Select a custom template --</option>';
                
                // Get company's primary template ID to exclude it
                const primaryTemplateId = manualBuilderTemplateData?._id?.toString() || manualBuilderTemplateData?.templateId;
                
                templates.forEach(template => {
                    const templateId = template._id?.toString() || template.id;
                    
                    // Skip the primary template
                    if (templateId === primaryTemplateId) return;
                    
                    // Skip templates linked to OTHER companies (they're exclusive)
                    if (template.linkedCompanyId && template.linkedCompanyId !== companyId) {
                        return; // This template belongs to another company
                    }
                    
                    const option = document.createElement('option');
                    option.value = templateId;
                    
                    // Show if it's already linked to THIS company
                    const isLinkedToUs = template.linkedCompanyId === companyId;
                    const badge = isLinkedToUs ? ' â˜… (yours)' : '';
                    
                    const categoryCount = template.categories?.length || 0;
                    const scenarioCount = template.categories?.reduce((sum, c) => sum + (c.scenarios?.length || 0), 0) || 0;
                    
                    option.textContent = `${template.name}${badge} (${categoryCount} categories, ${scenarioCount} scenarios)`;
                    select.appendChild(option);
                });
                
                // Check if company already has a custom template assigned
                await loadCompanyCustomTemplateAssignment();
                
            } catch (error) {
                console.error('[COMPANY LOCAL] Error loading templates:', error);
                select.innerHTML = '<option value="">Error loading templates</option>';
            }
        }
        
        async function loadCompanyCustomTemplateAssignment() {
            try {
                // Fetch company to get customTemplateId
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/local-config`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load company');
                
                const company = await response.json();
                
                if (company.customTemplateId) {
                    companyLocalState.customTemplateId = company.customTemplateId;
                    document.getElementById('custom-template-select').value = company.customTemplateId;
                    await selectCustomTemplate();
                }
            } catch (error) {
                console.error('[COMPANY LOCAL] Error loading company:', error);
            }
        }
        
        async function loadServiceContext() {
            try {
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/local-config`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load company');
                
                const company = await response.json();
                
                if (company.localServiceContext) {
                    companyLocalState.serviceContext = company.localServiceContext;
                    document.getElementById('company-service-context').value = company.localServiceContext;
                }
            } catch (error) {
                console.error('[COMPANY LOCAL] Error loading service context:', error);
            }
        }
        
        async function saveServiceContext() {
            const context = document.getElementById('company-service-context').value.trim();
            const statusEl = document.getElementById('context-save-status');
            
            if (!context) {
                showToast('Please enter a service context', 'warning');
                return;
            }
            
            statusEl.textContent = 'Saving...';
            statusEl.style.color = '#f59e0b';
            
            try {
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/local-config`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ localServiceContext: context })
                });
                
                if (!response.ok) throw new Error('Failed to save');
                
                companyLocalState.serviceContext = context;
                statusEl.textContent = 'âœ“ Saved';
                statusEl.style.color = '#10b981';
                showToast('Service context saved', 'success');
                
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
                
            } catch (error) {
                console.error('[COMPANY LOCAL] Error saving context:', error);
                statusEl.textContent = 'Error saving';
                statusEl.style.color = '#ef4444';
                showToast('Failed to save service context', 'error');
            }
        }
        
        async function selectCustomTemplate() {
            const templateId = document.getElementById('custom-template-select').value;
            const infoEl = document.getElementById('custom-template-info');
            const builderEl = document.getElementById('company-local-builder');
            const noTemplateEl = document.getElementById('no-template-selected');
            
            if (!templateId) {
                // No template selected
                infoEl.style.display = 'none';
                builderEl.style.display = 'none';
                noTemplateEl.style.display = 'block';
                companyLocalState.customTemplateId = null;
                companyLocalState.customTemplate = null;
                document.getElementById('company-local-badge').textContent = '0';
                return;
            }
            
            try {
                // Find template in our loaded list
                let template = companyLocalState.availableTemplates.find(t => 
                    (t._id?.toString() || t.id) === templateId
                );
                
                // If not found, fetch it
                if (!template) {
                    const response = await fetch(`/api/admin/global-instant-responses/${templateId}`, {
                        headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                    });
                    if (!response.ok) throw new Error('Failed to load template');
                    const result = await response.json();
                    template = result.data || result;
                }
                
                companyLocalState.customTemplateId = templateId;
                companyLocalState.customTemplate = template;
                
                // Update UI
                const categoryCount = template.categories?.length || 0;
                const scenarioCount = template.categories?.reduce((sum, c) => sum + (c.scenarios?.length || 0), 0) || 0;
                
                document.getElementById('custom-template-name').textContent = template.name;
                document.getElementById('custom-template-desc').textContent = template.description || 'No description';
                document.getElementById('custom-template-categories').textContent = categoryCount;
                document.getElementById('custom-template-scenarios').textContent = scenarioCount;
                document.getElementById('company-local-badge').textContent = scenarioCount;
                
                infoEl.style.display = 'block';
                builderEl.style.display = 'block';
                noTemplateEl.style.display = 'none';
                
                // Populate category dropdown
                populateLocalCategoryDropdown(template);
                
                // Load scenarios list
                refreshLocalScenarios();
                
                // Save assignment to company
                await saveCustomTemplateAssignment(templateId);
                
            } catch (error) {
                console.error('[COMPANY LOCAL] Error selecting template:', error);
                showToast('Failed to load template', 'error');
            }
        }
        
        async function saveCustomTemplateAssignment(templateId) {
            try {
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/local-config`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ customTemplateId: templateId || null })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    
                    // Handle "already linked to another company" error
                    if (error.linkedCompanyId) {
                        showToast(error.error, 'error');
                        // Reset dropdown
                        document.getElementById('custom-template-select').value = '';
                        document.getElementById('custom-template-info').style.display = 'none';
                        document.getElementById('company-local-builder').style.display = 'none';
                        document.getElementById('no-template-selected').style.display = 'block';
                        return;
                    }
                    
                    throw new Error(error.error || 'Failed to save assignment');
                }
                
                showToast('Template assigned successfully', 'success');
            } catch (error) {
                console.error('[COMPANY LOCAL] Error saving template assignment:', error);
                showToast(error.message || 'Failed to save template assignment', 'error');
            }
        }
        
        function populateLocalCategoryDropdown(template) {
            const select = document.getElementById('local-category-select');
            select.innerHTML = '<option value="">Auto (let AI choose)</option>';
            
            (template.categories || []).forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id || cat._id;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }
        
        async function refreshLocalScenarios() {
            const listEl = document.getElementById('local-scenarios-list');
            const template = companyLocalState.customTemplate;
            
            if (!template) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-folder-open fa-2x" style="margin-bottom: 12px; opacity: 0.5;"></i>
                        <p>Select a custom template to view scenarios</p>
                    </div>
                `;
                return;
            }
            
            // Flatten scenarios from all categories
            const scenarios = [];
            (template.categories || []).forEach(cat => {
                (cat.scenarios || []).forEach(s => {
                    scenarios.push({
                        ...s,
                        categoryName: cat.name,
                        categoryId: cat.id || cat._id
                    });
                });
            });
            
            // Update Wiring Status panel count
            updateWiringLocalCount(scenarios.length);
            
            if (scenarios.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-inbox fa-2x" style="margin-bottom: 12px; opacity: 0.5;"></i>
                        <p>No scenarios yet. Generate one using GPT-4 above!</p>
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = scenarios.map(s => `
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 12px 16px;
                    background: var(--bg-tertiary);
                    border-radius: 8px;
                    border-left: 3px solid ${s.scenarioType === 'Emergency' ? '#ef4444' : s.scenarioType === 'Booking' ? '#10b981' : '#8b5cf6'};
                ">
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 500; color: var(--text-primary);">${escapeHtml(s.name)}</div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">
                            <span style="color: #8b5cf6;">${escapeHtml(s.categoryName)}</span>
                            <span style="margin: 0 8px;">â€¢</span>
                            <span>${s.scenarioType || 'FAQ'}</span>
                            <span style="margin: 0 8px;">â€¢</span>
                            <span>${(s.triggers || []).length} triggers</span>
                        </div>
                    </div>
                    <a href="/admin-global-instant-responses.html?editScenario=${s.scenarioId || s._id}&categoryId=${s.categoryId}&templateId=${companyLocalState.customTemplateId}" 
                       target="_blank"
                       style="
                           padding: 6px 12px;
                           background: var(--bg-secondary);
                           border: 1px solid var(--border-color);
                           border-radius: 6px;
                           color: var(--text-primary);
                           font-size: 12px;
                           text-decoration: none;
                       ">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                </div>
            `).join('');
        }
        
        async function generateLocalScenario() {
            const question = document.getElementById('local-scenario-question').value.trim();
            const serviceContext = document.getElementById('company-service-context').value.trim();
            const categoryId = document.getElementById('local-category-select').value;
            const scenarioType = document.getElementById('local-type-select').value;
            const allowWarnings = document.getElementById('local-allow-warnings').checked;
            
            if (!question) {
                showToast('Please enter a caller question', 'warning');
                return;
            }
            
            if (!serviceContext) {
                showToast('Please enter a Service Context above so GPT-4 knows what services this company offers', 'warning');
                document.getElementById('company-service-context').focus();
                return;
            }
            
            if (!companyLocalState.customTemplateId) {
                showToast('Please select a custom template first', 'warning');
                return;
            }
            
            const btn = document.getElementById('generate-local-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            
            try {
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/generate-local`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question,
                        serviceContext,
                        templateId: companyLocalState.customTemplateId,
                        categoryId: categoryId || null,
                        scenarioType: scenarioType || null,
                        allowWarnings
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Generation failed');
                }
                
                const result = await response.json();
                displayLocalScenarioPreview(result);
                
            } catch (error) {
                console.error('[COMPANY LOCAL] Generation error:', error);
                showToast('Failed to generate scenario: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Generate with GPT-4';
            }
        }
        
        function displayLocalScenarioPreview(result) {
            const previewEl = document.getElementById('local-scenario-preview');
            const scenario = result.scenario;
            const validation = result.validation;
            
            previewEl.style.display = 'block';
            previewEl.innerHTML = `
                <div style="
                    background: var(--bg-secondary);
                    border: 1px solid var(--border-color);
                    border-radius: 16px;
                    padding: 24px;
                    margin-bottom: 24px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="color: var(--text-primary); margin: 0;">
                            <i class="fas fa-check-circle" style="color: #10b981;"></i> Generated Scenario Preview
                        </h3>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="saveLocalScenario()" style="
                                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                border: none;
                                color: white;
                                padding: 10px 20px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                            ">
                                <i class="fas fa-save"></i> Save to Template
                            </button>
                            <button onclick="document.getElementById('local-scenario-preview').style.display='none'" style="
                                background: var(--bg-tertiary);
                                border: 1px solid var(--border-color);
                                color: var(--text-primary);
                                padding: 10px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                            ">
                                <i class="fas fa-times"></i> Discard
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <!-- Left Column: Content -->
                        <div>
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Name</div>
                                <div style="font-size: 15px; font-weight: 600; color: var(--text-primary);">${escapeHtml(scenario.name)}</div>
                            </div>
                            
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
                                <span style="background: #f59e0b; color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px;">
                                    ðŸ“ ${escapeHtml(result.categoryName || 'Auto-created')}
                                </span>
                                <span style="background: #8b5cf6; color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px;">
                                    ${scenario.scenarioType || 'FAQ'}
                                </span>
                                <span style="background: var(--bg-tertiary); color: var(--text-secondary); padding: 4px 10px; border-radius: 6px; font-size: 12px;">
                                    ${scenario.priority || 'normal'} priority
                                </span>
                                ${result.categoryCreated ? `<span style="background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 4px 10px; border-radius: 6px; font-size: 12px;">âœ¨ New category</span>` : ''}
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Triggers (${(scenario.triggers || []).length})</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                    ${(scenario.triggers || []).slice(0, 8).map(t => `
                                        <span style="background: var(--bg-tertiary); padding: 4px 8px; border-radius: 4px; font-size: 12px; color: var(--text-secondary);">${escapeHtml(t)}</span>
                                    `).join('')}
                                    ${(scenario.triggers || []).length > 8 ? `<span style="color: var(--text-muted); font-size: 12px;">+${scenario.triggers.length - 8} more</span>` : ''}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Quick Replies</div>
                                ${(scenario.quickReplies || []).map(r => `
                                    <div style="background: var(--bg-tertiary); padding: 8px 12px; border-radius: 6px; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary);">${escapeHtml(r)}</div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Right Column: Settings Summary -->
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px; font-weight: 600;">22 SETTINGS GENERATED</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                                <div style="color: var(--text-secondary);">Type:</div>
                                <div style="color: var(--text-primary);">${scenario.scenarioType || 'FAQ'}</div>
                                
                                <div style="color: var(--text-secondary);">Priority:</div>
                                <div style="color: var(--text-primary);">${scenario.priority || 'normal'}</div>
                                
                                <div style="color: var(--text-secondary);">Booking:</div>
                                <div style="color: var(--text-primary);">${scenario.requiresBooking ? 'Yes' : 'No'}</div>
                                
                                <div style="color: var(--text-secondary);">Confidence:</div>
                                <div style="color: var(--text-primary);">${scenario.confidenceThreshold || 0.75}</div>
                                
                                <div style="color: var(--text-secondary);">Confirm:</div>
                                <div style="color: var(--text-primary);">${scenario.confirmBeforeAction ? 'Yes' : 'No'}</div>
                                
                                <div style="color: var(--text-secondary);">Multi-intent:</div>
                                <div style="color: var(--text-primary);">${scenario.allowMultiIntent ? 'Yes' : 'No'}</div>
                            </div>
                        </div>
                    </div>
                    
                    ${validation && validation.errors?.length > 0 ? `
                        <div style="margin-top: 16px; padding: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px;">
                            <div style="font-size: 12px; color: #ef4444; font-weight: 600; margin-bottom: 8px;">
                                <i class="fas fa-exclamation-triangle"></i> Validation Warnings
                            </div>
                            ${validation.errors.map(e => `<div style="font-size: 12px; color: #fca5a5;">â€¢ ${escapeHtml(e)}</div>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Store for save
            previewEl.dataset.scenario = JSON.stringify(scenario);
            previewEl.dataset.categoryId = result.categoryId || '';
        }
        
        async function saveLocalScenario() {
            const previewEl = document.getElementById('local-scenario-preview');
            const scenario = JSON.parse(previewEl.dataset.scenario);
            const categoryId = previewEl.dataset.categoryId;
            
            if (!companyLocalState.customTemplateId) {
                showToast('No template selected', 'error');
                return;
            }
            
            try {
                // Save to the custom template via Global Brain API
                const response = await fetch(`/api/admin/global-instant-responses/${companyLocalState.customTemplateId}/categories/${categoryId}/scenarios`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scenario)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save scenario');
                }
                
                showToast('Scenario saved to custom template!', 'success');
                
                // Clear form and preview
                document.getElementById('local-scenario-question').value = '';
                previewEl.style.display = 'none';
                
                // Refresh template to get updated data
                await refreshCustomTemplates();
                await selectCustomTemplate();
                
            } catch (error) {
                console.error('[COMPANY LOCAL] Error saving scenario:', error);
                showToast('Failed to save: ' + error.message, 'error');
            }
        }
        
        // ========================================
        // SETTINGS REGISTRY FUNCTIONS
        // ========================================
        // ========================================
        // SCENARIO POOL ALIGNMENT - Single Source of Truth
        // ========================================
        async function loadScenarioPoolAlignment() {
            try {
                const response = await fetch(`/api/admin/wiring-status/${companyId}/scenario-alignment`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load scenario alignment');
                
                const data = await response.json();
                
                if (!data.success) {
                    console.error('Scenario alignment error:', data.error);
                    return;
                }
                
                const alignment = data.alignment;
                
                // Update main counts
                document.getElementById('align-total').textContent = alignment.totalInTemplates;
                document.getElementById('align-active').textContent = alignment.activeInTemplates;
                document.getElementById('align-disabled').textContent = alignment.disabledByCompany;
                document.getElementById('align-agent').textContent = alignment.agentCanSee;
                
                // Update system harmony counts (all three should match)
                document.getElementById('align-gapfill-count').textContent = `${alignment.gapFillScope} scenarios`;
                document.getElementById('align-audit-count').textContent = `${alignment.auditScope} scenarios`;
                document.getElementById('align-runtime-count').textContent = `${alignment.agentCanSee} scenarios`;
                
                // Update harmony icons based on alignment
                const isAligned = alignment.isAligned;
                const gapFillIcon = document.getElementById('align-gapfill-icon');
                const auditIcon = document.getElementById('align-audit-icon');
                const runtimeIcon = document.getElementById('align-runtime-icon');
                
                if (isAligned) {
                    gapFillIcon.textContent = 'âœ…';
                    auditIcon.textContent = 'âœ…';
                    runtimeIcon.textContent = 'âœ…';
                } else {
                    // Check if gap fill and audit match agent
                    gapFillIcon.textContent = alignment.gapFillScope === alignment.agentCanSee ? 'âœ…' : 'âš ï¸';
                    auditIcon.textContent = alignment.auditScope === alignment.agentCanSee ? 'âœ…' : 'âš ï¸';
                    runtimeIcon.textContent = 'âœ…'; // Agent is always the baseline
                }
                
                // Show alignment status
                const statusDiv = document.getElementById('scenario-alignment-status');
                statusDiv.style.display = 'block';
                
                if (alignment.summary.status === 'GREEN') {
                    statusDiv.style.background = 'rgba(16,185,129,0.15)';
                    statusDiv.style.border = '1px solid var(--accent-green)';
                    statusDiv.style.borderRadius = '8px';
                    statusDiv.style.padding = '12px';
                    statusDiv.innerHTML = `
                        <div style="color: var(--accent-green);">
                            <strong>âœ… ${alignment.summary.label}</strong>
                            <div style="margin-top: 4px; font-size: 12px; color: #6ee7b7;">
                                ${alignment.summary.message}
                            </div>
                        </div>
                    `;
                } else if (alignment.summary.status === 'YELLOW') {
                    statusDiv.style.background = 'rgba(251,191,36,0.15)';
                    statusDiv.style.border = '1px solid var(--accent-yellow)';
                    statusDiv.style.borderRadius = '8px';
                    statusDiv.style.padding = '12px';
                    statusDiv.innerHTML = `
                        <div style="color: var(--accent-yellow);">
                            <strong>âš ï¸ ${alignment.summary.label}</strong>
                            <div style="margin-top: 4px; font-size: 12px; color: #fcd34d;">
                                ${alignment.summary.message}
                            </div>
                            <div style="margin-top: 8px; font-size: 11px; color: var(--text-muted);">
                                ðŸ’¡ <strong>Recommendation:</strong> Gap Fill and Audit should use ScenarioPoolService to match the agent's view.
                            </div>
                        </div>
                    `;
                } else {
                    statusDiv.style.background = 'rgba(239,68,68,0.15)';
                    statusDiv.style.border = '1px solid var(--accent-red)';
                    statusDiv.style.borderRadius = '8px';
                    statusDiv.style.padding = '12px';
                    statusDiv.innerHTML = `
                        <div style="color: var(--accent-red);">
                            <strong>âŒ ${alignment.summary.label}</strong>
                            <div style="margin-top: 4px; font-size: 12px; color: #fca5a5;">
                                ${alignment.summary.message}
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading scenario pool alignment:', error);
            }
        }
        
        async function loadSettingsRegistry() {
            try {
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/audit/settings-registry`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load registry');
                
                const data = await response.json();
                
                // ========================================
                // ðŸŽ¯ SINGLE SOURCE OF TRUTH DISPLAY
                // ========================================
                
                // Main counts - The ONE number (runtime contract) + breakdown
                const contract = data.runtimeContract;
                document.getElementById('reg-contract-total').textContent = contract.total;
                document.getElementById('reg-ai-generates').textContent = contract.aiGenerates;
                document.getElementById('reg-admin-configures').textContent = contract.adminConfigures;
                
                // Breakdown counts
                document.getElementById('reg-auto-count').textContent = data.byPurpose.runtime;
                document.getElementById('reg-manual-count').textContent = data.byPurpose.runtimeManual;
                document.getElementById('reg-system-count').textContent = data.byPurpose.system;
                document.getElementById('reg-future-count').textContent = data.byPurpose.future;
                
                // Update status message
                const statusMsg = document.getElementById('reg-status-message');
                statusMsg.innerHTML = `
                    All <strong>${contract.total}</strong> runtime contract settings are tracked:
                    <strong>${contract.aiGenerates}</strong> AI-generated + <strong>${contract.adminConfigures}</strong> admin-configured.
                    No drift possible.
                `;
                
            } catch (error) {
                console.error('Error loading settings registry:', error);
            }
        }
        
        // Load registry when audit tab opens
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CHECK: Auto-switch to audit tab if returning from Global Brain fix
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (urlParams.get('tab') === 'audit') {
                console.log('ðŸ”§ [AUDIT] Auto-switching to audit tab');
                
                // Check if returning from Deep Audit fix (vs Template Audit fix)
                const returnToDeepAudit = localStorage.getItem('returnToDeepAudit') === 'true';
                localStorage.removeItem('returnToDeepAudit'); // Clear flag
                
                // Click the audit tab
                setTimeout(() => {
                    const auditTab = document.querySelector('[onclick*="showTab"][onclick*="audit"]');
                    if (auditTab) {
                        auditTab.click();
                    }
                    
                    // Check if we have fixed scenarios to process
                    const fixedScenarios = JSON.parse(localStorage.getItem('auditFixedScenarios') || '[]');
                    
                    if (returnToDeepAudit) {
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // RETURNING FROM DEEP AUDIT FIX
                        // Show the Deep Audit results view with fixed scenarios removed
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        console.log('ðŸ”§ [DEEP AUDIT] Returning from Deep Audit fix, showing results');
                        
                        if (lastDeepAuditResults) {
                            // Remove fixed scenarios from the cached results
                            if (fixedScenarios.length > 0 && lastDeepAuditResults.scenarios) {
                                const originalCount = lastDeepAuditResults.scenarios.length;
                                lastDeepAuditResults.scenarios = lastDeepAuditResults.scenarios.filter(
                                    s => !fixedScenarios.includes(s.scenarioId)
                                );
                                const removedCount = originalCount - lastDeepAuditResults.scenarios.length;
                                
                                if (removedCount > 0) {
                                    console.log(`ðŸ”§ [DEEP AUDIT] Removed ${removedCount} fixed scenarios`);
                                    showToast(`${removedCount} scenario${removedCount !== 1 ? 's' : ''} fixed and removed!`, 'success');
                                    
                                    // Update summary
                                    if (lastDeepAuditResults.summary) {
                                        lastDeepAuditResults.summary.totalScenarios = Math.max(0, 
                                            (lastDeepAuditResults.summary.totalScenarios || 0) - removedCount);
                                        lastDeepAuditResults.summary.needsWork = Math.max(0,
                                            (lastDeepAuditResults.summary.needsWork || 0) - removedCount);
                                    }
                                    
                                    // Persist the updated results
                                    persistDeepAuditResults(lastDeepAuditResults);
                                }
                                localStorage.removeItem('auditFixedScenarios');
                            }
                            
                            // Re-display the Deep Audit results
                            displayDeepAuditResults(lastDeepAuditResults);
                            
                            // Make sure Deep Audit view is visible
                            document.getElementById('audit-empty').style.display = 'none';
                            document.getElementById('audit-results').style.display = 'none';
                            document.getElementById('deep-audit-results').style.display = 'block';
                        } else {
                            // No cached results - run Deep Audit again
                            console.log('ðŸ”§ [DEEP AUDIT] No cached results, running new audit');
                            setTimeout(() => {
                                if (typeof runDeepAudit === 'function') {
                                    runDeepAudit();
                                }
                            }, 500);
                        }
                    } else if (fixedScenarios.length > 0) {
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // RETURNING FROM TEMPLATE AUDIT FIX
                        // Re-run Template Audit to refresh the list
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        console.log('ðŸ”§ [TEMPLATE AUDIT] Found fixed scenarios, auto-running audit');
                        setTimeout(() => {
                            if (typeof runAudit === 'function') {
                                runAudit();
                            }
                        }, 500);
                    }
                }, 300);
                
                loadSettingsRegistry();
                loadScenarioPoolAlignment();
            }
        });
        
        // ========================================
        // AUDIT FUNCTIONS
        // ========================================
        async function runAudit() {
            const btn = document.getElementById('run-audit-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
            
            try {
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/audit/run`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Audit failed');
                }
                
                const result = await response.json();
                lastAuditResult = result;
                displayAuditResults(result);
                
            } catch (error) {
                console.error('Audit error:', error);
                showToast('Audit failed: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Run Audit';
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DEEP AUDIT (GPT-4 POWERED) - BATCH-BASED APPROACH
        // Uses multiple short requests instead of one long SSE connection
        // More resilient to proxy timeouts and connection drops
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const BATCH_SIZE = 5; // Process 5 scenarios per request
        let deepAuditCancelled = false;
        
        async function runDeepAudit() {
            const btn = document.getElementById('run-deep-audit-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
            deepAuditCancelled = false;
            
            // Hide regular results, show deep audit view
            document.getElementById('audit-results').style.display = 'none';
            document.getElementById('audit-empty').style.display = 'none';
            document.getElementById('deep-audit-results').style.display = 'block';
            
            // Show progress UI with cancel button
            document.getElementById('deep-audit-list').innerHTML = `
                <div id="deep-audit-progress" style="text-align: center; padding: 40px;">
                    <i class="fas fa-brain fa-3x" style="color: #8b5cf6; margin-bottom: 16px;"></i>
                    <h3 id="progress-title">Loading scenarios...</h3>
                    
                    <!-- Progress bar -->
                    <div style="max-width: 400px; margin: 20px auto;">
                        <div style="background: rgba(139, 92, 246, 0.2); border-radius: 10px; height: 20px; overflow: hidden;">
                            <div id="progress-bar" style="
                                background: linear-gradient(90deg, #8b5cf6 0%, #ec4899 100%);
                                height: 100%;
                                width: 0%;
                                transition: width 0.3s ease;
                                border-radius: 10px;
                            "></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 13px; color: var(--text-muted);">
                            <span id="progress-count">0 / 0</span>
                            <span id="progress-percent">0%</span>
                        </div>
                    </div>
                    
                    <!-- Cancel button -->
                    <button onclick="cancelDeepAudit()" id="cancel-deep-audit-btn" style="
                        margin-top: 16px;
                        background: rgba(239, 68, 68, 0.2);
                        border: 1px solid rgba(239, 68, 68, 0.3);
                        color: #f87171;
                        padding: 8px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 13px;
                    ">
                        <i class="fas fa-stop"></i> Cancel
                    </button>
                    
                    <!-- Current scenario being processed -->
                    <div id="progress-current" style="
                        margin-top: 20px;
                        padding: 12px 20px;
                        background: rgba(139, 92, 246, 0.1);
                        border-radius: 8px;
                        font-size: 13px;
                        color: #a78bfa;
                        display: none;
                    ">
                        <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                        <span id="progress-scenario-name">Processing...</span>
                    </div>
                    
                    <!-- Recent results feed -->
                    <div id="progress-feed" style="
                        margin-top: 20px;
                        max-height: 200px;
                        overflow-y: auto;
                        text-align: left;
                    "></div>
                </div>
            `;
            
            try {
                console.log('ðŸš€ [DEEP AUDIT] Starting batch-based audit...');
                
                // Load services config for service-aware auditing
                let deepAuditServicesConfig = null;
                try {
                    const svcResponse = await fetch(`/api/admin/scenario-gaps/${companyId}/services-config`, {
                        headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                    });
                    if (svcResponse.ok) {
                        deepAuditServicesConfig = await svcResponse.json();
                        console.log('[DEEP AUDIT] Loaded services config:', {
                            disabled: deepAuditServicesConfig.disabledServiceKeys?.length || 0
                        });
                    }
                } catch (e) {
                    console.warn('[DEEP AUDIT] Could not load services config, auditing all scenarios');
                }
                
                // STEP 1: Get list of scenarios to audit (non-streaming request)
                const listResponse = await fetch(`/api/admin/scenario-gaps/${companyId}/audit/deep`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ maxScenarios: 100, stream: false, listOnly: true })
                });
                
                if (!listResponse.ok) {
                    const error = await listResponse.json();
                    throw new Error(error.error || 'Failed to get scenario list');
                }
                
                const listData = await listResponse.json();
                let scenarioIds = listData.scenarioIds || [];
                const templateId = listData.templateId;
                const scenarioMetadata = listData.scenarioMetadata || {}; // category info per scenario
                
                // Filter out scenarios from disabled service categories
                let skippedScenarios = 0;
                if (deepAuditServicesConfig && deepAuditServicesConfig.disabledServiceKeys?.length > 0) {
                    const disabledCategories = new Set();
                    
                    // Build set of disabled category IDs
                    for (const serviceKey of deepAuditServicesConfig.disabledServiceKeys) {
                        const service = deepAuditServicesConfig.services[serviceKey];
                        if (service?.categoryId) {
                            disabledCategories.add(service.categoryId);
                        }
                    }
                    
                    if (disabledCategories.size > 0) {
                        const originalCount = scenarioIds.length;
                        scenarioIds = scenarioIds.filter(id => {
                            const meta = scenarioMetadata[id];
                            return !meta?.categoryId || !disabledCategories.has(meta.categoryId);
                        });
                        skippedScenarios = originalCount - scenarioIds.length;
                        
                        if (skippedScenarios > 0) {
                            console.log(`ðŸ”§ [DEEP AUDIT] Skipped ${skippedScenarios} scenarios from disabled service categories`);
                        }
                    }
                }
                
                const totalCount = scenarioIds.length;
                
                console.log(`ðŸ“‹ [DEEP AUDIT] Got ${totalCount} scenarios to audit${skippedScenarios > 0 ? ` (${skippedScenarios} skipped - disabled services)` : ''}`);
                
                if (totalCount === 0) {
                    throw new Error('No scenarios found to audit');
                }
                
                // Update UI with total count
                document.getElementById('progress-title').textContent = `Analyzing ${totalCount} scenarios with GPT-4...`;
                document.getElementById('progress-count').textContent = `0 / ${totalCount}`;
                document.getElementById('progress-current').style.display = 'block';
                
                // STEP 2: Process in batches
                const allResults = [];
                let processed = 0;
                let totalTokens = 0;
                let perfect = 0;
                let needsWork = 0;
                
                // Split into batches
                const batches = [];
                for (let i = 0; i < scenarioIds.length; i += BATCH_SIZE) {
                    batches.push(scenarioIds.slice(i, i + BATCH_SIZE));
                }
                
                console.log(`ðŸ“¦ [DEEP AUDIT] Processing ${batches.length} batches of up to ${BATCH_SIZE} scenarios each`);
                
                for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
                    // Check if cancelled
                    if (deepAuditCancelled) {
                        console.log('ðŸ›‘ [DEEP AUDIT] Cancelled by user');
                        break;
                    }
                    
                    const batch = batches[batchIndex];
                    const batchStart = batchIndex * BATCH_SIZE + 1;
                    
                    console.log(`ðŸ“¦ [DEEP AUDIT] Processing batch ${batchIndex + 1}/${batches.length} (scenarios ${batchStart}-${batchStart + batch.length - 1})`);
                    
                    try {
                        // Process this batch
                        const batchResponse = await fetch(`/api/admin/scenario-gaps/${companyId}/audit/deep`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${getAuthToken()}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 
                                scenarioIds: batch, 
                                stream: false,
                                templateId: templateId
                            })
                        });
                        
                        if (!batchResponse.ok) {
                            console.error(`Batch ${batchIndex + 1} failed, continuing...`);
                            processed += batch.length;
                            continue;
                        }
                        
                        const batchData = await batchResponse.json();
                        const batchResults = batchData.scenarios || [];
                        
                        // Process each result
                        for (const result of batchResults) {
                            processed++;
                            allResults.push(result);
                            
                            // Count by rewriteNeeded flag (more accurate than score threshold)
                            if (result.score >= 9 && !result.rewriteNeeded) perfect++;
                            else if (result.rewriteNeeded || result.score < 7) needsWork++;
                            
                            totalTokens += batchData.summary?.tokensUsed / batchResults.length || 0;
                            
                            // Update progress UI
                            const percent = Math.round((processed / totalCount) * 100);
                            document.getElementById('progress-bar').style.width = `${percent}%`;
                            document.getElementById('progress-count').textContent = `${processed} / ${totalCount}`;
                            document.getElementById('progress-percent').textContent = `${percent}%`;
                            document.getElementById('progress-scenario-name').textContent = result.name || 'Processing...';
                            
                            // Add to feed
                            const scoreColor = result.score >= 9 ? '#10b981' : 
                                              result.score >= 7 ? '#22c55e' : 
                                              result.score >= 5 ? '#f59e0b' : '#ef4444';
                            
                            const feedItem = document.createElement('div');
                            feedItem.style.cssText = `display: flex; justify-content: space-between; padding: 6px 12px; margin: 4px 0; background: rgba(255,255,255,0.03); border-radius: 6px; font-size: 13px;`;
                            feedItem.innerHTML = `
                                <span style="color: #e2e8f0;">${escapeHtml(result.name || 'Unknown')}</span>
                                <span style="color: ${scoreColor}; font-weight: 600;">${result.score}/10</span>
                            `;
                            document.getElementById('progress-feed').appendChild(feedItem);
                            
                            // Update button
                            document.getElementById('run-deep-audit-btn').innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${processed}/${totalCount}`;
                        }
                        
                    } catch (batchError) {
                        console.error(`Batch ${batchIndex + 1} error:`, batchError);
                        processed += batch.length;
                    }
                    
                    // Small delay between batches to avoid rate limiting
                    if (batchIndex < batches.length - 1 && !deepAuditCancelled) {
                        await new Promise(r => setTimeout(r, 500));
                    }
                }
                
                // STEP 3: Show final results
                const avgScore = allResults.length > 0 
                    ? (allResults.reduce((sum, r) => sum + (r.score || 0), 0) / allResults.length).toFixed(1)
                    : 0;
                
                const finalResult = {
                    success: true,
                    auditType: 'deep',
                    poweredBy: 'GPT-4o',
                    summary: {
                        totalScenarios: allResults.length,
                        averageScore: parseFloat(avgScore),
                        perfect: perfect,
                        needsWork: needsWork,
                        tokensUsed: Math.round(totalTokens),
                        estimatedCost: `$${(totalTokens * 0.00001).toFixed(4)}`
                    },
                    scenarios: allResults.sort((a, b) => (a.score || 0) - (b.score || 0))
                };
                
                // Store results for "Fix in Global Brain" button (persist for page navigation)
                persistDeepAuditResults(finalResult);
                
                if (deepAuditCancelled) {
                    document.getElementById('progress-title').innerHTML = `
                        <span style="color: #f59e0b;">â¹ï¸ Audit Cancelled</span><br>
                        <span style="font-size: 14px; color: #888;">Processed ${allResults.length} scenarios before cancellation</span>
                    `;
                    if (allResults.length > 0) {
                        setTimeout(() => displayDeepAuditResults(finalResult), 500);
                    }
                } else {
                    console.log('âœ… [DEEP AUDIT] Complete!', finalResult.summary);
                    displayDeepAuditResults(finalResult);
                }
                
            } catch (error) {
                console.error('Deep audit error:', error);
                document.getElementById('deep-audit-list').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle fa-2x" style="color: #ef4444; margin-bottom: 12px;"></i>
                        <h3 style="color: #ef4444;">Deep Audit Failed</h3>
                        <p style="color: #888; margin-bottom: 20px;">${escapeHtml(error.message)}</p>
                        <button onclick="runDeepAudit()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border: none; color: white; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            <i class="fas fa-redo"></i> Retry Deep Audit
                        </button>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-brain"></i> Deep Audit (AI)';
            }
        }
        
        function cancelDeepAudit() {
            deepAuditCancelled = true;
            document.getElementById('cancel-deep-audit-btn').disabled = true;
            document.getElementById('cancel-deep-audit-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cancelling...';
            document.getElementById('progress-title').textContent = 'Cancelling after current batch...';
        }
        
        // Legacy handler - no longer used but kept for compatibility
        function handleDeepAuditProgress(data) {
            const progressBar = document.getElementById('progress-bar');
            const progressCount = document.getElementById('progress-count');
            const progressPercent = document.getElementById('progress-percent');
            const progressTitle = document.getElementById('progress-title');
            const progressCurrent = document.getElementById('progress-current');
            const progressScenarioName = document.getElementById('progress-scenario-name');
            const progressFeed = document.getElementById('progress-feed');
            const btn = document.getElementById('run-deep-audit-btn');
            
            switch (data.type) {
                case 'connected':
                    // Initial SSE connection confirmed
                    progressTitle.textContent = 'Connected! Loading scenarios...';
                    console.log('âœ… [DEEP AUDIT] SSE connection established');
                    break;
                    
                case 'start':
                    progressTitle.textContent = `Analyzing ${data.total} scenarios with GPT-4...`;
                    progressCount.textContent = `0 / ${data.total}`;
                    progressCurrent.style.display = 'block';
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 0/${data.total}`;
                    break;
                    
                case 'progress':
                    // Update progress bar
                    progressBar.style.width = `${data.percent}%`;
                    progressCount.textContent = `${data.current} / ${data.total}`;
                    progressPercent.textContent = `${data.percent}%`;
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${data.current}/${data.total}`;
                    
                    // Update current scenario
                    if (data.scenario) {
                        progressScenarioName.textContent = `${data.scenario.name}`;
                        
                        // Add to feed
                        const scoreColor = data.scenario.score >= 9 ? '#10b981' : 
                                          data.scenario.score >= 7 ? '#22c55e' : 
                                          data.scenario.score >= 5 ? '#f59e0b' : '#ef4444';
                        
                        const feedItem = document.createElement('div');
                        feedItem.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            padding: 6px 12px;
                            margin: 4px 0;
                            background: rgba(255,255,255,0.03);
                            border-radius: 6px;
                            font-size: 12px;
                        `;
                        feedItem.innerHTML = `
                            <span style="color: var(--text-muted);">${data.scenario.name}</span>
                            <span style="color: ${scoreColor}; font-weight: 600;">${data.scenario.score}/10</span>
                        `;
                        progressFeed.insertBefore(feedItem, progressFeed.firstChild);
                        
                        // Keep only last 10 items visible
                        while (progressFeed.children.length > 10) {
                            progressFeed.removeChild(progressFeed.lastChild);
                        }
                    }
                    break;
                    
                case 'complete':
                    progressTitle.textContent = 'Deep Audit Complete!';
                    progressCurrent.style.display = 'none';
                    
                    // Display final results after a brief pause
                    setTimeout(() => {
                        displayDeepAuditResults(data);
                    }, 500);
                    break;
                    
                case 'error':
                    progressTitle.textContent = 'Error';
                    progressTitle.style.color = '#ef4444';
                    progressScenarioName.textContent = data.message;
                    break;
            }
        }
        
        function displayDeepAuditResults(result) {
            // Store results globally for openDeepAuditFix to access (persist for navigation)
            persistDeepAuditResults(result);
            
            const { summary, scenarios } = result;
            
            // Update summary
            document.getElementById('deep-avg-score').textContent = summary.averageScore || '-';
            document.getElementById('deep-total').textContent = summary.totalScenarios || 0;
            document.getElementById('deep-perfect').textContent = summary.perfect || 0;
            document.getElementById('deep-needs-work').textContent = summary.needsWork || 0;
            document.getElementById('deep-cost').textContent = summary.estimatedCost || '$0';
            
            // Color the avg score
            const avgScoreEl = document.getElementById('deep-avg-score');
            const avgScore = summary.averageScore || 0;
            if (avgScore >= 9) avgScoreEl.style.color = '#10b981';
            else if (avgScore >= 7) avgScoreEl.style.color = '#22c55e';
            else if (avgScore >= 5) avgScoreEl.style.color = '#f59e0b';
            else avgScoreEl.style.color = '#ef4444';
            
            // Build scenario cards
            const listEl = document.getElementById('deep-audit-list');
            
            if (!scenarios || scenarios.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No scenarios audited</div>';
                return;
            }
            
            // Calculate total hallucinations filtered for summary
            let totalHallucinationsFiltered = 0;
            scenarios.forEach(s => {
                if (s.supervision?.hallucinatedFiltered) {
                    totalHallucinationsFiltered += s.supervision.hallucinatedFiltered;
                }
            });
            
            // Show supervision summary if any hallucinations were filtered
            if (totalHallucinationsFiltered > 0) {
                const summaryEl = document.getElementById('deep-audit-summary');
                if (summaryEl) {
                    const supervisionBadge = document.createElement('div');
                    supervisionBadge.innerHTML = `
                        <div style="background: rgba(167, 139, 250, 0.15); border: 1px solid rgba(167, 139, 250, 0.3); border-radius: 8px; padding: 10px 16px; margin-top: 12px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 18px;">ðŸ›¡ï¸</span>
                            <div>
                                <div style="color: #a78bfa; font-weight: 600; font-size: 13px;">Supervision Active</div>
                                <div style="color: #c4b5fd; font-size: 12px;">${totalHallucinationsFiltered} false positive${totalHallucinationsFiltered !== 1 ? 's' : ''} filtered by grounding validator</div>
                            </div>
                        </div>
                    `;
                    const existingBadge = summaryEl.querySelector('.supervision-badge');
                    if (existingBadge) existingBadge.remove();
                    supervisionBadge.className = 'supervision-badge';
                    summaryEl.appendChild(supervisionBadge);
                }
            }
            
            listEl.innerHTML = scenarios.map(s => {
                const scoreColor = s.score >= 9 ? '#10b981' : s.score >= 7 ? '#22c55e' : s.score >= 5 ? '#f59e0b' : '#ef4444';
                const verdictBg = s.verdict === 'PERFECT' ? 'rgba(16, 185, 129, 0.2)' : 
                                  s.verdict === 'GOOD' ? 'rgba(34, 197, 94, 0.2)' :
                                  s.verdict === 'NEEDS_WORK' ? 'rgba(245, 158, 11, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                
                // Supervision badge for individual scenario
                const supervisionHtml = s.supervision?.hallucinatedFiltered > 0 
                    ? `<span style="background: rgba(167, 139, 250, 0.2); color: #a78bfa; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 8px;" title="${s.supervision.hallucinatedFiltered} hallucinated issue(s) filtered out">ðŸ›¡ï¸ ${s.supervision.hallucinatedFiltered} filtered</span>`
                    : '';
                
                const issuesHtml = (s.issues || []).map(issue => `
                    <div style="background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 8px 12px; margin: 4px 0; border-radius: 0 6px 6px 0;">
                        <div style="font-size: 12px; color: #ef4444; font-weight: 600;">${issue.field || 'general'} ${issue.grounded ? '<span style="color: #a78bfa; font-size: 10px;">âœ“ verified</span>' : ''}</div>
                        <div style="font-size: 13px; color: #fca5a5;">${issue.issue}</div>
                        <div style="font-size: 12px; color: #10b981; margin-top: 4px;">ðŸ’¡ ${issue.suggestion}</div>
                    </div>
                `).join('');
                
                const strengthsHtml = (s.strengths || []).map(str => `
                    <span style="background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 4px;">âœ“ ${str}</span>
                `).join('');
                
                return `
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; ${s.rewriteNeeded ? 'border-left: 4px solid #ef4444;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <h4 style="margin: 0; color: white;">${s.name}${supervisionHtml}</h4>
                                <span style="font-size: 12px; color: var(--text-muted);">${s.category} â€¢ ${s.scenarioType || 'FAQ'}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="background: ${verdictBg}; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">${s.verdict}</span>
                                <div style="font-size: 28px; font-weight: bold; color: ${scoreColor};">${s.score}/10</div>
                            </div>
                        </div>
                        
                        ${strengthsHtml ? `<div style="margin-bottom: 12px;">${strengthsHtml}</div>` : ''}
                        
                        ${issuesHtml || '<div style="color: #10b981; font-size: 13px;">âœ¨ No issues found</div>'}
                        
                        ${s.rewriteNeeded ? `
                            <div style="margin-top: 12px; display: flex; gap: 8px;">
                                <button class="btn" onclick="openDeepAuditFix('${s.scenarioId}', '${s.categoryId}')" 
                                    style="background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); border: none; padding: 8px 16px;">
                                    <i class="fas fa-magic"></i> Fix in Global Brain
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function hideDeepAuditResults() {
            document.getElementById('deep-audit-results').style.display = 'none';
            // Show regular audit results if we have them
            if (lastAuditResult) {
                document.getElementById('audit-results').style.display = 'block';
            } else {
                document.getElementById('audit-empty').style.display = 'block';
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EXPORT AUDIT RESULTS - Copy or Download as JSON for analysis
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function copyAuditJSON() {
            if (!lastDeepAuditResults) {
                showToast('No audit results to copy', 'error');
                return;
            }
            
            const exportData = buildAuditExport();
            const jsonStr = JSON.stringify(exportData, null, 2);
            
            navigator.clipboard.writeText(jsonStr).then(() => {
                showToast('âœ… Audit JSON copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }
        
        function downloadAuditJSON() {
            if (!lastDeepAuditResults) {
                showToast('No audit results to download', 'error');
                return;
            }
            
            const exportData = buildAuditExport();
            const jsonStr = JSON.stringify(exportData, null, 2);
            
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `deep-audit-${companyId}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('âœ… Audit JSON downloaded!', 'success');
        }
        
        function buildAuditExport() {
            const results = lastDeepAuditResults;
            
            return {
                exportedAt: new Date().toISOString(),
                companyId: companyId,
                
                // Summary stats
                summary: results.summary || {
                    averageScore: document.getElementById('deep-avg-score')?.textContent,
                    totalScenarios: document.getElementById('deep-total')?.textContent,
                    perfect: document.getElementById('deep-perfect')?.textContent,
                    needsWork: document.getElementById('deep-needs-work')?.textContent,
                    apiCost: document.getElementById('deep-cost')?.textContent
                },
                
                // Full scenario results with all GPT-4 analysis
                scenarios: (results.scenarios || []).map(s => ({
                    scenarioId: s.scenarioId,
                    name: s.name,
                    category: s.category,
                    scenarioType: s.scenarioType,
                    
                    // GPT-4 judgment
                    score: s.score,
                    verdict: s.verdict,
                    rewriteNeeded: s.rewriteNeeded,
                    
                    // Issues found (with grounding status)
                    issues: s.issues || [],
                    
                    // What GPT-4 liked
                    strengths: s.strengths || [],
                    
                    // Supervision metadata
                    supervision: s.supervision || null,
                    
                    // Raw data for debugging
                    _raw: {
                        hallucinatedIssuesFiltered: s.supervision?.hallucinatedFiltered || 0,
                        originalIssueCount: s.supervision?.originalIssueCount || null
                    }
                })),
                
                // Scenarios grouped by verdict for easy analysis
                byVerdict: {
                    PERFECT: (results.scenarios || []).filter(s => s.verdict === 'PERFECT').map(s => s.name),
                    GOOD: (results.scenarios || []).filter(s => s.verdict === 'GOOD').map(s => s.name),
                    NEEDS_WORK: (results.scenarios || []).filter(s => s.verdict === 'NEEDS_WORK').map(s => s.name),
                    FAILS: (results.scenarios || []).filter(s => s.verdict === 'FAILS').map(s => s.name)
                },
                
                // Common issues across all scenarios (for pattern analysis)
                commonIssues: analyzeCommonIssues(results.scenarios || [])
            };
        }
        
        function analyzeCommonIssues(scenarios) {
            const issueCounts = {};
            
            for (const s of scenarios) {
                for (const issue of (s.issues || [])) {
                    const key = issue.issue?.toLowerCase().substring(0, 50) || 'unknown';
                    issueCounts[key] = (issueCounts[key] || 0) + 1;
                }
            }
            
            // Sort by frequency
            return Object.entries(issueCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20)
                .map(([issue, count]) => ({ issue, count }));
        }
        
        // Store deep audit results globally for access by openDeepAuditFix
        // Also persist to sessionStorage so results survive page navigation
        let lastDeepAuditResults = null;
        
        // Load persisted deep audit results on page load
        try {
            const stored = sessionStorage.getItem('deepAuditResults');
            if (stored) {
                lastDeepAuditResults = JSON.parse(stored);
                console.log('ðŸ”§ [DEEP AUDIT] Loaded cached results from sessionStorage');
            }
        } catch (e) {
            console.warn('Failed to load deep audit results from sessionStorage');
        }
        
        // Helper to persist deep audit results
        function persistDeepAuditResults(results) {
            lastDeepAuditResults = results;
            try {
                sessionStorage.setItem('deepAuditResults', JSON.stringify(results));
            } catch (e) {
                console.warn('Failed to persist deep audit results');
            }
        }
        
        function openDeepAuditFix(scenarioId, categoryId) {
            // Store company ID for return navigation
            localStorage.setItem('lastAuditCompanyId', companyId);
            
            // Find the scenario in deep audit results to get the full data
            const scenarioResult = lastDeepAuditResults?.scenarios?.find(s => s.scenarioId === scenarioId);
            
            // Get template ID from the audit result (backend now includes it) or manual builder
            const templateId = scenarioResult?.templateId || manualBuilderTemplateData?.templateId || manualBuilderTemplateData?._id || null;
            
            console.log('ðŸ”§ [DEEP AUDIT FIX] Opening with templateId:', templateId);
            
            // Build prefill data similar to Template Audit flow
            const prefillData = {
                mode: 'deep-audit-fix',
                source: 'deep-audit',
                timestamp: Date.now(),
                navigation: {
                    templateId: templateId,
                    categoryId: categoryId,
                    scenarioId: scenarioId,
                    companyId: companyId
                },
                auditResult: scenarioResult || {
                    scenarioId: scenarioId,
                    categoryId: categoryId
                }
            };
            
            // Store in localStorage (same pattern as Template Audit)
            localStorage.setItem('deepAuditEditPrefill', JSON.stringify(prefillData));
            
            console.log('ðŸ”§ [DEEP AUDIT] Opening Global Brain with prefill:', prefillData);
            
            // Open Global Brain with prefill flag
            const gbUrl = `/admin-global-instant-responses.html?prefill=deep-audit-fix&scenarioId=${scenarioId}&categoryId=${categoryId}`;
            window.open(gbUrl, '_blank');
        }
        
        function toggleRulesChecked() {
            const list = document.getElementById('rules-checked-list');
            const icon = document.getElementById('rules-toggle-icon');
            if (list.style.display === 'none') {
                list.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                list.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }
        
        function displayAuditResults(result) {
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CHECK: Remove any scenarios that were fixed in Global Brain
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const fixedScenarios = JSON.parse(localStorage.getItem('auditFixedScenarios') || '[]');
            if (fixedScenarios.length > 0 && result.scenarios) {
                const originalCount = result.scenarios.length;
                result.scenarios = result.scenarios.filter(s => !fixedScenarios.includes(s.scenarioId));
                const removedCount = originalCount - result.scenarios.length;
                
                if (removedCount > 0) {
                    console.log(`ðŸ”§ [AUDIT] Removed ${removedCount} fixed scenarios from list`);
                    showToast(`${removedCount} scenario${removedCount !== 1 ? 's' : ''} fixed and removed from list!`, 'success');
                    
                    // Update summary counts
                    if (result.summary) {
                        result.summary.totalScenarios = Math.max(0, (result.summary.totalScenarios || 0) - removedCount);
                        result.summary.scenariosFailing = Math.max(0, (result.summary.scenariosFailing || 0) - removedCount);
                    }
                    
                    // Clear the fixed scenarios list
                    localStorage.removeItem('auditFixedScenarios');
                }
            }
            
            // Store for reference
            window.fullAuditResult = result;
            window.auditScenarios = result.scenarios?.filter(s => s.violations?.length > 0) || [];
            
            // Show results, hide empty state
            document.getElementById('audit-empty').style.display = 'none';
            document.getElementById('audit-results').style.display = 'block';
            
            // Update health score
            const healthScore = result.summary?.healthScore || 0;
            const scoreEl = document.getElementById('audit-health-score');
            scoreEl.textContent = healthScore;
            scoreEl.className = 'health-score ' + getHealthClass(healthScore);
            
            // Update badge in tab
            const badge = document.getElementById('health-badge');
            badge.textContent = healthScore;
            badge.style.background = getHealthColor(healthScore);
            badge.style.color = 'white';
            
            // Update stats
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CORRECTED PASSING DEFINITION:
            //   No Errors = 0 errors (warnings allowed) â†’ scenariosPassing
            //   Perfect = 0 errors AND 0 warnings â†’ scenariosPerfect
            //   Failing = 1+ errors â†’ scenariosFailing
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            document.getElementById('audit-total').textContent = result.summary?.totalScenarios || 0;
            document.getElementById('audit-passing').textContent = result.summary?.scenariosPassing || 0;
            document.getElementById('audit-perfect').textContent = result.summary?.scenariosPerfect || 0;
            document.getElementById('audit-errors').textContent = result.summary?.scenariosFailing || result.summary?.scenariosWithErrors || 0;
            document.getElementById('audit-warnings').textContent = result.summary?.bySeverity?.warning || result.summary?.scenariosWithWarnings || 0;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // SERVICE-AWARE AUDIT SCOPE (3 BUCKETS)
            // Shows runtime truth: Template + Company Local + Service Toggles
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const auditScope = result.auditScope;
            const buckets = result.buckets;
            
            if (auditScope || buckets) {
                const scopePanel = document.getElementById('audit-scope-panel');
                scopePanel.style.display = 'block';
                
                // Main Template bucket
                const mainBucket = buckets?.mainTemplate || {};
                document.getElementById('bucket-main-count').textContent = mainBucket.count || auditScope?.enabled || 0;
                document.getElementById('bucket-main-passing').textContent = `${mainBucket.passing || 0} passing`;
                document.getElementById('bucket-main-failing').textContent = `${mainBucket.failing || 0} failing`;
                
                // Company Local bucket
                const localBucket = buckets?.companyLocal || {};
                document.getElementById('bucket-local-count').textContent = localBucket.count || auditScope?.companyLocal || 0;
                document.getElementById('bucket-local-passing').textContent = `${localBucket.passing || 0} passing`;
                document.getElementById('bucket-local-failing').textContent = `${localBucket.failing || 0} failing`;
                
                // Gray out Company Local if empty
                const localPanel = document.getElementById('bucket-company-local');
                if ((localBucket.count || auditScope?.companyLocal || 0) === 0) {
                    localPanel.style.opacity = '0.5';
                } else {
                    localPanel.style.opacity = '1';
                }
                
                // Disabled bucket
                const disabledBucket = buckets?.disabled || {};
                const disabledCount = disabledBucket.count || auditScope?.disabled || 0;
                document.getElementById('bucket-disabled-count').textContent = disabledCount;
                
                const disabledServices = disabledBucket.services || auditScope?.disabledServices || [];
                if (disabledServices.length > 0) {
                    document.getElementById('bucket-disabled-services').innerHTML = 
                        disabledServices.map(s => `<span style="margin-right: 4px;">â€¢ ${s.replace(/_/g, ' ')}</span>`).join('');
                } else {
                    document.getElementById('bucket-disabled-services').textContent = 'No services disabled';
                }
                
                // Gray out disabled bucket if empty
                const disabledPanel = document.getElementById('bucket-disabled');
                if (disabledCount === 0) {
                    disabledPanel.style.opacity = '0.5';
                } else {
                    disabledPanel.style.opacity = '1';
                }
                
                console.log('[AUDIT] Service-aware scope:', {
                    mainTemplate: mainBucket.count || auditScope?.enabled,
                    companyLocal: localBucket.count || auditScope?.companyLocal,
                    disabled: disabledCount,
                    disabledServices
                });
            } else {
                // Hide scope panel if no service-aware data
                document.getElementById('audit-scope-panel').style.display = 'none';
            }
            
            // Update rules checked section
            const rulesChecklist = result.rulesChecklist || [];
            const totalChecks = result.totalChecksPerformed || 0;
            document.getElementById('rules-checked-count').textContent = 
                `(${rulesChecklist.length} rules, ${totalChecks} total checks)`;
            
            const rulesListEl = document.getElementById('rules-checked-list');
            rulesListEl.innerHTML = rulesChecklist.map(rule => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
                    <div style="width: 24px; text-align: center;">
                        ${rule.status === 'completed' 
                            ? `<i class="fas fa-check-circle" style="color: var(--accent-green);"></i>`
                            : `<i class="fas fa-spinner fa-spin" style="color: var(--text-muted);"></i>`
                        }
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 13px;">${escapeHtml(rule.ruleName)}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">${escapeHtml(rule.description || '')}</div>
                    </div>
                    <div style="text-align: right; min-width: 100px;">
                        ${rule.violationsFound > 0 
                            ? `<span style="color: var(--accent-red); font-weight: 600;">${rule.violationsFound} issues</span>`
                            : `<span style="color: var(--accent-green);">All passed</span>`
                        }
                        <div style="font-size: 11px; color: var(--text-muted);">${rule.checksRun} checks</div>
                    </div>
                </div>
            `).join('');
            
            // Auto-expand rules checked section to show completeness
            document.getElementById('rules-checked-list').style.display = 'block';
            document.getElementById('rules-toggle-icon').className = 'fas fa-chevron-up';
            
            // Build SCENARIO list (grouped by scenario, not individual violations)
            const violationsList = document.getElementById('violations-list');
            
            // Get scenarios with issues
            const scenariosWithIssues = (result.scenarios || [])
                .filter(s => s.violations && s.violations.length > 0)
                .sort((a, b) => {
                    // Sort by error count, then warning count
                    const aErrors = a.violations.filter(v => v.severity === 'error').length;
                    const bErrors = b.violations.filter(v => v.severity === 'error').length;
                    if (aErrors !== bErrors) return bErrors - aErrors;
                    return b.violations.length - a.violations.length;
                });
            
            // Store for modal use
            window.auditScenarios = scenariosWithIssues;
            window.fullAuditResult = result;
            
            const totalViolations = scenariosWithIssues.reduce((sum, s) => sum + s.violations.length, 0);
            
            // Update count
            document.getElementById('violations-count').textContent = 
                `(${scenariosWithIssues.length} scenarios, ${totalViolations} issues)`;
            
            if (scenariosWithIssues.length === 0) {
                violationsList.innerHTML = `
                    <div class="audit-empty" style="padding: 40px;">
                        <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                        <h3>All Scenarios Pass!</h3>
                        <p>No violations found. Your template follows all dispatcher personality rules.</p>
                    </div>
                `;
                return;
            }
            
            // Render SCENARIO cards (not individual violations)
            violationsList.innerHTML = scenariosWithIssues.map((scenario, idx) => {
                const categoryLabel = scenario.category || (Array.isArray(scenario.categories) ? scenario.categories[0] : 'General');
                const errorCount = scenario.violations.filter(v => v.severity === 'error').length;
                const warningCount = scenario.violations.filter(v => v.severity === 'warning').length;
                const infoCount = scenario.violations.filter(v => v.severity === 'info').length;
                
                return `
                <div class="scenario-audit-card" onclick="openScenarioReview(${idx})" style="
                    background: var(--bg-secondary);
                    border: 1px solid var(--border-color);
                    border-radius: 12px;
                    padding: 16px;
                    margin-bottom: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                " onmouseover="this.style.borderColor='var(--accent-purple)'" onmouseout="this.style.borderColor='var(--border-color)'">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">
                                ${escapeHtml(scenario.name)}
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted);">
                                ${escapeHtml(scenario.scenarioType || 'FAQ')} â€¢ ${escapeHtml(categoryLabel)}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            ${errorCount > 0 ? `<span style="background: var(--accent-red); color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${errorCount} errors</span>` : ''}
                            ${warningCount > 0 ? `<span style="background: var(--accent-yellow); color: #000; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${warningCount} warnings</span>` : ''}
                            ${infoCount > 0 ? `<span style="background: var(--accent-blue); color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${infoCount} info</span>` : ''}
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 12px; color: var(--text-muted);">
                            ${scenario.violations.slice(0, 2).map(v => `<span style="margin-right: 8px;">â€¢ ${escapeHtml(v.message.substring(0, 40))}${v.message.length > 40 ? '...' : ''}</span>`).join('')}
                            ${scenario.violations.length > 2 ? `<span>+${scenario.violations.length - 2} more</span>` : ''}
                        </div>
                        <button style="background: var(--accent-purple); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; cursor: pointer;">
                            <i class="fas fa-search"></i> Review & Fix
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function getHealthClass(score) {
            if (score >= 90) return 'excellent';
            if (score >= 70) return 'good';
            if (score >= 50) return 'fair';
            return 'poor';
        }
        
        function getHealthColor(score) {
            if (score >= 90) return 'var(--accent-green)';
            if (score >= 70) return 'var(--accent-blue)';
            if (score >= 50) return 'var(--accent-yellow)';
            return 'var(--accent-red)';
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BLUEPRINT BUILDER FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BLUEPRINT SERVICE AWARENESS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Blueprint Builder respects service toggles - disabled services are grayed out
        let blueprintServicesConfig = null;
        
        async function loadBlueprintServicesConfig() {
            try {
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/services-config`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                if (response.ok) {
                    blueprintServicesConfig = await response.json();
                    console.log('[BLUEPRINT] Loaded services config:', {
                        enabled: blueprintServicesConfig.enabledServiceKeys?.length || 0,
                        disabled: blueprintServicesConfig.disabledServiceKeys?.length || 0
                    });
                }
            } catch (error) {
                console.warn('[BLUEPRINT] Failed to load services config:', error);
                blueprintServicesConfig = null;
            }
        }
        
        function isServiceDisabled(serviceKey) {
            if (!blueprintServicesConfig || !serviceKey) return false;
            return blueprintServicesConfig.disabledServiceKeys?.includes(serviceKey) || false;
        }
        
        async function runBlueprintAssessment() {
            const btn = document.getElementById('run-blueprint-btn');
            const tradeKey = document.getElementById('blueprint-select').value;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Assessing...';
            
            try {
                const token = getAuthToken();
                
                // Load services config for service-aware rendering
                await loadBlueprintServicesConfig();
                
                // Fetch blueprint spec first (for copy/export)
                const specResponse = await fetch(`/api/admin/blueprints/${tradeKey}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (specResponse.ok) {
                    window.__lastBlueprintSpec = await specResponse.json();
                }
                
                // Fetch assessment
                const response = await fetch(`/api/admin/blueprints/${tradeKey}/assess?companyId=${companyId}&source=activePool`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Assessment failed: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Assessment failed');
                }
                
                blueprintAssessment = result;
                window.__lastBlueprintAssess = result; // Store for copy/export
                selectedBlueprintItems.clear();
                
                // Update UI
                renderBlueprintAssessment(result);
                
                // Update badge
                const badge = document.getElementById('blueprint-badge');
                badge.textContent = `${result.coverage.percent}%`;
                badge.style.background = result.coverage.percent >= 80 ? '#22c55e' : result.coverage.percent >= 50 ? '#f59e0b' : '#ef4444';
                
                console.log('âœ… [BLUEPRINT] Assessment complete:', result.coverage);
                console.log('âœ… [BLUEPRINT] Spec and Assess JSON stored for copy/export');
                
            } catch (error) {
                console.error('[BLUEPRINT] Assessment error:', error);
                alert('Failed to assess blueprint: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-chart-pie"></i> Assess Coverage';
            }
        }
        
        function renderBlueprintAssessment(result) {
            // Hide initial state, show summary
            document.getElementById('blueprint-initial').style.display = 'none';
            document.getElementById('blueprint-summary').style.display = 'block';
            
            // Store mode for later use
            window.__blueprintMode = result.mode;
            
            // Update coverage stats
            document.getElementById('blueprint-coverage-score').textContent = `${result.coverage.percent}%`;
            document.getElementById('blueprint-coverage-score').style.color = 
                result.coverage.percent >= 80 ? 'var(--accent-green)' : 
                result.coverage.percent >= 50 ? 'var(--accent-yellow)' : 'var(--accent-red)';
            
            document.getElementById('bp-total').textContent = result.coverage.totalInBlueprint;
            document.getElementById('bp-covered').textContent = result.coverage.totalCovered;
            document.getElementById('bp-missing').textContent = result.missingItems.length;
            document.getElementById('bp-required-missing').textContent = result.stats.missingRequired;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // RENDER MODE BANNER + ACTION BUTTONS (based on explicit actions from backend)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const actions = result.actions || {};
            const isGreenfield = result.mode === 'GREENFIELD_FULL_PACK';
            const modeBanner = document.getElementById('blueprint-mode-banner');
            
            if (modeBanner) {
                modeBanner.style.display = 'block';
                
                if (isGreenfield) {
                    // GREENFIELD MODE: Show Full Pack + Required Only buttons
                    modeBanner.innerHTML = `
                        <div style="padding: 20px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(99, 102, 241, 0.15)); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <i class="fas fa-rocket" style="font-size: 28px; color: #a78bfa;"></i>
                                <div>
                                    <div style="font-weight: 700; font-size: 16px; color: #a78bfa;">Greenfield Template</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        Empty template detected (${result.coverage.existingScenarios} scenarios). Generate a full blueprint pack to get started.
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                ${actions.generateFullPack?.enabled ? `
                                    <button onclick="generateWithMode('FULL_PACK')" class="btn-primary" style="padding: 12px 24px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; font-size: 14px;">
                                        <i class="fas fa-magic"></i> ${actions.generateFullPack.label}
                                    </button>
                                ` : ''}
                                ${actions.generateRequiredOnly?.enabled ? `
                                    <button onclick="generateWithMode('REQUIRED_ONLY')" style="padding: 12px 24px; background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 8px; color: #a78bfa; cursor: pointer; font-weight: 600; font-size: 14px;">
                                        <i class="fas fa-star"></i> ${actions.generateRequiredOnly.label}
                                    </button>
                                ` : ''}
                            </div>
                            <div style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">
                                <i class="fas fa-info-circle"></i> 
                                Full Pack = all ${result.coverage.totalInBlueprint} scenarios. 
                                Required Only = ${result.stats?.totalRequired || 0} essential scenarios.
                            </div>
                        </div>
                    `;
                } else {
                    // FILLING GAPS MODE: Show info banner (no action buttons here)
                    modeBanner.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; margin-bottom: 20px;">
                            <i class="fas fa-puzzle-piece" style="font-size: 20px; color: #4ade80;"></i>
                            <div style="font-size: 13px; color: var(--text-secondary);">
                                <strong style="color: #4ade80;">Filling Gaps Mode</strong> â€” 
                                ${result.coverage.existingScenarios} existing scenarios. 
                                Select missing items below to generate and add to your template.
                            </div>
                        </div>
                    `;
                }
            }
            
            // Render missing items grouped by category
            const listEl = document.getElementById('missing-items-list');
            
            if (result.missingItems.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--accent-green);">
                        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <h3>100% Blueprint Coverage!</h3>
                        <p style="color: var(--text-muted);">All required scenarios are present in your template.</p>
                    </div>
                `;
                return;
            }
            
            // Group by category
            const byCategory = result.missingByCategory || {};
            let html = '';
            let disabledCategoryCount = 0;
            
            for (const [categoryKey, items] of Object.entries(byCategory)) {
                const categoryName = items[0]?.categoryName || categoryKey;
                
                // Check if this category's service is disabled
                // Match by category name to serviceKey mapping (in services config)
                const serviceConfig = blueprintServicesConfig?.services || {};
                const matchingService = Object.entries(serviceConfig).find(([key, svc]) => 
                    svc.categoryName?.toLowerCase() === categoryName.toLowerCase()
                );
                const serviceKey = matchingService?.[0] || null;
                const isDisabled = serviceKey ? isServiceDisabled(serviceKey) : false;
                
                if (isDisabled) disabledCategoryCount++;
                
                html += `
                    <div style="margin-bottom: 16px; ${isDisabled ? 'opacity: 0.5;' : ''}">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: ${isDisabled ? 'rgba(107, 114, 128, 0.2)' : 'var(--bg-secondary)'}; border-radius: 8px; margin-bottom: 8px; ${isDisabled ? 'border: 1px dashed rgba(107, 114, 128, 0.5);' : ''}">
                            <span style="font-weight: 600; color: ${isDisabled ? 'var(--text-muted)' : 'var(--text-primary)'};">
                                ${escapeHtml(categoryName)}
                                ${isDisabled ? '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 8px;">SERVICE OFF</span>' : ''}
                            </span>
                            <span style="font-size: 13px; color: var(--text-muted);">
                                ${items.length} missing
                            </span>
                        </div>
                        ${items.map(item => `
                            <label style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: ${isDisabled ? 'rgba(107, 114, 128, 0.1)' : 'rgba(255,255,255,0.03)'}; border-radius: 8px; margin-bottom: 4px; cursor: ${isDisabled ? 'not-allowed' : 'pointer'}; border-left: 3px solid ${isDisabled ? '#6b7280' : (item.required !== false ? '#f59e0b' : '#6b7280')};" ${isDisabled ? 'title="Service disabled - enable in Company Local tab"' : ''}>
                                <input type="checkbox" 
                                       value="${escapeHtml(item.itemKey)}" 
                                       onchange="toggleBlueprintItem('${escapeHtml(item.itemKey)}')"
                                       style="margin-top: 3px; width: 18px; height: 18px; accent-color: #8b5cf6;"
                                       ${isDisabled ? 'disabled' : ''}>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: ${isDisabled ? 'var(--text-muted)' : 'white'}; margin-bottom: 4px;">
                                        ${escapeHtml(item.name)}
                                        ${!isDisabled && item.required !== false ? '<span style="color: #f59e0b; font-size: 11px; margin-left: 8px;">REQUIRED</span>' : ''}
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-muted);">
                                        Type: ${item.scenarioType} | Goal: ${item.replyGoal || 'classify'}
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                        Triggers: ${(item.triggerHints || []).slice(0, 3).map(t => `"${escapeHtml(t)}"`).join(', ')}...
                                    </div>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                `;
            }
            
            // Add disabled services notice if any
            if (disabledCategoryCount > 0) {
                html = `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; margin-bottom: 20px;">
                        <i class="fas fa-toggle-off" style="font-size: 18px; color: #ef4444;"></i>
                        <div style="font-size: 13px; color: var(--text-secondary);">
                            <strong style="color: #ef4444;">${disabledCategoryCount} categor${disabledCategoryCount === 1 ? 'y' : 'ies'} disabled</strong> â€” 
                            These services are turned off in Company Local â†’ Services Offered. 
                            <a href="#" onclick="switchTab('company-local'); return false;" style="color: #60a5fa; text-decoration: underline;">Enable them</a> to generate scenarios.
                        </div>
                    </div>
                ` + html;
            }
            
            listEl.innerHTML = html;
            updateSelectedCount();
        }
        
        function toggleBlueprintItem(itemKey) {
            if (selectedBlueprintItems.has(itemKey)) {
                selectedBlueprintItems.delete(itemKey);
            } else {
                selectedBlueprintItems.add(itemKey);
            }
            updateSelectedCount();
        }
        
        function selectAllMissing() {
            if (!blueprintAssessment) return;
            
            // Select all required items
            const required = blueprintAssessment.missingItems.filter(i => i.required !== false);
            
            // Clear and re-add
            selectedBlueprintItems.clear();
            required.forEach(item => selectedBlueprintItems.add(item.itemKey));
            
            // Update checkboxes
            document.querySelectorAll('#missing-items-list input[type="checkbox"]').forEach(cb => {
                cb.checked = selectedBlueprintItems.has(cb.value);
            });
            
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const countEl = document.getElementById('selected-count');
            const btn = document.getElementById('generate-cards-btn');
            
            countEl.textContent = selectedBlueprintItems.size;
            btn.disabled = selectedBlueprintItems.size === 0;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EXPLICIT GENERATION MODE (never inferred, always from button click)
        // Modes: FULL_PACK, REQUIRED_ONLY, MISSING_ONLY, SELECTED
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function generateWithMode(generationMode) {
            if (!blueprintAssessment) {
                showToast('Run assessment first', 'error');
                return;
            }
            
            // Get action details for confirmation
            const action = blueprintAssessment.actions?.[
                generationMode === 'FULL_PACK' ? 'generateFullPack' :
                generationMode === 'REQUIRED_ONLY' ? 'generateRequiredOnly' :
                'generateMissing'
            ];
            
            const estimatedCount = action?.estimatedCards || blueprintAssessment.missingItems?.length || 0;
            
            // Confirm with user (explicit, no accidents)
            const confirmMsg = generationMode === 'FULL_PACK' 
                ? `Generate ALL ${estimatedCount} scenarios for this empty template? This will create a complete blueprint pack.`
                : generationMode === 'REQUIRED_ONLY'
                    ? `Generate ${estimatedCount} REQUIRED scenarios (minimum viable template)?`
                    : `Generate ${estimatedCount} missing scenarios?`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            const btn = event?.target?.closest('button');
            const originalHTML = btn?.innerHTML;
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Generating ${generationMode}...`;
            }
            
            const tradeKey = document.getElementById('blueprint-select').value;
            
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/admin/blueprints/${tradeKey}/generate`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        companyId,
                        generationMode,  // EXPLICIT mode - never inferred
                        maxCards: generationMode === 'FULL_PACK' ? 200 : 100
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error || `Generation failed: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Generation failed');
                }
                
                // Store for export
                generatedBlueprintCards = result.cards || [];
                window.__lastGeneratedCards = result.cards || [];
                window.__lastGeneratorConfig = result.generatorConfig || null;
                window.__lastValidationReport = result.validation || null;
                
                // Show generated cards
                renderGeneratedCards(generatedBlueprintCards, result.validation);
                
                // Show detailed toast
                const truncatedMsg = result.truncated ? ` (truncated from ${result.requestedCount})` : '';
                showToast(`Generated ${result.count} scenarios${truncatedMsg}!`, 'success');
                console.log(`âœ… [BLUEPRINT] ${generationMode}: generated ${result.count} cards`);
                
            } catch (error) {
                console.error(`[BLUEPRINT] ${generationMode} generation error:`, error);
                alert(`Failed to generate (${generationMode}): ${error.message}`);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }
            }
        }
        
        // Legacy function (redirects to explicit mode)
        async function generateFullPack() {
            generateWithMode('FULL_PACK');
        }
        
        async function generateSelectedCards() {
            if (selectedBlueprintItems.size === 0) return;
            
            const btn = document.getElementById('generate-cards-btn');
            const tradeKey = document.getElementById('blueprint-select').value;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/admin/blueprints/${tradeKey}/generate`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        companyId,
                        generationMode: 'SELECTED',  // Explicit mode for manual selection
                        itemKeys: Array.from(selectedBlueprintItems),
                        maxCards: 50
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Generation failed: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Generation failed');
                }
                
                // Store for export
                generatedBlueprintCards = result.cards || [];
                window.__lastGeneratedCards = result.cards || [];
                window.__lastGeneratorConfig = result.generatorConfig || null;
                window.__lastValidationReport = result.validation || null;
                
                // Show generated cards
                renderGeneratedCards(generatedBlueprintCards, result.validation);
                
                // Log validation summary
                if (result.validation) {
                    console.log('âœ… [BLUEPRINT] Generated', result.count, 'cards');
                    console.log('   Validation:', result.validation.passed, 'passed,', result.validation.withWarnings, 'with warnings');
                    if (result.validation.failures?.length > 0) {
                        console.log('   Failures:', result.validation.failures);
                    }
                }
                
            } catch (error) {
                console.error('[BLUEPRINT] Generation error:', error);
                alert('Failed to generate cards: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-magic"></i> Generate Selected (<span id="selected-count">${selectedBlueprintItems.size}</span>)`;
            }
        }
        
        function renderGeneratedCards(cards, validation) {
            if (cards.length === 0) return;
            
            document.getElementById('blueprint-cards-review').style.display = 'block';
            
            // Show validation summary
            const validationSummary = validation ? `
                <div style="display: flex; gap: 16px; margin-bottom: 16px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <span style="color: var(--accent-green);"><i class="fas fa-check-circle"></i> ${validation.passed} passed</span>
                    <span style="color: var(--accent-yellow);"><i class="fas fa-exclamation-triangle"></i> ${validation.withWarnings} warnings</span>
                    <span style="color: var(--accent-red);"><i class="fas fa-times-circle"></i> ${validation.failed} failed</span>
                    <button onclick="copyResultsJson()" style="margin-left: auto; padding: 6px 12px; background: #6366f1; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-copy"></i> Copy Results JSON
                    </button>
                </div>
            ` : '';
            
            const gridEl = document.getElementById('generated-cards-grid');
            gridEl.innerHTML = validationSummary + cards.map((card, idx) => {
                // Find validation result for this card
                const cardValidation = validation?.results?.find(r => r.index === idx);
                const hasWarnings = cardValidation?.warnings?.length > 0;
                const hasErrors = cardValidation?.errors?.length > 0;
                const borderColor = hasErrors ? '#ef4444' : hasWarnings ? '#f59e0b' : '#8b5cf6';
                
                return `
                <div class="gap-card" style="border-left: 4px solid ${borderColor};">
                    <div class="gap-header">
                        <span class="gap-representative">${escapeHtml(card.scenario.name)}</span>
                        <span class="gap-priority ${card.priority === 'high' ? 'high' : card.priority === 'medium' ? 'medium' : 'low'}">
                            ${card.scenario.scenarioType}
                        </span>
                    </div>
                    ${cardValidation ? `
                    <div style="margin: 8px 0; font-size: 12px;">
                        ${cardValidation.passed ? '<span style="color: #4ade80;"><i class="fas fa-check"></i> Passed</span>' : ''}
                        ${hasWarnings ? `<span style="color: #fbbf24;"><i class="fas fa-exclamation-triangle"></i> ${cardValidation.warnings.length} warnings</span>` : ''}
                        ${hasErrors ? `<span style="color: #f87171;"><i class="fas fa-times"></i> ${cardValidation.errors.join(', ')}</span>` : ''}
                    </div>
                    ` : ''}
                    <div class="gap-stats">
                        <span><i class="fas fa-folder"></i> ${escapeHtml(card.categoryName || card.categoryKey)}</span>
                        <span><i class="fas fa-bolt"></i> ${card.scenario.triggers?.length || 0} triggers</span>
                        <span><i class="fas fa-comment"></i> ${card.scenario.quickReplies?.length || 0} quick, ${card.scenario.fullReplies?.length || 0} full</span>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Sample trigger:</div>
                        <div style="font-size: 13px; color: var(--text-secondary); font-style: italic;">
                            "${escapeHtml((card.scenario.triggers || [])[0] || 'N/A')}"
                        </div>
                    </div>
                    <div class="gap-actions" style="margin-top: 12px;">
                        <button class="btn-secondary" onclick="previewBlueprintCard(${idx})">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button class="btn-primary" onclick="loadBlueprintCard(${idx})">
                            <i class="fas fa-plus"></i> Load into Template
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        function previewBlueprintCard(idx) {
            const card = generatedBlueprintCards[idx];
            if (!card) return;
            
            // Create preview object matching the gap format
            const preview = card.scenario;
            currentPreview = preview;
            
            // Populate modal fields
            document.getElementById('preview-name').textContent = preview.name || '(not set)';
            document.getElementById('preview-type').textContent = preview.scenarioType || '(not set)';
            document.getElementById('preview-triggers').innerHTML = (preview.triggers || []).slice(0, 5)
                .map(t => `<span class="trigger-tag">${escapeHtml(t)}</span>`).join('') || '(none)';
            
            document.getElementById('preview-quick').innerHTML = (preview.quickReplies || []).slice(0, 2)
                .map(r => `<li>"${escapeHtml(r)}"</li>`).join('') || '<li>(none)</li>';
            document.getElementById('preview-full').innerHTML = (preview.fullReplies || []).slice(0, 2)
                .map(r => `<li>"${escapeHtml(r)}"</li>`).join('') || '<li>(none)</li>';
            
            // Show preview modal
            document.getElementById('create-modal').classList.add('active');
        }
        
        async function loadBlueprintCard(idx) {
            const card = generatedBlueprintCards[idx];
            if (!card) return;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // USE SAME FLOW AS GAP FILL - Proven "flawless" workflow:
            // 1. Build full scenario object with buildScenarioPrefill
            // 2. Store in sessionStorage
            // 3. Open Global Brain with ?prefill=scenario
            // 4. User clicks "Add Scenario" â†’ form auto-fills all 22 settings
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const cardScenario = card.scenario;
            
            // Include itemKey for tracking
            const previewWithMetadata = {
                ...cardScenario,
                itemKey: card.itemKey,
                source: 'blueprint-builder'
            };
            
            // Convert blueprint card to same format as Gap preview
            const scenarioData = buildScenarioPrefill(previewWithMetadata, {});
            
            // Store in sessionStorage for Global Brain to pick up
            sessionStorage.setItem('scenarioPrefill', JSON.stringify(scenarioData));
            
            // Open Global Brain with prefill flag (same as Gap Fill flow)
            window.open('/admin-global-instant-responses.html?prefill=scenario', '_blank');
            
            showToast('Opening Global Brain with pre-filled data...', 'success');
        }
        
        function clearGeneratedCards() {
            generatedBlueprintCards = [];
            document.getElementById('blueprint-cards-review').style.display = 'none';
            document.getElementById('generated-cards-grid').innerHTML = '';
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BLUEPRINT COPY / DOWNLOAD / IMPORT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function toPrettyJson(obj) {
            return JSON.stringify(obj, null, 2);
        }
        
        async function copyToClipboardWithToast(text, label) {
            try {
                await navigator.clipboard.writeText(text);
                showToast(`${label} copied to clipboard`, 'success');
            } catch (err) {
                console.error('Copy failed:', err);
                showToast('Copy failed - try again', 'error');
            }
        }
        
        function downloadJson(obj, filename) {
            const blob = new Blob([toPrettyJson(obj)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            showToast(`Downloaded ${filename}`, 'success');
        }
        
        async function copyBlueprintSpec() {
            if (!window.__lastBlueprintSpec) {
                showToast('Run "Assess Coverage" first to load the blueprint', 'error');
                return;
            }
            await copyToClipboardWithToast(toPrettyJson(window.__lastBlueprintSpec), 'Blueprint Spec JSON');
        }
        
        async function copyBlueprintAssess() {
            if (!window.__lastBlueprintAssess) {
                showToast('Run "Assess Coverage" first', 'error');
                return;
            }
            await copyToClipboardWithToast(toPrettyJson(window.__lastBlueprintAssess), 'Assessment JSON');
        }
        
        async function copyResultsJson() {
            const resultsExport = buildResultsExport();
            if (!resultsExport) return;
            await copyToClipboardWithToast(toPrettyJson(resultsExport), 'Results JSON (full export)');
        }
        
        function downloadBlueprintSpec() {
            if (!window.__lastBlueprintSpec) {
                showToast('Run "Assess Coverage" first', 'error');
                return;
            }
            const tradeKey = document.getElementById('blueprint-select').value;
            downloadJson(window.__lastBlueprintSpec, `blueprint-${tradeKey}-spec.json`);
        }
        
        function downloadBlueprintAssess() {
            if (!window.__lastBlueprintAssess) {
                showToast('Run "Assess Coverage" first', 'error');
                return;
            }
            const tradeKey = document.getElementById('blueprint-select').value;
            downloadJson(window.__lastBlueprintAssess, `blueprint-${tradeKey}-assess.json`);
        }
        
        function downloadResultsJson() {
            const tradeKey = document.getElementById('blueprint-select').value;
            const resultsExport = buildResultsExport();
            if (!resultsExport) return;
            downloadJson(resultsExport, `blueprint-${tradeKey}-results-${Date.now()}.json`);
        }
        
        function buildResultsExport() {
            if (!window.__lastBlueprintSpec && !window.__lastBlueprintAssess) {
                showToast('Run "Assess Coverage" first', 'error');
                return null;
            }
            
            const tradeKey = document.getElementById('blueprint-select').value;
            
            return {
                _format: 'BlueprintResultsExportV1',
                tradeKey,
                companyId,
                generatedAt: new Date().toISOString(),
                blueprint: window.__lastBlueprintSpec?.spec || window.__lastBlueprintSpec,
                assessment: window.__lastBlueprintAssess ? {
                    coverage: window.__lastBlueprintAssess.coverage,
                    missingCount: window.__lastBlueprintAssess.missingItems?.length || 0,
                    coveredCount: window.__lastBlueprintAssess.matchedItems?.length || 0,
                    weakCoverage: window.__lastBlueprintAssess.weakCoverage,
                    duplicates: window.__lastBlueprintAssess.duplicates
                } : null,
                generatorConfig: window.__lastGeneratorConfig,
                generatedCards: window.__lastGeneratedCards ? {
                    count: window.__lastGeneratedCards.length,
                    cards: window.__lastGeneratedCards.map(c => ({
                        itemKey: c.itemKey,
                        scenario: c.scenario,
                        categoryKey: c.categoryKey
                    })),
                    validation: window.__lastValidationReport
                } : null
            };
        }
        
        // Dropdown toggle functions
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const isVisible = dropdown.style.display !== 'none';
            
            // Hide all dropdowns first
            hideDropdowns();
            
            // Toggle this one
            if (!isVisible) {
                dropdown.style.display = 'block';
            }
        }
        
        function hideDropdowns() {
            document.querySelectorAll('.dropdown-menu').forEach(d => d.style.display = 'none');
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.json-dropdown')) {
                hideDropdowns();
            }
        });
        
        function openImportBlueprintModal() {
            document.getElementById('import-blueprint-modal').classList.add('active');
            document.getElementById('import-blueprint-json').value = '';
            document.getElementById('import-blueprint-error').style.display = 'none';
            document.getElementById('import-blueprint-success').style.display = 'none';
            document.getElementById('btn-load-imported').disabled = true;
        }
        
        function closeImportBlueprintModal() {
            document.getElementById('import-blueprint-modal').classList.remove('active');
        }
        
        function validateImportedBlueprint() {
            const textarea = document.getElementById('import-blueprint-json');
            const errorEl = document.getElementById('import-blueprint-error');
            const successEl = document.getElementById('import-blueprint-success');
            const loadBtn = document.getElementById('btn-load-imported');
            
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            loadBtn.disabled = true;
            
            try {
                const json = JSON.parse(textarea.value);
                
                // Basic validation
                const errors = [];
                if (!json.blueprintId && !json.spec?.blueprintId) errors.push('Missing blueprintId');
                if (!json.tradeKey && !json.spec?.tradeKey) errors.push('Missing tradeKey');
                if (!json.categories && !json.spec?.categories) errors.push('Missing categories array');
                
                const spec = json.spec || json;
                const categories = spec.categories || [];
                let itemCount = 0;
                categories.forEach(cat => {
                    itemCount += (cat.items || []).length;
                });
                
                if (itemCount === 0) errors.push('No blueprint items found');
                
                if (errors.length > 0) {
                    errorEl.textContent = 'Validation errors: ' + errors.join(', ');
                    errorEl.style.display = 'block';
                    return;
                }
                
                // Valid!
                successEl.innerHTML = `<i class="fas fa-check-circle"></i> Valid blueprint: ${spec.name || spec.tradeKey} with ${itemCount} items across ${categories.length} categories`;
                successEl.style.display = 'block';
                loadBtn.disabled = false;
                
            } catch (e) {
                errorEl.textContent = 'Invalid JSON: ' + e.message;
                errorEl.style.display = 'block';
            }
        }
        
        function loadImportedBlueprint() {
            const textarea = document.getElementById('import-blueprint-json');
            
            try {
                const json = JSON.parse(textarea.value);
                const spec = json.spec || json;
                
                // Store as last blueprint spec
                window.__lastBlueprintSpec = json;
                
                // Close modal
                closeImportBlueprintModal();
                
                showToast(`Loaded blueprint: ${spec.name || spec.tradeKey}`, 'success');
                console.log('âœ… [BLUEPRINT] Imported spec:', spec.tradeKey, 'with', (spec.categories || []).reduce((sum, c) => sum + (c.items?.length || 0), 0), 'items');
                
            } catch (e) {
                showToast('Failed to load: ' + e.message, 'error');
            }
        }
        
        // ========================================
        // SCENARIO REVIEW MODAL
        // ========================================
        function openScenarioReview(scenarioIdx) {
            const scenario = window.auditScenarios[scenarioIdx];
            if (!scenario) return;
            
            currentReviewScenarioIdx = scenarioIdx;
            
            // Update modal header
            document.getElementById('review-scenario-name').textContent = scenario.name;
            document.getElementById('review-issue-count').textContent = 
                `${scenario.violations.length} issue${scenario.violations.length !== 1 ? 's' : ''}`;
            
            // Build left column (current data)
            const currentDataEl = document.getElementById('review-current-data');
            currentDataEl.innerHTML = buildCurrentDataView(scenario);
            
            // Build right column (audit results)
            const auditResultsEl = document.getElementById('review-audit-results');
            auditResultsEl.innerHTML = buildAuditResultsView(scenario);
            
            // Show modal
            document.getElementById('scenario-review-modal').classList.add('active');
        }
        
        function buildCurrentDataView(scenario) {
            // Get full scenario data from audit result
            const fullScenario = window.fullAuditResult?.scenarios?.find(
                s => s.scenarioId === scenario.scenarioId
            ) || scenario;
            
            // Find the matching scenario in raw data if needed
            let rawScenario = fullScenario;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // FIELD DEFINITIONS - Only show CONTENT-OWNED fields
            // Note: followUpMode and actionType are RUNTIME-owned, not content
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const fields = [
                { key: 'name', label: 'Name', icon: 'fa-tag', required: true, ownership: 'content' },
                { key: 'scenarioType', label: 'Type', icon: 'fa-folder', required: true, ownership: 'content' },
                { key: 'category', label: 'Category', icon: 'fa-list', required: false, ownership: 'content' },
                { key: 'behavior', label: 'Behavior', icon: 'fa-user', required: false, ownership: 'content' },
                { key: 'minConfidence', label: 'Min Confidence', icon: 'fa-chart-line', required: false, ownership: 'content' },
                { key: 'triggers', label: 'Triggers', icon: 'fa-bolt', isArray: true, limit: 5, required: true, ownership: 'content' },
                { key: 'quickReplies', label: 'Quick Replies', icon: 'fa-comment', isArray: true, required: true, ownership: 'content' },
                { key: 'fullReplies', label: 'Full Replies', icon: 'fa-comments', isArray: true, required: false, ownership: 'content' }
                // REMOVED: followUpMode and actionType - these are RUNTIME-owned, not content
            ];
            
            return fields.map(field => {
                let value = rawScenario[field.key];
                let displayValue = '';
                
                // Determine if value is "present" (for required checks)
                const isPresent = field.isArray 
                    ? Array.isArray(value) && value.length > 0
                    : value !== undefined && value !== null && value !== '';
                
                if (field.isArray && Array.isArray(value)) {
                    const items = field.limit ? value.slice(0, field.limit) : value;
                    displayValue = items.map((item, i) => 
                        `<div style="padding: 6px 10px; background: rgba(255,255,255,0.08); border-radius: 6px; margin: 4px 0; font-size: 13px; color: #fff;">
                            <span style="color: #a78bfa; font-weight: 600;">[${i}]</span> ${escapeHtml(typeof item === 'string' ? item : JSON.stringify(item))}
                        </div>`
                    ).join('');
                    if (field.limit && value.length > field.limit) {
                        displayValue += `<div style="font-size: 12px; color: #a78bfa; padding: 4px;">+${value.length - field.limit} more</div>`;
                    }
                } else if (!isPresent) {
                    displayValue = `<span style="color: #888; font-style: italic;">(not set)</span>`;
                } else {
                    displayValue = `<span style="color: #fff; font-weight: 500;">${escapeHtml(value?.toString())}</span>`;
                }
                
                // Check if this field has violations
                const fieldViolations = scenario.violations.filter(v => 
                    v.field === field.key || v.field.startsWith(field.key + '[')
                );
                const hasIssue = fieldViolations.length > 0;
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // STATUS LOGIC (corrected):
                //   - hasIssue â†’ red border, show issue count
                //   - required && !isPresent â†’ red border, show âŒ (missing required)
                //   - isPresent && !hasIssue â†’ green border, show âœ“
                //   - !required && !isPresent && !hasIssue â†’ gray border, show â€” (optional, not set)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                let borderColor = '#22c55e'; // green
                let statusIcon = '<span style="color: #4ade80;">âœ“</span>';
                
                if (hasIssue) {
                    borderColor = '#ef4444'; // red
                    statusIcon = `<span style="color: #f87171;">(${fieldViolations.length} issue${fieldViolations.length > 1 ? 's' : ''})</span>`;
                } else if (field.required && !isPresent) {
                    borderColor = '#ef4444'; // red - required but missing
                    statusIcon = '<span style="color: #f87171;">âŒ required</span>';
                } else if (!isPresent) {
                    borderColor = '#6b7280'; // gray - optional, not set
                    statusIcon = '<span style="color: #9ca3af;">â€”</span>';
                }
                
                return `
                    <div style="margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid ${borderColor};">
                        <div style="font-size: 13px; color: #c4b5fd; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; font-weight: 600;">
                            <i class="fas ${field.icon}"></i> ${field.label}
                            ${statusIcon}
                        </div>
                        <div style="font-size: 13px; line-height: 1.5;">
                            ${displayValue}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function buildAuditResultsView(scenario) {
            if (!scenario.violations || scenario.violations.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: var(--accent-green);">
                        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <h3>All Checks Passed!</h3>
                        <p style="color: var(--text-muted);">This scenario meets all dispatcher guidelines.</p>
                    </div>
                `;
            }
            
            // Group violations by field
            const byField = {};
            scenario.violations.forEach(v => {
                const fieldKey = v.field.split('[')[0]; // Group array items together
                if (!byField[fieldKey]) byField[fieldKey] = [];
                byField[fieldKey].push(v);
            });
            
            return Object.entries(byField).map(([fieldKey, violations]) => `
                <div style="margin-bottom: 16px; padding: 14px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.3);">
                    <div style="font-weight: 700; margin-bottom: 10px; color: #f87171; font-size: 14px;">
                        <i class="fas fa-exclamation-triangle"></i> ${escapeHtml(fieldKey)}
                    </div>
                    ${violations.map(v => `
                        <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${v.severity === 'error' ? '#ef4444' : v.severity === 'warning' ? '#eab308' : '#3b82f6'};">
                            <div style="font-size: 13px; margin-bottom: 6px; color: #fff; font-weight: 500;">${escapeHtml(v.message)}</div>
                            ${v.value ? `<div style="font-size: 12px; color: #d1d5db; font-family: monospace; background: rgba(0,0,0,0.4); padding: 6px 8px; border-radius: 6px; margin-bottom: 6px; word-break: break-word;">Current: "${escapeHtml(v.value?.toString().substring(0, 80))}${v.value?.toString().length > 80 ? '...' : ''}"</div>` : ''}
                            ${v.suggestion ? `<div style="font-size: 13px; color: #4ade80; font-weight: 500;"><i class="fas fa-lightbulb"></i> ${escapeHtml(v.suggestion)}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Copy Audit Data to Clipboard (for verification)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function copyAuditToClipboard(event) {
            if (currentReviewScenarioIdx === null || !window.auditScenarios) {
                alert('No scenario data to copy');
                return;
            }
            
            const scenario = window.auditScenarios[currentReviewScenarioIdx];
            const violations = scenario.violations || [];
            
            // Build a clean text representation
            let text = `=== SCENARIO AUDIT: ${scenario.name || scenario.scenarioName} ===\n`;
            text += `ID: ${scenario.scenarioId}\n`;
            text += `Type: ${scenario.scenarioType || 'N/A'}\n`;
            const categoryLabel = scenario.category || (Array.isArray(scenario.categories) ? scenario.categories[0] : 'N/A');
            text += `Category: ${categoryLabel}\n`;
            text += `Total Issues: ${violations.length}\n`;
            text += `\n--- VIOLATIONS ---\n\n`;
            
            for (const v of violations) {
                text += `[${v.severity || 'WARN'}] ${v.field}\n`;
                text += `  Message: ${v.message}\n`;
                if (v.value) {
                    const valueStr = typeof v.value === 'string' 
                        ? v.value.substring(0, 100) 
                        : JSON.stringify(v.value).substring(0, 100);
                    text += `  Current: "${valueStr}${valueStr.length >= 100 ? '...' : ''}"\n`;
                }
                if (v.suggestion) {
                    text += `  Suggestion: ${v.suggestion}\n`;
                }
                text += `\n`;
            }
            
            text += `\n--- RAW JSON ---\n`;
            text += JSON.stringify({
                scenarioId: scenario.scenarioId,
                name: scenario.name || scenario.scenarioName,
                scenarioType: scenario.scenarioType,
                violationCount: violations.length,
                violations: violations.map(v => ({
                    field: v.field,
                    severity: v.severity,
                    message: v.message,
                    value: v.value,
                    suggestion: v.suggestion
                }))
            }, null, 2);
            
            try {
                await navigator.clipboard.writeText(text);
                // Show quick feedback
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.style.background = '#22c55e';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = '#6366f1';
                }, 1500);
            } catch (err) {
                console.error('Copy failed:', err);
                alert('Failed to copy. Please try again.');
            }
        }
        
        function closeScenarioReview() {
            document.getElementById('scenario-review-modal').classList.remove('active');
            currentReviewScenarioIdx = null;
        }
        
        function skipScenarioReview() {
            // Move to next scenario with issues
            if (currentReviewScenarioIdx !== null && window.auditScenarios) {
                const nextIdx = currentReviewScenarioIdx + 1;
                if (nextIdx < window.auditScenarios.length) {
                    openScenarioReview(nextIdx);
                } else {
                    closeScenarioReview();
                    showToast('All scenarios reviewed!', 'success');
                }
            } else {
                closeScenarioReview();
            }
        }
        
        async function approveAndFixScenario() {
            const scenario = window.auditScenarios[currentReviewScenarioIdx];
            if (!scenario) return;
            
            const btn = document.getElementById('approve-fix-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fixing all issues...';
            
            try {
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/audit/fix-scenario`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scenarioId: scenario.scenarioId,
                        violations: scenario.violations
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`Fixed ${result.fixesApplied} issues in "${scenario.name}"`, 'success');
                    
                    // Remove this scenario from the list
                    window.auditScenarios.splice(currentReviewScenarioIdx, 1);
                    
                    // Update the violations list UI
                    displayAuditResults(window.fullAuditResult);
                    
                    // Move to next scenario or close
                    if (window.auditScenarios.length > 0) {
                        const nextIdx = Math.min(currentReviewScenarioIdx, window.auditScenarios.length - 1);
                        openScenarioReview(nextIdx);
                    } else {
                        closeScenarioReview();
                        showToast('All scenarios fixed!', 'success');
                    }
                } else {
                    throw new Error(result.error || 'Fix failed');
                }
                
            } catch (error) {
                console.error('Fix error:', error);
                showToast('Fix failed: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Approve & Auto-Fix All';
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // REVIEW & FIX IN GLOBAL BRAIN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Mirrors the Gap Fill flow: Generate fixes â†’ Build prefill â†’ Open Global Brain
        // Admin reviews the fixed scenario in the edit form and manually saves
        // NO AUTO-SAVE - Admin has full control over what gets saved
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function reviewAndFixInGlobalBrain() {
            const scenario = window.auditScenarios[currentReviewScenarioIdx];
            if (!scenario) {
                showToast('No scenario selected', 'error');
                return;
            }
            
            const btn = document.getElementById('review-in-gb-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating fixes...';
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // OPEN WINDOW IMMEDIATELY (before async) to avoid popup blocker
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Browser popup blockers allow popups from direct user clicks.
            // If we wait for async fetch, the popup is blocked.
            // Solution: Open blank window now, update URL after fetch completes.
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const loadingHtml = `
                <html>
                <head><title>Loading Template Audit Fix...</title></head>
                <body style="background: #1a1a2e; color: white; font-family: system-ui; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0;">
                    <div style="text-align: center;">
                        <div style="font-size: 48px; animation: spin 1s linear infinite;">âš™ï¸</div>
                        <h2 style="margin-top: 20px;">Generating fixes...</h2>
                        <p style="color: #888;">Please wait while AI fixes are being generated</p>
                    </div>
                    <style>@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>
                </body>
                </html>
            `;
            const newWindow = window.open('about:blank', '_blank');
            if (newWindow) {
                newWindow.document.write(loadingHtml);
                newWindow.document.close();
            }
            
            try {
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // STEP 1: Generate fixes WITHOUT saving (mirrors Gap Fill approach)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                console.log('ðŸ“‹ [AUDITâ†’GB] Generating fixes for scenario:', scenario.name);
                
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/audit/generate-fix`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scenarioId: scenario.scenarioId,
                        violations: scenario.violations
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to generate fixes');
                }
                
                console.log('âœ… [AUDITâ†’GB] Fixes generated:', {
                    fixCount: result.fixes?.length || 0,
                    navigation: result.navigation
                });
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // STEP 2: Build prefill data for Global Brain edit form
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const prefillData = buildEditScenarioPrefill(result.fixedScenario, result.navigation, result.fixes);
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // STEP 3: Store in localStorage (more reliable for cross-tab sharing)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // Using localStorage instead of sessionStorage for better cross-tab reliability
                localStorage.setItem('scenarioEditPrefill', JSON.stringify(prefillData));
                
                // Also store company ID so Global Brain can return to the right audit page
                localStorage.setItem('lastAuditCompanyId', companyId);
                
                console.log('ðŸ“¦ [AUDITâ†’GB] Prefill data stored in localStorage');
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // STEP 4: Navigate the already-opened window to Global Brain
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const gbUrl = `/admin-global-instant-responses.html?prefill=edit-scenario&templateId=${result.navigation.templateId}&categoryId=${result.navigation.categoryId}&scenarioId=${result.navigation.scenarioId}`;
                
                console.log('ðŸš€ [AUDITâ†’GB] Navigating to Global Brain:', gbUrl);
                
                if (newWindow && !newWindow.closed) {
                    // Navigate the pre-opened window to Global Brain
                    newWindow.location.href = gbUrl;
                    closeScenarioReview();
                    showToast(`Opening Global Brain with ${result.fixes?.length || 0} fixes applied - review and save!`, 'success');
                } else {
                    // Window was closed or blocked - show manual link
                    showToast('Window was closed. Click the link below to open Global Brain.', 'error');
                    
                    const linkContainer = document.createElement('div');
                    linkContainer.id = 'gb-manual-link';
                    linkContainer.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
                        border: 2px solid #8b5cf6;
                        border-radius: 16px;
                        padding: 32px;
                        z-index: 20000;
                        text-align: center;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                        max-width: 500px;
                    `;
                    linkContainer.innerHTML = `
                        <div style="color: #f87171; font-size: 24px; margin-bottom: 16px;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 style="color: white; margin-bottom: 12px;">Window Closed</h3>
                        <p style="color: #a0a0b0; margin-bottom: 20px; font-size: 14px;">
                            Click the button below to open Global Brain.
                            <br><br>
                            <strong style="color: #10b981;">${result.fixes?.length || 0} fixes are ready!</strong>
                        </p>
                        <a href="${gbUrl}" target="_blank" 
                           onclick="document.getElementById('gb-manual-link').remove();"
                           style="
                               display: inline-block;
                               background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
                               color: white;
                               padding: 14px 28px;
                               border-radius: 10px;
                               text-decoration: none;
                               font-weight: 600;
                               font-size: 16px;
                           ">
                            <i class="fas fa-external-link-alt"></i> Open Global Brain
                        </a>
                        <button onclick="document.getElementById('gb-manual-link').remove();" 
                                style="
                                    display: block;
                                    margin: 16px auto 0;
                                    background: transparent;
                                    border: 1px solid #666;
                                    color: #888;
                                    padding: 8px 16px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                ">
                            Cancel
                        </button>
                    `;
                    document.body.appendChild(linkContainer);
                }
                
            } catch (error) {
                console.error('âŒ [AUDITâ†’GB] Error:', error);
                showToast('Failed to generate fixes: ' + error.message, 'error');
                
                // Close the pre-opened window on error
                if (newWindow && !newWindow.closed) {
                    newWindow.close();
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-external-link-alt"></i> Review & Fix in Global Brain';
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BUILD EDIT SCENARIO PREFILL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Builds prefill data for EDITING an existing scenario (not creating new)
        // Includes fixed content + navigation info + fix metadata
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function buildEditScenarioPrefill(fixedScenario, navigation, fixes) {
            const s = fixedScenario || {};
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // EDIT PREFILL STRUCTURE (different from Gap Fill's create prefill)
            // - mode: 'edit' (vs 'create' for Gap Fill)
            // - Contains scenarioId for update (not insert)
            // - Contains navigation for Global Brain to find the right scenario
            // - Contains fix metadata for transparency
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            return {
                mode: 'edit',  // Critical: tells Global Brain this is an EDIT, not ADD
                
                // Navigation (how to find the scenario in Global Brain)
                navigation: {
                    templateId: navigation.templateId,
                    templateName: navigation.templateName,
                    categoryId: navigation.categoryId,
                    categoryIndex: navigation.categoryIndex,
                    categoryName: navigation.categoryName,
                    scenarioIndex: navigation.scenarioIndex,
                    scenarioId: navigation.scenarioId
                },
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // CONTENT FIELDS (the fixed values to prefill)
                // Same structure as Gap Fill's buildScenarioPrefill()
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                scenario: {
                    // Identity
                    name: s.name || '',
                    status: s.status || 'live',
                    category: s.categories?.[0] || navigation.categoryName || '',
                    categories: Array.isArray(s.categories) ? s.categories : [],
                    scenarioType: s.scenarioType || 'FAQ',
                    isActive: s.isActive !== false,
                    
                    // Personality
                    behavior: s.behavior || 'calm_professional',
                    
                    // Priority & Confidence
                    priority: typeof s.priority === 'number' ? s.priority : 0,
                    minConfidence: typeof s.minConfidence === 'number' ? s.minConfidence : 0.6,
                    contextWeight: typeof s.contextWeight === 'number' ? s.contextWeight : 0.7,
                    
                    // Triggers
                    triggers: Array.isArray(s.triggers) ? s.triggers : [],
                    regexTriggers: Array.isArray(s.regexTriggers) ? s.regexTriggers : [],
                    negativeTriggers: Array.isArray(s.negativeTriggers) ? s.negativeTriggers : [],
                    exampleUserPhrases: Array.isArray(s.exampleUserPhrases) ? s.exampleUserPhrases : [],
                    negativeUserPhrases: Array.isArray(s.negativeUserPhrases) ? s.negativeUserPhrases : [],
                    
                    // Replies (THE MAIN FIELDS THAT GET FIXED)
                    quickReplies: Array.isArray(s.quickReplies) ? s.quickReplies : [],
                    fullReplies: Array.isArray(s.fullReplies) ? s.fullReplies : [],
                    quickReplies_noName: Array.isArray(s.quickReplies_noName) ? s.quickReplies_noName : [],
                    fullReplies_noName: Array.isArray(s.fullReplies_noName) ? s.fullReplies_noName : [],
                    replyStrategy: s.replyStrategy || 'AUTO',
                    replySelection: s.replySelection || 'random',
                    
                    // Intent & Entities
                    bookingIntent: s.bookingIntent === true,
                    entityCapture: Array.isArray(s.entityCapture) ? s.entityCapture : [],
                    
                    // Channel & Language
                    channel: s.channel || 'any',
                    language: s.language || 'auto',
                    
                    // Follow-up (runtime-owned, but included for completeness)
                    followUpMode: s.followUpMode || 'NONE',
                    followUpFunnel: s.followUpFunnel || '',
                    followUpQuestionText: s.followUpQuestionText || '',
                    
                    // Advanced
                    notes: s.notes || '',
                    handoffPolicy: s.handoffPolicy || 'low_confidence',
                    cooldownSeconds: s.cooldownSeconds || 0,
                    dynamicVariables: s.dynamicVariables || {},
                    entityValidation: s.entityValidation || {},
                    timedFollowUp: s.timedFollowUp || {},
                    silencePolicy: s.silencePolicy || {},
                    ttsOverride: s.ttsOverride || {},
                    preconditions: s.preconditions || {},
                    effects: s.effects || {}
                },
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // FIX METADATA (for transparency and audit trail)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                auditFix: {
                    source: 'template-audit',
                    fixedAt: new Date().toISOString(),
                    fixCount: fixes?.length || 0,
                    fixes: (fixes || []).map(f => ({
                        field: f.field,
                        oldValue: f.oldValue,
                        newValue: f.newValue,
                        severity: f.severity,
                        message: f.message
                    }))
                }
            };
        }
        
        // ========================================
        // AUTO-FIX FUNCTIONS
        // ========================================
        async function generateFix(violationIdx) {
            const violation = window.auditViolations[violationIdx];
            if (!violation) return;
            
            const btn = document.getElementById(`fix-btn-${violationIdx}`);
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            
            try {
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/audit/fix`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scenarioId: violation.scenarioId,
                        scenarioName: violation.scenarioName,
                        field: violation.field,
                        currentValue: violation.value,
                        ruleId: violation.ruleId,
                        message: violation.message,
                        suggestion: violation.suggestion
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Fix generation failed');
                }
                
                const result = await response.json();
                
                // Show preview
                const previewEl = document.getElementById(`fix-preview-${violationIdx}`);
                previewEl.style.display = 'block';
                previewEl.innerHTML = `
                    <div class="fix-preview">
                        <div class="fix-preview-label">AI Suggested Fix</div>
                        <div class="fix-preview-content">${escapeHtml(result.suggestedFix)}</div>
                        <div class="fix-preview-actions">
                            <button class="apply-fix-btn" onclick="applyFix(${violationIdx}, '${escapeAttr(result.suggestedFix)}')">
                                <i class="fas fa-check"></i> Apply Fix
                            </button>
                            <button class="cancel-fix-btn" onclick="cancelFix(${violationIdx})">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                
                btn.innerHTML = '<i class="fas fa-check"></i> Fix Generated';
                
            } catch (error) {
                console.error('Fix generation error:', error);
                showToast('Fix failed: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Auto-Fix with AI';
            }
        }
        
        async function applyFix(violationIdx, suggestedFix) {
            const violation = window.auditViolations[violationIdx];
            if (!violation) return;
            
            try {
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/audit/apply-fix`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scenarioId: violation.scenarioId,
                        field: violation.field,
                        newValue: suggestedFix
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Apply fix failed');
                }
                
                // Mark as fixed
                const card = document.getElementById(`violation-${violationIdx}`);
                card.style.opacity = '0.5';
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; color: var(--accent-green);">
                        <i class="fas fa-check-circle" style="font-size: 24px;"></i>
                        <div>
                            <strong>${escapeHtml(violation.scenarioName)}</strong>
                            <div style="font-size: 13px; color: var(--text-secondary);">Fixed successfully!</div>
                        </div>
                    </div>
                `;
                
                showToast('Fix applied successfully!', 'success');
                
            } catch (error) {
                console.error('Apply fix error:', error);
                showToast('Failed to apply fix: ' + error.message, 'error');
            }
        }
        
        function cancelFix(violationIdx) {
            const previewEl = document.getElementById(`fix-preview-${violationIdx}`);
            previewEl.style.display = 'none';
            
            const btn = document.getElementById(`fix-btn-${violationIdx}`);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> Auto-Fix with AI';
        }
        
        function escapeAttr(text) {
            if (!text) return '';
            return text.replace(/'/g, "\\'").replace(/\n/g, '\\n');
        }

        function getAuthToken() {
            return localStorage.getItem('adminToken')
                || localStorage.getItem('token')
                || sessionStorage.getItem('token');
        }

        function goBackToControlPlane() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('companyId') || companyId;
            if (id) {
                window.location.href = `/control-plane-v2.html?companyId=${encodeURIComponent(id)}`;
            } else {
                window.location.href = '/control-plane-v2.html';
            }
        }
        
        // ========================================
        // INIT
        // ========================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Get company ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            companyId = urlParams.get('companyId');
            
            if (!companyId) {
                showError('No company ID provided');
                return;
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // LOAD REGISTRY FIRST (Single Source of Truth)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            await loadRegistry();
            
            // Setup period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const newDays = parseInt(btn.dataset.days);
                    if (newDays === selectedDays) return; // Skip if same period
                    
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedDays = newDays;
                    
                    // Visual feedback: flash the summary cards
                    document.querySelectorAll('.summary-card').forEach(card => {
                        card.style.opacity = '0.5';
                    });
                    
                    loadGaps();
                });
            });
            
            loadGaps();
            loadManualTrades();
            loadManualCategories();
            
            // Load wiring stats for Template Audit tab
            loadWiringStats();

            const allowWarningsEl = document.getElementById('manual-allow-warnings');
            if (allowWarningsEl) {
                allowWarningsEl.addEventListener('change', updateManualSaveState);
            }
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WIRING STATS - Load service counts for the Agent Wiring Status panel
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadWiringStats() {
            try {
                // Load services config to get enabled/disabled count
                const servicesResponse = await fetch(`/api/admin/scenario-gaps/${companyId}/services-config`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (servicesResponse.ok) {
                    const config = await servicesResponse.json();
                    updateWiringServiceCounts(config.enabledServiceKeys?.length || 0);
                }
                
                // Load company config to get Company Local count
                const companyResponse = await fetch(`/api/admin/scenario-gaps/${companyId}/local-config`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (companyResponse.ok) {
                    const companyConfig = await companyResponse.json();
                    const customTemplateId = companyConfig.customTemplateId;
                    
                    if (customTemplateId) {
                        // Fetch the custom template to count scenarios
                        const templatesResponse = await fetch('/api/admin/global-instant-responses', {
                            headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                        });
                        
                        if (templatesResponse.ok) {
                            const result = await templatesResponse.json();
                            const templates = result.data || result;
                            const customTemplate = templates.find(t => t._id === customTemplateId);
                            
                            if (customTemplate) {
                                let scenarioCount = 0;
                                (customTemplate.categories || []).forEach(cat => {
                                    scenarioCount += (cat.scenarios || []).length;
                                });
                                updateWiringLocalCount(scenarioCount);
                            }
                        }
                    } else {
                        updateWiringLocalCount(0);
                    }
                }
            } catch (error) {
                console.warn('[WIRING STATS] Failed to load:', error);
            }
        }
        
        // ========================================
        // API CALLS
        // ========================================
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GAP FILL SERVICE AWARENESS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Separate True Gaps (missing scenarios) from Disabled Service Requests (expected declines)
        let gapFillServicesConfig = null;
        
        async function loadGapFillServicesConfig() {
            try {
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/services-config`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                if (response.ok) {
                    gapFillServicesConfig = await response.json();
                }
            } catch (error) {
                console.warn('[GAP FILL] Failed to load services config:', error);
            }
        }
        
        function detectDisabledServiceInGap(gapText) {
            if (!gapFillServicesConfig || !gapFillServicesConfig.services) return null;
            
            const normalizedText = gapText.toLowerCase().replace(/[^\w\s]/g, ' ');
            
            for (const [serviceKey, service] of Object.entries(gapFillServicesConfig.services)) {
                if (service.enabled) continue; // Only check disabled services
                
                const keywords = service.keywords || [];
                for (const keyword of keywords) {
                    if (normalizedText.includes(keyword.toLowerCase())) {
                        return {
                            serviceKey,
                            categoryName: service.categoryName || serviceKey,
                            matchedKeyword: keyword
                        };
                    }
                }
            }
            return null;
        }
        
        async function loadGaps() {
            document.getElementById('gaps-content').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 16px; color: var(--text-secondary);">Analyzing call patterns...</p>
                </div>
            `;
            
            try {
                const token = getAuthToken();
                
                // Check if token exists
                if (!token) {
                    showError('Not logged in. Please log in from the Control Plane first, then click the Gaps tab again.');
                    return;
                }
                
                // Load services config for service-aware gap filtering
                await loadGapFillServicesConfig();
                
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/gaps?days=${selectedDays}&minCalls=2`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 401) {
                    showError('Session expired. Please log in again from the Control Plane.');
                    return;
                }
                
                if (!response.ok) throw new Error('Failed to load gaps');
                
                const data = await response.json();
                
                document.getElementById('company-name').textContent = data.companyName || 'Company';
                currentGaps = data.gaps || [];
                
                // Update gaps count badge
                document.getElementById('gaps-count').textContent = currentGaps.length;
                
                renderSummary(data.summary);
                renderGaps(data.gaps);
                
            } catch (error) {
                console.error('Error loading gaps:', error);
                showError('Failed to load scenario gaps');
            }
        }

        // ========================================
        // MANUAL SCENARIO BUILDER
        // ========================================
        let manualPreview = null;
        let manualValidation = null;

        async function loadManualTrades() {
            try {
                const token = getAuthToken();
                if (!token) return;
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/manual/meta`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) return;
                const data = await response.json();
                if (!data.success) return;

                const tradeRow = document.getElementById('manual-trade-row');
                const tradeSelect = document.getElementById('manual-trade');
                if (!tradeRow || !tradeSelect) return;

                const trades = Array.isArray(data.trades) ? data.trades : [];
                if (trades.length === 0) {
                    tradeRow.style.display = 'none';
                    tradeSelect.innerHTML = '<option value="">Default</option>';
                    return;
                }

                tradeRow.style.display = trades.length > 1 ? 'block' : 'none';
                tradeSelect.innerHTML = trades.map((t, idx) => {
                    const key = t.key || '';
                    const label = t.label || t.key || 'Trade';
                    const selected = data.primaryTrade && data.primaryTrade.toLowerCase() === key.toLowerCase();
                    return `<option value="${escapeHtml(key)}"${selected ? ' selected' : ''}>${escapeHtml(label)}</option>`;
                }).join('');
            } catch (error) {
                console.error('Error loading manual trades:', error);
            }
        }

        // Store template data for reuse
        let manualBuilderTemplateData = null;
        
        async function loadManualCategories() {
            const templateNameEl = document.getElementById('manual-template-name');
            const categoryCountEl = document.getElementById('manual-category-count');
            const select = document.getElementById('manual-category');
            
            try {
                const token = getAuthToken();
                if (!token) {
                    if (templateNameEl) templateNameEl.textContent = 'Not logged in';
                    return;
                }
                
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/scenarios`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    const errData = await response.json();
                    console.error('Failed to load categories:', errData);
                    if (templateNameEl) templateNameEl.textContent = errData.message || 'Template error';
                    return;
                }
                
                const data = await response.json();
                manualBuilderTemplateData = data;
                
                // Update template info display
                if (templateNameEl) {
                    templateNameEl.innerHTML = `
                        <i class="fas fa-file-alt" style="margin-right: 6px;"></i>
                        ${escapeHtml(data.templateName || 'Template')}
                    `;
                }
                
                // Get unique categories
                const categories = Array.isArray(data.categories) && data.categories.length > 0
                    ? data.categories
                    : [];
                
                if (categoryCountEl) {
                    categoryCountEl.textContent = `${categories.length} categories`;
                }
                
                // Populate dropdown
                if (!select) return;
                
                select.innerHTML = `
                    <option value="">Auto (let AI choose)</option>
                    ${categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}
                `;
                
                console.log(`[Manual Builder] Loaded ${categories.length} categories from template "${data.templateName}"`);
                
            } catch (error) {
                console.error('Error loading manual categories:', error);
                if (templateNameEl) templateNameEl.textContent = 'Error loading template';
            }
        }

        function renderManualPreview(scenario) {
            const previewEl = document.getElementById('manual-preview');
            if (!previewEl) return;
            if (!scenario) {
                previewEl.style.display = 'none';
                previewEl.innerHTML = '';
                return;
            }

            const category = scenario.categories?.[0] || scenario.category || 'FAQ';
            const scenarioType = scenario.scenarioType || 'FAQ';
            const bookingIntent = scenario.bookingIntent ? 'âœ… Yes' : 'âŒ No';
            const triggers = (scenario.triggers || []).slice(0, 5);
            const quickReplies = (scenario.quickReplies || []).slice(0, 3);
            const fullReplies = (scenario.fullReplies || []).slice(0, 3);
            const quickNoNameCount = (scenario.quickReplies_noName || []).length;
            const fullNoNameCount = (scenario.fullReplies_noName || []).length;

            previewEl.style.display = 'block';
            previewEl.innerHTML = `
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Draft Preview</div>
                <div style="font-weight: 700; margin-bottom: 6px;">${escapeHtml(scenario.name || 'Untitled')}</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">
                    ${escapeHtml(category)} â€¢ ${escapeHtml(scenarioType)} â€¢ BookingIntent: ${bookingIntent}
                </div>
                <div style="display: grid; gap: 10px;">
                    <div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Triggers</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${triggers.length ? triggers.map(t => `<span class="trigger-tag">${escapeHtml(t)}</span>`).join('') : '<span style="color: var(--text-muted); font-size: 12px;">No triggers</span>'}
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Quick Replies (sample)</div>
                        ${quickReplies.length ? quickReplies.map(r => `<div class="preview-reply" style="background: #10b981; color: white; padding: 8px 10px; border-radius: 8px; font-size: 12px; margin-bottom: 6px;">${escapeHtml(r)}</div>`).join('') : '<div style="color: var(--text-muted); font-size: 12px;">No quick replies</div>'}
                    </div>
                    <div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Full Replies (sample)</div>
                        ${fullReplies.length ? fullReplies.map(r => `<div class="preview-reply" style="background: #3b82f6; color: white; padding: 8px 10px; border-radius: 8px; font-size: 12px; margin-bottom: 6px;">${escapeHtml(r)}</div>`).join('') : '<div style="color: var(--text-muted); font-size: 12px;">No full replies</div>'}
                    </div>
                    <div style="font-size: 12px; color: var(--text-muted);">
                        _noName variants: quick ${quickNoNameCount || 0}, full ${fullNoNameCount || 0}
                    </div>
                </div>
            `;
        }

        function renderManualValidation(validation) {
            const validationEl = document.getElementById('manual-validation');
            if (!validationEl) return;
            if (!validation) {
                validationEl.style.display = 'none';
                validationEl.innerHTML = '';
                return;
            }

            const errors = validation.errors || [];
            const warnings = validation.warnings || [];
            const statusLine = errors.length === 0
                ? `<div style="color: #22c55e; font-weight: 600; margin-bottom: 6px;">Validation passed (warnings allowed) âœ…</div>`
                : `<div style="color: #f87171; font-weight: 600; margin-bottom: 6px;">Validation failed (errors) âŒ</div>`;

            const errorHtml = errors.length > 0
                ? `<div style="margin-bottom: 8px; color: #f87171;">
                    <strong>Errors</strong>
                    <ul style="margin: 6px 0 0 16px;">
                        ${errors.map(e => `<li>${escapeHtml(e.message)}</li>`).join('')}
                    </ul>
                </div>`
                : '';

            const warningHtml = warnings.length > 0
                ? `<div style="color: #fbbf24;">
                    <strong>Warnings</strong>
                    <ul style="margin: 6px 0 0 16px;">
                        ${warnings.map(w => `<li>${escapeHtml(w.message)}</li>`).join('')}
                    </ul>
                </div>`
                : `<div style="color: var(--text-muted); font-size: 12px;">No warnings</div>`;

            const tokensUsed = Array.isArray(validation.tokensUsed) && validation.tokensUsed.length > 0
                ? validation.tokensUsed.map(t => `<code>${escapeHtml(t)}</code>`).join(', ')
                : 'None';
            const fieldsGenerated = Array.isArray(validation.fieldsGenerated) && validation.fieldsGenerated.length > 0
                ? validation.fieldsGenerated.map(f => `<code>${escapeHtml(f)}</code>`).join(', ')
                : 'None';

            const metaHtml = `
                <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                    <div><strong>Tokens used:</strong> ${tokensUsed}</div>
                    <div><strong>Fields generated:</strong> ${fieldsGenerated}</div>
                </div>
            `;

            validationEl.style.display = 'block';
            validationEl.innerHTML = `${statusLine}${errorHtml}${warningHtml}${metaHtml}`;
        }

        function updateManualSaveState() {
            const saveBtn = document.getElementById('manual-save-btn');
            const copyBtn = document.getElementById('manual-copy-btn');
            const allowWarnings = document.getElementById('manual-allow-warnings')?.checked;
            if (!saveBtn) return;

            if (!manualPreview || !manualValidation) {
                saveBtn.disabled = true;
                if (copyBtn) copyBtn.disabled = true;
                return;
            }

            const hasErrors = (manualValidation.errors || []).length > 0;
            const hasWarnings = (manualValidation.warnings || []).length > 0;
            saveBtn.disabled = hasErrors || (!allowWarnings && hasWarnings);
            if (copyBtn) copyBtn.disabled = false;
        }

        async function generateManualScenario() {
            const questionEl = document.getElementById('manual-question');
            const categoryEl = document.getElementById('manual-category');
            const typeEl = document.getElementById('manual-type');
            const tradeEl = document.getElementById('manual-trade');
            const btn = document.getElementById('manual-generate-btn');
            const resultDiv = document.getElementById('manual-result');

            const question = (questionEl?.value || '').trim();
            if (!question) {
                showToast('Please enter what the caller asked', 'error');
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                
                // Show loading state
                if (resultDiv) {
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-brain fa-3x" style="color: #10b981; margin-bottom: 16px; animation: pulse 2s infinite;"></i>
                            <h3 style="color: white; margin-bottom: 8px;">GPT-4 is creating your scenario...</h3>
                            <p style="color: var(--text-muted); font-size: 13px;">Generating triggers, replies, and validation</p>
                        </div>
                    `;
                }
                
                const token = getAuthToken();
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/manual/generate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userPrompt: question,
                        tradeKey: tradeEl?.value || null,
                        category: categoryEl?.value || null,
                        scenarioType: typeEl?.value || null
                    })
                });

                const data = await response.json();
                if (!response.ok || data.error) {
                    throw new Error(data.details || data.error || 'Failed to generate scenario');
                }

                if (data.isDuplicate) {
                    manualPreview = null;
                    manualValidation = null;
                    if (resultDiv) {
                        resultDiv.innerHTML = `
                            <div style="
                                background: rgba(245, 158, 11, 0.1);
                                border: 1px solid #f59e0b;
                                border-radius: 12px;
                                padding: 20px;
                                text-align: center;
                            ">
                                <div style="font-size: 48px; margin-bottom: 12px;">âš ï¸</div>
                                <h3 style="color: #f59e0b; margin-bottom: 8px;">Duplicate Detected</h3>
                                <p style="color: var(--text-muted); margin-bottom: 16px;">
                                    This appears to match: <strong style="color: white;">${escapeHtml(data.duplicateScenarioName || 'Unknown')}</strong>
                                </p>
                                <p style="color: var(--text-muted); font-size: 13px;">
                                    ${escapeHtml(data.explanation || 'Consider adding triggers to the existing scenario instead.')}
                                </p>
                            </div>
                        `;
                    }
                    return;
                }

                manualPreview = data.generatedScenario || data.preview;
                manualValidation = data.validation;
                renderManualResult(manualPreview, manualValidation);
                
            } catch (error) {
                console.error('Manual generate error:', error);
                showToast(error.message || 'Failed to generate draft', 'error');
                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div style="
                            background: rgba(239, 68, 68, 0.1);
                            border: 1px solid #ef4444;
                            border-radius: 12px;
                            padding: 20px;
                            text-align: center;
                        ">
                            <div style="font-size: 48px; margin-bottom: 12px;">âŒ</div>
                            <h3 style="color: #ef4444; margin-bottom: 8px;">Generation Failed</h3>
                            <p style="color: var(--text-muted);">${escapeHtml(error.message)}</p>
                        </div>
                    `;
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Generate with GPT-4';
            }
        }
        
        function renderManualResult(scenario, validation) {
            const resultDiv = document.getElementById('manual-result');
            if (!resultDiv || !scenario) return;
            
            const hasErrors = validation?.errors?.length > 0;
            const hasWarnings = validation?.warnings?.length > 0;
            
            // Helper to render a setting row
            const renderSetting = (label, value, type = 'text', color = '#e2e8f0') => {
                let displayValue = '';
                let statusIcon = '';
                
                if (value === undefined || value === null || value === '') {
                    displayValue = '<span style="color: #64748b; font-style: italic;">not set</span>';
                    statusIcon = '<i class="fas fa-minus-circle" style="color: #64748b;"></i>';
                } else if (type === 'boolean') {
                    displayValue = value ? '<span style="color: #4ade80;">true</span>' : '<span style="color: #f87171;">false</span>';
                    statusIcon = '<i class="fas fa-check-circle" style="color: #22c55e;"></i>';
                } else if (type === 'array') {
                    const arr = Array.isArray(value) ? value : [];
                    displayValue = arr.length > 0 
                        ? `<span style="color: #4ade80;">${arr.length} items</span>` 
                        : '<span style="color: #64748b;">empty</span>';
                    statusIcon = arr.length > 0 
                        ? '<i class="fas fa-check-circle" style="color: #22c55e;"></i>' 
                        : '<i class="fas fa-minus-circle" style="color: #64748b;"></i>';
                } else if (type === 'number') {
                    displayValue = `<span style="color: #60a5fa;">${value}</span>`;
                    statusIcon = '<i class="fas fa-check-circle" style="color: #22c55e;"></i>';
                } else {
                    displayValue = `<span style="color: ${color};">${escapeHtml(String(value))}</span>`;
                    statusIcon = '<i class="fas fa-check-circle" style="color: #22c55e;"></i>';
                }
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <span style="color: #94a3b8; font-size: 12px;">${statusIcon} ${label}</span>
                        <span style="font-size: 12px; font-family: monospace;">${displayValue}</span>
                    </div>
                `;
            };
            
            // Count how many settings are populated
            const settingsCount = [
                scenario.name, scenario.status, scenario.isActive, scenario.categories?.length,
                scenario.scenarioType, scenario.priority, scenario.minConfidence, scenario.behavior,
                scenario.replyStrategy, scenario.bookingIntent !== undefined, scenario.triggers?.length,
                scenario.regexTriggers?.length, scenario.negativeTriggers?.length,
                scenario.quickReplies?.length, scenario.fullReplies?.length,
                scenario.quickReplies_noName?.length, scenario.fullReplies_noName?.length,
                scenario.entityCapture?.length, scenario.channel, scenario.notes
            ].filter(v => v).length;
            
            resultDiv.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #10b981;">
                        <i class="fas fa-check-circle"></i> Scenario Generated
                        <span style="font-size: 14px; color: #94a3b8; font-weight: normal; margin-left: 12px;">
                            ${settingsCount}/22 settings populated
                        </span>
                    </h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="copyManualScenarioJson()" style="padding: 8px 16px;">
                            <i class="fas fa-copy"></i> Copy JSON
                        </button>
                        <button class="btn" onclick="openManualInGlobalBrain()" style="
                            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
                            border: none;
                            padding: 8px 20px;
                        ">
                            <i class="fas fa-external-link-alt"></i> Open in Global Brain
                        </button>
                    </div>
                </div>
                
                <!-- Two Column Layout: Content + Settings -->
                <div style="display: grid; grid-template-columns: 1fr 350px; gap: 20px;">
                    
                    <!-- LEFT: Content Preview -->
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: white; font-size: 18px;">
                            ${escapeHtml(scenario.name || 'Untitled')}
                        </h4>
                        
                        <!-- Type Badges -->
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
                            <span style="background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 4px 10px; border-radius: 6px; font-size: 11px;">
                                ${escapeHtml(scenario.categories?.[0] || 'General')}
                            </span>
                            <span style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 4px 10px; border-radius: 6px; font-size: 11px;">
                                ${escapeHtml(scenario.scenarioType || 'FAQ')}
                            </span>
                            ${scenario.bookingIntent ? `<span style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; padding: 4px 10px; border-radius: 6px; font-size: 11px;">Booking Intent</span>` : ''}
                        </div>
                        
                        <!-- Triggers -->
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; font-weight: 600;">
                                TRIGGERS (${scenario.triggers?.length || 0})
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${(scenario.triggers || []).slice(0, 8).map(t => `
                                    <span style="background: rgba(139, 92, 246, 0.2); color: #a78bfa; padding: 4px 10px; border-radius: 6px; font-size: 12px;">${escapeHtml(t)}</span>
                                `).join('')}
                                ${(scenario.triggers?.length || 0) > 8 ? `<span style="color: var(--text-muted); font-size: 12px;">+${scenario.triggers.length - 8} more</span>` : ''}
                            </div>
                        </div>
                        
                        <!-- Replies Grid -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; font-weight: 600;">
                                    QUICK REPLIES (${scenario.quickReplies?.length || 0})
                                </div>
                                ${(scenario.quickReplies || []).slice(0, 3).map(r => `
                                    <div style="background: rgba(16, 185, 129, 0.15); border-left: 3px solid #10b981; padding: 10px 12px; margin-bottom: 8px; border-radius: 0 8px 8px 0; font-size: 13px; color: #a7f3d0;">${escapeHtml(r)}</div>
                                `).join('')}
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; font-weight: 600;">
                                    FULL REPLIES (${scenario.fullReplies?.length || 0})
                                </div>
                                ${(scenario.fullReplies || []).slice(0, 3).map(r => `
                                    <div style="background: rgba(59, 130, 246, 0.15); border-left: 3px solid #3b82f6; padding: 10px 12px; margin-bottom: 8px; border-radius: 0 8px 8px 0; font-size: 13px; color: #93c5fd;">${escapeHtml(r)}</div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        ${scenario.notes ? `
                            <div style="margin-top: 16px; padding: 12px; background: rgba(148, 163, 184, 0.1); border-radius: 8px;">
                                <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">NOTES</div>
                                <div style="font-size: 13px; color: #cbd5e1;">${escapeHtml(scenario.notes)}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- RIGHT: All 22 Settings -->
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #a78bfa; font-size: 14px;">
                            <i class="fas fa-cogs"></i> All 22 Scenario Settings
                        </h4>
                        
                        <!-- Identity -->
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 10px; color: #8b5cf6; font-weight: 600; margin-bottom: 6px; text-transform: uppercase;">Identity</div>
                            ${renderSetting('name', scenario.name)}
                            ${renderSetting('status', scenario.status)}
                            ${renderSetting('isActive', scenario.isActive, 'boolean')}
                            ${renderSetting('categories', scenario.categories, 'array')}
                            ${renderSetting('scenarioType', scenario.scenarioType)}
                        </div>
                        
                        <!-- Matching -->
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 10px; color: #22c55e; font-weight: 600; margin-bottom: 6px; text-transform: uppercase;">Matching</div>
                            ${renderSetting('triggers', scenario.triggers, 'array')}
                            ${renderSetting('regexTriggers', scenario.regexTriggers, 'array')}
                            ${renderSetting('negativeTriggers', scenario.negativeTriggers, 'array')}
                            ${renderSetting('priority', scenario.priority, 'number')}
                            ${renderSetting('minConfidence', scenario.minConfidence, 'number')}
                        </div>
                        
                        <!-- Behavior -->
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 10px; color: #f59e0b; font-weight: 600; margin-bottom: 6px; text-transform: uppercase;">Behavior</div>
                            ${renderSetting('behavior', scenario.behavior)}
                            ${renderSetting('replyStrategy', scenario.replyStrategy)}
                            ${renderSetting('bookingIntent', scenario.bookingIntent, 'boolean')}
                            ${renderSetting('channel', scenario.channel)}
                        </div>
                        
                        <!-- Replies -->
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 10px; color: #3b82f6; font-weight: 600; margin-bottom: 6px; text-transform: uppercase;">Replies</div>
                            ${renderSetting('quickReplies', scenario.quickReplies, 'array')}
                            ${renderSetting('fullReplies', scenario.fullReplies, 'array')}
                            ${renderSetting('quickReplies_noName', scenario.quickReplies_noName, 'array')}
                            ${renderSetting('fullReplies_noName', scenario.fullReplies_noName, 'array')}
                        </div>
                        
                        <!-- Advanced -->
                        <div>
                            <div style="font-size: 10px; color: #ec4899; font-weight: 600; margin-bottom: 6px; text-transform: uppercase;">Advanced</div>
                            ${renderSetting('entityCapture', scenario.entityCapture, 'array')}
                            ${renderSetting('followUpMode', scenario.followUpMode)}
                            ${renderSetting('actionType', scenario.actionType)}
                            ${renderSetting('notes', scenario.notes ? 'provided' : null)}
                        </div>
                    </div>
                </div>
                
                <!-- Validation -->
                ${(hasErrors || hasWarnings) ? `
                    <div style="margin-top: 16px;">
                        ${hasErrors ? `
                            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                <div style="color: #ef4444; font-weight: 600; margin-bottom: 8px;">
                                    <i class="fas fa-times-circle"></i> Errors (${validation.errors.length})
                                </div>
                                ${validation.errors.map(e => `<div style="color: #fca5a5; font-size: 13px; margin-left: 20px;">â€¢ ${escapeHtml(e.message || e)}</div>`).join('')}
                            </div>
                        ` : ''}
                        ${hasWarnings ? `
                            <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 12px;">
                                <div style="color: #f59e0b; font-weight: 600; margin-bottom: 8px;">
                                    <i class="fas fa-exclamation-triangle"></i> Warnings (${validation.warnings.length})
                                </div>
                                ${validation.warnings.map(w => `<div style="color: #fcd34d; font-size: 13px; margin-left: 20px;">â€¢ ${escapeHtml(w.message || w)}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                ` : `
                    <div style="margin-top: 16px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 12px; text-align: center;">
                        <span style="color: #10b981;">
                            <i class="fas fa-check-circle"></i> All validations passed
                        </span>
                    </div>
                `}
            `;
        }
        
        function openManualInGlobalBrain() {
            if (!manualPreview) {
                showToast('No scenario generated yet', 'error');
                return;
            }
            
            // Build prefill data for Global Brain
            const prefillData = {
                mode: 'create',
                scenario: {
                    name: manualPreview.name || '',
                    status: 'draft',
                    category: manualPreview.categories?.[0] || manualPreview.category || '',
                    categories: manualPreview.categories || [],
                    scenarioType: manualPreview.scenarioType || 'FAQ',
                    bookingIntent: manualPreview.bookingIntent || false,
                    triggers: manualPreview.triggers || [],
                    quickReplies: manualPreview.quickReplies || [],
                    fullReplies: manualPreview.fullReplies || [],
                    quickReplies_noName: manualPreview.quickReplies_noName || [],
                    fullReplies_noName: manualPreview.fullReplies_noName || [],
                    behavior: manualPreview.behavior || '',
                    notes: `Created from Gap Fill. Question: "${document.getElementById('manual-question')?.value || ''}"`,
                    source: 'gap-fill-manual'
                },
                templateId: manualBuilderTemplateData?.templateId || null
            };
            
            // Store in localStorage
            localStorage.setItem('scenarioPrefill', JSON.stringify(prefillData));
            
            // Open Global Brain
            window.open('/admin-global-instant-responses.html?prefill=scenario', '_blank');
            showToast('Opening Global Brain with scenario...', 'success');
        }

        async function saveManualScenario() {
            if (!manualPreview || !manualValidation) {
                showToast('Generate a draft first', 'error');
                return;
            }

            const allowWarnings = document.getElementById('manual-allow-warnings')?.checked;
            const btn = document.getElementById('manual-save-btn');
            const questionEl = document.getElementById('manual-question');
            const tradeEl = document.getElementById('manual-trade');

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                const token = getAuthToken();
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/manual/save`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scenario: manualPreview,
                        allowWarnings: !!allowWarnings,
                        tradeKey: tradeEl?.value || null
                    })
                });

                const data = await response.json();
                if (!response.ok || data.error) {
                    manualValidation = data.validation || manualValidation;
                    renderManualValidation(manualValidation);
                    updateManualSaveState();
                    throw new Error(data.error || 'Failed to save draft');
                }

                showToast('Draft scenario saved', 'success');
                manualPreview = null;
                manualValidation = null;
                renderManualPreview(null);
                renderManualValidation(null);
                updateManualSaveState();
                if (questionEl) questionEl.value = '';
            } catch (error) {
                console.error('Manual save error:', error);
                showToast(error.message || 'Failed to save draft', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Save Draft';
            }
        }

        async function copyManualScenarioJson() {
            if (!manualPreview) {
                showToast('Generate a draft first', 'error');
                return;
            }
            try {
                const text = JSON.stringify(manualPreview, null, 2);
                await navigator.clipboard.writeText(text);
                showToast('Scenario JSON copied', 'success');
            } catch (err) {
                console.error('Copy failed:', err);
                showToast('Copy failed', 'error');
            }
        }
        
        async function generatePreview(gap) {
            try {
                const token = getAuthToken();
                const response = await fetch(
                    `/api/admin/scenario-gaps/${companyId}/gaps/preview?representative=${encodeURIComponent(gap.representative)}&examples=${encodeURIComponent(JSON.stringify(gap.examples))}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                
                if (!response.ok) throw new Error('Failed to generate preview');
                
                const data = await response.json();
                return data.preview;
                
            } catch (error) {
                console.error('Error generating preview:', error);
                return null;
            }
        }
        
        async function dismissGap(gap) {
            if (!confirm('Dismiss this gap? It won\'t appear in future analyses.')) return;
            
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/gaps/dismiss`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        representative: gap.representative,
                        reason: 'User dismissed'
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.details || err.error || `HTTP ${response.status}`);
                }
                
                showToast('Gap dismissed', 'success');
                loadGaps();
                
            } catch (error) {
                console.error('Error dismissing gap:', error);
                showToast(`Failed to dismiss: ${error.message}`, 'error');
            }
        }
        
        // Helper: Look up gap by ID and call dismissGap
        function dismissGapById(gapId) {
            const gap = currentGaps.find(g => g.id === gapId);
            if (gap) {
                dismissGap(gap);
            } else {
                console.error('Gap not found:', gapId);
                showToast('Gap not found', 'error');
            }
        }
        
        // Helper: Look up gap by ID and open modal
        function openCreateModalById(gapId) {
            const gap = currentGaps.find(g => g.id === gapId);
            if (gap) {
                openCreateModal(gap);
            } else {
                console.error('Gap not found:', gapId);
                showToast('Gap not found', 'error');
            }
        }
        
        // ========================================
        // RENDERING
        // ========================================
        function renderSummary(summary) {
            // Restore opacity on summary cards
            document.querySelectorAll('.summary-card').forEach(card => {
                card.style.opacity = '1';
            });
            
            document.getElementById('total-tier3').textContent = summary.totalTier3Calls || 0;
            document.getElementById('unique-gaps').textContent = summary.uniqueGaps || 0;
            // Show more precision for tiny amounts
            const savings = summary.potentialSavings || 0;
            const savingsText = savings < 0.01 && savings > 0 
                ? `$${savings.toFixed(3)}`  // Show 3 decimals for tiny amounts
                : `$${savings.toFixed(2)}`;
            document.getElementById('potential-savings').textContent = savingsText;
            document.getElementById('high-priority').textContent = summary.highPriorityCount || 0;
            
            // Update period indicator in header
            const periodText = summary.period || `Last ${selectedDays} days`;
            // Update summary card labels to show period
            const tier3Label = document.querySelector('#total-tier3').nextElementSibling;
            if (tier3Label) {
                tier3Label.innerHTML = `Tier 3 Calls <span style="font-size: 10px; color: var(--text-muted); display: block;">(${periodText})</span>`;
            }
            
            // Log for debugging
            console.log(`[GAPS] Period: ${periodText}, Tier3: ${summary.totalTier3Calls}, Gaps: ${summary.uniqueGaps}`);
        }
        
        function renderGaps(gaps) {
            const container = document.getElementById('gaps-content');
            
            if (!gaps || gaps.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <h3>No Gaps From Calls</h3>
                        <p>No scenario coverage gaps detected in the last ${selectedDays} days.</p>
                        <p style="font-size: 13px; color: var(--text-muted); margin-top: 12px;">
                            <i class="fas fa-info-circle"></i> 
                            This checks call data for missing scenarios. 
                            <strong>Quality audit may still show content issues.</strong>
                        </p>
                    </div>
                `;
                return;
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // SERVICE-AWARE GAP SPLITTING
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Separate true gaps from disabled service requests
            const trueGaps = [];
            const disabledServiceRequests = [];
            
            for (const gap of gaps) {
                const disabledService = detectDisabledServiceInGap(gap.representative);
                if (disabledService) {
                    gap._disabledService = disabledService;
                    disabledServiceRequests.push(gap);
                } else {
                    trueGaps.push(gap);
                }
            }
            
            let html = '';
            
            // Render TRUE GAPS section
            if (trueGaps.length > 0) {
                const highPriority = trueGaps.filter(g => g.priority === 'high');
                const mediumPriority = trueGaps.filter(g => g.priority === 'medium');
                const lowPriority = trueGaps.filter(g => g.priority === 'low');
                
                html += `<div style="margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 12px 16px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px;">
                        <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
                        <div>
                            <strong style="color: #ef4444;">True Gaps (${trueGaps.length})</strong>
                            <span style="color: var(--text-muted); font-size: 13px; margin-left: 8px;">
                                Missing scenarios - these need content
                            </span>
                        </div>
                    </div>
                `;
                
                if (highPriority.length > 0) {
                    html += renderPrioritySection('high', highPriority, 'ðŸ”´ High Priority', 'Asked 5+ times');
                }
                if (mediumPriority.length > 0) {
                    html += renderPrioritySection('medium', mediumPriority, 'ðŸŸ¡ Medium Priority', 'Asked 3-4 times');
                }
                if (lowPriority.length > 0) {
                    html += renderPrioritySection('low', lowPriority, 'âšª Low Priority', 'Asked 2 times');
                }
                
                html += `</div>`;
            }
            
            // Render DISABLED SERVICE REQUESTS section
            if (disabledServiceRequests.length > 0) {
                html += `
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 12px 16px; background: rgba(107, 114, 128, 0.1); border: 1px solid rgba(107, 114, 128, 0.3); border-radius: 8px;">
                            <i class="fas fa-toggle-off" style="color: #6b7280;"></i>
                            <div>
                                <strong style="color: #9ca3af;">Disabled Service Requests (${disabledServiceRequests.length})</strong>
                                <span style="color: var(--text-muted); font-size: 13px; margin-left: 8px;">
                                    NOT gaps - these services are intentionally off
                                </span>
                            </div>
                            <button onclick="toggleDisabledServiceDetails()" style="margin-left: auto; padding: 4px 12px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--text-muted); cursor: pointer; font-size: 12px;">
                                <i class="fas fa-eye"></i> Details
                            </button>
                        </div>
                        <div id="disabled-service-details" style="display: none;">
                            ${disabledServiceRequests.map(gap => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(107, 114, 128, 0.05); border-radius: 8px; margin-bottom: 4px; border-left: 3px solid #6b7280;">
                                    <div>
                                        <div style="color: var(--text-muted); font-size: 14px;">
                                            "${escapeHtml(gap.representative)}"
                                        </div>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                            Matched: <span style="color: #f59e0b;">${gap._disabledService.categoryName}</span> 
                                            (keyword: "${gap._disabledService.matchedKeyword}")
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span style="font-size: 12px; color: var(--text-muted);">${gap.callCount} calls</span>
                                        <button onclick="switchTab('company-local')" style="padding: 4px 10px; background: rgba(16, 185, 129, 0.2); border: none; border-radius: 4px; color: #10b981; cursor: pointer; font-size: 11px;">
                                            Enable Service
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                            <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;">
                                <i class="fas fa-info-circle"></i> 
                                These requests are being handled with deterministic decline responses. 
                                If callers frequently ask about these services, consider enabling them in 
                                <a href="#" onclick="switchTab('company-local'); return false;" style="color: #60a5fa;">Company Local â†’ Services Offered</a>.
                            </p>
                        </div>
                    </div>
                `;
            }
            
            // Handle empty state for true gaps
            if (trueGaps.length === 0 && disabledServiceRequests.length > 0) {
                html = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <h3>No True Gaps!</h3>
                        <p>All scenario coverage gaps are handled by disabled service declines.</p>
                    </div>
                ` + html;
            }
            
            container.innerHTML = html;
        }
        
        function toggleDisabledServiceDetails() {
            const el = document.getElementById('disabled-service-details');
            if (el) {
                el.style.display = el.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function renderPrioritySection(priority, gaps, title, subtitle) {
            return `
                <div class="priority-section">
                    <div class="priority-header">
                        <span class="priority-badge ${priority}">${title}</span>
                        <span class="priority-count">${subtitle}</span>
                    </div>
                    <div class="gaps-grid">
                        ${gaps.map(gap => renderGapCard(gap)).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderGapCard(gap) {
            const examples = gap.examples.slice(0, 3).map(e => `<div class="gap-example">${escapeHtml(e.text)}</div>`).join('');
            // Use gap.id as a safe key to look up from currentGaps array
            const gapId = gap.id;
            
            return `
                <div class="gap-card ${gap.priority}" data-gap-id="${escapeHtml(gapId)}">
                    <div class="gap-header">
                        <div class="gap-phrase">
                            <i class="fas fa-comment-dots"></i>
                            "${escapeHtml(gap.representative)}"
                        </div>
                        <div class="gap-stats">
                            <div class="gap-stat">
                                <div class="gap-stat-value" style="color: var(--accent-pink)">${gap.callCount}</div>
                                <div class="gap-stat-label">Calls</div>
                            </div>
                            <div class="gap-stat">
                                <div class="gap-stat-value" style="color: var(--accent-purple)">${gap.totalTokens || '--'}</div>
                                <div class="gap-stat-label">Tokens</div>
                            </div>
                            <span class="savings-badge">Save ~$${gap.savings?.weeklyCostSaved?.toFixed(2) || '0'}/wk</span>
                        </div>
                    </div>
                    
                    <div class="gap-examples">
                        <div class="gap-examples-title">Examples from calls</div>
                        ${examples}
                    </div>
                    
                    <div class="gap-actions">
                        <button class="btn btn-primary" onclick="openCreateModalById('${escapeHtml(gapId)}')">
                            <i class="fas fa-magic"></i> Auto-Create Scenario
                        </button>
                        <button class="btn btn-secondary" onclick="viewCalls('${escapeHtml(gapId)}')">
                            <i class="fas fa-eye"></i> View Calls (${gap.callIds?.length || 0})
                        </button>
                        <button class="btn btn-ghost" onclick="dismissGapById('${escapeHtml(gapId)}')">
                            <i class="fas fa-times"></i> Dismiss
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ========================================
        // MODAL - SIMPLIFIED: Preview + Open Global Brain
        // ========================================
        async function openCreateModal(gap) {
            currentGap = gap;
            currentPreview = null;
            
            // Show modal with loading state
            document.getElementById('create-modal').classList.add('active');
            document.getElementById('preview-loading').style.display = 'block';
            document.getElementById('preview-content').style.display = 'none';
            
            // Generate AI preview
            const preview = await generatePreview(gap);
            
            // Hide loading, show content
            document.getElementById('preview-loading').style.display = 'none';
            document.getElementById('preview-content').style.display = 'block';
            
            // Behavior display mapping
            const behaviorLabels = {
                'friendly_warm': 'ðŸ¤— Friendly & Warm',
                'empathetic_reassuring': 'ðŸ˜Š Empathetic & Reassuring',
                'professional_efficient': 'ðŸ’¼ Professional & Efficient',
                'enthusiastic_positive': 'ðŸŽ‰ Enthusiastic & Positive',
                'calm_patient': 'ðŸ§˜ Calm & Patient'
            };
            
            if (preview) {
                currentPreview = preview;
                
                // Populate preview display (with null checks for optional elements)
                const previewNameEl = document.getElementById('preview-name');
                if (previewNameEl) previewNameEl.textContent = preview.name || gap.representative.substring(0, 50);
                
                const previewCategoryEl = document.getElementById('preview-category');
                const previewCategory = preview.category || (Array.isArray(preview.categories) ? preview.categories[0] : 'FAQ');
                if (previewCategoryEl) previewCategoryEl.textContent = previewCategory;
                
                const previewTypeEl = document.getElementById('preview-type');
                if (previewTypeEl) previewTypeEl.textContent = preview.scenarioType || 'FAQ';
                
                const previewPriorityEl = document.getElementById('preview-priority');
                if (previewPriorityEl) previewPriorityEl.textContent = preview.priority || 50;
                
                // Behavior
                const behaviorEl = document.getElementById('preview-behavior');
                if (behaviorEl) {
                    behaviorEl.textContent = behaviorLabels[preview.behavior] || preview.behavior || 'Friendly & Warm';
                }
                
                // Triggers
                const triggersEl = document.getElementById('preview-triggers');
                const triggers = preview.triggers || [gap.representative];
                document.getElementById('trigger-count').textContent = triggers.length;
                triggersEl.innerHTML = triggers.slice(0, 10).map(t => 
                    `<span class="trigger-tag">${escapeHtml(t)}</span>`
                ).join('') + (triggers.length > 10 ? `<span class="trigger-tag" style="background: var(--bg-tertiary);">+${triggers.length - 10} more</span>` : '');
                
                // Quick Replies (multiple)
                const quickRepliesEl = document.getElementById('preview-quick-replies');
                const quickReplies = Array.isArray(preview.quickReplies) ? preview.quickReplies : [preview.quickReply || 'I can help with that.'];
                if (quickRepliesEl) {
                    quickRepliesEl.innerHTML = quickReplies.map(r => 
                        `<div class="preview-reply" style="background: #10b981; color: white; padding: 12px; border-radius: 8px; font-size: 14px;">${escapeHtml(r)}</div>`
                    ).join('');
                }
                
                // Full Replies (multiple)
                const fullRepliesEl = document.getElementById('preview-full-replies');
                const fullReplies = preview.fullReplies || [];
                if (fullRepliesEl) {
                    if (fullReplies.length > 0) {
                        fullRepliesEl.innerHTML = fullReplies.map(r => 
                            `<div class="preview-reply" style="background: #3b82f6; color: white; padding: 12px; border-radius: 8px; font-size: 14px;">${escapeHtml(r)}</div>`
                        ).join('');
                    } else {
                        fullRepliesEl.innerHTML = '<div style="color: var(--text-muted); font-style: italic;">No full replies generated</div>';
                    }
                }
                
                // Regex Triggers (if any) - with null checks
                const regexSection = document.getElementById('regex-section');
                const regexEl = document.getElementById('preview-regex');
                if (regexSection) {
                    if (preview.regexTriggers && preview.regexTriggers.length > 0) {
                        regexSection.style.display = 'block';
                        if (regexEl) regexEl.innerHTML = preview.regexTriggers.map(r => escapeHtml(r)).join('<br>');
                    } else {
                        regexSection.style.display = 'none';
                    }
                }
                
                // Follow-Up Funnel (if any) - with null checks
                const funnelSection = document.getElementById('funnel-section');
                const funnelEl = document.getElementById('preview-funnel');
                if (funnelSection) {
                    if (preview.followUpFunnel) {
                        funnelSection.style.display = 'block';
                        if (funnelEl) funnelEl.textContent = preview.followUpFunnel;
                    } else {
                        funnelSection.style.display = 'none';
                    }
                }
                
                // Advanced Settings (with null checks)
                const confEl = document.getElementById('preview-confidence');
                if (confEl) confEl.textContent = preview.minConfidence !== undefined ? (preview.minConfidence * 100).toFixed(0) + '%' : '60%';
                
                const followupEl = document.getElementById('preview-followup-mode');
                if (followupEl) followupEl.textContent = preview.followUpMode || 'NONE';
                
                const actionEl = document.getElementById('preview-action-type');
                if (actionEl) actionEl.textContent = preview.actionType || 'REPLY_ONLY';
                
                const bookingEl = document.getElementById('preview-booking-intent');
                if (bookingEl) {
                    bookingEl.textContent = preview.bookingIntent ? 'âœ… Yes' : 'âŒ No';
                    bookingEl.style.color = preview.bookingIntent ? 'var(--accent-green)' : 'var(--text-muted)';
                }
                
                const cooldownEl = document.getElementById('preview-cooldown');
                if (cooldownEl) cooldownEl.textContent = (preview.cooldownSeconds || 0) + 's';
                
                const handoffEl = document.getElementById('preview-handoff');
                if (handoffEl) handoffEl.textContent = preview.handoffPolicy || 'low_confidence';
                
                // Entity Capture (if any) - with null checks
                const entitySection = document.getElementById('entity-section');
                const entityEl = document.getElementById('preview-entities');
                const entities = preview.entityCapture || [];
                if (entitySection) {
                    if (entities.length > 0) {
                        entitySection.style.display = 'block';
                        if (entityEl) entityEl.innerHTML = entities.map(e => 
                            `<span style="background: var(--accent-purple); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">${escapeHtml(e)}</span>`
                        ).join('');
                    } else {
                        entitySection.style.display = 'none';
                    }
                }
                
                // _noName Variants indicator - with null checks
                const nonameSection = document.getElementById('noname-section');
                const nonameEl = document.getElementById('preview-noname');
                const hasNoNameQuick = preview.quickReplies_noName && preview.quickReplies_noName.length > 0;
                const hasNoNameFull = preview.fullReplies_noName && preview.fullReplies_noName.length > 0;
                if (nonameSection) {
                    if (hasNoNameQuick || hasNoNameFull) {
                        nonameSection.style.display = 'block';
                        if (nonameEl) nonameEl.innerHTML = `
                            <span>âœ… quickReplies_noName: ${hasNoNameQuick ? preview.quickReplies_noName.length + ' variants' : 'âŒ missing'}</span><br>
                            <span>âœ… fullReplies_noName: ${hasNoNameFull ? preview.fullReplies_noName.length + ' variants' : 'âŒ missing'}</span>
                        `;
                    } else {
                        nonameSection.style.display = 'none';
                    }
                }
                
                // ðŸŽ¯ HEALTH COUNT BANNER - Count populated settings
                updateHealthCount(preview, currentGap);
                
            } else {
                // Fallback display (with null checks for all optional elements)
                const fallbackNameEl = document.getElementById('preview-name');
                if (fallbackNameEl) fallbackNameEl.textContent = gap.representative.substring(0, 50);
                
                const fallbackCatEl = document.getElementById('preview-category');
                if (fallbackCatEl) fallbackCatEl.textContent = 'FAQ';
                
                const fallbackTypeEl = document.getElementById('preview-type');
                if (fallbackTypeEl) fallbackTypeEl.textContent = 'FAQ';
                
                const fallbackPriorityEl = document.getElementById('preview-priority');
                if (fallbackPriorityEl) fallbackPriorityEl.textContent = '50';
                
                const fallbackBehaviorEl = document.getElementById('preview-behavior');
                if (fallbackBehaviorEl) fallbackBehaviorEl.textContent = 'ðŸ¤— Friendly & Warm';
                
                const triggerCountEl = document.getElementById('trigger-count');
                if (triggerCountEl) triggerCountEl.textContent = gap.examples?.length || 1;
                
                const triggersEl = document.getElementById('preview-triggers');
                if (triggersEl) {
                    triggersEl.innerHTML = gap.examples?.slice(0, 5).map(e => 
                        `<span class="trigger-tag">${escapeHtml(e.text)}</span>`
                    ).join('') || `<span class="trigger-tag">${escapeHtml(gap.representative)}</span>`;
                }
                
                const fallbackQuickEl = document.getElementById('preview-quick-replies');
                if (fallbackQuickEl) fallbackQuickEl.innerHTML = '<div class="preview-reply" style="background: #10b981; color: white; padding: 12px; border-radius: 8px;">I can help with that. Let me get more information.</div>';
                
                const fallbackFullEl = document.getElementById('preview-full-replies');
                if (fallbackFullEl) fallbackFullEl.innerHTML = '<div style="color: var(--text-muted); font-style: italic;">No full replies generated</div>';
                
                // Health count for fallback (minimal)
                updateHealthCount({ name: gap.representative, scenarioType: 'FAQ', priority: 50, triggers: gap.examples || [] }, currentGap);
                
                // Advanced Settings fallback (with null checks)
                const fbConfEl = document.getElementById('preview-confidence');
                if (fbConfEl) fbConfEl.textContent = '60%';
                
                const fbFollowupEl = document.getElementById('preview-followup-mode');
                if (fbFollowupEl) fbFollowupEl.textContent = 'NONE';
                
                const fbActionEl = document.getElementById('preview-action-type');
                if (fbActionEl) fbActionEl.textContent = 'REPLY_ONLY';
                
                const fbBookingEl = document.getElementById('preview-booking-intent');
                if (fbBookingEl) {
                    fbBookingEl.textContent = 'âŒ No';
                    fbBookingEl.style.color = 'var(--text-muted)';
                }
                
                const fbCooldownEl = document.getElementById('preview-cooldown');
                if (fbCooldownEl) fbCooldownEl.textContent = '0s';
                
                const fbHandoffEl = document.getElementById('preview-handoff');
                if (fbHandoffEl) fbHandoffEl.textContent = 'low_confidence';
                
                const entitySection = document.getElementById('entity-section');
                if (entitySection) entitySection.style.display = 'none';
                
                const nonameSection = document.getElementById('noname-section');
                if (nonameSection) nonameSection.style.display = 'none';
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RUNTIME CONTRACT: Scenarios define WHAT to say, not HOW/WHEN to behave
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONTENT (Scenario owns - GPT generates):
        //   name, status, categories, scenarioType, behavior, priority, minConfidence
        //   triggers, regexTriggers, negativeTriggers, exampleUserPhrases
        //   quickReplies, fullReplies, _noName variants
        //   bookingIntent (flag), entityCapture, channel, notes
        //
        // RUNTIME (ConversationEngine owns - NOT generated):
        //   followUpMode, followUpFunnel, followUpQuestionText (decided by context)
        //   handoffPolicy (decided by confidence/context)
        //   actionType (decided by booking flow)
        //   silencePolicy, timedFollowUp (global admin settings)
        //   cooldown, actionHooks, entityValidation (infrastructure)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function buildScenarioPrefill(preview = {}, gap = {}) {
            const p = preview || {};
            const g = gap || {};
            const categoryValue = p.category || (Array.isArray(p.categories) ? p.categories[0] : 'FAQ');
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CONTENT ONLY - What the agent says when this scenario matches
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            return {
                // Identity
                name: p.name || g.representative?.substring(0, 50) || 'New Scenario',
                status: 'draft',
                category: categoryValue,
                categories: Array.isArray(p.categories) ? p.categories : [categoryValue],
                scenarioType: p.scenarioType || 'FAQ',
                isActive: true,
                
                // Personality (how replies are WRITTEN, not how agent BEHAVES)
                behavior: p.behavior || 'calm_professional',
                
                // Matching priority
                priority: typeof p.priority === 'number' ? Math.max(-10, Math.min(10, p.priority)) : 0,
                minConfidence: typeof p.minConfidence === 'number' ? p.minConfidence : 0.6,
                
                // Triggers (when to match)
                triggers: Array.isArray(p.triggers) && p.triggers.length > 0 
                    ? p.triggers 
                    : (g.representative ? [g.representative] : []),
                regexTriggers: Array.isArray(p.regexTriggers) ? p.regexTriggers : [],
                negativeTriggers: Array.isArray(p.negativeTriggers) ? p.negativeTriggers : [],
                exampleUserPhrases: Array.isArray(p.exampleUserPhrases) ? p.exampleUserPhrases : [],
                negativeUserPhrases: Array.isArray(p.negativeUserPhrases) ? p.negativeUserPhrases : [],
                
                // Replies (what to say)
                quickReplies: Array.isArray(p.quickReplies) && p.quickReplies.length > 0 
                    ? p.quickReplies 
                    : [p.quickReply || 'I can help with that.'],
                fullReplies: Array.isArray(p.fullReplies) ? p.fullReplies : [],
                quickReplies_noName: Array.isArray(p.quickReplies_noName) ? p.quickReplies_noName : [],
                fullReplies_noName: Array.isArray(p.fullReplies_noName) ? p.fullReplies_noName : [],
                replyStrategy: p.replyStrategy || 'AUTO',
                
                // Intent flag (Runtime uses this to decide behavior)
                bookingIntent: p.bookingIntent === true,
                
                // Entity extraction (what to capture, not how)
                entityCapture: Array.isArray(p.entityCapture) && p.entityCapture.length > 0 
                    ? p.entityCapture 
                    : ['name', 'issue'],
                
                // Channel restriction
                channel: p.channel || 'any',
                
                // Admin notes (handle both Gap Fill and Blueprint sources)
                notes: p.notes || (g.representative 
                    ? `Created from Scenario Gaps. Gap: "${g.representative}"` 
                    : `Created from Blueprint Builder`),
                
                // Metadata
                source: p.source || (g.representative ? 'scenario-gaps' : 'blueprint-builder'),
                sourceGap: g.representative || null,
                sourceItemKey: p.itemKey || null
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // RUNTIME-OWNED (NOT included - decided by ConversationEngine):
                // - followUpMode, followUpFunnel, followUpQuestionText
                // - handoffPolicy, actionType
                // - cooldownSeconds, actionHooks, entityValidation
                // - silencePolicy, timedFollowUp, dynamicVariables
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            };
        }
        
        function openInGlobalBrain() {
            if (!currentPreview && !currentGap) {
                showToast('No scenario data available', 'error');
                return;
            }
            
            // Build comprehensive scenario object for Global Brain
            const scenarioData = buildScenarioPrefill(currentPreview, currentGap);
            
            // Store in sessionStorage for Global Brain to pick up
            sessionStorage.setItem('scenarioPrefill', JSON.stringify(scenarioData));
            
            // Close modal
            closeModal();
            
            // Open Global Brain with prefill flag
            window.open('/admin-global-instant-responses.html?prefill=scenario', '_blank');
            
            showToast('Opening Global Brain with pre-filled data...', 'success');
        }
        
        function closeModal() {
            document.getElementById('create-modal').classList.remove('active');
            currentGap = null;
            currentPreview = null;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HEALTH COUNT BANNER - CONTENT ONLY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Only tracks settings that scenarios OWN (WHAT to say)
        // Runtime-owned settings (HOW/WHEN to behave) are NOT tracked here
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function updateHealthCount(preview, gap) {
            const scenarioData = buildScenarioPrefill(preview, gap);
            
            // ðŸŽ¯ CONTENT SETTINGS ONLY (derived from REGISTRY)
            // These are the settings GPT generates - what the agent SAYS
            // Runtime settings (behavior/timing) are NOT included
            // Count comes from SCENARIO_SETTINGS_REGISTRY.ownership.content
            const settingsToCheck = [
                // Identity (5)
                { key: 'name', label: 'Scenario Name', check: () => scenarioData.name && scenarioData.name.trim(), getValue: () => scenarioData.name },
                { key: 'status', label: 'Status', check: () => scenarioData.status, getValue: () => scenarioData.status },
                { key: 'isActive', label: 'Is Active', check: () => scenarioData.isActive !== undefined, getValue: () => scenarioData.isActive ? 'Yes' : 'No' },
                { key: 'category', label: 'Category', check: () => scenarioData.category, getValue: () => scenarioData.category },
                { key: 'scenarioType', label: 'Scenario Type', check: () => scenarioData.scenarioType, getValue: () => scenarioData.scenarioType },
                
                // Personality & Priority (3)
                { key: 'behavior', label: 'Personality', check: () => scenarioData.behavior, getValue: () => scenarioData.behavior },
                { key: 'priority', label: 'Priority', check: () => typeof scenarioData.priority === 'number', getValue: () => scenarioData.priority },
                { key: 'minConfidence', label: 'Min Confidence', check: () => typeof scenarioData.minConfidence === 'number', getValue: () => scenarioData.minConfidence },
                
                // Triggers (5)
                { key: 'triggers', label: 'Triggers', check: () => Array.isArray(scenarioData.triggers) && scenarioData.triggers.length > 0, getValue: () => scenarioData.triggers?.length || 0 },
                { key: 'regexTriggers', label: 'Regex Triggers', check: () => Array.isArray(scenarioData.regexTriggers), getValue: () => scenarioData.regexTriggers?.length || 0 },
                { key: 'negativeTriggers', label: 'Negative Triggers', check: () => Array.isArray(scenarioData.negativeTriggers), getValue: () => scenarioData.negativeTriggers?.length || 0 },
                { key: 'exampleUserPhrases', label: 'Example Phrases', check: () => Array.isArray(scenarioData.exampleUserPhrases), getValue: () => scenarioData.exampleUserPhrases?.length || 0 },
                { key: 'negativeUserPhrases', label: 'Negative Phrases', check: () => Array.isArray(scenarioData.negativeUserPhrases), getValue: () => scenarioData.negativeUserPhrases?.length || 0 },
                
                // Replies - WHAT to say (6)
                { key: 'quickReplies', label: 'Quick Replies', check: () => Array.isArray(scenarioData.quickReplies) && scenarioData.quickReplies.length > 0, getValue: () => scenarioData.quickReplies?.length || 0 },
                { key: 'fullReplies', label: 'Full Replies', check: () => Array.isArray(scenarioData.fullReplies), getValue: () => scenarioData.fullReplies?.length || 0 },
                { key: 'quickReplies_noName', label: 'Quick (no name)', check: () => Array.isArray(scenarioData.quickReplies_noName), getValue: () => scenarioData.quickReplies_noName?.length || 0 },
                { key: 'fullReplies_noName', label: 'Full (no name)', check: () => Array.isArray(scenarioData.fullReplies_noName), getValue: () => scenarioData.fullReplies_noName?.length || 0 },
                { key: 'replyStrategy', label: 'Reply Strategy', check: () => scenarioData.replyStrategy, getValue: () => scenarioData.replyStrategy },
                
                // Intent & Extraction (3)
                { key: 'bookingIntent', label: 'Booking Intent', check: () => typeof scenarioData.bookingIntent === 'boolean', getValue: () => scenarioData.bookingIntent ? 'Yes' : 'No' },
                { key: 'entityCapture', label: 'Entity Capture', check: () => Array.isArray(scenarioData.entityCapture), getValue: () => scenarioData.entityCapture?.length || 0 },
                { key: 'channel', label: 'Channel', check: () => scenarioData.channel, getValue: () => scenarioData.channel || 'any' }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // NOT TRACKED (Runtime-owned):
                // - followUpMode, followUpFunnel, followUpQuestionText
                // - actionType, handoffPolicy, cooldownSeconds
                // - actionHooks, entityValidation, silencePolicy
                // - dynamicVariables, timedFollowUp
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ];
            
            // Store for table rendering
            window._currentSettingsCheck = settingsToCheck;
            
            const missing = settingsToCheck.filter(s => !s.check()).map(s => s.key);
            const filledCount = settingsToCheck.length - missing.length;
            const totalCount = settingsToCheck.length;
            const percentage = Math.round((filledCount / totalCount) * 100);
            
            // Update banner
            const countGenerated = document.getElementById('health-count-generated');
            const countTotal = document.getElementById('health-count-total');
            const runtimeBadge = document.getElementById('health-runtime-badge');
            const progressBar = document.getElementById('health-progress-bar');
            const banner = document.getElementById('health-count-banner');
            const missingEl = document.getElementById('health-missing');
            
            if (countGenerated) countGenerated.textContent = filledCount;
            if (countTotal) countTotal.textContent = totalCount;
            if (runtimeBadge) runtimeBadge.textContent = percentage + '%';
            if (progressBar) progressBar.style.width = percentage + '%';
            if (missingEl) {
                missingEl.textContent = missing.length > 0 
                    ? `Missing: ${missing.join(', ')}` 
                    : 'All required fields set';
            }
            
            // ðŸŽ¯ RENDER TWO-COLUMN SETTINGS TABLE
            const tableEl = document.getElementById('settings-table');
            if (tableEl) {
                let tableHtml = '';
                settingsToCheck.forEach((setting, idx) => {
                    const isFilled = setting.check();
                    const value = setting.getValue ? setting.getValue() : '--';
                    const displayValue = typeof value === 'object' ? JSON.stringify(value) : value;
                    const bgColor = idx % 2 === 0 ? 'var(--bg-secondary)' : 'var(--bg-tertiary)';
                    
                    tableHtml += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; background: ${bgColor}; border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 11px; color: var(--text-muted); min-width: 20px;">${idx + 1}.</span>
                                <span style="color: ${isFilled ? 'var(--text-primary)' : 'var(--text-muted)'}; font-size: 13px;">${setting.label}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 13px; font-weight: 500; color: ${isFilled ? 'var(--accent-green)' : 'var(--accent-red)'}; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${isFilled ? displayValue : 'â€”'}
                                </span>
                                <span style="font-size: 12px;">${isFilled ? 'âœ…' : 'âŒ'}</span>
                            </div>
                        </div>
                    `;
                });
                tableEl.innerHTML = tableHtml;
            }
            
            // Color coding based on health
            if (percentage >= 90) {
                // Excellent - green
                if (banner) banner.style.background = 'linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.1))';
                if (banner) banner.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                if (countGenerated) countGenerated.style.color = '#22c55e';
                if (runtimeBadge) runtimeBadge.style.background = 'rgba(34, 197, 94, 0.2)';
                if (runtimeBadge) runtimeBadge.style.color = '#22c55e';
                if (progressBar) progressBar.style.background = 'linear-gradient(90deg, #22c55e, #10b981)';
            } else if (percentage >= 70) {
                // Good - blue
                if (banner) banner.style.background = 'linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(99, 102, 241, 0.1))';
                if (banner) banner.style.borderColor = 'rgba(59, 130, 246, 0.3)';
                if (countGenerated) countGenerated.style.color = '#3b82f6';
                if (runtimeBadge) runtimeBadge.style.background = 'rgba(59, 130, 246, 0.2)';
                if (runtimeBadge) runtimeBadge.style.color = '#3b82f6';
                if (progressBar) progressBar.style.background = 'linear-gradient(90deg, #3b82f6, #6366f1)';
            } else {
                // Needs work - orange
                if (banner) banner.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(234, 179, 8, 0.1))';
                if (banner) banner.style.borderColor = 'rgba(245, 158, 11, 0.3)';
                if (countGenerated) countGenerated.style.color = '#f59e0b';
                if (runtimeBadge) runtimeBadge.style.background = 'rgba(245, 158, 11, 0.2)';
                if (runtimeBadge) runtimeBadge.style.color = '#f59e0b';
                if (progressBar) progressBar.style.background = 'linear-gradient(90deg, #f59e0b, #eab308)';
            }
        }
        
        // ========================================
        // HELPER: Smart default follow-up funnel
        // ========================================
        // DISPATCHER-STYLE follow-up funnels (brief, action-oriented)
        function getDefaultFollowUpFunnel(scenarioType, bookingIntent) {
            if (bookingIntent) {
                return "Let's get this scheduled. Morning or afternoon work better?";
            }
            switch (scenarioType) {
                case 'EMERGENCY':
                    return "Let me get someone out right away. Are you available now?";
                case 'BOOKING':
                    return "Let's get this on the schedule. What day works for you?";
                case 'TROUBLESHOOT':
                    return "Let's get a tech out to take a look. What's your availability?";
                case 'BILLING':
                    return "Anything else on the account I can help with?";
                case 'SMALL_TALK':
                    return "What can I help you with today?";
                default:
                    return "Anything else I can help with?";
            }
        }
        
        // ========================================
        // HELPER: Determine Follow-Up Mode based on scenario type
        // ========================================
        // ASK_IF_BOOK only for booking-eligible scenarios
        // This prevents pushy behavior like asking to schedule after a billing question
        function getFollowUpModeForScenario(scenarioType, bookingIntent, aiSuggestedMode) {
            // If AI explicitly suggested NONE, respect it
            if (aiSuggestedMode === 'NONE') return 'NONE';
            
            // Booking-eligible scenarios can use ASK_IF_BOOK
            const bookingEligibleTypes = ['BOOKING', 'EMERGENCY', 'TROUBLESHOOT'];
            const isBookingEligible = bookingIntent || bookingEligibleTypes.includes(scenarioType);
            
            if (isBookingEligible && (aiSuggestedMode === 'ASK_IF_BOOK' || bookingIntent)) {
                return 'ASK_IF_BOOK';
            }
            
            // Default to NONE for FAQ, BILLING, SMALL_TALK, TRANSFER
            return 'NONE';
        }
        
        // ========================================
        // UTILS
        // ========================================
        async function viewCalls(gapId) {
            const gap = currentGaps.find(g => g.id === gapId);
            if (!gap || !gap.callIds || gap.callIds.length === 0) {
                showToast('No calls available for this gap', 'error');
                return;
            }
            
            // Show loading state
            const modal = document.getElementById('calls-modal');
            const content = document.getElementById('calls-modal-content');
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top: 12px;">Loading calls...</p></div>';
            modal.classList.add('active');
            
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/admin/scenario-gaps/${companyId}/calls/preview`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ callIds: gap.callIds })
                });
                
                if (!response.ok) throw new Error('Failed to load calls');
                
                const data = await response.json();
                
                if (!data.calls || data.calls.length === 0) {
                    content.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No calls found</p>';
                    return;
                }
                
                // Render calls list
                content.innerHTML = data.calls.map(call => `
                    <div class="call-preview-item" onclick="window.open('/black-box-detail.html?recordingId=${call.id}', '_blank')">
                        <div class="call-preview-header">
                            <span class="call-date">${new Date(call.date).toLocaleDateString()} ${new Date(call.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            <span class="call-phone">${escapeHtml(call.phone)}</span>
                            <span class="call-duration">${call.durationFormatted}</span>
                        </div>
                        <div class="call-preview-text">"${escapeHtml(call.firstLine)}"</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading calls:', error);
                content.innerHTML = `<p style="text-align: center; color: var(--accent-red);">Failed to load calls: ${error.message}</p>`;
            }
        }
        
        function closeCallsModal() {
            document.getElementById('calls-modal').classList.remove('active');
        }
        
        // ========================================
        // COPY FUNCTIONS - For discussion/debugging
        // ========================================
        
        function copyScenarioPreview() {
            if (!currentPreview && !currentGap) {
                showToast('No scenario to copy', 'error');
                return;
            }
            
            const p = currentPreview || {};
            const g = currentGap || {};
            
            // Build CONTENT-ONLY scenario preview
            const scenarioData = buildScenarioPrefill(p, g);
            
            // Count generated settings
            const settingsCount = countGeneratedSettings(scenarioData);
            
            const summary = `## AI-Generated Scenario Content (${settingsCount.generated}/${settingsCount.total} fields)

> **Contract:** Scenarios define WHAT to say, not HOW/WHEN to behave.
> Runtime (ConversationEngine) owns behavior decisions.

### Identity
- **Name:** ${scenarioData.name || 'Unknown'}
- **Status:** ${scenarioData.status || 'live'}
- **Category:** ${scenarioData.category || 'FAQ'}
- **Scenario Type:** ${scenarioData.scenarioType || 'FAQ'}

### Personality & Matching
- **Behavior:** ${scenarioData.behavior || 'calm_professional'}
- **Priority:** ${scenarioData.priority || 0} (-10 to +10)
- **Min Confidence:** ${scenarioData.minConfidence || 0.6}
- **Booking Intent:** ${scenarioData.bookingIntent ? 'Yes' : 'No'}

### Triggers (${(scenarioData.triggers || []).length})
${(scenarioData.triggers || []).map(t => `- "${t}"`).join('\n') || '(none)'}

### Regex Triggers (${(scenarioData.regexTriggers || []).length})
${(scenarioData.regexTriggers || []).map(t => `- \`${t}\``).join('\n') || '(none)'}

### Negative Triggers (${(scenarioData.negativeTriggers || []).length})
${(scenarioData.negativeTriggers || []).map(t => `- "${t}"`).join('\n') || '(none)'}

### Quick Replies (${(scenarioData.quickReplies || []).length})
${(scenarioData.quickReplies || []).map((r, i) => `${i + 1}. "${r}"`).join('\n') || '(none)'}

### Quick Replies - No Name (${(scenarioData.quickReplies_noName || []).length})
${(scenarioData.quickReplies_noName || []).map((r, i) => `${i + 1}. "${r}"`).join('\n') || '(none)'}

### Full Replies (${(scenarioData.fullReplies || []).length})
${(scenarioData.fullReplies || []).map((r, i) => `${i + 1}. "${r}"`).join('\n') || '(none)'}

### Full Replies - No Name (${(scenarioData.fullReplies_noName || []).length})
${(scenarioData.fullReplies_noName || []).map((r, i) => `${i + 1}. "${r}"`).join('\n') || '(none)'}

### Entity Capture
${(scenarioData.entityCapture || []).map(e => `- ${e}`).join('\n') || '- (none)'}

### Gap Context
- **Representative phrase:** "${g.representative || 'N/A'}"
- **Call count:** ${g.count || g.callIds?.length || 0}
- **Priority:** ${g.priority || 'MEDIUM'}

---
**Runtime-Owned (NOT in scenario):**
Follow-up mode, action type, handoff policy, timers, hooks, silence policy

*Generated: ${new Date().toISOString()}*
*Content Coverage: ${settingsCount.generated}/${settingsCount.total} (${Math.round(settingsCount.generated / settingsCount.total * 100)}%)*`;

            navigator.clipboard.writeText(summary).then(() => {
                showToast('Scenario content copied!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy', 'error');
            });
        }
        
        // Helper to count CONTENT settings (count derived from REGISTRY)
        function countGeneratedSettings(scenarioData) {
            const checks = [
                // Identity (5)
                scenarioData.name?.trim(),
                scenarioData.status,
                scenarioData.isActive !== undefined,
                scenarioData.category,
                scenarioData.scenarioType,
                // Personality & Priority (3)
                scenarioData.behavior,
                typeof scenarioData.priority === 'number',
                typeof scenarioData.minConfidence === 'number',
                // Triggers (5)
                Array.isArray(scenarioData.triggers) && scenarioData.triggers.length > 0,
                Array.isArray(scenarioData.regexTriggers),
                Array.isArray(scenarioData.negativeTriggers),
                Array.isArray(scenarioData.exampleUserPhrases),
                Array.isArray(scenarioData.negativeUserPhrases),
                // Replies (6)
                Array.isArray(scenarioData.quickReplies) && scenarioData.quickReplies.length > 0,
                Array.isArray(scenarioData.fullReplies),
                Array.isArray(scenarioData.quickReplies_noName),
                Array.isArray(scenarioData.fullReplies_noName),
                scenarioData.replyStrategy,
                // Intent & Extraction (3)
                scenarioData.bookingIntent !== undefined,
                Array.isArray(scenarioData.entityCapture),
                scenarioData.channel
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // NOT COUNTED (Runtime-owned):
                // - followUpMode, followUpFunnel, followUpQuestionText
                // - actionType, handoffPolicy, cooldownSeconds
                // - actionHooks, entityValidation, silencePolicy
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ];
            
            const generated = checks.filter(Boolean).length;
            return { generated, total: checks.length };
        }
        
        function copyPageSummary() {
            const companyName = document.getElementById('company-name')?.textContent || 'Unknown';
            const gapsCount = document.getElementById('gaps-count')?.textContent || '0';
            const tier3Count = document.getElementById('total-tier3')?.textContent || '0';
            const savings = document.getElementById('potential-savings')?.textContent || '$0';
            const highPriority = document.getElementById('high-priority')?.textContent || '0';
            
            // Get current gaps summary
            const gapsSummary = currentGaps.slice(0, 10).map((gap, i) => {
                const priority = gap.priority || 'MEDIUM';
                const count = gap.count || gap.callIds?.length || 0;
                const rep = gap.representative?.substring(0, 80) || 'Unknown';
                return `${i + 1}. [${priority}] "${rep}" (${count} calls)`;
            }).join('\n');
            
            // Get audit summary if available
            const auditScore = document.getElementById('audit-health-score')?.textContent || 'N/A';
            const auditTotal = document.getElementById('audit-total')?.textContent || '0';
            const auditPassing = document.getElementById('audit-passing')?.textContent || '0';
            const auditErrors = document.getElementById('audit-errors')?.textContent || '0';
            
            // Get alignment summary if available
            const alignAgent = document.getElementById('align-agent')?.textContent || 'N/A';
            const alignActive = document.getElementById('align-active')?.textContent || 'N/A';
            
            const summary = `## Scenario Gaps Summary
**Company:** ${companyName}
**Period:** Last ${selectedDays} days

### Overview
- **Tier 3 Calls:** ${tier3Count}
- **Unique Gaps:** ${gapsCount}
- **High Priority:** ${highPriority}
- **Potential Savings:** ${savings}/week

### Top Gaps
${gapsSummary || 'No gaps detected'}

### Audit Health
- **Score:** ${auditScore}
- **Scenarios:** ${auditPassing}/${auditTotal} passing
- **Errors:** ${auditErrors}

### System Alignment
- **Agent Can See:** ${alignAgent} scenarios
- **Active in Templates:** ${alignActive} scenarios

---
*Generated: ${new Date().toISOString()}*
*Page: scenario-gaps.html*`;

            navigator.clipboard.writeText(summary).then(() => {
                showToast('Summary copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy', 'error');
            });
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('i');
            const text = document.getElementById('toast-message');
            
            toast.className = `toast ${type}`;
            icon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            text.textContent = message;
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function showError(message) {
            document.getElementById('gaps-content').innerHTML = `
                <div class="empty-state" style="border-color: var(--accent-red);">
                    <i class="fas fa-exclamation-triangle" style="color: var(--accent-red);"></i>
                    <h3>Error</h3>
                    <p>${escapeHtml(message)}</p>
                </div>
            `;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
