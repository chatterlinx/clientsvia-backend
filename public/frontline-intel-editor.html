<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontline-Intel Editor - Full Screen</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .editor-header {
            background: #2563eb;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .editor-header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-buttons {
            display: flex;
            gap: 12px;
        }
        
        .header-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-close {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .btn-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .btn-reset {
            background: #f97316;
            color: white;
        }
        
        .btn-reset:hover {
            background: #ea580c;
        }
        
        .btn-save {
            background: #10b981;
            color: white;
        }
        
        .btn-save:hover {
            background: #059669;
        }
        
        /* Editor Container */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            overflow: hidden;
        }
        
        /* Info Box */
        .info-box {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .info-box h2 {
            font-size: 16px;
            color: #1e40af;
            margin-bottom: 8px;
        }
        
        .info-box p {
            font-size: 14px;
            color: #1e3a8a;
            line-height: 1.5;
        }
        
        /* Textarea */
        .textarea-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .textarea-header {
            padding: 12px 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .char-count {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
        }
        
        #frontline-intel-textarea {
            flex: 1;
            width: 100%;
            padding: 20px;
            border: none;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            outline: none;
            color: #1e293b;
        }
        
        /* Status Messages */
        .status-message {
            position: fixed;
            top: 80px;
            right: 24px;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
            z-index: 1000;
        }
        
        .status-success {
            background: #10b981;
            color: white;
        }
        
        .status-error {
            background: #ef4444;
            color: white;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="editor-header">
        <h1>
            <span>üß†</span>
            Frontline-Intel Full Screen Editor
        </h1>
        <div class="header-buttons">
            <button class="header-btn btn-close" onclick="closeEditor()">
                ‚úï Close
            </button>
            <button class="header-btn btn-reset" onclick="resetToDefault()">
                üîÑ Reset to Default
            </button>
            <button class="header-btn btn-save" onclick="saveAndClose()">
                üíæ Save & Close
            </button>
        </div>
    </div>

    <!-- Editor Container -->
    <div class="editor-container">
        <!-- Script Builder Panel (Admin-Only) -->
        <div id="frontline-script-builder-panel">
            <!-- Will be populated by FrontlineScriptBuilder.js -->
        </div>
        
        <!-- Info Box -->
        <div class="info-box">
            <h2>üí° What is Frontline-Intel?</h2>
            <p>
                Frontline-Intel is your AI receptionist - an intelligent gatekeeper that extracts intent, looks up customers, 
                validates company/service, and normalizes input before routing. Acts like a human front desk, but smarter!
            </p>
            <ul style="margin-top: 8px; font-size: 13px; color: #1e3a8a;">
                <li><strong>Conversational Tone:</strong> "Never interrupt the caller", "Always say 'Ok' instead of 'Got it!'"</li>
                <li><strong>Booking Protocols:</strong> "Round appointment times to next hour + 2 hour buffer"</li>
                <li><strong>Transfer Rules:</strong> "Before transferring, collect name, phone, and reason for call"</li>
                <li><strong>Emergency Handling:</strong> "If caller says 'emergency', connect immediately"</li>
            </ul>
            <p style="margin-top: 8px; font-size: 12px; color: #3b82f6;">
                ‚úèÔ∏è Fully customizable ‚Ä¢ üîÑ Resettable to default template ‚Ä¢ üìã Works alongside structured rules
            </p>
        </div>

        <!-- Textarea Wrapper -->
        <div class="textarea-wrapper">
            <div class="textarea-header">
                <div>
                    <strong>Instructions (Natural Language)</strong>
                </div>
                <div class="char-count">
                    <span id="char-count">0</span> characters
                </div>
            </div>
            <textarea 
                id="frontline-intel-textarea"
                placeholder="Enter your Frontline-Intel protocols here..."
            ></textarea>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <span>Saving...</span>
        </div>
    </div>

    <script>
        // Get company ID and versionId from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const companyId = urlParams.get('companyId');
        const versionId = urlParams.get('versionId'); // If editing a draft
        
        if (!companyId) {
            alert('Error: No company ID provided');
            window.close();
        }
        
        console.log('[FRONTLINE EDITOR] Initialized', { companyId, versionId, isDraft: !!versionId });
        
        const textarea = document.getElementById('frontline-intel-textarea');
        const charCount = document.getElementById('char-count');
        
        // Default Frontline-Intel template - TRADE-AGNOSTIC using {variables}
        // Works for ANY industry: HVAC, Real Estate, Legal, Medical, etc.
        const DEFAULT_FRONTLINE_INTEL = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
FRONTLINE-INTEL: {companyName} AI RECEPTIONIST
Trade: {companyType} | Service Areas: {serviceAreas}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üéØ YOUR MISSION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
You are the AI receptionist for {companyName}, a {companyType} company.
Your job: Answer calls professionally, understand what callers need, 
collect their information, and route them to the right destination.

üìã BEHAVIOR RULES (Always Follow)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ DO: Greet warmly with "{greeting}"
‚Ä¢ DO: Listen completely before responding - never interrupt
‚Ä¢ DO: Acknowledge their situation briefly, then focus on their actual need
‚Ä¢ DO: Speak naturally and conversationally (avoid robotic phrasing)
‚Ä¢ DO: Confirm important details by repeating them back
‚Ä¢ NEVER: Stay silent more than 2 seconds
‚Ä¢ NEVER: Say "I don't know" - always offer to find out or connect them with someone
‚Ä¢ NEVER: Argue with frustrated callers - empathize first

üîç INTENT DETECTION (What Callers Want)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Listen for these signals to understand the caller's true need:

‚Ä¢ EMERGENCY/URGENT: "emergency", "right now", "immediately", "urgent", safety concerns
  ‚Üí Transfer to {emergencyPhone} or escalate priority

‚Ä¢ SERVICE REQUEST: "need help with", "not working", "broken", "problem with"
  ‚Üí Collect details and schedule service

‚Ä¢ BOOKING/SCHEDULING: "appointment", "schedule", "when can you", "available"
  ‚Üí Enter booking flow, collect required information

‚Ä¢ PRICING INQUIRY: "how much", "cost", "price", "estimate", "quote"
  ‚Üí Explain pricing depends on situation, offer to schedule assessment

‚Ä¢ GENERAL QUESTION: "what are your hours", "where are you located", "do you offer"
  ‚Üí Answer from knowledge base or company info

‚Ä¢ EXISTING CUSTOMER: "checking on", "following up", "my appointment", "reschedule"
  ‚Üí Look up their info, assist with their request

üìù INFORMATION TO COLLECT
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
For service requests, gather (in this order):
1. Full name (first and last)
2. Best callback phone number
3. Service address with zip code
4. Email for confirmation (optional but encouraged)
5. Brief description of what they need
6. Any access instructions (gate codes, parking, etc.)

üìÖ BOOKING PROTOCOL
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
When scheduling:
‚Ä¢ Offer 2-hour time windows (e.g., "between 2-4 PM")
‚Ä¢ Confirm all details before finalizing
‚Ä¢ Mention: "You'll receive a text confirmation at this number"
‚Ä¢ Booking URL: {bookingUrl}

üìû TRANSFER RULES
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ EMERGENCIES ‚Üí Transfer immediately to {emergencyPhone}
‚Ä¢ BILLING QUESTIONS ‚Üí Transfer to {billingPhone}
‚Ä¢ TECHNICAL ISSUES ‚Üí Transfer to {techSupportPhone}
‚Ä¢ WANTS TO SPEAK TO HUMAN ‚Üí Offer to help first, then transfer if they insist

‚ö†Ô∏è WHAT TO AVOID
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Never quote exact prices (say "pricing depends on the specific situation")
‚Ä¢ Never promise specific arrival times (use time windows)
‚Ä¢ Never make guarantees about outcomes
‚Ä¢ Never share other customers' information
‚Ä¢ Never argue or get defensive
‚Ä¢ Never say "that's not my job" or "I can't help with that"

üè¢ COMPANY INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Company: {companyName}
‚Ä¢ Type: {companyType}
‚Ä¢ Main Phone: {mainPhone}
‚Ä¢ Emergency: {emergencyPhone}
‚Ä¢ Hours: {businessHours}
‚Ä¢ Service Areas: {serviceAreas}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CUSTOMIZATION NOTES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚úèÔ∏è Edit this script to match your specific business needs
üî¢ Variables in {brackets} are replaced with your company data
üí° Add trade-specific protocols below this line
üîÑ Use "Reset to Default" to restore this template
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;
        
        // Update character count
        function updateCharCount() {
            const count = textarea.value.length;
            charCount.textContent = count.toLocaleString();
        }
        
        textarea.addEventListener('input', updateCharCount);
        
        // Listen for initial data from parent window
        window.addEventListener('message', (event) => {
            if (event.data.type === 'initFrontlineIntel') {
                console.log('[FRONTLINE EDITOR] Received initial data from parent', {
                    valueLength: event.data.value?.length,
                    versionId: event.data.versionId
                });
                textarea.value = event.data.value || '';
                updateCharCount();
            }
        });
        
        // Load current Frontline-Intel text
        async function loadFrontlineIntel() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/cheat-sheet/${companyId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load Frontline-Intel');
                }
                
                const result = await response.json();
                textarea.value = result.cheatSheet?.frontlineIntel || '';
                updateCharCount();
            } catch (error) {
                console.error('Load error:', error);
                showStatus('Failed to load Frontline-Intel', 'error');
            }
        }
        
        // Save Frontline-Intel
        async function saveFrontlineIntel() {
            try {
                console.log('üîµ CHECKPOINT 1: Starting Frontline-Intel save...');
                document.getElementById('loading-overlay').classList.add('active');
                
                const token = localStorage.getItem('adminToken');
                console.log('üîµ CHECKPOINT 2: Token exists?', !!token);
                
                const url = `/api/admin/cheat-sheet/${companyId}`;
                console.log('üîµ CHECKPOINT 3: Saving to URL:', url);
                
                const payload = {
                    cheatSheet: {
                        frontlineIntel: textarea.value
                    }
                };
                console.log('üîµ CHECKPOINT 4: Payload:', payload);
                console.log('üîµ CHECKPOINT 5: Frontline text length:', textarea.value.length);
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('üîµ CHECKPOINT 6: Response received');
                console.log('   - Status:', response.status);
                console.log('   - OK?:', response.ok);
                console.log('   - Status Text:', response.statusText);
                
                document.getElementById('loading-overlay').classList.remove('active');
                
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error('üî¥ CHECKPOINT 7: Save FAILED');
                    console.error('   - HTTP Status:', response.status);
                    console.error('   - Response Body:', errorBody);
                    throw new Error(`Failed to save: ${response.status} - ${errorBody.substring(0, 200)}`);
                }
                
                const result = await response.json();
                console.log('üü¢ CHECKPOINT 8: Save SUCCESS');
                console.log('   - Result:', result);
                
                showStatus('‚úÖ Saved successfully!', 'success');
                return true;
            } catch (error) {
                document.getElementById('loading-overlay').classList.remove('active');
                console.error('üî¥ CHECKPOINT 9: EXCEPTION CAUGHT');
                console.error('   - Error Message:', error.message);
                console.error('   - Error Stack:', error.stack);
                console.error('   - Full Error:', error);
                showStatus(`‚ùå Save failed: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Reset to default
        async function resetToDefault() {
            // When editing a draft, just load the inlined default template
            if (versionId) {
                if (!confirm('Load default template? This will replace your current text (not saved until you click "Save & Close").')) {
                    return;
                }
                
                // Use the inlined template - no API call needed
                textarea.value = DEFAULT_FRONTLINE_INTEL.trim();
                updateCharCount();
                showStatus('‚úÖ Default template loaded! Click "Save & Close" to save.', 'success');
                return;
            }
            
            // Legacy: Non-draft mode uses API
            if (!confirm('Reset to default template? This will overwrite your current text.')) {
                return;
            }
            
            try {
                document.getElementById('loading-overlay').classList.add('active');
                
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/cheat-sheet/${companyId}/reset-frontline-intel`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                document.getElementById('loading-overlay').classList.remove('active');
                
                if (!response.ok) {
                    throw new Error('Failed to reset');
                }
                
                const result = await response.json();
                textarea.value = result.frontlineIntel;
                updateCharCount();
                showStatus('‚úÖ Reset to default!', 'success');
            } catch (error) {
                document.getElementById('loading-overlay').classList.remove('active');
                console.error('Reset error:', error);
                showStatus('‚ùå Reset failed', 'error');
            }
        }
        
        // Save and close
        async function saveAndClose() {
            // If editing a draft, send data to parent window directly
            if (versionId) {
                console.log('[FRONTLINE EDITOR] Sending data to parent window for draft save');
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({ 
                        type: 'frontlineIntelUpdated',
                        value: textarea.value,
                        versionId: versionId
                    }, '*');
                }
                showStatus('‚úÖ Changes sent to parent window', 'success');
                setTimeout(() => {
                    window.close();
                }, 500);
            } else {
                // Legacy: save directly to main cheat sheet endpoint
                const saved = await saveFrontlineIntel();
                if (saved) {
                    setTimeout(() => {
                        // Notify parent window
                        if (window.opener && !window.opener.closed) {
                            window.opener.postMessage({ 
                                type: 'frontlineIntelUpdated',
                                value: textarea.value
                            }, '*');
                        }
                        window.close();
                    }, 500);
                }
            }
        }
        
        // Close editor
        function closeEditor() {
            if (confirm('Close editor? Unsaved changes will be lost.')) {
                window.close();
            }
        }
        
        // Show status message
        function showStatus(message, type) {
            const existing = document.querySelector('.status-message');
            if (existing) {
                existing.remove();
            }
            
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                statusDiv.remove();
            }, 3000);
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Cmd/Ctrl + S to save and close
            if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                e.preventDefault();
                saveAndClose();
            }
            
            // Escape to close
            if (e.key === 'Escape') {
                closeEditor();
            }
        });
        
        // Load on page load (only if not editing a draft - parent will send data)
        if (!versionId) {
            console.log('[FRONTLINE EDITOR] Loading from API (not editing a draft)');
            loadFrontlineIntel();
        } else {
            console.log('[FRONTLINE EDITOR] Waiting for parent window to send data (editing draft)');
        }
        
        // ================================================================
        // SCRIPT BUILDER INITIALIZATION
        // ================================================================
        
        // Listen for script generated events from the Script Builder
        window.addEventListener('frontlineScriptGenerated', (e) => {
            if (e.detail?.scriptText) {
                console.log('[FRONTLINE EDITOR] Received generated script');
                textarea.value = e.detail.scriptText;
                updateCharCount();
                showStatus('‚úÖ Script generated! Review and save when ready.', 'success');
            }
        });
    </script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Script Builder UI -->
    <script src="/js/ai-agent-settings/FrontlineScriptBuilder.js"></script>
    <script>
        // Initialize Script Builder after page loads
        document.addEventListener('DOMContentLoaded', () => {
            if (companyId) {
                console.log('[FRONTLINE EDITOR] Initializing Script Builder');
                const builder = new FrontlineScriptBuilder(companyId);
                window.scriptBuilder = builder; // For draft loading
                
                const container = document.getElementById('frontline-script-builder-panel');
                if (container) {
                    builder.render(container.parentElement);
                }
            }
        });
    </script>

</body>
</html>

