<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Center | ClientsVia</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CALL CENTER MODULE V2 - STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        :root {
            /* Colors - Deep Navy Theme */
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-card: #1a2332;
            --bg-hover: #243044;
            
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            
            --accent-cyan: #22d3ee;
            --accent-green: #22c55e;
            --accent-yellow: #fbbf24;
            --accent-red: #ef4444;
            --accent-purple: #a855f7;
            --accent-blue: #3b82f6;
            
            --border-color: #334155;
            --border-light: rgba(255,255,255,0.1);
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            /* Typography */
            --font-sans: 'IBM Plex Sans', -apple-system, sans-serif;
            --font-mono: 'IBM Plex Mono', monospace;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 200ms ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LAYOUT
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 100;
        }
        
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: var(--space-lg);
            overflow-y: auto;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SIDEBAR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .sidebar-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
        }
        
        .back-link:hover {
            background: var(--accent-cyan) !important;
            color: var(--bg-primary) !important;
        }
        
        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-cyan);
        }
        
        .sidebar-logo svg {
            width: 24px;
            height: 24px;
        }
        
        .company-selector {
            margin-top: var(--space-md);
        }
        
        .company-selector select {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 13px;
            cursor: pointer;
        }
        
        .company-selector select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        .sidebar-nav {
            flex: 1;
            padding: var(--space-md);
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: var(--space-lg);
        }
        
        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            padding: var(--space-sm) var(--space-md);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            border-radius: 6px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, rgba(34,211,238,0.15) 0%, rgba(59,130,246,0.15) 100%);
            color: var(--accent-cyan);
        }
        
        .nav-item-icon {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }
        
        .nav-item.active .nav-item-icon {
            opacity: 1;
        }
        
        .nav-item-badge {
            margin-left: auto;
            background: var(--accent-red);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .nav-item-badge.pending-badge {
            background: var(--accent-yellow);
            color: var(--bg-primary);
            animation: pulse-badge 2s infinite;
        }
        
        .nav-item.has-items {
            color: var(--accent-yellow);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HEADER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        .page-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: var(--space-xs);
        }
        
        .header-actions {
            display: flex;
            gap: var(--space-sm);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            border: none;
            font-family: var(--font-sans);
        }
        
        .btn-primary {
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }
        
        .btn-primary:hover {
            background: #06b6d4;
        }
        
        .btn-secondary {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           STATS CARDS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: var(--space-lg);
            transition: var(--transition-normal);
        }
        
        .stat-card:hover {
            border-color: var(--accent-cyan);
            box-shadow: var(--shadow-md);
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: var(--font-mono);
        }
        
        .stat-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: var(--space-sm);
            font-size: 13px;
        }
        
        .stat-trend.up {
            color: var(--accent-green);
        }
        
        .stat-trend.down {
            color: var(--accent-red);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TABS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .tabs {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--space-xs);
        }
        
        .tab {
            padding: var(--space-sm) var(--space-md);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            transition: var(--transition-fast);
            font-family: var(--font-sans);
        }
        
        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-card);
        }
        
        .tab.active {
            color: var(--accent-cyan);
            background: var(--bg-card);
            border-bottom: 2px solid var(--accent-cyan);
        }
        
        .tab-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--accent-red);
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-badge 2s infinite;
        }
        
        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 4px rgba(239, 68, 68, 0); }
        }
        
        .tab[data-tab="pending"].has-items {
            color: var(--accent-yellow);
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CALL CARDS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .calls-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .call-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: var(--space-lg);
            cursor: pointer;
            transition: var(--transition-normal);
        }
        
        .call-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .call-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }
        
        .call-card-customer {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        
        .customer-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: white;
        }
        
        .customer-avatar.returning {
            background: linear-gradient(135deg, var(--accent-green), #059669);
        }
        
        .customer-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .customer-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .call-card-meta {
            text-align: right;
        }
        
        .call-time {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .call-duration {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .call-card-body {
            display: flex;
            gap: var(--space-lg);
        }
        
        .call-detail {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .call-detail-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }
        
        .call-detail-value {
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .call-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-light);
        }
        
        .call-tags {
            display: flex;
            gap: var(--space-sm);
        }
        
        .call-tag {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .call-tag.outcome-completed {
            background: rgba(34,197,94,0.15);
            color: var(--accent-green);
        }
        
        .call-tag.outcome-transferred {
            background: rgba(168,85,247,0.15);
            color: var(--accent-purple);
        }
        
        .call-tag.outcome-booked {
            background: rgba(59,130,246,0.15);
            color: var(--accent-blue);
        }
        
        .call-tag.outcome-abandoned {
            background: rgba(239,68,68,0.15);
            color: var(--accent-red);
        }
        
        .call-tag.tier-1 {
            background: rgba(34,211,238,0.15);
            color: var(--accent-cyan);
        }
        
        .call-tag.tier-2 {
            background: rgba(251,191,36,0.15);
            color: var(--accent-yellow);
        }
        
        .call-tag.tier-3 {
            background: rgba(239,68,68,0.15);
            color: var(--accent-red);
        }
        
        .call-actions {
            display: flex;
            gap: var(--space-sm);
        }
        
        .call-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
        }
        
        .call-action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SEARCH & FILTERS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .search-bar {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }
        
        .search-input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            padding-left: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: var(--font-sans);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }
        
        .filter-select {
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: var(--font-sans);
            cursor: pointer;
            min-width: 140px;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MODAL
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-normal);
        }
        
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: var(--transition-normal);
        }
        
        .modal-overlay.open .modal {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
        }
        
        .modal-title {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        
        .modal-title h2 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: var(--transition-fast);
        }
        
        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-sm);
            padding: var(--space-lg);
            border-top: 1px solid var(--border-color);
            background: var(--bg-card);
        }
        
        /* Account Type Badges */
        .account-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .account-badge.residential {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
        }
        
        .account-badge.commercial {
            background: rgba(168, 85, 247, 0.15);
            color: var(--accent-purple);
        }
        
        .phone-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .phone-badge.mobile {
            background: rgba(34, 211, 238, 0.15);
            color: var(--accent-cyan);
        }
        
        .phone-badge.landline {
            background: rgba(251, 191, 36, 0.15);
            color: var(--accent-yellow);
        }
        
        .phone-badge.voip {
            background: rgba(168, 85, 247, 0.15);
            color: var(--accent-purple);
        }
        
        /* Detail Sections */
        .detail-section {
            margin-bottom: var(--space-lg);
        }
        
        .detail-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }
        
        .detail-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .detail-section-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: var(--space-md);
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .detail-item.full-width {
            grid-column: span 2;
        }
        
        .detail-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }
        
        .detail-value {
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .detail-value.empty {
            color: var(--text-muted);
            font-style: italic;
        }
        
        /* Property Cards */
        .property-card {
            background: var(--bg-hover);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: var(--space-md);
            margin-bottom: var(--space-sm);
            transition: var(--transition-fast);
        }
        
        .property-card:hover {
            border-color: var(--accent-cyan);
        }
        
        .property-card.primary {
            border-left: 3px solid var(--accent-green);
        }
        
        .property-card.commercial {
            border-left: 3px solid var(--accent-purple);
        }
        
        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }
        
        .property-name {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .property-address {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .property-access {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: var(--space-sm);
            padding-top: var(--space-sm);
            border-top: 1px solid var(--border-light);
        }
        
        /* Household Member Cards */
        .member-card {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            background: var(--bg-hover);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: var(--space-md);
            margin-bottom: var(--space-sm);
        }
        
        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }
        
        .member-info {
            flex: 1;
        }
        
        .member-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .member-details {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Related Accounts */
        .related-account {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-hover);
            border-radius: 8px;
            margin-bottom: var(--space-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .related-account:hover {
            background: var(--bg-card);
            border: 1px solid var(--accent-cyan);
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }
        
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
        }
        
        .action-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            background: rgba(34, 211, 238, 0.1);
        }
        
        .action-btn.primary {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border-color: var(--accent-cyan);
        }
        
        .action-btn.primary:hover {
            background: #06b6d4;
        }
        
        /* Tabs in Modal */
        .modal-tabs {
            display: flex;
            gap: 4px;
            padding: 0 var(--space-lg);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-tab {
            padding: var(--space-sm) var(--space-md);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition-fast);
        }
        
        .modal-tab:hover {
            color: var(--text-primary);
        }
        
        .modal-tab.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           VENDOR SUBTABS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .vendor-subtab {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .vendor-subtab:hover {
            border-color: var(--accent-cyan);
            color: var(--text-primary);
        }
        
        .vendor-subtab.active {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border-color: var(--accent-cyan);
        }
        
        .vendor-subpanel {
            display: none;
        }
        
        .vendor-subpanel.active {
            display: block;
        }
        
        .stat-card.mini {
            padding: var(--space-md);
            text-align: center;
        }
        
        /* Vendor Card */
        .vendor-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            transition: var(--transition-fast);
            cursor: pointer;
        }
        
        .vendor-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }
        
        .vendor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }
        
        .vendor-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .vendor-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .vendor-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .vendor-type-badge.supply_house {
            background: rgba(34, 211, 238, 0.15);
            color: var(--accent-cyan);
        }
        
        .vendor-type-badge.parts_distributor {
            background: rgba(168, 85, 247, 0.15);
            color: var(--accent-purple);
        }
        
        .vendor-type-badge.delivery_service {
            background: rgba(251, 191, 36, 0.15);
            color: var(--accent-yellow);
        }
        
        .vendor-type-badge.equipment_manufacturer {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
        }
        
        /* Vendor Call Card */
        .vendor-call-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--accent-cyan);
            border-radius: 0 12px 12px 0;
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            transition: var(--transition-fast);
        }
        
        .vendor-call-card:hover {
            border-color: var(--accent-cyan);
        }
        
        .vendor-call-card.urgent {
            border-left-color: var(--accent-red);
            background: rgba(239, 68, 68, 0.05);
        }
        
        .vendor-call-card.high {
            border-left-color: var(--accent-yellow);
        }
        
        .vendor-call-card.pending {
            border-left-color: var(--accent-yellow);
        }
        
        .vendor-call-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-sm);
        }
        
        .vendor-call-vendor {
            font-weight: 600;
            font-size: 15px;
        }
        
        .vendor-call-time {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .vendor-call-summary {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }
        
        .vendor-call-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            align-items: center;
        }
        
        .vendor-call-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            background: var(--bg-hover);
            color: var(--text-secondary);
        }
        
        .vendor-call-tag.order {
            background: rgba(34, 211, 238, 0.15);
            color: var(--accent-cyan);
        }
        
        .vendor-call-tag.customer {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
        }
        
        .vendor-call-tag.action {
            background: rgba(251, 191, 36, 0.15);
            color: var(--accent-yellow);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LOADING & EMPTY STATES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        .cal-status-live { color: #22c55e !important; }
        .cal-status-offline { color: #ef4444 !important; }
        .cal-status-loading { color: #f59e0b !important; }
        
        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: var(--space-md);
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 18px;
            margin-bottom: var(--space-sm);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESPONSIVE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <!-- Back to Cheat Sheet Button -->
                <a href="#" onclick="goBackToCheatSheet()" class="back-link" style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-muted); text-decoration: none; margin-bottom: 12px; padding: 6px 10px; background: var(--bg-hover); border-radius: 6px; transition: all 0.2s;">
                    <span style="font-size: 14px;">â†</span> Back to Cheat Sheet
                </a>
                
                <div class="sidebar-logo">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
                    </svg>
                    Call Center
                </div>
                
                <div class="company-selector">
                    <select id="company-select">
                        <option value="">Loading companies...</option>
                    </select>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Action Required</div>
                    <a class="nav-item" data-tab="pending" style="position: relative;">
                        <span class="nav-item-icon">ğŸ“‹</span>
                        Pending Review
                        <span class="nav-item-badge pending-badge" id="sidebar-pending-badge" style="display: none;">0</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Call Management</div>
                    <a class="nav-item active" data-tab="calls">
                        <span class="nav-item-icon">ğŸ“</span>
                        Recent Calls
                        <span class="nav-item-badge" id="flagged-count" style="display: none;">0</span>
                    </a>
                    <a class="nav-item" data-tab="customers">
                        <span class="nav-item-icon">ğŸ‘¥</span>
                        Customers
                    </a>
                    <a class="nav-item" data-tab="search">
                        <span class="nav-item-icon">ğŸ”</span>
                        Search
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Analytics</div>
                    <a class="nav-item" data-tab="analytics">
                        <span class="nav-item-icon">ğŸ“Š</span>
                        Dashboard
                    </a>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="page-header">
                <div>
                    <h1 class="page-title">Call Center</h1>
                    <p class="page-subtitle" id="page-subtitle">Loading...</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" id="refresh-btn">
                        ğŸ”„ Refresh
                    </button>
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Today's Calls</div>
                    <div class="stat-value" id="stat-total-calls">â€”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Appointments Booked</div>
                    <div class="stat-value" id="stat-booked">â€”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Duration</div>
                    <div class="stat-value" id="stat-duration">â€”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Tier 1 Rate</div>
                    <div class="stat-value" id="stat-tier1">â€”</div>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab" data-tab="pending" style="position: relative;">
                    ğŸ“‹ Pending Review
                    <span id="pending-review-badge" class="tab-badge" style="display: none;">0</span>
                </button>
                <button class="tab active" data-tab="calls">ğŸ“ Recent Calls</button>
                <button class="tab" data-tab="calendar">ğŸ“… Calendar</button>
                <button class="tab" data-tab="customers">ğŸ‘¥ Customers</button>
                <button class="tab" data-tab="vendors">ğŸª Vendors</button>
                <button class="tab" data-tab="search">ğŸ” Search</button>
                <button class="tab" data-tab="analytics">ğŸ“Š Analytics</button>
            </div>
            
            <!-- Tab Panels -->
            
            <!-- PENDING REVIEW PANEL -->
            <div id="pending-panel" class="tab-panel">
                <div class="pending-review-header" style="margin-bottom: var(--space-lg); padding: var(--space-lg); background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(239, 68, 68, 0.05)); border: 1px solid var(--accent-yellow); border-radius: 12px;">
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-sm);">
                        <span style="font-size: 24px;">ğŸ“‹</span>
                        <h3 style="margin: 0; color: var(--accent-yellow);">Pending Review Queue</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin: 0; font-size: 14px;">
                        Calls that need human review: merge with existing profile, mark as spam, edit details, or delete. 
                        Clear this queue to keep your data clean!
                    </p>
                </div>
                
                <!-- Pending Review Filters -->
                <div class="search-bar" style="margin-bottom: var(--space-lg);">
                    <select class="filter-select" id="pending-type-filter" style="min-width: 160px;">
                        <option value="">All Types</option>
                        <option value="unknown">Unknown Callers</option>
                        <option value="unclassified">Unclassified</option>
                        <option value="duplicate">Possible Duplicates</option>
                        <option value="low_confidence">Low Confidence</option>
                    </select>
                    <button class="btn btn-secondary" onclick="markAllReviewed()" style="margin-left: auto;">
                        âœ“ Mark All Reviewed
                    </button>
                </div>
                
                <!-- Pending Review List -->
                <div class="calls-container" id="pending-container">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 16px;">Loading pending reviews...</p>
                    </div>
                </div>
            </div>
            
            <div id="calls-panel" class="tab-panel active">
                <!-- Search & Filters -->
                <div class="search-bar">
                    <div class="search-input-wrapper">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" class="search-input" id="calls-search" placeholder="Search by phone, name, or intent...">
                    </div>
                    <select class="filter-select" id="outcome-filter">
                        <option value="">All Outcomes</option>
                        <option value="completed">Completed</option>
                        <option value="booked">Booked</option>
                        <option value="transferred">Transferred</option>
                        <option value="abandoned">Abandoned</option>
                    </select>
                    <select class="filter-select" id="tier-filter">
                        <option value="">All Tiers</option>
                        <option value="1">Tier 1</option>
                        <option value="2">Tier 2</option>
                        <option value="3">Tier 3</option>
                    </select>
                </div>
                
                <!-- Calls List -->
                <div class="calls-container" id="calls-container">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 16px;">Loading calls...</p>
                    </div>
                </div>
            </div>
            
            <!-- CALENDAR PANEL -->
            <div id="calendar-panel" class="tab-panel">
                <!-- Calendar Status Bar -->
                <div id="cal-status-bar" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-md); padding: 12px 16px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: var(--space-md);">
                        <!-- Live Status Indicator -->
                        <div id="cal-live-status" style="display: flex; align-items: center; gap: 8px;">
                            <span id="cal-status-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #22c55e; animation: pulse 2s infinite;"></span>
                            <span id="cal-status-text" style="font-weight: 600; color: #22c55e;">Live</span>
                        </div>
                        <span style="color: var(--border-color);">|</span>
                        <!-- Last Sync Time -->
                        <div style="display: flex; align-items: center; gap: 6px; color: var(--text-secondary); font-size: 13px;">
                            <span style="font-size: 11px;">ğŸ”„</span>
                            <span>Last sync:</span>
                            <span id="cal-last-sync" style="font-weight: 500;">--</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-sm);">
                        <!-- Event Count -->
                        <span id="cal-event-count" style="font-size: 13px; color: var(--text-secondary);">0 events this month</span>
                        <!-- Refresh Button -->
                        <button class="btn btn-secondary" id="cal-refresh" style="padding: 6px 12px; font-size: 13px;">
                            <span id="cal-refresh-icon">ğŸ”„</span>
                            <span style="margin-left: 4px;">Refresh</span>
                        </button>
                    </div>
                </div>
                
                <!-- Calendar Header -->
                <div class="calendar-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-lg); padding: var(--space-md); background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: var(--space-md);">
                        <button class="btn btn-secondary" id="cal-prev" style="padding: 8px 14px; font-size: 16px;">â—€</button>
                        <h3 id="cal-month-year" style="margin: 0; min-width: 180px; text-align: center;">January 2026</h3>
                        <button class="btn btn-secondary" id="cal-next" style="padding: 8px 14px; font-size: 16px;">â–¶</button>
                        <button class="btn btn-secondary" id="cal-today" style="margin-left: var(--space-md);">Today</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-sm);">
                        <button class="btn btn-secondary cal-view-btn active" data-view="month">Month</button>
                        <button class="btn btn-secondary cal-view-btn" data-view="week">Week</button>
                        <button class="btn btn-secondary cal-view-btn" data-view="day">Day</button>
                    </div>
                </div>
                
                <!-- Calendar Grid -->
                <div id="calendar-container" style="background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden;">
                    <!-- Day Headers -->
                    <div class="cal-day-headers" style="display: grid; grid-template-columns: repeat(7, 1fr); background: var(--bg-hover); border-bottom: 1px solid var(--border-color);">
                        <div style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Sun</div>
                        <div style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Mon</div>
                        <div style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Tue</div>
                        <div style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Wed</div>
                        <div style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Thu</div>
                        <div style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Fri</div>
                        <div style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Sat</div>
                    </div>
                    <!-- Calendar Days Grid -->
                    <div id="cal-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); min-height: 500px;">
                        <!-- Days will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Day Detail Sidebar (shows when clicking a day) -->
                <div id="cal-day-detail" style="display: none; margin-top: var(--space-lg); background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); padding: var(--space-lg);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
                        <h4 id="cal-detail-date" style="margin: 0;">January 21, 2026</h4>
                        <button class="btn btn-secondary" onclick="document.getElementById('cal-day-detail').style.display='none'">âœ• Close</button>
                    </div>
                    <div id="cal-detail-events" style="display: flex; flex-direction: column; gap: var(--space-sm);">
                        <!-- Events for selected day will appear here -->
                    </div>
                </div>
                
                <!-- No Calendar Connected State -->
                <div id="cal-not-connected" style="display: none; text-align: center; padding: 60px 20px;">
                    <div style="font-size: 48px; margin-bottom: var(--space-md);">ğŸ“…</div>
                    <h3 style="margin-bottom: var(--space-sm);">Google Calendar Not Connected</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">Connect your Google Calendar in Company Profile to see appointments here.</p>
                    <a href="company-profile.html?id=${companyId}#configuration" class="btn btn-primary">
                        <i class="fas fa-link mr-2"></i>Connect Calendar
                    </a>
                </div>
            </div>
            
            <div id="customers-panel" class="tab-panel">
                <div class="search-bar">
                    <div class="search-input-wrapper">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" class="search-input" id="customers-search" placeholder="Search customers by name, phone, or email...">
                    </div>
                    <select class="filter-select" id="status-filter">
                        <option value="">All Statuses</option>
                        <option value="customer">Customer</option>
                        <option value="lead">Lead</option>
                        <option value="placeholder">New</option>
                    </select>
                </div>
                
                <div class="calls-container" id="customers-container">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 16px;">Loading customers...</p>
                    </div>
                </div>
            </div>
            
            <!-- VENDORS TAB -->
            <div id="vendors-panel" class="tab-panel">
                <!-- Vendor Stats Bar -->
                <div class="stats-bar" id="vendor-stats-bar" style="margin-bottom: var(--space-lg);">
                    <div class="stat-card mini">
                        <div class="stat-value" id="total-vendors-stat">â€”</div>
                        <div class="stat-label">Total Vendors</div>
                    </div>
                    <div class="stat-card mini">
                        <div class="stat-value" id="pending-vendor-actions-stat" style="color: var(--accent-yellow);">â€”</div>
                        <div class="stat-label">Pending Actions</div>
                    </div>
                    <div class="stat-card mini">
                        <div class="stat-value" id="vendor-calls-today-stat">â€”</div>
                        <div class="stat-label">Calls Today</div>
                    </div>
                </div>
                
                <!-- Vendor Subtabs -->
                <div style="display: flex; gap: 8px; margin-bottom: var(--space-lg);">
                    <button class="vendor-subtab active" data-vendor-tab="calls" onclick="switchVendorTab('calls')">ğŸ“ Vendor Calls</button>
                    <button class="vendor-subtab" data-vendor-tab="directory" onclick="switchVendorTab('directory')">ğŸ“‡ Vendor Directory</button>
                    <button class="vendor-subtab" data-vendor-tab="pending" onclick="switchVendorTab('pending')">âš ï¸ Pending Actions</button>
                </div>
                
                <!-- Vendor Calls Sub-Panel -->
                <div id="vendor-calls-subpanel" class="vendor-subpanel active">
                    <div class="search-bar">
                        <div class="search-input-wrapper">
                            <span class="search-icon">ğŸ”</span>
                            <input type="text" class="search-input" id="vendor-calls-search" placeholder="Search vendor calls...">
                        </div>
                        <select class="filter-select" id="vendor-reason-filter">
                            <option value="">All Reasons</option>
                            <option value="order_ready">Order Ready</option>
                            <option value="order_shipped">Order Shipped</option>
                            <option value="order_backordered">Backordered</option>
                            <option value="delivery_attempt">Delivery Attempt</option>
                            <option value="account_invoice">Invoice</option>
                        </select>
                        <button class="btn btn-primary" onclick="showNewVendorCallModal()">+ Log Vendor Call</button>
                    </div>
                    
                    <div class="calls-container" id="vendor-calls-container">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 16px;">Loading vendor calls...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Vendor Directory Sub-Panel -->
                <div id="vendor-directory-subpanel" class="vendor-subpanel" style="display: none;">
                    <div class="search-bar">
                        <div class="search-input-wrapper">
                            <span class="search-icon">ğŸ”</span>
                            <input type="text" class="search-input" id="vendor-search" placeholder="Search vendors by name or phone...">
                        </div>
                        <select class="filter-select" id="vendor-type-filter">
                            <option value="">All Types</option>
                            <option value="supply_house">Supply House</option>
                            <option value="parts_distributor">Parts Distributor</option>
                            <option value="equipment_manufacturer">Manufacturer</option>
                            <option value="delivery_service">Delivery Service</option>
                            <option value="wholesaler">Wholesaler</option>
                        </select>
                        <button class="btn btn-primary" onclick="showNewVendorModal()">+ Add Vendor</button>
                    </div>
                    
                    <div class="calls-container" id="vendors-container">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 16px;">Loading vendors...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Pending Actions Sub-Panel -->
                <div id="vendor-pending-subpanel" class="vendor-subpanel" style="display: none;">
                    <div style="padding: var(--space-md); background: rgba(251, 191, 36, 0.1); border: 1px solid var(--accent-yellow); border-radius: 8px; margin-bottom: var(--space-lg);">
                        <strong style="color: var(--accent-yellow);">âš ï¸ Pending Actions</strong>
                        <p style="margin: 8px 0 0; font-size: 13px; color: var(--text-secondary);">
                            These vendor calls require follow-up. Parts to pick up, orders to confirm, etc.
                        </p>
                    </div>
                    
                    <div class="calls-container" id="pending-actions-container">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 16px;">Loading pending actions...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="search-panel" class="tab-panel">
                <!-- Global Search -->
                <div class="search-bar">
                    <div class="search-input-wrapper">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" class="search-input" id="global-search" placeholder="Search by phone, name, intent, or keyword...">
                    </div>
                    <select class="filter-select" id="search-type-filter">
                        <option value="all">All Records</option>
                        <option value="calls">Calls Only</option>
                        <option value="customers">Customers Only</option>
                    </select>
                    <input type="date" class="filter-select" id="search-start-date" style="width: 160px;">
                    <input type="date" class="filter-select" id="search-end-date" style="width: 160px;">
                </div>
                
                <div class="calls-container" id="search-results-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”</div>
                        <h3>Search All Records</h3>
                        <p>Enter a search term to find calls, customers, or transcripts</p>
                    </div>
                </div>
            </div>
            
            <div id="analytics-panel" class="tab-panel">
                <!-- Analytics Dashboard -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
                    <!-- Tier Usage Card -->
                    <div class="stat-card" style="grid-column: 1;">
                        <div class="stat-label">Tier Usage (30 days)</div>
                        <div id="tier-usage-chart" style="padding: 20px 0;">
                            <div style="display: flex; gap: 10px; align-items: flex-end; height: 100px;">
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                    <div id="tier1-bar" style="width: 100%; background: var(--accent-cyan); border-radius: 4px 4px 0 0; height: 0%; transition: height 0.3s;"></div>
                                    <span style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Tier 1</span>
                                    <span id="tier1-percent" style="font-size: 14px; font-weight: 600;">â€”</span>
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                    <div id="tier2-bar" style="width: 100%; background: var(--accent-yellow); border-radius: 4px 4px 0 0; height: 0%; transition: height 0.3s;"></div>
                                    <span style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Tier 2</span>
                                    <span id="tier2-percent" style="font-size: 14px; font-weight: 600;">â€”</span>
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                    <div id="tier3-bar" style="width: 100%; background: var(--accent-red); border-radius: 4px 4px 0 0; height: 0%; transition: height 0.3s;"></div>
                                    <span style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Tier 3</span>
                                    <span id="tier3-percent" style="font-size: 14px; font-weight: 600;">â€”</span>
                                </div>
                            </div>
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary); border-top: 1px solid var(--border-light); padding-top: 10px;">
                            Estimated LLM cost: <span id="llm-cost" style="font-weight: 600; color: var(--accent-green);">$0.00</span>/month
                        </div>
                    </div>
                    
                    <!-- Top Intents Card -->
                    <div class="stat-card" style="grid-column: 2;">
                        <div class="stat-label">Top Intents (30 days)</div>
                        <div id="top-intents" style="padding: 10px 0;">
                            <div class="loading-container" style="padding: 20px;">
                                <div class="loading-spinner" style="width: 24px; height: 24px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Peak Hours Card -->
                    <div class="stat-card" style="grid-column: span 2;">
                        <div class="stat-label">Peak Hours (30 days)</div>
                        <div id="peak-hours-chart" style="display: flex; gap: 4px; padding: 20px 0; align-items: flex-end; height: 120px;">
                            <!-- Hourly bars will be inserted here -->
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted);">
                            <span>12 AM</span>
                            <span>6 AM</span>
                            <span>12 PM</span>
                            <span>6 PM</span>
                            <span>11 PM</span>
                        </div>
                    </div>
                    
                    <!-- Compliance Status Card -->
                    <div class="stat-card" style="grid-column: span 2;">
                        <div class="stat-label">Compliance Status</div>
                        <div id="compliance-status" style="padding: 15px 0;">
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 200px; background: var(--bg-hover); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-muted);">Data Retention</div>
                                    <div id="retention-status" style="font-size: 16px; font-weight: 600; color: var(--accent-green); margin-top: 5px;">â€”</div>
                                </div>
                                <div style="flex: 1; min-width: 200px; background: var(--bg-hover); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-muted);">Pending Purge</div>
                                    <div id="pending-purge" style="font-size: 16px; font-weight: 600; margin-top: 5px;">â€”</div>
                                </div>
                                <div style="flex: 1; min-width: 200px; background: var(--bg-hover); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-muted);">Duplicate Customers</div>
                                    <div id="duplicate-count" style="font-size: 16px; font-weight: 600; margin-top: 5px;">â€”</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Customer Detail Modal -->
    <div class="modal-overlay" id="customer-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <div class="customer-avatar" id="modal-avatar">?</div>
                    <div>
                        <h2 id="modal-customer-name">Loading...</h2>
                        <div style="display: flex; gap: 8px; margin-top: 4px;">
                            <span class="account-badge residential" id="modal-account-type">ğŸ  Residential</span>
                            <span class="phone-badge mobile" id="modal-phone-type">ğŸ“± Mobile</span>
                        </div>
                    </div>
                </div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="modal-tabs">
                <button class="modal-tab active" data-modal-tab="overview">Overview</button>
                <button class="modal-tab" data-modal-tab="intelligence" style="background: linear-gradient(135deg, rgba(244,114,182,0.1), rgba(167,139,250,0.1)); border: 1px solid rgba(244,114,182,0.3);">ğŸ§  AI Intelligence</button>
                <button class="modal-tab" data-modal-tab="properties">Properties</button>
                <button class="modal-tab" data-modal-tab="household">Household</button>
                <button class="modal-tab" data-modal-tab="history">Call History</button>
                <button class="modal-tab" data-modal-tab="commercial" id="commercial-tab" style="display: none;">Commercial</button>
            </div>
            
            <div class="modal-body">
                <!-- Overview Tab -->
                <div class="modal-tab-panel active" id="modal-panel-overview">
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <span class="detail-section-title">ğŸ“‹ Contact Information</span>
                        </div>
                        <div class="detail-section-content">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Phone</span>
                                    <span class="detail-value" id="modal-phone">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Email</span>
                                    <span class="detail-value" id="modal-email">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Status</span>
                                    <span class="detail-value" id="modal-status">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Customer ID</span>
                                    <span class="detail-value" id="modal-customer-id">â€”</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <span class="detail-section-title">ğŸ“Š Statistics</span>
                        </div>
                        <div class="detail-section-content">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Total Calls</span>
                                    <span class="detail-value" id="modal-total-calls">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Appointments</span>
                                    <span class="detail-value" id="modal-appointments">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">First Contact</span>
                                    <span class="detail-value" id="modal-first-contact">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Last Contact</span>
                                    <span class="detail-value" id="modal-last-contact">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Lifetime Value</span>
                                    <span class="detail-value" id="modal-ltv">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Properties</span>
                                    <span class="detail-value" id="modal-property-count">â€”</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <span class="detail-section-title">ğŸ“ Special Notes</span>
                            <button class="action-btn" onclick="editNotes()">âœï¸ Edit</button>
                        </div>
                        <div class="detail-section-content">
                            <div class="detail-value" id="modal-notes" style="white-space: pre-wrap;">No special notes</div>
                        </div>
                    </div>
                    
                    <div class="detail-section" id="related-accounts-section" style="display: none;">
                        <div class="detail-section-header">
                            <span class="detail-section-title">ğŸ”— Related Accounts</span>
                        </div>
                        <div class="detail-section-content" id="modal-related-accounts">
                            <!-- Related accounts will be inserted here -->
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="action-btn" onclick="addProperty()">ğŸ  Add Property</button>
                        <button class="action-btn" onclick="addHouseholdMember()">ğŸ‘¤ Add Household Member</button>
                        <button class="action-btn" id="convert-commercial-btn" onclick="convertToCommercial()">ğŸ¢ Create Commercial Profile</button>
                        <button class="action-btn" onclick="linkAccount()">ğŸ”— Link Account</button>
                    </div>
                </div>
                
                <!-- AI Intelligence Tab -->
                <div class="modal-tab-panel" id="modal-panel-intelligence" style="display: none;">
                    <div id="intelligence-loading" style="text-align: center; padding: 40px;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 16px; color: var(--text-secondary);">Loading AI Intelligence...</p>
                    </div>
                    <div id="intelligence-content" style="display: none;">
                        <!-- Data Completeness Score -->
                        <div class="detail-section" style="background: linear-gradient(135deg, rgba(244,114,182,0.1), rgba(167,139,250,0.1)); border: 1px solid rgba(244,114,182,0.3);">
                            <div class="detail-section-header">
                                <span class="detail-section-title">ğŸ“Š Customer Knowledge Score</span>
                            </div>
                            <div class="detail-section-content">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div id="intel-score-circle" style="width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(var(--accent-cyan) 0%, var(--bg-card) 0%); display: flex; align-items: center; justify-content: center;">
                                        <div style="width: 60px; height: 60px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700;" id="intel-score-value">0%</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 14px; color: var(--text-secondary);">Data completeness</div>
                                        <div id="intel-score-level" style="font-size: 18px; font-weight: 600; color: var(--accent-cyan);">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Notes Section -->
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <span class="detail-section-title">ğŸ§  AI Learned Notes</span>
                                <span id="intel-notes-count" style="font-size: 12px; color: var(--text-muted);">0 notes</span>
                            </div>
                            <div class="detail-section-content" id="intel-notes-list">
                                <div style="color: var(--text-muted); font-style: italic;">No AI notes yet. Intelligence is gathered from conversations.</div>
                            </div>
                        </div>
                        
                        <!-- Equipment Section -->
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <span class="detail-section-title">âš™ï¸ Equipment on File</span>
                                <span id="intel-equipment-count" style="font-size: 12px; color: var(--text-muted);">0 items</span>
                            </div>
                            <div class="detail-section-content" id="intel-equipment-list">
                                <div style="color: var(--text-muted); font-style: italic;">No equipment recorded.</div>
                            </div>
                        </div>
                        
                        <!-- Preferences Section -->
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <span class="detail-section-title">ğŸ¯ Customer Preferences</span>
                            </div>
                            <div class="detail-section-content" id="intel-preferences">
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <span class="detail-label">Preferred Tech</span>
                                        <span class="detail-value" id="intel-pref-tech">â€”</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Preferred Time</span>
                                        <span class="detail-value" id="intel-pref-time">â€”</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Contact Method</span>
                                        <span class="detail-value" id="intel-pref-contact">â€”</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Comm. Style</span>
                                        <span class="detail-value" id="intel-pref-style">â€”</span>
                                    </div>
                                </div>
                                <div id="intel-special-instructions" style="margin-top: 12px; display: none;">
                                    <span class="detail-label">Special Instructions</span>
                                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-top: 4px; color: var(--text-primary);"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Service Visits Section -->
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <span class="detail-section-title">ğŸ”§ Service Visit History</span>
                                <span id="intel-visits-count" style="font-size: 12px; color: var(--text-muted);">0 visits</span>
                            </div>
                            <div class="detail-section-content" id="intel-visits-list">
                                <div style="color: var(--text-muted); font-style: italic;">No service visits recorded.</div>
                            </div>
                        </div>
                        
                        <!-- Call Summary Section -->
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <span class="detail-section-title">ğŸ“ Call History Summary</span>
                                <span id="intel-calls-count" style="font-size: 12px; color: var(--text-muted);">0 calls</span>
                            </div>
                            <div class="detail-section-content" id="intel-calls-list">
                                <div style="color: var(--text-muted); font-style: italic;">No calls recorded.</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Properties Tab -->
                <div class="modal-tab-panel" id="modal-panel-properties" style="display: none;">
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <span class="detail-section-title">ğŸ  Properties (<span id="property-count-label">0</span>)</span>
                            <button class="action-btn primary" onclick="addProperty()">+ Add Property</button>
                        </div>
                        <div id="properties-list">
                            <!-- Properties will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- Household Tab -->
                <div class="modal-tab-panel" id="modal-panel-household" style="display: none;">
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <span class="detail-section-title">ğŸ‘¥ Household Members (<span id="household-count-label">0</span>)</span>
                            <button class="action-btn primary" onclick="addHouseholdMember()">+ Add Member</button>
                        </div>
                        <div id="household-list">
                            <!-- Household members will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- Call History Tab -->
                <div class="modal-tab-panel" id="modal-panel-history" style="display: none;">
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <span class="detail-section-title">ğŸ“ Recent Calls</span>
                        </div>
                        <div id="call-history-list">
                            <!-- Call history will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- Commercial Tab -->
                <div class="modal-tab-panel" id="modal-panel-commercial" style="display: none;">
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <span class="detail-section-title">ğŸ¢ Business Information</span>
                            <button class="action-btn" onclick="editCommercial()">âœï¸ Edit</button>
                        </div>
                        <div class="detail-section-content">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Business Name</span>
                                    <span class="detail-value" id="modal-business-name">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Location Name</span>
                                    <span class="detail-value" id="modal-location-name">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Industry</span>
                                    <span class="detail-value" id="modal-industry">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Payment Terms</span>
                                    <span class="detail-value" id="modal-payment-terms">â€”</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <span class="detail-section-title">ğŸšª Access Instructions</span>
                        </div>
                        <div class="detail-section-content">
                            <div class="detail-grid">
                                <div class="detail-item full-width">
                                    <span class="detail-label">Service Entrance</span>
                                    <span class="detail-value" id="modal-service-entrance">â€”</span>
                                </div>
                                <div class="detail-item full-width">
                                    <span class="detail-label">Unit Location</span>
                                    <span class="detail-value" id="modal-unit-location">â€”</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <span class="detail-section-title">ğŸ‘¤ Site Contact</span>
                        </div>
                        <div class="detail-section-content">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Name</span>
                                    <span class="detail-value" id="modal-site-contact-name">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Title</span>
                                    <span class="detail-value" id="modal-site-contact-title">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Phone</span>
                                    <span class="detail-value" id="modal-site-contact-phone">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Text Notifications</span>
                                    <span class="detail-value" id="modal-text-phone">â€”</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <span class="detail-section-title">ğŸ’³ Billing Information</span>
                        </div>
                        <div class="detail-section-content">
                            <div class="detail-grid">
                                <div class="detail-item full-width">
                                    <span class="detail-label">Billing Address</span>
                                    <span class="detail-value" id="modal-billing-address">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Billing Contact</span>
                                    <span class="detail-value" id="modal-billing-contact">â€”</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Requires PO</span>
                                    <span class="detail-value" id="modal-requires-po">â€”</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <span class="detail-section-title">ğŸ‘¥ Authorized Callers</span>
                            <button class="action-btn" onclick="addAuthorizedCaller()">+ Add Caller</button>
                        </div>
                        <div id="authorized-callers-list">
                            <!-- Authorized callers will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" onclick="saveCustomer()">ğŸ’¾ Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Call Detail Modal -->
    <div class="modal-overlay" id="call-modal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">
                    <div class="customer-avatar" id="call-modal-avatar">?</div>
                    <div>
                        <h2 id="call-modal-customer-name">Unknown Caller</h2>
                        <div style="display: flex; gap: 12px; align-items: center; font-size: 13px; color: var(--text-secondary);">
                            <span id="call-modal-phone">â€”</span>
                            <span>â€¢</span>
                            <span id="call-modal-date">â€”</span>
                            <span>â€¢</span>
                            <span id="call-modal-duration">â€”</span>
                        </div>
                    </div>
                </div>
                <button class="modal-close" onclick="closeCallModal()">âœ•</button>
            </div>
            
            <div class="modal-body" style="padding: 24px;">
                <!-- Call Stats -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="background: var(--bg-card); padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Outcome</div>
                        <div style="font-size: 18px; font-weight: 600;" id="call-modal-outcome">â€”</div>
                    </div>
                    <div style="background: var(--bg-card); padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Intent</div>
                        <div style="font-size: 14px; font-weight: 500;" id="call-modal-intent">â€”</div>
                    </div>
                    <div style="background: var(--bg-card); padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Routing Tier</div>
                        <div style="font-size: 18px; font-weight: 600;" id="call-modal-tier">â€”</div>
                    </div>
                    <div style="background: var(--bg-card); padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Turns</div>
                        <div style="font-size: 18px; font-weight: 600;" id="call-modal-turns">â€”</div>
                    </div>
                </div>
                
                <!-- Transcript Section -->
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
                        ğŸ“ Conversation Transcript
                    </h3>
                    <div id="call-modal-transcript" style="background: var(--bg-card); border-radius: 8px; padding: 16px; max-height: 400px; overflow-y: auto;">
                        <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                            Loading transcript...
                        </div>
                    </div>
                </div>
                
                <!-- AI Summary -->
                <div id="call-modal-summary-section" style="display: none; margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
                        ğŸ¤– AI Summary
                    </h3>
                    <div id="call-modal-summary" style="background: var(--bg-card); border-radius: 8px; padding: 16px; color: var(--text-secondary); font-size: 14px;">
                    </div>
                </div>
                
                <!-- Slots Collected -->
                <div id="call-modal-slots-section" style="display: none;">
                    <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
                        ğŸ“‹ Information Collected
                    </h3>
                    <div id="call-modal-slots" style="background: var(--bg-card); border-radius: 8px; padding: 16px;">
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCallModal()">Close</button>
                <button class="btn" style="background: var(--accent-yellow); color: #000;" onclick="flagCallFromModal()">ğŸš© Flag Call</button>
                <button class="btn btn-primary" onclick="viewCustomerFromCall()">ğŸ‘¤ View Customer</button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script>
        /**
         * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         * CALL CENTER MODULE V2 - FRONTEND
         * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         */
        
        // State
        let currentCompanyId = null;
        let currentTab = 'calls';
        const token = localStorage.getItem('adminToken');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NAVIGATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function goBackToCheatSheet() {
            const urlParams = new URLSearchParams(window.location.search);
            const companyId = urlParams.get('companyId');
            
            // Navigate back to Control Plane, land on Booking Rules tab
            const controlPlaneUrl = `/control-plane-v2.html?companyId=${companyId}&tab=cheatsheet&subtab=booking`;
            window.location.href = controlPlaneUrl;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Check auth
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            // Get companyId from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentCompanyId = urlParams.get('companyId');
            
            if (!currentCompanyId) {
                document.getElementById('page-subtitle').textContent = 'No company selected';
                showEmptyState('calls-container', 'Please select a company from the Control Plane');
                return;
            }
            
            // Load company info
            await loadCompanyInfo();
            
            // Load today's stats
            await loadTodayStats();
            
            // Load pending review count (for badge)
            await loadPendingCount();
            
            // Load initial calls
            await loadCalls();
            
            // Set up event listeners
            setupEventListeners();
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // API CALLS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function apiCall(endpoint, options = {}) {
            const response = await fetch(endpoint, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            });
            
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            
            return response.json();
        }
        
        async function loadCompanyInfo() {
            try {
                const res = await apiCall(`/api/company/${currentCompanyId}`);
                const company = res.data || res;
                
                document.getElementById('page-subtitle').textContent = 
                    company.businessName || company.companyName || 'Unknown Company';
                    
                // Update company selector
                const select = document.getElementById('company-select');
                select.innerHTML = `<option value="${currentCompanyId}">${company.businessName || company.companyName}</option>`;
            } catch (err) {
                console.error('Failed to load company:', err);
                document.getElementById('page-subtitle').textContent = 'Error loading company';
            }
        }
        
        async function loadTodayStats() {
            try {
                const res = await apiCall(`/api/admin/call-center/${currentCompanyId}/stats/today`);
                const stats = res.data;
                
                document.getElementById('stat-total-calls').textContent = stats.totalCalls || 0;
                document.getElementById('stat-booked').textContent = stats.appointmentsBooked || 0;
                document.getElementById('stat-duration').textContent = 
                    stats.avgDuration ? `${Math.round(stats.avgDuration)}s` : 'â€”';
                document.getElementById('stat-tier1').textContent = 
                    stats.totalCalls > 0 
                        ? `${Math.round((stats.tier1Count / stats.totalCalls) * 100)}%`
                        : 'â€”';
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }
        
        async function loadCalls(filters = {}) {
            const container = document.getElementById('calls-container');
            container.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 16px;">Loading calls...</p>
                </div>
            `;
            
            try {
                const params = new URLSearchParams({ limit: 50, ...filters });
                const res = await apiCall(`/api/admin/call-center/${currentCompanyId}/calls?${params}`);
                const calls = res.data || [];
                
                if (calls.length === 0) {
                    showEmptyState('calls-container', 'No calls yet', 'Calls will appear here as they come in');
                    return;
                }
                
                container.innerHTML = calls.map(call => renderCallCard(call)).join('');
                
            } catch (err) {
                console.error('Failed to load calls:', err);
                showEmptyState('calls-container', 'Error loading calls', err.message);
            }
        }
        
        async function loadCustomers(filters = {}) {
            const container = document.getElementById('customers-container');
            container.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 16px;">Loading customers...</p>
                </div>
            `;
            
            try {
                const params = new URLSearchParams({ limit: 50, ...filters });
                const res = await apiCall(`/api/admin/call-center/${currentCompanyId}/customers?${params}`);
                const customers = res.data || [];
                
                if (customers.length === 0) {
                    showEmptyState('customers-container', 'No customers yet', 'Customers will appear here as calls come in');
                    return;
                }
                
                container.innerHTML = customers.map(c => renderCustomerCard(c)).join('');
                
            } catch (err) {
                console.error('Failed to load customers:', err);
                showEmptyState('customers-container', 'Error loading customers', err.message);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PENDING REVIEW FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function loadPendingReviews(filters = {}) {
            const container = document.getElementById('pending-container');
            container.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 16px;">Loading pending reviews...</p>
                </div>
            `;
            
            try {
                const params = new URLSearchParams({ limit: 100, ...filters });
                const res = await apiCall(`/api/call-center/${currentCompanyId}/pending-review?${params}`);
                const items = res.data || [];
                
                // Update badge count
                updatePendingBadge(items.length);
                
                if (items.length === 0) {
                    showEmptyState('pending-container', 'âœ… All Clear!', 'No pending reviews. Great job keeping your data clean!');
                    return;
                }
                
                container.innerHTML = items.map(item => renderPendingCard(item)).join('');
                
            } catch (err) {
                console.error('Failed to load pending reviews:', err);
                showEmptyState('pending-container', 'Error loading reviews', err.message);
            }
        }
        
        function updatePendingBadge(count) {
            const badge = document.getElementById('pending-review-badge');
            const sidebarBadge = document.getElementById('sidebar-pending-badge');
            const tab = document.querySelector('.tab[data-tab="pending"]');
            const sidebarNav = document.querySelector('.nav-item[data-tab="pending"]');
            
            const displayCount = count > 99 ? '99+' : count;
            
            if (count > 0) {
                if (badge) {
                    badge.textContent = displayCount;
                    badge.style.display = 'flex';
                }
                if (sidebarBadge) {
                    sidebarBadge.textContent = displayCount;
                    sidebarBadge.style.display = 'inline-flex';
                }
                if (tab) tab.classList.add('has-items');
                if (sidebarNav) sidebarNav.classList.add('has-items');
            } else {
                if (badge) badge.style.display = 'none';
                if (sidebarBadge) sidebarBadge.style.display = 'none';
                if (tab) tab.classList.remove('has-items');
                if (sidebarNav) sidebarNav.classList.remove('has-items');
            }
        }
        
        // Load just the pending count (lightweight, for badge updates)
        async function loadPendingCount() {
            try {
                const res = await apiCall(`/api/call-center/${currentCompanyId}/pending-review/count`);
                updatePendingBadge(res.count || 0);
            } catch (err) {
                console.error('Failed to load pending count:', err);
            }
        }
        
        function renderPendingCard(item) {
            const isCall = item.type === 'call';
            const isCustomer = item.type === 'customer';
            const isVendor = item.type === 'vendor';
            
            const name = item.name || item.callerName || 'Unknown';
            const phone = item.phone || item.phoneNumbers?.[0]?.number || '';
            const reason = item.reviewReason || 'Needs classification';
            const initials = getInitials(name);
            const time = item.createdAt ? formatTime(item.createdAt) : '';
            
            // Color based on review reason
            let reasonColor = 'var(--accent-yellow)';
            let reasonIcon = 'âš ï¸';
            if (item.reviewReason?.includes('duplicate')) {
                reasonColor = 'var(--accent-purple)';
                reasonIcon = 'ğŸ”„';
            } else if (item.reviewReason?.includes('spam')) {
                reasonColor = 'var(--accent-red)';
                reasonIcon = 'ğŸš«';
            } else if (item.reviewReason?.includes('unknown')) {
                reasonColor = 'var(--accent-yellow)';
                reasonIcon = 'â“';
            }
            
            return `
                <div class="call-card pending-card" data-id="${item._id}" data-type="${item.type}" 
                     style="border-left: 4px solid ${reasonColor};">
                    <div class="call-card-header">
                        <div class="call-card-customer">
                            <div class="customer-avatar">${initials}</div>
                            <div class="customer-info">
                                <h3>${name}</h3>
                                <p>${formatPhone(phone)} ${time ? 'â€¢ ' + time : ''}</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: ${reasonColor}22; color: ${reasonColor}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                ${reasonIcon} ${reason}
                            </span>
                        </div>
                    </div>
                    
                    ${item.possibleMatches?.length > 0 ? `
                    <div style="margin: 12px 0; padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Possible matches:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${item.possibleMatches.slice(0, 3).map(m => `
                                <button class="btn btn-secondary" style="font-size: 12px; padding: 4px 8px;" 
                                        onclick="mergeWith('${item._id}', '${m._id}', '${item.type}')">
                                    Merge with "${m.name || m.callerName || formatPhone(m.phone)}"
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="call-card-actions" style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                        ${isCall ? `
                            <button class="btn btn-primary" onclick="classifyCall('${item._id}', 'customer')">
                                ğŸ‘¤ Customer
                            </button>
                            <button class="btn btn-secondary" onclick="classifyCall('${item._id}', 'vendor')">
                                ğŸª Vendor
                            </button>
                        ` : `
                            <button class="btn btn-primary" onclick="editProfile('${item._id}', '${item.type}')">
                                âœï¸ Edit
                            </button>
                            ${isCustomer ? `
                                <button class="btn btn-secondary" onclick="convertToVendor('${item._id}')">
                                    â†’ Vendor
                                </button>
                            ` : `
                                <button class="btn btn-secondary" onclick="convertToCustomer('${item._id}')">
                                    â†’ Customer
                                </button>
                            `}
                        `}
                        <button class="btn btn-secondary" onclick="markAsSpam('${item._id}', '${item.type}')" 
                                style="color: var(--accent-red);">
                            ğŸš« Spam
                        </button>
                        <button class="btn btn-secondary" onclick="deletePending('${item._id}', '${item.type}')" 
                                style="color: var(--text-muted);">
                            ğŸ—‘ï¸ Delete
                        </button>
                        <button class="btn btn-secondary" onclick="markReviewed('${item._id}', '${item.type}')"
                                style="margin-left: auto;">
                            âœ“ Reviewed
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Pending Review Actions
        async function classifyCall(id, type) {
            try {
                await apiCall(`/api/call-center/${currentCompanyId}/call/${id}/reclassify`, {
                    method: 'POST',
                    body: JSON.stringify({ callerType: type })
                });
                showToast(`Call classified as ${type}`, 'success');
                loadPendingReviews();
            } catch (err) {
                showToast('Failed to classify: ' + err.message, 'error');
            }
        }
        
        async function mergeWith(sourceId, targetId, type) {
            if (!confirm('Merge these records? This will combine their history.')) return;
            try {
                await apiCall(`/api/call-center/${currentCompanyId}/${type}/${sourceId}/merge`, {
                    method: 'POST',
                    body: JSON.stringify({ targetId })
                });
                showToast('Records merged successfully', 'success');
                loadPendingReviews();
            } catch (err) {
                showToast('Failed to merge: ' + err.message, 'error');
            }
        }
        
        async function convertToVendor(customerId) {
            try {
                await apiCall(`/api/call-center/${currentCompanyId}/customer/${customerId}/convert-to-vendor`, {
                    method: 'POST',
                    body: JSON.stringify({ vendorType: 'other' })
                });
                showToast('Converted to vendor', 'success');
                loadPendingReviews();
            } catch (err) {
                showToast('Failed to convert: ' + err.message, 'error');
            }
        }
        
        async function convertToCustomer(vendorId) {
            try {
                await apiCall(`/api/call-center/${currentCompanyId}/vendor/${vendorId}/convert-to-customer`, {
                    method: 'POST',
                    body: JSON.stringify({ category: 'residential' })
                });
                showToast('Converted to customer', 'success');
                loadPendingReviews();
            } catch (err) {
                showToast('Failed to convert: ' + err.message, 'error');
            }
        }
        
        async function markAsSpam(id, type) {
            if (!confirm('Mark as spam? This will block future calls from this number.')) return;
            try {
                const endpoint = type === 'call' 
                    ? `/api/call-center/${currentCompanyId}/call/${id}/reclassify`
                    : `/api/call-center/${currentCompanyId}/${type}/${id}`;
                    
                await apiCall(endpoint, {
                    method: type === 'call' ? 'POST' : 'PATCH',
                    body: JSON.stringify(type === 'call' ? { callerType: 'spam' } : { markAsSpam: true })
                });
                showToast('Marked as spam and blocked', 'success');
                loadPendingReviews();
            } catch (err) {
                showToast('Failed to mark as spam: ' + err.message, 'error');
            }
        }
        
        async function deletePending(id, type) {
            if (!confirm('Delete this record? This cannot be undone.')) return;
            try {
                await apiCall(`/api/call-center/${currentCompanyId}/${type}/${id}`, {
                    method: 'DELETE'
                });
                showToast('Deleted', 'success');
                loadPendingReviews();
            } catch (err) {
                showToast('Failed to delete: ' + err.message, 'error');
            }
        }
        
        async function markReviewed(id, type) {
            try {
                const endpoint = type === 'call' 
                    ? `/api/call-center/${currentCompanyId}/call/${id}/card`
                    : `/api/call-center/${currentCompanyId}/${type}/${id}`;
                    
                await apiCall(endpoint, {
                    method: 'PATCH',
                    body: JSON.stringify({ needsReview: false, reviewedAt: new Date().toISOString() })
                });
                showToast('Marked as reviewed', 'success');
                loadPendingReviews();
            } catch (err) {
                showToast('Failed to update: ' + err.message, 'error');
            }
        }
        
        async function markAllReviewed() {
            if (!confirm('Mark all items as reviewed?')) return;
            try {
                await apiCall(`/api/call-center/${currentCompanyId}/pending-review/mark-all-reviewed`, {
                    method: 'POST'
                });
                showToast('All items marked as reviewed', 'success');
                loadPendingReviews();
            } catch (err) {
                showToast('Failed to mark all: ' + err.message, 'error');
            }
        }
        
        function editProfile(id, type) {
            // Open edit modal based on type
            if (type === 'customer') {
                viewCustomer(id);
            } else if (type === 'vendor') {
                viewVendor({ _id: id });
            } else {
                viewCall(id);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDER FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function renderCallCard(call) {
            const initials = getInitials(call.callerName || call.phone);
            const isReturning = call.isReturning;
            const time = formatTime(call.startedAt);
            const duration = formatDuration(call.durationSeconds);
            
            return `
                <div class="call-card" data-call-id="${call.callId}">
                    <div class="call-card-header">
                        <div class="call-card-customer">
                            <div class="customer-avatar ${isReturning ? 'returning' : ''}">${initials}</div>
                            <div class="customer-info">
                                <h3>${call.callerName || 'Unknown Caller'}</h3>
                                <p>${formatPhone(call.phone)} ${isReturning ? 'â€¢ Returning' : ''}</p>
                            </div>
                        </div>
                        <div class="call-card-meta">
                            <div class="call-time">${time}</div>
                            <div class="call-duration">${duration}</div>
                        </div>
                    </div>
                    
                    <div class="call-card-body">
                        <div class="call-detail">
                            <span class="call-detail-label">Intent</span>
                            <span class="call-detail-value">${call.primaryIntent || 'Unknown'}</span>
                        </div>
                        ${call.scenarioMatched ? `
                        <div class="call-detail">
                            <span class="call-detail-label">Scenario</span>
                            <span class="call-detail-value">${call.scenarioMatched}</span>
                        </div>
                        ` : ''}
                        ${call.agentNote ? `
                        <div class="call-detail">
                            <span class="call-detail-label">Note</span>
                            <span class="call-detail-value">${call.agentNote}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="call-card-footer">
                        <div class="call-tags">
                            <span class="call-tag outcome-${call.outcome}">${call.outcome}</span>
                            ${call.routingTier ? `<span class="call-tag tier-${call.routingTier}">Tier ${call.routingTier}</span>` : ''}
                            ${call.flagged ? '<span class="call-tag" style="background: rgba(239,68,68,0.15); color: var(--accent-red);">ğŸš© Flagged</span>' : ''}
                        </div>
                        <div class="call-actions">
                            <button class="call-action-btn" onclick="viewCall('${call.callId}')">View</button>
                            <button class="call-action-btn" onclick="flagCall('${call.callId}')">Flag</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderCustomerCard(customer) {
            const initials = getInitials(customer.fullName || customer.phone);
            const accountType = customer.accountType || 'residential';
            const phoneType = customer.phoneType || 'unknown';
            const propertyCount = 1 + (customer.serviceAddresses?.length || 0);
            const householdCount = customer.householdMembers?.length || 0;
            
            const accountIcon = accountType === 'commercial' ? 'ğŸ¢' : 'ğŸ ';
            const phoneIcon = phoneType === 'mobile' ? 'ğŸ“±' : phoneType === 'landline' ? 'â˜ï¸' : 'ğŸ“';
            
            return `
                <div class="call-card" data-customer-id="${customer._id}" onclick="viewCustomer('${customer._id}')" style="cursor: pointer;">
                    <div class="call-card-header">
                        <div class="call-card-customer">
                            <div class="customer-avatar ${customer.status === 'customer' ? 'returning' : ''}" style="${accountType === 'commercial' ? 'background: linear-gradient(135deg, var(--accent-purple), #7c3aed);' : ''}">${initials}</div>
                            <div class="customer-info">
                                <h3>
                                    ${accountIcon} ${customer.fullName || (accountType === 'commercial' && customer.commercial?.businessName) || 'Unknown'}
                                    ${accountType === 'commercial' ? '<span style="font-size: 11px; background: rgba(168,85,247,0.2); color: var(--accent-purple); padding: 2px 6px; border-radius: 4px; margin-left: 8px;">Commercial</span>' : ''}
                                </h3>
                                <p>
                                    ${phoneIcon} ${formatPhone(customer.phone)}
                                    ${customer.canSms ? '<span style="font-size: 10px; color: var(--accent-cyan);">SMS âœ“</span>' : ''}
                                    ${customer.primaryAddress?.city ? ` â€¢ ğŸ“ ${customer.primaryAddress.city}` : ''}
                                </p>
                            </div>
                        </div>
                        <div class="call-card-meta">
                            <div class="call-time">${customer.totalCalls || 0} calls</div>
                            <div class="call-duration">${customer.lastContactAt ? formatRelativeTime(customer.lastContactAt) : 'Never'}</div>
                        </div>
                    </div>
                    
                    <div class="call-card-body" style="padding-top: 8px;">
                        ${propertyCount > 1 ? `
                            <div class="call-detail">
                                <span class="call-detail-label">Properties</span>
                                <span class="call-detail-value">ğŸ  ${propertyCount} locations</span>
                            </div>
                        ` : ''}
                        ${householdCount > 0 ? `
                            <div class="call-detail">
                                <span class="call-detail-label">Household</span>
                                <span class="call-detail-value">ğŸ‘¥ ${householdCount} members</span>
                            </div>
                        ` : ''}
                        ${customer.lifetimeValue > 0 ? `
                            <div class="call-detail">
                                <span class="call-detail-label">Lifetime Value</span>
                                <span class="call-detail-value">ğŸ’° $${customer.lifetimeValue.toLocaleString()}</span>
                            </div>
                        ` : ''}
                        ${customer.specialNotes ? `
                            <div class="call-detail" style="flex: 2;">
                                <span class="call-detail-label">Notes</span>
                                <span class="call-detail-value" style="font-size: 12px; color: var(--text-muted);">${customer.specialNotes.substring(0, 50)}${customer.specialNotes.length > 50 ? '...' : ''}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="call-card-footer">
                        <div class="call-tags">
                            <span class="call-tag outcome-${customer.status === 'customer' ? 'completed' : 'booked'}">${customer.status}</span>
                            ${customer.tags?.slice(0, 3).map(tag => `<span class="call-tag tier-1">${tag}</span>`).join('') || ''}
                        </div>
                        <div class="call-actions">
                            <button class="call-action-btn" onclick="event.stopPropagation(); viewCustomer('${customer._id}')">View Details</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function showEmptyState(containerId, title, message = '') {
            document.getElementById(containerId).innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <h3>${title}</h3>
                    ${message ? `<p>${message}</p>` : ''}
                </div>
            `;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UTILITY FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function getInitials(name) {
            if (!name) return '?';
            if (name.startsWith('+') || /^\d/.test(name)) {
                return name.slice(-2);
            }
            return name.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
        }
        
        function formatPhone(phone) {
            if (!phone) return 'Unknown';
            // Format as (XXX) XXX-XXXX for US numbers
            const cleaned = phone.replace(/\D/g, '');
            if (cleaned.length === 11 && cleaned.startsWith('1')) {
                return `(${cleaned.slice(1, 4)}) ${cleaned.slice(4, 7)}-${cleaned.slice(7)}`;
            }
            return phone;
        }
        
        function formatTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
            return date.toLocaleDateString();
        }
        
        function formatRelativeTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            return `${Math.floor(diffDays / 30)} months ago`;
        }
        
        function formatDuration(seconds) {
            if (!seconds) return 'â€”';
            if (seconds < 60) return `${seconds}s`;
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EVENT HANDLERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab, .nav-item').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = el.dataset.tab;
                    if (tab) switchTab(tab);
                });
            });
            
            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', async () => {
                await loadTodayStats();
                await loadPendingCount(); // Always refresh pending count
                if (currentTab === 'pending') await loadPendingReviews();
                if (currentTab === 'calls') await loadCalls();
                if (currentTab === 'customers') await loadCustomers();
                if (currentTab === 'vendors') {
                    await loadVendorStats();
                    await switchVendorTab(currentVendorSubtab);
                }
            });
            
            // Filters
            document.getElementById('outcome-filter').addEventListener('change', async (e) => {
                await loadCalls({ outcome: e.target.value });
            });
            
            document.getElementById('tier-filter').addEventListener('change', async (e) => {
                const tier = e.target.value;
                await loadCalls(tier ? { routingTier: tier } : {});
            });
            
            document.getElementById('pending-type-filter').addEventListener('change', async (e) => {
                await loadPendingReviews({ type: e.target.value });
            });
            
            // Search (debounced)
            let searchTimeout;
            document.getElementById('calls-search').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadCalls({ query: e.target.value });
                }, 300);
            });
            
            document.getElementById('customers-search').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadCustomers({ query: e.target.value });
                }, 300);
            });
            
            // Global search
            let globalSearchTimeout;
            document.getElementById('global-search').addEventListener('input', () => {
                clearTimeout(globalSearchTimeout);
                globalSearchTimeout = setTimeout(performGlobalSearch, 500);
            });
            
            document.getElementById('search-type-filter').addEventListener('change', performGlobalSearch);
            document.getElementById('search-start-date').addEventListener('change', performGlobalSearch);
            document.getElementById('search-end-date').addEventListener('change', performGlobalSearch);
        }
        
        function switchTab(tab) {
            currentTab = tab;
            
            // Update nav items
            document.querySelectorAll('.nav-item, .tab').forEach(el => {
                el.classList.toggle('active', el.dataset.tab === tab);
            });
            
            // Update panels
            document.querySelectorAll('.tab-panel').forEach(el => {
                el.classList.toggle('active', el.id === `${tab}-panel`);
            });
            
            // Load data for the tab
            if (tab === 'pending') loadPendingReviews();
            if (tab === 'calls') loadCalls();
            if (tab === 'customers') loadCustomers();
            if (tab === 'calendar') loadCalendar();
            if (tab === 'vendors') {
                loadVendorStats();
                switchVendorTab(currentVendorSubtab);
            }
            if (tab === 'analytics') loadAnalytics();
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CALENDAR FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let calendarDate = new Date();
        let calendarEvents = [];
        let calendarView = 'month';
        let calendarLastSync = null;
        
        function updateCalendarStatus(status, message) {
            const dot = document.getElementById('cal-status-dot');
            const text = document.getElementById('cal-status-text');
            const statusBar = document.getElementById('cal-status-bar');
            
            if (!dot || !text) return;
            
            switch(status) {
                case 'live':
                    dot.style.background = '#22c55e';
                    dot.style.animation = 'pulse 2s infinite';
                    text.textContent = 'Live';
                    text.className = 'cal-status-live';
                    statusBar.style.borderColor = 'var(--border-color)';
                    break;
                case 'offline':
                    dot.style.background = '#ef4444';
                    dot.style.animation = 'none';
                    text.textContent = 'Offline';
                    text.className = 'cal-status-offline';
                    statusBar.style.borderColor = '#ef4444';
                    break;
                case 'loading':
                    dot.style.background = '#f59e0b';
                    dot.style.animation = 'pulse 1s infinite';
                    text.textContent = message || 'Syncing...';
                    text.className = 'cal-status-loading';
                    break;
            }
        }
        
        function updateLastSyncTime() {
            const el = document.getElementById('cal-last-sync');
            if (!el) return;
            
            calendarLastSync = new Date();
            const timeStr = calendarLastSync.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                second: '2-digit'
            });
            el.textContent = timeStr;
        }
        
        function updateEventCount(count) {
            const el = document.getElementById('cal-event-count');
            if (el) {
                el.textContent = `${count} event${count !== 1 ? 's' : ''} this month`;
            }
        }
        
        async function loadCalendar() {
            const container = document.getElementById('calendar-container');
            const notConnected = document.getElementById('cal-not-connected');
            const statusBar = document.getElementById('cal-status-bar');
            
            updateCalendarStatus('loading', 'Connecting...');
            
            try {
                // Check if calendar is connected
                const statusRes = await apiCall(`/api/company/${currentCompanyId}/google-calendar/status`);
                
                if (!statusRes.connected) {
                    container.style.display = 'none';
                    statusBar.style.display = 'none';
                    notConnected.style.display = 'block';
                    // Fix the link
                    notConnected.querySelector('a').href = `company-profile.html?id=${currentCompanyId}#configuration`;
                    return;
                }
                
                container.style.display = 'block';
                statusBar.style.display = 'flex';
                notConnected.style.display = 'none';
                
                // Load events for current month
                updateCalendarStatus('loading', 'Fetching events...');
                await loadCalendarEvents();
                renderCalendar();
                wireCalendarControls();
                
                // Update status
                updateCalendarStatus('live');
                updateLastSyncTime();
                updateEventCount(calendarEvents.length);
                
            } catch (err) {
                console.error('Calendar load error:', err);
                updateCalendarStatus('offline');
                container.style.display = 'none';
                notConnected.style.display = 'block';
            }
        }
        
        async function loadCalendarEvents() {
            const start = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), 1);
            const end = new Date(calendarDate.getFullYear(), calendarDate.getMonth() + 1, 0);
            
            try {
                const res = await apiCall(`/api/company/${currentCompanyId}/google-calendar/events?start=${start.toISOString()}&end=${end.toISOString()}`);
                calendarEvents = res.events || [];
            } catch (err) {
                console.error('Failed to load calendar events:', err);
                calendarEvents = [];
            }
        }
        
        function renderCalendar() {
            if (calendarView === 'month') {
                renderMonthView();
            } else if (calendarView === 'week') {
                renderWeekView();
            } else if (calendarView === 'day') {
                renderDayView();
            }
        }
        
        function renderMonthView() {
            const grid = document.getElementById('cal-grid');
            const monthYear = document.getElementById('cal-month-year');
            const dayHeaders = document.querySelector('.cal-day-headers');
            
            // Show day headers for month view
            if (dayHeaders) dayHeaders.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
            
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            monthYear.textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and total days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            // Build grid
            let html = '';
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += `<div class="cal-day empty" style="min-height: 100px; background: var(--bg-hover); border: 1px solid var(--border-color);"></div>`;
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
                const dayEvents = calendarEvents.filter(e => e.start?.dateTime?.startsWith(dateStr) || e.start?.date === dateStr);
                
                html += `
                    <div class="cal-day" data-date="${dateStr}" onclick="showDayDetail('${dateStr}')" 
                         style="min-height: 100px; padding: 8px; border: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; ${isToday ? 'background: rgba(59, 130, 246, 0.1);' : ''}"
                         onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='${isToday ? 'rgba(59, 130, 246, 0.1)' : ''}'">
                        <div style="font-weight: ${isToday ? '700' : '500'}; color: ${isToday ? 'var(--accent-blue)' : 'var(--text-primary)'}; margin-bottom: 4px;">
                            ${day}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 2px; font-size: 11px;">
                            ${dayEvents.slice(0, 3).map(e => {
                                const color = getEventColor(e.colorId);
                                const time = e.start?.dateTime ? new Date(e.start.dateTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : 'All day';
                                return `<div style="background: ${color}; color: white; padding: 2px 4px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${e.summary}">${time} ${e.summary || 'Appointment'}</div>`;
                            }).join('')}
                            ${dayEvents.length > 3 ? `<div style="color: var(--text-muted); font-size: 10px;">+${dayEvents.length - 3} more</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Empty cells after last day
            const totalCells = firstDay + daysInMonth;
            const remaining = 7 - (totalCells % 7);
            if (remaining < 7) {
                for (let i = 0; i < remaining; i++) {
                    html += `<div class="cal-day empty" style="min-height: 100px; background: var(--bg-hover); border: 1px solid var(--border-color);"></div>`;
                }
            }
            
            grid.innerHTML = html;
        }
        
        function renderWeekView() {
            const grid = document.getElementById('cal-grid');
            const monthYear = document.getElementById('cal-month-year');
            const dayHeaders = document.querySelector('.cal-day-headers');
            
            // Show day headers for week view
            if (dayHeaders) dayHeaders.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
            
            const today = new Date();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Get start of week (Sunday)
            const startOfWeek = new Date(calendarDate);
            startOfWeek.setDate(calendarDate.getDate() - calendarDate.getDay());
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            // Update header
            monthYear.textContent = `${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getDate()} - ${monthNames[endOfWeek.getMonth()]} ${endOfWeek.getDate()}, ${endOfWeek.getFullYear()}`;
            
            let html = '';
            
            // Generate 7 days
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const isToday = today.toDateString() === date.toDateString();
                const dayEvents = calendarEvents.filter(e => e.start?.dateTime?.startsWith(dateStr) || e.start?.date === dateStr);
                
                html += `
                    <div class="cal-day" data-date="${dateStr}" onclick="showDayDetail('${dateStr}')"
                         style="min-height: 300px; padding: 8px; border: 1px solid var(--border-color); cursor: pointer; ${isToday ? 'background: rgba(59, 130, 246, 0.1);' : ''}">
                        <div style="text-align: center; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); margin-bottom: 8px;">
                            <div style="font-size: 12px; color: var(--text-muted);">${dayNames[i]}</div>
                            <div style="font-size: 20px; font-weight: ${isToday ? '700' : '500'}; color: ${isToday ? 'var(--accent-blue)' : 'var(--text-primary)'};">${date.getDate()}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px; font-size: 12px;">
                            ${dayEvents.map(e => {
                                const color = getEventColor(e.colorId);
                                const time = e.start?.dateTime ? new Date(e.start.dateTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : 'All day';
                                return `<div style="background: ${color}; color: white; padding: 4px 6px; border-radius: 4px;" title="${e.summary}">
                                    <div style="font-weight: 600;">${time}</div>
                                    <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${e.summary || 'Appointment'}</div>
                                </div>`;
                            }).join('')}
                            ${dayEvents.length === 0 ? '<div style="color: var(--text-muted); text-align: center; padding: 20px 0;">No events</div>' : ''}
                        </div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }
        
        function renderDayView() {
            const grid = document.getElementById('cal-grid');
            const monthYear = document.getElementById('cal-month-year');
            const dayHeaders = document.querySelector('.cal-day-headers');
            
            // Hide day headers for day view
            if (dayHeaders) dayHeaders.style.display = 'none';
            grid.style.gridTemplateColumns = '1fr';
            
            const today = new Date();
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            const day = calendarDate.getDate();
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = today.toDateString() === calendarDate.toDateString();
            
            // Update header
            monthYear.textContent = `${dayNames[calendarDate.getDay()]}, ${monthNames[month]} ${day}, ${year}`;
            
            const dayEvents = calendarEvents.filter(e => e.start?.dateTime?.startsWith(dateStr) || e.start?.date === dateStr);
            
            // Sort events by time
            dayEvents.sort((a, b) => {
                const timeA = a.start?.dateTime ? new Date(a.start.dateTime).getTime() : 0;
                const timeB = b.start?.dateTime ? new Date(b.start.dateTime).getTime() : 0;
                return timeA - timeB;
            });
            
            let html = `
                <div style="padding: 20px; ${isToday ? 'background: rgba(59, 130, 246, 0.05);' : ''}">
                    ${dayEvents.length === 0 ? `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“…</div>
                            <div style="font-size: 18px;">No appointments scheduled</div>
                            <div style="font-size: 14px; margin-top: 8px;">Enjoy your free day!</div>
                        </div>
                    ` : `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${dayEvents.map(e => {
                                const color = getEventColor(e.colorId);
                                const startTime = e.start?.dateTime ? new Date(e.start.dateTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : 'All day';
                                const endTime = e.end?.dateTime ? new Date(e.end.dateTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
                                return `
                                    <div style="display: flex; gap: 16px; padding: 16px; background: var(--bg-hover); border-radius: 12px; border-left: 5px solid ${color};">
                                        <div style="min-width: 100px;">
                                            <div style="font-size: 18px; font-weight: 600; color: var(--text-primary);">${startTime}</div>
                                            ${endTime ? `<div style="font-size: 14px; color: var(--text-secondary);">to ${endTime}</div>` : ''}
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${e.summary || 'Appointment'}</div>
                                            ${e.description ? `<div style="color: var(--text-secondary); font-size: 14px; margin-top: 8px; white-space: pre-wrap;">${e.description}</div>` : ''}
                                            ${e.location ? `<div style="color: var(--text-muted); font-size: 13px; margin-top: 8px;">ğŸ“ ${e.location}</div>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
            
            grid.innerHTML = html;
        }
        
        function getEventColor(colorId) {
            const colors = {
                '1': '#7986cb', '2': '#33b679', '3': '#8e24aa', '4': '#e67c73',
                '5': '#f6c026', '6': '#f5511d', '7': '#039be5', '8': '#616161',
                '9': '#3f51b5', '10': '#0b8043', '11': '#d60000'
            };
            return colors[colorId] || '#039be5';
        }
        
        function showDayDetail(dateStr) {
            const detail = document.getElementById('cal-day-detail');
            const dateEl = document.getElementById('cal-detail-date');
            const eventsEl = document.getElementById('cal-detail-events');
            
            const date = new Date(dateStr + 'T12:00:00');
            dateEl.textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const dayEvents = calendarEvents.filter(e => e.start?.dateTime?.startsWith(dateStr) || e.start?.date === dateStr);
            
            if (dayEvents.length === 0) {
                eventsEl.innerHTML = `<div style="color: var(--text-muted); padding: 20px; text-align: center;">No appointments scheduled</div>`;
            } else {
                eventsEl.innerHTML = dayEvents.map(e => {
                    const color = getEventColor(e.colorId);
                    const time = e.start?.dateTime ? new Date(e.start.dateTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : 'All day';
                    const endTime = e.end?.dateTime ? new Date(e.end.dateTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
                    return `
                        <div style="display: flex; gap: var(--space-md); padding: var(--space-md); background: var(--bg-hover); border-radius: 8px; border-left: 4px solid ${color};">
                            <div style="min-width: 80px; color: var(--text-secondary); font-size: 13px;">${time}${endTime ? ' - ' + endTime : ''}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${e.summary || 'Appointment'}</div>
                                ${e.description ? `<div style="color: var(--text-secondary); font-size: 13px; margin-top: 4px; white-space: pre-wrap;">${e.description}</div>` : ''}
                                ${e.location ? `<div style="color: var(--text-muted); font-size: 12px; margin-top: 4px;"><i class="fas fa-map-marker-alt mr-1"></i>${e.location}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            detail.style.display = 'block';
        }
        
        function wireCalendarControls() {
            // Only wire once
            if (document.getElementById('cal-prev').dataset.wired) return;
            document.getElementById('cal-prev').dataset.wired = 'true';
            
            document.getElementById('cal-prev').addEventListener('click', async () => {
                if (calendarView === 'month') {
                    calendarDate.setMonth(calendarDate.getMonth() - 1);
                } else if (calendarView === 'week') {
                    calendarDate.setDate(calendarDate.getDate() - 7);
                } else if (calendarView === 'day') {
                    calendarDate.setDate(calendarDate.getDate() - 1);
                }
                updateCalendarStatus('loading', 'Loading...');
                await loadCalendarEvents();
                renderCalendar();
                updateCalendarStatus('live');
                updateLastSyncTime();
                updateEventCount(calendarEvents.length);
            });
            
            document.getElementById('cal-next').addEventListener('click', async () => {
                if (calendarView === 'month') {
                    calendarDate.setMonth(calendarDate.getMonth() + 1);
                } else if (calendarView === 'week') {
                    calendarDate.setDate(calendarDate.getDate() + 7);
                } else if (calendarView === 'day') {
                    calendarDate.setDate(calendarDate.getDate() + 1);
                }
                updateCalendarStatus('loading', 'Loading...');
                await loadCalendarEvents();
                renderCalendar();
                updateCalendarStatus('live');
                updateLastSyncTime();
                updateEventCount(calendarEvents.length);
            });
            
            document.getElementById('cal-today').addEventListener('click', async () => {
                calendarDate = new Date();
                updateCalendarStatus('loading', 'Loading...');
                await loadCalendarEvents();
                renderCalendar();
                updateCalendarStatus('live');
                updateLastSyncTime();
                updateEventCount(calendarEvents.length);
            });
            
            // Refresh button
            document.getElementById('cal-refresh').addEventListener('click', async () => {
                const btn = document.getElementById('cal-refresh');
                btn.disabled = true;
                btn.style.opacity = '0.6';
                updateCalendarStatus('loading', 'Refreshing...');
                
                try {
                    await loadCalendarEvents();
                    renderCalendar();
                    updateCalendarStatus('live');
                    updateLastSyncTime();
                    updateEventCount(calendarEvents.length);
                } catch (err) {
                    updateCalendarStatus('offline');
                }
                
                btn.disabled = false;
                btn.style.opacity = '1';
            });
            
            // View switcher - re-renders calendar in new view
            document.querySelectorAll('.cal-view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.cal-view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    calendarView = btn.dataset.view;
                    renderCalendar(); // Re-render with new view
                });
            });
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ANALYTICS FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function loadAnalytics() {
            try {
                // Load tier usage
                const tierRes = await apiCall(`/api/admin/call-center/${currentCompanyId}/analytics/tiers?days=30`);
                const tiers = tierRes.data;
                
                document.getElementById('tier1-bar').style.height = `${tiers.tier1.percentage}%`;
                document.getElementById('tier2-bar').style.height = `${tiers.tier2.percentage}%`;
                document.getElementById('tier3-bar').style.height = `${tiers.tier3.percentage}%`;
                document.getElementById('tier1-percent').textContent = `${tiers.tier1.percentage}%`;
                document.getElementById('tier2-percent').textContent = `${tiers.tier2.percentage}%`;
                document.getElementById('tier3-percent').textContent = `${tiers.tier3.percentage}%`;
                document.getElementById('llm-cost').textContent = `$${tiers.estimatedMonthlyCost?.toFixed(2) || '0.00'}`;
                
                // Load top intents
                const intentsRes = await apiCall(`/api/admin/call-center/${currentCompanyId}/analytics/intents?days=30&limit=5`);
                const intents = intentsRes.data || [];
                
                if (intents.length === 0) {
                    document.getElementById('top-intents').innerHTML = '<div style="color: var(--text-muted); padding: 20px;">No intent data yet</div>';
                } else {
                    const maxCount = Math.max(...intents.map(i => i.count));
                    document.getElementById('top-intents').innerHTML = intents.map(intent => `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <div style="width: 100px; font-size: 13px; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${intent.intent}</div>
                            <div style="flex: 1; height: 8px; background: var(--bg-hover); border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${(intent.count / maxCount) * 100}%; background: var(--accent-cyan); border-radius: 4px;"></div>
                            </div>
                            <div style="width: 50px; text-align: right; font-size: 13px; font-weight: 600;">${intent.count}</div>
                        </div>
                    `).join('');
                }
                
                // Load peak hours
                const peakRes = await apiCall(`/api/admin/call-center/${currentCompanyId}/analytics/peak-hours?days=30`);
                const peak = peakRes.data;
                
                if (peak.hourly) {
                    const maxHourly = Math.max(...peak.hourly.map(h => h.count)) || 1;
                    document.getElementById('peak-hours-chart').innerHTML = peak.hourly.map((h, i) => `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="width: 100%; max-width: 20px; background: ${i === peak.peakHour ? 'var(--accent-cyan)' : 'var(--bg-hover)'}; border-radius: 2px 2px 0 0; height: ${(h.count / maxHourly) * 80}px; min-height: 2px;"></div>
                        </div>
                    `).join('');
                }
                
                // Load compliance status
                const complianceRes = await apiCall(`/api/admin/call-center/${currentCompanyId}/compliance/retention`);
                const compliance = complianceRes.data;
                
                document.getElementById('retention-status').textContent = compliance.status === 'COMPLIANT' ? 'âœ… Compliant' : 'âš ï¸ Needs Attention';
                document.getElementById('retention-status').style.color = compliance.status === 'COMPLIANT' ? 'var(--accent-green)' : 'var(--accent-yellow)';
                document.getElementById('pending-purge').textContent = `${compliance.pendingPurge?.calls || 0} calls, ${compliance.pendingPurge?.transcripts || 0} transcripts`;
                
                // Load duplicate count
                const dupRes = await apiCall(`/api/admin/call-center/${currentCompanyId}/compliance/duplicates`);
                const dups = dupRes.data;
                const totalDups = (dups.byPhone?.length || 0) + (dups.byEmail?.length || 0);
                document.getElementById('duplicate-count').textContent = totalDups === 0 ? 'âœ… None' : `âš ï¸ ${totalDups} found`;
                document.getElementById('duplicate-count').style.color = totalDups === 0 ? 'var(--accent-green)' : 'var(--accent-yellow)';
                
            } catch (err) {
                console.error('Failed to load analytics:', err);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GLOBAL SEARCH FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function performGlobalSearch() {
            const query = document.getElementById('global-search').value;
            const type = document.getElementById('search-type-filter').value;
            const startDate = document.getElementById('search-start-date').value;
            const endDate = document.getElementById('search-end-date').value;
            
            if (!query && !startDate && !endDate) {
                document.getElementById('search-results-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”</div>
                        <h3>Search All Records</h3>
                        <p>Enter a search term or select dates to find calls and customers</p>
                    </div>
                `;
                return;
            }
            
            document.getElementById('search-results-container').innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 16px;">Searching...</p>
                </div>
            `;
            
            try {
                const results = [];
                
                // Search calls
                if (type === 'all' || type === 'calls') {
                    const params = new URLSearchParams({ limit: 25 });
                    if (query) params.set('query', query);
                    if (startDate) params.set('startDate', startDate);
                    if (endDate) params.set('endDate', endDate);
                    
                    const callsRes = await apiCall(`/api/admin/call-center/${currentCompanyId}/calls?${params}`);
                    (callsRes.data || []).forEach(call => results.push({ type: 'call', data: call }));
                }
                
                // Search customers
                if (type === 'all' || type === 'customers') {
                    const params = new URLSearchParams({ limit: 25 });
                    if (query) params.set('query', query);
                    
                    const customersRes = await apiCall(`/api/admin/call-center/${currentCompanyId}/customers?${params}`);
                    (customersRes.data || []).forEach(c => results.push({ type: 'customer', data: c }));
                }
                
                if (results.length === 0) {
                    document.getElementById('search-results-container').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ”</div>
                            <h3>No Results Found</h3>
                            <p>Try a different search term or date range</p>
                        </div>
                    `;
                    return;
                }
                
                document.getElementById('search-results-container').innerHTML = results.map(r => {
                    if (r.type === 'call') return renderCallCard(r.data);
                    return renderCustomerCard(r.data);
                }).join('');
                
            } catch (err) {
                console.error('Search failed:', err);
                document.getElementById('search-results-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <h3>Search Failed</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VENDOR FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let currentVendorSubtab = 'calls';
        
        function switchVendorTab(tab) {
            currentVendorSubtab = tab;
            
            // Update subtab buttons
            document.querySelectorAll('.vendor-subtab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.vendorTab === tab);
            });
            
            // Update subpanels
            document.getElementById('vendor-calls-subpanel').classList.toggle('active', tab === 'calls');
            document.getElementById('vendor-directory-subpanel').classList.toggle('active', tab === 'directory');
            document.getElementById('vendor-pending-subpanel').classList.toggle('active', tab === 'pending');
            
            // Load data
            if (tab === 'calls') loadVendorCalls();
            else if (tab === 'directory') loadVendorDirectory();
            else if (tab === 'pending') loadPendingActions();
        }
        
        async function loadVendorStats() {
            try {
                const res = await apiCall(`/api/admin/call-center/${currentCompanyId}/vendor-stats`);
                const stats = res.data;
                
                document.getElementById('total-vendors-stat').textContent = stats.totalVendors;
                document.getElementById('pending-vendor-actions-stat').textContent = stats.pendingActions;
                document.getElementById('vendor-calls-today-stat').textContent = stats.callsToday;
                
            } catch (err) {
                console.error('Failed to load vendor stats:', err);
            }
        }
        
        async function loadVendorCalls() {
            const container = document.getElementById('vendor-calls-container');
            container.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 16px;">Loading vendor calls...</p>
                </div>
            `;
            
            try {
                const res = await apiCall(`/api/admin/call-center/${currentCompanyId}/vendor-calls`);
                const calls = res.data;
                
                if (calls.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“¦</div>
                            <h3>No Vendor Calls Yet</h3>
                            <p>When vendors call about orders, parts, or deliveries, they'll appear here.</p>
                            <button class="btn btn-primary" onclick="showNewVendorCallModal()">+ Log First Vendor Call</button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = calls.map(call => renderVendorCallCard(call)).join('');
                
            } catch (err) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <h3>Error Loading Vendor Calls</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }
        
        async function loadVendorDirectory() {
            const container = document.getElementById('vendors-container');
            container.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 16px;">Loading vendors...</p>
                </div>
            `;
            
            try {
                const res = await apiCall(`/api/admin/call-center/${currentCompanyId}/vendors`);
                const vendors = res.data;
                
                if (vendors.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‡</div>
                            <h3>No Vendors Yet</h3>
                            <p>Add your suppliers, parts distributors, and delivery contacts.</p>
                            <button class="btn btn-primary" onclick="showNewVendorModal()">+ Add First Vendor</button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = vendors.map(vendor => renderVendorCard(vendor)).join('');
                
            } catch (err) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <h3>Error Loading Vendors</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }
        
        async function loadPendingActions() {
            const container = document.getElementById('pending-actions-container');
            container.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 16px;">Loading pending actions...</p>
                </div>
            `;
            
            try {
                const res = await apiCall(`/api/admin/call-center/${currentCompanyId}/vendor-calls/pending`);
                const pendingCalls = res.data;
                
                if (pendingCalls.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âœ…</div>
                            <h3>All Caught Up!</h3>
                            <p>No pending vendor actions. All parts picked up, orders confirmed.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = pendingCalls.map(call => renderVendorCallCard(call, true)).join('');
                
            } catch (err) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <h3>Error Loading Pending Actions</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }
        
        function renderVendorCallCard(call, showCompleteBtn = false) {
            const reasonLabels = {
                order_ready: 'ğŸ“¦ Order Ready',
                order_shipped: 'ğŸšš Shipped',
                order_backordered: 'â³ Backordered',
                order_delivered: 'âœ… Delivered',
                delivery_attempt: 'ğŸšª Delivery Attempt',
                delivery_schedule: 'ğŸ“… Delivery Schedule',
                account_invoice: 'ğŸ“„ Invoice',
                general_inquiry: 'ğŸ’¬ Inquiry',
                other: 'ğŸ“ Other'
            };
            
            const urgencyClass = call.urgency === 'urgent' ? 'urgent' : 
                                 call.urgency === 'high' ? 'high' : 
                                 call.actionStatus === 'pending' ? 'pending' : '';
            
            return `
                <div class="vendor-call-card ${urgencyClass}">
                    <div class="vendor-call-header">
                        <div>
                            <span class="vendor-call-vendor">ğŸª ${call.vendorName || 'Unknown Vendor'}</span>
                            ${call.callerName ? `<span style="color: var(--text-muted); font-size: 12px;"> â€¢ ${call.callerName}</span>` : ''}
                        </div>
                        <span class="vendor-call-time">${formatRelativeTime(call.calledAt)}</span>
                    </div>
                    
                    <div class="vendor-call-summary">${call.summary}</div>
                    
                    <div class="vendor-call-meta">
                        <span class="vendor-call-tag">${reasonLabels[call.reason] || call.reason}</span>
                        ${call.orderNumber ? `<span class="vendor-call-tag order">ğŸ“‹ ${call.orderNumber}</span>` : ''}
                        ${call.relatedCustomerName ? `<span class="vendor-call-tag customer">ğŸ‘¤ ${call.relatedCustomerName}</span>` : ''}
                        ${call.actionRequired ? `<span class="vendor-call-tag action">âš¡ ${call.actionRequired}</span>` : ''}
                        ${call.trackingNumber ? `<span class="vendor-call-tag">ğŸ“¦ ${call.trackingNumber}</span>` : ''}
                        
                        ${showCompleteBtn && call.actionStatus !== 'completed' ? `
                            <button class="action-btn primary" onclick="completeVendorAction('${call.callId}')" style="margin-left: auto;">
                                âœ… Mark Complete
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function renderVendorCard(vendor) {
            const typeLabels = {
                supply_house: 'ğŸ­ Supply House',
                parts_distributor: 'âš™ï¸ Parts Distributor',
                equipment_manufacturer: 'ğŸ”§ Manufacturer',
                delivery_service: 'ğŸšš Delivery',
                wholesaler: 'ğŸ“¦ Wholesaler',
                other: 'ğŸ¢ Vendor'
            };
            
            return `
                <div class="vendor-card" onclick="viewVendor('${vendor._id}')">
                    <div class="vendor-card-header">
                        <div class="vendor-info">
                            <h3>${vendor.businessName}</h3>
                            <p>${vendor.phone ? formatPhone(vendor.phone) : 'No phone'} ${vendor.email ? `â€¢ ${vendor.email}` : ''}</p>
                        </div>
                        <span class="vendor-type-badge ${vendor.vendorType}">${typeLabels[vendor.vendorType] || vendor.vendorType}</span>
                    </div>
                    
                    <div style="display: flex; gap: var(--space-lg); font-size: 13px; color: var(--text-secondary);">
                        ${vendor.accountNumber ? `<span>ğŸ“‹ Acct: ${vendor.accountNumber}</span>` : ''}
                        <span>ğŸ“ ${vendor.totalCalls || 0} calls</span>
                        ${vendor.lastCallAt ? `<span>ğŸ• Last: ${formatRelativeTime(vendor.lastCallAt)}</span>` : ''}
                    </div>
                    
                    ${vendor.contacts?.length > 0 ? `
                        <div style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--border-light); font-size: 12px; color: var(--text-muted);">
                            ğŸ‘¤ Contacts: ${vendor.contacts.map(c => c.name).join(', ')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function showNewVendorCallModal() {
            const vendorName = prompt('Vendor name (e.g., "Johnstone Supply"):');
            if (!vendorName) return;
            
            const summary = prompt('What did they call about?');
            if (!summary) return;
            
            const reason = prompt('Reason: order_ready, order_shipped, order_backordered, delivery_attempt, account_invoice, other') || 'other';
            
            const orderNumber = prompt('Order/PO number (optional):');
            const customerName = prompt('Related customer name (optional, e.g., "Mrs. Johnson"):');
            const actionRequired = prompt('Action required (optional, e.g., "Pick up motor by 5pm"):');
            
            logVendorCall({
                vendorName,
                summary,
                reason,
                orderNumber,
                relatedCustomerName: customerName,
                actionRequired,
                urgency: actionRequired ? 'high' : 'normal'
            });
        }
        
        async function logVendorCall(callData) {
            try {
                await apiCall(`/api/admin/call-center/${currentCompanyId}/vendor-calls`, {
                    method: 'POST',
                    body: JSON.stringify(callData)
                });
                
                alert('Vendor call logged!');
                loadVendorCalls();
                loadVendorStats();
                
            } catch (err) {
                alert('Failed to log vendor call: ' + err.message);
            }
        }
        
        function showNewVendorModal() {
            const businessName = prompt('Vendor/Company name:');
            if (!businessName) return;
            
            const phone = prompt('Phone number:');
            const vendorType = prompt('Type: supply_house, parts_distributor, equipment_manufacturer, delivery_service, wholesaler, other') || 'other';
            const accountNumber = prompt('Your account number with them (optional):');
            
            createVendor({
                businessName,
                phone,
                vendorType,
                accountNumber
            });
        }
        
        async function createVendor(vendorData) {
            try {
                await apiCall(`/api/admin/call-center/${currentCompanyId}/vendors`, {
                    method: 'POST',
                    body: JSON.stringify(vendorData)
                });
                
                alert('Vendor added!');
                loadVendorDirectory();
                loadVendorStats();
                
            } catch (err) {
                alert('Failed to add vendor: ' + err.message);
            }
        }
        
        async function completeVendorAction(callId) {
            const notes = prompt('Completion notes (optional):');
            
            try {
                await apiCall(`/api/admin/call-center/${currentCompanyId}/vendor-calls/${callId}/complete`, {
                    method: 'POST',
                    body: JSON.stringify({ notes })
                });
                
                alert('Action marked as complete!');
                loadPendingActions();
                loadVendorStats();
                
            } catch (err) {
                alert('Failed to complete action: ' + err.message);
            }
        }
        
        function viewVendor(vendorId) {
            // TODO: Full vendor detail modal
            alert(`View vendor: ${vendorId} - Full detail modal coming soon!`);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CUSTOMER DETAIL MODAL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let currentCustomer = null;
        let currentModalTab = 'overview';
        
        async function viewCustomer(customerId) {
            const modal = document.getElementById('customer-modal');
            modal.classList.add('open');
            
            try {
                // Load full customer data
                const res = await apiCall(`/api/admin/call-center/${currentCompanyId}/customers/${customerId}`);
                currentCustomer = res.data;
                
                populateCustomerModal(currentCustomer);
                
            } catch (err) {
                console.error('Failed to load customer:', err);
                alert('Failed to load customer: ' + err.message);
                closeModal();
            }
        }
        
        function populateCustomerModal(customer) {
            // Header
            document.getElementById('modal-avatar').textContent = getInitials(customer.fullName || customer.phone);
            document.getElementById('modal-avatar').className = `customer-avatar ${customer.status === 'customer' ? 'returning' : ''}`;
            document.getElementById('modal-customer-name').textContent = customer.fullName || 'Unknown Customer';
            
            // Account Type Badge
            const accountType = customer.accountType || 'residential';
            const accountBadge = document.getElementById('modal-account-type');
            if (accountType === 'commercial') {
                accountBadge.className = 'account-badge commercial';
                accountBadge.textContent = 'ğŸ¢ Commercial';
                document.getElementById('commercial-tab').style.display = 'block';
                document.getElementById('convert-commercial-btn').style.display = 'none';
            } else {
                accountBadge.className = 'account-badge residential';
                accountBadge.textContent = 'ğŸ  Residential';
                document.getElementById('commercial-tab').style.display = 'none';
                document.getElementById('convert-commercial-btn').style.display = 'inline-flex';
            }
            
            // Phone Type Badge
            const phoneType = customer.phoneType || 'unknown';
            const phoneBadge = document.getElementById('modal-phone-type');
            const phoneIcons = { mobile: 'ğŸ“±', landline: 'â˜ï¸', voip: 'ğŸŒ', unknown: 'â“' };
            phoneBadge.className = `phone-badge ${phoneType}`;
            phoneBadge.textContent = `${phoneIcons[phoneType] || 'â“'} ${phoneType.charAt(0).toUpperCase() + phoneType.slice(1)}`;
            if (customer.canSms) {
                phoneBadge.textContent += ' (SMS âœ“)';
            }
            
            // Contact Info
            document.getElementById('modal-phone').textContent = formatPhone(customer.phone);
            document.getElementById('modal-email').textContent = customer.email || 'â€”';
            document.getElementById('modal-status').textContent = customer.status || 'â€”';
            document.getElementById('modal-customer-id').textContent = customer.customerId || 'â€”';
            
            // Statistics
            document.getElementById('modal-total-calls').textContent = customer.totalCalls || 0;
            document.getElementById('modal-appointments').textContent = 
                `${customer.completedAppointments || 0} completed, ${customer.totalAppointments || 0} total`;
            document.getElementById('modal-first-contact').textContent = 
                customer.firstContactAt ? new Date(customer.firstContactAt).toLocaleDateString() : 'â€”';
            document.getElementById('modal-last-contact').textContent = 
                customer.lastContactAt ? formatRelativeTime(customer.lastContactAt) : 'â€”';
            document.getElementById('modal-ltv').textContent = 
                customer.lifetimeValue ? `$${customer.lifetimeValue.toLocaleString()}` : '$0';
            
            // Property count
            const propertyCount = 1 + (customer.serviceAddresses?.length || 0);
            document.getElementById('modal-property-count').textContent = propertyCount;
            document.getElementById('property-count-label').textContent = propertyCount;
            
            // Notes
            document.getElementById('modal-notes').textContent = customer.specialNotes || 'No special notes';
            document.getElementById('modal-notes').className = customer.specialNotes ? 'detail-value' : 'detail-value empty';
            
            // Related Accounts
            if (customer.relatedAccounts?.length > 0) {
                document.getElementById('related-accounts-section').style.display = 'block';
                document.getElementById('modal-related-accounts').innerHTML = customer.relatedAccounts.map(acc => `
                    <div class="related-account" onclick="viewRelatedAccount('${acc.accountId}')">
                        <span>${acc.accountType === 'commercial' ? 'ğŸ¢' : 'ğŸ '}</span>
                        <div>
                            <strong>${acc.businessName || acc.accountId}</strong>
                            <div style="font-size: 12px; color: var(--text-muted);">${acc.relationship || ''} ${acc.note ? 'â€¢ ' + acc.note : ''}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('related-accounts-section').style.display = 'none';
            }
            
            // Properties
            populatePropertiesList(customer);
            
            // Household Members
            populateHouseholdList(customer);
            
            // Commercial Info
            if (accountType === 'commercial' && customer.commercial) {
                populateCommercialInfo(customer.commercial);
            }
        }
        
        function populatePropertiesList(customer) {
            const container = document.getElementById('properties-list');
            const properties = [];
            
            // Primary address
            if (customer.primaryAddress?.street) {
                properties.push({
                    id: 'PRIMARY',
                    nickname: 'Home',
                    isPrimary: true,
                    ...customer.primaryAddress
                });
            }
            
            // Service addresses
            if (customer.serviceAddresses) {
                properties.push(...customer.serviceAddresses);
            }
            
            if (properties.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><p>No properties on file</p></div>';
                return;
            }
            
            container.innerHTML = properties.map(prop => `
                <div class="property-card ${prop.isPrimary ? 'primary' : ''}">
                    <div class="property-header">
                        <span class="property-name">
                            ${prop.isPrimary ? 'ğŸ ' : 'ğŸ“'} ${prop.nickname || 'Property'}
                            ${prop.isPrimary ? '<span style="font-size: 11px; color: var(--accent-green); margin-left: 8px;">PRIMARY</span>' : ''}
                        </span>
                        <button class="action-btn" onclick="editProperty('${prop.id || prop.addressId}')">âœï¸</button>
                    </div>
                    <div class="property-address">
                        ${prop.street || ''}${prop.unit ? ', ' + prop.unit : ''}<br>
                        ${prop.city || ''}${prop.state ? ', ' + prop.state : ''} ${prop.zip || ''}
                    </div>
                    ${(prop.gateCode || prop.lockboxCode || prop.accessNotes) ? `
                        <div class="property-access">
                            ${prop.gateCode ? `ğŸ”¢ Gate: <strong>${prop.gateCode}</strong> ` : ''}
                            ${prop.lockboxCode ? `ğŸ” Lockbox: <strong>${prop.lockboxCode}</strong> ` : ''}
                            ${prop.accessNotes ? `<br>ğŸ“ ${prop.accessNotes}` : ''}
                        </div>
                    ` : ''}
                    ${prop.siteContact?.name ? `
                        <div class="property-access">
                            ğŸ‘¤ Site Contact: <strong>${prop.siteContact.name}</strong> 
                            ${prop.siteContact.phone ? `(${formatPhone(prop.siteContact.phone)})` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function populateHouseholdList(customer) {
            const container = document.getElementById('household-list');
            const members = customer.householdMembers || [];
            
            document.getElementById('household-count-label').textContent = members.length;
            
            if (members.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><p>No household members on file</p></div>';
                return;
            }
            
            container.innerHTML = members.map((member, idx) => `
                <div class="member-card">
                    <div class="member-avatar">${getInitials(member.name)}</div>
                    <div class="member-info">
                        <div class="member-name">
                            ${member.name}
                            ${member.isPrimary ? '<span style="font-size: 11px; color: var(--accent-green); margin-left: 8px;">PRIMARY</span>' : ''}
                        </div>
                        <div class="member-details">
                            ${member.relationship || 'Household member'}
                            ${member.phone ? ` â€¢ ${formatPhone(member.phone)}` : ''}
                            ${member.phoneType ? ` â€¢ ${member.phoneType === 'mobile' ? 'ğŸ“±' : 'â˜ï¸'}` : ''}
                            ${member.canAuthorize ? ' â€¢ âœ… Can authorize' : ''}
                        </div>
                    </div>
                    <button class="action-btn" onclick="editHouseholdMember(${idx})">âœï¸</button>
                </div>
            `).join('');
        }
        
        function populateCommercialInfo(commercial) {
            document.getElementById('modal-business-name').textContent = commercial.businessName || 'â€”';
            document.getElementById('modal-location-name').textContent = commercial.locationName || 'â€”';
            document.getElementById('modal-industry').textContent = commercial.industryType || 'â€”';
            document.getElementById('modal-payment-terms').textContent = 
                (commercial.paymentTerms || 'due_on_receipt').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            document.getElementById('modal-service-entrance').textContent = commercial.serviceEntrance || 'â€”';
            document.getElementById('modal-unit-location').textContent = commercial.unitLocation || 'â€”';
            
            const site = commercial.siteContact || {};
            document.getElementById('modal-site-contact-name').textContent = site.name || 'â€”';
            document.getElementById('modal-site-contact-title').textContent = site.title || 'â€”';
            document.getElementById('modal-site-contact-phone').textContent = site.phone ? formatPhone(site.phone) : 'â€”';
            document.getElementById('modal-text-phone').textContent = 
                commercial.textNotificationPhone ? formatPhone(commercial.textNotificationPhone) : 'â€”';
            
            const billing = commercial.billingAddress || {};
            const billingAddr = [billing.street, billing.city, billing.state, billing.zip].filter(Boolean).join(', ');
            document.getElementById('modal-billing-address').textContent = billingAddr || 'â€”';
            
            const billingContact = commercial.billingContact || {};
            document.getElementById('modal-billing-contact').textContent = 
                billingContact.name ? `${billingContact.name}${billingContact.title ? ' (' + billingContact.title + ')' : ''}` : 'â€”';
            
            document.getElementById('modal-requires-po').textContent = commercial.requiresPO ? 'Yes' : 'No';
            
            // Authorized callers
            const callersContainer = document.getElementById('authorized-callers-list');
            const callers = commercial.authorizedCallers || [];
            
            if (callers.length === 0) {
                callersContainer.innerHTML = '<div class="empty-state" style="padding: 10px;"><p style="font-size: 13px;">No authorized callers configured</p></div>';
            } else {
                callersContainer.innerHTML = callers.map((caller, idx) => `
                    <div class="member-card">
                        <div class="member-avatar">${getInitials(caller.name)}</div>
                        <div class="member-info">
                            <div class="member-name">${caller.name}</div>
                            <div class="member-details">
                                ${caller.title || 'Authorized Caller'}
                                ${caller.phone ? ` â€¢ ${formatPhone(caller.phone)}` : ''}
                                ${caller.canAuthorizeWork ? ' â€¢ âœ… Can authorize work' : ''}
                                ${caller.canViewBilling ? ' â€¢ ğŸ’³ Can view billing' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function closeModal() {
            document.getElementById('customer-modal').classList.remove('open');
            currentCustomer = null;
            switchModalTab('overview');
        }
        
        function switchModalTab(tab) {
            currentModalTab = tab;
            
            // Update tabs
            document.querySelectorAll('.modal-tab').forEach(el => {
                el.classList.toggle('active', el.dataset.modalTab === tab);
            });
            
            // Update panels
            document.querySelectorAll('.modal-tab-panel').forEach(el => {
                el.style.display = el.id === `modal-panel-${tab}` ? 'block' : 'none';
            });
            
            // Load intelligence data when that tab is selected
            if (tab === 'intelligence' && currentCustomer) {
                loadCustomerIntelligence(currentCustomer._id);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AI INTELLIGENCE TAB FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let customerIntelligenceCache = {};
        
        async function loadCustomerIntelligence(customerId) {
            // Check cache first
            if (customerIntelligenceCache[customerId]) {
                renderIntelligence(customerIntelligenceCache[customerId]);
                return;
            }
            
            // Show loading
            document.getElementById('intelligence-loading').style.display = 'block';
            document.getElementById('intelligence-content').style.display = 'none';
            
            try {
                const res = await apiCall(`/api/admin/call-center/${currentCompanyId}/customers/${customerId}/intelligence`);
                const intel = res.data;
                
                // Cache it
                customerIntelligenceCache[customerId] = intel;
                
                renderIntelligence(intel);
                
            } catch (err) {
                console.error('Failed to load intelligence:', err);
                document.getElementById('intelligence-loading').innerHTML = `
                    <div style="color: var(--accent-red);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px;"></i>
                        <p style="margin-top: 12px;">Failed to load AI intelligence</p>
                        <p style="font-size: 12px; color: var(--text-muted);">${err.message}</p>
                    </div>
                `;
            }
        }
        
        function renderIntelligence(intel) {
            document.getElementById('intelligence-loading').style.display = 'none';
            document.getElementById('intelligence-content').style.display = 'block';
            
            // === Data Completeness Score ===
            const score = intel.meta?.dataCompleteness || { percentage: 0, level: 'minimal' };
            document.getElementById('intel-score-value').textContent = `${score.percentage}%`;
            document.getElementById('intel-score-circle').style.background = 
                `conic-gradient(var(--accent-cyan) ${score.percentage}%, var(--bg-card) ${score.percentage}%)`;
            document.getElementById('intel-score-level').textContent = 
                score.level.charAt(0).toUpperCase() + score.level.slice(1);
            
            // Color based on level
            const levelColors = { excellent: 'var(--accent-green)', good: 'var(--accent-cyan)', partial: 'var(--accent-yellow)', minimal: 'var(--text-muted)' };
            document.getElementById('intel-score-level').style.color = levelColors[score.level] || 'var(--text-muted)';
            
            // === AI Notes ===
            const notes = intel.aiNotes || [];
            document.getElementById('intel-notes-count').textContent = `${notes.length} notes`;
            if (notes.length > 0) {
                document.getElementById('intel-notes-list').innerHTML = notes.map(note => `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--accent-purple);">
                        <div style="color: var(--text-primary);">${escapeHtml(note.note)}</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                            ${note.source === 'ai_extracted' ? 'ğŸ¤– AI Extracted' : note.source === 'manual' ? 'âœï¸ Manual' : 'âš™ï¸ System'}
                            â€¢ ${note.createdAt ? formatRelativeTime(note.createdAt) : 'Unknown date'}
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('intel-notes-list').innerHTML = `
                    <div style="color: var(--text-muted); font-style: italic; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                        No AI notes yet. The AI learns about customers during conversations.
                    </div>
                `;
            }
            
            // === Equipment ===
            const equipment = intel.equipment || [];
            document.getElementById('intel-equipment-count').textContent = `${equipment.length} items`;
            if (equipment.length > 0) {
                document.getElementById('intel-equipment-list').innerHTML = equipment.map(eq => `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 600; color: var(--text-primary);">
                                âš™ï¸ ${escapeHtml(eq.type || 'Equipment')}
                                ${eq.brand ? ` - ${escapeHtml(eq.brand)}` : ''}
                                ${eq.model ? ` ${escapeHtml(eq.model)}` : ''}
                            </div>
                            ${eq.warrantyStatus ? `
                                <span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; ${eq.warrantyStatus === 'active' ? 'background: rgba(52,211,153,0.2); color: var(--accent-green);' : 'background: rgba(248,113,113,0.2); color: var(--accent-red);'}">
                                    ${eq.warrantyStatus === 'active' ? 'âœ“ Warranty Active' : 'âš  Warranty Expired'}
                                </span>
                            ` : ''}
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                            ${eq.serialNumber ? `S/N: ${escapeHtml(eq.serialNumber)} â€¢ ` : ''}
                            ${eq.installDate ? `Installed: ${new Date(eq.installDate).toLocaleDateString()} â€¢ ` : ''}
                            ${eq.lastServiceDate ? `Last Service: ${new Date(eq.lastServiceDate).toLocaleDateString()}` : ''}
                        </div>
                        ${eq.notes ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${escapeHtml(eq.notes)}</div>` : ''}
                    </div>
                `).join('');
            } else {
                document.getElementById('intel-equipment-list').innerHTML = `
                    <div style="color: var(--text-muted); font-style: italic; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                        No equipment recorded. Equipment info is gathered during service calls.
                    </div>
                `;
            }
            
            // === Preferences ===
            const prefs = intel.preferences || {};
            document.getElementById('intel-pref-tech').textContent = prefs.preferredTechnicianName || 'â€”';
            document.getElementById('intel-pref-time').textContent = prefs.preferredTimeWindow || 'â€”';
            document.getElementById('intel-pref-contact').textContent = prefs.preferredContactMethod ? 
                prefs.preferredContactMethod.charAt(0).toUpperCase() + prefs.preferredContactMethod.slice(1) : 'â€”';
            document.getElementById('intel-pref-style').textContent = prefs.communicationStyle || 'â€”';
            
            if (prefs.specialInstructions) {
                const instrEl = document.getElementById('intel-special-instructions');
                instrEl.style.display = 'block';
                instrEl.querySelector('div').textContent = prefs.specialInstructions;
            } else {
                document.getElementById('intel-special-instructions').style.display = 'none';
            }
            
            // === Service Visits ===
            const visits = intel.visits || [];
            document.getElementById('intel-visits-count').textContent = `${visits.length} visits`;
            if (visits.length > 0) {
                document.getElementById('intel-visits-list').innerHTML = visits.map(visit => `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--accent-green);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 600; color: var(--text-primary);">
                                ğŸ”§ ${visit.date ? new Date(visit.date).toLocaleDateString() : 'Unknown date'}
                                ${visit.technicianName ? ` â€¢ Tech: ${escapeHtml(visit.technicianName)}` : ''}
                            </div>
                            ${visit.customerRating ? `
                                <span style="color: var(--accent-yellow);">${'â­'.repeat(visit.customerRating)}</span>
                            ` : ''}
                        </div>
                        ${visit.issueDescription ? `<div style="color: var(--text-secondary); margin-top: 4px;"><strong>Issue:</strong> ${escapeHtml(visit.issueDescription)}</div>` : ''}
                        ${visit.resolution ? `<div style="color: var(--text-secondary); margin-top: 2px;"><strong>Resolution:</strong> ${escapeHtml(visit.resolution)}</div>` : ''}
                        ${visit.notes ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(visit.notes)}</div>` : ''}
                        ${visit.wasCallback ? `<span style="font-size: 11px; background: rgba(251,191,36,0.2); color: var(--accent-yellow); padding: 2px 6px; border-radius: 4px;">ğŸ”„ Callback</span>` : ''}
                        ${visit.invoiceAmount ? `<div style="font-size: 12px; color: var(--accent-green); margin-top: 4px;">ğŸ’° $${visit.invoiceAmount.toLocaleString()}</div>` : ''}
                    </div>
                `).join('');
            } else {
                document.getElementById('intel-visits-list').innerHTML = `
                    <div style="color: var(--text-muted); font-style: italic; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                        No service visits recorded.
                    </div>
                `;
            }
            
            // === Call History ===
            const calls = intel.callHistory || [];
            document.getElementById('intel-calls-count').textContent = `${calls.length} calls`;
            if (calls.length > 0) {
                document.getElementById('intel-calls-list').innerHTML = calls.map(call => `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="${call.blackBoxId ? `window.open('/black-box-detail.html?recordingId=${call.blackBoxId}', '_blank')` : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 500; color: var(--text-primary);">
                                ğŸ“ ${call.date ? new Date(call.date).toLocaleString() : 'Unknown'}
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: ${call.outcome === 'completed' ? 'rgba(52,211,153,0.2)' : call.outcome === 'abandoned' ? 'rgba(248,113,113,0.2)' : 'rgba(148,163,184,0.2)'}; color: ${call.outcome === 'completed' ? 'var(--accent-green)' : call.outcome === 'abandoned' ? 'var(--accent-red)' : 'var(--text-muted)'};">
                                    ${call.outcome || 'unknown'}
                                </span>
                                <span style="font-size: 11px; color: var(--text-muted);">
                                    ${call.tier ? `Tier ${call.tier.replace('tier', '')}` : ''}
                                </span>
                            </div>
                        </div>
                        ${call.primaryIntent ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Intent: ${escapeHtml(call.primaryIntent)}</div>` : ''}
                        ${call.summary ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(call.summary.substring(0, 100))}${call.summary.length > 100 ? '...' : ''}</div>` : ''}
                        ${call.duration ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Duration: ${Math.floor(call.duration / 60)}:${String(call.duration % 60).padStart(2, '0')}</div>` : ''}
                        ${call.blackBoxId ? `<div style="font-size: 11px; color: var(--accent-cyan); margin-top: 4px;">ğŸ” Click to view transcript</div>` : ''}
                    </div>
                `).join('');
            } else {
                document.getElementById('intel-calls-list').innerHTML = `
                    <div style="color: var(--text-muted); font-style: italic; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                        No calls recorded.
                    </div>
                `;
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Set up modal tab listeners
        document.querySelectorAll('.modal-tab').forEach(el => {
            el.addEventListener('click', () => {
                const tab = el.dataset.modalTab;
                if (tab) switchModalTab(tab);
            });
        });
        
        // Close modal on overlay click
        document.getElementById('customer-modal').addEventListener('click', (e) => {
            if (e.target.id === 'customer-modal') closeModal();
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CUSTOMER ACTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function addProperty() {
            const nickname = prompt('Property nickname (e.g., "Beach House", "Rental"):');
            if (!nickname) return;
            
            const street = prompt('Street address:');
            if (!street) return;
            
            const city = prompt('City:');
            const state = prompt('State (2 letters):');
            const zip = prompt('ZIP code:');
            
            const gateCode = prompt('Gate code (optional):');
            const accessNotes = prompt('Access notes (optional):');
            
            // Save the new property
            saveNewProperty({
                nickname,
                street,
                city,
                state,
                zip,
                gateCode,
                accessNotes
            });
        }
        
        async function saveNewProperty(propertyData) {
            if (!currentCustomer) return;
            
            try {
                await apiCall(`/api/admin/call-center/${currentCompanyId}/customers/${currentCustomer._id}/properties`, {
                    method: 'POST',
                    body: JSON.stringify(propertyData)
                });
                
                alert('Property added successfully!');
                viewCustomer(currentCustomer._id); // Refresh
            } catch (err) {
                alert('Failed to add property: ' + err.message);
            }
        }
        
        function addHouseholdMember() {
            const name = prompt('Member name:');
            if (!name) return;
            
            const relationship = prompt('Relationship (e.g., "Spouse", "Tenant"):');
            const phone = prompt('Phone number (optional):');
            const canAuth = confirm('Can this person authorize work?');
            
            saveNewHouseholdMember({
                name,
                relationship,
                phone,
                canAuthorize: canAuth
            });
        }
        
        async function saveNewHouseholdMember(memberData) {
            if (!currentCustomer) return;
            
            try {
                await apiCall(`/api/admin/call-center/${currentCompanyId}/customers/${currentCustomer._id}/household`, {
                    method: 'POST',
                    body: JSON.stringify(memberData)
                });
                
                alert('Household member added successfully!');
                viewCustomer(currentCustomer._id); // Refresh
            } catch (err) {
                alert('Failed to add household member: ' + err.message);
            }
        }
        
        function convertToCommercial() {
            if (!confirm('Convert this to a commercial account? This will add commercial-specific fields.')) return;
            
            const businessName = prompt('Business name:');
            if (!businessName) return;
            
            const industryType = prompt('Industry (e.g., restaurant, warehouse, office):');
            const serviceEntrance = prompt('Service entrance instructions:');
            const unitLocation = prompt('Unit/equipment location:');
            
            saveCommercialConversion({
                businessName,
                industryType,
                serviceEntrance,
                unitLocation
            });
        }
        
        async function saveCommercialConversion(commercialData) {
            if (!currentCustomer) return;
            
            try {
                await apiCall(`/api/admin/call-center/${currentCompanyId}/customers/${currentCustomer._id}/convert-commercial`, {
                    method: 'POST',
                    body: JSON.stringify(commercialData)
                });
                
                alert('Converted to commercial account!');
                viewCustomer(currentCustomer._id); // Refresh
            } catch (err) {
                alert('Failed to convert: ' + err.message);
            }
        }
        
        function linkAccount() {
            const accountId = prompt('Enter the Customer ID to link (e.g., CUST-12345 or COMM-67890):');
            if (!accountId) return;
            
            const relationship = prompt('Relationship (e.g., "Manager at", "Also residential customer"):');
            
            saveLinkAccount({
                accountId,
                relationship
            });
        }
        
        async function saveLinkAccount(linkData) {
            if (!currentCustomer) return;
            
            try {
                await apiCall(`/api/admin/call-center/${currentCompanyId}/customers/${currentCustomer._id}/link`, {
                    method: 'POST',
                    body: JSON.stringify(linkData)
                });
                
                alert('Account linked successfully!');
                viewCustomer(currentCustomer._id); // Refresh
            } catch (err) {
                alert('Failed to link account: ' + err.message);
            }
        }
        
        function editNotes() {
            const currentNotes = currentCustomer?.specialNotes || '';
            const newNotes = prompt('Edit special notes:', currentNotes);
            if (newNotes === null) return;
            
            saveNotes(newNotes);
        }
        
        async function saveNotes(notes) {
            if (!currentCustomer) return;
            
            try {
                await apiCall(`/api/admin/call-center/${currentCompanyId}/customers/${currentCustomer._id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ specialNotes: notes })
                });
                
                currentCustomer.specialNotes = notes;
                document.getElementById('modal-notes').textContent = notes || 'No special notes';
                document.getElementById('modal-notes').className = notes ? 'detail-value' : 'detail-value empty';
            } catch (err) {
                alert('Failed to save notes: ' + err.message);
            }
        }
        
        async function saveCustomer() {
            // TODO: Implement full save
            alert('Changes saved!');
            closeModal();
            if (currentTab === 'customers') loadCustomers();
        }
        
        function editProperty(propertyId) {
            alert(`Edit property: ${propertyId} - Coming soon!`);
        }
        
        function editHouseholdMember(idx) {
            alert(`Edit household member ${idx} - Coming soon!`);
        }
        
        function editCommercial() {
            alert('Edit commercial info - Coming soon!');
        }
        
        function addAuthorizedCaller() {
            const name = prompt('Caller name:');
            if (!name) return;
            
            const title = prompt('Title (e.g., "Office Manager"):');
            const phone = prompt('Phone number:');
            
            alert(`Adding authorized caller: ${name} - Coming soon!`);
        }
        
        function viewRelatedAccount(accountId) {
            alert(`View related account: ${accountId} - Coming soon!`);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CALL DETAIL MODAL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let currentCall = null;
        
        async function viewCall(callId) {
            const modal = document.getElementById('call-modal');
            modal.classList.add('open');
            
            // Reset modal state
            document.getElementById('call-modal-transcript').innerHTML = `
                <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px;"></i>
                    <p>Loading transcript...</p>
                </div>
            `;
            
            try {
                // Load call with transcript
                const res = await apiCall(`/api/admin/call-center/${currentCompanyId}/calls/${callId}?includeTranscript=true`);
                currentCall = res.data;
                
                populateCallModal(currentCall);
                
            } catch (err) {
                console.error('Failed to load call:', err);
                document.getElementById('call-modal-transcript').innerHTML = `
                    <div style="text-align: center; color: var(--accent-red); padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i>
                        <p>Failed to load call: ${err.message}</p>
                    </div>
                `;
            }
        }
        
        function populateCallModal(call) {
            // Header info
            const initials = getInitials(call.callerName || call.phone);
            document.getElementById('call-modal-avatar').textContent = initials;
            document.getElementById('call-modal-avatar').className = `customer-avatar ${call.isReturning ? 'returning' : ''}`;
            document.getElementById('call-modal-customer-name').textContent = call.callerName || 'Unknown Caller';
            document.getElementById('call-modal-phone').textContent = formatPhone(call.phone);
            document.getElementById('call-modal-date').textContent = new Date(call.startedAt).toLocaleString();
            document.getElementById('call-modal-duration').textContent = formatDuration(call.durationSeconds);
            
            // Stats
            document.getElementById('call-modal-outcome').textContent = call.outcome || 'â€”';
            document.getElementById('call-modal-outcome').style.color = 
                call.outcome === 'booked' ? 'var(--accent-green)' :
                call.outcome === 'completed' ? 'var(--accent-cyan)' :
                call.outcome === 'abandoned' ? 'var(--accent-red)' : 'var(--text-primary)';
            document.getElementById('call-modal-intent').textContent = call.primaryIntent || 'Unknown';
            document.getElementById('call-modal-tier').textContent = call.routingTier ? `Tier ${call.routingTier}` : 'â€”';
            document.getElementById('call-modal-turns').textContent = call.turnCount || 'â€”';
            
            // Transcript
            renderCallTranscript(call);
            
            // AI Summary
            if (call.aiSummary) {
                document.getElementById('call-modal-summary-section').style.display = 'block';
                document.getElementById('call-modal-summary').textContent = call.aiSummary;
            } else {
                document.getElementById('call-modal-summary-section').style.display = 'none';
            }
            
            // Slots Collected
            if (call.slotsCollected && Object.keys(call.slotsCollected).length > 0) {
                document.getElementById('call-modal-slots-section').style.display = 'block';
                document.getElementById('call-modal-slots').innerHTML = Object.entries(call.slotsCollected)
                    .map(([key, value]) => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-light);">
                            <span style="color: var(--text-muted); font-size: 13px;">${key}</span>
                            <span style="color: var(--text-primary); font-weight: 500;">${value || 'â€”'}</span>
                        </div>
                    `).join('');
            } else {
                document.getElementById('call-modal-slots-section').style.display = 'none';
            }
        }
        
        function renderCallTranscript(call) {
            const transcriptEl = document.getElementById('call-modal-transcript');
            
            // Check for transcript data
            const turns = call.transcript?.turns || call.turns || [];
            
            if (turns.length === 0) {
                transcriptEl.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                        <i class="fas fa-comment-slash" style="font-size: 32px; margin-bottom: 12px;"></i>
                        <p>No transcript available for this call</p>
                    </div>
                `;
                return;
            }
            
            transcriptEl.innerHTML = turns.map((turn, idx) => {
                const isCaller = turn.speaker === 'caller' || turn.role === 'user';
                const isAgent = turn.speaker === 'agent' || turn.role === 'assistant';
                
                return `
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; ${isCaller ? 'flex-direction: row;' : 'flex-direction: row-reverse;'}">
                        <div style="
                            width: 32px; height: 32px; border-radius: 50%;
                            background: ${isCaller ? 'var(--accent-cyan)' : 'var(--accent-purple)'};
                            display: flex; align-items: center; justify-content: center;
                            font-size: 12px; font-weight: 600; flex-shrink: 0;
                            color: ${isCaller ? '#000' : '#fff'};
                        ">
                            ${isCaller ? 'ğŸ‘¤' : 'ğŸ¤–'}
                        </div>
                        <div style="
                            max-width: 70%; padding: 12px 16px; border-radius: 12px;
                            background: ${isCaller ? 'rgba(34, 211, 238, 0.1)' : 'rgba(168, 85, 247, 0.1)'};
                            color: var(--text-primary); font-size: 14px; line-height: 1.5;
                        ">
                            <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">
                                ${isCaller ? 'Caller' : 'AI Agent'} ${turn.timestamp ? 'â€¢ ' + new Date(turn.timestamp).toLocaleTimeString() : ''}
                            </div>
                            ${turn.text || turn.content || '(empty)'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function closeCallModal() {
            document.getElementById('call-modal').classList.remove('open');
            currentCall = null;
        }
        
        async function flagCallFromModal() {
            if (!currentCall) return;
            
            const reason = prompt('Enter flag reason:');
            if (!reason) return;
            
            try {
                await apiCall(`/api/admin/call-center/${currentCompanyId}/calls/${currentCall.callId}/flag`, {
                    method: 'POST',
                    body: JSON.stringify({ reason })
                });
                alert('Call flagged successfully!');
                await loadCalls();
            } catch (err) {
                alert('Failed to flag call: ' + err.message);
            }
        }
        
        function viewCustomerFromCall() {
            if (!currentCall || !currentCall.customerId) {
                alert('No customer associated with this call');
                return;
            }
            closeCallModal();
            viewCustomer(currentCall.customerId);
        }
        
        async function flagCall(callId) {
            const reason = prompt('Enter flag reason:');
            if (!reason) return;
            
            try {
                await apiCall(`/api/admin/call-center/${currentCompanyId}/calls/${callId}/flag`, {
                    method: 'POST',
                    body: JSON.stringify({ reason })
                });
                await loadCalls();
            } catch (err) {
                alert('Failed to flag call: ' + err.message);
            }
        }
    </script>
</body>
</html>

