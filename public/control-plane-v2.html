<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ClientsVia Control Plane</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Tailwind CSS (compiled from input.css) -->
  <link rel="stylesheet" href="/css/output.css">
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CLEAN SWEEP ARCHITECTURE - December 2025
       Single Source of Truth: Dynamic Flow â†’ All Routing
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #ffffff;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --text-dark: #1e293b;
      --accent-orange: #f97316;
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-purple: #8b5cf6;
      --accent-cyan: #06b6d4;
      --border-subtle: #334155;
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1f35 100%);
      color: var(--text-primary);
      min-height: 100vh;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOP HEADER BAR
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .top-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-subtle);
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 10px;
      border: 2px solid var(--accent-blue);
      background: var(--accent-blue);
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-back:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    .page-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    /* Platform JSON Button */
    .btn-json {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .btn-json:hover {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    /* Golden Setup Button */
    .btn-golden {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .btn-golden:hover {
      background: linear-gradient(135deg, #6d28d9 0%, #9333ea 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    }
    
    /* Export Config Button */
    .btn-export {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 14px;
      background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    .btn-export:hover {
      background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }
    
    /* Apply Patch Button */
    .btn-patch {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 14px;
      background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
      color: #1e293b;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    .btn-patch:hover {
      background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }
    
    /* Validator Button */
    .btn-validator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 14px;
      background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    .btn-validator:hover {
      background: linear-gradient(135deg, #db2777 0%, #ec4899 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
    }
    
    /* Debug Button */
    .btn-debug {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 14px;
      background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    .btn-debug:hover {
      background: linear-gradient(135deg, #475569 0%, #64748b 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3);
    }
    
    /* Debug Drawer Styles */
    .debug-drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: flex-end;
      z-index: 10000;
    }
    .debug-drawer-overlay.open {
      display: flex;
    }
    .debug-drawer {
      width: 600px;
      max-width: 90vw;
      height: 100%;
      background: #0f172a;
      color: #e2e8f0;
      box-shadow: -4px 0 20px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    .debug-drawer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-bottom: 1px solid #475569;
    }
    .debug-drawer-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    .debug-drawer-close {
      background: transparent;
      border: none;
      color: #94a3b8;
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
    }
    .debug-drawer-close:hover {
      color: #f1f5f9;
    }
    .debug-drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .debug-section {
      margin-bottom: 24px;
    }
    .debug-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .debug-score-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 16px;
    }
    .debug-score-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    .debug-score-circle.green { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
    .debug-score-circle.yellow { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); }
    .debug-score-circle.red { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }
    .debug-score-value { font-size: 24px; }
    .debug-score-grade { font-size: 14px; opacity: 0.9; }
    .debug-score-details { flex: 1; }
    .debug-score-details h4 { margin: 0 0 8px 0; font-size: 16px; }
    .debug-score-details p { margin: 0; font-size: 13px; color: #94a3b8; }
    .debug-issues-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .debug-issue {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: #1e293b;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .debug-issue-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }
    .debug-issue-icon.error { background: #dc2626; }
    .debug-issue-icon.warning { background: #d97706; }
    .debug-issue-icon.info { background: #2563eb; }
    .debug-issue-content { flex: 1; }
    .debug-issue-field { font-size: 12px; color: #64748b; margin-bottom: 4px; }
    .debug-issue-message { font-size: 13px; color: #e2e8f0; }
    .debug-json-block {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 12px;
      overflow-x: auto;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 11px;
      max-height: 300px;
      overflow-y: auto;
    }
    .debug-metric-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #334155;
    }
    .debug-metric-row:last-child { border-bottom: none; }
    .debug-metric-label { color: #94a3b8; font-size: 13px; }
    .debug-metric-value { color: #e2e8f0; font-size: 13px; font-weight: 600; }
    .debug-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 1px solid #334155;
      padding-bottom: 8px;
    }
    .debug-tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: #94a3b8;
      font-size: 13px;
      cursor: pointer;
      border-radius: 6px 6px 0 0;
      transition: all 0.2s;
    }
    .debug-tab:hover { color: #e2e8f0; background: #1e293b; }
    .debug-tab.active { color: #e2e8f0; background: #334155; }
    .debug-tab-content { display: none; }
    .debug-tab-content.active { display: block; }
    
    .json-badge-score {
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }
    
    .json-badge-score.notloaded { background: #64748b; color: white; }
    .json-badge-score.green { background: #10b981; color: white; }
    .json-badge-score.yellow { background: #f59e0b; color: white; }
    .json-badge-score.red { background: #ef4444; color: white; }
    .json-badge-score.error { background: #7f1d1d; color: white; }
    
    /* Platform Snapshot Modal */
    .snapshot-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .snapshot-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .snapshot-modal {
      background: white;
      border-radius: 16px;
      width: 95%;
      max-width: 1200px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
      transform: scale(0.95) translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .snapshot-modal-overlay.active .snapshot-modal {
      transform: scale(1) translateY(0);
    }
    
    .snapshot-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid #e2e8f0;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-radius: 16px 16px 0 0;
      color: white;
    }
    
    .snapshot-modal-title {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .snapshot-status-badge {
      padding: 6px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 14px;
    }
    
    .snapshot-status-badge.green { background: #10b981; color: white; }
    .snapshot-status-badge.yellow { background: #f59e0b; color: white; }
    .snapshot-status-badge.red { background: #ef4444; color: white; }
    
    .snapshot-modal-controls {
      display: flex;
      gap: 12px;
    }
    
    .snapshot-modal-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .snapshot-scope-selector {
      padding: 16px 24px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 24px;
    }
    
    .snapshot-scope-label {
      font-weight: 600;
      color: #475569;
    }
    
    .snapshot-scope-options {
      display: flex;
      gap: 12px;
    }
    
    .snapshot-scope-options label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 8px;
      background: white;
      border: 2px solid #e2e8f0;
      transition: all 0.2s;
      color: #374151;
      font-weight: 500;
      font-size: 13px;
    }
    
    .snapshot-scope-options label:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    
    .snapshot-scope-options label:has(input:checked) {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .snapshot-scope-options input[type="radio"] {
      display: none;
    }
    
    .snapshot-json-container {
      flex: 1;
      overflow: auto;
      background: #0d1117;
      position: relative;
    }
    
    .snapshot-json-pre {
      margin: 0;
      padding: 24px;
      color: #c9d1d9;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    .snapshot-penalties-panel {
      padding: 16px 24px;
      background: #fef3c7;
      border-top: 1px solid #fcd34d;
      max-height: 200px;
      overflow-y: auto;
      color: #1f2937;
    }
    
    .snapshot-penalties-panel.red { background: #fee2e2; border-color: #fca5a5; color: #7f1d1d; }
    .snapshot-penalties-panel.yellow { background: #fef3c7; border-color: #fcd34d; color: #78350f; }
    .snapshot-penalties-panel.green { background: #d1fae5; border-color: #6ee7b7; color: #064e3b; }
    
    .snapshot-modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8fafc;
      border-radius: 0 0 16px 16px;
    }
    
    .btn-test {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 10px;
      border: 2px solid var(--accent-green);
      background: linear-gradient(135deg, #059669, var(--accent-green));
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn-test:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }
    
    .btn-black-box {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 10px;
      border: 2px solid var(--accent-orange);
      background: var(--accent-orange);
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .btn-black-box:hover {
      background: #ea580c;
      transform: translateY(-1px);
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN NAVIGATION - FLAT, SINGLE-LEVEL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .main-nav {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 12px 24px;
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border-subtle);
      overflow-x: auto;
    }
    
    .nav-tab {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .nav-tab:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }
    
    .nav-tab.active {
      background: var(--accent-orange);
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
    }
    
    .nav-tab i {
      font-size: 16px;
    }
    
    .nav-divider {
      width: 1px;
      height: 24px;
      background: var(--border-subtle);
      margin: 0 8px;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONTENT AREA
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .content-area {
      padding: 24px;
      min-height: calc(100vh - 140px);
    }
    
    .tab-panel {
      display: none;
    }
    
    .tab-panel.active {
      display: block;
    }
    
    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
      color: var(--text-dark);
    }
    
    .card h2 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-dark);
    }
    
    .card .muted {
      color: #64748b;
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    /* Loading spinner */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 20px;
      color: #64748b;
    }
    
    .loading-container i {
      font-size: 48px;
      margin-bottom: 20px;
      color: var(--accent-orange);
    }
    
    .loading-container p {
      font-size: 16px;
      font-weight: 500;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FLOW TREE VISUALIZATION
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .flow-tree-container {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      border-radius: 16px;
      padding: 24px;
      min-height: 600px;
      color: var(--text-primary);
    }
    
    .flow-tree-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-subtle);
    }
    
    .flow-tree-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .flow-tree-title h2 {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }
    
    .flow-tree-title .icon {
      font-size: 32px;
    }
    
    .flow-tree-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(16, 185, 129, 0.2);
      border-radius: 20px;
      color: var(--accent-green);
      font-weight: 600;
      font-size: 14px;
    }
    
    .tree-node {
      display: flex;
      flex-direction: column;
      margin-left: 24px;
      position: relative;
    }
    
    .tree-node::before {
      content: '';
      position: absolute;
      left: -16px;
      top: 0;
      bottom: 20px;
      width: 2px;
      background: var(--border-subtle);
    }
    
    .tree-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px;
      margin: 8px 0;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border-left: 4px solid var(--accent-blue);
      position: relative;
    }
    
    .tree-item::before {
      content: '';
      position: absolute;
      left: -20px;
      top: 24px;
      width: 16px;
      height: 2px;
      background: var(--border-subtle);
    }
    
    .tree-item.active {
      border-left-color: var(--accent-green);
      background: rgba(16, 185, 129, 0.1);
    }
    
    .tree-item.triggered {
      border-left-color: var(--accent-orange);
      background: rgba(249, 115, 22, 0.1);
    }
    
    .tree-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-secondary);
      border-radius: 10px;
      font-size: 20px;
    }
    
    .tree-content {
      flex: 1;
    }
    
    .tree-content h4 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .tree-content p {
      font-size: 13px;
      color: var(--text-secondary);
      margin: 0;
    }
    
    .tree-meta {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }
    
    .meta-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .meta-badge.success {
      background: rgba(16, 185, 129, 0.2);
      color: var(--accent-green);
    }
    
    .meta-badge.warning {
      background: rgba(249, 115, 22, 0.2);
      color: var(--accent-orange);
    }
    
    /* Data boxes for live call memory */
    .data-boxes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }
    
    .data-box {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--border-subtle);
    }
    
    .data-box-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .data-box-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }
    
    .data-box-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .data-box-value.empty {
      color: var(--text-secondary);
      font-style: italic;
      font-weight: 400;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BUTTONS & FORMS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--accent-blue);
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-secondary {
      background: #e2e8f0;
      color: var(--text-dark);
    }
    
    .btn-secondary:hover {
      background: #cbd5e1;
    }
    
    .btn-danger {
      background: #dc2626;
      color: white;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TABLES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 14px;
    }
    
    table th {
      background: #f8fafc;
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #e2e8f0;
      color: var(--text-dark);
    }
    
    table td {
      padding: 12px 16px;
      border-bottom: 1px solid #f1f5f9;
      color: var(--text-dark);
    }
    
    table tr:hover {
      background: #f8fafc;
    }
    
    /* Status badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-active {
      background: #d1fae5;
      color: #059669;
    }
    
    .status-inactive {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .status-pending {
      background: #fef3c7;
      color: #d97706;
    }
  </style>
</head>
<body>
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOP HEADER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <header class="top-header">
    <div class="header-left">
      <button class="btn-back" onclick="goBackToProfile()">
      <i class="fas fa-arrow-left"></i>
      <span>Back to Profile</span>
    </button>
      <h1 class="page-title">ğŸ›ï¸ Control Plane</h1>
    </div>
    <div class="header-right">
      <!-- ğŸŸ£ GOLDEN SETUP BUTTON (Admin Only) -->
      <button id="btn-golden-setup" class="btn-golden" onclick="openGoldenSetupModal()" title="Load Golden HVAC Reference Setup">
        <span>ğŸŸ£</span>
        <span>Golden Setup</span>
      </button>
      <!-- ğŸ“¤ EXPORT CONFIG BUTTON (ChatGPT Workflow) -->
      <button id="btn-export-config" class="btn-export" onclick="openExportModal()" title="Export full config for ChatGPT analysis">
        <span>ğŸ“¤</span>
        <span>Export</span>
      </button>
      <!-- ğŸ“¥ APPLY PATCH BUTTON - REMOVED (was causing issues) -->
      <!-- ğŸ” VALIDATOR BUTTON - REMOVED (redundant with Scenario Browser AUDIT tab) -->
      <!-- ğŸ”§ DEBUG DRAWER BUTTON (Control Plane Introspection) -->
      <button id="btn-debug-drawer" class="btn-debug" onclick="openDebugDrawer()" title="View effective config, lint results, and performance metrics">
        <span>ğŸ”§</span>
        <span>Debug</span>
      </button>
      <!-- ğŸ“„ PLATFORM SNAPSHOT BUTTON (Enterprise Introspection) -->
      <button id="btn-platform-json" class="btn-json" onclick="openPlatformSnapshotModal()">
        <span id="json-badge-emoji">â³</span>
        <span>JSON</span>
        <span id="json-badge-score" class="json-badge-score notloaded">â€”</span>
      </button>
      <button class="btn-test" onclick="openAITestConsole()">
        <i class="fas fa-phone-volume"></i>
        <span>ğŸ§ª Test Agent</span>
      </button>
      <a href="#" class="btn-black-box" onclick="openBlackBox(); return false;">
        <span>ğŸ“¼</span>
        <span>Black Box</span>
      </a>
    </div>
  </header>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN NAVIGATION - SINGLE LEVEL, FLAT STRUCTURE
       Final Navigation: Front Desk | Flow Tree | Dynamic Flow | Call Protection | 
                        Transfer Calls | Call Center | Company Contacts | Links | Version History
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <nav class="main-nav">
    <button class="nav-tab active" data-tab="front-desk">
      <i class="fas fa-concierge-bell"></i>
      <span>Front Desk</span>
    </button>
    <button class="nav-tab" data-tab="flow-tree">
      <i class="fas fa-project-diagram"></i>
      <span>Flow Tree</span>
    </button>
    <button class="nav-tab" data-tab="dynamic-flow">
      <i class="fas fa-code-branch"></i>
      <span>Dynamic Flow</span>
    </button>
    <button class="nav-tab" data-tab="data-config">
      <i class="fas fa-database"></i>
      <span>Data & Config</span>
    </button>
    
    <div class="nav-divider"></div>
    
    <button class="nav-tab" data-tab="call-protection">
      <i class="fas fa-shield-alt"></i>
      <span>Call Protection</span>
    </button>
    <button class="nav-tab" data-tab="transfer-calls">
      <i class="fas fa-phone-alt"></i>
      <span>Transfer Calls</span>
    </button>
    
    <div class="nav-divider"></div>
    
    <button class="nav-tab" data-tab="call-center" onclick="openCallCenter(); return false;">
      <i class="fas fa-headset"></i>
      <span>Call Center</span>
    </button>
    <button class="nav-tab" data-tab="company-contacts">
      <i class="fas fa-address-book"></i>
      <span>Company Contacts</span>
    </button>
    <button class="nav-tab" data-tab="links">
      <i class="fas fa-link"></i>
      <span>Links</span>
    </button>
    
    <div class="nav-divider"></div>
    
    <button class="nav-tab" data-tab="version-history">
      <i class="fas fa-history"></i>
      <span>Version History</span>
    </button>
    
    <div class="nav-divider"></div>
    
    <button class="nav-tab" data-tab="legacy" style="color: #f59e0b;">
      <i class="fas fa-archive"></i>
      <span>ğŸ“¦ Legacy</span>
    </button>
  </nav>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONTENT PANELS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <main class="content-area">
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         FRONT DESK - The Config Brain
         Greeting rules, tone, confirmation, policy guardrails, booking fields,
         escalation preferences, quick answers
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel active" data-panel="front-desk">
      <div class="card">
        <div id="front-desk-container">
          <div class="loading-container">
            <i class="fas fa-concierge-bell fa-spin"></i>
            <p>Loading Front Desk Configuration...</p>
            </div>
          </div>
        </div>
      </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         FLOW TREE - Live AI Decision Visualization + System Snapshot
         Real-time understanding of how AI agent operates during calls
         SINGLE SOURCE OF TRUTH - If it's not in the snapshot, it doesn't exist
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel" data-panel="flow-tree">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; min-height: 600px;">
        
        <!-- LEFT PANEL: Visual Flow Tree -->
        <div class="flow-tree-container">
          <div class="flow-tree-header">
            <div class="flow-tree-title">
              <span class="icon">ğŸŒ³</span>
              <h2>AI Decision Flow Tree</h2>
            </div>
            <div class="flow-tree-status" id="flow-tree-status">
              <i class="fas fa-circle"></i>
              <span>Ready</span>
            </div>
          </div>
          
          <div id="flow-tree-content">
          <!-- Static visualization - will be populated dynamically during live calls -->
          <div class="tree-node">
            <!-- Call Start -->
            <div class="tree-item active">
              <div class="tree-icon">ğŸ“</div>
              <div class="tree-content">
                <h4>Call Arrives</h4>
                <p>Incoming call detected, initializing AI agent</p>
                <div class="tree-meta">
                  <span class="meta-badge success">âœ“ Connected</span>
          </div>
        </div>
      </div>

            <!-- Call Protection -->
            <div class="tree-node">
              <div class="tree-item">
                <div class="tree-icon">ğŸ›¡ï¸</div>
                <div class="tree-content">
                  <h4>Call Protection</h4>
                  <p>Pre-answer filters: spam detection, IVR detection, abuse protection</p>
                  <div class="tree-meta">
                    <span class="meta-badge">Spam Check</span>
                    <span class="meta-badge">IVR Detection</span>
                    <span class="meta-badge">Machine Detection</span>
                  </div>
                </div>
              </div>
              
              <!-- Dynamic Flow Router -->
              <div class="tree-node">
                <div class="tree-item">
                  <div class="tree-icon">ğŸ”€</div>
                  <div class="tree-content">
                    <h4>Dynamic Flow Router</h4>
                    <p>Single source of truth for all routing decisions</p>
                    <div class="tree-meta">
                      <span class="meta-badge">Priority-based</span>
                      <span class="meta-badge">Trigger matching</span>
            </div>
                  </div>
                </div>
                
                <!-- Flow Nodes (populated from Dynamic Flows) -->
                <div class="tree-node" id="dynamic-flows-tree">
                  <div class="tree-item" style="border-left-color: #f97316;">
                    <div class="tree-icon">âš¡</div>
                    <div class="tree-content">
                      <h4>Emergency Service</h4>
                      <p>Trigger: "no heat", "no air", "emergency"</p>
                      <div class="tree-meta">
                        <span class="meta-badge warning">Priority: 200</span>
                        <span class="meta-badge">â†’ Booking</span>
          </div>
        </div>
      </div>

                  <div class="tree-item" style="border-left-color: #3b82f6;">
                    <div class="tree-icon">ğŸ“…</div>
                    <div class="tree-content">
                      <h4>Booking Intent</h4>
                      <p>Trigger: "schedule", "appointment", "book"</p>
                      <div class="tree-meta">
                        <span class="meta-badge">Priority: 100</span>
                        <span class="meta-badge">â†’ Booking</span>
            </div>
          </div>
        </div>
                  
                  <div class="tree-item" style="border-left-color: #8b5cf6;">
                    <div class="tree-icon">â“</div>
                    <div class="tree-content">
                      <h4>General Inquiry</h4>
                      <p>Trigger: "question", "information", "help"</p>
                      <div class="tree-meta">
                        <span class="meta-badge">Priority: 50</span>
                        <span class="meta-badge">â†’ Discovery</span>
      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Action Handler -->
                <div class="tree-item">
                  <div class="tree-icon">âš™ï¸</div>
                  <div class="tree-content">
                    <h4>Action Handler</h4>
                    <p>Transfer / Booking / Message / KB / Escalation</p>
                    <div class="tree-meta">
                      <span class="meta-badge">Target: Booking Engine</span>
                    </div>
              </div>
            </div>
            
                <!-- LLM Fallback -->
                <div class="tree-item" style="opacity: 0.6;">
                  <div class="tree-icon">ğŸ¤–</div>
                  <div class="tree-content">
                    <h4>LLM Fallback</h4>
                    <p>Last resort only - when no flow matches</p>
                    <div class="tree-meta">
                      <span class="meta-badge">$0.50/use</span>
                      <span class="meta-badge">Target: &lt;1%</span>
              </div>
              </div>
                </div>
              </div>
              </div>
            </div>
            
          <!-- Live Call Memory Boxes -->
          <h3 style="margin-top: 32px; margin-bottom: 16px; font-size: 16px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">
            ğŸ“Š Live Call Memory (Populates During Calls)
          </h3>
          <div class="data-boxes">
            <div class="data-box">
              <div class="data-box-header">
                <span class="data-box-title">Caller Name</span>
              </div>
              <div class="data-box-value empty">Not collected</div>
            </div>
            <div class="data-box">
              <div class="data-box-header">
                <span class="data-box-title">Phone Number</span>
              </div>
              <div class="data-box-value empty">Not collected</div>
            </div>
            <div class="data-box">
              <div class="data-box-header">
                <span class="data-box-title">Service Type</span>
              </div>
              <div class="data-box-value empty">Not detected</div>
            </div>
            <div class="data-box">
              <div class="data-box-header">
                <span class="data-box-title">Urgency</span>
              </div>
              <div class="data-box-value empty">Not assessed</div>
            </div>
            <div class="data-box">
              <div class="data-box-header">
                <span class="data-box-title">Trigger Matched</span>
              </div>
              <div class="data-box-value empty">Awaiting call</div>
            </div>
            <div class="data-box">
              <div class="data-box-header">
                <span class="data-box-title">Match Score</span>
              </div>
              <div class="data-box-value empty">â€”</div>
            </div>
            <div class="data-box">
              <div class="data-box-header">
                <span class="data-box-title">Flow Priority</span>
              </div>
              <div class="data-box-value empty">â€”</div>
            </div>
            <div class="data-box">
              <div class="data-box-header">
                <span class="data-box-title">Action Taken</span>
              </div>
              <div class="data-box-value empty">â€”</div>
            </div>
            <div class="data-box">
              <div class="data-box-header">
                <span class="data-box-title">Booking Status</span>
              </div>
              <div class="data-box-value empty">â€”</div>
            </div>
          </div>
        </div>
          </div>
          
        <!-- RIGHT PANEL: System Snapshot (Copyable JSON) -->
        <div class="flow-tree-container" style="background: linear-gradient(135deg, #1a1f35 0%, #0f172a 100%);">
          <div class="flow-tree-header">
            <div class="flow-tree-title">
              <span class="icon">ğŸ“¸</span>
              <h2>System Snapshot</h2>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div id="snapshot-status" style="display: flex; align-items: center; gap: 8px; padding: 6px 14px; background: rgba(16, 185, 129, 0.2); border-radius: 20px; color: var(--accent-green); font-weight: 600; font-size: 13px;">
                <span id="snapshot-mode-icon">ğŸŸ¡</span>
                <span id="snapshot-mode-text">IDLE</span>
          </div>
        </div>
      </div>

          <!-- Snapshot Controls -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <div style="position: relative; display: inline-block;">
              <button onclick="toggleRuntimeTruthDropdown()" id="btn-copy-snapshot" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border-radius: 8px; border: 2px solid var(--accent-orange); background: var(--accent-orange); color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                <span style="display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; background: white; color: var(--accent-orange); border-radius: 50%; font-size: 12px; font-weight: 700;">1</span>
                <span>Runtime Truth</span>
                <i class="fas fa-chevron-down" style="font-size: 10px; margin-left: 4px;"></i>
              </button>
              <div id="runtime-truth-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 4px; background: #1e293b; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 180px; z-index: 1000; overflow: hidden;">
                <button onclick="copySystemSnapshot(); toggleRuntimeTruthDropdown();" style="width: 100%; padding: 12px 16px; background: transparent; color: #e2e8f0; border: none; text-align: left; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #334155;">
                  <i class="fas fa-copy" style="color: #f97316; width: 16px;"></i> Copy to Clipboard
                </button>
                <button onclick="downloadRuntimeTruth(); toggleRuntimeTruthDropdown();" style="width: 100%; padding: 12px 16px; background: transparent; color: #e2e8f0; border: none; text-align: left; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 10px;">
                  <i class="fas fa-download" style="color: #22c55e; width: 16px;"></i> Download .json
                </button>
              </div>
            </div>
            <button onclick="refreshSystemSnapshot()" id="btn-refresh-snapshot" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border-radius: 8px; border: 2px solid var(--border-subtle); background: transparent; color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
              <i class="fas fa-sync-alt" id="refresh-icon"></i>
              <span>ğŸ”„ Refresh</span>
          </button>
          </div>
          
          <!-- Snapshot Info -->
          <div style="display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary);">
              <i class="fas fa-clock"></i>
              <span>Generated: </span>
              <span id="snapshot-timestamp" style="color: var(--text-primary);">â€”</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary);">
              <i class="fas fa-bolt"></i>
              <span>Time: </span>
              <span id="snapshot-generation-time" style="color: var(--accent-green);">â€”</span>
          </div>
        </div>
        
          <!-- Snapshot Stats -->
          <div id="snapshot-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 20px; font-weight: 700; color: var(--accent-orange);" id="stat-flows">â€”</div>
              <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Flows</div>
              <button id="btn-create-booking-flow" onclick="createBookingFlow()" style="display: none; margin-top: 8px; padding: 6px 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer;">
                <i class="fas fa-plus"></i> Create Booking Flow
              </button>
            </div>
            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 20px; font-weight: 700; color: var(--accent-blue);" id="stat-transfers">â€”</div>
              <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Transfers</div>
            </div>
            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 20px; font-weight: 700; color: var(--accent-green);" id="stat-contacts">â€”</div>
              <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Contacts</div>
          </div>
        </div>
        
          <!-- JSON Display -->
          <div style="position: relative;">
            <div style="position: absolute; top: 8px; right: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; z-index: 10;">
              READ-ONLY
            </div>
            <pre id="snapshot-json" style="background: #0d1117; border: 1px solid var(--border-subtle); border-radius: 12px; padding: 16px; font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace; font-size: 11px; line-height: 1.5; color: #c9d1d9; overflow: auto; max-height: 450px; margin: 0; white-space: pre-wrap; word-wrap: break-word;">
{
  "message": "Click 'Refresh' to load system snapshot",
  "hint": "This JSON contains EVERYTHING the AI agent can see"
}
            </pre>
          </div>
          
          <!-- Help Text -->
          <div style="margin-top: 16px; padding: 12px; background: rgba(249, 115, 22, 0.1); border-radius: 8px; border-left: 4px solid var(--accent-orange);">
            <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
              <strong style="color: var(--accent-orange);">ğŸ’¡ This is the Single Source of Truth</strong><br>
              If something is missing from this JSON, it is <strong>not wired</strong> and will <strong>not work in production</strong>.
              Copy this JSON when reporting issues or discussing system behavior.
            </p>
          </div>
        </div>
        
      </div>
    </div>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         DYNAMIC FLOW - The ONLY Routing Brain
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel" data-panel="dynamic-flow">
      <div class="card">
        <div id="dynamic-flow-container">
          <div class="loading-container">
            <i class="fas fa-code-branch fa-spin"></i>
            <p>Loading Dynamic Flow Configuration...</p>
            </div>
          </div>
        </div>
      </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         DATA & CONFIG - Placeholders, Templates, Scenarios
         Global data + company overrides for multi-tenant system
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel" data-panel="data-config">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <div>
            <h2>ğŸ“‚ Data & Config</h2>
            <p class="muted">Manage placeholders, templates, and scenarios. Global data with company-specific overrides.</p>
          </div>
          <!-- CONSOLIDATED BUTTONS: Runtime Truth + Patch Import + Scenario Browser + Debug Tools -->
          <div style="display: flex; gap: 8px;">
            <!-- CORE: Runtime Truth -->
            <button onclick="openRuntimeTruthModal()" 
                    style="padding: 8px 14px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: flex; align-items: center; gap: 6px;"
                    title="THE single JSON that shows exactly what runs at runtime">
              <i class="fas fa-bolt"></i> Runtime Truth
            </button>
            
            <!-- CORE: Patch Import -->
            <button onclick="openPatchImportModal()" 
                    style="padding: 8px 14px; background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: flex; align-items: center; gap: 6px;"
                    title="Paste JSON patches to update configuration">
              <i class="fas fa-file-import"></i> Patch Import
            </button>
            
            <!-- CORE: Scenario Browser (includes RAW/AUDIT/Export/Report) -->
            <button onclick="openScenarioBrowserModal()" 
                    style="padding: 8px 14px; background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: flex; align-items: center; gap: 6px;"
                    title="Browse scenarios with tree view - RAW or AUDIT tabs, includes export and enterprise report">
              <i class="fas fa-folder-tree"></i> Scenario Browser
            </button>
            
            <!-- DEBUG/TOOLS: Dropdown -->
            <div style="position: relative;">
              <button onclick="toggleDebugToolsDropdown()" 
                      style="padding: 8px 14px; background: linear-gradient(135deg, #475569 0%, #64748b 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-tools"></i> Debug â–¾
              </button>
              <div id="debug-tools-dropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: #1e293b; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 200px; z-index: 1000;">
                <button onclick="openFieldReportModal(); toggleDebugToolsDropdown();" 
                        style="width: 100%; padding: 10px 12px; background: transparent; color: #e2e8f0; border: none; text-align: left; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #334155;">
                  <i class="fas fa-clipboard-list" style="color: #818cf8;"></i> Field Report (Schema vs UI)
                </button>
                <button onclick="exportFullScenarioJSON(); toggleDebugToolsDropdown();" 
                        style="width: 100%; padding: 10px 12px; background: transparent; color: #e2e8f0; border: none; text-align: left; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #334155;">
                  <i class="fas fa-file-export" style="color: #22d3ee;"></i> Export Full Scenario JSON
                </button>
                <button onclick="openScenarioReportModal(); toggleDebugToolsDropdown();" 
                        style="width: 100%; padding: 10px 12px; background: transparent; color: #e2e8f0; border: none; text-align: left; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-shield-alt" style="color: #ef4444;"></i> Scenario Report (Legacy)
                </button>
              </div>
            </div>
            
            <!-- Golden Autofill - Classifies all scenarios with scenarioType -->
            <button onclick="runGoldenAutofill()"
                    style="padding: 8px 14px; background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: #1e293b; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: flex; align-items: center; gap: 6px;"
                    title="STEP 4: Classify all scenarios with scenarioType">
              <i class="fas fa-magic"></i> Golden Autofill
              <span style="font-size: 9px; background: #f59e0b; color: black; padding: 1px 4px; border-radius: 3px; margin-left: 4px;">REVIEW</span>
            </button>
          </div>
        </div>
        
        <!-- Sub-tabs for Data & Config -->
        <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px;">
          <button class="data-config-subtab active" data-subtab="placeholders" style="padding: 10px 20px; border: none; background: #3b82f6; color: white; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer;">
            <i class="fas fa-tags"></i> Placeholders
          </button>
          <button class="data-config-subtab" data-subtab="defaults" style="padding: 10px 20px; border: none; background: #f1f5f9; color: #64748b; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer;">
            <i class="fas fa-reply-all"></i> Default Replies
          </button>
          <button class="data-config-subtab" data-subtab="templates" style="padding: 10px 20px; border: none; background: #f1f5f9; color: #64748b; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer;">
            <i class="fas fa-file-alt"></i> Templates
          </button>
          <button class="data-config-subtab" data-subtab="scenarios" style="padding: 10px 20px; border: none; background: #f1f5f9; color: #64748b; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer;">
            <i class="fas fa-theater-masks"></i> Scenarios
          </button>
          <button class="data-config-subtab" data-subtab="execution-map" style="padding: 10px 20px; border: none; background: #f1f5f9; color: #64748b; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer;">
            <i class="fas fa-project-diagram"></i> Execution Map
          </button>
          <button class="data-config-subtab" data-subtab="qa-dashboard" style="padding: 10px 20px; border: none; background: #f1f5f9; color: #64748b; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer;">
            <i class="fas fa-chart-bar"></i> QA Dashboard
          </button>
        </div>
        
        <!-- PLACEHOLDERS (V2 - Replaces Variables) -->
        <div id="data-config-placeholders" class="data-config-content">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div>
              <h3 style="font-size: 18px; font-weight: 600; margin: 0;">ğŸ·ï¸ Placeholders (Variables V2)</h3>
              <p style="font-size: 13px; color: #64748b; margin-top: 4px;">
                Dynamic tokens resolved at runtime. Use <code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px;">{companyName}</code> in prompts.
              </p>
          </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="importPlaceholderDefaults()" class="btn btn-secondary" style="font-size: 13px;">
                <i class="fas fa-download"></i> Import Defaults
              </button>
              <button onclick="addPlaceholder()" class="btn btn-primary" style="font-size: 13px;">
                <i class="fas fa-plus"></i> Add Placeholder
              </button>
            </div>
          </div>
          
          <table id="placeholders-table">
              <thead>
                <tr>
                <th style="width: 30%;">Name (Token)</th>
                <th style="width: 50%;">Value</th>
                <th style="width: 20%;">Actions</th>
                </tr>
              </thead>
            <tbody id="placeholders-list">
              <tr>
                <td colspan="3" style="text-align: center; padding: 40px; color: #94a3b8;">
                  <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px; display: block;"></i>
                  Loading placeholders...
                </td>
              </tr>
              </tbody>
            </table>
          
          <div style="margin-top: 16px; display: flex; justify-content: flex-end; gap: 12px;">
            <button onclick="resetPlaceholders()" class="btn btn-secondary">
              <i class="fas fa-undo"></i> Reset to Defaults
            </button>
            <button onclick="savePlaceholders()" class="btn btn-primary">
              <i class="fas fa-save"></i> Save Changes
            </button>
          </div>
        </div>
        
        <!-- DEFAULT REPLIES (Company-level fallback responses) -->
        <div id="data-config-defaults" class="data-config-content" style="display: none;">
          <div style="margin-bottom: 16px;">
            <h3 style="font-size: 18px; font-weight: 600; margin: 0;">ğŸ“ Company Default Replies</h3>
            <p style="font-size: 13px; color: #64748b; margin-top: 4px;">
              Deterministic fallback responses when scenarios/categories are disabled. <strong>No LLM required.</strong>
            </p>
          </div>
          
          <div id="defaults-loading" style="text-align: center; padding: 40px; color: #94a3b8;">
            <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px; display: block;"></i>
            Loading company defaults...
          </div>
          
          <div id="defaults-form" style="display: none;">
            <!-- Not Offered Reply -->
            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid #f59e0b;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                <span style="font-size: 24px;">ğŸš«</span>
                <div>
                  <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #92400e;">Not Offered Reply</h4>
                  <p style="margin: 4px 0 0 0; font-size: 12px; color: #78350f;">When a caller asks about a disabled scenario/category (e.g., "duct cleaning" disabled).</p>
                </div>
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #78350f; margin-bottom: 4px;">Quick Reply (TTS)</label>
                <input type="text" id="defaults-notOffered-quick" placeholder="I'm sorry, we don't offer that service." 
                  style="width: 100%; padding: 10px 12px; border: 1px solid #d97706; border-radius: 8px; font-size: 14px; background: white;">
              </div>
              <div>
                <label style="display: block; font-size: 12px; font-weight: 600; color: #78350f; margin-bottom: 4px;">Full Reply (Required)</label>
                <textarea id="defaults-notOffered-full" rows="3" placeholder="I'm sorry, that's not a service we currently provide. Is there anything else I can help you with today?"
                  style="width: 100%; padding: 10px 12px; border: 1px solid #d97706; border-radius: 8px; font-size: 14px; resize: vertical; background: white;"></textarea>
              </div>
            </div>
            
            <!-- Unknown Intent Reply -->
            <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid #3b82f6;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                <span style="font-size: 24px;">â“</span>
                <div>
                  <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #1e40af;">Unknown Intent Reply</h4>
                  <p style="margin: 4px 0 0 0; font-size: 12px; color: #1e3a8a;">When the system can't understand what the caller is asking (rare fallback).</p>
                </div>
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #1e40af; margin-bottom: 4px;">Quick Reply (TTS)</label>
                <input type="text" id="defaults-unknownIntent-quick" placeholder="I'm not sure I understand."
                  style="width: 100%; padding: 10px 12px; border: 1px solid #3b82f6; border-radius: 8px; font-size: 14px; background: white;">
              </div>
              <div>
                <label style="display: block; font-size: 12px; font-weight: 600; color: #1e40af; margin-bottom: 4px;">Full Reply (Required)</label>
                <textarea id="defaults-unknownIntent-full" rows="3" placeholder="I'm sorry, I didn't quite catch that. Could you tell me more about what you're looking for?"
                  style="width: 100%; padding: 10px 12px; border: 1px solid #3b82f6; border-radius: 8px; font-size: 14px; resize: vertical; background: white;"></textarea>
              </div>
            </div>
            
            <!-- After Hours Reply -->
            <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid #6366f1;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                <span style="font-size: 24px;">ğŸŒ™</span>
                <div>
                  <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #3730a3;">After Hours Reply</h4>
                  <p style="margin: 4px 0 0 0; font-size: 12px; color: #312e81;">When a caller reaches you outside business hours.</p>
                </div>
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #3730a3; margin-bottom: 4px;">Quick Reply (TTS)</label>
                <input type="text" id="defaults-afterHours-quick" placeholder="We're currently closed."
                  style="width: 100%; padding: 10px 12px; border: 1px solid #6366f1; border-radius: 8px; font-size: 14px; background: white;">
              </div>
              <div>
                <label style="display: block; font-size: 12px; font-weight: 600; color: #3730a3; margin-bottom: 4px;">Full Reply (Required)</label>
                <textarea id="defaults-afterHours-full" rows="3" placeholder="Thanks for calling! Our office is currently closed. Our normal business hours are..."
                  style="width: 100%; padding: 10px 12px; border: 1px solid #6366f1; border-radius: 8px; font-size: 14px; resize: vertical; background: white;"></textarea>
              </div>
            </div>
            
            <!-- Strict Behavior Toggle -->
            <div style="background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid #e2e8f0;">
              <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                <input type="checkbox" id="defaults-strictBehavior" checked
                  style="width: 20px; height: 20px; margin-top: 2px; accent-color: #10b981;">
                <div>
                  <span style="font-weight: 600; color: #1e293b;">Strict Disabled Behavior</span>
                  <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">
                    When enabled, always use Not Offered reply for disabled scenarios (never fall back to LLM).
                    <strong style="color: #059669;">Recommended for predictable, cost-effective responses.</strong>
                  </p>
                </div>
              </label>
            </div>
            
            <!-- Save Button -->
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
              <button onclick="loadCompanyDefaults()" class="btn btn-secondary">
                <i class="fas fa-undo"></i> Reset
              </button>
              <button onclick="saveCompanyDefaults()" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Default Replies
              </button>
            </div>
          </div>
        </div>
        
        <!-- TEMPLATES (Using AiCoreTemplatesManager - YOUR original system) -->
        <div id="data-config-templates" class="data-config-content" style="display: none;">
          <!-- This container is used by AiCoreTemplatesManager -->
          <div id="aicore-templates-container">
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
              <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px; display: block;"></i>
              Loading templates...
          </div>
        </div>
      </div>

        <!-- SCENARIOS (Using AiCoreLiveScenariosManager - YOUR original system) -->
        <div id="data-config-scenarios" class="data-config-content" style="display: none;">
          <!-- This container is used by AiCoreLiveScenariosManager -->
          <div id="aicore-live-scenarios-container">
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
              <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px; display: block;"></i>
              Loading scenarios...
            </div>
          </div>
        </div>


        <!-- EXECUTION MAP (Call Flow Visualization) -->
        <div id="data-config-execution-map" class="data-config-content" style="display: none;">
          <div style="margin-bottom: 20px;">
            <h3 style="font-size: 18px; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 8px;">
              <span>ğŸ—ºï¸</span> Call Execution Map
            </h3>
            <p style="font-size: 13px; color: #64748b; margin-top: 4px;">
              Complete visualization of how calls flow through all systems. Every stage, every connection.
            </p>
          </div>
          
          <!-- Health Status Banner -->
          <div id="execution-map-health" style="background: #f1f5f9; border-radius: 12px; padding: 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
            <div id="execution-map-health-badge" style="width: 48px; height: 48px; border-radius: 12px; background: #22c55e; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-check" style="color: white; font-size: 20px;"></i>
            </div>
            <div>
              <h4 id="execution-map-health-title" style="margin: 0; font-size: 16px; font-weight: 600;">Loading...</h4>
              <p id="execution-map-health-message" style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">Analyzing system configuration...</p>
            </div>
            <div style="flex: 1;"></div>
            <button onclick="refreshExecutionMap()" class="btn btn-secondary" style="padding: 8px 16px;">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button onclick="exportExecutionMap()" class="btn btn-secondary" style="padding: 8px 16px;">
              <i class="fas fa-download"></i> Export JSON
            </button>
          </div>
          
          <!-- Execution Flow Diagram -->
          <div id="execution-map-diagram" style="background: #1e293b; border-radius: 12px; padding: 24px; color: white;">
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
              <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px; display: block;"></i>
              Loading execution map...
            </div>
          </div>
          
          <!-- Issues Panel -->
          <div id="execution-map-issues" style="margin-top: 20px; display: none;">
            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">
              <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Issues & Recommendations
            </h4>
            <div id="execution-map-issues-list">
            </div>
          </div>
        </div>
        
        <!-- QA DASHBOARD (Category Quality Report) -->
        <div id="data-config-qa-dashboard" class="data-config-content" style="display: none;">
          <div style="margin-bottom: 20px;">
            <h3 style="font-size: 18px; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 8px;">
              <span>ğŸ“Š</span> Category QA Dashboard
            </h3>
            <p style="font-size: 13px; color: #64748b; margin-top: 4px;">
              Quality metrics for all scenarios. Fix the worst first, lock the best.
            </p>
          </div>
          
          <!-- Active Template Display (Auto-detected from company settings) -->
          <div id="qa-active-template-info" style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #10b981; border-radius: 12px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <div>
                <div style="font-size: 11px; color: #065f46; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Working on Company's Active Template</div>
                <div id="qa-template-name" style="font-size: 18px; font-weight: 700; color: #047857; margin-top: 4px;">Loading...</div>
                <div id="qa-template-stats" style="font-size: 12px; color: #059669; margin-top: 2px;">-- categories Â· -- scenarios Â· -- triggers</div>
              </div>
              <button onclick="loadQADashboard()" style="padding: 10px 16px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
            </div>
          </div>
          <!-- Hidden select for backwards compatibility -->
          <select id="qa-template-select" style="display: none;">
            <option value="">Loading...</option>
          </select>
            <button onclick="runGoldenAutofillDryRun()" class="btn btn-primary" style="padding: 8px 16px;">
              <i class="fas fa-magic"></i> Golden Autofill (Dry Run)
            </button>
          </div>
          
          <!-- Summary Cards -->
          <div id="qa-summary" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px;">
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 12px; padding: 20px; color: white;">
              <div style="font-size: 32px; font-weight: 700;" id="qa-total-scenarios">--</div>
              <div style="font-size: 13px; opacity: 0.9;">Total Scenarios</div>
            </div>
            <div style="background: linear-gradient(135deg, #22c55e 0%, #15803d 100%); border-radius: 12px; padding: 20px; color: white;">
              <div style="font-size: 32px; font-weight: 700;" id="qa-avg-score">--</div>
              <div style="font-size: 13px; opacity: 0.9;">Avg Quality Score</div>
            </div>
            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; padding: 20px; color: white;">
              <div style="font-size: 32px; font-weight: 700;" id="qa-needs-work">--</div>
              <div style="font-size: 13px; opacity: 0.9;">Needs Work</div>
            </div>
            <div style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border-radius: 12px; padding: 20px; color: white;">
              <div style="font-size: 32px; font-weight: 700;" id="qa-locked">--</div>
              <div style="font-size: 13px; opacity: 0.9;">Locked (Tuned)</div>
            </div>
            <div style="background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); border-radius: 12px; padding: 20px; color: white;">
              <div style="font-size: 32px; font-weight: 700;" id="qa-categories">--</div>
              <div style="font-size: 13px; opacity: 0.9;">Categories</div>
            </div>
          </div>
          
          <!-- Grade Distribution -->
          <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
            <h4 style="font-size: 14px; font-weight: 600; margin: 0 0 16px 0; color: #334155;">Grade Distribution</h4>
            <div id="qa-grades" style="display: flex; gap: 12px;">
              <div style="flex: 1; text-align: center; padding: 12px; background: #dcfce7; border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: #15803d;" id="qa-grade-a">0</div>
                <div style="font-size: 12px; color: #166534;">Grade A</div>
              </div>
              <div style="flex: 1; text-align: center; padding: 12px; background: #d1fae5; border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: #059669;" id="qa-grade-b">0</div>
                <div style="font-size: 12px; color: #047857;">Grade B</div>
              </div>
              <div style="flex: 1; text-align: center; padding: 12px; background: #fef3c7; border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: #d97706;" id="qa-grade-c">0</div>
                <div style="font-size: 12px; color: #b45309;">Grade C</div>
              </div>
              <div style="flex: 1; text-align: center; padding: 12px; background: #fed7aa; border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: #ea580c;" id="qa-grade-d">0</div>
                <div style="font-size: 12px; color: #c2410c;">Grade D</div>
              </div>
              <div style="flex: 1; text-align: center; padding: 12px; background: #fecaca; border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: #dc2626;" id="qa-grade-f">0</div>
                <div style="font-size: 12px; color: #b91c1c;">Grade F</div>
              </div>
            </div>
          </div>
          
          <!-- Fix Queue (Priority) -->
          <div style="margin-bottom: 24px;">
            <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 16px 0; color: #334155;">
              <i class="fas fa-wrench" style="color: #f59e0b;"></i> Fix Queue (Worst First)
            </h4>
            <div id="qa-fix-queue" style="display: grid; gap: 12px;">
              <div style="text-align: center; padding: 40px; color: #94a3b8;">
                <i class="fas fa-spinner fa-spin"></i> Loading scenarios...
              </div>
            </div>
          </div>
          
          <!-- Category List with Expandable Scenarios -->
          <div style="margin-bottom: 24px;">
            <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 16px 0; color: #334155;">
              <i class="fas fa-folder-open" style="color: #3b82f6;"></i> All Categories
            </h4>
            <div id="qa-categories-list" style="display: grid; gap: 12px;">
              <div style="text-align: center; padding: 40px; color: #94a3b8;">
                <i class="fas fa-spinner fa-spin"></i> Loading categories...
              </div>
            </div>
          </div>
          
          <!-- Minimum Requirements Reference -->
          <div style="background: #f1f5f9; border-radius: 12px; padding: 16px; margin-top: 20px;">
            <h5 style="font-size: 14px; font-weight: 600; margin: 0 0 12px 0; color: #334155;">
              <i class="fas fa-info-circle" style="color: #3b82f6;"></i> Golden Minimum Requirements
            </h5>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; font-size: 13px;">
              <div><strong>Triggers:</strong> â‰¥8</div>
              <div><strong>Negatives:</strong> â‰¥3</div>
              <div><strong>Quick Replies:</strong> â‰¥7</div>
              <div><strong>Full Replies:</strong> â‰¥3</div>
            </div>
          </div>
        </div>
        
        </div>
      </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         CALL PROTECTION (formerly Edge Cases)
         Pre-DFLOW filters: Spam, IVR, Machine, Silence, Abuse
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel" data-panel="call-protection">
        <div class="card">
        <h2>ğŸ›¡ï¸ Call Protection</h2>
        <p class="muted">Pre-answer filters that execute BEFORE Dynamic Flow. Cannot route â€” only short-circuit or pass forward.</p>
        <div id="call-protection-container">
          <!-- CheatSheetManager will render Edge Cases here -->
          <div id="cheatsheet-subtab-edge-cases">
            <div id="edge-cases-section" class="bg-white rounded-lg p-6">
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                <div>
                  <h4 style="font-size: 16px; font-weight: 600; color: #111827; margin:0;">
                    <i class="fas fa-exclamation-triangle" style="margin-right:6px; color:#f59e0b;"></i>Edge Cases
                  </h4>
                  <p style="font-size: 12px; color:#6b7280; margin-top:4px;">
                    Edge cases short-circuit everything else. Use for spam, IVR detection, wrong number, etc.
                  </p>
          </div>
                <button type="button" data-cheatsheet-action="add-edge-case" style="padding:8px 14px; border-radius:8px; border:none; background:#f59e0b; color:#fff; font-size:13px; font-weight:600; display:flex; align-items:center; gap:6px;">
                  <i class="fas fa-plus"></i>Add Edge Case
                </button>
              </div>
              <div id="edge-cases-list" style="display:flex; flex-direction:column; gap:12px;">
                <div class="loading-container">
                  <i class="fas fa-shield-alt fa-spin"></i>
                  <p>Loading Call Protection Settings...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TRANSFER CALLS - Transfer Target Directory
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel" data-panel="transfer-calls">
        <div class="card">
        <h2>ğŸ“ Transfer Calls</h2>
        <p class="muted">Transfer target directory. DFLOW references transferTargetId. Defines destination, availability, and pre-transfer script.</p>
        <div id="transfer-calls-container">
          <!-- CheatSheetManager will render Transfer Rules here -->
          <div id="cheatsheet-subtab-transfer-calls">
            <div id="transfer-rules-section" class="bg-white rounded-lg p-6">
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                <div>
                  <h4 style="font-size: 16px; font-weight: 600; color: #111827; margin:0;">
                    <i class="fas fa-phone" style="margin-right:6px; color:#2563eb;"></i>Transfer Rules
                  </h4>
                  <p style="font-size: 12px; color:#6b7280; margin-top:4px;">
                    Transfer rules route calls to specific departments or people based on intent.
                  </p>
          </div>
                <button type="button" data-cheatsheet-action="add-transfer-rule" style="padding:8px 14px; border-radius:8px; border:none; background:#2563eb; color:#fff; font-size:13px; font-weight:600; display:flex; align-items:center; gap:6px;">
                  <i class="fas fa-plus"></i>Add Transfer Rule
                </button>
              </div>
              <div id="transfer-rules-list" style="display:flex; flex-direction:column; gap:12px;">
                <div class="loading-container">
                  <i class="fas fa-phone-alt fa-spin"></i>
                  <p>Loading Transfer Directory...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         COMPANY CONTACTS - Directory of humans for escalation
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel" data-panel="company-contacts">
        <div class="card">
        <h2>ğŸ“‹ Company Contacts</h2>
        <p class="muted">Directory of humans AI can escalate or notify. Used by transfers, escalations, and notifications.</p>
        <div id="company-contacts-container">
          <!-- CheatSheetManager will render Company Contacts here -->
          <div id="cheatsheet-v2-dynamic-content" data-section="company-contacts" style="background: #fff; border-radius: 12px; min-height: 200px;">
            <div class="loading-container">
              <i class="fas fa-address-book fa-spin"></i>
              <p>Loading Company Contacts...</p>
            </div>
          </div>
          </div>
        </div>
      </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         LINKS - Outbound customer delivery
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel" data-panel="links">
        <div class="card">
        <h2>ğŸ”— Links</h2>
        <p class="muted">Outbound customer delivery: payments, forms, financing. DFLOW actions may reference linkId.</p>
        <div id="links-container">
          <!-- CheatSheetManager will render Links here -->
          <div id="cheatsheet-v2-links-content" data-section="links" style="background: #fff; border-radius: 12px; min-height: 200px;">
            <div class="loading-container">
              <i class="fas fa-link fa-spin"></i>
              <p>Loading Links...</p>
          </div>
          </div>
          </div>
        </div>
      </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         VERSION HISTORY - Front Desk Configuration versioning
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel" data-panel="version-history">
        <div class="card">
        <h2>ğŸ“š Version History</h2>
        <p class="muted">Versioning for Front Desk Configuration. Isolate LIVE vs DRAFT safely during calls.</p>
        <div id="version-history-container">
          <!-- CheatSheetManager will render Version History here -->
          <div id="cheatsheet-v2-version-content" data-section="version-history" style="background: #fff; border-radius: 12px; min-height: 200px;">
            <div class="loading-container">
              <i class="fas fa-history fa-spin"></i>
              <p>Loading Version History...</p>
            </div>
          </div>
          </div>
        </div>
      </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         LEGACY (Read-Only + Migration)
         Temporary tab to view old data modules during migration
         DO NOT DELETE DATA until migration is verified complete
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel" data-panel="legacy">
      <div class="card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <span style="font-size: 32px;">ğŸ“¦</span>
          <div>
            <h2 style="margin: 0; color: #92400e;">Legacy Data (Read-Only)</h2>
            <p class="muted" style="color: #a16207;">This tab shows old data that existed before the Control Plane cleanup. Nothing has been deleted.</p>
          </div>
        </div>
        
        <!-- Full Inventory Button -->
        <div style="margin-bottom: 24px;">
          <button onclick="loadFullInventory()" id="btn-load-inventory" class="btn" style="background: #f59e0b; color: white; padding: 14px 24px; font-size: 15px;">
            <i class="fas fa-search"></i> Load Full Inventory (Prove Nothing Lost)
          </button>
          <button onclick="copyInventoryJson()" id="btn-copy-inventory" class="btn btn-secondary" style="margin-left: 12px;">
            <i class="fas fa-copy"></i> Copy JSON
          </button>
      </div>
        
        <!-- Inventory Stats Summary -->
        <div id="inventory-summary" style="display: none; margin-bottom: 24px;">
          <h3 style="font-size: 16px; font-weight: 600; color: #92400e; margin-bottom: 12px;">ğŸ“Š Inventory Summary</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;" id="inventory-stats-grid">
            <!-- Stats will be populated here -->
      </div>
        </div>
        
        <!-- Legacy Sections Accordion -->
        <div id="legacy-sections" style="display: flex; flex-direction: column; gap: 12px;">
          
          <!-- TRIAGE CARDS -->
          <div class="legacy-section" style="background: white; border-radius: 12px; overflow: hidden;">
            <button onclick="toggleLegacySection('triage')" style="width: 100%; padding: 16px; background: #f8fafc; border: none; text-align: left; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
              <span style="font-weight: 600; color: #1e293b;"><i class="fas fa-clipboard-list" style="margin-right: 8px; color: #f59e0b;"></i>Triage Cards</span>
              <span id="triage-count" style="background: #e2e8f0; padding: 4px 12px; border-radius: 20px; font-size: 12px;">â€”</span>
            </button>
            <div id="legacy-triage" style="display: none; padding: 16px; max-height: 400px; overflow-y: auto;">
              <pre id="legacy-triage-json" style="background: #0d1117; color: #c9d1d9; padding: 16px; border-radius: 8px; font-size: 11px; overflow-x: auto;">Click "Load Full Inventory" to view</pre>
        </div>
        </div>
          
          <!-- MISSION CONTROL -->
          <div class="legacy-section" style="background: white; border-radius: 12px; overflow: hidden;">
            <button onclick="toggleLegacySection('mission')" style="width: 100%; padding: 16px; background: #f8fafc; border: none; text-align: left; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
              <span style="font-weight: 600; color: #1e293b;"><i class="fas fa-rocket" style="margin-right: 8px; color: #8b5cf6;"></i>Mission Control</span>
              <span id="mission-count" style="background: #e2e8f0; padding: 4px 12px; border-radius: 20px; font-size: 12px;">â€”</span>
            </button>
            <div id="legacy-mission" style="display: none; padding: 16px; max-height: 400px; overflow-y: auto;">
              <pre id="legacy-mission-json" style="background: #0d1117; color: #c9d1d9; padding: 16px; border-radius: 8px; font-size: 11px; overflow-x: auto;">Click "Load Full Inventory" to view</pre>
        </div>
        </div>
          
          <!-- BEHAVIOR RULES -->
          <div class="legacy-section" style="background: white; border-radius: 12px; overflow: hidden;">
            <button onclick="toggleLegacySection('behavior')" style="width: 100%; padding: 16px; background: #f8fafc; border: none; text-align: left; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
              <span style="font-weight: 600; color: #1e293b;"><i class="fas fa-sliders-h" style="margin-right: 8px; color: #3b82f6;"></i>Behavior Rules</span>
              <span id="behavior-count" style="background: #e2e8f0; padding: 4px 12px; border-radius: 20px; font-size: 12px;">â€”</span>
            </button>
            <div id="legacy-behavior" style="display: none; padding: 16px; max-height: 400px; overflow-y: auto;">
              <pre id="legacy-behavior-json" style="background: #0d1117; color: #c9d1d9; padding: 16px; border-radius: 8px; font-size: 11px; overflow-x: auto;">Click "Load Full Inventory" to view</pre>
    </div>
  </div>

          <!-- GUARDRAILS -->
          <div class="legacy-section" style="background: white; border-radius: 12px; overflow: hidden;">
            <button onclick="toggleLegacySection('guardrails')" style="width: 100%; padding: 16px; background: #f8fafc; border: none; text-align: left; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
              <span style="font-weight: 600; color: #1e293b;"><i class="fas fa-shield-alt" style="margin-right: 8px; color: #10b981;"></i>Guardrails</span>
              <span id="guardrails-count" style="background: #e2e8f0; padding: 4px 12px; border-radius: 20px; font-size: 12px;">â€”</span>
            </button>
            <div id="legacy-guardrails" style="display: none; padding: 16px; max-height: 400px; overflow-y: auto;">
              <pre id="legacy-guardrails-json" style="background: #0d1117; color: #c9d1d9; padding: 16px; border-radius: 8px; font-size: 11px; overflow-x: auto;">Click "Load Full Inventory" to view</pre>
            </div>
          </div>
          
          <!-- LEGACY VARIABLES -->
          <div class="legacy-section" style="background: white; border-radius: 12px; overflow: hidden;">
            <button onclick="toggleLegacySection('variables')" style="width: 100%; padding: 16px; background: #f8fafc; border: none; text-align: left; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
              <span style="font-weight: 600; color: #1e293b;"><i class="fas fa-code" style="margin-right: 8px; color: #06b6d4;"></i>Legacy Variables</span>
              <span id="variables-count" style="background: #e2e8f0; padding: 4px 12px; border-radius: 20px; font-size: 12px;">â€”</span>
            </button>
            <div id="legacy-variables" style="display: none; padding: 16px; max-height: 400px; overflow-y: auto;">
              <pre id="legacy-variables-json" style="background: #0d1117; color: #c9d1d9; padding: 16px; border-radius: 8px; font-size: 11px; overflow-x: auto;">Click "Load Full Inventory" to view</pre>
            </div>
          </div>
          
          <!-- CALCULATORS -->
          <div class="legacy-section" style="background: white; border-radius: 12px; overflow: hidden;">
            <button onclick="toggleLegacySection('calculators')" style="width: 100%; padding: 16px; background: #f8fafc; border: none; text-align: left; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
              <span style="font-weight: 600; color: #1e293b;"><i class="fas fa-calculator" style="margin-right: 8px; color: #ec4899;"></i>Calculators</span>
              <span id="calculators-count" style="background: #e2e8f0; padding: 4px 12px; border-radius: 20px; font-size: 12px;">â€”</span>
            </button>
            <div id="legacy-calculators" style="display: none; padding: 16px; max-height: 400px; overflow-y: auto;">
              <pre id="legacy-calculators-json" style="background: #0d1117; color: #c9d1d9; padding: 16px; border-radius: 8px; font-size: 11px; overflow-x: auto;">Click "Load Full Inventory" to view</pre>
            </div>
          </div>
          
          <!-- BLACK BOX RECORDINGS -->
          <div class="legacy-section" style="background: white; border-radius: 12px; overflow: hidden;">
            <button onclick="toggleLegacySection('blackbox')" style="width: 100%; padding: 16px; background: #f8fafc; border: none; text-align: left; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
              <span style="font-weight: 600; color: #1e293b;"><i class="fas fa-video" style="margin-right: 8px; color: #f97316;"></i>Black Box Recordings</span>
              <span id="blackbox-count" style="background: #e2e8f0; padding: 4px 12px; border-radius: 20px; font-size: 12px;">â€”</span>
            </button>
            <div id="legacy-blackbox" style="display: none; padding: 16px; max-height: 400px; overflow-y: auto;">
              <pre id="legacy-blackbox-json" style="background: #0d1117; color: #c9d1d9; padding: 16px; border-radius: 8px; font-size: 11px; overflow-x: auto;">Click "Load Full Inventory" to view</pre>
            </div>
          </div>
          
        </div>
        
        <!-- Full JSON Display -->
        <div style="margin-top: 24px;">
          <h3 style="font-size: 16px; font-weight: 600; color: #92400e; margin-bottom: 12px;">ğŸ“ Full Inventory JSON</h3>
          <pre id="legacy-full-json" style="background: #0d1117; color: #c9d1d9; padding: 16px; border-radius: 12px; font-size: 11px; max-height: 500px; overflow: auto; white-space: pre-wrap;">
{
  "message": "Click 'Load Full Inventory' to fetch all legacy data",
  "hint": "This proves nothing has been deleted during the cleanup"
}
          </pre>
        </div>
      </div>
    </div>
    
  </main>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       JAVASCRIPT
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GLOBAL STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const currentCompanyId = new URLSearchParams(window.location.search).get('companyId') || null;
    const authToken = localStorage.getItem('adminToken');
    const API_BASE = '';
    
    // Track initialized managers
    const initializedTabs = new Set();
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NAVIGATION FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function goBackToProfile() {
      if (currentCompanyId) {
        window.location.href = `/company-profile.html?id=${currentCompanyId}#ai-agent-settings`;
      } else {
        window.location.href = '/admin-directory.html';
      }
    }

    function openCallCenter() {
      if (!currentCompanyId) {
        alert('No company ID found.');
        return;
      }
      window.open(`/call-center.html?companyId=${currentCompanyId}`, '_blank');
    }
    
    function openBlackBox() {
      if (!currentCompanyId) {
        alert('No company ID found.');
        return;
      }
      window.open(`/black-box.html?companyId=${currentCompanyId}`, '_blank');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LAZY SCRIPT LOADER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const loadedScripts = new Set();
    
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        if (loadedScripts.has(src)) {
          resolve();
          return;
        }
        
        console.log(`ğŸ“¦ [LAZY LOAD] Loading: ${src}`);
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => {
          loadedScripts.add(src);
          console.log(`âœ… [LAZY LOAD] Loaded: ${src}`);
          resolve();
        };
        script.onerror = () => {
          console.error(`âŒ [LAZY LOAD] Failed: ${src}`);
          reject(new Error(`Failed to load: ${src}`));
        };
        document.body.appendChild(script);
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB SWITCHING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function switchTab(tabId) {
      console.log(`ğŸ¯ [NAV] Switching to: ${tabId}`);
      
      // Update nav buttons
      document.querySelectorAll('.nav-tab').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabId);
      });
      
      // Update panels
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.toggle('active', panel.getAttribute('data-panel') === tabId);
      });
      
      // Initialize tab content if not already done
      initializeTab(tabId);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB INITIALIZATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function initializeTab(tabId) {
      if (initializedTabs.has(tabId)) return;
      if (!currentCompanyId) {
        console.error('No companyId provided');
        return;
      }
      
      try {
        switch (tabId) {
          case 'front-desk':
            await initFrontDesk();
            break;
          case 'flow-tree':
            await initFlowTree();
            break;
          case 'dynamic-flow':
            await initDynamicFlow();
            break;
          case 'call-protection':
            await initCallProtection();
            break;
          case 'transfer-calls':
            await initTransferCalls();
            break;
          case 'company-contacts':
            await initCompanyContacts();
            break;
          case 'links':
            await initLinks();
            break;
          case 'version-history':
            await initVersionHistory();
            break;
          case 'data-config':
            await initDataConfig();
            break;
          case 'legacy':
            await initLegacy();
            break;
        }
        initializedTabs.add(tabId);
      } catch (error) {
        console.error(`âŒ [INIT] Failed to initialize ${tabId}:`, error);
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FRONT DESK INITIALIZATION
    // Uses existing FrontDeskBehaviorManager
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function initFrontDesk() {
      console.log('ğŸ¢ [INIT] Initializing Front Desk...');
      await loadScript('/js/ai-agent-settings/FrontDeskBehaviorManager.js');
      
      const container = document.getElementById('front-desk-container');
      if (container && window.FrontDeskBehaviorManager) {
        window.frontDeskManager = new window.FrontDeskBehaviorManager(currentCompanyId);
        await window.frontDeskManager.load();
        window.frontDeskManager.render(container);
        console.log('âœ… [INIT] Front Desk initialized');
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLOW TREE INITIALIZATION
    // Live visualization of AI decision flow + System Snapshot
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function initFlowTree() {
      console.log('ğŸŒ³ [INIT] Initializing Flow Tree...');
      
      // Load company's dynamic flows to populate the tree
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/dynamic-flows`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.flows && data.flows.length > 0) {
            renderFlowTreeNodes(data.flows);
          }
        }
      } catch (error) {
        console.error('Failed to load flows for tree:', error);
      }
      
      // Auto-load system snapshot
      await refreshSystemSnapshot();
      
      console.log('âœ… [INIT] Flow Tree initialized with System Snapshot');
    }
    
    function renderFlowTreeNodes(flows) {
      const container = document.getElementById('dynamic-flows-tree');
      if (!container) return;
      
      // Sort by priority descending
      const sortedFlows = flows.sort((a, b) => (b.priority || 0) - (a.priority || 0));
      
      container.innerHTML = sortedFlows.map(flow => {
        const triggerPhrases = flow.trigger?.phrases?.slice(0, 3).join('", "') || 'No triggers';
        const priority = flow.priority || 0;
        const actions = flow.actions?.map(a => a.type).join(', ') || 'No actions';
        
        // Color based on priority
        let borderColor = '#8b5cf6'; // Default purple
        if (priority >= 200) borderColor = '#dc2626'; // Red for emergency
        else if (priority >= 100) borderColor = '#f97316'; // Orange for high
        else if (priority >= 50) borderColor = '#3b82f6'; // Blue for medium
        
        return `
          <div class="tree-item" style="border-left-color: ${borderColor};">
            <div class="tree-icon">${flow.isActive ? 'âœ…' : 'â¸ï¸'}</div>
            <div class="tree-content">
              <h4>${flow.name || flow.flowKey || 'Unnamed Flow'}</h4>
              <p>Trigger: "${triggerPhrases}"</p>
              <div class="tree-meta">
                <span class="meta-badge ${priority >= 100 ? 'warning' : ''}">Priority: ${priority}</span>
                <span class="meta-badge">â†’ ${actions}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DYNAMIC FLOW INITIALIZATION
    // Renders the Dynamic Flows tab from FrontDeskBehaviorManager
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function initDynamicFlow() {
      console.log('ğŸ”€ [INIT] Initializing Dynamic Flow...');
      
      // Ensure FrontDeskBehaviorManager is loaded
      if (!window.frontDeskManager) {
        await loadScript('/js/ai-agent-settings/FrontDeskBehaviorManager.js');
        window.frontDeskManager = new window.FrontDeskBehaviorManager(currentCompanyId);
        await window.frontDeskManager.load();
      }
      
      const container = document.getElementById('dynamic-flow-container');
      if (container && window.frontDeskManager) {
        // Render just the Dynamic Flows tab content
        container.innerHTML = window.frontDeskManager.renderDynamicFlowsTab();
        window.frontDeskManager.initDynamicFlowsTab(container);
        console.log('âœ… [INIT] Dynamic Flow initialized');
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CALL PROTECTION INITIALIZATION (formerly Edge Cases)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function initCallProtection() {
      console.log('ğŸ›¡ï¸ [INIT] Initializing Call Protection...');
      
      await loadScript('/js/ai-agent-settings/CheatSheetVersioningAdapter.js');
      await loadScript('/js/ai-agent-settings/CheatSheetManager.js');
      
      if (window.cheatSheetManager) {
        if (window.cheatSheetManager.companyId !== currentCompanyId) {
          await window.cheatSheetManager.load(currentCompanyId);
        }
        
        // Attach action handlers for Add Edge Case button
        const container = document.getElementById('call-protection-container');
          if (container) {
          container.addEventListener('click', (e) => {
            const actionBtn = e.target.closest('[data-cheatsheet-action]');
            if (actionBtn && actionBtn.getAttribute('data-cheatsheet-action') === 'add-edge-case') {
              e.preventDefault();
              window.cheatSheetManager.addEdgeCase();
            }
          });
        }
        
        window.cheatSheetManager.renderEdgeCases();
        console.log('âœ… [INIT] Call Protection initialized');
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRANSFER CALLS INITIALIZATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function initTransferCalls() {
      console.log('ğŸ“ [INIT] Initializing Transfer Calls...');
      
      await loadScript('/js/ai-agent-settings/CheatSheetVersioningAdapter.js');
      await loadScript('/js/ai-agent-settings/CheatSheetManager.js');
      
      if (window.cheatSheetManager) {
        if (window.cheatSheetManager.companyId !== currentCompanyId) {
          await window.cheatSheetManager.load(currentCompanyId);
        }
        
        // Attach action handlers for Add Transfer Rule button
        const container = document.getElementById('transfer-calls-container');
          if (container) {
          container.addEventListener('click', (e) => {
            const actionBtn = e.target.closest('[data-cheatsheet-action]');
            if (actionBtn && actionBtn.getAttribute('data-cheatsheet-action') === 'add-transfer-rule') {
              e.preventDefault();
              window.cheatSheetManager.addTransferRule();
            }
          });
        }
        
        window.cheatSheetManager.renderTransferRules();
        console.log('âœ… [INIT] Transfer Calls initialized');
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMPANY CONTACTS INITIALIZATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function initCompanyContacts() {
      console.log('ğŸ“‹ [INIT] Initializing Company Contacts...');
      
      await loadScript('/js/ai-agent-settings/CheatSheetVersioningAdapter.js');
      await loadScript('/js/ai-agent-settings/CheatSheetManager.js');
      
      if (window.cheatSheetManager) {
        if (window.cheatSheetManager.companyId !== currentCompanyId) {
          await window.cheatSheetManager.load(currentCompanyId);
        }
        
        // renderCompanyContacts expects #cheatsheet-v2-dynamic-content
        window.cheatSheetManager.renderCompanyContacts();
        console.log('âœ… [INIT] Company Contacts initialized');
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LINKS INITIALIZATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function initLinks() {
      console.log('ğŸ”— [INIT] Initializing Links...');
      
      await loadScript('/js/ai-agent-settings/CheatSheetVersioningAdapter.js');
      await loadScript('/js/ai-agent-settings/CheatSheetManager.js');
      
      if (window.cheatSheetManager) {
        if (window.cheatSheetManager.companyId !== currentCompanyId) {
          await window.cheatSheetManager.load(currentCompanyId);
        }
        
        // Links needs its own container - update cheatSheetManager to render there
        const linksContainer = document.getElementById('cheatsheet-v2-links-content');
        if (linksContainer) {
          // Temporarily override the container lookup for links
          window.cheatSheetManager.renderLinksToContainer(linksContainer);
        }
        console.log('âœ… [INIT] Links initialized');
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VERSION HISTORY INITIALIZATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function initVersionHistory() {
      console.log('ğŸ“š [INIT] Initializing Version History...');
      
      await loadScript('/js/ai-agent-settings/CheatSheetVersioningAdapter.js');
      await loadScript('/js/ai-agent-settings/CheatSheetManager.js');
      
      if (window.cheatSheetManager) {
        if (window.cheatSheetManager.companyId !== currentCompanyId) {
          await window.cheatSheetManager.load(currentCompanyId);
        }
        
        // Version history needs its own container
        const versionContainer = document.getElementById('cheatsheet-v2-version-content');
        if (versionContainer) {
          window.cheatSheetManager.renderVersionHistoryToContainer(versionContainer);
        }
        console.log('âœ… [INIT] Version History initialized');
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DATA & CONFIG INITIALIZATION
    // Placeholders (V2), Templates, Scenarios
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentPlaceholders = {};
    
    // Store references to the original managers
    let aiCoreTemplatesManager = null;
    let aiCoreLiveScenariosManager = null;
    
    async function initDataConfig() {
      console.log('ğŸ“‚ [INIT] Initializing Data & Config...');
      
      // Load the ORIGINAL manager scripts
      await loadScript('/js/ai-agent-settings/AiCoreTemplatesManager.js');
      await loadScript('/js/ai-agent-settings/AiCoreLiveScenariosManager.js');
      
      // Set up sub-tab switching
      document.querySelectorAll('.data-config-subtab').forEach(btn => {
        btn.addEventListener('click', () => {
          const subtab = btn.getAttribute('data-subtab');
          switchDataConfigSubtab(subtab);
      });
    });

      // Load placeholders by default
      await loadPlaceholders();
      
      console.log('âœ… [INIT] Data & Config initialized');
    }
    
    async function switchDataConfigSubtab(subtab) {
      // Update subtab buttons
      document.querySelectorAll('.data-config-subtab').forEach(btn => {
        const isActive = btn.getAttribute('data-subtab') === subtab;
        btn.style.background = isActive ? '#3b82f6' : '#f1f5f9';
        btn.style.color = isActive ? 'white' : '#64748b';
        btn.classList.toggle('active', isActive);
      });
      
      // Update content panels
      document.querySelectorAll('.data-config-content').forEach(panel => {
        panel.style.display = 'none';
      });
      
      const activePanel = document.getElementById(`data-config-${subtab}`);
      if (activePanel) {
        activePanel.style.display = 'block';
      }
      
      // Load content for the subtab using ORIGINAL managers
      if (subtab === 'placeholders') {
        loadPlaceholders();
      } else if (subtab === 'defaults') {
        await loadCompanyDefaults();
      } else if (subtab === 'templates') {
        await loadTemplatesWithOriginalManager();
      } else if (subtab === 'scenarios') {
        await loadScenariosWithOriginalManager();
      } else if (subtab === 'execution-map') {
        await loadExecutionMap();
      } else if (subtab === 'qa-dashboard') {
        await initQADashboard();
      }
    }
    
    async function loadTemplatesWithOriginalManager() {
      console.log('ğŸ“„ [TEMPLATES] Using AiCoreTemplatesManager...');
      
      if (!window.AiCoreTemplatesManager) {
        console.error('AiCoreTemplatesManager not loaded!');
          return;
        }

      // Create a minimal parent object that the manager expects
      const parentManager = {
        companyId: currentCompanyId
      };
      
      if (!aiCoreTemplatesManager) {
        aiCoreTemplatesManager = new window.AiCoreTemplatesManager(parentManager);
      }
      
      await aiCoreTemplatesManager.load();
    }
    
    async function loadScenariosWithOriginalManager() {
      console.log('ğŸ­ [SCENARIOS] Using AiCoreLiveScenariosManager...');
      
      if (!window.AiCoreLiveScenariosManager) {
        console.error('AiCoreLiveScenariosManager not loaded!');
        return;
      }
      
      // Create a minimal parent object that the manager expects
      const parentManager = {
        companyId: currentCompanyId
      };
      
      if (!aiCoreLiveScenariosManager) {
        aiCoreLiveScenariosManager = new window.AiCoreLiveScenariosManager(parentManager);
      }
      
      await aiCoreLiveScenariosManager.load();
    }
    
    
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EXECUTION MAP
    // Call flow visualization
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentExecutionMap = null;
    
    async function loadExecutionMap() {
      console.log('ğŸ—ºï¸ [EXECUTION MAP] Loading execution map...');
      await refreshExecutionMap();
    }
    
    async function refreshExecutionMap() {
      const diagramDiv = document.getElementById('execution-map-diagram');
      const healthDiv = document.getElementById('execution-map-health');
      const issuesDiv = document.getElementById('execution-map-issues');
      
      diagramDiv.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #94a3b8;">
          <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px; display: block;"></i>
          Loading execution map...
        </div>
      `;
      
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/execution-map`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const executionMap = await response.json();
        
        if (!executionMap.success) {
          diagramDiv.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #f87171;">
              <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
              <p>Failed to load execution map: ${executionMap.error || 'Unknown error'}</p>
            </div>
          `;
          return;
        }
        
        currentExecutionMap = executionMap;
        renderExecutionMap(executionMap);
        
      } catch (error) {
        console.error('[EXECUTION MAP] Error:', error);
        diagramDiv.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #f87171;">
            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
            <p>Error: ${error.message}</p>
          </div>
        `;
      }
    }
    
    function renderExecutionMap(executionMap) {
      // Update health badge
      const healthBadge = document.getElementById('execution-map-health-badge');
      const healthTitle = document.getElementById('execution-map-health-title');
      const healthMessage = document.getElementById('execution-map-health-message');
      
      const healthColors = {
        GREEN: { bg: '#22c55e', icon: 'check' },
        YELLOW: { bg: '#f59e0b', icon: 'exclamation' },
        RED: { bg: '#ef4444', icon: 'times' }
      };
      
      const healthConfig = healthColors[executionMap.health.status] || healthColors.YELLOW;
      healthBadge.style.background = healthConfig.bg;
      healthBadge.innerHTML = `<i class="fas fa-${healthConfig.icon}" style="color: white; font-size: 20px;"></i>`;
      healthTitle.textContent = `${executionMap.health.status} - ${executionMap.summary.coverage} Coverage`;
      healthMessage.textContent = executionMap.health.message;
      
      // Render flow diagram
      const diagramDiv = document.getElementById('execution-map-diagram');
      let stagesHtml = '';
      
      for (const stage of executionMap.stages) {
        const statusColors = {
          active: '#22c55e',
          warning: '#f59e0b',
          error: '#ef4444',
          disabled: '#64748b',
          unknown: '#94a3b8'
        };
        
        const statusColor = statusColors[stage.status] || statusColors.unknown;
        
        stagesHtml += `
          <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;">
            <div style="min-width: 48px; height: 48px; border-radius: 12px; background: ${statusColor}; display: flex; align-items: center; justify-content: center; font-size: 24px;">
              ${stage.icon}
            </div>
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <h5 style="margin: 0; font-size: 16px; font-weight: 600;">${stage.name}</h5>
                <span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: ${statusColor}; color: white; text-transform: uppercase;">
                  ${stage.status}
                </span>
              </div>
              <p style="margin: 0 0 8px 0; font-size: 13px; color: #94a3b8;">${stage.description}</p>
              ${stage.actions?.length > 0 ? `
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                  ${stage.actions.slice(0, 3).map(a => `
                    <span style="background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 4px; font-size: 11px; color: #cbd5e1;">
                      ${a.trigger} â†’ ${a.action}
                    </span>
                  `).join('')}
                </div>
              ` : ''}
              ${stage.warnings?.length > 0 ? `
                <div style="margin-top: 8px;">
                  ${stage.warnings.map(w => `
                    <div style="font-size: 12px; color: #fbbf24; display: flex; align-items: center; gap: 6px;">
                      <i class="fas fa-exclamation-triangle"></i> ${w}
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          </div>
          ${stage.order < executionMap.stages.length ? `
            <div style="margin-left: 24px; height: 20px; border-left: 2px dashed #475569;"></div>
          ` : ''}
        `;
      }
      
      diagramDiv.innerHTML = stagesHtml;
      
      // Render issues
      const issuesDiv = document.getElementById('execution-map-issues');
      const issuesList = document.getElementById('execution-map-issues-list');
      
      const allIssues = [
        ...executionMap.issues.critical.map(i => ({ ...i, severity: 'critical' })),
        ...executionMap.issues.warnings.map(i => ({ ...i, severity: 'warning' })),
        ...executionMap.issues.info.map(i => ({ ...i, severity: 'info' }))
      ];
      
      if (allIssues.length > 0) {
        issuesDiv.style.display = 'block';
        issuesList.innerHTML = allIssues.map(issue => `
          <div style="background: ${issue.severity === 'critical' ? '#fef2f2' : issue.severity === 'warning' ? '#fffbeb' : '#f0f9ff'}; 
                      border: 1px solid ${issue.severity === 'critical' ? '#ef4444' : issue.severity === 'warning' ? '#f59e0b' : '#0ea5e9'}; 
                      border-radius: 8px; padding: 12px; margin-bottom: 8px;">
            <div style="font-weight: 600; color: ${issue.severity === 'critical' ? '#991b1b' : issue.severity === 'warning' ? '#92400e' : '#0369a1'};">
              ${issue.severity === 'critical' ? 'ğŸ”´' : issue.severity === 'warning' ? 'ğŸŸ¡' : 'ğŸ”µ'} 
              ${issue.stage}: ${issue.message}
            </div>
            ${issue.recommendation ? `
              <div style="font-size: 13px; color: #64748b; margin-top: 4px;">
                ğŸ’¡ ${issue.recommendation}
              </div>
            ` : ''}
          </div>
        `).join('');
      } else {
        issuesDiv.style.display = 'none';
      }
    }
    
    function exportExecutionMap() {
      if (!currentExecutionMap) {
        showSnapshotToast('No execution map loaded', 'warning');
        return;
      }
      
      const jsonStr = JSON.stringify(currentExecutionMap, null, 2);
      navigator.clipboard.writeText(jsonStr).then(() => {
        showSnapshotToast(`Execution map copied (${jsonStr.length} bytes)`, 'success');
      });
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // QA DASHBOARD
    // Category Quality Report + Golden Autofill
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentQAReport = null;
    let qaSelectedTemplateId = null;
    
    async function initQADashboard() {
      console.log('ğŸ“Š [QA DASHBOARD] Initializing - Auto-detecting company active template...');
      
      const select = document.getElementById('qa-template-select');
      const nameEl = document.getElementById('qa-template-name');
      const statsEl = document.getElementById('qa-template-stats');
      const infoBox = document.getElementById('qa-active-template-info');
      
      try {
        // Use the SAME endpoint as Templates tab - /configuration/templates
        // This ensures consistency with what the Templates UI shows
        const response = await fetch(`/api/company/${currentCompanyId}/configuration/templates`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const templates = await response.json();
        
        console.log('[QA DASHBOARD] Active templates from configuration/templates:', templates);
        
        if (!templates || templates.length === 0) {
          nameEl.textContent = 'No template selected';
          statsEl.textContent = 'Go to Templates tab to activate a template';
          infoBox.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
          infoBox.style.borderColor = '#f59e0b';
          nameEl.style.color = '#92400e';
          return;
        }
        
        // Use the first (primary) active template - sort by priority
        const sortedTemplates = templates.sort((a, b) => (a.priority || 99) - (b.priority || 99));
        const primaryTemplate = sortedTemplates[0];
        const templateId = primaryTemplate.templateId || primaryTemplate._id;
        
        // Update hidden select for backwards compatibility
        select.innerHTML = `<option value="${templateId}" selected>${primaryTemplate.name}</option>`;
        select.value = templateId;
        
        // Update display
        nameEl.textContent = primaryTemplate.name;
        const stats = primaryTemplate.stats || {};
        statsEl.textContent = `${stats.categories || 0} categories Â· ${stats.scenarios || 0} scenarios Â· ${stats.triggers || 0} triggers`;
        
        // Set qaSelectedTemplateId for other functions
        qaSelectedTemplateId = templateId;
        
        console.log(`[QA DASHBOARD] Auto-selected primary template: ${primaryTemplate.name} (${templateId})`);
        
        // Now load the QA Dashboard for this template
        await loadQADashboard();
        
      } catch (error) {
        console.error('[QA DASHBOARD] Init error:', error);
        nameEl.textContent = 'Error loading template';
        statsEl.textContent = error.message;
        infoBox.style.background = 'linear-gradient(135deg, #fef2f2 0%, #fecaca 100%)';
        infoBox.style.borderColor = '#ef4444';
        nameEl.style.color = '#991b1b';
      }
    }
    
    async function loadQADashboard() {
      const templateId = document.getElementById('qa-template-select').value;
      
      if (!templateId) {
        console.log('[QA DASHBOARD] No template selected');
        return;
      }
      
      qaSelectedTemplateId = templateId;
      console.log(`ğŸ“Š [QA DASHBOARD] Loading quality report for template ${templateId}`);
      
      try {
        const response = await fetch(`/api/trade-knowledge/templates/${templateId}/quality-report`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        currentQAReport = data;
        
        renderQADashboard(data);
        
      } catch (error) {
        console.error('[QA DASHBOARD] Error:', error);
        showSnapshotToast('Failed to load quality report', 'error');
      }
    }
    
    function renderQADashboard(report) {
      // Summary cards
      document.getElementById('qa-total-scenarios').textContent = report.summary.totalScenarios;
      document.getElementById('qa-avg-score').textContent = report.summary.averageScore + '%';
      document.getElementById('qa-needs-work').textContent = report.summary.scenariosNeedingWork;
      document.getElementById('qa-locked').textContent = report.summary.lockedScenarios;
      document.getElementById('qa-categories').textContent = report.summary.totalCategories;
      
      // Grades
      const byGrade = report.categories.reduce((acc, cat) => {
        cat.scenarios.forEach(s => {
          acc[s.quality.grade] = (acc[s.quality.grade] || 0) + 1;
        });
        return acc;
      }, { A: 0, B: 0, C: 0, D: 0, F: 0 });
      
      document.getElementById('qa-grade-a').textContent = byGrade.A || 0;
      document.getElementById('qa-grade-b').textContent = byGrade.B || 0;
      document.getElementById('qa-grade-c').textContent = byGrade.C || 0;
      document.getElementById('qa-grade-d').textContent = byGrade.D || 0;
      document.getElementById('qa-grade-f').textContent = byGrade.F || 0;
      
      // Fix Queue
      const fixQueueDiv = document.getElementById('qa-fix-queue');
      if (report.fixQueue.length === 0) {
        fixQueueDiv.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #22c55e; background: #dcfce7; border-radius: 8px;">
            <i class="fas fa-check-circle" style="font-size: 24px;"></i>
            <p style="margin: 8px 0 0 0; font-weight: 600;">All categories meet quality standards!</p>
          </div>
        `;
      } else {
        fixQueueDiv.innerHTML = report.fixQueue.slice(0, 5).map((cat, i) => `
          <div style="background: ${cat.grade === 'F' ? '#fef2f2' : '#fffbeb'}; border: 1px solid ${cat.grade === 'F' ? '#fecaca' : '#fed7aa'}; border-radius: 8px; padding: 16px; display: flex; align-items: center; gap: 16px;">
            <div style="width: 40px; height: 40px; background: ${cat.grade === 'F' ? '#dc2626' : '#f59e0b'}; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px;">
              ${i + 1}
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #1e293b;">${cat.categoryName}</div>
              <div style="font-size: 13px; color: #64748b;">
                Grade ${cat.grade} â€¢ Score ${cat.averageScore}% â€¢ ${cat.scenariosToFix} scenario(s) need work
              </div>
            </div>
            <button onclick="expandCategory('${cat.categoryId}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
              <i class="fas fa-eye"></i> View
            </button>
          </div>
        `).join('');
      }
      
      // Categories list
      const categoriesDiv = document.getElementById('qa-categories-list');
      categoriesDiv.innerHTML = report.categories.map(cat => `
        <div class="qa-category-card" data-category-id="${cat.categoryId}" style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
          <div onclick="toggleCategoryExpand('${cat.categoryId}')" style="padding: 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; background: ${cat.grade === 'A' || cat.grade === 'B' ? '#f0fdf4' : cat.grade === 'C' ? '#fefce8' : '#fef2f2'};">
            <div style="width: 40px; height: 40px; background: ${getGradeColor(cat.grade)}; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
              ${cat.grade}
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #1e293b;">${cat.categoryName}</div>
              <div style="font-size: 13px; color: #64748b;">
                ${cat.scenarioCount} scenarios â€¢ Score ${cat.averageScore}% â€¢ ${cat.needsWorkCount} need work â€¢ ${cat.lockedCount} locked
              </div>
            </div>
            <i class="fas fa-chevron-down qa-expand-icon" style="color: #94a3b8; transition: transform 0.2s;"></i>
          </div>
          <div class="qa-category-scenarios" style="display: none; border-top: 1px solid #e2e8f0; padding: 16px; background: #f8fafc;">
            ${cat.scenarios.map(s => renderScenarioRow(s, cat.categoryId)).join('')}
          </div>
        </div>
      `).join('');
    }
    
    function renderScenarioRow(scenario, categoryId) {
      const gradeColor = getGradeColor(scenario.quality.grade);
      const issues = scenario.quality.issues || [];
      
      return `
        <div style="padding: 12px; margin-bottom: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; display: flex; align-items: flex-start; gap: 12px;">
          <div style="min-width: 32px; height: 32px; background: ${gradeColor}; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
            ${scenario.quality.grade}
          </div>
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
              <span style="font-weight: 600; color: #1e293b;">${scenario.name}</span>
              ${scenario.isLocked ? '<span style="background: #dbeafe; color: #1d4ed8; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">ğŸ”’ LOCKED</span>' : ''}
              <span style="background: ${getTypeColor(scenario.scenarioType)}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${scenario.scenarioType}</span>
            </div>
            <div style="font-size: 12px; color: #64748b; display: flex; gap: 16px; flex-wrap: wrap;">
              <span>ğŸ“ ${scenario.counts.triggerCount} triggers</span>
              <span>ğŸš« ${scenario.counts.negativeCount} negatives</span>
              <span>âš¡ ${scenario.counts.quickCount} quick</span>
              <span>ğŸ“„ ${scenario.counts.fullCount} full</span>
              <span>ğŸ¯ P${scenario.priority}</span>
              <span>ğŸ“Š ${(scenario.minConfidence * 100).toFixed(0)}%</span>
            </div>
            ${issues.length > 0 ? `
              <div style="margin-top: 8px; padding: 8px; background: #fef3c7; border-radius: 6px;">
                <span style="font-size: 12px; color: #92400e; font-weight: 600;">Issues:</span>
                <span style="font-size: 12px; color: #92400e;">${issues.join(' â€¢ ')}</span>
              </div>
            ` : ''}
          </div>
          <div style="display: flex; flex-direction: column; gap: 4px;">
            <button onclick="openScenarioInBrowser('${scenario.scenarioId}', '${categoryId}')" 
                    style="padding: 4px 8px; border: none; background: #dbeafe; color: #1d4ed8; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
              âœï¸ Edit
            </button>
            <button onclick="toggleScenarioLock('${scenario.scenarioId}', ${!scenario.isLocked})" 
                    style="padding: 4px 8px; border: none; background: ${scenario.isLocked ? '#fee2e2' : '#e0f2fe'}; color: ${scenario.isLocked ? '#dc2626' : '#0369a1'}; border-radius: 4px; cursor: pointer; font-size: 11px;">
              ${scenario.isLocked ? 'ğŸ”“ Unlock' : 'ğŸ”’ Lock'}
            </button>
          </div>
        </div>
      `;
    }
    
    function getGradeColor(grade) {
      const colors = { A: '#22c55e', B: '#84cc16', C: '#eab308', D: '#f97316', F: '#ef4444' };
      return colors[grade] || '#94a3b8';
    }
    
    function getTypeColor(type) {
      const colors = {
        EMERGENCY: '#dc2626',
        BOOKING: '#2563eb',
        FAQ: '#7c3aed',
        SMALL_TALK: '#64748b',
        SYSTEM: '#0891b2',
        TRANSFER: '#ea580c',
        UNKNOWN: '#9ca3af'
      };
      return colors[type] || '#9ca3af';
    }
    
    function toggleCategoryExpand(categoryId) {
      const card = document.querySelector(`.qa-category-card[data-category-id="${categoryId}"]`);
      if (!card) return;
      
      const scenariosDiv = card.querySelector('.qa-category-scenarios');
      const icon = card.querySelector('.qa-expand-icon');
      
      if (scenariosDiv.style.display === 'none') {
        scenariosDiv.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
      } else {
        scenariosDiv.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }
    
    function expandCategory(categoryId) {
      // Expand this category and scroll to it
      const cards = document.querySelectorAll('.qa-category-card');
      cards.forEach(card => {
        const scenarios = card.querySelector('.qa-category-scenarios');
        const icon = card.querySelector('.qa-expand-icon');
        if (card.dataset.categoryId === categoryId) {
          scenarios.style.display = 'block';
          icon.style.transform = 'rotate(180deg)';
          card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
          scenarios.style.display = 'none';
          icon.style.transform = 'rotate(0deg)';
        }
      });
    }
    
    async function openScenarioInBrowser(scenarioId, categoryId) {
      console.log('[QA DASHBOARD] Opening scenario in browser:', { scenarioId, categoryId });
      
      // Open the Scenario Browser modal
      await openScenarioBrowserModal();
      
      // Wait a moment for data to load, then select the category and scenario
      setTimeout(() => {
        // First select the category to expand it
        selectCategory(categoryId);
        
        // Then select the specific scenario
        setTimeout(() => {
          selectScenario(scenarioId, categoryId);
          
          // Scroll the scenario into view in the left panel
          const scenarioEl = document.querySelector(`.sb-scenario-item[data-scenario-id="${scenarioId}"]`);
          if (scenarioEl) {
            scenarioEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 300);
      }, 500);
    }
    
    async function toggleScenarioLock(scenarioId, lock) {
      if (!qaSelectedTemplateId) return;
      
      try {
        const response = await fetch(`/api/trade-knowledge/templates/${qaSelectedTemplateId}/scenarios/${scenarioId}/lock`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ locked: lock })
        });
        
        if (response.ok) {
          showSnapshotToast(lock ? 'Scenario locked (protected from autofill)' : 'Scenario unlocked', 'success');
          await loadQADashboard(); // Refresh
        } else {
          throw new Error('Failed to update lock');
        }
      } catch (error) {
        showSnapshotToast('Failed to update scenario lock', 'error');
      }
    }
    
    async function runGoldenAutofill() {
      // Find the active template ID for this company
      if (!qaSelectedTemplateId && currentCompanyId) {
        // Try to detect active template
        try {
          const response = await fetch(`/api/company/${currentCompanyId}/configuration/templates`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          const data = await response.json();
          if (data.success && data.activeTemplates?.length > 0) {
            qaSelectedTemplateId = data.activeTemplates[0].templateId;
          }
        } catch (e) {
          console.log('Could not auto-detect template');
        }
      }
      
      if (!qaSelectedTemplateId) {
        showSnapshotToast('No Template', 'Go to Data & Config tab to see active template', 'warning');
        return;
      }
      
      // Show confirmation
      if (!confirm('Run Golden Autofill to classify all scenarios?\\n\\nThis will:\\n- Auto-detect scenarioType (BOOKING, FAQ, EMERGENCY, etc.)\\n- Set priority and minConfidence based on type\\n- Respect locked scenarios (autofillLock=true)\\n\\nContinue?')) {
        return;
      }
      
      showSnapshotToast('Running...', 'Classifying scenarios...', 'info');
      
      try {
        // First do dry run to show preview
        const dryRunResponse = await fetch(`/api/trade-knowledge/templates/${qaSelectedTemplateId}/golden-autofill`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ mode: 'dry_run' })
        });
        
        const dryRunData = await dryRunResponse.json();
        
        if (!dryRunData.success) {
          throw new Error(dryRunData.error || 'Dry run failed');
        }
        
        // Show preview count
        const willUpdate = dryRunData.summary?.scenariosWithChanges || 0;
        const unknownFixed = dryRunData.scenarioUpdates?.filter(s => s.updates?.scenarioType?.from === 'UNKNOWN').length || 0;
        
        if (willUpdate === 0) {
          showSnapshotToast('No Changes', 'All scenarios already classified', 'info');
          return;
        }
        
        // Confirm apply
        if (!confirm(`Found ${willUpdate} scenarios to update (${unknownFixed} UNKNOWN will be classified).\\n\\nApply changes now?`)) {
          return;
        }
        
        // Apply the changes
        const applyResponse = await fetch(`/api/trade-knowledge/templates/${qaSelectedTemplateId}/golden-autofill`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ mode: 'apply' })
        });
        
        const applyData = await applyResponse.json();
        
        if (!applyData.success) {
          throw new Error(applyData.error || 'Apply failed');
        }
        
        showSnapshotToast('Success!', `Updated ${applyData.summary?.scenariosUpdated || 0} scenarios`, 'success');
        
        // Refresh Runtime Truth to see changes
        await refreshSystemSnapshot();
        
      } catch (error) {
        console.error('[GOLDEN AUTOFILL] Error:', error);
        showSnapshotToast('Error', error.message, 'error');
      }
    }
    
    async function runGoldenAutofillDryRun() {
      if (!qaSelectedTemplateId) {
        showSnapshotToast('No active template found. Go to Templates tab to activate one.', 'warning');
        return;
      }
      
      console.log(`ğŸ¯ [GOLDEN AUTOFILL] Dry run for template ${qaSelectedTemplateId}`);
      
      try {
        const response = await fetch(`/api/trade-knowledge/templates/${qaSelectedTemplateId}/golden-autofill`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ mode: 'dry_run' })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        showGoldenAutofillPreview(data);
        
      } catch (error) {
        console.error('[GOLDEN AUTOFILL] Error:', error);
        showSnapshotToast('Failed to run autofill preview', 'error');
      }
    }
    
    function showGoldenAutofillPreview(data) {
      // Create modal for preview
      const modal = document.createElement('div');
      modal.id = 'golden-autofill-preview-modal';
      modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      
      const content = document.createElement('div');
      content.style.cssText = 'background: white; border-radius: 16px; max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;';
      
      content.innerHTML = `
        <div style="padding: 20px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between;">
          <div>
            <h3 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸ¯ Golden Autofill Preview</h3>
            <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">Template: ${data.templateName} â€¢ Version ${data.goldenVersion}</p>
          </div>
          <button onclick="closeGoldenAutofillPreview()" style="padding: 8px; border: none; background: none; cursor: pointer; font-size: 20px;">&times;</button>
        </div>
        
        <div style="padding: 20px 24px; overflow-y: auto; flex: 1;">
          <!-- Summary -->
          <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px;">
            <div style="background: #f0f9ff; border-radius: 8px; padding: 16px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #0369a1;">${data.summary.totalScenarios}</div>
              <div style="font-size: 12px; color: #0c4a6e;">Total</div>
            </div>
            <div style="background: #f0fdf4; border-radius: 8px; padding: 16px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #15803d;">${data.summary.toUpdate}</div>
              <div style="font-size: 12px; color: #166534;">Will Update</div>
            </div>
            <div style="background: #f8fafc; border-radius: 8px; padding: 16px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #64748b;">${data.summary.alreadyCompliant}</div>
              <div style="font-size: 12px; color: #475569;">Already OK</div>
            </div>
            <div style="background: #fef3c7; border-radius: 8px; padding: 16px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #d97706;">${data.summary.locked}</div>
              <div style="font-size: 12px; color: #92400e;">Locked (Skip)</div>
            </div>
            <div style="background: #fef2f2; border-radius: 8px; padding: 16px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #dc2626;">${data.summary.withQualityIssues}</div>
              <div style="font-size: 12px; color: #991b1b;">Need Manual</div>
            </div>
          </div>
          
          <!-- Changes Preview -->
          <h4 style="font-size: 14px; font-weight: 600; margin: 0 0 12px 0; color: #334155;">Changes to Apply (${data.willUpdate?.length || 0} scenarios)</h4>
          <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 16px;">
            ${(data.willUpdate || []).map(s => `
              <div style="padding: 12px; border-bottom: 1px solid #f1f5f9;">
                <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">${s.scenarioName}</div>
                <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">${s.categoryName} â€¢ Type: ${s.type}</div>
                <div style="background: #f8fafc; padding: 8px; border-radius: 4px;">
                  ${s.changes.map(c => `
                    <div style="font-size: 12px; margin-bottom: 4px;">
                      <strong>${c.field}:</strong> 
                      <span style="color: #dc2626; text-decoration: line-through;">${JSON.stringify(c.before)}</span> â†’ 
                      <span style="color: #22c55e;">${JSON.stringify(c.after)}</span>
                      <span style="color: #94a3b8; font-style: italic;"> (${c.reason})</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('') || '<div style="padding: 20px; text-align: center; color: #94a3b8;">No changes needed</div>'}
          </div>
          
          <!-- Quality Issues -->
          ${data.qualityIssues?.length > 0 ? `
            <h4 style="font-size: 14px; font-weight: 600; margin: 0 0 12px 0; color: #f59e0b;">âš ï¸ Manual Attention Needed (${data.qualityIssues.length})</h4>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #fed7aa; border-radius: 8px; background: #fffbeb;">
              ${data.qualityIssues.map(s => `
                <div style="padding: 12px; border-bottom: 1px solid #fed7aa;">
                  <div style="font-weight: 600; color: #92400e;">${s.scenarioName} (Grade ${s.grade})</div>
                  <div style="font-size: 12px; color: #b45309;">${s.issues.join(' â€¢ ')}</div>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
        
        <div style="padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc;">
          <button onclick="closeGoldenAutofillPreview()" class="btn btn-secondary">Cancel</button>
          <button onclick="applyGoldenAutofill()" class="btn btn-primary" ${data.summary.toUpdate === 0 ? 'disabled' : ''}>
            <i class="fas fa-check"></i> Apply ${data.summary.toUpdate} Changes
          </button>
        </div>
      `;
      
      modal.appendChild(content);
      document.body.appendChild(modal);
    }
    
    function closeGoldenAutofillPreview() {
      const modal = document.getElementById('golden-autofill-preview-modal');
      if (modal) modal.remove();
    }
    
    async function applyGoldenAutofill() {
      if (!qaSelectedTemplateId) return;
      
      closeGoldenAutofillPreview();
      
      try {
        const response = await fetch(`/api/trade-knowledge/templates/${qaSelectedTemplateId}/golden-autofill`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ mode: 'apply' })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          showSnapshotToast(`Golden Autofill applied: ${data.results.updated} updated, ${data.results.locked} locked, ${data.results.failed} failed`, 'success');
          await loadQADashboard(); // Refresh
        } else {
          throw new Error(data.error || 'Apply failed');
        }
        
      } catch (error) {
        console.error('[GOLDEN AUTOFILL] Apply error:', error);
        showSnapshotToast('Failed to apply golden autofill', 'error');
      }
    }
    
    async function loadPlaceholders() {
      const tbody = document.getElementById('placeholders-list');
      
      try {
        // Load from company.variables (legacy) until we have a proper placeholders endpoint
        const response = await fetch(`/api/company/${currentCompanyId}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          const company = data.company || data;
          const variables = company.variables || {};
          
          currentPlaceholders = variables;
          
          if (Object.keys(variables).length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="3" style="text-align: center; padding: 40px; color: #94a3b8;">
                  <i class="fas fa-tags" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                  No placeholders yet. Click "Add Placeholder" or "Import Defaults".
                </td>
              </tr>
            `;
          } else {
            tbody.innerHTML = Object.entries(variables).map(([key, value]) => `
              <tr data-placeholder-key="${key}">
                <td>
                  <code style="background: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-size: 13px;">{${key}}</code>
                </td>
                <td>
                  <input type="text" value="${escapeHtml(value)}" 
                         onchange="updatePlaceholder('${key}', this.value)"
                         style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                </td>
                <td>
                  <button onclick="deletePlaceholder('${key}')" style="padding: 6px 12px; border: none; background: #fee2e2; color: #dc2626; border-radius: 6px; cursor: pointer; font-size: 12px;">
                    <i class="fas fa-trash"></i>
                  </button>
            </td>
          </tr>
        `).join('');
          }
        }
      } catch (error) {
        console.error('Failed to load placeholders:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="3" style="text-align: center; padding: 40px; color: #ef4444;">
              <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px; display: block;"></i>
              Failed to load placeholders: ${error.message}
            </td>
          </tr>
        `;
      }
    }
    
    function addPlaceholder() {
      const name = prompt('Enter placeholder name (no spaces, e.g., "companyName"):');
      if (!name) return;
      
      const sanitizedName = name.replace(/[^a-zA-Z0-9_]/g, '');
      if (!sanitizedName) {
        alert('Invalid placeholder name');
        return;
      }
      
      if (currentPlaceholders[sanitizedName]) {
        alert('Placeholder already exists');
        return;
      }
      
      currentPlaceholders[sanitizedName] = '';
      loadPlaceholders();
    }
    
    function updatePlaceholder(key, value) {
      currentPlaceholders[key] = value;
    }
    
    function deletePlaceholder(key) {
      if (confirm(`Delete placeholder {${key}}?`)) {
        delete currentPlaceholders[key];
        loadPlaceholders();
      }
    }
    
    async function savePlaceholders() {
      try {
        const response = await fetch(`/api/company/${currentCompanyId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ variables: currentPlaceholders })
        });
        
        if (response.ok) {
          alert('âœ… Placeholders saved!');
        } else {
          throw new Error('Failed to save');
        }
      } catch (error) {
        alert('âŒ Failed to save placeholders: ' + error.message);
      }
    }
    
    async function importPlaceholderDefaults() {
      // Import common defaults
      const defaults = {
        companyName: '',
        companyPhone: '',
        companyAddress: '',
        businessHours: 'Monday-Friday 8am-5pm',
        serviceArea: '',
        emergencyPhone: '',
        websiteUrl: ''
      };
      
      currentPlaceholders = { ...defaults, ...currentPlaceholders };
      loadPlaceholders();
      alert('âœ… Default placeholders imported. Fill in the values and click Save.');
    }
    
    function resetPlaceholders() {
      if (confirm('Reset all placeholders to defaults? This will clear custom values.')) {
        currentPlaceholders = {};
        importPlaceholderDefaults();
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMPANY DEFAULT REPLIES - Deterministic fallback responses
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentDefaults = null;
    
    async function loadCompanyDefaults() {
      const loadingEl = document.getElementById('defaults-loading');
      const formEl = document.getElementById('defaults-form');
      
      if (loadingEl) loadingEl.style.display = 'block';
      if (formEl) formEl.style.display = 'none';
      
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/overrides/defaults`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!response.ok) throw new Error('Failed to load defaults');
        
        const data = await response.json();
        currentDefaults = data.defaults;
        
        // Populate form fields
        document.getElementById('defaults-notOffered-quick').value = currentDefaults?.notOfferedReply?.quickReply || '';
        document.getElementById('defaults-notOffered-full').value = currentDefaults?.notOfferedReply?.fullReply || '';
        document.getElementById('defaults-unknownIntent-quick').value = currentDefaults?.unknownIntentReply?.quickReply || '';
        document.getElementById('defaults-unknownIntent-full').value = currentDefaults?.unknownIntentReply?.fullReply || '';
        document.getElementById('defaults-afterHours-quick').value = currentDefaults?.afterHoursReply?.quickReply || '';
        document.getElementById('defaults-afterHours-full').value = currentDefaults?.afterHoursReply?.fullReply || '';
        document.getElementById('defaults-strictBehavior').checked = currentDefaults?.strictDisabledBehavior ?? true;
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (formEl) formEl.style.display = 'block';
        
        console.log('âœ… [DEFAULTS] Company defaults loaded');
      } catch (error) {
        console.error('âŒ [DEFAULTS] Load failed:', error);
        if (loadingEl) loadingEl.innerHTML = `
          <div style="color: #ef4444;">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px; display: block;"></i>
            Failed to load defaults: ${error.message}
          </div>
        `;
      }
    }
    
    async function saveCompanyDefaults() {
      try {
        const updates = {
          notOfferedReply: {
            quickReply: document.getElementById('defaults-notOffered-quick').value.trim(),
            fullReply: document.getElementById('defaults-notOffered-full').value.trim()
          },
          unknownIntentReply: {
            quickReply: document.getElementById('defaults-unknownIntent-quick').value.trim(),
            fullReply: document.getElementById('defaults-unknownIntent-full').value.trim()
          },
          afterHoursReply: {
            quickReply: document.getElementById('defaults-afterHours-quick').value.trim(),
            fullReply: document.getElementById('defaults-afterHours-full').value.trim()
          },
          strictDisabledBehavior: document.getElementById('defaults-strictBehavior').checked
        };
        
        // Validate required fields
        if (!updates.notOfferedReply.fullReply) {
          alert('âš ï¸ "Not Offered" full reply is required for production readiness.');
          return;
        }
        
        const response = await fetch(`/api/company/${currentCompanyId}/overrides/defaults`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updates)
        });
        
        if (!response.ok) throw new Error('Failed to save defaults');
        
        showSnapshotToast('âœ… Default Replies Saved!', 'Your deterministic fallback responses are now configured.', 'success');
        
        // Refresh the header badge to reflect new score
        loadSnapshotBadge();
        
        console.log('âœ… [DEFAULTS] Company defaults saved');
      } catch (error) {
        console.error('âŒ [DEFAULTS] Save failed:', error);
        alert('âŒ Failed to save: ' + error.message);
      }
    }
    
    // OLD loadTemplates/loadScenarios removed
    // Now using AiCoreTemplatesManager and AiCoreLiveScenariosManager (the original managers)
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LEGACY TAB - Full Inventory & Read-Only View
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let fullInventory = null;
    
    async function initLegacy() {
      console.log('ğŸ“¦ [INIT] Initializing Legacy tab...');
      // Auto-load inventory when tab is first opened
      await loadFullInventory();
      console.log('âœ… [INIT] Legacy tab initialized');
    }
    
    async function loadFullInventory() {
      const btn = document.getElementById('btn-load-inventory');
      const jsonDisplay = document.getElementById('legacy-full-json');
      
      try {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        btn.disabled = true;
        
        const response = await fetch(`/api/company/${currentCompanyId}/full-inventory`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!response.ok) {
          throw new Error(`Failed to fetch inventory: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.inventory) {
          fullInventory = data.inventory;
          
          // Update full JSON display
          jsonDisplay.textContent = JSON.stringify(data.inventory, null, 2);
          
          // Update summary stats
          const summaryDiv = document.getElementById('inventory-summary');
          const statsGrid = document.getElementById('inventory-stats-grid');
          summaryDiv.style.display = 'block';
          
          const inv = data.inventory;
          const collections = inv.collections || {};
          const separate = inv.separateCollections || {};
          
          statsGrid.innerHTML = `
            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #92400e;">${collections.triage?.count || 0}</div>
              <div style="font-size: 11px; color: #a16207;">Triage Cards</div>
            </div>
            <div style="background: #e0e7ff; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #4338ca;">${collections.behaviorRules?.count || 0}</div>
              <div style="font-size: 11px; color: #6366f1;">Behavior Rules</div>
            </div>
            <div style="background: #d1fae5; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #059669;">${collections.guardrails?.count || 0}</div>
              <div style="font-size: 11px; color: #10b981;">Guardrails</div>
            </div>
            <div style="background: #cffafe; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #0891b2;">${collections.variablesLegacy?.count || 0}</div>
              <div style="font-size: 11px; color: #06b6d4;">Variables</div>
            </div>
            <div style="background: #fce7f3; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #be185d;">${collections.calculators?.count || 0}</div>
              <div style="font-size: 11px; color: #ec4899;">Calculators</div>
            </div>
            <div style="background: #ffedd5; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #c2410c;">${separate.blackBoxRecordings?.count || 0}</div>
              <div style="font-size: 11px; color: #f97316;">Black Box</div>
            </div>
            <div style="background: #f1f5f9; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #475569;">${separate.dynamicFlows?.count || 0}</div>
              <div style="font-size: 11px; color: #64748b;">Dynamic Flows</div>
            </div>
            <div style="background: #f1f5f9; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #475569;">${collections.transferRules?.count || 0}</div>
              <div style="font-size: 11px; color: #64748b;">Transfer Rules</div>
            </div>
          `;
          
          // Update individual section counts
          document.getElementById('triage-count').textContent = collections.triage?.count || 0;
          document.getElementById('mission-count').textContent = collections.missionControl?.exists ? 'âœ“' : 'â€”';
          document.getElementById('behavior-count').textContent = collections.behaviorRules?.count || 0;
          document.getElementById('guardrails-count').textContent = collections.guardrails?.count || 0;
          document.getElementById('variables-count').textContent = collections.variablesLegacy?.count || 0;
          document.getElementById('calculators-count').textContent = collections.calculators?.count || 0;
          document.getElementById('blackbox-count').textContent = separate.blackBoxRecordings?.count || 0;
          
          // Update section JSON displays
          document.getElementById('legacy-triage-json').textContent = JSON.stringify(collections.triage, null, 2);
          document.getElementById('legacy-mission-json').textContent = JSON.stringify(collections.missionControl, null, 2);
          document.getElementById('legacy-behavior-json').textContent = JSON.stringify(collections.behaviorRules, null, 2);
          document.getElementById('legacy-guardrails-json').textContent = JSON.stringify(collections.guardrails, null, 2);
          document.getElementById('legacy-variables-json').textContent = JSON.stringify(collections.variablesLegacy, null, 2);
          document.getElementById('legacy-calculators-json').textContent = JSON.stringify(collections.calculators, null, 2);
          document.getElementById('legacy-blackbox-json').textContent = JSON.stringify(separate.blackBoxRecordings, null, 2);
          
          console.log('âœ… [INVENTORY] Loaded:', {
            triage: collections.triage?.count,
            variables: collections.variablesLegacy?.count,
            dynamicFlows: separate.dynamicFlows?.count
          });
        }
        
      } catch (error) {
        console.error('âŒ [INVENTORY] Error:', error);
        jsonDisplay.textContent = JSON.stringify({
          error: true,
          message: error.message,
          timestamp: new Date().toISOString()
        }, null, 2);
      } finally {
        btn.innerHTML = '<i class="fas fa-search"></i> Load Full Inventory (Prove Nothing Lost)';
        btn.disabled = false;
      }
    }
    
    function toggleLegacySection(section) {
      const content = document.getElementById(`legacy-${section}`);
      if (content) {
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
      }
    }
    
    function copyInventoryJson() {
      const jsonDisplay = document.getElementById('legacy-full-json');
      navigator.clipboard.writeText(jsonDisplay.textContent).then(() => {
        const btn = document.getElementById('btn-copy-inventory');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => { btn.innerHTML = originalHTML; }, 2000);
      }).catch(err => {
        alert('Failed to copy: ' + err.message);
      });
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI TEST CONSOLE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function openAITestConsole() {
      if (!currentCompanyId) {
        alert('Please select a company first');
          return;
        }

      if (!window.AITestConsole) {
        await loadScript('/js/ai-agent-settings/AITestConsole.js');
      }
      
      const testConsole = new window.AITestConsole(currentCompanyId);
      testConsole.open();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RUNTIME TRUTH - Single Source of Truth (Fixed Dec 2025 - uses /runtime-truth not /system-snapshot)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentSnapshot = null;
    
    async function refreshSystemSnapshot() {
      if (!currentCompanyId) {
        alert('No company selected');
        return;
      }
      
      const refreshIcon = document.getElementById('refresh-icon');
      const jsonDisplay = document.getElementById('snapshot-json');
      
      try {
        // Show loading state
        if (refreshIcon) refreshIcon.classList.add('fa-spin');
        jsonDisplay.textContent = '{\n  "loading": true,\n  "message": "Loading Runtime Truth..."\n}';
        
        // FIXED: Use /runtime-truth endpoint (the one that actually works)
        const response = await fetch(`/api/company/${currentCompanyId}/runtime-truth`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!response.ok) {
          throw new Error(`Failed to fetch runtime truth: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const rt = result.data; // Runtime Truth format
          currentSnapshot = rt;
          
          // Update display
          jsonDisplay.textContent = JSON.stringify(rt, null, 2);
          
          // Update stats (map from Runtime Truth format)
          document.getElementById('stat-flows').textContent = rt.dynamicFlows?.flows?.length || rt.dynamicFlows?.totalCount || 0;
          document.getElementById('stat-transfers').textContent = rt.controlPlane?.booking?.slotsCount || 0;
          document.getElementById('stat-contacts').textContent = rt.scenarioBrain?.totals?.scenarios || 0;
          
          // Update timestamp
          document.getElementById('snapshot-timestamp').textContent = new Date(rt._meta?.generatedAt || new Date()).toLocaleTimeString();
          document.getElementById('snapshot-generation-time').textContent = (rt._meta?.generationTimeMs || 0) + 'ms';
          
          // Update mode indicator based on health status
          const modeIcon = document.getElementById('snapshot-mode-icon');
          const modeText = document.getElementById('snapshot-mode-text');
          const statusDiv = document.getElementById('snapshot-status');
          
          const healthStatus = rt.health?.status || 'UNKNOWN';
          if (healthStatus === 'GREEN') {
            modeIcon.textContent = 'ğŸŸ¢';
            modeText.textContent = 'HEALTHY';
            statusDiv.style.background = 'rgba(16, 185, 129, 0.2)';
            statusDiv.style.color = 'var(--accent-green)';
          } else if (healthStatus === 'YELLOW') {
            modeIcon.textContent = 'ğŸŸ¡';
            modeText.textContent = 'WARNINGS';
            statusDiv.style.background = 'rgba(249, 115, 22, 0.2)';
            statusDiv.style.color = 'var(--accent-orange)';
          } else {
            modeIcon.textContent = 'ğŸ”´';
            modeText.textContent = 'ISSUES';
            statusDiv.style.background = 'rgba(239, 68, 68, 0.2)';
            statusDiv.style.color = 'var(--accent-red)';
          }
          
          // Update Flow Tree status
          const flowTreeStatus = document.getElementById('flow-tree-status');
          if (flowTreeStatus) {
            const enabledFlows = rt.dynamicFlows?.enabledCount || 0;
            if (enabledFlows > 0) {
              flowTreeStatus.innerHTML = `<i class="fas fa-circle" style="color: var(--accent-green);"></i><span>${enabledFlows} Flows Active</span>`;
              flowTreeStatus.style.background = 'rgba(16, 185, 129, 0.2)';
              flowTreeStatus.style.color = 'var(--accent-green)';
            } else {
              flowTreeStatus.innerHTML = '<i class="fas fa-circle" style="color: var(--accent-orange);"></i><span>No Flows</span>';
              flowTreeStatus.style.background = 'rgba(249, 115, 22, 0.2)';
              flowTreeStatus.style.color = 'var(--accent-orange)';
              
              // Show "Create Booking Flow" button when no flows exist
              showCreateFlowButton(true);
            }
          }
          
          // Hide the button if flows exist
          if (rt.dynamicFlows?.enabledCount > 0) {
            showCreateFlowButton(false);
          }
          
          console.log('âœ… [RUNTIME TRUTH] Loaded:', {
            health: rt.health?.status,
            scenarios: rt.scenarioBrain?.totals?.scenarios,
            flows: rt.dynamicFlows?.totalCount,
            generatedIn: rt._meta?.generationTimeMs + 'ms'
          });
          
        } else {
          throw new Error(result.error || 'Unknown error');
        }
        
      } catch (error) {
        console.error('âŒ [RUNTIME TRUTH] Error:', error);
        jsonDisplay.textContent = JSON.stringify({
          error: true,
          message: error.message,
          timestamp: new Date().toISOString()
        }, null, 2);
      } finally {
        if (refreshIcon) refreshIcon.classList.remove('fa-spin');
      }
    }
    
    function toggleRuntimeTruthDropdown() {
      const dropdown = document.getElementById('runtime-truth-dropdown');
      dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
    
    function showCreateFlowButton(show) {
      const btn = document.getElementById('btn-create-booking-flow');
      if (btn) {
        btn.style.display = show ? 'inline-block' : 'none';
      }
    }
    
    async function createBookingFlow() {
      const btn = document.getElementById('btn-create-booking-flow');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
      }
      
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/seed-golden/quick-booking-flow`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSnapshotToast('Booking Flow Created!', `${result.flowKey} is now enabled with ${result.triggerCount} triggers`, 'success');
          
          // Refresh the Runtime Truth to show the new flow
          await refreshSystemSnapshot();
          
          // Hide the button
          showCreateFlowButton(false);
        } else {
          throw new Error(result.error || 'Failed to create flow');
        }
      } catch (error) {
        console.error('[CREATE BOOKING FLOW] Error:', error);
        showSnapshotToast('Error', error.message, 'error');
        
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-plus"></i> Create Booking Flow';
        }
      }
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('runtime-truth-dropdown');
      const btn = document.getElementById('btn-copy-snapshot');
      if (dropdown && btn && !btn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });
    
    function downloadRuntimeTruth() {
      if (!currentSnapshot) {
        alert('No Runtime Truth loaded yet. Click Refresh first.');
        return;
      }
      
      const jsonStr = JSON.stringify(currentSnapshot, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `runtime-truth-${currentCompanyId}-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      console.log('ğŸ“¥ [RUNTIME TRUTH] Downloaded JSON file');
    }
    
    function copySystemSnapshot() {
      const jsonDisplay = document.getElementById('snapshot-json');
      const text = jsonDisplay.textContent;
      
      navigator.clipboard.writeText(text).then(() => {
        // Visual feedback
        const btn = document.getElementById('btn-copy-snapshot');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i><span>âœ… Copied!</span>';
        btn.style.background = 'var(--accent-green)';
        btn.style.borderColor = 'var(--accent-green)';
        
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.style.background = 'var(--accent-orange)';
          btn.style.borderColor = 'var(--accent-orange)';
        }, 2000);
        
        console.log('ğŸ“‹ [SNAPSHOT] Copied to clipboard');
      }).catch(err => {
        console.error('âŒ [SNAPSHOT] Failed to copy:', err);
        alert('Failed to copy to clipboard');
      });
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EVENT LISTENERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.addEventListener('DOMContentLoaded', () => {
      // Wire up nav tabs
      document.querySelectorAll('.nav-tab').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tabId = btn.getAttribute('data-tab');
          // Skip for Call Center (opens in new tab)
          if (tabId === 'call-center') return;
          switchTab(tabId);
      });
    });

      // Auto-initialize Front Desk (default tab)
      if (currentCompanyId) {
        initializeTab('front-desk');
      } else {
        document.getElementById('front-desk-container').innerHTML = `
          <div style="padding: 60px; text-align: center; color: #ef4444;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
            <h3>No Company Selected</h3>
            <p>Please add ?companyId=... to the URL</p>
          </div>
        `;
      }
    });
    
    console.log('âœ… [CONTROL PLANE] Clean Architecture loaded - Dec 2025');
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PLATFORM SNAPSHOT (Enterprise Introspection)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Note: currentSnapshot is already declared above for Flow Tree
    let currentSnapshotScope = 'full';
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BADGE STATE MACHINE (LOCKED)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // | State      | Meaning              | Display      |
    // | ---------- | -------------------- | ------------ |
    // | notloaded  | Snapshot not fetched | â³ â€” gray    |
    // | GREEN      | â‰¥90                  | ğŸŸ¢ 92%       |
    // | YELLOW     | 80â€“89                | ğŸŸ¡ 85%       |
    // | RED        | <80                  | ğŸ”´ 72%       |
    // | ERROR      | Snapshot failed      | âŒ ERR       |
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function updateHeaderBadge(score, status, error = null) {
      const emojiEl = document.getElementById('json-badge-emoji');
      const scoreEl = document.getElementById('json-badge-score');
      
      if (error) {
        emojiEl.textContent = 'âŒ';
        scoreEl.textContent = 'ERR';
        scoreEl.className = 'json-badge-score error';
        return;
      }
      
      // Emoji based on status
      if (status === 'GREEN') emojiEl.textContent = 'ğŸŸ¢';
      else if (status === 'YELLOW') emojiEl.textContent = 'ğŸŸ¡';
      else if (status === 'RED') emojiEl.textContent = 'ğŸ”´';
      else emojiEl.textContent = 'ğŸ“„';
      
      // Score display
      scoreEl.textContent = score + '%';
      scoreEl.className = 'json-badge-score ' + (status || 'notloaded').toLowerCase();
    }
    
    // Load badge on page load (uses same endpoint as modal for consistency)
    async function loadSnapshotBadge() {
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/platform-snapshot/badge`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.badge) {
          updateHeaderBadge(data.badge.score, data.badge.status);
        } else {
          throw new Error(data.error || 'Invalid badge response');
        }
      } catch (error) {
        console.warn('[SNAPSHOT] Badge load failed:', error);
        updateHeaderBadge(0, null, error);
      }
    }
    
    // Initialize badge on page load
    setTimeout(loadSnapshotBadge, 1000);
    
    async function openPlatformSnapshotModal() {
      const overlay = document.getElementById('snapshot-modal-overlay');
      overlay.classList.add('active');
      
      // Load snapshot
      await loadPlatformSnapshot(currentSnapshotScope);
    }
    
    function closePlatformSnapshotModal() {
      const overlay = document.getElementById('snapshot-modal-overlay');
      overlay.classList.remove('active');
    }
    
    async function loadPlatformSnapshot(scope = 'full') {
      currentSnapshotScope = scope;
      
      const jsonPre = document.getElementById('snapshot-json-content');
      const statusBadge = document.getElementById('snapshot-status-badge');
      const penaltiesPanel = document.getElementById('snapshot-penalties-panel');
      const summaryText = document.getElementById('snapshot-summary-text');
      const genTimeText = document.getElementById('snapshot-gen-time');
      
      // Show loading
      jsonPre.textContent = 'Loading snapshot...';
      statusBadge.textContent = 'â³ Loading';
      statusBadge.className = 'snapshot-status-badge';
      
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/platform-snapshot?scope=${scope}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
        });
          const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Failed to load snapshot');
        }
        
        currentSnapshot = data.snapshot;
        const completeness = currentSnapshot.completeness || {};
        
        // Update status badge WITH SCOPE LABEL
        const emoji = completeness.status === 'GREEN' ? 'ğŸŸ¢' : 
                      completeness.status === 'YELLOW' ? 'ğŸŸ¡' : 'ğŸ”´';
        const scopeLabel = scope.toUpperCase();
        statusBadge.textContent = `${emoji} ${completeness.score}% (${completeness.grade}) â€” ${scopeLabel}`;
        statusBadge.className = `snapshot-status-badge ${completeness.status?.toLowerCase() || 'yellow'}`;
        
        // Update summary
        summaryText.textContent = completeness.summary || '';
        
        // Update generation time
        genTimeText.textContent = `Generated in ${currentSnapshot.meta?.generationMs || 0}ms`;
        
        // Update penalties panel
        const penalties = completeness.penalties || [];
        if (penalties.length > 0) {
          penaltiesPanel.style.display = 'block';
          penaltiesPanel.className = `snapshot-penalties-panel ${completeness.status?.toLowerCase()}`;
          penaltiesPanel.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 12px;">
              âš ï¸ ${penalties.length} Issue${penalties.length > 1 ? 's' : ''} Found
            </div>
            ${penalties.map(p => `
              <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 6px; margin-bottom: 6px;">
                <span style="font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600;
                  background: ${p.severity === 'RED' ? '#ef4444' : p.severity === 'YELLOW' ? '#f59e0b' : '#10b981'};
                  color: white;">${p.severity}</span>
                <span style="flex: 1; font-size: 13px; color: #374151;">${p.message}</span>
                <span style="font-size: 12px; color: #6b7280;">-${p.weight}</span>
              </div>
            `).join('')}
            ${(completeness.recommendations || []).length > 0 ? `
              <div style="margin-top: 16px; padding-top: 16px; border-top: 1px dashed rgba(0,0,0,0.2);">
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 13px;">ğŸ’¡ Recommendations</div>
                ${completeness.recommendations.map(r => `
                  <div style="font-size: 12px; color: #4b5563; padding: 4px 0;">â€¢ ${r}</div>
                `).join('')}
              </div>
            ` : ''}
          `;
        } else {
          penaltiesPanel.style.display = 'none';
        }
        
        // Update JSON display
        jsonPre.textContent = JSON.stringify(currentSnapshot, null, 2);
        
        // SYNC: Update header badge ONLY if this is FULL scope
        // Header badge always shows FULL platform score (single source of truth)
        if (scope === 'full') {
          updateHeaderBadge(completeness.score, completeness.status);
        }
        
      } catch (error) {
        console.error('[SNAPSHOT] Load failed:', error);
        jsonPre.textContent = `Error: ${error.message}`;
        statusBadge.textContent = 'ğŸ”´ Error';
        statusBadge.className = 'snapshot-status-badge red';
        summaryText.textContent = error.message;
        penaltiesPanel.style.display = 'none';
      }
    }
    
    function copySnapshotToClipboard() {
      if (!currentSnapshot) {
        showSnapshotToast('âŒ No snapshot loaded', 'Load a snapshot first by clicking Refresh', 'error');
        return;
      }
      
      const jsonText = JSON.stringify(currentSnapshot, null, 2);
      const charCount = jsonText.length;
      const lineCount = jsonText.split('\n').length;
      const providerCount = Object.keys(currentSnapshot.providers || {}).length;
      const score = currentSnapshot.completeness?.score || 0;
      const status = currentSnapshot.completeness?.status || 'UNKNOWN';
      
      navigator.clipboard.writeText(jsonText).then(() => {
        // Update button visual
        const btn = document.getElementById('btn-copy-snapshot-modal');
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.style.background = '#10b981';
        btn.style.transform = 'scale(1.05)';
        
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-copy"></i> Copy JSON';
          btn.style.background = '#3b82f6';
          btn.style.transform = 'scale(1)';
        }, 2500);
        
        // Show detailed toast
        showSnapshotToast(
          'âœ… Snapshot Copied!',
          `${providerCount} providers â€¢ ${lineCount} lines â€¢ ${(charCount/1024).toFixed(1)}KB â€¢ Score: ${score}% (${status})`,
          'success'
        );
        
      }).catch(err => {
        showSnapshotToast('âŒ Copy Failed', err.message, 'error');
      });
    }
    
    function showSnapshotToast(title, message, type = 'info') {
      // Remove existing toast
      const existing = document.getElementById('snapshot-toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.id = 'snapshot-toast';
      toast.style.cssText = `
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 100001;
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 300px;
        max-width: 500px;
        animation: toastSlideUp 0.3s ease forwards;
      `;
      
      toast.innerHTML = `
        <div style="font-weight: 700; font-size: 15px;">${title}</div>
        <div style="font-size: 13px; opacity: 0.9;">${message}</div>
      `;
      
      // Add animation keyframes if not exists
      if (!document.getElementById('toast-animation-style')) {
        const style = document.createElement('style');
        style.id = 'toast-animation-style';
        style.textContent = `
          @keyframes toastSlideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
          }
          @keyframes toastSlideDown {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(100px); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(toast);
      
      // Auto-dismiss after 3 seconds
      setTimeout(() => {
        toast.style.animation = 'toastSlideDown 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    function refreshPlatformSnapshot() {
      loadPlatformSnapshot(currentSnapshotScope);
    }
    
    function changeSnapshotScope(scope) {
      loadPlatformSnapshot(scope);
    }
  </script>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PLATFORM SNAPSHOT MODAL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="snapshot-modal-overlay" class="snapshot-modal-overlay" onclick="if(event.target === this) closePlatformSnapshotModal()">
    <div class="snapshot-modal">
      
      <!-- Header -->
      <div class="snapshot-modal-header">
        <div class="snapshot-modal-title">
          <h2 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸ“„ Platform Snapshot</h2>
          <span id="snapshot-status-badge" class="snapshot-status-badge">Loading...</span>
        </div>
        <div class="snapshot-modal-controls">
          <button id="btn-copy-snapshot-modal" onclick="copySnapshotToClipboard()" 
                  style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px; transition: all 0.15s ease; box-shadow: 0 2px 4px rgba(59,130,246,0.3);"
                  onmousedown="this.style.transform='scale(0.95)'; this.style.boxShadow='0 1px 2px rgba(59,130,246,0.2)';"
                  onmouseup="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(59,130,246,0.3)';"
                  onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(59,130,246,0.3)';">
            <i class="fas fa-copy"></i> Copy JSON
          </button>
          <button onclick="refreshPlatformSnapshot()" 
                  style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <button onclick="closePlatformSnapshotModal()" 
                  style="padding: 8px 16px; background: transparent; color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-weight: 500;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <!-- Body -->
      <div class="snapshot-modal-body">
        
        <!-- Scope Selector -->
        <div class="snapshot-scope-selector">
          <span class="snapshot-scope-label">Snapshot Scope:</span>
          <div class="snapshot-scope-options">
            <label><input type="radio" name="snapshot-scope" value="full" checked onchange="changeSnapshotScope('full')"> FULL PLATFORM</label>
            <label><input type="radio" name="snapshot-scope" value="control" onchange="changeSnapshotScope('control')"> Control Plane Only</label>
            <label><input type="radio" name="snapshot-scope" value="scenarios" onchange="changeSnapshotScope('scenarios')"> Scenario Brain Only</label>
            <label><input type="radio" name="snapshot-scope" value="runtime" onchange="changeSnapshotScope('runtime')"> Runtime Wiring</label>
          </div>
        </div>
        
        <!-- Penalties Panel (conditional) -->
        <div id="snapshot-penalties-panel" class="snapshot-penalties-panel" style="display: none;">
          <!-- Populated by JS -->
        </div>
        
        <!-- JSON Display -->
        <div class="snapshot-json-container">
          <pre id="snapshot-json-content" class="snapshot-json-pre">Click "Refresh" to load snapshot...</pre>
        </div>
        
      </div>
      
      <!-- Footer -->
      <div class="snapshot-modal-footer">
        <div style="display: flex; align-items: center; gap: 16px;">
          <span id="snapshot-summary-text" style="font-size: 14px; color: #64748b;"></span>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <span id="snapshot-gen-time" style="font-size: 12px; color: #94a3b8;"></span>
          <span style="font-size: 12px; color: #94a3b8;">v1.0</span>
        </div>
      </div>
      
    </div>
  </div>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GOLDEN SETUP MODAL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="golden-modal-overlay" class="snapshot-modal-overlay" onclick="if(event.target === this) closeGoldenSetupModal()">
    <div class="snapshot-modal" style="max-width: 650px; max-height: 90vh; display: flex; flex-direction: column;">
      
      <!-- Header -->
      <div class="snapshot-modal-header" style="background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);">
        <div class="snapshot-modal-title">
          <h2 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸŸ£ Load Golden HVAC Setup</h2>
          <span id="golden-status-badge" class="snapshot-status-badge" style="display: none;"></span>
        </div>
        <div class="snapshot-modal-controls">
          <button onclick="closeGoldenSetupModal()" 
                  style="padding: 8px 16px; background: transparent; color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-weight: 500;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="snapshot-modal-body" style="padding: 24px; overflow-y: auto; flex: 1;">
        
        <div id="golden-confirm-view">
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 64px; margin-bottom: 16px;">ğŸ§</div>
            <h3 style="margin: 0 0 8px; font-size: 20px; font-weight: 600; color: #1e293b;">Penguin Air Reference</h3>
            <p style="color: #64748b; margin: 0 0 16px; line-height: 1.6;">
              This seeds the <strong>golden HVAC configuration</strong> in two parts:
            </p>
          </div>
          
          <!-- STEP 1: Company Config -->
          <div style="background: #f0fdf4; border: 2px solid #86efac; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #166534; display: flex; align-items: center; gap: 8px;">
              <span style="background: #22c55e; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">1</span>
              Company Config (Auto-applied)
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; color: #166534;">
              <div>âœ“ Placeholders (phone, address)</div>
              <div>âœ“ Front Desk Greeting & Tone</div>
              <div>âœ“ Booking Slots & Time Windows</div>
              <div>âœ“ Default Replies (Not Offered)</div>
              <div>âœ“ Transfer Targets</div>
              <div>âœ“ Call Protection Rules</div>
            </div>
          </div>
          
          <!-- STEP 2: Templates -->
          <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #92400e; display: flex; align-items: center; gap: 8px;">
              <span style="background: #f59e0b; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">2</span>
              Dynamic Flow Templates (Global, not auto-activated)
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; color: #92400e;">
              <div>ğŸ“‹ Emergency Detection</div>
              <div>ğŸ“‹ After Hours Routing</div>
              <div>ğŸ“‹ Technician Request</div>
              <div>ğŸ“‹ Booking Intent</div>
            </div>
            <p style="font-size: 12px; color: #78350f; margin: 12px 0 0; padding-top: 12px; border-top: 1px solid #fcd34d;">
              <strong>Note:</strong> Templates are seeded globally. Use "Copy Templates to Company" to activate them for this company.
            </p>
          </div>
          
          <div style="background: #f1f5f9; border-radius: 8px; padding: 12px; margin-bottom: 24px;">
            <div style="font-size: 13px; color: #475569; line-height: 1.5;">
              <strong>Why two steps?</strong> Global templates are shared blueprints. Company flows are 
              editable copies. This separation prevents cross-company contamination and keeps templates stable.
            </div>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="closeGoldenSetupModal()" 
                    style="padding: 12px 24px; background: #f1f5f9; color: #475569; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
              Cancel
            </button>
            <button id="btn-confirm-golden" onclick="executeGoldenSetup()" 
                    style="padding: 12px 24px; background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-magic"></i> Seed Config + Templates
            </button>
          </div>
        </div>
        
        <div id="golden-loading-view" style="display: none; text-align: center; padding: 40px;">
          <div style="font-size: 48px; margin-bottom: 16px; animation: spin 1s linear infinite;">âš™ï¸</div>
          <p style="color: #64748b; margin: 0;">Seeding golden configuration...</p>
        </div>
        
        <div id="golden-result-view" style="display: none;">
          <div id="golden-result-content"></div>
          <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button onclick="closeGoldenSetupModal()" 
                    style="padding: 12px 24px; background: #f1f5f9; color: #475569; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
              Close
            </button>
            <button onclick="openPlatformSnapshotModal(); closeGoldenSetupModal();" 
                    style="padding: 12px 24px; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-file-code"></i> View Snapshot
            </button>
          </div>
        </div>
        
      </div>
      
    </div>
  </div>
  
  <style>
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
  
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GOLDEN SETUP MODAL FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function openGoldenSetupModal() {
      const overlay = document.getElementById('golden-modal-overlay');
      overlay.classList.add('active');
      
      // Reset to confirm view
      document.getElementById('golden-confirm-view').style.display = 'block';
      document.getElementById('golden-loading-view').style.display = 'none';
      document.getElementById('golden-result-view').style.display = 'none';
    }
    
    function closeGoldenSetupModal() {
      const overlay = document.getElementById('golden-modal-overlay');
      overlay.classList.remove('active');
    }
    
    async function copyTemplatesToCompany() {
      // Show loading in the button
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Copying...';
      btn.disabled = true;
      
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/seed-golden/copy-templates`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            tradeCategoryKey: 'hvac_residential'
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          btn.innerHTML = `<i class="fas fa-check"></i> Copied ${result.summary?.copied || 0} flows!`;
          btn.style.background = '#22c55e';
          
          // Show toast
          showSnapshotToast(`âœ… ${result.summary?.copied || 0} templates copied to company. ${result.summary?.skipped || 0} already existed.`, 'success');
          
          // Refresh badge
          setTimeout(loadSnapshotBadge, 500);
        } else {
          btn.innerHTML = `<i class="fas fa-times"></i> Failed`;
          btn.style.background = '#dc2626';
          showSnapshotToast(`âŒ Copy failed: ${result.error}`, 'error');
        }
        
      } catch (error) {
        console.error('[COPY TEMPLATES] Error:', error);
        btn.innerHTML = `<i class="fas fa-times"></i> Error`;
        btn.style.background = '#dc2626';
        showSnapshotToast(`âŒ Copy failed: ${error.message}`, 'error');
      }
    }
    
    async function executeGoldenSetup() {
      // Show loading
      document.getElementById('golden-confirm-view').style.display = 'none';
      document.getElementById('golden-loading-view').style.display = 'block';
      document.getElementById('golden-result-view').style.display = 'none';
      
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/seed-golden`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            profile: 'penguin_air',
            tradeCategoryKey: 'hvac_residential'
          })
        });
        
        const result = await response.json();
        
        // Show result
        document.getElementById('golden-loading-view').style.display = 'none';
        document.getElementById('golden-result-view').style.display = 'block';
        
        const resultContent = document.getElementById('golden-result-content');
        
        if (result.success) {
          const hasTemplates = result.templatesSeeded > 0;
          resultContent.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 64px; margin-bottom: 16px;">âœ…</div>
              <h3 style="margin: 0 0 8px; font-size: 20px; font-weight: 600; color: #059669;">Golden Setup Complete!</h3>
              <p style="color: #64748b; margin: 0 0 24px;">Completed in ${result.duration}ms</p>
            </div>
            
            <div style="background: #f0fdf4; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #166534;">Config Applied:</h4>
              <div style="font-size: 13px; color: #15803d; line-height: 1.8;">
                ${result.actions.filter(a => a.section !== 'dynamicFlowTemplates').map(a => `<div>âœ“ ${a.section}</div>`).join('')}
              </div>
            </div>
            
            ${hasTemplates ? `
              <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <h4 style="margin: 0 0 8px; font-size: 14px; font-weight: 600; color: #92400e;">ğŸ“‹ Templates Seeded: ${result.templatesSeeded}</h4>
                <p style="font-size: 13px; color: #78350f; margin: 0 0 12px;">
                  Templates are now available globally. To activate them for this company:
                </p>
                <button onclick="copyTemplatesToCompany()" 
                        style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-copy"></i> Copy Templates to This Company
                </button>
              </div>
            ` : ''}
            
            ${result.warnings.length > 0 ? `
              <div style="background: #fef3c7; border-radius: 8px; padding: 12px;">
                <strong style="color: #92400e;">Notes:</strong>
                <div style="font-size: 13px; color: #92400e; margin-top: 8px;">
                  ${result.warnings.map(w => `<div>â„¹ï¸ ${w}</div>`).join('')}
                </div>
              </div>
            ` : ''}
          `;
          
          // Refresh the snapshot badge
          setTimeout(loadSnapshotBadge, 500);
        } else {
          resultContent.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 64px; margin-bottom: 16px;">âŒ</div>
              <h3 style="margin: 0 0 8px; font-size: 20px; font-weight: 600; color: #dc2626;">Setup Failed</h3>
              <p style="color: #64748b; margin: 0 0 24px;">${result.error || 'Unknown error'}</p>
            </div>
            
            ${result.errors?.length > 0 ? `
              <div style="background: #fef2f2; border-radius: 8px; padding: 12px;">
                <strong style="color: #dc2626;">Errors:</strong>
                <div style="font-size: 13px; color: #dc2626; margin-top: 8px;">
                  ${result.errors.map(e => `<div>â€¢ ${e.section}: ${e.error}</div>`).join('')}
                </div>
              </div>
            ` : ''}
          `;
        }
        
      } catch (error) {
        console.error('[GOLDEN] Setup failed:', error);
        
        document.getElementById('golden-loading-view').style.display = 'none';
        document.getElementById('golden-result-view').style.display = 'block';
        
        document.getElementById('golden-result-content').innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 64px; margin-bottom: 16px;">âŒ</div>
            <h3 style="margin: 0 0 8px; font-size: 20px; font-weight: 600; color: #dc2626;">Request Failed</h3>
            <p style="color: #64748b; margin: 0;">${error.message}</p>
          </div>
        `;
      }
    }
  </script>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EXPORT CONFIG MODAL (ChatGPT Workflow)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="export-modal-overlay" class="snapshot-modal-overlay" onclick="if(event.target === this) closeExportModal()">
    <div class="snapshot-modal" style="max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
      
      <div class="snapshot-modal-header" style="background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);">
        <div class="snapshot-modal-title">
          <h2 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸ“¤ Export Config for ChatGPT Analysis</h2>
          <span id="export-status-badge" class="snapshot-status-badge" style="display: none;"></span>
        </div>
        <div class="snapshot-modal-controls">
          <button onclick="closeExportModal()" 
                  style="padding: 8px 16px; background: transparent; color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-weight: 500;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="snapshot-modal-body" style="padding: 24px; overflow-y: auto; flex: 1;">
        
        <div style="margin-bottom: 20px; background: #f0f9ff; border-radius: 8px; padding: 16px;">
          <h3 style="margin: 0 0 8px; font-size: 14px; font-weight: 600; color: #0369a1;">How to use:</h3>
          <ol style="margin: 0; padding-left: 20px; font-size: 13px; color: #0c4a6e; line-height: 1.8;">
            <li>Click <strong>"Load Export"</strong> to fetch full company config</li>
            <li>Click <strong>"Copy JSON"</strong> to copy to clipboard</li>
            <li>Paste into ChatGPT with your analysis prompt</li>
            <li>Get ChatGPT's JSON patch directive â†’ use "Apply Patch" modal</li>
          </ol>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
          <button onclick="loadExportData()" id="btn-load-export"
                  style="padding: 10px 20px; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-download"></i> Load Export
          </button>
          <button onclick="copyExportToClipboard()" id="btn-copy-export"
                  style="padding: 10px 20px; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 8px;" disabled>
            <i class="fas fa-copy"></i> Copy JSON
          </button>
          <button onclick="downloadExportAsJson()" id="btn-download-export"
                  style="padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 8px;" disabled>
            <i class="fas fa-file-download"></i> Download .json
          </button>
        </div>
        
        <div id="export-stats" style="display: none; background: #f1f5f9; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
            <div style="text-align: center;">
              <div id="stat-categories" style="font-size: 24px; font-weight: 700; color: #0ea5e9;">-</div>
              <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">Categories</div>
            </div>
            <div style="text-align: center;">
              <div id="stat-scenarios" style="font-size: 24px; font-weight: 700; color: #059669;">-</div>
              <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">Scenarios</div>
            </div>
            <div style="text-align: center;">
              <div id="stat-triggers" style="font-size: 24px; font-weight: 700; color: #f59e0b;">-</div>
              <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">Triggers</div>
            </div>
            <div style="text-align: center;">
              <div id="stat-flows" style="font-size: 24px; font-weight: 700; color: #8b5cf6;">-</div>
              <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">Flows</div>
            </div>
          </div>
        </div>
        
        <div style="position: relative;">
          <textarea id="export-json-output" readonly
                    style="width: 100%; height: 400px; font-family: 'SF Mono', Monaco, monospace; font-size: 11px; background: #1e293b; color: #a5f3fc; border: none; border-radius: 8px; padding: 16px; resize: vertical;"
                    placeholder="Click 'Load Export' to fetch company configuration..."></textarea>
        </div>
        
      </div>
    </div>
  </div>
  
  <script>
    let currentExportData = null;
    
    function openExportModal() {
      document.getElementById('export-modal-overlay').classList.add('active');
    }
    
    function closeExportModal() {
      document.getElementById('export-modal-overlay').classList.remove('active');
    }
    
    async function loadExportData() {
      const btn = document.getElementById('btn-load-export');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
      btn.disabled = true;
      
      try {
        const response = await fetch(`/api/export/company/${currentCompanyId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          currentExportData = result.export;
          
          // Update stats (prefer summary object if available)
          document.getElementById('export-stats').style.display = 'block';
          const summary = currentExportData.summary || {};
          document.getElementById('stat-categories').textContent = summary.categoriesCount ?? currentExportData.categories?.length ?? 0;
          document.getElementById('stat-scenarios').textContent = summary.scenariosCount ?? currentExportData.scenarios?.length ?? 0;
          document.getElementById('stat-triggers').textContent = summary.totalTriggers ?? (currentExportData.scenarios || []).reduce((sum, s) => sum + (s.triggers?.length || 0), 0);
          document.getElementById('stat-flows').textContent = summary.dynamicFlowsCount ?? currentExportData.dynamicFlows?.length ?? 0;
          
          console.log('[EXPORT] Summary:', summary);
          
          // Show JSON
          document.getElementById('export-json-output').value = JSON.stringify(currentExportData, null, 2);
          
          // Enable copy and download buttons
          document.getElementById('btn-copy-export').disabled = false;
          document.getElementById('btn-download-export').disabled = false;
          
          btn.innerHTML = '<i class="fas fa-check"></i> Loaded!';
          btn.style.background = '#059669';
          
          showSnapshotToast('âœ… Export loaded - ' + (currentExportData.scenarios?.length || 0) + ' scenarios', 'success');
        } else {
          throw new Error(result.error);
        }
        
      } catch (error) {
        console.error('[EXPORT] Error:', error);
        btn.innerHTML = '<i class="fas fa-times"></i> Error';
        btn.style.background = '#dc2626';
        showSnapshotToast('âŒ Export failed: ' + error.message, 'error');
      }
      
      setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-download"></i> Load Export';
        btn.style.background = '#0ea5e9';
        btn.disabled = false;
      }, 2000);
    }
    
    async function copyExportToClipboard() {
      if (!currentExportData) return;
      
      try {
        await navigator.clipboard.writeText(JSON.stringify(currentExportData, null, 2));
        showSnapshotToast('âœ… Copied to clipboard! Paste into ChatGPT.', 'success');
      } catch (error) {
        showSnapshotToast('âŒ Copy failed: ' + error.message, 'error');
      }
    }
    
    function downloadExportAsJson() {
      if (!currentExportData) return;
      
      try {
        // Create filename with company name and timestamp
        const companyName = currentExportData.company?.companyName || 'export';
        const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
        const filename = `${companyName.replace(/\s+/g, '-').toLowerCase()}-config-${timestamp}.json`;
        
        // Create blob and download link
        const jsonString = JSON.stringify(currentExportData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Trigger download
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Calculate file size
        const sizeKB = (jsonString.length / 1024).toFixed(1);
        const scenarioCount = currentExportData.scenarios?.length || 0;
        
        showSnapshotToast(`âœ… Downloaded ${filename} (${sizeKB} KB, ${scenarioCount} scenarios)`, 'success');
      } catch (error) {
        showSnapshotToast('âŒ Download failed: ' + error.message, 'error');
      }
    }
  </script>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       APPLY PATCH MODAL (ChatGPT Workflow)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="patch-modal-overlay" class="snapshot-modal-overlay" onclick="if(event.target === this) closeApplyPatchModal()">
    <div class="snapshot-modal" style="max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
      
      <div class="snapshot-modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
        <div class="snapshot-modal-title">
          <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #1e293b;">ğŸ“¥ Apply JSON Patch from ChatGPT</h2>
        </div>
        <div class="snapshot-modal-controls">
          <button onclick="closeApplyPatchModal()" 
                  style="padding: 8px 16px; background: transparent; color: #1e293b; border: 1px solid rgba(0,0,0,0.2); border-radius: 6px; cursor: pointer; font-weight: 500;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="snapshot-modal-body" style="padding: 24px; overflow-y: auto; flex: 1;">
        
        <div style="margin-bottom: 20px; background: #fffbeb; border-radius: 8px; padding: 16px;">
          <h3 style="margin: 0 0 8px; font-size: 14px; font-weight: 600; color: #92400e;">âš ï¸ Admin Only - Modifies Database</h3>
          <p style="margin: 0; font-size: 13px; color: #78350f; line-height: 1.6;">
            Paste the JSON patch from ChatGPT. Click "Preview" first to see what will change, then "Apply" to execute.
          </p>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; display: block; margin-bottom: 8px;">Patch JSON:</label>
          <textarea id="patch-json-input"
                    style="width: 100%; height: 300px; font-family: 'SF Mono', Monaco, monospace; font-size: 11px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 12px; resize: vertical;"
                    placeholder='Paste JSON patch here. Example:
{
  "patchType": "template",
  "targetId": "template_id_here",
  "operations": [
    {
      "op": "update",
      "path": "scenario",
      "categoryId": "cat_1",
      "scenarioId": "scenario_1",
      "value": {
        "triggers": ["new trigger", "another trigger"],
        "quickReplies": ["Reply 1", "Reply 2", ...]
      }
    }
  ]
}'></textarea>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
          <button onclick="previewPatch()" id="btn-preview-patch"
                  style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-search"></i> Preview Changes
          </button>
          <button onclick="applyPatch()" id="btn-apply-patch-confirm"
                  style="padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 8px;" disabled>
            <i class="fas fa-bolt"></i> Apply Patch
          </button>
        </div>
        
        <div id="patch-preview" style="display: none; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #166534;">Preview:</h4>
          <div id="patch-preview-content" style="font-size: 13px; color: #15803d; line-height: 1.8;"></div>
        </div>
        
        <div id="patch-result" style="display: none; background: #f8fafc; border-radius: 8px; padding: 16px;">
          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #374151;">Result:</h4>
          <pre id="patch-result-content" style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; background: #1e293b; color: #a5f3fc; padding: 12px; border-radius: 6px; overflow-x: auto;"></pre>
        </div>
        
      </div>
    </div>
  </div>
  
  <script>
    function openApplyPatchModal() {
      document.getElementById('patch-modal-overlay').classList.add('active');
      document.getElementById('patch-preview').style.display = 'none';
      document.getElementById('patch-result').style.display = 'none';
      document.getElementById('btn-apply-patch-confirm').disabled = true;
    }
    
    function closeApplyPatchModal() {
      document.getElementById('patch-modal-overlay').classList.remove('active');
    }
    
    async function previewPatch() {
      const patchInput = document.getElementById('patch-json-input').value.trim();
      
      if (!patchInput) {
        showSnapshotToast('âŒ Please paste a JSON patch first', 'error');
        return;
      }
      
      let patch;
      try {
        patch = JSON.parse(patchInput);
      } catch (e) {
        showSnapshotToast('âŒ Invalid JSON: ' + e.message, 'error');
        return;
      }
      
      const btn = document.getElementById('btn-preview-patch');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
      btn.disabled = true;
      
      try {
        const response = await fetch('/api/export/apply-patch', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ patch, dryRun: true })
        });
        
        const result = await response.json();
        
        if (result.success) {
          const diff = result.diff;
          document.getElementById('patch-preview').style.display = 'block';
          document.getElementById('patch-preview-content').innerHTML = `
            <div>âœ… Patch is valid</div>
            <div>ğŸ“ Creates: ${diff.creates}</div>
            <div>ğŸ“ Updates: ${diff.updates}</div>
            <div>ğŸ“ Deletes: ${diff.deletes}</div>
            <div>ğŸ¯ Affected IDs: ${diff.affectedIds.join(', ') || 'none'}</div>
          `;
          
          // Enable apply button
          document.getElementById('btn-apply-patch-confirm').disabled = false;
          
          showSnapshotToast('âœ… Patch validated - ready to apply', 'success');
        } else {
          throw new Error(result.error + (result.validationErrors ? ': ' + result.validationErrors.join(', ') : ''));
        }
        
      } catch (error) {
        console.error('[PATCH] Preview error:', error);
        showSnapshotToast('âŒ Validation failed: ' + error.message, 'error');
        document.getElementById('patch-preview').style.display = 'none';
        document.getElementById('btn-apply-patch-confirm').disabled = true;
      }
      
      btn.innerHTML = '<i class="fas fa-search"></i> Preview Changes';
      btn.disabled = false;
    }
    
    async function applyPatch() {
      const patchInput = document.getElementById('patch-json-input').value.trim();
      
      let patch;
      try {
        patch = JSON.parse(patchInput);
      } catch (e) {
        showSnapshotToast('âŒ Invalid JSON: ' + e.message, 'error');
        return;
      }
      
      // Confirm
      if (!confirm('Are you sure you want to apply this patch? This will modify the database.')) {
        return;
      }
      
      const btn = document.getElementById('btn-apply-patch-confirm');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Applying...';
      btn.disabled = true;
      
      try {
        const response = await fetch('/api/export/apply-patch', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ patch, dryRun: false })
        });
        
        const result = await response.json();
        
        document.getElementById('patch-result').style.display = 'block';
        document.getElementById('patch-result-content').textContent = JSON.stringify(result, null, 2);
        
        if (result.success) {
          btn.innerHTML = '<i class="fas fa-check"></i> Applied!';
          btn.style.background = '#059669';
          showSnapshotToast('âœ… Patch applied successfully!', 'success');
          
          // Refresh snapshot badge
          setTimeout(loadSnapshotBadge, 500);
        } else {
          throw new Error(result.error);
        }
        
      } catch (error) {
        console.error('[PATCH] Apply error:', error);
        btn.innerHTML = '<i class="fas fa-times"></i> Failed';
        btn.style.background = '#dc2626';
        showSnapshotToast('âŒ Apply failed: ' + error.message, 'error');
      }
      
      setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-bolt"></i> Apply Patch';
        btn.style.background = '#dc2626';
        btn.disabled = true;
      }, 3000);
    }
  </script>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       VALIDATOR PANEL (Phase D)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="validator-modal-overlay" class="snapshot-modal-overlay" onclick="if(event.target === this) closeValidatorModal()">
    <div class="snapshot-modal" style="max-width: 950px; max-height: 90vh; display: flex; flex-direction: column;">
      
      <div class="snapshot-modal-header" style="background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);">
        <div class="snapshot-modal-title">
          <h2 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸ” Scenario Validator</h2>
        </div>
        <div class="snapshot-modal-controls">
          <button onclick="closeValidatorModal()" 
                  style="padding: 8px 16px; background: transparent; color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-weight: 500;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="snapshot-modal-body" style="padding: 24px; overflow-y: auto; flex: 1;">
        
        <div style="margin-bottom: 20px;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; display: block; margin-bottom: 8px;">Template ID:</label>
          <div style="display: flex; gap: 12px;">
            <input type="text" id="validator-template-id" 
                   style="flex: 1; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px;"
                   placeholder="Enter template ID to validate">
            <button onclick="runValidation()" id="btn-run-validation"
                    style="padding: 10px 20px; background: #ec4899; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
              <i class="fas fa-play"></i> Validate
            </button>
          </div>
        </div>
        
        <div id="validation-results" style="display: none;">
          <div id="validation-summary" style="background: #f1f5f9; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          </div>
          
          <div id="validation-issues" style="margin-bottom: 16px;">
          </div>
          
          <div id="validation-scenarios">
          </div>
        </div>
        
      </div>
    </div>
  </div>
  
  <script>
    function openValidatorModal() {
      document.getElementById('validator-modal-overlay').classList.add('active');
    }
    
    function closeValidatorModal() {
      document.getElementById('validator-modal-overlay').classList.remove('active');
    }
    
    async function runValidation() {
      const templateId = document.getElementById('validator-template-id').value.trim();
      
      if (!templateId) {
        showSnapshotToast('âŒ Please enter a template ID', 'error');
        return;
      }
      
      const btn = document.getElementById('btn-run-validation');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';
      btn.disabled = true;
      
      try {
        const response = await fetch(`/api/export/validate/template/${templateId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          document.getElementById('validation-results').style.display = 'block';
          
          // Summary
          const summary = result.summary;
          const summaryColor = summary.errorCount === 0 ? '#059669' : '#dc2626';
          document.getElementById('validation-summary').innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; text-align: center;">
              <div>
                <div style="font-size: 28px; font-weight: 700; color: #0ea5e9;">${summary.categoryCount}</div>
                <div style="font-size: 11px; color: #64748b;">Categories</div>
              </div>
              <div>
                <div style="font-size: 28px; font-weight: 700; color: #8b5cf6;">${summary.scenarioCount}</div>
                <div style="font-size: 11px; color: #64748b;">Scenarios</div>
              </div>
              <div>
                <div style="font-size: 28px; font-weight: 700; color: #dc2626;">${summary.errorCount}</div>
                <div style="font-size: 11px; color: #64748b;">Errors</div>
              </div>
              <div>
                <div style="font-size: 28px; font-weight: 700; color: #f59e0b;">${summary.warningCount}</div>
                <div style="font-size: 11px; color: #64748b;">Warnings</div>
              </div>
              <div>
                <div style="font-size: 28px; font-weight: 700; color: ${summaryColor};">${summary.valid ? 'âœ…' : 'âŒ'}</div>
                <div style="font-size: 11px; color: #64748b;">${summary.valid ? 'Valid' : 'Invalid'}</div>
              </div>
            </div>
          `;
          
          // Issues
          if (result.issues.length > 0) {
            document.getElementById('validation-issues').innerHTML = `
              <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #dc2626;">âš ï¸ Issues Found:</h4>
              ${result.issues.map(i => `
                <div style="background: ${i.severity === 'error' ? '#fef2f2' : '#fffbeb'}; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                  <strong style="color: ${i.severity === 'error' ? '#dc2626' : '#f59e0b'};">${i.type}</strong>
                  <div style="font-size: 13px; margin-top: 4px;">${i.message}</div>
                </div>
              `).join('')}
            `;
          } else {
            document.getElementById('validation-issues').innerHTML = '';
          }
          
          // Scenario details (show issues only)
          const problemScenarios = result.scenarios.filter(s => !s.valid || s.warnings.length > 0);
          if (problemScenarios.length > 0) {
            document.getElementById('validation-scenarios').innerHTML = `
              <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #374151;">ğŸ“‹ Scenarios Needing Attention:</h4>
              <div style="max-height: 300px; overflow-y: auto;">
                ${problemScenarios.map(s => `
                  <div style="background: #f8fafc; border-radius: 6px; padding: 12px; margin-bottom: 8px; border-left: 4px solid ${s.valid ? '#f59e0b' : '#dc2626'};">
                    <strong>${s.name}</strong> <span style="font-size: 11px; color: #64748b;">(${s.scenarioId})</span>
                    <div style="font-size: 12px; margin-top: 6px;">
                      ${s.issues.map(i => `<div style="color: ${i.severity === 'error' ? '#dc2626' : '#f59e0b'};">â€¢ ${i.message}</div>`).join('')}
                      ${s.warnings.map(w => `<div style="color: #f59e0b;">â€¢ ${w.message}</div>`).join('')}
                    </div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 6px;">
                      Triggers: ${s.stats.triggerCount} | Quick: ${s.stats.quickReplyCount} | Full: ${s.stats.fullReplyCount}
                    </div>
                  </div>
                `).join('')}
              </div>
            `;
          } else {
            document.getElementById('validation-scenarios').innerHTML = `
              <div style="text-align: center; padding: 20px; color: #059669;">
                <div style="font-size: 48px; margin-bottom: 8px;">âœ…</div>
                <div>All scenarios pass validation!</div>
              </div>
            `;
          }
          
          showSnapshotToast(`Validation complete: ${summary.errorCount} errors, ${summary.warningCount} warnings`, summary.errorCount > 0 ? 'error' : 'success');
        } else {
          throw new Error(result.error);
        }
        
      } catch (error) {
        console.error('[VALIDATION] Error:', error);
        showSnapshotToast('âŒ Validation failed: ' + error.message, 'error');
      }
      
      btn.innerHTML = '<i class="fas fa-play"></i> Validate';
      btn.disabled = false;
    }
  </script>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FIELD REPORT MODAL (Schema vs UI Analysis)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="field-report-modal-overlay" class="snapshot-modal-overlay" onclick="if(event.target === this) closeFieldReportModal()">
    <div class="snapshot-modal" style="max-width: 1100px; max-height: 95vh; display: flex; flex-direction: column;">
      
      <div class="snapshot-modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);">
        <div class="snapshot-modal-title">
          <h2 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸ“‹ Field Report (Schema vs UI)</h2>
        </div>
        <div class="snapshot-modal-controls" style="display: flex; gap: 8px;">
          <button onclick="copyFieldReport()" id="btn-copy-field-report"
                  style="padding: 8px 16px; background: white; color: #6366f1; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
            <i class="fas fa-copy"></i> Copy JSON
          </button>
          <button onclick="downloadFieldReport()" 
                  style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
            <i class="fas fa-download"></i> Download
          </button>
          <button onclick="closeFieldReportModal()" 
                  style="padding: 8px 16px; background: transparent; color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-weight: 500;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="snapshot-modal-body" style="padding: 24px; overflow-y: auto; flex: 1;">
        <!-- Summary Stats -->
        <div id="field-report-summary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
          <div style="background: #f0fdf4; border-radius: 8px; padding: 16px; text-align: center;">
            <div id="fr-total" style="font-size: 32px; font-weight: 700; color: #059669;">--</div>
            <div style="font-size: 12px; color: #064e3b;">Total Fields</div>
          </div>
          <div style="background: #eff6ff; border-radius: 8px; padding: 16px; text-align: center;">
            <div id="fr-exposed" style="font-size: 32px; font-weight: 700; color: #2563eb;">--</div>
            <div style="font-size: 12px; color: #1e3a8a;">Exposed in UI</div>
          </div>
          <div style="background: #fef3c7; border-radius: 8px; padding: 16px; text-align: center;">
            <div id="fr-hidden" style="font-size: 32px; font-weight: 700; color: #d97706;">--</div>
            <div style="font-size: 12px; color: #92400e;">Hidden</div>
          </div>
          <div style="background: #fef2f2; border-radius: 8px; padding: 16px; text-align: center;">
            <div id="fr-deprecated" style="font-size: 32px; font-weight: 700; color: #dc2626;">--</div>
            <div style="font-size: 12px; color: #7f1d1d;">Deprecated</div>
          </div>
        </div>
        
        <!-- Report JSON -->
        <pre id="field-report-json" style="background: #1e293b; color: #e2e8f0; padding: 20px; border-radius: 8px; font-size: 12px; overflow: auto; max-height: 500px; white-space: pre-wrap; word-break: break-word;">
Loading field report...
        </pre>
      </div>
    </div>
  </div>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RUNTIME TRUTH MODAL - THE Single JSON That Shows Everything
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="runtime-truth-modal-overlay" class="snapshot-modal-overlay">
    <div class="snapshot-modal" style="max-width: 1200px;">
      <div class="snapshot-modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        <div class="snapshot-modal-title">
          <h2 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸ¯ Runtime Truth - What Actually Runs</h2>
          <p style="margin: 4px 0 0; font-size: 12px; opacity: 0.9;">If it's not in this JSON, it doesn't exist at runtime</p>
        </div>
        <div class="snapshot-modal-controls" style="display: flex; gap: 8px; align-items: center;">
          <span id="runtime-truth-status" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;"></span>
          <span id="runtime-truth-version" style="color: rgba(255,255,255,0.7); font-size: 10px; font-family: monospace;"></span>
          <button id="btn-copy-runtime-truth" onclick="copyRuntimeTruth()" style="padding: 8px 16px; background: white; color: #059669; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-copy"></i> Copy JSON
          </button>
          <button onclick="closeRuntimeTruthModal()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <!-- Tab Navigation -->
      <div style="background: #1e293b; padding: 0 20px; display: flex; gap: 0; border-bottom: 2px solid #334155;">
        <button onclick="switchRuntimeTruthTab('overview')" id="rt-tab-overview" class="rt-tab active" style="padding: 12px 20px; background: transparent; border: none; color: white; font-weight: 600; font-size: 13px; cursor: pointer; border-bottom: 3px solid #10b981; margin-bottom: -2px;">
          ğŸ“Š Overview
        </button>
        <button onclick="switchRuntimeTruthTab('wiring')" id="rt-tab-wiring" class="rt-tab" style="padding: 12px 20px; background: transparent; border: none; color: #94a3b8; font-weight: 600; font-size: 13px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px;">
          ğŸ”Œ Scenario Wiring
        </button>
        <button onclick="switchRuntimeTruthTab('booking')" id="rt-tab-booking" class="rt-tab" style="padding: 12px 20px; background: transparent; border: none; color: #94a3b8; font-weight: 600; font-size: 13px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px;">
          ğŸ“… Booking
        </button>
        <button onclick="switchRuntimeTruthTab('json')" id="rt-tab-json" class="rt-tab" style="padding: 12px 20px; background: transparent; border: none; color: #94a3b8; font-weight: 600; font-size: 13px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px;">
          { } JSON
        </button>
      </div>
      
      <div class="snapshot-modal-body" style="padding: 20px; max-height: 70vh; overflow-y: auto;">
        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             TAB: OVERVIEW
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="rt-content-overview" class="rt-tab-content">
          <!-- Last Write Stamp -->
          <div id="runtime-truth-last-write" style="background: #0f172a; border-radius: 8px; padding: 10px 16px; margin-bottom: 16px; display: flex; gap: 24px; font-size: 11px; color: #64748b;">
            <span><strong>Version:</strong> <code id="rt-version-display" style="color: #22d3ee;">--</code></span>
            <span><strong>Generated:</strong> <span id="rt-generated-at">--</span></span>
            <span><strong>Last Patch:</strong> <span id="rt-last-patch">Never</span></span>
          </div>
          
          <!-- Summary Cards -->
          <div id="runtime-truth-summary" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 20px;"></div>
          
          <!-- Issues Panel -->
          <div id="runtime-truth-issues" style="margin-bottom: 20px;"></div>
          
          <!-- Dynamic Flow Toggle Panel -->
          <div id="runtime-truth-flows" style="background: #1e293b; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <h4 style="margin: 0; color: #f1f5f9; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                <span>âš¡</span> Dynamic Flows (Toggle ON/OFF)
              </h4>
              <span id="flows-enabled-count" style="color: #94a3b8; font-size: 12px;"></span>
            </div>
            <div id="flows-toggle-list" style="display: flex; flex-direction: column; gap: 8px;">
              <!-- Flow toggles will be rendered here -->
            </div>
          </div>
        </div>
        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             TAB: SCENARIO WIRING
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="rt-content-wiring" class="rt-tab-content" style="display: none;">
          <!-- Bulk Actions -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
            <button onclick="fixUnknownScenarioTypes()" style="padding: 10px 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-magic"></i> Fix UNKNOWN Types
            </button>
            <button onclick="wireSelectedToFlow()" style="padding: 10px 16px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-link"></i> Wire Selected to Flow
            </button>
            <select id="bulk-flow-select" style="padding: 10px 12px; border: 1px solid #334155; border-radius: 8px; background: #1e293b; color: #f1f5f9; font-size: 12px;">
              <option value="">-- Select Flow --</option>
            </select>
            <span id="wiring-selected-count" style="color: #94a3b8; font-size: 12px; margin-left: auto;">0 selected</span>
          </div>
          
          <!-- Wiring Table -->
          <div style="background: #0f172a; border-radius: 12px; overflow: hidden;">
            <div style="overflow-x: auto;">
              <table id="scenario-wiring-table" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead>
                  <tr style="background: #1e293b;">
                    <th style="padding: 12px 8px; text-align: left; color: #94a3b8; font-weight: 600; border-bottom: 1px solid #334155;">
                      <input type="checkbox" id="select-all-scenarios" onchange="toggleAllScenarios(this.checked)" style="accent-color: #10b981;">
                    </th>
                    <th style="padding: 12px 8px; text-align: left; color: #94a3b8; font-weight: 600; border-bottom: 1px solid #334155;">Scenario</th>
                    <th style="padding: 12px 8px; text-align: left; color: #94a3b8; font-weight: 600; border-bottom: 1px solid #334155;">Type</th>
                    <th style="padding: 12px 8px; text-align: left; color: #94a3b8; font-weight: 600; border-bottom: 1px solid #334155;">Action</th>
                    <th style="padding: 12px 8px; text-align: left; color: #94a3b8; font-weight: 600; border-bottom: 1px solid #334155;">Flow ID</th>
                    <th style="padding: 12px 8px; text-align: center; color: #94a3b8; font-weight: 600; border-bottom: 1px solid #334155;">Book?</th>
                    <th style="padding: 12px 8px; text-align: left; color: #94a3b8; font-weight: 600; border-bottom: 1px solid #334155;">Transfer</th>
                    <th style="padding: 12px 8px; text-align: center; color: #94a3b8; font-weight: 600; border-bottom: 1px solid #334155;">Priority</th>
                    <th style="padding: 12px 8px; text-align: left; color: #94a3b8; font-weight: 600; border-bottom: 1px solid #334155;">Status</th>
                  </tr>
                </thead>
                <tbody id="scenario-wiring-body">
                  <!-- Scenarios will be rendered here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             TAB: BOOKING
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="rt-content-booking" class="rt-tab-content" style="display: none;">
          <!-- Master Toggle -->
          <div style="background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h4 style="margin: 0 0 4px 0; color: #f1f5f9; font-size: 16px;">ğŸ“… Booking System</h4>
                <p style="margin: 0; color: #94a3b8; font-size: 12px;">Enable to collect appointment details from callers</p>
              </div>
              <label style="position: relative; display: inline-block; width: 60px; height: 32px;">
                <input type="checkbox" id="booking-enabled-toggle" onchange="toggleBookingEnabled(this.checked)" style="opacity: 0; width: 0; height: 0;">
                <span id="booking-toggle-track" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #475569; transition: 0.3s; border-radius: 32px;">
                  <span id="booking-toggle-thumb" style="position: absolute; content: ''; height: 26px; width: 26px; left: 3px; bottom: 3px; background: white; transition: 0.3s; border-radius: 50%;"></span>
                </span>
              </label>
            </div>
          </div>
          
          <!-- Required Fields -->
          <div style="background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 16px 0; color: #f1f5f9; font-size: 14px;">ğŸ“ Required Fields</h4>
            <div id="booking-fields-list" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
              <!-- Fields will be rendered here -->
            </div>
          </div>
          
          <!-- Time Windows -->
          <div style="background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0; color: #f1f5f9; font-size: 14px;">â° Time Windows</h4>
              <button onclick="addTimeWindow()" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;">
                <i class="fas fa-plus"></i> Add Window
              </button>
            </div>
            <div id="booking-time-windows" style="display: flex; flex-wrap: wrap; gap: 8px;">
              <!-- Time windows will be rendered here -->
            </div>
          </div>
          
          <!-- Consent Rules -->
          <div style="background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 16px 0; color: #f1f5f9; font-size: 14px;">âœ… Consent & Confirmation</h4>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label style="display: flex; align-items: center; gap: 12px; color: #f1f5f9; font-size: 13px;">
                <input type="checkbox" id="consent-sms" onchange="updateConsentSetting('smsConsent', this.checked)" style="accent-color: #10b981; width: 18px; height: 18px;">
                SMS Text Consent Required
              </label>
              <label style="display: flex; align-items: center; gap: 12px; color: #f1f5f9; font-size: 13px;">
                <input type="checkbox" id="consent-confirm-name" onchange="updateConsentSetting('confirmName', this.checked)" style="accent-color: #10b981; width: 18px; height: 18px;">
                Confirm Name (repeat back first + last)
              </label>
              <label style="display: flex; align-items: center; gap: 12px; color: #f1f5f9; font-size: 13px;">
                <input type="checkbox" id="consent-confirm-address" onchange="updateConsentSetting('confirmAddress', this.checked)" style="accent-color: #10b981; width: 18px; height: 18px;">
                Confirm Address (street/city/unit)
              </label>
              <label style="display: flex; align-items: center; gap: 12px; color: #f1f5f9; font-size: 13px;">
                <input type="checkbox" id="consent-confirm-phone" onchange="updateConsentSetting('confirmPhone', this.checked)" style="accent-color: #10b981; width: 18px; height: 18px;">
                Confirm Phone (repeat back number)
              </label>
            </div>
            <div style="margin-top: 16px;">
              <label style="display: block; color: #94a3b8; font-size: 12px; margin-bottom: 8px;">Consent Script (read to caller)</label>
              <textarea id="consent-script" onchange="updateConsentScript(this.value)" style="width: 100%; height: 80px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 12px; color: #f1f5f9; font-size: 12px; resize: vertical;" placeholder="I'll send you a text confirmation. Is that okay?"></textarea>
            </div>
          </div>
          
          <!-- Booking Health -->
          <div id="booking-health-panel" style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 12px; padding: 16px; display: none;">
            <h4 style="margin: 0 0 8px 0; color: #92400e; font-size: 14px;">âš ï¸ Booking Configuration Issues</h4>
            <ul id="booking-health-issues" style="margin: 0; padding-left: 20px; color: #92400e; font-size: 13px;">
            </ul>
          </div>
        </div>
        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             TAB: JSON
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="rt-content-json" class="rt-tab-content" style="display: none;">
          <div style="background: #0f172a; border-radius: 12px; overflow: hidden;">
            <div style="padding: 12px 16px; background: #1e293b; display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #94a3b8; font-weight: 600; font-size: 14px;">ğŸ“‹ Complete Runtime JSON</span>
              <span id="runtime-truth-size" style="color: #64748b; font-size: 12px;"></span>
            </div>
            <pre id="runtime-truth-json" style="margin: 0; padding: 16px; color: #22d3ee; font-size: 11px; line-height: 1.5; overflow-x: auto; max-height: 500px; overflow-y: auto;"></pre>
          </div>
        </div>
        
      </div>
    </div>
  </div>
  
  <script>
    // ============================================================================
    // RUNTIME TRUTH - THE Single Source of All Runtime Behavior
    // ============================================================================
    let currentRuntimeTruth = null;
    let selectedScenarios = new Set();
    let lastPatchTimestamp = null;
    
    // Enums for dropdowns
    const SCENARIO_TYPES = ['FAQ', 'TROUBLESHOOT', 'BOOKING', 'EMERGENCY', 'TRANSFER', 'SMALL_TALK', 'UNKNOWN'];
    const SCENARIO_ACTIONS = ['REPLY_ONLY', 'START_FLOW', 'ESCALATE_OR_BOOK', 'TRANSFER', 'REPLY_THEN_ASK', 'REPLY_THEN_OFFER_BOOK'];
    const BOOKING_FIELDS = [
      { key: 'firstName', label: 'First Name', required: true },
      { key: 'lastName', label: 'Last Name', required: true },
      { key: 'phone', label: 'Phone Number', required: true },
      { key: 'address', label: 'Address', required: false },
      { key: 'problemSummary', label: 'Problem Description', required: false },
      { key: 'timeWindow', label: 'Preferred Time', required: false }
    ];
    
    async function openRuntimeTruthModal() {
      document.getElementById('runtime-truth-modal-overlay').classList.add('active');
      await loadRuntimeTruth();
    }
    
    function closeRuntimeTruthModal() {
      document.getElementById('runtime-truth-modal-overlay').classList.remove('active');
    }
    
    // Tab switching
    function switchRuntimeTruthTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.rt-tab').forEach(tab => {
        tab.style.color = '#94a3b8';
        tab.style.borderBottomColor = 'transparent';
      });
      const activeTab = document.getElementById(`rt-tab-${tabName}`);
      if (activeTab) {
        activeTab.style.color = 'white';
        activeTab.style.borderBottomColor = '#10b981';
      }
      
      // Update content
      document.querySelectorAll('.rt-tab-content').forEach(content => {
        content.style.display = 'none';
      });
      const activeContent = document.getElementById(`rt-content-${tabName}`);
      if (activeContent) {
        activeContent.style.display = 'block';
      }
      
      // Load tab-specific content
      if (tabName === 'wiring' && currentRuntimeTruth) {
        renderScenarioWiringTable();
      } else if (tabName === 'booking' && currentRuntimeTruth) {
        renderBookingPanel();
      }
    }
    
    async function loadRuntimeTruth() {
      const summaryEl = document.getElementById('runtime-truth-summary');
      const issuesEl = document.getElementById('runtime-truth-issues');
      const jsonEl = document.getElementById('runtime-truth-json');
      const statusEl = document.getElementById('runtime-truth-status');
      const sizeEl = document.getElementById('runtime-truth-size');
      
      summaryEl.innerHTML = '<div style="grid-column: span 6; text-align: center; color: #94a3b8;"><i class="fas fa-spinner fa-spin"></i> Loading runtime truth...</div>';
      issuesEl.innerHTML = '';
      jsonEl.textContent = '';
      
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/runtime-truth`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to load');
        }
        
        currentRuntimeTruth = result.data;
        
        // Display version info
        const meta = result.data._meta || {};
        document.getElementById('runtime-truth-version').textContent = meta.version || '';
        document.getElementById('rt-version-display').textContent = meta.version || '--';
        document.getElementById('rt-generated-at').textContent = meta.generatedAt ? new Date(meta.generatedAt).toLocaleString() : '--';
        document.getElementById('rt-last-patch').textContent = lastPatchTimestamp ? new Date(lastPatchTimestamp).toLocaleString() : 'Never';
        
        // Status badge
        const health = result.data.health;
        const statusColors = {
          GREEN: { bg: '#10b981', text: 'white' },
          YELLOW: { bg: '#f59e0b', text: '#1e293b' },
          RED: { bg: '#ef4444', text: 'white' }
        };
        const statusColor = statusColors[health.status] || statusColors.RED;
        statusEl.style.background = statusColor.bg;
        statusEl.style.color = statusColor.text;
        statusEl.textContent = `${health.status} - ${health.criticalCount} errors, ${health.warningCount} warnings`;
        
        // Summary cards
        const sb = result.data.scenarioBrain;
        const df = result.data.dynamicFlows;
        const cp = result.data.controlPlane;
        
        // Safe access with defaults
        const totals = sb?.totals || { templates: 0, scenarios: 0, triggers: 0 };
        const greetingConfigured = cp?.greeting?.configured || false;
        const bookingSlots = cp?.booking?.slotsCount || 0;
        
        summaryEl.innerHTML = `
          <div style="background: #1e293b; padding: 14px; border-radius: 10px; text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: #60a5fa;">${totals.templates}</div>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">Templates</div>
          </div>
          <div style="background: #1e293b; padding: 14px; border-radius: 10px; text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: #34d399;">${totals.scenarios}</div>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">Scenarios</div>
          </div>
          <div style="background: #1e293b; padding: 14px; border-radius: 10px; text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: #fbbf24;">${totals.triggers}</div>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">Triggers</div>
          </div>
          <div style="background: #1e293b; padding: 14px; border-radius: 10px; text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: ${df?.enabled ? '#34d399' : '#ef4444'};">${df?.enabledCount || 0}/${df?.totalCount || 0}</div>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">Flows ${df?.enabled ? 'âœ“' : 'âš ï¸'}</div>
          </div>
          <div style="background: #1e293b; padding: 14px; border-radius: 10px; text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: ${greetingConfigured ? '#34d399' : '#ef4444'};">${greetingConfigured ? 'âœ“' : 'âœ—'}</div>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">Greeting</div>
          </div>
          <div style="background: #1e293b; padding: 14px; border-radius: 10px; text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: ${bookingSlots > 0 ? '#34d399' : '#f59e0b'};">${bookingSlots}</div>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">Booking Slots</div>
          </div>
        `;
        
        // Issues panel
        if (health.issues.length > 0) {
          issuesEl.innerHTML = `
            <div style="background: ${health.status === 'RED' ? '#fef2f2' : '#fffbeb'}; border: 1px solid ${health.status === 'RED' ? '#ef4444' : '#f59e0b'}; border-radius: 10px; padding: 16px;">
              <h4 style="margin: 0 0 12px 0; color: ${health.status === 'RED' ? '#991b1b' : '#92400e'}; font-size: 14px;">
                ${health.status === 'RED' ? 'ğŸš¨' : 'âš ï¸'} ${health.issues.length} Issue(s) Detected
              </h4>
              <ul style="margin: 0; padding-left: 20px; color: ${health.status === 'RED' ? '#991b1b' : '#92400e'}; font-size: 13px;">
                ${health.issues.map(i => `<li><strong>[${i.area}]</strong> ${i.message}</li>`).join('')}
              </ul>
            </div>
          `;
        } else {
          issuesEl.innerHTML = `
            <div style="background: #ecfdf5; border: 1px solid #10b981; border-radius: 10px; padding: 16px;">
              <span style="color: #065f46; font-size: 14px;">âœ… No issues - runtime is fully configured</span>
            </div>
          `;
        }
        
        // Render Dynamic Flow Toggles
        renderFlowToggles(result.data.dynamicFlows);
        
        // JSON output
        const jsonStr = JSON.stringify(result.data, null, 2);
        jsonEl.textContent = jsonStr;
        sizeEl.textContent = `${(jsonStr.length / 1024).toFixed(1)} KB | ${result.data._meta.generationTimeMs}ms`;
        
      } catch (error) {
        console.error('[RUNTIME TRUTH] Error:', error);
        summaryEl.innerHTML = `<div style="grid-column: span 6; text-align: center; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Failed to load: ${error.message}</div>`;
        statusEl.textContent = 'ERROR';
        statusEl.style.background = '#ef4444';
        statusEl.style.color = 'white';
      }
    }
    
    function copyRuntimeTruth() {
      if (!currentRuntimeTruth) {
        showSnapshotToast('No data to copy', 'error');
        return;
      }
      
      const jsonStr = JSON.stringify(currentRuntimeTruth, null, 2);
      navigator.clipboard.writeText(jsonStr).then(() => {
        const btn = document.getElementById('btn-copy-runtime-truth');
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.style.background = '#059669';
        btn.style.color = 'white';
        
        showSnapshotToast(`Runtime Truth copied! ${(jsonStr.length / 1024).toFixed(1)} KB`, 'success');
        
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-copy"></i> Copy JSON';
          btn.style.background = 'white';
          btn.style.color = '#059669';
        }, 2000);
      });
    }
    
    // ============================================================================
    // DYNAMIC FLOW TOGGLE CONTROLS
    // ============================================================================
    
    function renderFlowToggles(dynamicFlows) {
      const listEl = document.getElementById('flows-toggle-list');
      const countEl = document.getElementById('flows-enabled-count');
      
      const flows = dynamicFlows?.flows || [];
      const enabledCount = flows.filter(f => f.enabled).length;
      
      countEl.textContent = `${enabledCount}/${flows.length} enabled`;
      
      if (flows.length === 0) {
        listEl.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #94a3b8;">
            <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
            No dynamic flows configured. Create flows in the Dynamic Flow tab.
          </div>
        `;
        return;
      }
      
      listEl.innerHTML = flows.map(flow => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: ${flow.enabled ? '#064e3b' : '#1e293b'}; border: 1px solid ${flow.enabled ? '#10b981' : '#334155'}; border-radius: 8px; transition: all 0.2s;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: ${flow.enabled ? '#34d399' : '#94a3b8'}; font-weight: 600; font-size: 14px;">
                ${flow.enabled ? 'âœ“' : 'â—‹'} ${flow.name || flow.flowKey}
              </span>
              <span style="background: ${flow.enabled ? '#10b981' : '#475569'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">
                ${flow.enabled ? 'ENABLED' : 'DISABLED'}
              </span>
              <span style="color: #64748b; font-size: 11px;">
                Priority: ${flow.priority} | Triggers: ${flow.triggers?.reduce((sum, t) => sum + (t.phraseCount || 0), 0) || 0}
              </span>
            </div>
            <div style="color: #64748b; font-size: 11px; margin-top: 4px;">
              flowKey: <code style="background: #0f172a; padding: 2px 6px; border-radius: 4px; color: #22d3ee;">${flow.flowKey}</code>
              | ID: <code style="background: #0f172a; padding: 2px 6px; border-radius: 4px; color: #a5b4fc;">${flow.id}</code>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <label class="flow-toggle-switch" style="position: relative; display: inline-block; width: 50px; height: 26px;">
              <input type="checkbox" ${flow.enabled ? 'checked' : ''} 
                     onchange="toggleFlowEnabled('${flow.id}', this.checked)"
                     style="opacity: 0; width: 0; height: 0;">
              <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: ${flow.enabled ? '#10b981' : '#475569'}; transition: 0.3s; border-radius: 26px;">
                <span style="position: absolute; content: ''; height: 20px; width: 20px; left: ${flow.enabled ? '26px' : '3px'}; bottom: 3px; background: white; transition: 0.3s; border-radius: 50%;"></span>
              </span>
            </label>
          </div>
        </div>
      `).join('');
    }
    
    async function toggleFlowEnabled(flowId, enabled) {
      console.log(`[FLOW TOGGLE] ${flowId} â†’ ${enabled}`);
      
      const toggleEl = event.target;
      toggleEl.disabled = true;
      
      try {
        // Use the patch endpoint to toggle flow
        const response = await fetch(`/api/company/${currentCompanyId}/runtime-patch`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            companyId: currentCompanyId,
            scope: 'companyOverride',
            patches: [
              { op: 'replace', path: `/dynamicFlows/flows/${flowId}/enabled`, value: enabled }
            ]
          })
        });
        
        const result = await response.json();
        
        if (result.success && result.appliedCount > 0) {
          lastPatchTimestamp = new Date().toISOString();
          showSnapshotToast(`Flow ${enabled ? 'enabled' : 'disabled'} successfully!`, 'success');
          // Reload runtime truth to refresh the view
          await loadRuntimeTruth();
        } else {
          showSnapshotToast(`Failed to toggle flow: ${result.errors?.[0]?.message || 'Unknown error'}`, 'error');
          // Revert the checkbox
          toggleEl.checked = !enabled;
        }
        
      } catch (error) {
        console.error('[FLOW TOGGLE] Error:', error);
        showSnapshotToast(`Error: ${error.message}`, 'error');
        toggleEl.checked = !enabled;
      } finally {
        toggleEl.disabled = false;
      }
    }
    
    // ============================================================================
    // SCENARIO WIRING PANEL
    // ============================================================================
    
    function renderScenarioWiringTable() {
      const tbody = document.getElementById('scenario-wiring-body');
      const flowSelect = document.getElementById('bulk-flow-select');
      
      if (!currentRuntimeTruth) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #94a3b8;">Loading...</td></tr>';
        return;
      }
      
      const scenarios = currentRuntimeTruth.scenarioBrain?.scenarios || [];
      const flows = currentRuntimeTruth.dynamicFlows?.flows || [];
      const bookingEnabled = currentRuntimeTruth.controlPlane?.booking?.enabled;
      
      // Populate flow dropdown
      flowSelect.innerHTML = '<option value="">-- Select Flow --</option>' + 
        flows.filter(f => f.enabled).map(f => `<option value="${f.id}">${f.name || f.flowKey}</option>`).join('');
      
      if (scenarios.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #94a3b8;">No scenarios found. Enable a template first.</td></tr>';
        return;
      }
      
      tbody.innerHTML = scenarios.map(s => {
        const hasIssues = [];
        if (s.scenarioType === 'UNKNOWN') hasIssues.push('UNKNOWN TYPE');
        if (s.wiring.action === 'START_FLOW' && !s.wiring.flowId) hasIssues.push('Missing flowId');
        if (s.wiring.action === 'TRANSFER' && !s.wiring.transferTarget) hasIssues.push('Missing target');
        if (s.wiring.bookingIntent && !bookingEnabled) hasIssues.push('Booking disabled');
        
        const rowBg = hasIssues.length > 0 ? '#1c1917' : '#0f172a';
        const isSelected = selectedScenarios.has(s.id);
        
        return `
          <tr style="background: ${rowBg}; ${isSelected ? 'outline: 2px solid #10b981;' : ''}">
            <td style="padding: 10px 8px; border-bottom: 1px solid #1e293b;">
              <input type="checkbox" ${isSelected ? 'checked' : ''} 
                     onchange="toggleScenarioSelection('${s.id}', this.checked)"
                     style="accent-color: #10b981;">
            </td>
            <td style="padding: 10px 8px; border-bottom: 1px solid #1e293b;">
              <div style="color: #f1f5f9; font-weight: 500; font-size: 12px;">${s.name}</div>
              <div style="color: #64748b; font-size: 10px;">${s.categoryName}</div>
            </td>
            <td style="padding: 10px 8px; border-bottom: 1px solid #1e293b;">
              <select onchange="updateScenarioField('${s.id}', 'scenarioType', this.value)" 
                      style="padding: 6px 8px; background: ${s.scenarioType === 'UNKNOWN' ? '#7f1d1d' : '#1e293b'}; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9; font-size: 11px; width: 100%;">
                ${SCENARIO_TYPES.map(t => `<option value="${t}" ${s.scenarioType === t ? 'selected' : ''}>${t}</option>`).join('')}
              </select>
            </td>
            <td style="padding: 10px 8px; border-bottom: 1px solid #1e293b;">
              <select onchange="updateScenarioField('${s.id}', 'wiring.action', this.value)" 
                      style="padding: 6px 8px; background: #1e293b; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9; font-size: 11px; width: 100%;">
                ${SCENARIO_ACTIONS.map(a => `<option value="${a}" ${s.wiring.action === a ? 'selected' : ''}>${a}</option>`).join('')}
              </select>
            </td>
            <td style="padding: 10px 8px; border-bottom: 1px solid #1e293b;">
              <select onchange="updateScenarioField('${s.id}', 'wiring.flowId', this.value)" 
                      style="padding: 6px 8px; background: ${s.wiring.action === 'START_FLOW' && !s.wiring.flowId ? '#7f1d1d' : '#1e293b'}; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9; font-size: 11px; width: 100%;">
                <option value="">None</option>
                ${flows.map(f => `<option value="${f.id}" ${s.wiring.flowId === f.id ? 'selected' : ''}>${f.name || f.flowKey}</option>`).join('')}
              </select>
            </td>
            <td style="padding: 10px 8px; border-bottom: 1px solid #1e293b; text-align: center;">
              <input type="checkbox" ${s.wiring.bookingIntent ? 'checked' : ''} 
                     onchange="updateScenarioField('${s.id}', 'wiring.bookingIntent', this.checked)"
                     style="accent-color: #10b981;">
            </td>
            <td style="padding: 10px 8px; border-bottom: 1px solid #1e293b;">
              <input type="text" value="${s.wiring.transferTarget || ''}" 
                     onchange="updateScenarioField('${s.id}', 'wiring.transferTarget', this.value)"
                     placeholder="None"
                     style="padding: 6px 8px; background: #1e293b; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9; font-size: 11px; width: 80px;">
            </td>
            <td style="padding: 10px 8px; border-bottom: 1px solid #1e293b; text-align: center;">
              <input type="number" value="${s.priority}" min="0" max="100"
                     onchange="updateScenarioField('${s.id}', 'priority', parseInt(this.value))"
                     style="padding: 6px 4px; background: #1e293b; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9; font-size: 11px; width: 50px; text-align: center;">
            </td>
            <td style="padding: 10px 8px; border-bottom: 1px solid #1e293b;">
              ${hasIssues.length > 0 ? hasIssues.map(i => `<span style="display: inline-block; background: #7f1d1d; color: #fecaca; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin: 1px;">${i}</span>`).join('') : '<span style="color: #10b981; font-size: 11px;">âœ“ OK</span>'}
            </td>
          </tr>
        `;
      }).join('');
      
      updateSelectedCount();
    }
    
    function toggleScenarioSelection(scenarioId, selected) {
      if (selected) {
        selectedScenarios.add(scenarioId);
      } else {
        selectedScenarios.delete(scenarioId);
      }
      updateSelectedCount();
    }
    
    function toggleAllScenarios(selected) {
      const scenarios = currentRuntimeTruth?.scenarioBrain?.scenarios || [];
      selectedScenarios.clear();
      if (selected) {
        scenarios.forEach(s => selectedScenarios.add(s.id));
      }
      renderScenarioWiringTable();
    }
    
    function updateSelectedCount() {
      document.getElementById('wiring-selected-count').textContent = `${selectedScenarios.size} selected`;
    }
    
    async function updateScenarioField(scenarioId, field, value) {
      console.log(`[WIRING] ${scenarioId}.${field} = ${value}`);
      
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/runtime-patch`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            companyId: currentCompanyId,
            scope: 'companyOverride',
            expectedVersion: currentRuntimeTruth?._meta?.version,
            patches: [
              { op: 'replace', path: `/scenarioBrain/scenarios/${scenarioId}/${field}`, value }
            ]
          })
        });
        
        const result = await response.json();
        
        if (result.success && result.appliedCount > 0) {
          lastPatchTimestamp = new Date().toISOString();
          showSnapshotToast(`Updated ${field}`, 'success');
          await loadRuntimeTruth();
          renderScenarioWiringTable();
        } else {
          showSnapshotToast(`Failed: ${result.errors?.[0]?.message || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        console.error('[WIRING] Error:', error);
        showSnapshotToast(`Error: ${error.message}`, 'error');
      }
    }
    
    async function fixUnknownScenarioTypes() {
      const scenarios = currentRuntimeTruth?.scenarioBrain?.scenarios || [];
      const unknowns = scenarios.filter(s => s.scenarioType === 'UNKNOWN');
      
      if (unknowns.length === 0) {
        showSnapshotToast('No UNKNOWN scenarios to fix', 'info');
        return;
      }
      
      // Deterministic rules to assign types
      const patches = unknowns.map(s => {
        const name = (s.name || '').toLowerCase();
        const cat = (s.categoryName || '').toLowerCase();
        
        let type = 'FAQ'; // Default
        
        // Emergency detection
        if (name.includes('leak') || name.includes('emergency') || name.includes('gas') || 
            name.includes('burning') || name.includes('smoke') || name.includes('fire') ||
            cat.includes('emergency') || cat.includes('leak')) {
          type = 'EMERGENCY';
        }
        // Troubleshoot detection
        else if (name.includes('not cool') || name.includes('not heat') || name.includes('no cool') || 
                 name.includes('no heat') || name.includes('broken') || name.includes('noise') ||
                 name.includes('not working') || name.includes('issue') || name.includes('problem') ||
                 cat.includes('troubleshoot') || cat.includes('repair') || cat.includes('failure')) {
          type = 'TROUBLESHOOT';
        }
        // Booking detection
        else if (name.includes('schedule') || name.includes('appointment') || name.includes('book') ||
                 cat.includes('booking') || cat.includes('schedule')) {
          type = 'BOOKING';
        }
        // Transfer detection
        else if (name.includes('transfer') || name.includes('speak to') || name.includes('manager') ||
                 cat.includes('transfer')) {
          type = 'TRANSFER';
        }
        // Small talk detection
        else if (name.includes('greeting') || name.includes('hello') || name.includes('thank') ||
                 cat.includes('small talk') || cat.includes('greeting')) {
          type = 'SMALL_TALK';
        }
        
        return { op: 'replace', path: `/scenarioBrain/scenarios/${s.id}/scenarioType`, value: type };
      });
      
      if (patches.length === 0) return;
      
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/runtime-patch`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            companyId: currentCompanyId,
            scope: 'companyOverride',
            patches
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          lastPatchTimestamp = new Date().toISOString();
          showSnapshotToast(`Fixed ${result.appliedCount} scenario types`, 'success');
          await loadRuntimeTruth();
          renderScenarioWiringTable();
        } else {
          showSnapshotToast(`Failed: ${result.errors?.[0]?.message || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        showSnapshotToast(`Error: ${error.message}`, 'error');
      }
    }
    
    async function wireSelectedToFlow() {
      const flowId = document.getElementById('bulk-flow-select').value;
      
      if (!flowId) {
        showSnapshotToast('Select a flow first', 'warning');
        return;
      }
      
      if (selectedScenarios.size === 0) {
        showSnapshotToast('Select scenarios first', 'warning');
        return;
      }
      
      const patches = [];
      selectedScenarios.forEach(scenarioId => {
        patches.push({ op: 'replace', path: `/scenarioBrain/scenarios/${scenarioId}/wiring.action`, value: 'START_FLOW' });
        patches.push({ op: 'replace', path: `/scenarioBrain/scenarios/${scenarioId}/wiring.flowId`, value: flowId });
      });
      
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/runtime-patch`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            companyId: currentCompanyId,
            scope: 'companyOverride',
            patches
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          lastPatchTimestamp = new Date().toISOString();
          showSnapshotToast(`Wired ${selectedScenarios.size} scenarios to flow`, 'success');
          selectedScenarios.clear();
          await loadRuntimeTruth();
          renderScenarioWiringTable();
        } else {
          showSnapshotToast(`Failed: ${result.errors?.[0]?.message || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        showSnapshotToast(`Error: ${error.message}`, 'error');
      }
    }
    
    // ============================================================================
    // BOOKING PANEL
    // ============================================================================
    
    function renderBookingPanel() {
      if (!currentRuntimeTruth) return;
      
      const booking = currentRuntimeTruth.controlPlane?.booking || {};
      const consent = booking.consent || {};
      
      // Master toggle
      const toggle = document.getElementById('booking-enabled-toggle');
      const track = document.getElementById('booking-toggle-track');
      const thumb = document.getElementById('booking-toggle-thumb');
      
      toggle.checked = booking.enabled;
      track.style.background = booking.enabled ? '#10b981' : '#475569';
      thumb.style.left = booking.enabled ? '31px' : '3px';
      
      // Required fields
      const fieldsEl = document.getElementById('booking-fields-list');
      const currentSlots = booking.slots || [];
      const currentSlotKeys = currentSlots.map(s => s.key);
      
      fieldsEl.innerHTML = BOOKING_FIELDS.map(field => {
        const isEnabled = currentSlotKeys.includes(field.key);
        return `
          <label style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: ${isEnabled ? '#064e3b' : '#0f172a'}; border: 1px solid ${isEnabled ? '#10b981' : '#334155'}; border-radius: 8px; cursor: pointer;">
            <input type="checkbox" ${isEnabled ? 'checked' : ''} 
                   onchange="toggleBookingField('${field.key}', '${field.label}', this.checked)"
                   style="accent-color: #10b981; width: 16px; height: 16px;">
            <div>
              <div style="color: #f1f5f9; font-size: 13px; font-weight: 500;">${field.label}</div>
              <div style="color: #64748b; font-size: 10px;">${field.required ? 'Recommended' : 'Optional'}</div>
            </div>
          </label>
        `;
      }).join('');
      
      // Time windows
      const windowsEl = document.getElementById('booking-time-windows');
      const windows = booking.timeWindows || [];
      
      windowsEl.innerHTML = windows.map((w, i) => `
        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #0f172a; border: 1px solid #334155; border-radius: 6px;">
          <span style="color: #f1f5f9; font-size: 12px;">${w}</span>
          <button onclick="removeTimeWindow(${i})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `).join('') || '<span style="color: #64748b; font-size: 12px;">No time windows configured</span>';
      
      // Consent checkboxes
      document.getElementById('consent-sms').checked = consent.required || false;
      document.getElementById('consent-script').value = consent.phrase || '';
      
      // Booking health
      const healthPanel = document.getElementById('booking-health-panel');
      const healthIssues = document.getElementById('booking-health-issues');
      const issues = [];
      
      if (booking.enabled && windows.length === 0) {
        issues.push('Booking enabled but no time windows configured');
      }
      if (booking.enabled && currentSlots.length === 0) {
        issues.push('Booking enabled but no required fields configured');
      }
      
      if (issues.length > 0) {
        healthPanel.style.display = 'block';
        healthIssues.innerHTML = issues.map(i => `<li>${i}</li>`).join('');
      } else {
        healthPanel.style.display = 'none';
      }
    }
    
    async function toggleBookingEnabled(enabled) {
      const track = document.getElementById('booking-toggle-track');
      const thumb = document.getElementById('booking-toggle-thumb');
      
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/runtime-patch`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            companyId: currentCompanyId,
            scope: 'companyOverride',
            patches: [
              { op: 'replace', path: '/controlPlane/booking/enabled', value: enabled }
            ]
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          lastPatchTimestamp = new Date().toISOString();
          track.style.background = enabled ? '#10b981' : '#475569';
          thumb.style.left = enabled ? '31px' : '3px';
          showSnapshotToast(`Booking ${enabled ? 'enabled' : 'disabled'}`, 'success');
          await loadRuntimeTruth();
          renderBookingPanel();
        } else {
          showSnapshotToast(`Failed: ${result.errors?.[0]?.message || 'Unknown error'}`, 'error');
          document.getElementById('booking-enabled-toggle').checked = !enabled;
        }
      } catch (error) {
        showSnapshotToast(`Error: ${error.message}`, 'error');
        document.getElementById('booking-enabled-toggle').checked = !enabled;
      }
    }
    
    async function toggleBookingField(key, label, enabled) {
      // Note: This would need a proper backend endpoint to add/remove booking slots
      // For now, show a message that this feature needs backend support
      showSnapshotToast(`Booking field toggle requires backend update. Use Patch Import to modify slots.`, 'info');
    }
    
    function addTimeWindow() {
      const newWindow = prompt('Enter time window (e.g., "8:00 AM - 10:00 AM"):');
      if (newWindow && newWindow.trim()) {
        showSnapshotToast(`Time window add requires backend update. Use Patch Import.`, 'info');
      }
    }
    
    function removeTimeWindow(index) {
      showSnapshotToast(`Time window remove requires backend update. Use Patch Import.`, 'info');
    }
    
    async function updateConsentSetting(setting, value) {
      // These would need proper patch paths to be added to the allowlist
      showSnapshotToast(`Consent setting requires backend update. Use Patch Import.`, 'info');
    }
    
    function updateConsentScript(value) {
      showSnapshotToast(`Consent script requires backend update. Use Patch Import.`, 'info');
    }
  </script>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCENARIO REPORT MODAL - Enterprise Enforcement Proof
       Shows which scenarios are enterprise-ready and will actually match
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="scenario-report-modal-overlay" class="snapshot-modal-overlay">
    <div class="snapshot-modal" style="max-width: 1400px;">
      <div class="snapshot-modal-header" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);">
        <div class="snapshot-modal-title">
          <h2 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸ›¡ï¸ Scenario Report - Enterprise Enforcement</h2>
          <p style="margin: 4px 0 0; font-size: 12px; opacity: 0.9;">Only enterpriseReady === true scenarios will match at runtime. NO EXCEPTIONS.</p>
        </div>
        <div class="snapshot-modal-controls" style="display: flex; gap: 8px; align-items: center;">
          <span id="scenario-report-health" style="padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700;"></span>
          <button id="btn-copy-scenario-report" onclick="copyScenarioReport()" style="padding: 8px 16px; background: white; color: #dc2626; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-copy"></i> Copy Full JSON
          </button>
          <button onclick="closeScenarioReportModal()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="snapshot-modal-body" style="padding: 20px; max-height: 75vh; overflow-y: auto; background: #0f172a;">
        <!-- Summary Stats -->
        <div id="scenario-report-summary" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px;">
          <div style="background: #1e293b; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 32px; font-weight: 700; color: #60a5fa;" id="sr-total">--</div>
            <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">Total Scenarios</div>
          </div>
          <div style="background: #1e293b; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #10b981;">
            <div style="font-size: 32px; font-weight: 700; color: #10b981;" id="sr-ready">--</div>
            <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">âœ… Enterprise Ready</div>
          </div>
          <div style="background: #1e293b; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #ef4444;">
            <div style="font-size: 32px; font-weight: 700; color: #ef4444;" id="sr-not-ready">--</div>
            <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">âŒ Will NOT Match</div>
          </div>
          <div style="background: #1e293b; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 32px; font-weight: 700; color: #fbbf24;" id="sr-percent">--</div>
            <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">% Ready</div>
          </div>
          <div style="background: #1e293b; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 32px; font-weight: 700; color: #a78bfa;" id="sr-collisions">--</div>
            <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">Collisions</div>
          </div>
        </div>
        
        <!-- Grade Distribution -->
        <div style="background: #1e293b; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
          <h4 style="margin: 0 0 12px 0; color: #f1f5f9; font-size: 14px;">ğŸ“Š Grade Distribution</h4>
          <div id="scenario-report-grades" style="display: flex; gap: 16px; align-items: flex-end;"></div>
        </div>
        
        <!-- Quality Requirements -->
        <div style="background: #1e293b; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
          <h4 style="margin: 0 0 12px 0; color: #f1f5f9; font-size: 14px;">ğŸ“‹ Quality Requirements (Non-Negotiable)</h4>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
            <div style="background: #0f172a; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #60a5fa;">8+</div>
              <div style="font-size: 11px; color: #94a3b8;">Triggers</div>
            </div>
            <div style="background: #0f172a; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #60a5fa;">3+</div>
              <div style="font-size: 11px; color: #94a3b8;">Negative Triggers</div>
            </div>
            <div style="background: #0f172a; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #60a5fa;">7+</div>
              <div style="font-size: 11px; color: #94a3b8;">Quick Replies</div>
            </div>
            <div style="background: #0f172a; padding: 12px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #60a5fa;">7+</div>
              <div style="font-size: 11px; color: #94a3b8;">Full Replies</div>
            </div>
          </div>
        </div>
        
        <!-- Top Issues -->
        <div style="background: #1e293b; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
          <h4 style="margin: 0 0 12px 0; color: #f1f5f9; font-size: 14px;">ğŸš¨ Top Issues (Fix These First)</h4>
          <div id="scenario-report-issues" style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;"></div>
        </div>
        
        <!-- Full JSON -->
        <div style="background: #1e293b; border-radius: 12px; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="margin: 0; color: #f1f5f9; font-size: 14px;">{ } Full Report JSON</h4>
            <button onclick="copyScenarioReport()" style="padding: 6px 12px; background: #0f172a; color: #94a3b8; border: 1px solid #334155; border-radius: 6px; font-size: 11px; cursor: pointer;">
              <i class="fas fa-copy"></i> Copy
            </button>
          </div>
          <pre id="scenario-report-json" style="background: #0f172a; padding: 16px; border-radius: 8px; overflow: auto; max-height: 400px; font-size: 11px; color: #e2e8f0; white-space: pre-wrap; margin: 0;"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCENARIO BROWSER MODAL - Enterprise Separated RAW vs AUDIT
       TABS: RAW = pure stored data | AUDIT = computed proof blocks
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="scenario-browser-modal-overlay" class="snapshot-modal-overlay">
    <div class="snapshot-modal" style="max-width: 1600px; height: 90vh;">
      <!-- HEADER with TABS -->
      <div style="background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);">
        <div class="snapshot-modal-header" style="background: transparent; padding-bottom: 0;">
          <div class="snapshot-modal-title">
            <h2 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸ“‚ Scenario Browser</h2>
            <p style="margin: 4px 0 0; font-size: 12px; opacity: 0.9;">Enterprise-separated RAW/AUDIT data sources</p>
          </div>
          <div class="snapshot-modal-controls" style="display: flex; gap: 8px; align-items: center;">
            <!-- Export Dropdown -->
            <div style="position: relative;">
              <button onclick="toggleSBExportDropdown()" 
                      style="padding: 6px 12px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
                <i class="fas fa-file-export"></i> Export â–¾
              </button>
              <div id="sb-export-dropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: #1e293b; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 180px; z-index: 1000;">
                <button onclick="exportAllScenariosRAW()" style="width: 100%; padding: 10px 12px; background: transparent; color: #e2e8f0; border: none; text-align: left; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #334155;">
                  <i class="fas fa-database" style="color: #22c55e;"></i> Export All (RAW)
                </button>
                <button onclick="exportAllScenariosAUDIT()" style="width: 100%; padding: 10px 12px; background: transparent; color: #e2e8f0; border: none; text-align: left; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #334155;">
                  <i class="fas fa-shield-alt" style="color: #f59e0b;"></i> Export All (AUDIT)
                </button>
                <button onclick="copySelectedScenario()" style="width: 100%; padding: 10px 12px; background: transparent; color: #e2e8f0; border: none; text-align: left; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #334155;">
                  <i class="fas fa-copy" style="color: #06b6d4;"></i> Copy Selected
                </button>
                <button onclick="downloadSelectedScenario()" style="width: 100%; padding: 10px 12px; background: transparent; color: #e2e8f0; border: none; text-align: left; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-download" style="color: #a78bfa;"></i> Download Selected
                </button>
              </div>
            </div>
            <button onclick="closeScenarioBrowserModal()" 
                    style="padding: 6px 12px; background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
              âœ• Close
            </button>
          </div>
        </div>
        
        <!-- TABS -->
        <div style="display: flex; padding: 0 16px;">
          <button id="sb-tab-raw" onclick="switchScenarioBrowserTab('raw')" 
                  style="padding: 10px 20px; background: white; color: #7c3aed; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 12px; font-weight: 700; margin-right: 4px;">
            <i class="fas fa-database"></i> RAW
            <span style="font-size: 9px; opacity: 0.7; display: block;">Pure stored data</span>
          </button>
          <button id="sb-tab-audit" onclick="switchScenarioBrowserTab('audit')" 
                  style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 12px; font-weight: 600;">
            <i class="fas fa-shield-alt"></i> AUDIT
            <span style="font-size: 9px; opacity: 0.7; display: block;">Computed proof blocks</span>
          </button>
        </div>
      </div>
      
      <div class="snapshot-modal-body" style="padding: 0; display: flex !important; flex-direction: row !important; height: calc(100% - 100px); min-height: 500px;">
        <!-- LEFT PANEL: Categories Tree -->
        <div id="sb-left-panel" style="width: 320px; min-width: 320px; border-right: 1px solid #334155; display: flex; flex-direction: column; background: #1e293b;">
          <!-- Search Box -->
          <div style="padding: 12px; border-bottom: 1px solid #334155;">
            <input type="text" id="sb-search" placeholder="Search scenarios..." 
                   oninput="filterScenarioBrowser(this.value)"
                   style="width: 100%; padding: 8px 12px; background: #0f172a; border: 1px solid #475569; border-radius: 6px; color: #e2e8f0; font-size: 12px;">
            <div style="margin-top: 8px; font-size: 10px; color: #64748b;">
              Search by: name, scenarioId, actionType, flowId, triggers...
            </div>
          </div>
          
          <!-- Stats Bar (shows different info for RAW vs AUDIT) -->
          <div id="sb-stats" style="padding: 8px 12px; background: #0f172a; border-bottom: 1px solid #334155;">
            <div style="display: flex; gap: 12px; font-size: 11px;">
              <span style="color: #22d3ee;"><strong id="sb-cat-count">0</strong> categories</span>
              <span style="color: #a78bfa;"><strong id="sb-scenario-count">0</strong> scenarios</span>
              <span style="color: #fbbf24;"><strong id="sb-trigger-count">0</strong> triggers</span>
            </div>
            <!-- AUDIT-only health summary -->
            <div id="sb-audit-health" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid #334155;">
              <div style="display: flex; gap: 8px; align-items: center;">
                <span id="sb-health-badge" style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700;">-</span>
                <span id="sb-health-msg" style="font-size: 10px; color: #94a3b8;">-</span>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 6px; font-size: 10px;">
                <span style="color: #22c55e;"><strong id="sb-ready-count">0</strong> ready</span>
                <span style="color: #f87171;"><strong id="sb-not-ready-count">0</strong> not ready</span>
                <span style="color: #f59e0b;"><strong id="sb-collision-count">0</strong> collisions</span>
              </div>
            </div>
          </div>
          
          <!-- Categories List -->
          <div id="sb-categories-list" style="flex: 1; overflow-y: auto; padding: 8px;">
            <div style="color: #64748b; text-align: center; padding: 20px;">Select a tab to load data...</div>
          </div>
        </div>
        
        <!-- RIGHT PANEL: Scenario JSON Viewer -->
        <div id="sb-right-panel" style="flex: 1; display: flex; flex-direction: column; background: #0f172a !important; min-width: 400px;">
          <!-- Scenario Header -->
          <div id="sb-scenario-header" style="padding: 12px 16px; border-bottom: 1px solid #334155; background: #1e293b;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div id="sb-scenario-name" style="font-size: 14px; font-weight: 600; color: #e2e8f0;">Select a scenario</div>
                <div id="sb-scenario-meta" style="font-size: 11px; color: #64748b; margin-top: 4px;">Click a category then a scenario to view</div>
              </div>
              <div id="sb-scenario-badges" style="display: flex; gap: 6px;"></div>
            </div>
          </div>
          
          <!-- AUDIT-only: Quick Report -->
          <div id="sb-audit-report" style="display: none; padding: 12px 16px; border-bottom: 1px solid #334155; background: #1e293b;">
            <div style="display: flex; gap: 16px; align-items: center;">
              <div>
                <span style="font-size: 10px; color: #64748b;">Grade:</span>
                <span id="sb-scenario-grade" style="font-size: 18px; font-weight: 700; margin-left: 4px; color: #fbbf24;">-</span>
              </div>
              <div>
                <span style="font-size: 10px; color: #64748b;">Score:</span>
                <span id="sb-scenario-score" style="font-size: 14px; font-weight: 600; margin-left: 4px; color: #e2e8f0;">-</span>
              </div>
              <div>
                <span style="font-size: 10px; color: #64748b;">Enterprise Ready:</span>
                <span id="sb-scenario-ready" style="font-size: 11px; font-weight: 600; margin-left: 4px;">-</span>
              </div>
              <div id="sb-scenario-issues" style="flex: 1; font-size: 10px; color: #f87171;"></div>
            </div>
          </div>
          
          <!-- Find in JSON -->
          <div style="padding: 8px 16px; border-bottom: 1px solid #334155; background: #1e293b;">
            <input type="text" id="sb-find-in-json" placeholder="Find in JSON..." 
                   oninput="highlightInJson(this.value)"
                   style="width: 300px; padding: 6px 10px; background: #0f172a; border: 1px solid #475569; border-radius: 4px; color: #e2e8f0; font-size: 11px;">
            <span id="sb-find-count" style="margin-left: 8px; font-size: 11px; color: #64748b;"></span>
            <span id="sb-mode-indicator" style="margin-left: 16px; padding: 2px 8px; background: #22c55e; color: black; border-radius: 4px; font-size: 9px; font-weight: 700;">RAW</span>
          </div>
          
          <!-- JSON Viewer -->
          <div style="flex: 1; overflow: auto; padding: 16px; background: #0f172a;">
            <pre id="sb-json-viewer" style="margin: 0; font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: #e2e8f0 !important; white-space: pre-wrap; background: transparent;">
{
  "info": "Select a tab (RAW or AUDIT) to load scenarios",
  "RAW": {
    "endpoint": "/api/company/:companyId/scenarios-raw",
    "description": "Pure stored data - NO computed fields"
  },
  "AUDIT": {
    "endpoint": "/api/company/:companyId/scenarios-audit",
    "description": "Includes _stats, _auditReport, _collisions"
  }
}
            </pre>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SCENARIO BROWSER - Enterprise Separated RAW vs AUDIT
    // HARD RULE: RAW and AUDIT use SEPARATE API endpoints. No leakage.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let scenarioBrowserData = null;
    let scenarioBrowserRawData = null;
    let scenarioBrowserAuditData = null;
    let scenarioBrowserMode = 'raw'; // 'raw' or 'audit'
    let selectedCategoryId = null;
    let selectedScenarioId = null;
    let selectedScenarioData = null;
    
    async function openScenarioBrowserModal() {
      document.getElementById('scenario-browser-modal-overlay').classList.add('active');
      // Auto-load RAW tab on open
      await switchScenarioBrowserTab('raw');
    }
    
    function closeScenarioBrowserModal() {
      document.getElementById('scenario-browser-modal-overlay').classList.remove('active');
      document.getElementById('sb-export-dropdown').style.display = 'none';
    }
    
    function toggleSBExportDropdown() {
      const dropdown = document.getElementById('sb-export-dropdown');
      dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
    
    function toggleDebugToolsDropdown() {
      const dropdown = document.getElementById('debug-tools-dropdown');
      dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      // Scenario Browser export dropdown
      if (!e.target.closest('#sb-export-dropdown') && !e.target.closest('[onclick="toggleSBExportDropdown()"]')) {
        const dropdown = document.getElementById('sb-export-dropdown');
        if (dropdown) dropdown.style.display = 'none';
      }
      // Debug tools dropdown
      if (!e.target.closest('#debug-tools-dropdown') && !e.target.closest('[onclick="toggleDebugToolsDropdown()"]')) {
        const dropdown = document.getElementById('debug-tools-dropdown');
        if (dropdown) dropdown.style.display = 'none';
      }
    });
    
    async function switchScenarioBrowserTab(mode) {
      scenarioBrowserMode = mode;
      
      // Update tab styles
      const rawTab = document.getElementById('sb-tab-raw');
      const auditTab = document.getElementById('sb-tab-audit');
      const modeIndicator = document.getElementById('sb-mode-indicator');
      const auditHealthSection = document.getElementById('sb-audit-health');
      const auditReportSection = document.getElementById('sb-audit-report');
      
      if (mode === 'raw') {
        rawTab.style.background = 'white';
        rawTab.style.color = '#7c3aed';
        auditTab.style.background = 'rgba(255,255,255,0.2)';
        auditTab.style.color = 'white';
        modeIndicator.textContent = 'RAW';
        modeIndicator.style.background = '#22c55e';
        auditHealthSection.style.display = 'none';
        auditReportSection.style.display = 'none';
      } else {
        auditTab.style.background = 'white';
        auditTab.style.color = '#7c3aed';
        rawTab.style.background = 'rgba(255,255,255,0.2)';
        rawTab.style.color = 'white';
        modeIndicator.textContent = 'AUDIT';
        modeIndicator.style.background = '#f59e0b';
        auditHealthSection.style.display = 'block';
        auditReportSection.style.display = 'flex';
      }
      
      // Load data from the CORRECT endpoint (separate sources!)
      await loadScenarioBrowserData(mode);
    }
    
    async function loadScenarioBrowserData(mode) {
      const categoriesList = document.getElementById('sb-categories-list');
      categoriesList.innerHTML = '<div style="color: #64748b; text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading ' + mode.toUpperCase() + ' data...</div>';
      
      try {
        // Use SEPARATE endpoints based on mode (HARD RULE: no shared serializer)
        const endpoint = mode === 'raw' 
          ? `/api/company/${currentCompanyId}/scenarios-raw`
          : `/api/company/${currentCompanyId}/scenarios-audit`;
        
        console.log(`[SCENARIO BROWSER] Loading ${mode.toUpperCase()} from: ${endpoint}`);
        
        const response = await fetch(endpoint, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const result = await response.json();
        
        if (!result.success || !result.data) {
          categoriesList.innerHTML = `<div style="color: #f87171; text-align: center; padding: 20px;">Failed to load ${mode.toUpperCase()} data</div>`;
          return;
        }
        
        // Store in the correct cache
        if (mode === 'raw') {
          scenarioBrowserRawData = result.data;
        } else {
          scenarioBrowserAuditData = result.data;
        }
        scenarioBrowserData = result.data;
        
        // Update stats
        const categories = scenarioBrowserData.categories || [];
        const totalScenarios = scenarioBrowserData._totalScenarios || categories.reduce((sum, c) => sum + (c.scenarios?.length || 0), 0);
        const totalTriggers = scenarioBrowserData._totalTriggers || categories.reduce((sum, c) => 
          sum + c.scenarios?.reduce((s, sc) => s + (sc.triggers?.length || 0), 0) || 0, 0);
        
        document.getElementById('sb-cat-count').textContent = categories.length;
        document.getElementById('sb-scenario-count').textContent = totalScenarios;
        document.getElementById('sb-trigger-count').textContent = totalTriggers;
        
        // Update AUDIT-specific health summary
        if (mode === 'audit' && scenarioBrowserData._summary) {
          const summary = scenarioBrowserData._summary;
          
          // Health badge
          const healthBadge = document.getElementById('sb-health-badge');
          healthBadge.textContent = summary.health || 'UNKNOWN';
          healthBadge.style.background = summary.health === 'GREEN' ? '#22c55e' : summary.health === 'YELLOW' ? '#f59e0b' : '#ef4444';
          healthBadge.style.color = summary.health === 'YELLOW' ? 'black' : 'white';
          
          document.getElementById('sb-health-msg').textContent = summary.healthMessage || '';
          document.getElementById('sb-ready-count').textContent = summary.totalEnterpriseReady || 0;
          document.getElementById('sb-not-ready-count').textContent = (summary.totalScenarios || 0) - (summary.totalEnterpriseReady || 0);
          document.getElementById('sb-collision-count').textContent = summary.totalCollisions || 0;
        }
        
        // Render categories tree
        renderCategoriesTree(categories);
        
        // Clear selected scenario
        selectedScenarioData = null;
        document.getElementById('sb-scenario-name').textContent = 'Select a scenario';
        document.getElementById('sb-scenario-meta').textContent = 'Click a category then a scenario to view';
        document.getElementById('sb-scenario-badges').innerHTML = '';
        document.getElementById('sb-json-viewer').textContent = JSON.stringify({
          mode: mode.toUpperCase(),
          endpoint: mode === 'raw' ? '/scenarios-raw' : '/scenarios-audit',
          dataSource: mode === 'raw' ? 'Pure stored fields (NO computed)' : 'Includes _stats, _auditReport, _collisions',
          loaded: scenarioBrowserData.categories?.length + ' categories'
        }, null, 2);
        
      } catch (error) {
        console.error('[SCENARIO BROWSER] Error:', error);
        categoriesList.innerHTML = `<div style="color: #f87171; text-align: center; padding: 20px;">Error: ${error.message}</div>`;
      }
    }
    
    function renderCategoriesTree(categories) {
      const container = document.getElementById('sb-categories-list');
      
      if (!categories || categories.length === 0) {
        container.innerHTML = '<div style="color: #64748b; text-align: center; padding: 20px;">No categories found</div>';
        return;
      }
      
      let html = '';
      categories.forEach(cat => {
        const scenarioCount = cat.scenarios?.length || cat._stats?.scenarioCount || 0;
        const triggerCount = cat._stats?.totalTriggers || 0;
        
        html += `
          <div class="sb-category-item" data-category-id="${cat.categoryId}" onclick="selectCategory('${cat.categoryId}')"
               style="padding: 10px 12px; margin-bottom: 4px; background: #334155; border-radius: 6px; cursor: pointer; transition: all 0.15s;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="font-weight: 600; font-size: 12px; color: #e2e8f0;">${cat.icon || 'ğŸ“'} ${cat.name}</div>
              <div style="font-size: 10px; color: #94a3b8;">${scenarioCount}</div>
            </div>
            <div style="font-size: 10px; color: #64748b; margin-top: 4px;">
              ${triggerCount} triggers
            </div>
          </div>
          <div id="sb-scenarios-${cat.categoryId}" class="sb-scenarios-container" style="display: none; margin-left: 12px; margin-bottom: 8px;"></div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    function selectCategory(categoryId) {
      // Highlight selected category
      document.querySelectorAll('.sb-category-item').forEach(el => {
        el.style.background = '#334155';
        el.style.borderLeft = 'none';
      });
      
      const selectedEl = document.querySelector(`.sb-category-item[data-category-id="${categoryId}"]`);
      if (selectedEl) {
        selectedEl.style.background = '#475569';
        selectedEl.style.borderLeft = '3px solid #a78bfa';
      }
      
      selectedCategoryId = categoryId;
      
      // Toggle scenarios list
      document.querySelectorAll('.sb-scenarios-container').forEach(el => {
        el.style.display = 'none';
      });
      
      const scenariosContainer = document.getElementById(`sb-scenarios-${categoryId}`);
      if (scenariosContainer) {
        scenariosContainer.style.display = 'block';
        
        // Find scenarios for this category
        const category = scenarioBrowserData.categories?.find(c => c.categoryId === categoryId);
        const scenarios = category?.scenarios || scenarioBrowserData.scenarios?.filter(s => s.categoryId === categoryId) || [];
        
        if (scenarios.length === 0) {
          scenariosContainer.innerHTML = '<div style="color: #64748b; font-size: 11px; padding: 8px;">No scenarios in this category</div>';
        } else {
          let html = '';
          scenarios.forEach(s => {
            const statusColor = s.status === 'live' ? '#22c55e' : s.status === 'draft' ? '#fbbf24' : '#64748b';
            const typeLabel = s.scenarioType || 'UNKNOWN';
            const triggerCount = s.triggers?.length || s._stats?.triggerCount || 0;
            
            html += `
              <div class="sb-scenario-item" data-scenario-id="${s.scenarioId}" onclick="selectScenario('${s.scenarioId}', '${categoryId}')"
                   style="padding: 8px 10px; margin-bottom: 2px; background: #1e293b; border-radius: 4px; cursor: pointer; transition: all 0.15s; border-left: 2px solid transparent;">
                <div style="font-size: 11px; font-weight: 500; color: #e2e8f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${s.name}</div>
                <div style="display: flex; gap: 8px; margin-top: 4px; font-size: 9px;">
                  <span style="color: ${statusColor};">â— ${s.status || 'draft'}</span>
                  <span style="color: #a78bfa;">${typeLabel}</span>
                  <span style="color: #64748b;">${triggerCount} triggers</span>
                </div>
              </div>
            `;
          });
          scenariosContainer.innerHTML = html;
        }
      }
    }
    
    function selectScenario(scenarioId, categoryId) {
      console.log('[SCENARIO BROWSER] selectScenario called:', { scenarioId, categoryId });
      
      // Highlight selected scenario
      document.querySelectorAll('.sb-scenario-item').forEach(el => {
        el.style.background = '#1e293b';
        el.style.borderLeftColor = 'transparent';
      });
      
      const selectedEl = document.querySelector(`.sb-scenario-item[data-scenario-id="${scenarioId}"]`);
      if (selectedEl) {
        selectedEl.style.background = '#334155';
        selectedEl.style.borderLeftColor = '#a78bfa';
      }
      
      selectedScenarioId = scenarioId;
      
      // Find scenario data
      console.log('[SCENARIO BROWSER] Looking for category:', categoryId, 'in data:', scenarioBrowserData?.categories?.length, 'categories');
      const category = scenarioBrowserData.categories?.find(c => c.categoryId === categoryId);
      console.log('[SCENARIO BROWSER] Found category:', category ? category.name : 'NOT FOUND');
      
      let scenario = category?.scenarios?.find(s => s.scenarioId === scenarioId);
      console.log('[SCENARIO BROWSER] Found scenario in category:', scenario ? scenario.name : 'NOT FOUND');
      
      if (!scenario) {
        console.log('[SCENARIO BROWSER] Trying fallback search in top-level scenarios array...');
        scenario = scenarioBrowserData.scenarios?.find(s => s.scenarioId === scenarioId);
        console.log('[SCENARIO BROWSER] Fallback result:', scenario ? scenario.name : 'NOT FOUND');
      }
      
      if (scenario) {
        console.log('[SCENARIO BROWSER] Rendering scenario:', scenario.name);
        selectedScenarioData = scenario;
        renderScenarioJson(scenario);
      } else {
        console.error('[SCENARIO BROWSER] ERROR: Could not find scenario!', { scenarioId, categoryId });
        document.getElementById('sb-scenario-name').textContent = 'Scenario not found';
        document.getElementById('sb-scenario-meta').textContent = 'Error: Could not find scenario data';
        document.getElementById('sb-json-viewer').textContent = JSON.stringify({
          error: 'Scenario not found',
          searchedFor: { scenarioId, categoryId },
          availableCategories: scenarioBrowserData?.categories?.map(c => ({ id: c.categoryId, name: c.name })) || []
        }, null, 2);
      }
    }
    
    function renderScenarioJson(scenario) {
      console.log('[SCENARIO BROWSER] renderScenarioJson called for:', scenario?.name || 'UNKNOWN');
      
      // Update header
      const nameEl = document.getElementById('sb-scenario-name');
      const metaEl = document.getElementById('sb-scenario-meta');
      const jsonViewer = document.getElementById('sb-json-viewer');
      
      console.log('[SCENARIO BROWSER] Elements found:', {
        nameEl: !!nameEl,
        metaEl: !!metaEl,
        jsonViewer: !!jsonViewer
      });
      
      if (!nameEl || !metaEl || !jsonViewer) {
        console.error('[SCENARIO BROWSER] ERROR: Required DOM elements not found!');
        return;
      }
      
      nameEl.textContent = scenario.name || 'Unnamed';
      
      const statusColor = scenario.status === 'live' ? '#22c55e' : '#fbbf24';
      const typeLabel = scenario.scenarioType || 'UNKNOWN';
      const typeColor = typeLabel === 'UNKNOWN' || typeLabel === '' ? '#f87171' : '#a78bfa';
      const triggerCount = scenario.triggers?.length || scenario._stats?.triggerCount || 0;
      
      metaEl.innerHTML = `
        <span style="color: ${statusColor};">â— ${scenario.status || 'draft'}</span>
        <span style="margin-left: 8px;">Type: <span style="color: ${typeColor}; font-weight: 600;">${typeLabel || 'UNKNOWN'}</span></span>
        <span style="margin-left: 8px;">Priority: ${scenario.priority || 0}</span>
        <span style="margin-left: 8px;">Triggers: ${triggerCount}</span>
      `;
      
      // Build badges
      let badges = '';
      if (scenario.transferTarget) {
        badges += '<span style="background: #f59e0b; color: black; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600;">TRANSFER</span>';
      }
      if (scenario.actionHooks?.length > 0) {
        badges += '<span style="background: #06b6d4; color: black; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600; margin-left: 4px;">HOOKS</span>';
      }
      if (scenario.flowId) {
        badges += '<span style="background: #8b5cf6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600; margin-left: 4px;">FLOW</span>';
      }
      if (scenario.bookingIntent) {
        badges += '<span style="background: #22c55e; color: black; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600; margin-left: 4px;">BOOKING</span>';
      }
      document.getElementById('sb-scenario-badges').innerHTML = badges;
      
      // AUDIT mode: Update quick report from backend data (NOT client-side generated)
      if (scenarioBrowserMode === 'audit' && scenario._auditReport) {
        const report = scenario._auditReport;
        
        // Grade
        const gradeEl = document.getElementById('sb-scenario-grade');
        gradeEl.textContent = report.grade || '-';
        gradeEl.style.color = report.grade === 'A' ? '#22c55e' : report.grade === 'B' ? '#84cc16' : report.grade === 'C' ? '#fbbf24' : report.grade === 'D' ? '#f97316' : '#ef4444';
        
        // Score
        document.getElementById('sb-scenario-score').textContent = (report.score || 0) + '%';
        
        // Enterprise Ready
        const readyEl = document.getElementById('sb-scenario-ready');
        readyEl.textContent = report.enterpriseReady ? 'âœ… YES' : 'âŒ NO';
        readyEl.style.color = report.enterpriseReady ? '#22c55e' : '#ef4444';
        
        // Issues
        const issues = [...(report.issues || []), ...(report.warnings || [])];
        document.getElementById('sb-scenario-issues').textContent = issues.length > 0 ? issues.slice(0, 3).join(' | ') : '';
      }
      
      // Render JSON - RAW mode already has pure data, AUDIT mode already has computed blocks
      // NO client-side generation - data comes from separate endpoints
      console.log('[SCENARIO BROWSER] Setting JSON viewer content, scenario keys:', Object.keys(scenario));
      jsonViewer.textContent = JSON.stringify(scenario, null, 2);
      console.log('[SCENARIO BROWSER] renderScenarioJson complete');
    }
    
    function generateAuditReport(scenario) {
      const report = {
        generatedAt: new Date().toISOString(),
        mode: 'AUDIT',
        checks: {},
        issues: [],
        warnings: [],
        grade: 'F',
        score: 0
      };
      
      let score = 100;
      
      // Check triggers
      const triggerCount = scenario.triggers?.length || 0;
      report.checks.triggers = { count: triggerCount, required: 8, pass: triggerCount >= 8 };
      if (triggerCount < 8) {
        report.issues.push(`Triggers: ${triggerCount}/8 required`);
        score -= (8 - triggerCount) * 5;
      }
      
      // Check negative triggers
      const negCount = scenario.negativeTriggers?.length || 0;
      report.checks.negativeTriggers = { count: negCount, required: 3, pass: negCount >= 3 };
      if (negCount < 3) {
        report.warnings.push(`Negative triggers: ${negCount}/3 recommended`);
        score -= (3 - negCount) * 3;
      }
      
      // Check quick replies
      const quickCount = scenario.quickReplies?.length || 0;
      report.checks.quickReplies = { count: quickCount, required: 7, pass: quickCount >= 7 };
      if (quickCount < 7) {
        report.issues.push(`Quick replies: ${quickCount}/7 required`);
        score -= (7 - quickCount) * 3;
      }
      
      // Check full replies
      const fullCount = scenario.fullReplies?.length || 0;
      report.checks.fullReplies = { count: fullCount, required: 7, pass: fullCount >= 7 };
      if (fullCount < 7) {
        report.warnings.push(`Full replies: ${fullCount}/7 recommended`);
        score -= (7 - fullCount) * 2;
      }
      
      // Check scenarioType
      const hasType = scenario.scenarioType && scenario.scenarioType !== 'UNKNOWN' && scenario.scenarioType !== '';
      report.checks.scenarioType = { value: scenario.scenarioType || 'UNKNOWN', valid: hasType };
      if (!hasType) {
        report.issues.push('scenarioType is UNKNOWN or empty');
        score -= 10;
      }
      
      // Check wiring
      const hasWiring = !!(scenario.actionType && scenario.actionType !== 'REPLY_ONLY') || 
                        !!(scenario.flowId) || 
                        !!(scenario.transferTarget) || 
                        !!(scenario.bookingIntent);
      report.checks.wiring = { 
        actionType: scenario.actionType || 'REPLY_ONLY',
        flowId: scenario.flowId || null,
        transferTarget: scenario.transferTarget || null,
        bookingIntent: scenario.bookingIntent || false,
        hasExplicitWiring: hasWiring
      };
      
      // Calculate grade
      score = Math.max(0, score);
      report.score = score;
      
      if (score >= 90) report.grade = 'A';
      else if (score >= 80) report.grade = 'B';
      else if (score >= 70) report.grade = 'C';
      else if (score >= 60) report.grade = 'D';
      else report.grade = 'F';
      
      report.enterpriseReady = report.grade !== 'F' && report.issues.length === 0;
      
      return report;
    }
    
    function filterScenarioBrowser(query) {
      if (!scenarioBrowserData) return;
      
      const q = query.toLowerCase().trim();
      
      // If empty, show all
      if (!q) {
        renderCategoriesTree(scenarioBrowserData.categories);
        return;
      }
      
      // Filter categories that have matching scenarios
      const filteredCategories = [];
      
      for (const cat of scenarioBrowserData.categories || []) {
        const matchingScenarios = (cat.scenarios || []).filter(s => {
          return (
            s.name?.toLowerCase().includes(q) ||
            s.scenarioId?.toLowerCase().includes(q) ||
            s.actionType?.toLowerCase().includes(q) ||
            s.flowId?.toLowerCase().includes(q) ||
            s.scenarioType?.toLowerCase().includes(q) ||
            s.transferTarget?.toLowerCase().includes(q) ||
            (s.triggers || []).some(t => t.toLowerCase().includes(q)) ||
            (s.actionHooks || []).some(h => (typeof h === 'string' ? h : JSON.stringify(h)).toLowerCase().includes(q))
          );
        });
        
        if (matchingScenarios.length > 0 || cat.name.toLowerCase().includes(q)) {
          filteredCategories.push({
            ...cat,
            scenarios: matchingScenarios.length > 0 ? matchingScenarios : cat.scenarios,
            _stats: {
              ...cat._stats,
              scenarioCount: matchingScenarios.length > 0 ? matchingScenarios.length : (cat._stats?.scenarioCount || cat.scenarios?.length || 0)
            }
          });
        }
      }
      
      // Update counts
      const totalScenarios = filteredCategories.reduce((sum, c) => sum + (c.scenarios?.length || 0), 0);
      document.getElementById('sb-cat-count').textContent = filteredCategories.length;
      document.getElementById('sb-scenario-count').textContent = totalScenarios;
      
      renderCategoriesTree(filteredCategories);
    }
    
    function highlightInJson(query) {
      const jsonViewer = document.getElementById('sb-json-viewer');
      const findCountEl = document.getElementById('sb-find-count');
      
      if (!selectedScenarioData || !query) {
        // Reset to normal
        renderScenarioJson(selectedScenarioData);
        findCountEl.textContent = '';
        return;
      }
      
      const text = jsonViewer.textContent;
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      const matches = text.match(regex);
      
      if (matches) {
        const highlighted = text.replace(regex, '<mark style="background: #fbbf24; color: black; padding: 0 2px;">$1</mark>');
        jsonViewer.innerHTML = highlighted;
        findCountEl.textContent = `${matches.length} found`;
        findCountEl.style.color = '#22c55e';
      } else {
        findCountEl.textContent = 'No matches';
        findCountEl.style.color = '#f87171';
      }
    }
    
    function copySelectedScenario() {
      if (!selectedScenarioData) {
        showSnapshotToast('âš ï¸ Select a scenario first', 'warning');
        return;
      }
      
      // Data already comes from correct endpoint (RAW or AUDIT) - no client-side manipulation needed
      navigator.clipboard.writeText(JSON.stringify(selectedScenarioData, null, 2)).then(() => {
        showSnapshotToast(`âœ… Copied ${selectedScenarioData.name} (${scenarioBrowserMode.toUpperCase()} mode)`, 'success');
      }).catch(err => {
        showSnapshotToast('âŒ Copy failed: ' + err.message, 'error');
      });
      
      document.getElementById('sb-export-dropdown').style.display = 'none';
    }
    
    function downloadSelectedScenario() {
      if (!selectedScenarioData) {
        showSnapshotToast('âš ï¸ Select a scenario first', 'warning');
        return;
      }
      
      // Data already comes from correct endpoint - no client-side manipulation needed
      const filename = `${selectedScenarioData.name?.replace(/\s+/g, '-').toLowerCase() || 'scenario'}-${scenarioBrowserMode}.json`;
      const blob = new Blob([JSON.stringify(selectedScenarioData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showSnapshotToast(`âœ… Downloaded ${filename}`, 'success');
      document.getElementById('sb-export-dropdown').style.display = 'none';
    }
    
    // Export ALL scenarios (RAW)
    async function exportAllScenariosRAW() {
      if (!scenarioBrowserRawData) {
        // Load RAW data if not cached
        const response = await fetch(`/api/company/${currentCompanyId}/scenarios-raw`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const result = await response.json();
        if (result.success) scenarioBrowserRawData = result.data;
      }
      
      if (!scenarioBrowserRawData) {
        showSnapshotToast('âš ï¸ Failed to load RAW data', 'warning');
        return;
      }
      
      const filename = `${scenarioBrowserRawData.companyName?.replace(/\s+/g, '-').toLowerCase() || 'company'}-scenarios-raw.json`;
      const blob = new Blob([JSON.stringify(scenarioBrowserRawData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      const size = (JSON.stringify(scenarioBrowserRawData).length / 1024).toFixed(1);
      showSnapshotToast(`âœ… Downloaded RAW export (${size} KB)`, 'success');
      document.getElementById('sb-export-dropdown').style.display = 'none';
    }
    
    // Export ALL scenarios (AUDIT)
    async function exportAllScenariosAUDIT() {
      if (!scenarioBrowserAuditData) {
        // Load AUDIT data if not cached
        const response = await fetch(`/api/company/${currentCompanyId}/scenarios-audit`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const result = await response.json();
        if (result.success) scenarioBrowserAuditData = result.data;
      }
      
      if (!scenarioBrowserAuditData) {
        showSnapshotToast('âš ï¸ Failed to load AUDIT data', 'warning');
        return;
      }
      
      const filename = `${scenarioBrowserAuditData.companyName?.replace(/\s+/g, '-').toLowerCase() || 'company'}-scenarios-audit.json`;
      const blob = new Blob([JSON.stringify(scenarioBrowserAuditData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      const size = (JSON.stringify(scenarioBrowserAuditData).length / 1024).toFixed(1);
      const summary = scenarioBrowserAuditData._summary || {};
      showSnapshotToast(`âœ… Downloaded AUDIT export (${size} KB, ${summary.health || 'UNKNOWN'} health)`, 'success');
      document.getElementById('sb-export-dropdown').style.display = 'none';
    }
  </script>
  
  <script>
    let currentScenarioReport = null;
    
    async function openScenarioReportModal() {
      document.getElementById('scenario-report-modal-overlay').classList.add('active');
      await loadScenarioReport();
    }
    
    function closeScenarioReportModal() {
      document.getElementById('scenario-report-modal-overlay').classList.remove('active');
    }
    
    async function loadScenarioReport() {
      const summaryEls = {
        total: document.getElementById('sr-total'),
        ready: document.getElementById('sr-ready'),
        notReady: document.getElementById('sr-not-ready'),
        percent: document.getElementById('sr-percent'),
        collisions: document.getElementById('sr-collisions')
      };
      const gradesEl = document.getElementById('scenario-report-grades');
      const issuesEl = document.getElementById('scenario-report-issues');
      const jsonEl = document.getElementById('scenario-report-json');
      const healthEl = document.getElementById('scenario-report-health');
      
      // Show loading
      summaryEls.total.textContent = '...';
      summaryEls.ready.textContent = '...';
      summaryEls.notReady.textContent = '...';
      summaryEls.percent.textContent = '...';
      summaryEls.collisions.textContent = '...';
      gradesEl.innerHTML = '<div style="color: #94a3b8;">Loading...</div>';
      issuesEl.innerHTML = '<div style="color: #94a3b8;">Loading...</div>';
      jsonEl.textContent = 'Loading...';
      
      try {
        // Get the selected template ID from the company config
        const configResponse = await fetch(`/api/company/${currentCompanyId}/configuration/templates`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const configResult = await configResponse.json();
        
        let templateId = null;
        if (configResult.success && configResult.data?.templateReferences?.length > 0) {
          const primaryTemplate = configResult.data.templateReferences.find(t => t.enabled);
          if (primaryTemplate) {
            templateId = primaryTemplate.templateId;
          }
        }
        
        // Load scenario export
        const url = templateId 
          ? `/api/company/${currentCompanyId}/scenario-export?templateId=${templateId}`
          : `/api/company/${currentCompanyId}/scenario-export`;
          
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to load scenario report');
        }
        
        currentScenarioReport = result.data;
        
        // Extract data
        const qs = result.data.qualitySummary || {};
        const gradesDist = qs.gradeDistribution || {};
        const statusDist = qs.statusDistribution || {};
        const collisions = result.data.collisions || {};
        const topIssues = result.data.topIssues || [];
        const total = qs.totalScenarios || 0;
        const enterpriseReady = qs.compliance?.enterpriseReady || 0;
        const notReady = total - enterpriseReady;
        const percentReady = qs.percentEnterpriseReady || 0;
        
        // Update summary
        summaryEls.total.textContent = total;
        summaryEls.ready.textContent = enterpriseReady;
        summaryEls.notReady.textContent = notReady;
        summaryEls.percent.textContent = `${percentReady}%`;
        summaryEls.collisions.textContent = collisions.count || 0;
        
        // Health badge
        const health = result.data.health || 'RED';
        const healthColors = {
          GREEN: { bg: '#10b981', text: 'white', label: 'GREEN - Production Ready' },
          YELLOW: { bg: '#f59e0b', text: '#1e293b', label: 'YELLOW - Needs Work' },
          RED: { bg: '#ef4444', text: 'white', label: 'RED - Critical Issues' }
        };
        const hc = healthColors[health] || healthColors.RED;
        healthEl.style.background = hc.bg;
        healthEl.style.color = hc.text;
        healthEl.textContent = hc.label;
        
        // Grade distribution bars
        const maxGrade = Math.max(gradesDist.A || 0, gradesDist.B || 0, gradesDist.C || 0, gradesDist.D || 0, gradesDist.F || 0, 1);
        const gradeColors = { A: '#10b981', B: '#34d399', C: '#fbbf24', D: '#f97316', F: '#ef4444' };
        gradesEl.innerHTML = ['A', 'B', 'C', 'D', 'F'].map(g => {
          const count = gradesDist[g] || 0;
          const height = Math.max(20, (count / maxGrade) * 100);
          return `
            <div style="flex: 1; text-align: center;">
              <div style="background: ${gradeColors[g]}; height: ${height}px; border-radius: 4px 4px 0 0; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 4px;">
                <span style="color: white; font-weight: 700; font-size: 14px;">${count}</span>
              </div>
              <div style="background: #0f172a; padding: 6px; border-radius: 0 0 4px 4px;">
                <span style="color: ${gradeColors[g]}; font-weight: 700; font-size: 16px;">${g}</span>
              </div>
            </div>
          `;
        }).join('');
        
        // Top issues
        if (topIssues.length === 0) {
          issuesEl.innerHTML = '<div style="color: #10b981; padding: 12px; background: #0f172a; border-radius: 8px;">âœ… No issues - all scenarios meet requirements</div>';
        } else {
          issuesEl.innerHTML = topIssues.map(issue => {
            const gradeColor = gradeColors[issue.grade] || '#ef4444';
            return `
              <div style="background: #0f172a; padding: 12px; border-radius: 8px; border-left: 4px solid ${gradeColor};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                  <strong style="color: #f1f5f9; font-size: 13px;">${issue.name || 'Unknown'}</strong>
                  <span style="background: ${gradeColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">Grade ${issue.grade}</span>
                </div>
                <div style="color: #94a3b8; font-size: 11px; display: flex; flex-wrap: wrap; gap: 8px;">
                  ${(issue.issues || []).map(i => `<span style="background: #1e293b; padding: 2px 6px; border-radius: 4px;">${i}</span>`).join('')}
                </div>
              </div>
            `;
          }).join('');
        }
        
        // Full JSON
        jsonEl.textContent = JSON.stringify(result.data, null, 2);
        
      } catch (error) {
        console.error('Failed to load scenario report:', error);
        healthEl.style.background = '#ef4444';
        healthEl.style.color = 'white';
        healthEl.textContent = 'ERROR';
        issuesEl.innerHTML = `<div style="color: #ef4444; padding: 12px; background: #0f172a; border-radius: 8px;">âŒ ${error.message}</div>`;
        jsonEl.textContent = `Error: ${error.message}`;
      }
    }
    
    function copyScenarioReport() {
      if (!currentScenarioReport) {
        showSnapshotToast('Load report first', 'warning');
        return;
      }
      
      const jsonStr = JSON.stringify(currentScenarioReport, null, 2);
      navigator.clipboard.writeText(jsonStr).then(() => {
        const qs = currentScenarioReport.qualitySummary || {};
        showSnapshotToast(
          `Scenario Report copied! ${qs.totalScenarios || 0} scenarios, ${(jsonStr.length / 1024).toFixed(1)} KB`,
          'success'
        );
      }).catch(err => {
        showSnapshotToast('Failed to copy: ' + err.message, 'error');
      });
    }
  </script>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PATCH IMPORT MODAL - Safe JSON Patch Import
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="patch-import-modal-overlay" class="snapshot-modal-overlay">
    <div class="snapshot-modal" style="max-width: 900px;">
      <div class="snapshot-modal-header" style="background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);">
        <div class="snapshot-modal-title">
          <h2 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸ“ Patch Import - Apply Changes via JSON</h2>
          <p style="margin: 4px 0 0; font-size: 12px; opacity: 0.9;">Safe, validated patches with allowlisted paths only</p>
        </div>
        <div class="snapshot-modal-controls" style="display: flex; gap: 8px;">
          <button onclick="loadPatchSchema()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-info-circle"></i> View Schema
          </button>
          <button onclick="generatePatchSkeleton()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-file-code"></i> Generate Skeleton
          </button>
          <button onclick="closePatchImportModal()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="snapshot-modal-body" style="padding: 20px; max-height: 75vh; overflow-y: auto;">
        <!-- Instructions -->
        <div style="background: #fdf4ff; border: 1px solid #ec4899; border-radius: 10px; padding: 16px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 8px 0; color: #831843; font-size: 14px;">ğŸ“‹ How to Use</h4>
          <ol style="margin: 0; padding-left: 20px; color: #9d174d; font-size: 13px;">
            <li>Paste a JSON patch payload below (RFC 6902 format)</li>
            <li>Click "Validate" to check for errors before applying</li>
            <li>Click "Apply" to make the changes (or uncheck "Dry Run")</li>
            <li>Click "Refresh Runtime Truth" to verify changes</li>
          </ol>
        </div>
        
        <!-- Patch Input -->
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-weight: 600; color: #1e293b; margin-bottom: 8px;">
            Patch Payload (JSON)
          </label>
          <textarea id="patch-input" 
                    style="width: 100%; height: 200px; font-family: monospace; font-size: 12px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: #f8fafc; color: #334155; resize: vertical;"
                    placeholder='{
  "companyId": "{{companyId}}",
  "scope": "companyOverride",
  "patches": [
    { "op": "replace", "path": "/controlPlane/greeting/text", "value": "Thanks for calling!" },
    { "op": "replace", "path": "/dynamicFlows/flows/{{flowId}}/enabled", "value": true }
  ]
}'></textarea>
        </div>
        
        <!-- Controls -->
        <div style="display: flex; gap: 12px; margin-bottom: 20px; align-items: center;">
          <label style="display: flex; align-items: center; gap: 6px; color: #64748b; font-size: 13px;">
            <input type="checkbox" id="patch-dry-run" checked style="accent-color: #ec4899;">
            Dry Run (validate only)
          </label>
          <button onclick="validatePatch()" 
                  style="padding: 10px 20px; background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-check-circle"></i> Validate
          </button>
          <button onclick="applyPatch()" 
                  style="padding: 10px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-play"></i> Apply
          </button>
          <button onclick="openRuntimeTruthModal()" 
                  style="padding: 10px 20px; background: white; color: #10b981; border: 2px solid #10b981; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-sync-alt"></i> Refresh Runtime Truth
          </button>
        </div>
        
        <!-- Results Panel -->
        <div id="patch-results" style="display: none;">
          <div style="background: #0f172a; border-radius: 12px; overflow: hidden;">
            <div id="patch-results-header" style="padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #94a3b8; font-weight: 600; font-size: 14px;">ğŸ“Š Results</span>
              <span id="patch-results-status" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;"></span>
            </div>
            <pre id="patch-results-json" style="margin: 0; padding: 16px; color: #22d3ee; font-size: 11px; line-height: 1.5; overflow-x: auto; max-height: 300px; overflow-y: auto;"></pre>
          </div>
        </div>
        
        <!-- Schema Panel (hidden by default) -->
        <div id="patch-schema-panel" style="display: none; margin-top: 20px;">
          <div style="background: #0f172a; border-radius: 12px; overflow: hidden;">
            <div style="padding: 12px 16px; background: #1e293b; display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #94a3b8; font-weight: 600; font-size: 14px;">ğŸ“‹ Allowlisted Paths (Schema)</span>
              <button onclick="document.getElementById('patch-schema-panel').style.display='none'" 
                      style="background: transparent; border: none; color: #94a3b8; cursor: pointer;">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <pre id="patch-schema-json" style="margin: 0; padding: 16px; color: #a5f3fc; font-size: 11px; line-height: 1.5; overflow-x: auto; max-height: 400px; overflow-y: auto;"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // ============================================================================
    // PATCH IMPORT - Safe JSON Patch Import
    // ============================================================================
    
    function openPatchImportModal() {
      document.getElementById('patch-import-modal-overlay').classList.add('active');
      // Pre-fill with company ID
      const textarea = document.getElementById('patch-input');
      if (!textarea.value || textarea.value.includes('{{companyId}}')) {
        textarea.value = JSON.stringify({
          companyId: currentCompanyId,
          scope: "companyOverride",
          patches: [
            { op: "replace", path: "/controlPlane/greeting/text", value: "Thanks for calling {{companyName}}!" }
          ]
        }, null, 2);
      }
    }
    
    function closePatchImportModal() {
      document.getElementById('patch-import-modal-overlay').classList.remove('active');
    }
    
    async function loadPatchSchema() {
      const schemaPanel = document.getElementById('patch-schema-panel');
      const schemaJson = document.getElementById('patch-schema-json');
      
      schemaPanel.style.display = 'block';
      schemaJson.textContent = 'Loading schema...';
      
      try {
        const response = await fetch(`/api/company/${currentCompanyId}/runtime-patch/schema`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const result = await response.json();
        schemaJson.textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        schemaJson.textContent = `Error: ${error.message}`;
      }
    }
    
    function generatePatchSkeleton() {
      if (!currentRuntimeTruth) {
        showSnapshotToast('Load Runtime Truth first to generate skeleton', 'warning');
        openRuntimeTruthModal();
        return;
      }
      
      // Build a patch skeleton with common changes
      const skeleton = {
        companyId: currentCompanyId,
        scope: "companyOverride",
        expectedVersion: currentRuntimeTruth._meta?.version,
        patches: []
      };
      
      // Add greeting if not configured
      if (!currentRuntimeTruth.controlPlane?.greeting?.configured) {
        skeleton.patches.push({
          op: "replace",
          path: "/controlPlane/greeting/text",
          value: "Thanks for calling {{companyName}} â€” how can I help?"
        });
      }
      
      // Add flow enable if none enabled
      if (currentRuntimeTruth.dynamicFlows?.flows?.length > 0 && !currentRuntimeTruth.dynamicFlows?.enabled) {
        const firstFlow = currentRuntimeTruth.dynamicFlows.flows[0];
        skeleton.patches.push({
          op: "replace",
          path: `/dynamicFlows/flows/${firstFlow.id}/enabled`,
          value: true
        });
      }
      
      // Add scenarioType fixes for UNKNOWN scenarios
      const unknownScenarios = (currentRuntimeTruth.scenarioBrain?.scenarios || [])
        .filter(s => s.scenarioType === 'UNKNOWN')
        .slice(0, 5); // First 5
        
      unknownScenarios.forEach(s => {
        // Guess type from category name
        let type = 'FAQ';
        const catName = (s.categoryName || '').toLowerCase();
        if (catName.includes('emergency') || catName.includes('leak') || catName.includes('no cool') || catName.includes('no heat')) {
          type = 'EMERGENCY';
        } else if (catName.includes('book') || catName.includes('schedule') || catName.includes('appointment')) {
          type = 'BOOKING';
        } else if (catName.includes('transfer') || catName.includes('speak')) {
          type = 'TRANSFER';
        }
        
        skeleton.patches.push({
          op: "replace",
          path: `/scenarioBrain/scenarios/${s.id}/scenarioType`,
          value: type
        });
      });
      
      // Populate textarea
      document.getElementById('patch-input').value = JSON.stringify(skeleton, null, 2);
      showSnapshotToast(`Generated ${skeleton.patches.length} patch suggestions`, 'success');
    }
    
    async function validatePatch() {
      const textarea = document.getElementById('patch-input');
      const resultsPanel = document.getElementById('patch-results');
      const resultsJson = document.getElementById('patch-results-json');
      const resultsStatus = document.getElementById('patch-results-status');
      const resultsHeader = document.getElementById('patch-results-header');
      
      resultsPanel.style.display = 'block';
      resultsJson.textContent = 'Validating...';
      
      try {
        const payload = JSON.parse(textarea.value);
        
        const response = await fetch(`/api/company/${currentCompanyId}/runtime-patch?dryRun=1`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (result.success) {
          resultsStatus.textContent = `âœ“ Valid (${result.validCount}/${result.patchCount} patches)`;
          resultsStatus.style.background = '#10b981';
          resultsStatus.style.color = 'white';
          resultsHeader.style.background = '#065f46';
        } else {
          resultsStatus.textContent = `âœ— Errors (${result.errors?.length || 0})`;
          resultsStatus.style.background = '#ef4444';
          resultsStatus.style.color = 'white';
          resultsHeader.style.background = '#7f1d1d';
        }
        
        resultsJson.textContent = JSON.stringify(result, null, 2);
        
      } catch (error) {
        resultsStatus.textContent = 'Parse Error';
        resultsStatus.style.background = '#ef4444';
        resultsStatus.style.color = 'white';
        resultsHeader.style.background = '#7f1d1d';
        resultsJson.textContent = `JSON Parse Error: ${error.message}\n\nMake sure your JSON is valid.`;
      }
    }
    
    async function applyPatch() {
      const textarea = document.getElementById('patch-input');
      const dryRun = document.getElementById('patch-dry-run').checked;
      const resultsPanel = document.getElementById('patch-results');
      const resultsJson = document.getElementById('patch-results-json');
      const resultsStatus = document.getElementById('patch-results-status');
      const resultsHeader = document.getElementById('patch-results-header');
      
      if (dryRun) {
        return validatePatch(); // Just validate if dry run is checked
      }
      
      resultsPanel.style.display = 'block';
      resultsJson.textContent = 'Applying patches...';
      
      try {
        const payload = JSON.parse(textarea.value);
        
        const response = await fetch(`/api/company/${currentCompanyId}/runtime-patch`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (result.success && result.appliedCount > 0) {
          resultsStatus.textContent = `âœ“ Applied ${result.appliedCount}/${result.patchCount}`;
          resultsStatus.style.background = '#10b981';
          resultsStatus.style.color = 'white';
          resultsHeader.style.background = '#065f46';
          
          showSnapshotToast(`Applied ${result.appliedCount} patches successfully!`, 'success');
        } else if (result.errors?.length > 0) {
          resultsStatus.textContent = `âœ— Failed (${result.errors.length} errors)`;
          resultsStatus.style.background = '#ef4444';
          resultsStatus.style.color = 'white';
          resultsHeader.style.background = '#7f1d1d';
        } else {
          resultsStatus.textContent = `âš  No changes made`;
          resultsStatus.style.background = '#f59e0b';
          resultsStatus.style.color = '#1e293b';
          resultsHeader.style.background = '#78350f';
        }
        
        resultsJson.textContent = JSON.stringify(result, null, 2);
        
      } catch (error) {
        resultsStatus.textContent = 'Error';
        resultsStatus.style.background = '#ef4444';
        resultsStatus.style.color = 'white';
        resultsHeader.style.background = '#7f1d1d';
        resultsJson.textContent = `Error: ${error.message}`;
      }
    }
  </script>
  
  <script>
    // ============================================================================
    // FIELD REPORT (Schema vs UI)
    // ============================================================================
    let currentFieldReport = null;
    
    function openFieldReportModal() {
      document.getElementById('field-report-modal-overlay').classList.add('active');
      generateFieldReport();
    }
    
    function closeFieldReportModal() {
      document.getElementById('field-report-modal-overlay').classList.remove('active');
    }
    
    function generateFieldReport() {
      // Complete schema field inventory
      const schemaFields = {
        // === SCENARIO FIELDS ===
        scenario: {
          // IDENTITY
          'scenarioId': { section: 'Basic Info', exposed: true, selector: '#scenario-id', default: null, deprecated: false },
          'name': { section: 'Basic Info', exposed: true, selector: '#scenario-name', default: null, deprecated: false },
          'version': { section: 'Basic Info', exposed: true, selector: '#scenario-version', default: 1, deprecated: false },
          'status': { section: 'Basic Info', exposed: true, selector: '#scenario-status', default: 'draft', deprecated: false },
          'isActive': { section: 'Basic Info', exposed: true, selector: '#scenario-active', default: true, deprecated: false },
          'categories': { section: 'Basic Info', exposed: true, selector: '#scenario-categories', default: [], deprecated: false },
          'notes': { section: 'Basic Info', exposed: true, selector: '#scenario-notes', default: '', deprecated: false },
          
          // TRIGGERS
          'triggers': { section: 'Triggers & Matching', exposed: true, selector: '#scenario-triggers', default: [], deprecated: false },
          'negativeTriggers': { section: 'Triggers & Matching', exposed: true, selector: '#negative-triggers', default: [], deprecated: false },
          'regexTriggers': { section: 'Triggers & Matching', exposed: true, selector: '#regex-triggers', default: [], deprecated: false },
          'keywords': { section: 'Triggers & Matching', exposed: false, selector: null, default: [], deprecated: false },
          'negativeKeywords': { section: 'Triggers & Matching', exposed: false, selector: null, default: [], deprecated: false },
          'exampleUserPhrases': { section: 'Triggers & Matching', exposed: false, selector: null, default: [], deprecated: false },
          'negativeUserPhrases': { section: 'Triggers & Matching', exposed: false, selector: null, default: [], deprecated: false },
          'contextWeight': { section: 'Triggers & Matching', exposed: false, selector: null, default: 0.7, deprecated: false },
          'testPhrases': { section: 'Triggers & Matching', exposed: false, selector: null, default: [], deprecated: false },
          'embeddingVector': { section: 'Triggers & Matching', exposed: false, selector: null, default: null, deprecated: false, computed: true },
          
          // REPLIES
          'quickReplies': { section: 'Replies & Flow', exposed: true, selector: '#quick-replies', default: [], deprecated: false },
          'fullReplies': { section: 'Replies & Flow', exposed: true, selector: '#full-replies', default: [], deprecated: false },
          'followUpPrompts': { section: 'Replies & Flow', exposed: false, selector: null, default: [], deprecated: false },
          'followUpFunnel': { section: 'Replies & Flow', exposed: false, selector: null, default: null, deprecated: false },
          'replySelection': { section: 'Replies & Flow', exposed: false, selector: null, default: 'bandit', deprecated: false },
          'scenarioType': { section: 'Replies & Flow', exposed: false, selector: null, default: null, deprecated: false },
          'replyStrategy': { section: 'Replies & Flow', exposed: false, selector: null, default: 'AUTO', deprecated: false },
          'followUpMode': { section: 'Replies & Flow', exposed: false, selector: null, default: 'NONE', deprecated: false },
          'followUpQuestionText': { section: 'Replies & Flow', exposed: false, selector: null, default: null, deprecated: false },
          'transferTarget': { section: 'Replies & Flow', exposed: false, selector: null, default: null, deprecated: false },
          
          // ENTITIES
          'entityCapture': { section: 'Entities & Variables', exposed: false, selector: null, default: [], deprecated: false },
          'entityValidation': { section: 'Entities & Variables', exposed: false, selector: null, default: {}, deprecated: false },
          'dynamicVariables': { section: 'Entities & Variables', exposed: false, selector: null, default: {}, deprecated: false },
          'qnaPairs': { section: 'Entities & Variables', exposed: false, selector: null, default: [], deprecated: false, computed: true },
          'examples': { section: 'Entities & Variables', exposed: false, selector: null, default: [], deprecated: false },
          
          // ADVANCED
          'minConfidence': { section: 'Advanced Settings', exposed: false, selector: null, default: null, deprecated: false },
          'priority': { section: 'Advanced Settings', exposed: true, selector: '#scenario-priority', default: 0, deprecated: false },
          'cooldownSeconds': { section: 'Advanced Settings', exposed: false, selector: null, default: 0, deprecated: false },
          'channel': { section: 'Advanced Settings', exposed: false, selector: null, default: 'any', deprecated: false },
          'language': { section: 'Advanced Settings', exposed: false, selector: null, default: 'auto', deprecated: false },
          'preconditions': { section: 'Advanced Settings', exposed: false, selector: null, default: null, deprecated: false },
          'effects': { section: 'Advanced Settings', exposed: false, selector: null, default: null, deprecated: false },
          'sensitiveInfoRule': { section: 'Advanced Settings', exposed: false, selector: null, default: 'platform_default', deprecated: false },
          'customMasking': { section: 'Advanced Settings', exposed: false, selector: null, default: null, deprecated: false },
          'timedFollowUp.enabled': { section: 'Advanced Settings', exposed: false, selector: null, default: false, deprecated: false },
          'timedFollowUp.delaySeconds': { section: 'Advanced Settings', exposed: false, selector: null, default: 50, deprecated: false },
          'timedFollowUp.messages': { section: 'Advanced Settings', exposed: false, selector: null, default: [], deprecated: false },
          'timedFollowUp.extensionSeconds': { section: 'Advanced Settings', exposed: false, selector: null, default: 30, deprecated: false },
          'silencePolicy.maxConsecutive': { section: 'Advanced Settings', exposed: false, selector: null, default: 2, deprecated: false },
          'silencePolicy.finalWarning': { section: 'Advanced Settings', exposed: false, selector: null, default: 'Hello? Did I lose you?', deprecated: false },
          
          // HOOKS
          'actionHooks': { section: 'Action Hooks', exposed: false, selector: null, default: [], deprecated: false },
          'handoffPolicy': { section: 'Action Hooks', exposed: false, selector: null, default: 'low_confidence', deprecated: false },
          'escalationFlags': { section: 'Action Hooks', exposed: false, selector: null, default: [], deprecated: false },
          
          // VOICE
          'behavior': { section: 'Voice & TTS', exposed: false, selector: null, default: null, deprecated: false },
          'toneLevel': { section: 'Voice & TTS', exposed: false, selector: null, default: 2, deprecated: true },
          'ttsOverride.pitch': { section: 'Voice & TTS', exposed: false, selector: null, default: null, deprecated: false },
          'ttsOverride.rate': { section: 'Voice & TTS', exposed: false, selector: null, default: null, deprecated: false },
          'ttsOverride.volume': { section: 'Voice & TTS', exposed: false, selector: null, default: null, deprecated: false },
          
          // DEPRECATED
          'quickReply': { section: 'Deprecated', exposed: false, selector: null, default: null, deprecated: true },
          'fullReply': { section: 'Deprecated', exposed: false, selector: null, default: null, deprecated: true },
          'legacyMigrated': { section: 'Deprecated', exposed: false, selector: null, default: false, deprecated: true }
        },
        
        // === CATEGORY FIELDS ===
        category: {
          'id': { section: 'Category Settings', exposed: true, selector: '#category-id', default: null, deprecated: false },
          'name': { section: 'Category Settings', exposed: true, selector: '#category-name', default: null, deprecated: false },
          'icon': { section: 'Category Settings', exposed: true, selector: '#category-icon', default: 'ğŸ’¬', deprecated: false },
          'description': { section: 'Category Settings', exposed: true, selector: '#category-description', default: null, deprecated: false },
          'behavior': { section: 'Category Settings', exposed: false, selector: null, default: null, deprecated: true },
          'isActive': { section: 'Category Settings', exposed: true, selector: '#category-active', default: true, deprecated: false },
          'additionalFillerWords': { section: 'Category Settings', exposed: false, selector: null, default: [], deprecated: false },
          'synonymMap': { section: 'Category Settings', exposed: false, selector: null, default: {}, deprecated: false }
        },
        
        // === TEMPLATE CONTEXT ===
        templateContext: {
          'fillerWords': { section: 'Template NLP', exposed: false, selector: null, default: '(50+ defaults)', deprecated: false },
          'synonymMap': { section: 'Template NLP', exposed: false, selector: null, default: '(Map)', deprecated: false },
          'learningSettings.tier1Threshold': { section: 'Template Learning', exposed: false, selector: null, default: 0.80, deprecated: false },
          'learningSettings.tier2Threshold': { section: 'Template Learning', exposed: false, selector: null, default: 0.60, deprecated: false },
          'learningSettings.enableLearning': { section: 'Template Learning', exposed: false, selector: null, default: true, deprecated: false },
          'learningSettings.shareWithinIndustry': { section: 'Template Learning', exposed: false, selector: null, default: false, deprecated: false },
          'learningSettings.llmBudgetMonthly': { section: 'Template Learning', exposed: false, selector: null, default: 500, deprecated: false },
          'aiGatewaySettings.enableTier3': { section: 'Template AI Gateway', exposed: false, selector: null, default: true, deprecated: false },
          'intelligenceMode': { section: 'Template AI Gateway', exposed: false, selector: null, default: 'MAXIMUM', deprecated: false },
          'variableDefinitions': { section: 'Template Variables', exposed: false, selector: null, default: [], deprecated: false },
          'urgencyKeywords': { section: 'Template Keywords', exposed: false, selector: null, default: [], deprecated: false }
        }
      };
      
      // Calculate counts
      let total = 0, exposed = 0, hidden = 0, deprecated = 0;
      const fieldList = [];
      
      for (const [section, fields] of Object.entries(schemaFields)) {
        for (const [path, info] of Object.entries(fields)) {
          total++;
          if (info.deprecated) {
            deprecated++;
          } else if (info.exposed) {
            exposed++;
          } else {
            hidden++;
          }
          
          fieldList.push({
            section: section,
            path: `${section}.${path}`,
            uiSection: info.section,
            exposed: info.exposed,
            selector: info.selector,
            default: info.default,
            deprecated: info.deprecated,
            computed: info.computed || false
          });
        }
      }
      
      // Update summary
      document.getElementById('fr-total').textContent = total;
      document.getElementById('fr-exposed').textContent = exposed;
      document.getElementById('fr-hidden').textContent = hidden;
      document.getElementById('fr-deprecated').textContent = deprecated;
      
      // Build report
      currentFieldReport = {
        _meta: {
          reportType: 'FIELD_REPORT_SCHEMA_VS_UI',
          schemaVersion: 'V22',
          generatedAt: new Date().toISOString(),
          companyId: currentCompanyId
        },
        counts: {
          total,
          exposed,
          hidden,
          deprecated
        },
        bySection: {
          scenario: Object.keys(schemaFields.scenario).length,
          category: Object.keys(schemaFields.category).length,
          templateContext: Object.keys(schemaFields.templateContext).length
        },
        fields: fieldList,
        
        // Summary of what's missing
        missingFromUI: fieldList.filter(f => !f.exposed && !f.deprecated && !f.computed).map(f => ({
          path: f.path,
          section: f.uiSection,
          default: f.default
        })),
        
        // What's exposed
        exposedInUI: fieldList.filter(f => f.exposed).map(f => ({
          path: f.path,
          selector: f.selector
        }))
      };
      
      document.getElementById('field-report-json').textContent = JSON.stringify(currentFieldReport, null, 2);
    }
    
    function copyFieldReport() {
      if (!currentFieldReport) return;
      
      navigator.clipboard.writeText(JSON.stringify(currentFieldReport, null, 2)).then(() => {
        const btn = document.getElementById('btn-copy-field-report');
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.style.background = '#10b981';
        btn.style.color = 'white';
        showSnapshotToast('âœ… Field Report copied to clipboard!', 'success');
        
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-copy"></i> Copy JSON';
          btn.style.background = 'white';
          btn.style.color = '#6366f1';
        }, 2000);
      });
    }
    
    function downloadFieldReport() {
      if (!currentFieldReport) return;
      
      const blob = new Blob([JSON.stringify(currentFieldReport, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `field-report-${currentCompanyId}-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showSnapshotToast('ğŸ“¥ Field Report downloaded!', 'success');
    }
  </script>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GOLDEN HVAC AUTOFILL MODAL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="golden-autofill-modal-overlay" class="snapshot-modal-overlay" onclick="if(event.target === this) closeGoldenAutofillModal()">
    <div class="snapshot-modal" style="max-width: 1000px; max-height: 95vh; display: flex; flex-direction: column;">
      
      <div class="snapshot-modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
        <div class="snapshot-modal-title">
          <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #1e293b;">âœ¨ Golden HVAC Autofill</h2>
        </div>
        <div class="snapshot-modal-controls" style="display: flex; gap: 8px;">
          <button onclick="closeGoldenAutofillModal()" 
                  style="padding: 8px 16px; background: rgba(0,0,0,0.1); color: #1e293b; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="snapshot-modal-body" style="padding: 24px; overflow-y: auto; flex: 1;">
        
        <!-- Description -->
        <div style="background: #fef3c7; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
          <div style="font-weight: 600; color: #92400e; margin-bottom: 8px;"><i class="fas fa-magic"></i> What This Does:</div>
          <p style="font-size: 13px; color: #78350f; margin: 0;">
            Applies best-practice HVAC defaults to all scenarios in the selected template. <strong>No LLM required.</strong>
            Sets optimal confidence, priority, reply strategy, negative triggers, and more.
          </p>
        </div>
        
        <!-- Template Selection (Auto-Detected from Company Settings) -->
        <div style="margin-bottom: 20px;">
          <label style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">Working on Company's Active Template:</label>
          <div style="display: flex; align-items: center; gap: 12px;">
            <select id="autofill-template-select" 
                    style="flex: 1; padding: 10px 12px; border: 2px solid #10b981; border-radius: 6px; font-size: 14px; background: #ecfdf5; color: #047857; font-weight: 600;">
              <option value="">Loading...</option>
            </select>
            <div id="autofill-template-info" style="font-size: 12px; color: #94a3b8;"></div>
          </div>
        </div>
        
        <!-- Golden Defaults Reference -->
        <div style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #374151;"><i class="fas fa-list-check"></i> Golden Defaults Applied:</h4>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 12px;">
            <div>
              <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">Reply Strategy</div>
              <ul style="margin: 0; padding-left: 16px; color: #64748b;">
                <li>replySelection: <code>bandit</code></li>
                <li>replyStrategy: <code>AUTO</code></li>
                <li>followUpMode: <code>NONE</code> (unless ACTION_FLOW)</li>
              </ul>
            </div>
            <div>
              <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">Min Confidence (by type)</div>
              <ul style="margin: 0; padding-left: 16px; color: #64748b;">
                <li>Emergency: <code>0.60-0.70</code></li>
                <li>Normal: <code>0.45-0.60</code></li>
                <li>Small Talk: <code>0.35-0.45</code></li>
              </ul>
            </div>
            <div>
              <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">Priority (by type)</div>
              <ul style="margin: 0; padding-left: 16px; color: #64748b;">
                <li>Emergency: <code>90-100</code></li>
                <li>Booking: <code>70-85</code></li>
                <li>FAQ: <code>40-60</code></li>
                <li>Small Talk: <code>-5 to 0</code></li>
              </ul>
            </div>
            <div>
              <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">Context Weight (by type)</div>
              <ul style="margin: 0; padding-left: 16px; color: #64748b;">
                <li>Emergency: <code>0.95</code></li>
                <li>Booking: <code>0.80</code></li>
                <li>FAQ: <code>0.70</code></li>
                <li>Small Talk: <code>0.50</code></li>
              </ul>
            </div>
          </div>
          
          <div style="margin-top: 12px;">
            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">Also Applied:</div>
            <ul style="margin: 0; padding-left: 16px; color: #64748b; font-size: 12px;">
              <li>negativeTriggers: Minimum 3 per scenario (auto-generated if missing)</li>
              <li>quickReplies: Min 7, fullReplies: Min 7 (flagged if below)</li>
              <li>silencePolicy.maxConsecutive: 2, finalWarning: set</li>
              <li>handoffPolicy: <code>low_confidence</code> (or <code>always_on_keyword</code> for emergency)</li>
              <li>actionHooks: Standard hooks by scenarioType</li>
            </ul>
          </div>
        </div>
        
        <!-- Preview Area -->
        <div id="autofill-preview" style="display: none;">
          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #374151;"><i class="fas fa-eye"></i> Preview Changes:</h4>
          <div id="autofill-diff" style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; font-size: 12px; max-height: 300px; overflow-y: auto;">
          </div>
        </div>
        
        <!-- Actions -->
        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
          <button onclick="previewGoldenAutofill()" id="btn-preview-autofill"
                  style="padding: 10px 20px; background: #f1f5f9; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
            <i class="fas fa-eye"></i> Preview Changes
          </button>
          <button onclick="applyGoldenAutofillFromModal()" id="btn-apply-autofill"
                  style="padding: 10px 20px; background: #f59e0b; color: #1e293b; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;" disabled>
            <i class="fas fa-magic"></i> Apply Golden Defaults
          </button>
        </div>
        
      </div>
    </div>
  </div>
  
  <script>
    // ============================================================================
    // GOLDEN HVAC AUTOFILL
    // ============================================================================
    let goldenDefaults = {
      // Scenario type detection keywords
      typeKeywords: {
        emergency: ['emergency', 'urgent', 'no heat', 'no ac', 'no cooling', 'leak', 'gas', 'flood', 'fire'],
        booking: ['appointment', 'schedule', 'book', 'service', 'visit', 'tune-up', 'maintenance'],
        faq: ['hours', 'pricing', 'price', 'cost', 'location', 'address', 'warranty', 'payment', 'financing'],
        smallTalk: ['hello', 'hi', 'thanks', 'thank you', 'goodbye', 'bye', 'how are you', 'great', 'good']
      },
      
      // Golden values by scenario type
      byType: {
        emergency: {
          minConfidence: 0.65,
          priority: 95,
          contextWeight: 0.95,
          handoffPolicy: 'always_on_keyword',
          followUpMode: 'ASK_IF_BOOK',
          scenarioType: 'ACTION_FLOW',
          replyStrategy: 'AUTO',
          actionHooks: ['log_emergency_call', 'notify_dispatch']
        },
        booking: {
          minConfidence: 0.50,
          priority: 75,
          contextWeight: 0.80,
          handoffPolicy: 'low_confidence',
          followUpMode: 'ASK_IF_BOOK',
          scenarioType: 'ACTION_FLOW',
          replyStrategy: 'AUTO',
          actionHooks: ['log_booking_intent']
        },
        faq: {
          minConfidence: 0.55,
          priority: 50,
          contextWeight: 0.70,
          handoffPolicy: 'low_confidence',
          followUpMode: 'NONE',
          scenarioType: 'INFO_FAQ',
          replyStrategy: 'AUTO',
          actionHooks: []
        },
        smallTalk: {
          minConfidence: 0.40,
          priority: -5,
          contextWeight: 0.50,
          handoffPolicy: 'never',
          followUpMode: 'NONE',
          scenarioType: 'SMALL_TALK',
          replyStrategy: 'AUTO',
          actionHooks: []
        }
      },
      
      // Default values for all scenarios
      defaults: {
        replySelection: 'bandit',
        silencePolicy: {
          maxConsecutive: 2,
          finalWarning: 'Hello? Are you still there? I want to make sure I can help you today.'
        },
        timedFollowUp: {
          enabled: false,
          delaySeconds: 50,
          extensionSeconds: 30
        }
      }
    };
    
    let autofillPreview = null;
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FULL SCENARIO EXPORT - All 30+ fields per scenario in one JSON
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function exportFullScenarioJSON() {
      console.log('ğŸ“‹ [EXPORT] Starting full scenario export...');
      
      try {
        // First get the company's active template
        const templatesResponse = await fetch(`/api/company/${currentCompanyId}/configuration/templates`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!templatesResponse.ok) throw new Error('Failed to load templates');
        
        const templates = await templatesResponse.json();
        if (!templates || templates.length === 0) {
          showSnapshotToast('âŒ No active template found. Go to Templates tab first.', 'error');
          return;
        }
        
        const templateId = templates[0].templateId || templates[0]._id;
        console.log(`ğŸ“‹ [EXPORT] Fetching full export for template: ${templateId}`);
        
        // Fetch the RAW template with ALL fields
        const exportResponse = await fetch(`/api/admin/global-instant-responses/${templateId}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!exportResponse.ok) throw new Error(`Export failed: HTTP ${exportResponse.status}`);
        
        const templateData = await exportResponse.json();
        
        // Build a comprehensive export with ALL scenario fields
        const fullExport = {
          _exportInfo: {
            exportedAt: new Date().toISOString(),
            companyId: currentCompanyId,
            templateId: templateId,
            templateName: templateData.name || templates[0].name,
            version: templateData.version || 'v1.0.0',
            description: 'Complete scenario export with all 30+ advanced fields per scenario'
          },
          summary: {
            totalCategories: (templateData.categories || []).length,
            totalScenarios: (templateData.categories || []).reduce((sum, c) => sum + (c.scenarios || []).length, 0),
            totalTriggers: (templateData.categories || []).reduce((sum, c) => 
              sum + (c.scenarios || []).reduce((s2, sc) => s2 + (sc.triggers || []).length, 0), 0)
          },
          categories: (templateData.categories || []).map(cat => ({
            // Category metadata
            _categoryId: cat.id || cat._id,
            _categoryName: cat.name,
            _categoryDescription: cat.description || '',
            _scenarioCount: (cat.scenarios || []).length,
            
            // All scenarios with ALL fields
            scenarios: (cat.scenarios || []).map(sc => ({
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // IDENTIFICATION
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              scenarioId: sc.scenarioId || sc._id,
              name: sc.name,
              categoryId: cat.id || cat._id,
              categoryName: cat.name,
              status: sc.status || 'live',
              
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // CLASSIFICATION & PRIORITY
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              scenarioType: sc.scenarioType || 'UNKNOWN',
              priority: sc.priority ?? 5,
              minConfidence: sc.minConfidence ?? 0.5,
              contextWeight: sc.contextWeight ?? 0.7,
              
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // TRIGGERS (Full arrays)
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              triggers: sc.triggers || [],
              negativeTriggers: sc.negativeTriggers || [],
              keywords: sc.keywords || [],
              negativeKeywords: sc.negativeKeywords || [],
              exampleUserPhrases: sc.exampleUserPhrases || [],
              negativeUserPhrases: sc.negativeUserPhrases || [],
              testPhrases: sc.testPhrases || [],
              
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // REPLIES (Full arrays)
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              quickReplies: sc.quickReplies || [],
              fullReplies: sc.fullReplies || [],
              
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // REPLY STRATEGY
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              replySelection: sc.replySelection || 'random',
              replyStrategy: sc.replyStrategy || 'AUTO',
              followUpMode: sc.followUpMode || 'NONE',
              followUpQuestionText: sc.followUpQuestionText || '',
              followUpPrompts: sc.followUpPrompts || [],
              
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // HANDOFF & TRANSFER
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              handoffPolicy: sc.handoffPolicy || 'low_confidence',
              transferTarget: sc.transferTarget || null,
              escalationFlags: sc.escalationFlags || [],
              
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // ACTION HOOKS
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              actionHooks: sc.actionHooks || [],
              preconditions: sc.preconditions || [],
              effects: sc.effects || [],
              
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // SILENCE & FOLLOW-UP
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              silencePolicy: sc.silencePolicy || null,
              timedFollowUp: sc.timedFollowUp || null,
              
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // FLAGS & LOCKS
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              autofillLock: sc.autofillLock || false,
              bookingIntent: sc.bookingIntent || false,
              requiresConsent: sc.requiresConsent || false,
              
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // AUDIT TRAIL
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              lastAutofillAt: sc.lastAutofillAt || null,
              lastAutofillVersion: sc.lastAutofillVersion || null,
              lastManualTuneAt: sc.lastManualTuneAt || null,
              updatedAt: sc.updatedAt || null,
              updatedBy: sc.updatedBy || null,
              
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              // COUNTS (For quick reference)
              // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              _counts: {
                triggers: (sc.triggers || []).length,
                negativeTriggers: (sc.negativeTriggers || []).length,
                quickReplies: (sc.quickReplies || []).length,
                fullReplies: (sc.fullReplies || []).length,
                actionHooks: (sc.actionHooks || []).length
              }
            }))
          }))
        };
        
        // Show in modal with copy options
        showFullExportModal(fullExport);
        
      } catch (error) {
        console.error('[EXPORT] Error:', error);
        showSnapshotToast('âŒ Export failed: ' + error.message, 'error');
      }
    }
    
    function showFullExportModal(exportData) {
      const jsonStr = JSON.stringify(exportData, null, 2);
      const lines = jsonStr.split('\n').length;
      const size = (jsonStr.length / 1024).toFixed(1);
      
      // Create modal
      const modal = document.createElement('div');
      modal.id = 'full-export-modal';
      modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      
      modal.innerHTML = `
        <div style="background: #1e293b; border-radius: 16px; max-width: 95vw; width: 1200px; max-height: 95vh; display: flex; flex-direction: column; overflow: hidden;">
          <!-- Header -->
          <div style="background: linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%); padding: 20px; display: flex; align-items: center; justify-content: space-between;">
            <div>
              <h2 style="margin: 0; color: #0e4156; font-size: 18px; font-weight: 700;">ğŸ“‹ Full Scenario Export</h2>
              <div style="color: #155e75; font-size: 13px; margin-top: 4px;">
                ${exportData.summary.totalCategories} categories Â· ${exportData.summary.totalScenarios} scenarios Â· ${exportData.summary.totalTriggers} triggers
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="copyFullExport()" style="padding: 8px 16px; background: white; color: #0e4156; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                <i class="fas fa-copy"></i> Copy JSON
              </button>
              <button onclick="downloadFullExport()" style="padding: 8px 16px; background: #0e4156; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                <i class="fas fa-download"></i> Download
              </button>
              <button onclick="this.closest('#full-export-modal').remove()" style="padding: 8px 12px; background: rgba(0,0,0,0.2); color: white; border: none; border-radius: 6px; cursor: pointer;">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          
          <!-- Stats Bar -->
          <div style="background: #0f172a; padding: 12px 20px; display: flex; gap: 24px; border-bottom: 1px solid #334155;">
            <div style="color: #94a3b8; font-size: 12px;"><strong style="color: #22d3ee;">Template:</strong> ${exportData._exportInfo.templateName}</div>
            <div style="color: #94a3b8; font-size: 12px;"><strong style="color: #22d3ee;">Size:</strong> ${size} KB</div>
            <div style="color: #94a3b8; font-size: 12px;"><strong style="color: #22d3ee;">Lines:</strong> ${lines.toLocaleString()}</div>
            <div style="color: #94a3b8; font-size: 12px;"><strong style="color: #22d3ee;">Fields per scenario:</strong> ~35</div>
          </div>
          
          <!-- JSON Content -->
          <div style="flex: 1; overflow: auto; padding: 20px;">
            <textarea id="full-export-json" readonly style="width: 100%; height: 100%; min-height: 500px; background: #0f172a; color: #22d3ee; border: 1px solid #334155; border-radius: 8px; padding: 16px; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; resize: none;">${jsonStr}</textarea>
          </div>
          
          <!-- Field Reference -->
          <div style="background: #0f172a; padding: 12px 20px; border-top: 1px solid #334155; font-size: 11px; color: #64748b;">
            <strong style="color: #94a3b8;">Fields included:</strong> 
            scenarioType, priority, minConfidence, contextWeight, triggers[], negativeTriggers[], keywords[], 
            quickReplies[], fullReplies[], replySelection, replyStrategy, followUpMode, handoffPolicy, transferTarget, 
            actionHooks[], preconditions[], effects[], silencePolicy, timedFollowUp, autofillLock, bookingIntent, and more...
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Store for copy/download
      window._fullExportData = exportData;
    }
    
    function copyFullExport() {
      if (!window._fullExportData) return;
      const jsonStr = JSON.stringify(window._fullExportData, null, 2);
      navigator.clipboard.writeText(jsonStr).then(() => {
        showSnapshotToast(`âœ… Copied ${window._fullExportData.summary.totalScenarios} scenarios (${(jsonStr.length/1024).toFixed(1)} KB)`, 'success');
      });
    }
    
    function downloadFullExport() {
      if (!window._fullExportData) return;
      const jsonStr = JSON.stringify(window._fullExportData, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `scenarios-export-${window._fullExportData._exportInfo.templateName.replace(/\s+/g, '-')}-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showSnapshotToast('âœ… Downloaded!', 'success');
    }
    
    function openGoldenAutofillModal() {
      document.getElementById('golden-autofill-modal-overlay').classList.add('active');
      loadTemplatesForAutofill();
    }
    
    function closeGoldenAutofillModal() {
      document.getElementById('golden-autofill-modal-overlay').classList.remove('active');
      autofillPreview = null;
      document.getElementById('autofill-preview').style.display = 'none';
      document.getElementById('btn-apply-autofill').disabled = true;
    }
    
    async function loadTemplatesForAutofill() {
      const select = document.getElementById('autofill-template-select');
      const infoDiv = document.getElementById('autofill-template-info');
      select.innerHTML = '<option value="">Loading...</option>';
      
      try {
        // Use the SAME endpoint as Templates tab - /configuration/templates
        // This ensures consistency with what the Templates UI shows
        const response = await fetch(`/api/company/${currentCompanyId}/configuration/templates`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const templates = await response.json();
        
        if (!templates || templates.length === 0) {
          select.innerHTML = '<option value="">No template selected for this company</option>';
          if (infoDiv) {
            infoDiv.innerHTML = '<span style="color: #fbbf24;">âš ï¸ Go to Templates tab to select a template first</span>';
          }
          return;
        }
        
        // Sort by priority and use first (primary) template
        const sortedTemplates = templates.sort((a, b) => (a.priority || 99) - (b.priority || 99));
        const primaryTemplate = sortedTemplates[0];
        const templateId = primaryTemplate.templateId || primaryTemplate._id;
        const stats = primaryTemplate.stats || {};
        
        select.innerHTML = `<option value="${templateId}" selected>${primaryTemplate.name} (${stats.scenarios || 0} scenarios)</option>`;
        
        // Update info display
        if (infoDiv) {
          infoDiv.innerHTML = `<span style="color: #4ade80;">âœ… Auto-selected: ${primaryTemplate.name}</span>`;
        }
        
        console.log(`[AUTOFILL] Auto-selected primary template: ${primaryTemplate.name} (${templateId})`);
        
      } catch (error) {
        console.error('[AUTOFILL] Failed to load templates:', error);
        select.innerHTML = '<option value="">Error loading templates</option>';
        if (infoDiv) {
          infoDiv.innerHTML = `<span style="color: #f87171;">âŒ ${error.message}</span>`;
        }
      }
    }
    
    function detectScenarioType(scenario) {
      const name = (scenario.name || '').toLowerCase();
      const triggers = (scenario.triggers || []).map(t => t.toLowerCase()).join(' ');
      const combined = name + ' ' + triggers;
      
      for (const [type, keywords] of Object.entries(goldenDefaults.typeKeywords)) {
        for (const kw of keywords) {
          if (combined.includes(kw)) {
            return type;
          }
        }
      }
      
      return 'faq'; // Default to FAQ if unknown
    }
    
    function generateNegativeTriggers(scenario) {
      // Smart generation of negative triggers based on scenario name
      const name = (scenario.name || '').toLowerCase();
      const negatives = [];
      
      // Common negative patterns
      const baseNegatives = ["cancel", "don't need", "not interested", "stop"];
      
      if (name.includes('appointment') || name.includes('book')) {
        negatives.push("cancel appointment", "don't book", "cancel booking");
      }
      if (name.includes('emergency') || name.includes('urgent')) {
        negatives.push("not an emergency", "not urgent", "can wait");
      }
      if (name.includes('heat')) {
        negatives.push("too much heat", "overheating", "turn down heat");
      }
      if (name.includes('cool') || name.includes('ac')) {
        negatives.push("too cold", "turn off ac", "don't need cooling");
      }
      
      // Ensure at least 3
      while (negatives.length < 3) {
        if (negatives.length < baseNegatives.length) {
          negatives.push(baseNegatives[negatives.length]);
        } else {
          break;
        }
      }
      
      return negatives;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GOLDEN AUTOFILL - NOW USES REAL API (Dec 2025 Fix)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function previewGoldenAutofill() {
      const templateId = document.getElementById('autofill-template-select').value;
      
      if (!templateId) {
        showSnapshotToast('âŒ Please select a template', 'error');
        return;
      }
      
      const btn = document.getElementById('btn-preview-autofill');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calling API...';
      btn.disabled = true;
      
      console.log(`ğŸ¯ [GOLDEN AUTOFILL] Calling dry_run API for template: ${templateId}`);
      
      try {
        // Call the REAL backend API - dry_run mode
        const response = await fetch(`/api/trade-knowledge/templates/${templateId}/golden-autofill`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ mode: 'dry_run' })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('[GOLDEN AUTOFILL] API Response:', data);
        
        // Store for apply
        autofillPreview = { templateId, data };
        
        // Show preview with REAL JSON
        document.getElementById('autofill-preview').style.display = 'block';
        
        // Build visual summary
        let diffHtml = `
          <div style="margin-bottom: 16px;">
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 16px;">
              <div style="background: #1e3a5f; padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: #60a5fa;">${data.summary?.totalScenarios || 0}</div>
                <div style="font-size: 11px; color: #93c5fd;">Total</div>
              </div>
              <div style="background: #14532d; padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: #4ade80;">${data.summary?.toUpdate || 0}</div>
                <div style="font-size: 11px; color: #86efac;">Will Update</div>
              </div>
              <div style="background: #1e293b; padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: #94a3b8;">${data.summary?.alreadyCompliant || 0}</div>
                <div style="font-size: 11px; color: #cbd5e1;">OK</div>
              </div>
              <div style="background: #713f12; padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: #fbbf24;">${data.summary?.locked || 0}</div>
                <div style="font-size: 11px; color: #fde68a;">Locked</div>
              </div>
              <div style="background: #7f1d1d; padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: #f87171;">${data.summary?.withQualityIssues || 0}</div>
                <div style="font-size: 11px; color: #fca5a5;">Issues</div>
              </div>
            </div>
          </div>
          
          <div style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <strong style="color: #f1f5f9;">ğŸ“‹ Full API Response (JSON)</strong>
              <button onclick="copyAutofillJson()" style="padding: 4px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                <i class="fas fa-copy"></i> Copy JSON
              </button>
            </div>
            <textarea id="autofill-json-output" readonly style="width: 100%; height: 300px; background: #0f172a; color: #22d3ee; border: 1px solid #334155; border-radius: 8px; padding: 12px; font-family: monospace; font-size: 11px; resize: vertical;">${JSON.stringify(data, null, 2)}</textarea>
          </div>
        `;
        
        // Show sample changes
        if (data.willUpdate && data.willUpdate.length > 0) {
          diffHtml += `<div style="margin-top: 16px;"><strong style="color: #4ade80;">Sample Changes (first 5):</strong></div>`;
          for (const s of data.willUpdate.slice(0, 5)) {
            diffHtml += `<div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
              <div style="font-weight: 600; color: #fbbf24;">${s.scenarioName} <span style="color: #64748b;">(${s.type})</span></div>
              <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">
                ${(s.changes || []).map(c => `${c.field}: ${JSON.stringify(c.before)} â†’ ${JSON.stringify(c.after)}`).join(' | ')}
              </div>
            </div>`;
          }
        }
        
        document.getElementById('autofill-diff').innerHTML = diffHtml;
        document.getElementById('btn-apply-autofill').disabled = (data.summary?.toUpdate || 0) === 0;
        
      } catch (error) {
        console.error('[AUTOFILL] Preview error:', error);
        showSnapshotToast('âŒ API Error: ' + error.message, 'error');
        document.getElementById('autofill-preview').style.display = 'block';
        document.getElementById('autofill-diff').innerHTML = `
          <div style="color: #f87171; padding: 20px; text-align: center;">
            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
            <strong>API Call Failed</strong><br>
            ${error.message}
          </div>
        `;
      }
      
      btn.innerHTML = '<i class="fas fa-eye"></i> Preview Changes';
      btn.disabled = false;
    }
    
    function copyAutofillJson() {
      const textarea = document.getElementById('autofill-json-output');
      if (textarea) {
        navigator.clipboard.writeText(textarea.value).then(() => {
          showSnapshotToast('âœ… JSON copied to clipboard', 'success');
        });
      }
    }
    
    // Apply Golden Autofill using the REAL backend API (Dec 2025 Fix)
    async function applyGoldenAutofillFromModal() {
      if (!autofillPreview || !autofillPreview.templateId) {
        showSnapshotToast('âŒ No preview loaded. Click Preview first.', 'error');
        return;
      }
      
      const toUpdate = autofillPreview.data?.summary?.toUpdate || 0;
      if (toUpdate === 0) {
        showSnapshotToast('âŒ No changes to apply', 'error');
        return;
      }
      
      const btn = document.getElementById('btn-apply-autofill');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Applying via API...';
      btn.disabled = true;
      
      console.log(`ğŸ¯ [GOLDEN AUTOFILL] Calling APPLY API for template: ${autofillPreview.templateId}`);
      
      try {
        // Call the REAL backend API - apply mode
        const response = await fetch(`/api/trade-knowledge/templates/${autofillPreview.templateId}/golden-autofill`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ mode: 'apply' })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('[GOLDEN AUTOFILL] Apply Response:', data);
        
        if (data.success) {
          // Update the JSON textarea with the apply result
          const textarea = document.getElementById('autofill-json-output');
          if (textarea) {
            textarea.value = JSON.stringify(data, null, 2);
          }
          
          showSnapshotToast(`âœ… Applied: ${data.results?.updated || 0} updated, ${data.results?.locked || 0} locked, ${data.results?.failed || 0} failed`, 'success');
          
          // Update the visual summary
          document.getElementById('autofill-diff').innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 48px; margin-bottom: 16px;">âœ…</div>
              <div style="font-size: 18px; font-weight: 600; color: #4ade80; margin-bottom: 8px;">Golden Autofill Applied!</div>
              <div style="color: #94a3b8;">
                ${data.results?.updated || 0} scenarios updated | 
                ${data.results?.locked || 0} locked (skipped) | 
                ${data.results?.failed || 0} failed
              </div>
              <div style="margin-top: 16px;">
                <button onclick="copyAutofillJson()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                  <i class="fas fa-copy"></i> Copy Result JSON
                </button>
              </div>
            </div>
          `;
          
        } else {
          throw new Error(data.error || 'Apply failed');
        }
        
      } catch (error) {
        console.error('[AUTOFILL] Apply error:', error);
        showSnapshotToast('âŒ API Error: ' + error.message, 'error');
      }
      
      btn.innerHTML = '<i class="fas fa-magic"></i> Apply Golden Defaults';
      btn.disabled = false;
    }
  </script>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DEBUG DRAWER - Control Plane Introspection
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="debug-drawer-overlay" class="debug-drawer-overlay" onclick="if(event.target === this) closeDebugDrawer()">
    <div class="debug-drawer">
      <div class="debug-drawer-header">
        <h2>ğŸ”§ Control Plane Debug</h2>
        <button class="debug-drawer-close" onclick="closeDebugDrawer()">&times;</button>
      </div>
      
      <div class="debug-drawer-content">
        <!-- Tabs -->
        <div class="debug-tabs">
          <button class="debug-tab active" onclick="switchDebugTab('overview')">Overview</button>
          <button class="debug-tab" onclick="switchDebugTab('lint')">Lint Results</button>
          <button class="debug-tab" onclick="switchDebugTab('effective')">Effective Config</button>
          <button class="debug-tab" onclick="switchDebugTab('registry')">Registry</button>
        </div>
        
        <!-- OVERVIEW TAB -->
        <div id="debug-tab-overview" class="debug-tab-content active">
          <div class="debug-section">
            <div class="debug-section-title">ğŸ“Š Performance Score</div>
            <div id="debug-score-card" class="debug-score-card">
              <div class="debug-score-circle green">
                <span class="debug-score-value">--</span>
                <span class="debug-score-grade">--</span>
              </div>
              <div class="debug-score-details">
                <h4>Loading...</h4>
                <p>Fetching control plane metrics...</p>
              </div>
            </div>
          </div>
          
          <div class="debug-section">
            <div class="debug-section-title">ğŸ“ˆ Performance Metrics</div>
            <div id="debug-metrics" style="background: #1e293b; border-radius: 8px; padding: 16px;">
              <div class="debug-metric-row">
                <span class="debug-metric-label">Greeting Word Count</span>
                <span id="metric-greeting-words" class="debug-metric-value">--</span>
              </div>
              <div class="debug-metric-row">
                <span class="debug-metric-label">Greeting TTS Estimate</span>
                <span id="metric-greeting-tts" class="debug-metric-value">--</span>
              </div>
              <div class="debug-metric-row">
                <span class="debug-metric-label">Booking Slots</span>
                <span id="metric-booking-slots" class="debug-metric-value">--</span>
              </div>
              <div class="debug-metric-row">
                <span class="debug-metric-label">Forbidden Phrases</span>
                <span id="metric-forbidden" class="debug-metric-value">--</span>
              </div>
              <div class="debug-metric-row">
                <span class="debug-metric-label">Escalation Rules</span>
                <span id="metric-escalation" class="debug-metric-value">--</span>
              </div>
              <div class="debug-metric-row">
                <span class="debug-metric-label">Last Fetch</span>
                <span id="metric-fetch-time" class="debug-metric-value">--</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- LINT TAB -->
        <div id="debug-tab-lint" class="debug-tab-content">
          <div class="debug-section">
            <div class="debug-section-title">ğŸ” Lint Issues</div>
            <ul id="debug-issues-list" class="debug-issues-list">
              <li class="debug-issue">
                <span class="debug-issue-icon info">?</span>
                <div class="debug-issue-content">
                  <div class="debug-issue-message">Loading lint results...</div>
                </div>
              </li>
            </ul>
          </div>
        </div>
        
        <!-- EFFECTIVE CONFIG TAB -->
        <div id="debug-tab-effective" class="debug-tab-content">
          <div class="debug-section">
            <div class="debug-section-title">âš¡ Effective Config (Runtime)</div>
            <div style="margin-bottom: 12px;">
              <button onclick="copyDebugJson('effective')" style="padding: 6px 12px; background: #334155; color: #e2e8f0; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                ğŸ“‹ Copy JSON
              </button>
            </div>
            <pre id="debug-effective-json" class="debug-json-block">Loading...</pre>
          </div>
        </div>
        
        <!-- REGISTRY TAB (Enhanced with Wiring Map) -->
        <div id="debug-tab-registry" class="debug-tab-content">
          <!-- UI WIRING MAP TABLE -->
          <div class="debug-section">
            <div class="debug-section-title">ğŸ”Œ UI Wiring Map</div>
            <p style="color: #9ca3af; font-size: 12px; margin-bottom: 12px;">
              Shows every field, its current value, source, and <strong>write target</strong>. Click field key to copy JSON path.
            </p>
            <div style="overflow-x: auto; margin-bottom: 16px;">
              <table id="wiring-map-table" style="width: 100%; border-collapse: collapse; font-size: 11px;">
                <thead>
                  <tr style="background: #334155; color: #e2e8f0;">
                    <th style="padding: 8px 6px; text-align: left; border: 1px solid #475569;">Panel</th>
                    <th style="padding: 8px 6px; text-align: left; border: 1px solid #475569;">Field Key</th>
                    <th style="padding: 8px 6px; text-align: left; border: 1px solid #475569;">UI Type</th>
                    <th style="padding: 8px 6px; text-align: left; border: 1px solid #475569;">Current Value</th>
                    <th style="padding: 8px 6px; text-align: left; border: 1px solid #475569;">Source</th>
                    <th style="padding: 8px 6px; text-align: left; border: 1px solid #475569;">Write Target</th>
                    <th style="padding: 8px 6px; text-align: center; border: 1px solid #475569;">Status</th>
                  </tr>
                </thead>
                <tbody id="wiring-map-body">
                  <tr><td colspan="7" style="padding: 20px; text-align: center; color: #9ca3af;">Loading wiring map...</td></tr>
                </tbody>
              </table>
            </div>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <span style="font-size: 10px; color: #22c55e;">â— OK</span>
              <span style="font-size: 10px; color: #f59e0b;">â— Default</span>
              <span style="font-size: 10px; color: #ef4444;">â— Missing</span>
              <span style="font-size: 10px; color: #6b7280;">â— Deprecated</span>
              <span style="font-size: 10px; color: #f87171;">âš  Mismatch = read/write paths differ</span>
            </div>
          </div>
          
          <!-- RAW JSON -->
          <div class="debug-section">
            <div class="debug-section-title">ğŸ“‹ Raw Schema Registry (JSON)</div>
            <div style="margin-bottom: 12px;">
              <button onclick="copyDebugJson('registry')" style="padding: 6px 12px; background: #334155; color: #e2e8f0; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                ğŸ“‹ Copy JSON
              </button>
            </div>
            <pre id="debug-registry-json" class="debug-json-block">Loading...</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DEBUG DRAWER LOGIC
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let debugEffectiveConfig = null;
    let debugRegistryData = null;
    
    async function openDebugDrawer() {
      document.getElementById('debug-drawer-overlay').classList.add('open');
      await loadDebugData();
    }
    
    function closeDebugDrawer() {
      document.getElementById('debug-drawer-overlay').classList.remove('open');
    }
    
    function switchDebugTab(tabId) {
      // Update tab buttons
      document.querySelectorAll('.debug-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent.toLowerCase().includes(tabId.split('-')[0]) || 
            (tabId === 'overview' && tab.textContent === 'Overview') ||
            (tabId === 'lint' && tab.textContent === 'Lint Results') ||
            (tabId === 'effective' && tab.textContent === 'Effective Config') ||
            (tabId === 'registry' && tab.textContent === 'Registry')) {
          tab.classList.add('active');
        }
      });
      // Find active tab by onclick
      document.querySelectorAll('.debug-tab').forEach(tab => {
        const onclick = tab.getAttribute('onclick');
        if (onclick && onclick.includes(`'${tabId}'`)) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      // Update tab content
      document.querySelectorAll('.debug-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`debug-tab-${tabId}`).classList.add('active');
    }
    
    async function loadDebugData() {
      try {
        // Load effective config
        const effectiveResponse = await fetch(`/api/company/${currentCompanyId}/control-plane/effective`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!effectiveResponse.ok) {
          throw new Error(`Effective config API returned ${effectiveResponse.status}: ${effectiveResponse.statusText}`);
        }
        
        const effectiveData = await effectiveResponse.json();
        
        if (effectiveData.success && effectiveData.data) {
          debugEffectiveConfig = effectiveData.data;
          renderDebugOverview(effectiveData.data);
          renderDebugLint(effectiveData.data?.lint);
          document.getElementById('debug-effective-json').textContent = 
            JSON.stringify(effectiveData.data?.effectiveConfig || {}, null, 2);
        } else {
          // API returned but with error
          console.warn('[DEBUG DRAWER] Effective config not available:', effectiveData.error);
          renderDebugOverview({}); // Render with empty data
          renderDebugLint(null);
          document.getElementById('debug-effective-json').textContent = 
            JSON.stringify({ error: effectiveData.error || 'No data available' }, null, 2);
        }
        
        // Load registry
        const registryResponse = await fetch('/api/control-plane/registry', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (registryResponse.ok) {
          const registryData = await registryResponse.json();
          if (registryData.success) {
            debugRegistryData = registryData.data;
            document.getElementById('debug-registry-json').textContent = 
              JSON.stringify(registryData.data, null, 2);
            // Render wiring map table
            renderWiringMap(registryData.data, debugEffectiveConfig?.effectiveConfig);
          }
        } else {
          document.getElementById('debug-registry-json').textContent = 
            JSON.stringify({ error: 'Failed to load registry' }, null, 2);
        }
        
      } catch (error) {
        console.error('[DEBUG DRAWER] Load error:', error);
        document.getElementById('debug-score-card').innerHTML = `
          <div style="color: #ef4444; padding: 20px;">
            âŒ Failed to load: ${error.message}<br>
            <small style="color: #9ca3af;">Check console for details. The /control-plane/effective endpoint may not be deployed yet.</small>
          </div>
        `;
        // Still try to show empty state
        renderDebugOverview({});
        renderDebugLint(null);
      }
    }
    
    function renderDebugOverview(data) {
      // Add null checks for all nested properties
      const lint = data?.lint || { score: 0, grade: 'N/A', summary: { errors: 0, warnings: 0, info: 0 }, issues: [] };
      const computed = data?.computed || { performance: {}, completeness: { score: 0 } };
      const generatedInMs = data?.generatedInMs || 0;
      
      // Score card
      const scoreClass = lint.score >= 80 ? 'green' : lint.score >= 60 ? 'yellow' : 'red';
      const summary = lint.summary || { errors: 0, warnings: 0, info: 0 };
      const issuesSummary = `${summary.errors || 0} errors, ${summary.warnings || 0} warnings, ${summary.info || 0} info`;
      
      document.getElementById('debug-score-card').innerHTML = `
        <div class="debug-score-circle ${scoreClass}">
          <span class="debug-score-value">${lint.score || 0}</span>
          <span class="debug-score-grade">${lint.grade || 'N/A'}</span>
        </div>
        <div class="debug-score-details">
          <h4>Copy Performance Score</h4>
          <p>${issuesSummary}</p>
          <p style="margin-top: 8px; color: ${(computed?.completeness?.score || 0) >= 80 ? '#10b981' : '#f59e0b'}">
            Completeness: ${computed?.completeness?.score || 0}%
          </p>
        </div>
      `;
      
      // Metrics - with null checks
      const perf = computed?.performance || {};
      document.getElementById('metric-greeting-words').textContent = 
        (perf.greetingWordCount ?? '--') + ' words';
      document.getElementById('metric-greeting-tts').textContent = 
        (perf.greetingEstimatedSeconds ?? '--') + 's (' + (perf.greetingTTSRating || 'N/A') + ')';
      document.getElementById('metric-booking-slots').textContent = 
        perf.bookingSlotsCount ?? '--';
      document.getElementById('metric-forbidden').textContent = 
        perf.forbiddenPhrasesCount ?? '--';
      document.getElementById('metric-escalation').textContent = 
        perf.escalationRulesCount ?? '--';
      document.getElementById('metric-fetch-time').textContent = 
        (generatedInMs || '--') + 'ms';
    }
    
    function renderDebugLint(lint) {
      const listEl = document.getElementById('debug-issues-list');
      
      // Handle null/undefined lint
      if (!lint || !lint.issues) {
        listEl.innerHTML = `
          <li class="debug-issue" style="background: #1e293b;">
            <span class="debug-issue-icon" style="background: #64748b;">?</span>
            <div class="debug-issue-content">
              <div class="debug-issue-message">Lint data not available. The effective config endpoint may not be deployed yet.</div>
            </div>
          </li>
        `;
        return;
      }
      
      if (lint.issues.length === 0) {
        listEl.innerHTML = `
          <li class="debug-issue" style="background: #064e3b;">
            <span class="debug-issue-icon" style="background: #10b981;">âœ“</span>
            <div class="debug-issue-content">
              <div class="debug-issue-message">No issues found! Copy quality is excellent.</div>
            </div>
          </li>
        `;
        return;
      }
      
      listEl.innerHTML = lint.issues.map(issue => `
        <li class="debug-issue">
          <span class="debug-issue-icon ${issue.severity || 'info'}">
            ${issue.severity === 'error' ? 'âœ•' : issue.severity === 'warning' ? '!' : 'i'}
          </span>
          <div class="debug-issue-content">
            <div class="debug-issue-field">${issue.field || 'unknown'} â€¢ ${issue.rule || 'unknown'}</div>
            <div class="debug-issue-message">${issue.message || 'No message'}</div>
          </div>
        </li>
      `).join('');
    }
    
    /**
     * Render the UI Wiring Map table
     * Shows every field, current value, and source
     */
    /**
     * Render the UI Wiring Map table
     * Shows every field, current value, source, AND write target
     */
    function renderWiringMap(registry, effectiveConfig) {
      const tbody = document.getElementById('wiring-map-body');
      
      if (!registry || !registry.panels) {
        tbody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #9ca3af;">No registry data available</td></tr>';
        return;
      }
      
      // CANONICAL WRITE TARGETS - This is where UI saves should go
      const CANONICAL_WRITE_TARGETS = {
        'greeting': 'connectionMessages.voice.text',
        'connectionMessages.voice.text': 'connectionMessages.voice.text',
        'connectionMessages.voice.realtime.text': 'connectionMessages.voice.text',
        'frontDeskBehavior.greeting': 'connectionMessages.voice.text',
        'frontDeskBehavior.bookingSlots': 'frontDeskBehavior.bookingSlots',
        'frontDeskBehavior.bookingEnabled': 'frontDeskBehavior.bookingEnabled',
        'frontDeskBehavior.conversationStyle': 'frontDeskBehavior.personality.conversationStyle',
        'frontDeskBehavior.personality.conversationStyle': 'frontDeskBehavior.personality.conversationStyle',
        'companyResponseDefaults.notOfferedReply.fullReply': 'companyResponseDefaults.notOfferedReply.fullReply',
        'companyResponseDefaults.unknownIntentReply.fullReply': 'companyResponseDefaults.unknownIntentReply.fullReply',
        'companyResponseDefaults.afterHoursReply.fullReply': 'companyResponseDefaults.afterHoursReply.fullReply'
      };
      
      const rows = [];
      
      // Iterate through all panels
      registry.panels.forEach(panel => {
        const panelId = panel.id;
        const panelLabel = panel.label || panelId;
        
        // Get the effective config section for this panel
        const configSection = effectiveConfig?.[panelId] || {};
        
        // Iterate through all fields in the panel
        (panel.fields || []).forEach(field => {
          const fieldKey = field.key;
          const fullPath = field.key; // Registry field.key is already the full path
          
          // Get current value from effective config (using panel section)
          const shortKey = fieldKey.split('.').pop(); // Get last part of key
          let currentValue = configSection[shortKey];
          let source = 'default';
          let status = 'default';
          
          // Check if value exists and determine source
          if (currentValue !== undefined && currentValue !== null) {
            if (Array.isArray(currentValue)) {
              currentValue = `Array(${currentValue.length})`;
            } else if (typeof currentValue === 'object') {
              currentValue = JSON.stringify(currentValue).substring(0, 40) + '...';
            } else if (typeof currentValue === 'string' && currentValue.length > 40) {
              currentValue = currentValue.substring(0, 40) + '...';
            }
            source = 'company';
            status = 'ok';
          } else if (field.defaultValue !== undefined) {
            currentValue = String(field.defaultValue);
            source = 'default';
            status = 'default';
          } else {
            currentValue = 'â€”';
            source = 'missing';
            status = 'missing';
          }
          
          // Check for deprecation
          if (field.deprecated) {
            status = 'deprecated';
          }
          
          // Determine write target (canonical path for saves)
          const writeTarget = CANONICAL_WRITE_TARGETS[fieldKey] || fieldKey;
          const hasMismatch = writeTarget !== fieldKey && !field.deprecated;
          
          // Status colors
          const statusColors = {
            'ok': '#22c55e',
            'default': '#f59e0b',
            'missing': '#ef4444',
            'deprecated': '#6b7280'
          };
          
          const statusIcons = {
            'ok': 'â—',
            'default': 'â—',
            'missing': 'â—‹',
            'deprecated': 'âœ—'
          };
          
          // Write target styling
          const writeTargetColor = hasMismatch ? '#f87171' : '#94a3b8';
          const writeTargetIcon = hasMismatch ? 'âš ï¸ ' : '';
          
          rows.push(`
            <tr style="border-bottom: 1px solid #334155;">
              <td style="padding: 6px; border: 1px solid #334155; color: #94a3b8;">${panelLabel}</td>
              <td style="padding: 6px; border: 1px solid #334155;">
                <code style="cursor: pointer; color: #38bdf8; font-size: 10px;" onclick="navigator.clipboard.writeText('${fullPath}'); showSnapshotToast('Copied!', '${fullPath}', 'success');">
                  ${fieldKey.split('.').pop()}
                </code>
              </td>
              <td style="padding: 6px; border: 1px solid #334155; color: #9ca3af; font-size: 10px;">${field.uiType || 'text'}</td>
              <td style="padding: 6px; border: 1px solid #334155; color: #e2e8f0; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 10px;" title="${String(currentValue).replace(/"/g, '&quot;')}">${currentValue}</td>
              <td style="padding: 6px; border: 1px solid #334155; color: #9ca3af; font-size: 10px;">${source}</td>
              <td style="padding: 6px; border: 1px solid #334155; color: ${writeTargetColor}; font-size: 9px;" title="UI saves should write to this path">${writeTargetIcon}${writeTarget.split('.').slice(-2).join('.')}</td>
              <td style="padding: 6px; border: 1px solid #334155; text-align: center; color: ${statusColors[status]}; font-size: 14px;" title="${status.toUpperCase()}">${statusIcons[status]}</td>
            </tr>
          `);
        });
      });
      
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #9ca3af;">No fields found in registry</td></tr>';
      } else {
        tbody.innerHTML = rows.join('');
      }
    }
    
    function copyDebugJson(type) {
      let data;
      if (type === 'effective') {
        data = debugEffectiveConfig?.effectiveConfig;
      } else if (type === 'registry') {
        data = debugRegistryData;
      }
      
      if (data) {
        navigator.clipboard.writeText(JSON.stringify(data, null, 2));
        showSnapshotToast('ğŸ“‹ JSON Copied!', `${type} config copied to clipboard`, 'success');
      } else {
        showSnapshotToast('âŒ No Data', 'No data available to copy', 'error');
      }
    }
  </script>
  
</body>
</html>

