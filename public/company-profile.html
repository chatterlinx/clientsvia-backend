<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Company Profile</title>
    <link rel="icon" href="/favicon.ico">
    
    <!-- Tailwind CSS (Production Build) -->
    <link rel="stylesheet" href="/css/output.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        
        /* Global Navigation Styling */
        .nav-link-global { 
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #6B7280;
            text-decoration: none;
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
        }
        .nav-link-global:hover {
            color: #4F46E5;
            background-color: #EEF2FF;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .nav-link-global.active { 
            background-color: #4F46E5;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }
        
        /* Tab Navigation Styling */
        .nav-link.active-tab { border-bottom-width: 2px; border-color: #4F46E5; color: #4F46E5; font-weight: 600; background-color: #EEF2FF; }
        .nav-link { @apply px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100 hover:text-gray-900; }
        
        .profile-section-title { @apply text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200; }
        .detail-item { @apply flex flex-col sm:flex-row py-2; }
        .detail-label { @apply sm:w-1/3 font-medium text-gray-600 mb-1 sm:mb-0; }
        .detail-value { @apply sm:w-2/3 text-gray-800; }
        .config-block { @apply mt-3 p-4 border border-gray-200 rounded-md bg-gray-50; }
        .form-input, .form-select, .form-textarea, .form-checkbox { @apply mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-150 ease-in-out; }
        .form-checkbox { @apply w-auto h-4 text-indigo-600; } 
        .form-label { @apply block text-sm font-medium text-gray-700; }
        .form-check-label { @apply ml-2 text-sm text-gray-700; }
        .tab-button { padding: 0.5rem 1rem; font-weight: 500; font-size: 0.875rem; line-height: 1.25rem; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; cursor: pointer; }
        .tab-button:focus { outline: 2px solid transparent; outline-offset: 2px; }
        .tab-button-active { background-color: #4F46E5; color: white; }
        .tab-button-inactive { background-color: #E5E7EB; color: #374151; }
        .tab-button-inactive:hover { background-color: #D1D5DB; }
        .tab-content-item { @apply p-0 pt-6; } 
        .tab-content-item.hidden { display: none; }
        .notes-textarea { @apply w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out; min-height: 150px; }
        .wider-textbox { max-width: 800px; width: 100%; }
        .note-card { @apply bg-white p-4 rounded-lg shadow border border-gray-200 mb-4; }
        .note-card.pinned { @apply bg-yellow-50 border-yellow-300; }
        .note-content { @apply text-gray-800 whitespace-pre-wrap; }
        .note-timestamps { @apply text-xs text-gray-500 mt-2; }
        .note-actions { @apply mt-3 flex items-center space-x-3; }
        .note-action-button { @apply text-xs text-indigo-600 hover:text-indigo-800 font-medium; }
        .note-action-button .fa-thumbtack.pinned-icon { color: #F59E0B; }
        .status-badge { @apply px-2.5 py-0.5 rounded-full text-xs font-medium; }
        .status-active { @apply bg-green-100 text-green-800; }
        .status-inactive { @apply bg-red-100 text-red-800; }

        


        
        .contact-block-view { @apply mt-3 pt-3 border-t border-gray-200; }
        .contact-block-view .detail-item:last-child { padding-bottom: 0; }
        .scheduling-rule-daily-hours-header { @apply grid grid-cols-4 gap-x-3 mb-1 px-2 text-xs font-medium text-gray-500; }
        .scheduling-rule-daily-hours-row { @apply grid grid-cols-4 gap-x-3 items-center p-2 hover:bg-gray-100 rounded-md; }
        #toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out; }
        #toast-notification.show { opacity: 1; }
        #toast-notification.success { background-color: #4CAF50; }
        #toast-notification.error { background-color: #f44336; }
        @media (min-width: 768px) { .wider-textbox { max-width: 800px; } }
        @media (max-width: 767px) { .wider-textbox { max-width: 100%; } }
        
        /* ðŸ§  Agent ClientsVia Intelligence Styles */
        .clientsvia-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .clientsvia-tab-btn.active {
            border-color: #6366f1 !important;
            color: #6366f1 !important;
            background-color: #eef2ff;
        }
        .clientsvia-tab-content {
            display: none;
        }
        .clientsvia-tab-content.active {
            display: block;
        }
        .clientsvia-priority-item {
            transition: all 0.3s ease;
        }
        .clientsvia-priority-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .clientsvia-source-item {
            transition: all 0.3s ease;
        }
        .clientsvia-source-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" class="flex flex-col min-h-screen">
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex-shrink-0">
                        <a href="/index.html" class="text-2xl font-bold text-indigo-600">
                            <i class="fas fa-tachometer-alt mr-2"></i>Admin Dashboard
                        </a>
                    </div>
                    <nav class="hidden md:flex items-center" style="gap: 20px;">
                        <a href="/index.html" class="nav-link-global" id="nav-home">Home</a>
                        <a href="/directory.html" class="nav-link-global" id="nav-directory">Directory</a>
                        <a href="/add-company.html" class="nav-link-global" id="nav-add-company">Add Company</a>
                        <a href="/trade-category-management.html" class="nav-link-global" id="nav-trade-categories">Trade Categories</a>
                        <a href="/company-profile.html" class="nav-link-global active" id="nav-company-profile">Company Profile</a>
                    </nav>
                    <div class="md:hidden flex items-center">
                        <button id="mobile-menu-button" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
                            <span class="sr-only">Open main menu</span>
                            <i class="fas fa-bars text-2xl"></i>
                        </button>
                    </div>
                </div>

            <!-- ...existing code... -->
            <div id="mobile-menu" class="md:hidden hidden">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="/index.html" class="block nav-link text-base">Home</a>
                    <a href="/directory.html" class="block nav-link text-base">Directory</a>
                    <a href="/add-company.html" class="block nav-link text-base">Add Company</a>
                    <a href="/trade-category-management.html" class="block nav-link text-base">Trade Categories</a>
                    <a href="/company-profile.html" class="block nav-link text-base">Company Profile</a>
                </div>
            </div>
        </header>

        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-1">
                    <div> 
                        <h1 class="text-3xl font-semibold text-gray-800" id="company-name-header">Loading...</h1>
                        <p id="company-id-subheader" class="text-xs text-gray-500 mt-1">ID: Loading...</p> 
                    </div>
                    <div class="flex items-center gap-x-3 mt-3 md:mt-0">
                         <span id="company-status-badge" class="status-badge mr-3">Status</span> 
                    </div>
                </div>
                <hr class="mb-6 mt-3">

                <div class="mb-6">
                    <div class="border-b border-gray-300">
                        <nav class="-mb-px flex flex-wrap space-x-1" aria-label="Tabs">
                            <button class="tab-button tab-button-active" id="tab-overview" data-tab="overview">
                                <i class="fas fa-info-circle mr-1"></i>Overview
                            </button>
                            <button class="tab-button tab-button-inactive" id="tab-config" data-tab="config">
                                <i class="fas fa-cogs mr-1"></i>Configuration
                            </button>
                            <button class="tab-button tab-button-inactive" id="tab-notes" data-tab="notes">
                                <i class="fas fa-sticky-note mr-1"></i>Notes
                            </button>
                             <button class="tab-button tab-button-inactive" id="tab-calendar-settings" data-tab="calendar-settings">
                                <i class="fas fa-calendar-alt mr-1"></i>Calendar Settings
                            </button>
                            <button class="tab-button tab-button-inactive" id="tab-ai-settings" data-tab="ai-settings">
                                <i class="fas fa-robot mr-1"></i>AI Settings
                            </button>
                            <button class="tab-button tab-button-inactive" id="tab-ai-voice" data-tab="ai-voice">
                                <i class="fas fa-microphone-alt mr-1"></i>AI Voice Settings
                            </button>
                            <button class="tab-button tab-button-inactive" id="tab-personality-responses" data-tab="personality-responses">
                                <i class="fas fa-comment-dots mr-1"></i>Agent Personality Responses
                            </button>
                            <button class="tab-button tab-button-inactive" id="tab-ai-agent-logic" data-tab="ai-agent-logic">
                                <i class="fas fa-brain mr-1"></i>AI Agent Logic
                            </button>

                        </nav>
                    </div>
                </div>

                <div id="tab-content-area">
                    <div id="overview-content" class="tab-content-item">
                        <section class="profile-section bg-transparent shadow-none p-0">
                            <div id="company-details-edit-form">
                                <!-- Modern form will be inserted here by JavaScript -->
                                <p class="text-gray-500 text-center py-8">Loading company information...</p>
                            </div>
                            <!-- Company Contacts Section -->
                            <div id="company-contacts-section" class="mt-8">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-address-book mr-2 text-indigo-600"></i>Company Contacts
                                </h2>
                                <div id="contacts-list" class="space-y-6"></div>
                                <button type="button" id="add-contact-btn" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-150">
                                    <i class="fas fa-plus mr-1"></i>Add Contact
                                </button>
                            </div>
                        </section>
                    </div>

                    <div id="config-content" class="tab-content-item hidden">
                        <section class="profile-section bg-transparent shadow-none p-0">
                            <h2 class="profile-section-title"><i class="fas fa-cogs mr-2 text-indigo-600"></i>Service Configuration</h2>
                            <form id="config-settings-form">
                                <div class="config-block">
                                    <h3 class="font-semibold text-gray-700 mb-2">Twilio Integration Credentials</h3>
                                    <p class="text-sm text-gray-500 mb-3">Enter the Twilio credentials that this company's AI agent will use.</p>
                                    <div class="space-y-3">
                                        <div>
                                            <label for="twilioAccountSid" class="form-label">Account SID</label>
                                            <input type="text" id="twilioAccountSid" name="twilioAccountSid" class="form-input wider-textbox" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                                        </div>
                                        <div>
                                            <label for="twilioAuthToken" class="form-label">Auth Token</label>
                                            <input type="text" id="twilioAuthToken" name="twilioAuthToken" class="form-input wider-textbox" placeholder="Enter Auth Token" style="font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Phone Numbers Management -->
                                <div class="config-block mt-6">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="font-semibold text-gray-700">Twilio Phone Numbers</h3>
                                        <button type="button" id="addPhoneNumberBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-3 py-1 rounded-md flex items-center">
                                            <i class="fas fa-plus mr-1"></i>Add Number
                                        </button>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-3">Manage all Twilio phone numbers available for this company's AI agents.</p>
                                    
                                    <!-- Phone Numbers List -->
                                    <div id="phoneNumbersList" class="space-y-3">
                                        <!-- Primary Phone Number (Default) -->
                                        <div class="phone-number-item border border-gray-200 rounded-lg p-4 bg-gray-50">
                                            <div class="flex items-center justify-between">
                                                <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <div>
                                                        <label class="form-label text-sm">Phone Number (E.164 format)</label>
                                                        <input type="tel" name="phoneNumber" class="form-input" placeholder="+12395551212" value="">
                                                    </div>
                                                    <div>
                                                        <label class="form-label text-sm">Friendly Name</label>
                                                        <input type="text" name="friendlyName" class="form-input" placeholder="Main Business Line" value="Primary Number">
                                                    </div>
                                                    <div>
                                                        <label class="form-label text-sm">Status</label>
                                                        <select name="status" class="form-select">
                                                            <option value="active" selected>Active</option>
                                                            <option value="inactive">Inactive</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="ml-4 flex items-center space-x-2">
                                                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Primary</span>
                                                    <button type="button" class="text-red-600 hover:text-red-800" title="Remove">
                                                        <i class="fas fa-trash text-sm"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Add Phone Number Template (Hidden) -->
                                    <template id="phoneNumberTemplate">
                                        <div class="phone-number-item border border-gray-200 rounded-lg p-4">
                                            <div class="flex items-center justify-between">
                                                <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <div>
                                                        <label class="form-label text-sm">Phone Number (E.164 format)</label>
                                                        <input type="tel" name="phoneNumber" class="form-input" placeholder="+12395551212">
                                                    </div>
                                                    <div>
                                                        <label class="form-label text-sm">Friendly Name</label>
                                                        <input type="text" name="friendlyName" class="form-input" placeholder="e.g., Emergency Line, Sales Line">
                                                    </div>
                                                    <div>
                                                        <label class="form-label text-sm">Status</label>
                                                        <select name="status" class="form-select">
                                                            <option value="active" selected>Active</option>
                                                            <option value="inactive">Inactive</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="ml-4 flex items-center space-x-2">
                                                    <button type="button" class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full hover:bg-blue-200" title="Set as Primary">
                                                        Set Primary
                                                    </button>
                                                    <button type="button" class="text-red-600 hover:text-red-800" title="Remove">
                                                        <i class="fas fa-trash text-sm"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Webhook Configuration Reference -->
                                <div class="config-block mt-6">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="font-semibold text-gray-700">Twilio Webhook Configuration</h3>
                                        <button type="button" id="toggleWebhookInfo" class="text-indigo-600 hover:text-indigo-800 text-sm flex items-center">
                                            <i class="fas fa-info-circle mr-1"></i>Show Webhook URLs
                                        </button>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-3">Use these webhook URLs in your Twilio Console for phone number configuration.</p>
                                    
                                    <div id="webhookInfoPanel" class="hidden">
                                        <!-- Dynamic webhook content will be generated by JavaScript -->
                                    </div>
                                </div>
                                
                                <!-- Additional API Configuration -->
                                <div class="config-block mt-6">
                                    <h3 class="font-semibold text-gray-700 mb-2">Additional API Keys</h3>
                                    <p class="text-sm text-gray-500 mb-3">Configure additional integrations and services.</p>
                                    <div class="space-y-3">
                                        <div>
                                            <label for="twilioApiKey" class="form-label">Twilio API Key (Optional)</label>
                                            <input type="text" id="twilioApiKey" name="twilioApiKey" class="form-input wider-textbox" placeholder="SKxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" style="font-family: monospace;">
                                        </div>
                                        <div>
                                            <label for="twilioApiSecret" class="form-label">Twilio API Secret (Optional)</label>
                                            <input type="text" id="twilioApiSecret" name="twilioApiSecret" class="form-input wider-textbox" placeholder="Enter API Secret" style="font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-8 pt-5 border-t border-gray-200">
                                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                                        <i class="fas fa-save mr-2"></i>Save Configuration
                                    </button>
                                </div>
                            </form>
                        </section>
                    </div>

                    <div id="notes-content" class="tab-content-item hidden">
                        <section class="profile-section bg-transparent shadow-none p-0"> 
                            <h2 class="profile-section-title"><i class="fas fa-sticky-note mr-2 text-indigo-600"></i>Company Notes</h2>
                            <div id="add-note-area" class="mb-6">
                                <textarea id="new-note-textarea" class="notes-textarea wider-textbox" placeholder="Type your new note here..."></textarea>
                                <button id="add-new-note-button" class="mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                                    <i class="fas fa-plus-circle mr-2"></i>Add Note
                                </button>
                            </div>
                            <div id="notes-display-area">
                                <p class="text-gray-500 italic text-center py-4">Notes will appear here.</p>
                            </div>
                        </section>
                    </div>
                    
                    <div id="calendar-settings-content" class="tab-content-item hidden">
                         <section class="profile-section bg-transparent shadow-none p-0">
                            <h2 class="profile-section-title"><i class="fas fa-calendar-alt mr-2 text-indigo-600"></i>Google Calendar Integration</h2>
                            <div id="gcal-status-container" class="p-4 rounded-lg border bg-gray-50 mb-6">
                                 <!-- Status content will be dynamically inserted here -->
                                 <p class="text-gray-500">Checking connection status...</p>
                            </div>

                            <div id="gcal-calendars-list-container" class="hidden">
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">Available Calendars</h3>
                                <p class="text-sm text-gray-500 mb-4">These calendars can be selected within the 'Service Scheduling Rules'. Only calendars you have 'write' access to are shown.</p>
                                <div id="gcal-calendars-list" class="space-y-3 border rounded-lg p-4 bg-white max-h-96 overflow-y-auto">
                                    <!-- Calendar list will be dynamically inserted here -->
                                    <p class="text-gray-500">Loading calendars...</p>
                                </div>
                            </div>
                         </section>
                    </div>

                    <div id="ai-settings-content" class="tab-content-item hidden">
                        <section class="profile-section bg-transparent shadow-none p-0">
                            <h2 class="profile-section-title"><i class="fas fa-robot mr-2 text-indigo-600"></i>AI Core Parameters</h2>
                            <p class="text-sm text-gray-500 mb-4">High-level AI settings for core functionality.</p>
                            <form id="ai-settings-form">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                    <div>
                                        <label for="aiModel" class="form-label">AI Model Engine</label>
                                        <select id="aiModel" name="aiModel" class="form-select">
                                            <option value="gemini-2.5-flash">Gemini 2.5 Flash (High Speed)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="aiCorePersonality" class="form-label">AI Base Personality</label>
                                        <select id="aiCorePersonality" name="aiCorePersonality" class="form-select">
                                            <option value="friendly">Friendly & Empathetic</option>
                                            <option value="formal">Formal & Professional</option>
                                            <option value="efficient">Quick & Efficient</option>
                                            <option value="witty">Witty & Engaging</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label for="knowledgeBaseSource" class="form-label">External Knowledge Base URL/ID (Optional)</label>
                                    <input type="text" id="knowledgeBaseSource" name="knowledgeBaseSource" class="form-input wider-textbox" placeholder="e.g., FAQ page URL, Document ID">
                                </div>
                                <div class="mt-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="llmFallbackEnabled" name="llmFallbackEnabled" class="form-checkbox">
                                        <span class="form-check-label">Enable Cloud LLM Chain (Primary â†’ Backup)</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">Cloud AI with intelligent fallback for maximum reliability</p>
                                </div>
                                
                                <div class="mt-4" id="escalationMessageContainer">
                                    <label for="customEscalationMessage" class="form-label">Custom Escalation Message</label>
                                    <textarea id="customEscalationMessage" name="customEscalationMessage" class="form-textarea wider-textbox" rows="3" placeholder="Iâ€™m unable to answer that, let me connect you to a team member who can help."></textarea>
                                </div>
                                <div class="mt-6 border-t border-gray-200 pt-6">
                                    <h3 class="text-md font-medium text-gray-700 mb-3">Conversation Flow Settings</h3>
                                    <div class="space-y-3">
                                        <label class="flex items-start">
                                            <input type="checkbox" id="bargeIn" name="bargeIn" class="form-checkbox mt-1">
                                            <div class="ml-2">
                                                <span class="form-check-label font-medium">Allow Caller Interruption (Barge-In)</span>
                                                <p class="text-xs text-gray-500 mt-1">
                                                    <strong>ON:</strong> Callers can interrupt the agent while speaking (may cause choppy conversations)<br>
                                                    <strong>OFF:</strong> Agent finishes speaking before listening (natural conversation flow)
                                                </p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="mt-6 border-t border-gray-200 pt-6">
                                    <h3 class="text-md font-medium text-gray-700 mb-3">Advanced Options</h3>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="sentimentAnalysis" name="sentimentAnalysis" class="form-checkbox">
                                            <span class="form-check-label">Enable Sentiment Analysis</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="dataLogging" name="dataLogging" class="form-checkbox" checked>
                                            <span class="form-check-label">Enable Interaction Logging (for improvements)</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="mt-8 pt-5 border-t border-gray-200">
                                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                                        <i class="fas fa-save mr-2"></i>Save AI Core Settings
                                    </button>
                                </div>
                            </form>
                        </section>
                    </div>

                    <div id="ai-voice-content" class="tab-content-item hidden">
                        <section class="profile-section bg-transparent shadow-none p-0">
                            <h2 class="profile-section-title">
                                <i class="fas fa-microphone-alt mr-2 text-indigo-600"></i>AI Voice Settings
                                <span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Latest ElevenLabs API</span>
                            </h2>

                            <!-- API Configuration Section -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gray-50 px-6 py-4 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-key mr-2 text-blue-600"></i>API Configuration
                                        <button type="button" id="test-api-connection" class="ml-auto text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded transition duration-150">
                                            <i class="fas fa-plug mr-1"></i>Test Connection
                                        </button>
                                    </h3>
                                </div>
                                
                                <form id="elevenlabs-api-form" class="p-6">
                                    <!-- API Key Source Toggle -->
                                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h4 class="text-sm font-semibold text-gray-800 mb-1">
                                                    <i class="fas fa-toggle-on mr-2 text-blue-600"></i>ElevenLabs API Source
                                                </h4>
                                                <p class="text-xs text-gray-600" id="api-source-description">
                                                    Using ClientsVia global API (default for all companies)
                                                </p>
                                            </div>
                                            <div class="flex items-center">
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" id="useOwnApiKey" class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                                    <span class="ml-3 text-sm font-medium text-gray-700" id="toggle-label">Use Own API</span>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- Global API Info -->
                                        <div id="global-api-info" class="mt-3 p-3 bg-white rounded border border-blue-100">
                                            <div class="flex items-center text-sm text-green-700">
                                                <i class="fas fa-check-circle mr-2"></i>
                                                <span>Using ClientsVia shared ElevenLabs account - no setup required!</span>
                                            </div>
                                            <p class="text-xs text-gray-600 mt-1">
                                                Voice synthesis costs are covered by ClientsVia. Perfect for most businesses.
                                            </p>
                                        </div>
                                        
                                        <!-- Own API Info (hidden by default) -->
                                        <div id="own-api-info" class="mt-3 p-3 bg-orange-50 rounded border border-orange-200 hidden">
                                            <div class="flex items-center text-sm text-orange-700">
                                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                                <span>Using your own ElevenLabs API account</span>
                                            </div>
                                            <p class="text-xs text-gray-600 mt-1">
                                                You'll be billed directly by ElevenLabs. Recommended for high-volume usage or special requirements.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div>
                                            <label for="elevenlabsApiKey" class="form-label">
                                                <span id="api-key-label">Your ElevenLabs API Key</span>
                                                <span class="text-xs text-orange-600 ml-1" id="api-key-required">(Required when using own API)</span>
                                            </label>
                                            <input type="password" id="elevenlabsApiKey" name="elevenlabsApiKey" 
                                                   class="form-input" placeholder="sk-..." autocomplete="new-password" disabled>
                                            <p class="text-xs text-gray-500 mt-1" id="api-key-help">
                                                Get your API key from <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank" class="text-blue-600 hover:underline">ElevenLabs Dashboard</a>
                                            </p>
                                        </div>
                                        
                                        <div id="subscription-info" class="hidden">
                                            <label class="form-label">Subscription Status</label>
                                            <div id="subscription-details" class="text-sm bg-gray-50 p-3 rounded border">
                                                <!-- Subscription info will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!-- Voice Selection & Preview -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gray-50 px-6 py-4 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-user-friends mr-2 text-purple-600"></i>Voice Selection & Preview
                                        <button type="button" id="refresh-voices" class="ml-auto text-sm bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded transition duration-150">
                                            <i class="fas fa-sync mr-1"></i>Refresh Voices
                                        </button>
                                    </h3>
                                </div>
                                
                                <div class="p-6">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Voice Selection -->
                                        <div>
                                            <label for="voice-selector" class="form-label">Select Voice</label>
                                            <select id="voice-selector" name="voiceId" class="form-select mb-3">
                                                <option value="">Choose a voice...</option>
                                            </select>
                                            
                                            <!-- Voice Filters -->
                                            <div class="flex space-x-2 mb-4">
                                                <select id="voice-gender-filter" class="text-xs border border-gray-300 rounded px-2 py-1">
                                                    <option value="">All Genders</option>
                                                    <option value="male">Male</option>
                                                    <option value="female">Female</option>
                                                </select>
                                                <select id="voice-category-filter" class="text-xs border border-gray-300 rounded px-2 py-1">
                                                    <option value="">All Categories</option>
                                                    <option value="conversational">Conversational</option>
                                                    <option value="professional">Professional</option>
                                                    <option value="narration">Narration</option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Voice Preview & Info -->
                                        <div id="voice-preview-section" class="hidden">
                                            <label class="form-label">Voice Preview</label>
                                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                                <div id="voice-info" class="mb-3">
                                                    <!-- Voice details will be populated here -->
                                                </div>
                                                
                                                <div class="flex items-center space-x-2">
                                                    <button type="button" id="play-voice-sample" class="text-sm bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded transition duration-150">
                                                        <i class="fas fa-play mr-1"></i>Play Sample
                                                    </button>
                                                    <audio id="voice-preview-audio" controls class="hidden"></audio>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced Voice Settings -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gray-50 px-6 py-4 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-sliders-h mr-2 text-orange-600"></i>Advanced Voice Settings
                                        <button type="button" id="reset-voice-settings" class="ml-auto text-sm bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded transition duration-150">
                                            <i class="fas fa-undo mr-1"></i>Reset to Optimal
                                        </button>
                                    </h3>
                                </div>
                                
                                <div class="p-6">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Left Column: Voice Quality -->
                                        <div class="space-y-4">
                                            <h4 class="text-md font-semibold text-gray-700 border-b pb-2">Voice Quality</h4>
                                            
                                            <!-- Stability -->
                                            <div>
                                                <label for="voice-stability" class="form-label flex items-center justify-between">
                                                    Stability
                                                    <span id="stability-value" class="text-sm text-gray-500">0.5</span>
                                                </label>
                                                <input type="range" id="voice-stability" name="stability" 
                                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                       value="0.5" min="0.0" max="1.0" step="0.1" oninput="updateSliderValue('stability', this.value)">
                                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span>Variable (0.0)</span>
                                                    <span>Stable (1.0)</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Higher = more consistent, Lower = more expressive</p>
                                            </div>

                                            <!-- Similarity Boost -->
                                            <div>
                                                <label for="voice-similarity" class="form-label flex items-center justify-between">
                                                    Similarity Boost
                                                    <span id="similarity-value" class="text-sm text-gray-500">0.7</span>
                                                </label>
                                                <input type="range" id="voice-similarity" name="similarity_boost" 
                                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                       value="0.7" min="0.0" max="1.0" step="0.1" oninput="updateSliderValue('similarity', this.value)">
                                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span>Creative (0.0)</span>
                                                    <span>Accurate (1.0)</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Higher = more similar to original voice</p>
                                            </div>

                                            <!-- Style -->
                                            <div>
                                                <label for="voice-style" class="form-label flex items-center justify-between">
                                                    Style Exaggeration
                                                    <span id="style-value" class="text-sm text-gray-500">0.0</span>
                                                </label>
                                                <input type="range" id="voice-style" name="style" 
                                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                       value="0.0" min="0.0" max="1.0" step="0.1" oninput="updateSliderValue('style', this.value)">
                                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span>Natural (0.0)</span>
                                                    <span>Exaggerated (1.0)</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Higher = more expressive, can reduce quality</p>
                                            </div>
                                        </div>

                                        <!-- Right Column: Performance & Output -->
                                        <div class="space-y-4">
                                            <h4 class="text-md font-semibold text-gray-700 border-b pb-2">Performance & Output</h4>
                                            
                                            <!-- Speaker Boost -->
                                            <div>
                                                <label class="form-label">Speaker Boost</label>
                                                <div class="flex items-center space-x-3">
                                                    <input type="checkbox" id="voice-speaker-boost" name="use_speaker_boost" 
                                                           class="form-checkbox" checked onchange="updateCheckboxValue('speaker-boost', this.checked)">
                                                    <span class="text-sm text-gray-700">Enable speaker boost for better quality</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Recommended for most use cases</p>
                                            </div>

                                            <!-- Model Selection -->
                                            <div>
                                                <label for="voice-model" class="form-label">AI Model</label>
                                                <select id="voice-model" name="model_id" class="form-select">
                                                    <option value="eleven_turbo_v2_5">Turbo v2.5 (Fastest)</option>
                                                    <option value="eleven_multilingual_v2">Multilingual v2 (Quality)</option>
                                                    <option value="eleven_monolingual_v1">Monolingual v1 (Classic)</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">Turbo recommended for real-time applications</p>
                                            </div>

                                            <!-- Output Format -->
                                            <div>
                                                <label for="voice-format" class="form-label">Output Format</label>
                                                <select id="voice-format" name="output_format" class="form-select">
                                                    <option value="mp3_44100_128">MP3 44.1kHz 128kbps (Recommended)</option>
                                                    <option value="mp3_44100_192">MP3 44.1kHz 192kbps (Higher Quality)</option>
                                                    <option value="pcm_16000">PCM 16kHz (Phone Quality)</option>
                                                    <option value="pcm_22050">PCM 22kHz (Good Quality)</option>
                                                    <option value="pcm_44100">PCM 44.1kHz (CD Quality)</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">MP3 recommended for web delivery</p>
                                            </div>

                                            <!-- Streaming Optimization -->
                                            <div>
                                                <label for="voice-latency" class="form-label">Streaming Latency</label>
                                                <select id="voice-latency" name="optimize_streaming_latency" class="form-select">
                                                    <option value="0">No optimization (Best Quality)</option>
                                                    <option value="1">Light optimization</option>
                                                    <option value="2">Moderate optimization</option>
                                                    <option value="3">High optimization</option>
                                                    <option value="4">Maximum optimization (Real-time)</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">Higher values reduce latency but may affect quality</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Test & Preview -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gray-50 px-6 py-4 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-vial mr-2 text-green-600"></i>Test & Preview
                                    </h3>
                                </div>
                                
                                <div class="p-6">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Test Input -->
                                        <div>
                                            <label for="test-text" class="form-label">Test Message</label>
                                            <textarea id="test-text" name="testText" rows="3" class="form-input" 
                                                      placeholder="Enter text to test voice synthesis...">Hello! Thanks for calling. How can I help you today?</textarea>
                                            
                                            <div class="flex items-center space-x-3 mt-3">
                                                <button type="button" id="test-voice-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">
                                                    <i class="fas fa-play mr-2"></i>Generate Test Audio
                                                </button>
                                                <button type="button" id="stream-test-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">
                                                    <i class="fas fa-broadcast-tower mr-2"></i>Stream Test
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Test Results -->
                                        <div>
                                            <label class="form-label">Test Results</label>
                                            <div id="test-results" class="bg-gray-50 border border-gray-200 rounded-lg p-4 min-h-[120px]">
                                                <div class="text-center text-gray-500 py-8">
                                                    <i class="fas fa-headphones text-2xl mb-2"></i>
                                                    <p>Test your voice settings to hear how they sound</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Save Settings -->
                            <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded-lg p-6">
                                <div>
                                    <h3 class="text-md font-semibold text-gray-800">Save Voice Configuration</h3>
                                    <p class="text-sm text-gray-600">Apply these settings to your AI agent</p>
                                </div>
                                <div class="flex space-x-3">
                                    <button type="button" id="save-voice-settings" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-150">
                                        <i class="fas fa-save mr-2"></i>Save Voice Settings
                                    </button>
                                </div>
                            </div>
                        </section>
                    </div>

                    <div id="personality-responses-content" class="tab-content-item hidden">
                        <section class="profile-section bg-transparent shadow-none p-0">
                            <h2 class="profile-section-title"><i class="fas fa-comment-dots mr-2 text-indigo-600"></i>Agent Personality Responses</h2>
                            <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-info-circle text-blue-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-blue-700">
                                            Customize how your AI agent responds in common scenarios. These responses will be used 
                                            to maintain consistent, professional communication that reflects your company's voice and brand.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Placeholder Management Section -->
                            <div class="mb-8 bg-gray-50 border border-gray-200 rounded-lg p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900">
                                        <i class="fas fa-tags mr-2 text-purple-600"></i>Response Placeholders
                                    </h3>
                                    <button type="button" id="add-placeholder-btn" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-150">
                                        <i class="fas fa-plus mr-1"></i>Add Placeholder
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 mb-4">
                                    Use placeholders in your responses to automatically insert dynamic content. Placeholders are enclosed in curly braces like <code class="bg-gray-200 px-1 rounded text-purple-700">{companyname}</code>.
                                </p>
                                
                                <!-- Placeholder Table -->
                                <div class="overflow-hidden border border-gray-200 rounded-lg">
                                    <table class="min-w-full bg-white">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Placeholder</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value/Description</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="placeholders-table-body" class="bg-white divide-y divide-gray-200">
                                            <!-- Placeholders will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Response Categories Management Section -->
                            <div class="mb-8 bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-200 rounded-lg p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900">
                                        <i class="fas fa-comment-alt mr-2 text-indigo-600"></i>Response Categories
                                    </h3>
                                    <button type="button" id="add-response-category-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-150">
                                        <i class="fas fa-plus mr-1"></i>Add Response Category
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 mb-4">
                                    Manage response categories for different scenarios. Each category defines how your AI agent responds in specific situations.
                                </p>
                                
                                <!-- Response Categories List -->
                                <div id="response-categories-container" class="space-y-3">
                                    <!-- Response categories will be populated here -->
                                </div>
                            </div>
                            <form id="personality-responses-form">
                                <div id="personality-responses-list" class="space-y-4"></div>
                                <div class="mt-8 pt-5 border-t border-gray-200">
                                </div>
                            </form>
                        </section>
                    </div>

                    <!-- Add/Edit Placeholder Modal -->
                    <div id="placeholder-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
                        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                            <div class="mt-3">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-medium text-gray-900" id="placeholder-modal-title">Add Placeholder</h3>
                                    <button type="button" class="text-gray-400 hover:text-gray-600" id="close-placeholder-modal">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <form id="placeholder-form">
                                    <div class="mb-4">
                                        <label for="placeholder-name" class="block text-sm font-medium text-gray-700 mb-2">
                                            Placeholder Name
                                        </label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-2 text-gray-500">{</span>
                                            <input type="text" id="placeholder-name" name="placeholder-name" 
                                                   class="pl-8 pr-8 py-2 w-full border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500"
                                                   placeholder="companyname" required>
                                            <span class="absolute right-3 top-2 text-gray-500">}</span>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Use lowercase, no spaces (e.g., companyname, phonenumber)</p>
                                    </div>
                                    <div class="mb-4">
                                        <label for="placeholder-value" class="block text-sm font-medium text-gray-700 mb-2">
                                            Value
                                        </label>
                                        <input type="text" id="placeholder-value" name="placeholder-value" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500"
                                               placeholder="Your Company Name" required>
                                        <p class="text-xs text-gray-500 mt-1">The text that will replace this placeholder</p>
                                    </div>
                                    <div class="mb-6">
                                        <label for="placeholder-description" class="block text-sm font-medium text-gray-700 mb-2">
                                            Description (Optional)
                                        </label>
                                        <input type="text" id="placeholder-description" name="placeholder-description" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500"
                                               placeholder="Brief description of this placeholder">
                                    </div>
                                    <div class="flex justify-end space-x-3">
                                        <button type="button" id="cancel-placeholder" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                                            Cancel
                                        </button>
                                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-purple-600 rounded-md hover:bg-purple-700">
                                            <span id="placeholder-submit-text">Add Placeholder</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Add/Edit Response Category Modal -->
                    <div id="response-category-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
                        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                            <div class="mt-3">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-medium text-gray-900" id="response-category-modal-title">Add Response Category</h3>
                                    <button type="button" class="text-gray-400 hover:text-gray-600" id="close-response-category-modal">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <form id="response-category-form">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label for="response-category-key" class="block text-sm font-medium text-gray-700 mb-2">
                                                Category Key <span class="text-red-500">*</span>
                                            </label>
                                            <input type="text" id="response-category-key" name="response-category-key" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                                   placeholder="e.g., greeting, pricing, support" required>
                                            <p class="text-xs text-gray-500 mt-1">Lowercase, no spaces (used for identification)</p>
                                        </div>
                                        <div>
                                            <label for="response-category-label" class="block text-sm font-medium text-gray-700 mb-2">
                                                Display Label <span class="text-red-500">*</span>
                                            </label>
                                            <input type="text" id="response-category-label" name="response-category-label" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                                   placeholder="e.g., Greeting Response" required>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="response-category-icon" class="block text-sm font-medium text-gray-700 mb-2">
                                            Icon Class
                                        </label>
                                        <input type="text" id="response-category-icon" name="response-category-icon" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                               placeholder="e.g., fas fa-hand-wave">
                                        <p class="text-xs text-gray-500 mt-1">FontAwesome icon class (optional)</p>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="response-category-description" class="block text-sm font-medium text-gray-700 mb-2">
                                            Description
                                        </label>
                                        <textarea id="response-category-description" name="response-category-description" 
                                                  rows="2"
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                                  placeholder="Brief description of when this response is used"></textarea>
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label for="response-category-default" class="block text-sm font-medium text-gray-700 mb-2">
                                            Default Response Template
                                        </label>
                                        <textarea id="response-category-default" name="response-category-default" 
                                                  rows="3"
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                                  placeholder="Enter the default response template (you can use placeholders like {companyname})"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">Use placeholders like {companyname} for dynamic content</p>
                                    </div>
                                    
                                    <div class="flex justify-end space-x-3">
                                        <button type="button" id="cancel-response-category" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                                            Cancel
                                        </button>
                                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">
                                            <span id="response-category-submit-text">Add Category</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div id="ai-agent-logic-content" class="tab-content-item hidden">
                        <section class="profile-section bg-transparent shadow-none p-0">
                            <h2 class="profile-section-title"><i class="fas fa-brain mr-2 text-indigo-600"></i>AI Agent Logic</h2>
                            

                            
                            <!-- ðŸ§  AGENT CLIENTSVIA INTELLIGENCE - UNIFIED CONTAINER -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-4 rounded-t-lg">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fas fa-brain mr-3 text-white text-2xl"></i>
                                            <div>                                <h3 class="text-xl font-bold text-white">ðŸ§  Agent ClientsVia Intelligence</h3>
                                <p class="text-indigo-100 text-sm mt-1">Agent Personality & Complete AI Configuration - Priority Flow & Knowledge Sources</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-3">
                                            <button id="save-clientsvia-all-config" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white font-semibold rounded-lg backdrop-blur-sm transition-all duration-200 border border-white/30">
                                                <i class="fas fa-save mr-2"></i>Save All ClientsVia Settings
                                            </button>
                                            <span class="px-3 py-1 bg-white/20 text-white text-xs font-medium rounded-full backdrop-blur-sm">
                                                <i class="fas fa-rocket mr-1"></i>ClientsVia Unified
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-6">
                                    <!-- Tab Navigation -->
                                    <div class="flex border-b border-gray-200 mb-6">
                                        <button id="clientsvia-tab-priority" class="clientsvia-tab-btn active px-6 py-3 text-sm font-medium border-b-2 border-indigo-500 text-indigo-600 bg-indigo-50">
                                            <i class="fas fa-layer-group mr-2"></i>Answer Priority Flow
                                        </button>
                                        <button id="clientsvia-tab-knowledge" class="clientsvia-tab-btn px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                            <i class="fas fa-book-open mr-2"></i>Knowledge Source Controls
                                        </button>
                                        <button id="clientsvia-tab-personality" class="clientsvia-tab-btn px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                            <i class="fas fa-theater-masks mr-2"></i>Agent Personality
                                        </button>
                                    </div>
                                    
                                    <!-- Tab Content Container -->
                                    <div id="clientsvia-tab-content">
                                        
                                        <!-- TAB 1: Answer Priority Flow -->
                                        <div id="clientsvia-priority-content" class="clientsvia-tab-content active">
                                            <div class="mb-6">
                                                <h4 class="text-lg font-semibold text-gray-800 flex items-center mb-4">
                                                    <i class="fas fa-flow-chart mr-2 text-indigo-600"></i>Answer Priority Flow
                                                    <span class="ml-2 text-sm text-gray-600">(Drag to reorder)</span>
                                                </h4>
                                                
                                                <!-- Sortable Priority Items -->
                                                <div id="clientsvia-priority-flow-container" class="space-y-3">
                                                    <!-- Company Knowledge Base -->
                                                    <div class="clientsvia-priority-item" data-priority-type="company-knowledge" data-priority-order="1" draggable="true">
                                                        <div class="flex items-center justify-between p-4 bg-gradient-to-r from-emerald-50 to-green-50 border-2 border-emerald-200 rounded-lg cursor-move hover:shadow-md transition-all duration-200">
                                                            <div class="flex items-center">
                                                                <div class="drag-handle flex items-center justify-center w-8 h-8 bg-emerald-600 text-white rounded-full mr-3">
                                                                    <i class="fas fa-grip-vertical"></i>
                                                                </div>
                                                                <div class="priority-number flex items-center justify-center w-8 h-8 bg-emerald-700 text-white rounded-full mr-3">
                                                                    <span class="font-bold text-sm">1</span>
                                                                </div>
                                                                <div class="flex items-center mr-3">
                                                                    <i class="fas fa-building text-emerald-600 text-lg mr-2"></i>
                                                                    <div>
                                                                        <h5 class="font-semibold text-gray-800">Company Knowledge Base</h5>
                                                                        <p class="text-xs text-gray-600">Company-specific Q&A and internal documentation</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="flex items-center space-x-2">
                                                                <label class="flex items-center">
                                                                    <input type="checkbox" class="clientsvia-priority-toggle" checked />
                                                                    <span class="ml-2 text-sm text-gray-700">Active</span>
                                                                </label>
                                                                <span class="px-2 py-1 bg-emerald-100 text-emerald-800 text-xs font-medium rounded-full">
                                                                    <i class="fas fa-star mr-1"></i>Primary
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Trade Categories -->
                                                    <div class="clientsvia-priority-item" data-priority-type="trade-categories" data-priority-order="2" draggable="true">
                                                        <div class="flex items-center justify-between p-4 bg-gradient-to-r from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-lg cursor-move hover:shadow-md transition-all duration-200">
                                                            <div class="flex items-center">
                                                                <div class="drag-handle flex items-center justify-center w-8 h-8 bg-blue-600 text-white rounded-full mr-3">
                                                                    <i class="fas fa-grip-vertical"></i>
                                                                </div>
                                                                <div class="priority-number flex items-center justify-center w-8 h-8 bg-blue-700 text-white rounded-full mr-3">
                                                                    <span class="font-bold text-sm">2</span>
                                                                </div>
                                                                <div class="flex items-center mr-3">
                                                                    <i class="fas fa-briefcase text-blue-600 text-lg mr-2"></i>
                                                                    <div>
                                                                        <h5 class="font-semibold text-gray-800">Trade Categories Q&A</h5>
                                                                        <p class="text-xs text-gray-600">Industry-specific questions and answers</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="flex items-center space-x-2">
                                                                <label class="flex items-center">
                                                                    <input type="checkbox" class="clientsvia-priority-toggle" checked />
                                                                    <span class="ml-2 text-sm text-gray-700">Active</span>
                                                                </label>
                                                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                                                                    <i class="fas fa-tools mr-1"></i>Industry
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Template Intelligence -->
                                                    <div class="clientsvia-priority-item" data-priority-type="template-intelligence" data-priority-order="3" draggable="true">
                                                        <div class="flex items-center justify-between p-4 bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-lg cursor-move hover:shadow-md transition-all duration-200">
                                                            <div class="flex items-center">
                                                                <div class="drag-handle flex items-center justify-center w-8 h-8 bg-purple-600 text-white rounded-full mr-3">
                                                                    <i class="fas fa-grip-vertical"></i>
                                                                </div>
                                                                <div class="priority-number flex items-center justify-center w-8 h-8 bg-purple-700 text-white rounded-full mr-3">
                                                                    <span class="font-bold text-sm">3</span>
                                                                </div>
                                                                <div class="flex items-center mr-3">
                                                                    <i class="fas fa-magic text-purple-600 text-lg mr-2"></i>
                                                                    <div>
                                                                        <h5 class="font-semibold text-gray-800">Template Intelligence</h5>
                                                                        <p class="text-xs text-gray-600">Smart templates and conversation patterns</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="flex items-center space-x-2">
                                                                <label class="flex items-center">
                                                                    <input type="checkbox" class="clientsvia-priority-toggle" checked />
                                                                    <span class="ml-2 text-sm text-gray-700">Active</span>
                                                                </label>
                                                                <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs font-medium rounded-full">
                                                                    <i class="fas fa-lightbulb mr-1"></i>Smart
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Learning Queue -->
                                                    <div class="clientsvia-priority-item" data-priority-type="learning-queue" data-priority-order="4" draggable="true">
                                                        <div class="flex items-center justify-between p-4 bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 rounded-lg cursor-move hover:shadow-md transition-all duration-200">
                                                            <div class="flex items-center">
                                                                <div class="drag-handle flex items-center justify-center w-8 h-8 bg-amber-600 text-white rounded-full mr-3">
                                                                    <i class="fas fa-grip-vertical"></i>
                                                                </div>
                                                                <div class="priority-number flex items-center justify-center w-8 h-8 bg-amber-700 text-white rounded-full mr-3">
                                                                    <span class="font-bold text-sm">4</span>
                                                                </div>
                                                                <div class="flex items-center mr-3">
                                                                    <i class="fas fa-graduation-cap text-amber-600 text-lg mr-2"></i>
                                                                    <div>
                                                                        <h5 class="font-semibold text-gray-800">Learning Queue Insights</h5>
                                                                        <p class="text-xs text-gray-600">Previously learned patterns and approved answers</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="flex items-center space-x-2">
                                                                <label class="flex items-center">
                                                                    <input type="checkbox" class="clientsvia-priority-toggle" checked />
                                                                    <span class="ml-2 text-sm text-gray-700">Active</span>
                                                                </label>
                                                                <span class="px-2 py-1 bg-amber-100 text-amber-800 text-xs font-medium rounded-full">
                                                                    <i class="fas fa-brain mr-1"></i>Learning
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Emergency LLM -->
                                                    <div class="clientsvia-priority-item" data-priority-type="emergency-llm" data-priority-order="5" draggable="true">
                                                        <div class="flex items-center justify-between p-4 bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-200 rounded-lg cursor-move hover:shadow-md transition-all duration-200">
                                                            <div class="flex items-center">
                                                                <div class="drag-handle flex items-center justify-center w-8 h-8 bg-red-600 text-white rounded-full mr-3">
                                                                    <i class="fas fa-grip-vertical"></i>
                                                                </div>
                                                                <div class="priority-number flex items-center justify-center w-8 h-8 bg-red-700 text-white rounded-full mr-3">
                                                                    <span class="font-bold text-sm">5</span>
                                                                </div>
                                                                <div class="flex items-center mr-3">
                                                                    <i class="fas fa-exclamation-triangle text-red-600 text-lg mr-2"></i>
                                                                    <div>
                                                                        <h5 class="font-semibold text-gray-800">Emergency LLM Fallback</h5>
                                                                        <p class="text-xs text-gray-600">Last resort: external AI when no knowledge matches</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="flex items-center space-x-2">
                                                                <label class="flex items-center">
                                                                    <input type="checkbox" class="clientsvia-priority-toggle" checked />
                                                                    <span class="ml-2 text-sm text-gray-700">Active</span>
                                                                </label>
                                                                <span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full">
                                                                    <i class="fas fa-life-ring mr-1"></i>Emergency
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- ClientsVia Priority Status -->
                                            <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                                                <div class="flex items-center text-sm text-green-800">
                                                    <i class="fas fa-check-circle mr-2"></i>
                                                    <strong>ClientsVia Priority Status:</strong> Interactive drag & drop enabled! Reorder priorities and toggle active states.
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- TAB 2: Knowledge Source Controls -->
                                        <div id="clientsvia-knowledge-content" class="clientsvia-tab-content hidden">
                                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                <!-- Left Column: Source Priority & Configuration -->
                                                <div class="space-y-5">
                                                    <h4 class="text-md font-semibold text-gray-700 border-b pb-2">
                                                        <i class="fas fa-layer-group mr-2 text-indigo-600"></i>Knowledge Source Priority
                                                        <span class="text-xs text-gray-500 ml-2">(Drag to reorder)</span>
                                                    </h4>
                                                    
                                                    <div id="clientsvia-source-priority-container" class="space-y-2">
                                                        <!-- Company Q&A -->
                                                        <div id="clientsvia-source-companyQnA" data-source="companyQnA" class="clientsvia-source-item flex items-center p-3 bg-white border border-gray-300 rounded-lg cursor-move hover:bg-blue-50 transition duration-150">
                                                            <div class="handle mr-3 text-gray-400">
                                                                <i class="fas fa-grip-vertical"></i>
                                                            </div>
                                                            <div class="flex-1">
                                                                <div class="flex items-center justify-between">
                                                                    <div class="flex items-center">
                                                                        <i class="fas fa-building text-blue-500 mr-2"></i>
                                                                        <span class="font-medium">Company Q&A</span>
                                                                    </div>
                                                                    <div class="text-sm font-mono bg-blue-100 text-blue-800 px-2 py-0.5 rounded">
                                                                        Priority: <span class="priority-value">1</span>
                                                                    </div>
                                                                </div>
                                                                <p class="text-xs text-gray-600 mt-1">Company-specific questions and answers</p>
                                                                <div class="mt-2">
                                                                    <label class="flex items-center space-x-2 text-sm">
                                                                        <span class="text-gray-700">Confidence:</span>
                                                                        <input type="range" 
                                                                            id="clientsvia-threshold-companyQnA" 
                                                                            class="w-1/2" 
                                                                            min="0" max="1" step="0.05" value="0.8">
                                                                        <span id="clientsvia-threshold-value-companyQnA" class="text-sm font-mono">0.80</span>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Trade Category Q&A -->
                                                        <div id="clientsvia-source-tradeQnA" data-source="tradeQnA" class="clientsvia-source-item flex items-center p-3 bg-white border border-gray-300 rounded-lg cursor-move hover:bg-blue-50 transition duration-150">
                                                            <div class="handle mr-3 text-gray-400">
                                                                <i class="fas fa-grip-vertical"></i>
                                                            </div>
                                                            <div class="flex-1">
                                                                <div class="flex items-center justify-between">
                                                                    <div class="flex items-center">
                                                                        <i class="fas fa-tools text-purple-500 mr-2"></i>
                                                                        <span class="font-medium">Trade Category Q&A</span>
                                                                    </div>
                                                                    <div class="text-sm font-mono bg-purple-100 text-purple-800 px-2 py-0.5 rounded">
                                                                        Priority: <span class="priority-value">2</span>
                                                                    </div>
                                                                </div>
                                                                <p class="text-xs text-gray-600 mt-1">Industry-specific knowledge (HVAC, plumbing, etc.)</p>
                                                                <div class="mt-2">
                                                                    <label class="flex items-center space-x-2 text-sm">
                                                                        <span class="text-gray-700">Confidence:</span>
                                                                        <input type="range" 
                                                                            id="clientsvia-threshold-tradeQnA" 
                                                                            class="w-1/2" 
                                                                            min="0" max="1" step="0.05" value="0.75">
                                                                        <span id="clientsvia-threshold-value-tradeQnA" class="text-sm font-mono">0.75</span>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Vector Search -->
                                                        <div id="clientsvia-source-vectorSearch" data-source="vectorSearch" class="clientsvia-source-item flex items-center p-3 bg-white border border-gray-300 rounded-lg cursor-move hover:bg-blue-50 transition duration-150">
                                                            <div class="handle mr-3 text-gray-400">
                                                                <i class="fas fa-grip-vertical"></i>
                                                            </div>
                                                            <div class="flex-1">
                                                                <div class="flex items-center justify-between">
                                                                    <div class="flex items-center">
                                                                        <i class="fas fa-network-wired text-green-500 mr-2"></i>
                                                                        <span class="font-medium">Vector Search</span>
                                                                    </div>
                                                                    <div class="text-sm font-mono bg-green-100 text-green-800 px-2 py-0.5 rounded">
                                                                        Priority: <span class="priority-value">3</span>
                                                                    </div>
                                                                </div>
                                                                <p class="text-xs text-gray-600 mt-1">Semantic search across all knowledge</p>
                                                                <div class="mt-2">
                                                                    <label class="flex items-center space-x-2 text-sm">
                                                                        <span class="text-gray-700">Confidence:</span>
                                                                        <input type="range" 
                                                                            id="clientsvia-threshold-vectorSearch" 
                                                                            class="w-1/2" 
                                                                            min="0" max="1" step="0.05" value="0.7">
                                                                        <span id="clientsvia-threshold-value-vectorSearch" class="text-sm font-mono">0.70</span>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- LLM Fallback -->
                                                        <div id="clientsvia-source-llmFallback" data-source="llmFallback" class="clientsvia-source-item flex items-center p-3 bg-white border border-gray-300 rounded-lg cursor-move hover:bg-blue-50 transition duration-150">
                                                            <div class="handle mr-3 text-gray-400">
                                                                <i class="fas fa-grip-vertical"></i>
                                                            </div>
                                                            <div class="flex-1">
                                                                <div class="flex items-center justify-between">
                                                                    <div class="flex items-center">
                                                                        <i class="fas fa-robot text-amber-500 mr-2"></i>
                                                                        <span class="font-medium">LLM Fallback</span>
                                                                    </div>
                                                                    <div class="text-sm font-mono bg-amber-100 text-amber-800 px-2 py-0.5 rounded">
                                                                        Priority: <span class="priority-value">4</span>
                                                                    </div>
                                                                </div>
                                                                <p class="text-xs text-gray-600 mt-1">AI-generated responses (last resort)</p>
                                                                <div class="mt-2">
                                                                    <label class="flex items-center space-x-2 text-sm">
                                                                        <span class="text-gray-700">Confidence:</span>
                                                                        <input type="range" 
                                                                            id="clientsvia-threshold-llmFallback" 
                                                                            class="w-1/2" 
                                                                            min="0" max="1" step="0.05" value="0.6">
                                                                        <span id="clientsvia-threshold-value-llmFallback" class="text-sm font-mono">0.60</span>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Right Column: Memory & Fallback Settings -->
                                                <div class="space-y-5">
                                                    <h4 class="text-md font-semibold text-gray-700 border-b pb-2">
                                                        <i class="fas fa-brain mr-2 text-indigo-600"></i>Memory & Fallback Options
                                                    </h4>
                                                    
                                                    <!-- Memory Mode Selection -->
                                                    <div>
                                                        <label for="clientsvia-memoryModeSelect" class="form-label">Memory Mode</label>
                                                        <select id="clientsvia-memoryModeSelect" class="form-select">
                                                            <option value="short">Short-term (Basic context)</option>
                                                            <option value="conversational" selected>Conversational (Full dialog history)</option>
                                                            <option value="session">Session (Persistent memory)</option>
                                                        </select>
                                                        <p class="text-xs text-gray-500 mt-1">How agent remembers previous interactions</p>
                                                    </div>
                                                    
                                                    <!-- Context Retention Time -->
                                                    <div>
                                                        <label for="clientsvia-contextRetentionSlider" class="form-label">Context Retention Time</label>
                                                        <div class="flex items-center space-x-3">
                                                            <input type="range" id="clientsvia-contextRetentionSlider" 
                                                                class="w-1/2" min="5" max="120" step="5" value="30">
                                                            <span id="clientsvia-contextRetentionValue" class="text-sm font-mono bg-gray-100 px-2 py-1 rounded">30 minutes</span>
                                                        </div>
                                                        <p class="text-xs text-gray-500 mt-1">How long to maintain conversation history</p>
                                                    </div>
                                                    
                                                    <!-- Fallback Behaviors -->
                                                    <div class="mt-5">
                                                        <h5 class="text-sm font-medium text-gray-700 mb-3">Fallback Behavior</h5>
                                                        <div class="space-y-3">
                                                            <label class="flex items-center p-3 bg-red-50 rounded-lg border border-red-200">
                                                                <input type="checkbox" id="clientsvia-rejectLowConfidenceToggle" class="form-checkbox" checked>
                                                                <div class="ml-3">
                                                                    <span class="text-sm font-medium text-gray-900">Reject Low Confidence Matches</span>
                                                                    <p class="text-xs text-gray-500">Don't use answers below threshold</p>
                                                                </div>
                                                            </label>
                                                            
                                                            <label class="flex items-center p-3 bg-orange-50 rounded-lg border border-orange-200">
                                                                <input type="checkbox" id="clientsvia-escalateNoMatchToggle" class="form-checkbox" checked>
                                                                <div class="ml-3">
                                                                    <span class="text-sm font-medium text-gray-900">Escalate On No Match</span>
                                                                    <p class="text-xs text-gray-500">Connect to human when no good answers</p>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Fallback Message -->
                                                    <div class="mt-4">
                                                        <label for="clientsvia-fallbackMessageInput" class="form-label">Fallback Message</label>
                                                        <textarea id="clientsvia-fallbackMessageInput" class="form-textarea" rows="3">I want to make sure I give you accurate information. Let me connect you with a specialist who can help.</textarea>
                                                        <p class="text-xs text-gray-500 mt-1">Message to use when escalating to human</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- ClientsVia Knowledge Status -->
                                            <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                                <div class="flex items-center text-sm text-blue-800">
                                                    <i class="fas fa-info-circle mr-2"></i>
                                                    <strong>ClientsVia Knowledge Status:</strong> Advanced knowledge source configuration active. Drag to reorder priority and adjust confidence thresholds.
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- TAB 3: Agent Personality -->
                                        <div id="clientsvia-personality-content" class="clientsvia-tab-content hidden">
                                            <div class="mb-6">
                                                <h4 class="text-lg font-semibold text-gray-800 flex items-center mb-4">
                                                    <i class="fas fa-theater-masks mr-2 text-pink-600"></i>Agent Personality Configuration
                                                    <span class="ml-2 text-sm text-gray-600">(Voice tone, pace & behavior)</span>
                                                </h4>
                                                
                                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                    <!-- Left Column: Voice Settings -->
                                                    <div class="space-y-4">
                                                        <h5 class="text-md font-semibold text-gray-700 border-b pb-2">
                                                            <i class="fas fa-microphone mr-2 text-pink-600"></i>Voice Configuration
                                                        </h5>
                                                        
                                                        <!-- Voice Tone -->
                                                        <div>
                                                            <label for="clientsvia-voiceToneSelect" class="form-label">Voice Tone</label>
                                                            <select id="clientsvia-voiceToneSelect" class="form-select">
                                                                <option value="friendly">Friendly - Warm and approachable</option>
                                                                <option value="professional">Professional - Business-focused</option>
                                                                <option value="playful">Playful - Light and engaging</option>
                                                            </select>
                                                            <p class="text-xs text-gray-500 mt-1">Controls word choice and phrasing style</p>
                                                        </div>

                                                        <!-- Speech Pace -->
                                                        <div>
                                                            <label for="clientsvia-speechPaceSelect" class="form-label">Speech Pace</label>
                                                            <select id="clientsvia-speechPaceSelect" class="form-select">
                                                                <option value="slow">Slow - Deliberate and clear</option>
                                                                <option value="normal">Normal - Standard pace</option>
                                                                <option value="fast">Fast - Quick and efficient</option>
                                                            </select>
                                                            <p class="text-xs text-gray-500 mt-1">Adjusts TTS speed for ElevenLabs or Google</p>
                                                        </div>
                                                    </div>

                                                    <!-- Right Column: Behavior Settings -->
                                                    <div class="space-y-4">
                                                        <h5 class="text-md font-semibold text-gray-700 border-b pb-2">
                                                            <i class="fas fa-user-cog mr-2 text-rose-600"></i>Behavior Controls
                                                        </h5>
                                                        
                                                        <!-- Interactive Behaviors -->
                                                        <div class="space-y-3">
                                                            <label class="flex items-center p-3 bg-blue-50 rounded-lg border border-blue-200">
                                                                <input type="checkbox" id="clientsvia-bargeInToggle" class="form-checkbox">
                                                                <div class="ml-3">
                                                                    <span class="text-sm font-medium text-gray-900">Allow Barge-In</span>
                                                                    <p class="text-xs text-gray-500">Caller can interrupt AI while speaking</p>
                                                                </div>
                                                            </label>

                                                            <label class="flex items-center p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                                                                <input type="checkbox" id="clientsvia-emotionToggle" class="form-checkbox">
                                                                <div class="ml-3">
                                                                    <span class="text-sm font-medium text-gray-900">Acknowledge Emotion</span>
                                                                    <p class="text-xs text-gray-500">Respond to frustration, urgency, etc.</p>
                                                                </div>
                                                            </label>

                                                            <label class="flex items-center p-3 bg-green-50 rounded-lg border border-green-200">
                                                                <input type="checkbox" id="clientsvia-emojiToggle" class="form-checkbox">
                                                                <div class="ml-3">
                                                                    <span class="text-sm font-medium text-gray-900">Use Emojis</span>
                                                                    <p class="text-xs text-gray-500">Add emojis in SMS/email (ðŸ‘ ðŸ˜Š âŒ)</p>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Action Buttons -->
                                                <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center">
                                                    <div class="flex items-center space-x-4">
                                                        <button type="button" onclick="previewClientsviaPersonality()" class="bg-pink-600 hover:bg-pink-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">
                                                            <i class="fas fa-play mr-2"></i>Preview Voice
                                                        </button>
                                                        <button type="button" onclick="resetClientsviaPersonalityDefaults()" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">
                                                            <i class="fas fa-undo mr-2"></i>Reset Defaults
                                                        </button>
                                                    </div>
                                                    <div class="flex items-center space-x-3">
                                                        <span id="clientsvia-personality-settings-saved" class="text-green-600 text-sm hidden">
                                                            <i class="fas fa-check-circle mr-1"></i>Personality Saved!
                                                        </span>
                                                        <button type="button" onclick="saveClientsviaAgentPersonalitySettings()" class="bg-rose-600 hover:bg-rose-700 text-white font-medium py-2 px-6 rounded-md shadow-sm transition duration-150 ease-in-out">
                                                            <i class="fas fa-save mr-2"></i>Save Personality
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <!-- ðŸŽ­ RESPONSE CATEGORIES - ENTERPRISE TEMPLATE ENGINE -->
                                                <div class="mt-8 p-6 bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-200 rounded-xl shadow-sm">
                                                    <div class="flex items-center justify-between mb-6">
                                                        <div>
                                                            <h5 class="text-lg font-bold text-purple-800 flex items-center">
                                                                <i class="fas fa-comments mr-3 text-purple-600"></i>Response Categories
                                                                <span class="ml-2 px-2 py-1 bg-purple-100 text-purple-700 text-xs font-semibold rounded-full">ENTERPRISE</span>
                                                            </h5>
                                                            <p class="text-sm text-purple-600 mt-1">Define branded responses that adapt to your personality settings automatically</p>
                                                        </div>
                                                        <button type="button" onclick="toggleResponsePreview()" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg shadow-sm transition duration-150 ease-in-out">
                                                            <i class="fas fa-eye mr-2"></i>Live Preview
                                                        </button>
                                                    </div>

                                                    <!-- Response Category Tabs -->
                                                    <div class="flex flex-wrap gap-2 mb-6 p-2 bg-white/50 rounded-lg border border-purple-100">
                                                        <button onclick="switchResponseCategory('core')" class="response-category-tab active bg-purple-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-all duration-200">Core Responses</button>
                                                        <button onclick="switchResponseCategory('advanced')" class="response-category-tab bg-white text-purple-600 hover:bg-purple-50 px-4 py-2 rounded-md text-sm font-medium transition-all duration-200">Advanced</button>
                                                        <button onclick="switchResponseCategory('emotional')" class="response-category-tab bg-white text-purple-600 hover:bg-purple-50 px-4 py-2 rounded-md text-sm font-medium transition-all duration-200">Emotional</button>
                                                    </div>

                                                    <!-- Core Responses Tab -->
                                                    <div id="core-responses" class="response-category-content">
                                                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                            <!-- Left Column - Primary Responses -->
                                                            <div class="space-y-4">
                                                                <h6 class="text-md font-semibold text-purple-800 border-b border-purple-200 pb-2">
                                                                    <i class="fas fa-star mr-2"></i>Primary Interactions
                                                                </h6>
                                                                
                                                                <!-- Greeting Response -->
                                                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                                        <i class="fas fa-hand-wave mr-2 text-green-500"></i>Greeting Response
                                                                    </label>
                                                                    <textarea id="response-greeting" class="form-textarea w-full h-20 text-sm" placeholder="Hi {callername}! Thanks for calling {companyname}. How can I help you today?">Hi {callername}! Thanks for calling {companyname}. How can I help you today?</textarea>
                                                                    <div class="flex items-center justify-between mt-2">
                                                                        <div class="flex flex-wrap gap-1" data-response-variables="response-greeting">
                                                                            <!-- Variable buttons will be populated dynamically -->
                                                                        </div>
                                                                        <button onclick="previewResponse('response-greeting')" class="text-purple-600 hover:text-purple-800 text-xs font-medium">
                                                                            <i class="fas fa-play mr-1"></i>Preview
                                                                        </button>
                                                                    </div>
                                                                </div>

                                                                <!-- Farewell Response -->
                                                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                                        <i class="fas fa-hand-peace mr-2 text-blue-500"></i>Farewell Response
                                                                    </label>
                                                                    <textarea id="response-farewell" class="form-textarea w-full h-20 text-sm" placeholder="Thanks for calling {companyname}! Have a great day!">Thanks for calling {companyname}! Have a great day!</textarea>
                                                                    <div class="flex items-center justify-between mt-2">
                                                                        <div class="flex flex-wrap gap-1" data-response-variables="response-farewell">
                                                                            <!-- Variable buttons will be populated dynamically -->
                                                                        </div>
                                                                        <button onclick="previewResponse('response-farewell')" class="text-purple-600 hover:text-purple-800 text-xs font-medium">
                                                                            <i class="fas fa-play mr-1"></i>Preview
                                                                        </button>
                                                                    </div>
                                                                </div>

                                                                <!-- Hold Response -->
                                                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                                        <i class="fas fa-pause-circle mr-2 text-yellow-500"></i>Hold Response
                                                                    </label>
                                                                    <textarea id="response-hold" class="form-textarea w-full h-20 text-sm" placeholder="Please hold for just a moment while I look that up for you.">Please hold for just a moment while I look that up for you.</textarea>
                                                                    <div class="flex items-center justify-between mt-2">
                                                                        <div class="flex flex-wrap gap-1" data-response-variables="response-hold">
                                                                            <!-- Variable buttons will be populated dynamically -->
                                                                        </div>
                                                                        <button onclick="previewResponse('response-hold')" class="text-purple-600 hover:text-purple-800 text-xs font-medium">
                                                                            <i class="fas fa-play mr-1"></i>Preview
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- Right Column - Service Responses -->
                                                            <div class="space-y-4">
                                                                <h6 class="text-md font-semibold text-purple-800 border-b border-purple-200 pb-2">
                                                                    <i class="fas fa-cogs mr-2"></i>Service Interactions
                                                                </h6>

                                                                <!-- Transfer Response -->
                                                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                                        <i class="fas fa-phone-alt mr-2 text-indigo-500"></i>Transfer Response
                                                                    </label>
                                                                    <textarea id="response-transfer" class="form-textarea w-full h-20 text-sm" placeholder="Let me connect you with {departmentname} who can better assist you.">Let me connect you with {departmentname} who can better assist you.</textarea>
                                                                    <div class="flex items-center justify-between mt-2">
                                                                        <div class="flex flex-wrap gap-1" data-response-variables="response-transfer">
                                                                            <!-- Variable buttons will be populated dynamically -->
                                                                        </div>
                                                                        <button onclick="previewResponse('response-transfer')" class="text-purple-600 hover:text-purple-800 text-xs font-medium">
                                                                            <i class="fas fa-play mr-1"></i>Preview
                                                                        </button>
                                                                    </div>
                                                                </div>

                                                                <!-- Unavailable Response -->
                                                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                                        <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>Service Unavailable
                                                                    </label>
                                                                    <textarea id="response-unavailable" class="form-textarea w-full h-20 text-sm" placeholder="I'm sorry, {{serviceType}} isn't available right now. Can I help with something else?">I'm sorry, {{serviceType}} isn't available right now. Can I help with something else?</textarea>
                                                                    <div class="flex items-center justify-between mt-2">
                                                                        <div class="flex flex-wrap gap-1">
                                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('response-unavailable', '{{serviceType}}')">{{serviceType}}</span>
                                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('response-unavailable', '{{alternativeService}}')">{{alternativeService}}</span>
                                                                        </div>
                                                                        <button onclick="previewResponse('response-unavailable')" class="text-purple-600 hover:text-purple-800 text-xs font-medium">
                                                                            <i class="fas fa-play mr-1"></i>Preview
                                                                        </button>
                                                                    </div>
                                                                </div>

                                                                <!-- Business Hours Response -->
                                                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                                        <i class="fas fa-clock mr-2 text-orange-500"></i>Business Hours
                                                                    </label>
                                                                    <textarea id="response-hours" class="form-textarea w-full h-20 text-sm" placeholder="We're open {{businessHours}}. You can also visit our website at {{website}}.">We're open {{businessHours}}. You can also visit our website at {{website}}.</textarea>
                                                                    <div class="flex items-center justify-between mt-2">
                                                                        <div class="flex flex-wrap gap-1">
                                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('response-hours', '{{businessHours}}')">{{businessHours}}</span>
                                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('response-hours', '{{website}}')">{{website}}</span>
                                                                        </div>
                                                                        <button onclick="previewResponse('response-hours')" class="text-purple-600 hover:text-purple-800 text-xs font-medium">
                                                                            <i class="fas fa-play mr-1"></i>Preview
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Advanced Responses Tab (Hidden by default) -->
                                                    <div id="advanced-responses" class="response-category-content hidden">
                                                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                            <div class="space-y-4">
                                                                <h6 class="text-md font-semibold text-purple-800 border-b border-purple-200 pb-2">
                                                                    <i class="fas fa-rocket mr-2"></i>Advanced Scenarios
                                                                </h6>
                                                                
                                                                <!-- Callback Response -->
                                                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                                        <i class="fas fa-phone-square mr-2 text-green-600"></i>Callback Request
                                                                    </label>
                                                                    <textarea id="response-callback" class="form-textarea w-full h-20 text-sm" placeholder="I can have someone call you back at {{phoneNumber}}. What's the best time to reach you?">I can have someone call you back at {{phoneNumber}}. What's the best time to reach you?</textarea>
                                                                    <div class="flex items-center justify-between mt-2">
                                                                        <div class="flex flex-wrap gap-1">
                                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('response-callback', '{{phoneNumber}}')">{{phoneNumber}}</span>
                                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('response-callback', '{{preferredTime}}')">{{preferredTime}}</span>
                                                                        </div>
                                                                        <button onclick="previewResponse('response-callback')" class="text-purple-600 hover:text-purple-800 text-xs font-medium">
                                                                            <i class="fas fa-play mr-1"></i>Preview
                                                                        </button>
                                                                    </div>
                                                                </div>

                                                                <!-- Technical Issue Response -->
                                                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                                        <i class="fas fa-tools mr-2 text-red-600"></i>Technical Issues
                                                                    </label>
                                                                    <textarea id="response-technical" class="form-textarea w-full h-20 text-sm" placeholder="I understand you're having a technical issue with {{serviceType}}. Let me get our technical team to help you right away.">I understand you're having a technical issue with {{serviceType}}. Let me get our technical team to help you right away.</textarea>
                                                                    <div class="flex items-center justify-between mt-2">
                                                                        <div class="flex flex-wrap gap-1">
                                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('response-technical', '{{serviceType}}')">{{serviceType}}</span>
                                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('response-technical', '{{ticketNumber}}')">{{ticketNumber}}</span>
                                                                        </div>
                                                                        <button onclick="previewResponse('response-technical')" class="text-purple-600 hover:text-purple-800 text-xs font-medium">
                                                                            <i class="fas fa-play mr-1"></i>Preview
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="space-y-4">
                                                                <h6 class="text-md font-semibold text-purple-800 border-b border-purple-200 pb-2">
                                                                    <i class="fas fa-shield-alt mr-2"></i>Escalation Scenarios
                                                                </h6>

                                                                <!-- Escalation Response -->
                                                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                                        <i class="fas fa-arrow-up mr-2 text-orange-600"></i>Manager Request
                                                                    </label>
                                                                    <textarea id="response-escalation" class="form-textarea w-full h-20 text-sm" placeholder="Absolutely, I'll connect you with my supervisor {{managerName}} right away. They'll be able to help you further.">Absolutely, I'll connect you with my supervisor {{managerName}} right away. They'll be able to help you further.</textarea>
                                                                    <div class="flex items-center justify-between mt-2">
                                                                        <div class="flex flex-wrap gap-1">
                                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('response-escalation', '{{managerName}}')">{{managerName}}</span>
                                                                        </div>
                                                                        <button onclick="previewResponse('response-escalation')" class="text-purple-600 hover:text-purple-800 text-xs font-medium">
                                                                            <i class="fas fa-play mr-1"></i>Preview
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Emotional Responses Tab (Hidden by default) -->
                                                    <div id="emotional-responses" class="response-category-content hidden">
                                                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                            <div class="space-y-4">
                                                                <h6 class="text-md font-semibold text-purple-800 border-b border-purple-200 pb-2">
                                                                    <i class="fas fa-heart mr-2"></i>Emotional Intelligence
                                                                </h6>
                                                                
                                                                <!-- Frustrated Customer -->
                                                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                                        <i class="fas fa-angry mr-2 text-red-500"></i>Frustrated Customer
                                                                    </label>
                                                                    <textarea id="response-frustrated" class="form-textarea w-full h-20 text-sm" placeholder="I completely understand your frustration with {{issueType}}. Let me see what I can do to help resolve this for you right away.">I completely understand your frustration with {{issueType}}. Let me see what I can do to help resolve this for you right away.</textarea>
                                                                    <div class="flex items-center justify-between mt-2">
                                                                        <div class="flex flex-wrap gap-1">
                                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('response-frustrated', '{{issueType}}')">{{issueType}}</span>
                                                                        </div>
                                                                        <button onclick="previewResponse('response-frustrated')" class="text-purple-600 hover:text-purple-800 text-xs font-medium">
                                                                            <i class="fas fa-play mr-1"></i>Preview
                                                                        </button>
                                                                    </div>
                                                                </div>

                                                                <!-- Urgent Request -->
                                                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                                        <i class="fas fa-exclamation mr-2 text-orange-500"></i>Urgent Request
                                                                    </label>
                                                                    <textarea id="response-urgent" class="form-textarea w-full h-20 text-sm" placeholder="I can hear this is urgent for you. Let me prioritize your {{requestType}} and get this handled immediately.">I can hear this is urgent for you. Let me prioritize your {{requestType}} and get this handled immediately.</textarea>
                                                                    <div class="flex items-center justify-between mt-2">
                                                                        <div class="flex flex-wrap gap-1">
                                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('response-urgent', '{{requestType}}')">{{requestType}}</span>
                                                                        </div>
                                                                        <button onclick="previewResponse('response-urgent')" class="text-purple-600 hover:text-purple-800 text-xs font-medium">
                                                                            <i class="fas fa-play mr-1"></i>Preview
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="space-y-4">
                                                                <h6 class="text-md font-semibold text-purple-800 border-b border-purple-200 pb-2">
                                                                    <i class="fas fa-smile mr-2"></i>Positive Interactions
                                                                </h6>

                                                                <!-- Appreciation Response -->
                                                                <div class="bg-white p-4 rounded-lg border border-purple-100 shadow-sm">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                                        <i class="fas fa-thumbs-up mr-2 text-green-500"></i>Customer Appreciation
                                                                    </label>
                                                                    <textarea id="response-appreciation" class="form-textarea w-full h-20 text-sm" placeholder="You're so welcome! I'm really glad I could help you with {{serviceProvided}}. Is there anything else I can assist you with?">You're so welcome! I'm really glad I could help you with {{serviceProvided}}. Is there anything else I can assist you with?</textarea>
                                                                    <div class="flex items-center justify-between mt-2">
                                                                        <div class="flex flex-wrap gap-1">
                                                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 cursor-pointer" onclick="insertVariable('response-appreciation', '{{serviceProvided}}')">{{serviceProvided}}</span>
                                                                        </div>
                                                                        <button onclick="previewResponse('response-appreciation')" class="text-purple-600 hover:text-purple-800 text-xs font-medium">
                                                                            <i class="fas fa-play mr-1"></i>Preview
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Live Preview Panel -->
                                                    <div id="response-preview-panel" class="hidden mt-6 p-4 bg-white border border-purple-200 rounded-lg shadow-sm">
                                                        <div class="flex items-center justify-between mb-4">
                                                            <h6 class="text-md font-semibold text-purple-800">
                                                                <i class="fas fa-magic mr-2"></i>Live Response Preview
                                                            </h6>
                                                            <button onclick="toggleResponsePreview()" class="text-gray-400 hover:text-gray-600">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                                            <div>
                                                                <label class="block text-sm font-medium text-gray-700 mb-2">Original Template</label>
                                                                <div id="preview-original" class="p-3 bg-gray-50 border border-gray-200 rounded text-sm min-h-[60px]">
                                                                    Select a response to preview...
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <label class="block text-sm font-medium text-gray-700 mb-2">With Personality Applied</label>
                                                                <div id="preview-personalized" class="p-3 bg-purple-50 border border-purple-200 rounded text-sm min-h-[60px]">
                                                                    Personality-enhanced version will appear here...
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Response Actions -->
                                                    <div class="mt-6 pt-4 border-t border-purple-200 flex justify-between items-center">
                                                        <div class="flex items-center space-x-4">
                                                            <button type="button" onclick="importResponseTemplates()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">
                                                                <i class="fas fa-upload mr-2"></i>Import Templates
                                                            </button>
                                                            <button type="button" onclick="exportResponseTemplates()" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">
                                                                <i class="fas fa-download mr-2"></i>Export Templates
                                                            </button>
                                                        </div>
                                                        <div class="flex items-center space-x-3">
                                                            <span id="response-templates-saved" class="text-green-600 text-sm hidden">
                                                                <i class="fas fa-check-circle mr-1"></i>Templates Saved!
                                                            </span>
                                                            <button type="button" onclick="saveResponseTemplates()" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-6 rounded-md shadow-sm transition duration-150 ease-in-out">
                                                                <i class="fas fa-save mr-2"></i>Save Templates
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- ClientsVia Personality Status -->
                                                <div class="mt-6 p-4 bg-pink-50 border border-pink-200 rounded-lg">
                                                    <div class="flex items-center text-sm text-pink-800">
                                                        <i class="fas fa-theater-masks mr-2"></i>
                                                        <strong>ClientsVia Personality Status:</strong> Voice tone and behavioral settings configured. These apply to all conversation flows.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notepad Section -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gray-50 px-4 py-3 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800">
                                        <i class="fas fa-sticky-note mr-2 text-yellow-600"></i>Logic Notes
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Keep track of AI logic decisions, rules, and implementation notes</p>
                                </div>
                                
                                <div class="p-4">
                                    <!-- Add New Note Form -->
                                    <div class="mb-4 pb-4 border-b border-gray-200">
                                        <label for="new-logic-note" class="form-label">Add New Note</label>
                                        <textarea 
                                            id="new-logic-note" 
                                            class="form-textarea wider-textbox" 
                                            rows="3" 
                                            placeholder="Enter your AI logic note here..."
                                        ></textarea>
                                        <div class="mt-2 flex justify-end">
                                            <button 
                                                type="button" 
                                                onclick="addLogicNote()" 
                                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out"
                                            >
                                                <i class="fas fa-plus mr-2"></i>Add Note
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Notes List -->
                                    <div id="logic-notes-list" class="space-y-3">
                                        <p class="text-gray-500 italic text-center py-4">No notes yet. Add your first note above.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Booking Flow Config Section -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gradient-to-r from-blue-50 to-cyan-50 px-4 py-3 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-calendar-check mr-2 text-blue-600"></i>Booking Flow Configuration
                                        <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">Interactive</span>
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Configure the conversation flow for booking appointments with customers</p>
                                </div>
                                
                                <div class="p-4">
                                    <div class="mb-4">
                                        <div class="overflow-x-auto">
                                            <table id="booking-flow-table" class="min-w-full divide-y divide-gray-200 border border-gray-300 rounded-lg">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prompt</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Field Name</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="booking-flow-body" class="bg-white divide-y divide-gray-200">
                                                    <tr>
                                                        <td colspan="3" class="px-6 py-8 text-center text-gray-500">
                                                            <div class="flex flex-col items-center">
                                                                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                                                </svg>
                                                                <p class="text-sm text-gray-500">No booking fields configured yet.</p>
                                                                <p class="text-xs text-gray-400 mt-1">Add your first field above to get started.</p>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                        <div class="flex items-start space-x-3">
                                            <div class="flex-shrink-0">
                                                <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                                </svg>
                                            </div>
                                            <div class="flex-1">
                                                <h4 class="text-sm font-medium text-blue-800 mb-2">Add New Booking Field</h4>
                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                    <div class="md:col-span-2">
                                                        <label for="new-prompt" class="block text-xs font-medium text-blue-700 mb-1">
                                                            Customer Prompt
                                                        </label>
                                                        <input 
                                                            id="new-prompt" 
                                                            type="text"
                                                            placeholder="e.g., What's your address?" 
                                                            class="w-full px-3 py-2 border border-blue-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label for="new-name" class="block text-xs font-medium text-blue-700 mb-1">
                                                            Field Name
                                                        </label>
                                                        <input 
                                                            id="new-name" 
                                                            type="text"
                                                            placeholder="e.g., address" 
                                                            class="w-full px-3 py-2 border border-blue-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm font-mono"
                                                        />
                                                    </div>
                                                </div>
                                                <div class="mt-3 flex justify-end">
                                                    <button 
                                                        type="button"
                                                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200" 
                                                        onclick="addBookingField()"
                                                    >
                                                        <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                                        </svg>
                                                        Add Field
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                                        <div class="flex items-center text-sm text-gray-600">
                                            <svg class="mr-2 h-5 w-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                            </svg>
                                            These fields define the conversation flow for booking appointments
                                        </div>
                                        <div class="flex items-center space-x-3">
                                            <button 
                                                type="button"
                                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200" 
                                                onclick="saveBookingFlow()"
                                            >
                                                <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v6a2 2 0 002 2h2m0 0h2m0 0h2m0 0h2a2 2 0 002-2V9a2 2 0 00-2-2h-2m0 0V5a2 2 0 00-2-2H9a2 2 0 00-2 2v2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v2" />
                                                </svg>
                                                Save Booking Flow
                                            </button>
                                            <span id="booking-flow-saved" class="text-green-600 text-sm hidden flex items-center">
                                                <svg class="mr-1 h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                                </svg>
                                                Saved!
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ðŸš€ ENTERPRISE AI AGENT INTELLIGENCE CONTROL CENTER -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50 px-4 py-3 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-brain mr-2 text-indigo-600"></i>AI Intelligence Settings
                                        <span class="ml-2 px-2 py-1 bg-indigo-100 text-indigo-800 text-xs font-medium rounded-full">Enterprise</span>
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Complete control over AI agent behavior, thresholds, and decision making</p>
                                </div>
                                
                                <div class="p-6">
                                    <!-- Agent Intelligence Control Panel -->
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Left Column: Core AI Settings -->
                                        <div class="space-y-4">
                                            <h4 class="text-md font-semibold text-gray-700 border-b pb-2">
                                                <i class="fas fa-cogs mr-2 text-blue-600"></i>AI Core Configuration
                                            </h4>
                                            
                                            <!-- Trade Categories Selection -->
                                            <div class="space-y-3">
                                                <label class="form-label">
                                                    <i class="fas fa-briefcase mr-1 text-blue-600"></i>Trade Categories
                                                </label>
                                                <p class="text-xs text-gray-500 mb-3">Select the trade categories your AI agent should access for Q&A responses</p>
                                                
                                                <!-- Original Trade Categories Dropdown (for backward compatibility) -->
                                                <div>
                                                    <label for="agent-trade-categories" class="form-label">Trade Categories</label>
                                                    <select id="agent-trade-categories" multiple onchange="handleTradeCategoryChange()" class="form-select h-24 text-sm">
                                                        <!-- Options loaded dynamically -->
                                                    </select>
                                                    <p class="text-xs text-gray-500 mt-1">Controls which Q&A categories the agent can access</p>
                                                </div>
                                                
                                                <!-- Trade Categories Checkboxes Container -->
                                                <div id="trade-categories-checkboxes" class="bg-gray-50 border border-gray-200 rounded-lg p-4 max-h-48 overflow-y-auto">
                                                    <!-- Checkboxes will be populated dynamically -->
                                                    <div class="text-center text-gray-500">
                                                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading trade categories...
                                                    </div>
                                                </div>
                                                
                                                <!-- Selected Categories Display -->
                                                <div class="mt-3">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <span class="text-sm font-medium text-gray-700">Selected Categories:</span>
                                                        <span id="selected-categories-count" class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">0 selected</span>
                                                    </div>
                                                    <div id="selected-categories-list" class="bg-white border border-gray-200 rounded-lg p-3 min-h-[60px]">
                                                        <div class="text-gray-400 text-sm italic">No categories selected</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Language Selection -->
                                            <div>
                                                <label for="agent-language" class="form-label">
                                                    <i class="fas fa-globe mr-1 text-green-600"></i>Agent Language
                                                </label>
                                                <select id="agent-language" onchange="handleLanguageChange()" class="form-select">
                                                    <option value="en">ðŸ‡ºðŸ‡¸ English</option>
                                                    <option value="es">ðŸ‡ªðŸ‡¸ Spanish</option>
                                                    <option value="fr">ðŸ‡«ðŸ‡· French</option>
                                                    <option value="de">ðŸ‡©ðŸ‡ª German</option>
                                                    <option value="it">ðŸ‡®ðŸ‡¹ Italian</option>
                                                    <option value="pt">ðŸ‡§ðŸ‡· Portuguese</option>
                                                    <option value="ru">ðŸ‡·ðŸ‡º Russian</option>
                                                    <option value="zh">ðŸ‡¨ðŸ‡³ Chinese (Simplified)</option>
                                                    <option value="ja">ðŸ‡¯ðŸ‡µ Japanese</option>
                                                    <option value="ko">ðŸ‡°ðŸ‡· Korean</option>
                                                    <option value="ar">ðŸ‡¸ðŸ‡¦ Arabic</option>
                                                    <option value="hi">ðŸ‡®ðŸ‡³ Hindi</option>
                                                    <option value="nl">ðŸ‡³ðŸ‡± Dutch</option>
                                                    <option value="sv">ðŸ‡¸ðŸ‡ª Swedish</option>
                                                    <option value="da">ðŸ‡©ðŸ‡° Danish</option>
                                                    <option value="no">ðŸ‡³ðŸ‡´ Norwegian</option>
                                                    <option value="fi">ðŸ‡«ðŸ‡® Finnish</option>
                                                    <option value="pl">ðŸ‡µðŸ‡± Polish</option>
                                                    <option value="tr">ðŸ‡¹ðŸ‡· Turkish</option>
                                                    <option value="cs">ðŸ‡¨ðŸ‡¿ Czech</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">
                                                    Primary language for agent conversations, Q&A matching, and LLM responses
                                                </p>
                                                
                                                <!-- Language Feature Indicators -->
                                                <div class="mt-2 flex flex-wrap gap-1">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">
                                                        <i class="fas fa-brain mr-1"></i>LLM Support
                                                    </span>
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">
                                                        <i class="fas fa-microphone mr-1"></i>Voice Synthesis
                                                    </span>
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-purple-100 text-purple-800">
                                                        <i class="fas fa-search mr-1"></i>Q&A Matching
                                                    </span>
                                                </div>
                                            </div>

                                            <!-- LLM Toggle -->
                                            <div>
                                                <label class="form-label">Use Large Language Model (LLM)</label>
                                                <select id="agent-useLLM" class="form-select">
                                                    <option value="true">Yes - Enable AI reasoning</option>
                                                    <option value="false" selected>No - Use Knowledge Base Only</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">ðŸ”’ Salesforce approach: Curated knowledge first, LLM emergency only</p>
                                            </div>

                                            <!-- ðŸš€ ENHANCED LLM SELECTOR - Multi-Model Configuration -->
                                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                                                <h5 class="text-sm font-semibold text-gray-800 mb-3 flex items-center">
                                                    <i class="fas fa-microchip mr-2 text-blue-600"></i>LLM Model Configuration
                                                    <span class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">Multi-Model</span>
                                                </h5>
                                                
                                                <!-- Primary LLM Selection -->
                                                <div class="mb-4">
                                                    <label class="form-label text-sm">Primary LLM Model</label>
                                                    <select id="agent-primaryLLM" class="form-select">
                                                        <option value="gemini-pro" selected>Gemini Pro (Cloud, Balanced)</option>
                                                        <option value="openai-gpt4">OpenAI GPT-4 (Premium, Cloud)</option>
                                                        <option value="claude-3">Claude-3 (Premium, Cloud)</option>
                                                        <option value="none">None - Knowledge Base Only</option>
                                                    </select>
                                                    <p class="text-xs text-gray-500 mt-1">ï¿½ Cloud-based AI for intelligent responses</p>
                                                </div>

                                                <!-- Fallback LLM Selection -->
                                                <div class="mb-4">
                                                    <label class="form-label text-sm">Fallback LLM Model</label>
                                                    <select id="agent-fallbackLLM" class="form-select">
                                                        <option value="gemini-pro" selected>Gemini Pro (Cloud, Reliable)</option>
                                                        <option value="openai-gpt4">OpenAI GPT-4 (Premium, Cloud)</option>
                                                        <option value="claude-3">Claude-3 (Premium, Cloud)</option>
                                                        <option value="none">None - No Fallback</option>
                                                    </select>
                                                    <p class="text-xs text-gray-500 mt-1">ðŸ”’ Emergency backup - only when KB fails completely</p>
                                                </div>

                                                <!-- Allowed Models Multi-Select -->
                                                <div class="mb-4">
                                                    <label class="form-label text-sm flex items-center">
                                                        <i class="fas fa-shield-alt mr-2 text-green-600"></i>Allowed LLM Models
                                                    </label>
                                                    <div class="space-y-2 mt-2">
                                                        <label class="flex items-center p-2 bg-white rounded border border-gray-200 hover:bg-gray-50">
                                                            <input type="checkbox" id="llm-gemini-pro" class="form-checkbox h-4 w-4 text-blue-600" checked>
                                                            <div class="ml-3 flex-1">
                                                                <span class="text-sm font-medium">Gemini Pro</span>
                                                                <span class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">Cloud</span>
                                                                <p class="text-xs text-gray-500">ðŸ”’ Emergency fallback only</p>
                                                            </div>
                                                        </label>
                                                        
                                                        <label class="flex items-center p-2 bg-white rounded border border-gray-200 hover:bg-gray-50">
                                                            <input type="checkbox" id="llm-openai-gpt4" class="form-checkbox h-4 w-4 text-blue-600">
                                                            <div class="ml-3 flex-1">
                                                                <span class="text-sm font-medium">OpenAI GPT-4</span>
                                                                <span class="ml-2 px-2 py-0.5 bg-purple-100 text-purple-800 text-xs rounded">Premium</span>
                                                                <p class="text-xs text-gray-500">Most advanced reasoning</p>
                                                            </div>
                                                        </label>
                                                        
                                                        <label class="flex items-center p-2 bg-white rounded border border-gray-200 hover:bg-gray-50">
                                                            <input type="checkbox" id="llm-claude-3" class="form-checkbox h-4 w-4 text-blue-600">
                                                            <div class="ml-3 flex-1">
                                                                <span class="text-sm font-medium">Claude-3</span>
                                                                <span class="ml-2 px-2 py-0.5 bg-purple-100 text-purple-800 text-xs rounded">Premium</span>
                                                                <p class="text-xs text-gray-500">Anthropic's latest model</p>
                                                            </div>
                                                        </label>
                                                    </div>
                                                    <p class="text-xs text-gray-500 mt-2">ðŸ§  Salesforce approach: Knowledge Base priority, cloud AI emergency only</p>
                                                </div>

                                                <!-- Model Performance Stats -->
                                                <div class="mt-3 p-3 bg-green-50 rounded-lg border border-green-200">
                                                    <div class="flex items-center justify-between text-xs">
                                                        <span class="text-gray-600">ðŸ”’ Salesforce Mode:</span>
                                                        <span id="activeModelsCount" class="font-medium text-green-600">Knowledge Base Priority</span>
                                                    </div>
                                                    <div class="mt-1 text-xs text-gray-500">
                                                        <i class="fas fa-cloud mr-1 text-blue-500"></i>Cloud-native AI architecture
                                                        <i class="fas fa-shield-alt ml-3 mr-1 text-green-500"></i>Enterprise-grade reliability
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Memory Mode -->
                                            <div>
                                                <label class="form-label">Memory Mode</label>
                                                <select id="agent-memoryMode" class="form-select">
                                                    <option value="short">Short - Forget after response</option>
                                                    <option value="conversation">Conversation - Remember context</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">How much conversation history to retain</p>
                                            </div>
                                        </div>

                                        <!-- Right Column: Intelligence Thresholds -->
                                        <div class="space-y-4">
                                            <h4 class="text-md font-semibold text-gray-700 border-b pb-2">
                                                <i class="fas fa-sliders-h mr-2 text-green-600"></i>Intelligence Thresholds
                                            </h4>

                                            <!-- Confidence Threshold -->
                                            <div>
                                                <label class="form-label">Fallback Threshold (0-1)</label>
                                                <div class="flex items-center space-x-3">
                                                    <input type="range" id="agent-fallbackThreshold" class="flex-1" min="0" max="1" step="0.05" value="0.5">
                                                    <span id="fallback-threshold-value" class="text-sm font-medium text-gray-700 w-12">0.5</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Lower = more likely to escalate, Higher = more AI responses</p>
                                            </div>

                                            <!-- Escalation Mode -->
                                            <div>
                                                <label class="form-label">Escalation Strategy</label>
                                                <select id="agent-escalationMode" class="form-select">
                                                    <option value="ask">Ask - Confirm before escalating</option>
                                                    <option value="auto">Auto - Escalate immediately</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">How to handle low-confidence situations</p>
                                            </div>

                                            <!-- Re-prompt Settings -->
                                            <div>
                                                <label class="form-label">Re-prompt After Turns</label>
                                                <select id="agent-rePromptAfterTurns" class="form-select">
                                                    <option value="1">1 turn</option>
                                                    <option value="2">2 turns</option>
                                                    <option value="3">3 turns</option>
                                                    <option value="4">4 turns</option>
                                                    <option value="5">5 turns</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">When to ask clarifying questions</p>
                                            </div>

                                            <!-- Max Prompts -->
                                            <div>
                                                <label class="form-label">Max Prompts Per Call</label>
                                                <select id="agent-maxPromptsPerCall" class="form-select">
                                                    <option value="1">1 prompt</option>
                                                    <option value="2">2 prompts</option>
                                                    <option value="3">3 prompts</option>
                                                    <option value="4">4 prompts</option>
                                                    <option value="5">5 prompts</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">Maximum clarification attempts</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Advanced Features Row -->
                                    <div class="mt-6 pt-4 border-t border-gray-200">
                                        <h4 class="text-md font-semibold text-gray-700 mb-4">
                                            <i class="fas fa-star mr-2 text-yellow-600"></i>Advanced Features
                                        </h4>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <label class="flex items-center p-3 bg-blue-50 rounded-lg border border-blue-200">
                                                <input type="checkbox" id="agent-semanticSearchEnabled" class="form-checkbox">
                                                <div class="ml-3">
                                                    <span class="text-sm font-medium text-gray-900">Semantic Search</span>
                                                    <p class="text-xs text-gray-500">AI-powered question matching</p>
                                                </div>
                                            </label>

                                            <label class="flex items-center p-3 bg-green-50 rounded-lg border border-green-200">
                                                <input type="checkbox" id="agent-confidenceScoring" class="form-checkbox">
                                                <div class="ml-3">
                                                    <span class="text-sm font-medium text-gray-900">Confidence Scoring</span>
                                                    <p class="text-xs text-gray-500">Track response certainty</p>
                                                </div>
                                            </label>

                                            <label class="flex items-center p-3 bg-purple-50 rounded-lg border border-purple-200">
                                                <input type="checkbox" id="agent-autoLearningQueue" class="form-checkbox">
                                                <div class="ml-3">
                                                    <span class="text-sm font-medium text-gray-900">Auto Learning</span>
                                                    <p class="text-xs text-gray-500">Learn from conversations</p>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center">
                                        <div class="flex items-center space-x-4">
                                            <button type="button" onclick="testAgentConfiguration()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">
                                                <i class="fas fa-flask mr-2"></i>Test Configuration
                                            </button>
                                            <button type="button" onclick="resetToDefaults()" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">
                                                <i class="fas fa-undo mr-2"></i>Reset to Defaults
                                            </button>
                                        </div>
                                        <div class="flex items-center space-x-3">
                                            <span id="agent-settings-saved" class="text-green-600 text-sm hidden">
                                                <i class="fas fa-check-circle mr-1"></i>Settings Saved!
                                            </span>
                                            <button type="button" onclick="saveAgentSettings()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-md shadow-sm transition duration-150 ease-in-out">
                                                <i class="fas fa-save mr-2"></i>Save AI Settings
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Agent Performance Analytics -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gradient-to-r from-green-50 to-teal-50 px-4 py-3 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-chart-line mr-2 text-green-600"></i>Agent Performance Analytics
                                        <span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">Live Data</span>
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Monitor AI agent performance and optimization opportunities</p>
                                </div>
                                
                                <div class="p-6">
                                    <div id="agent-analytics-container">
                                        <p class="text-gray-500 text-center py-8">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading performance data...
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- ðŸ§ª AI AGENT TESTING CONSOLE + TRACE LOGS - Module 3: Testing & Debugging -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gradient-to-r from-orange-50 to-amber-50 px-4 py-3 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-flask mr-2 text-orange-600"></i>Testing Console + Trace Logs
                                        <span class="ml-2 px-2 py-1 bg-orange-100 text-orange-800 text-xs font-medium rounded-full">Module 3</span>
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Test AI agent responses in real-time with detailed trace logging and debugging</p>
                                </div>
                                
                                <div class="p-6">
                                    <!-- Testing Input Section -->
                                    <div class="mb-6">
                                        <div class="flex items-start space-x-4">
                                            <div class="flex-1">
                                                <label for="testMessage" class="form-label">Test Message</label>
                                                <textarea 
                                                    id="testMessage" 
                                                    class="form-textarea" 
                                                    rows="3" 
                                                    placeholder="Enter a test message to see how the AI agent responds..."
                                                ></textarea>
                                            </div>
                                            <div class="flex flex-col space-y-2 pt-6">
                                                <button 
                                                    type="button" 
                                                    onclick="runAgentTest()" 
                                                    id="testAgentBtn"
                                                    class="bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out"
                                                >
                                                    <i class="fas fa-play mr-2"></i>Test Agent
                                                </button>
                                                <button 
                                                    type="button" 
                                                    onclick="clearTestResults()" 
                                                    class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out"
                                                >
                                                    <i class="fas fa-trash mr-2"></i>Clear
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Test Results Section -->
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Agent Response -->
                                        <div class="space-y-4">
                                            <h4 class="text-md font-semibold text-gray-700 border-b pb-2">
                                                <i class="fas fa-robot mr-2 text-blue-600"></i>Agent Response
                                            </h4>
                                            
                                            <div id="agentResponse" class="bg-blue-50 border border-blue-200 rounded-lg p-4 min-h-32">
                                                <p class="text-gray-500 italic text-center py-4">No test run yet. Enter a message and click "Test Agent" to see the response.</p>
                                            </div>
                                            
                                            <!-- Response Metadata -->
                                            <div id="responseMetadata" class="hidden space-y-2">
                                                <div class="text-xs space-y-1">
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Response Time:</span>
                                                        <span id="responseTime" class="font-medium">-</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Confidence Score:</span>
                                                        <span id="confidenceScore" class="font-medium">-</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Knowledge Source:</span>
                                                        <span id="knowledgeSource" class="font-medium">-</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Trace Logs -->
                                        <div class="space-y-4">
                                            <h4 class="text-md font-semibold text-gray-700 border-b pb-2">
                                                <i class="fas fa-list-ul mr-2 text-green-600"></i>Trace Logs
                                            </h4>
                                            
                                            <div id="traceLogs" class="bg-gray-900 text-green-400 font-mono text-xs rounded-lg p-4 min-h-32 overflow-y-auto max-h-64">
                                                <div class="text-gray-400">No trace logs yet. Run a test to see detailed execution logs.</div>
                                            </div>
                                            
                                            <!-- Log Controls -->
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center space-x-2">
                                                    <input 
                                                        type="checkbox" 
                                                        id="autoScroll" 
                                                        checked 
                                                        class="form-checkbox h-4 w-4"
                                                    >
                                                    <label for="autoScroll" class="text-sm text-gray-600">Auto-scroll logs</label>
                                                </div>
                                                <button 
                                                    type="button" 
                                                    onclick="downloadTraceLogs()" 
                                                    class="text-xs bg-gray-600 hover:bg-gray-700 text-white py-1 px-2 rounded transition duration-150 ease-in-out"
                                                >
                                                    <i class="fas fa-download mr-1"></i>Download
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Test History -->
                                    <div class="mt-6 pt-4 border-t border-gray-200">
                                        <div class="flex items-center justify-between mb-4">
                                            <h4 class="text-md font-semibold text-gray-700">
                                                <i class="fas fa-history mr-2 text-purple-600"></i>Test History
                                            </h4>
                                            <button 
                                                type="button" 
                                                onclick="clearTestHistory()" 
                                                class="text-xs bg-purple-600 hover:bg-purple-700 text-white py-1 px-2 rounded transition duration-150 ease-in-out"
                                            >
                                                <i class="fas fa-trash mr-1"></i>Clear History
                                            </button>
                                        </div>
                                        
                                        <div id="testHistory" class="space-y-2 max-h-48 overflow-y-auto">
                                            <p class="text-gray-500 italic text-center py-4">No test history yet.</p>
                                        </div>
                                    </div>

                                    <!-- Quick Test Templates -->
                                    <div class="mt-6 pt-4 border-t border-gray-200">
                                        <h4 class="text-md font-semibold text-gray-700 mb-3">
                                            <i class="fas fa-rocket mr-2 text-indigo-600"></i>Quick Test Templates
                                        </h4>
                                        
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                            <button 
                                                type="button" 
                                                onclick="loadTestTemplate('greeting')"
                                                class="text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-800 py-2 px-3 rounded border border-indigo-300 transition duration-150 ease-in-out"
                                            >
                                                <i class="fas fa-hand-wave mr-1"></i>Greeting
                                            </button>
                                            <button 
                                                type="button" 
                                                onclick="loadTestTemplate('service_inquiry')"
                                                class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 py-2 px-3 rounded border border-blue-300 transition duration-150 ease-in-out"
                                            >
                                                <i class="fas fa-question-circle mr-1"></i>Service Inquiry
                                            </button>
                                            <button 
                                                type="button" 
                                                onclick="loadTestTemplate('booking_request')"
                                                class="text-xs bg-green-100 hover:bg-green-200 text-green-800 py-2 px-3 rounded border border-green-300 transition duration-150 ease-in-out"
                                            >
                                                <i class="fas fa-calendar mr-1"></i>Booking Request
                                            </button>
                                            <button 
                                                type="button" 
                                                onclick="loadTestTemplate('pricing_question')"
                                                class="text-xs bg-yellow-100 hover:bg-yellow-200 text-yellow-800 py-2 px-3 rounded border border-yellow-300 transition duration-150 ease-in-out"
                                            >
                                                <i class="fas fa-dollar-sign mr-1"></i>Pricing Question
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ðŸ“š SELF-LEARNING KNOWLEDGE BASE APPROVAL SYSTEM - Module 4: Learning & Approval -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gradient-to-r from-purple-50 to-pink-50 px-4 py-3 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-graduation-cap mr-2 text-purple-600"></i>Self-Learning Knowledge Base
                                        <span class="ml-2 px-2 py-1 bg-purple-100 text-purple-800 text-xs font-medium rounded-full">Module 4</span>
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Review and approve AI-generated Q&A pairs for continuous learning</p>
                                </div>
                                
                                <div class="p-6">
                                    <!-- Learning Controls Section -->
                                    <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                                        <h4 class="text-md font-semibold text-gray-700 mb-4 flex items-center">
                                            <i class="fas fa-cogs mr-2 text-blue-600"></i>Learning Controls
                                        </h4>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <!-- Auto Learning Toggle -->
                                            <div>
                                                <label class="form-label">Auto Learning</label>
                                                <select id="autoLearningEnabled" class="form-select">
                                                    <option value="true">Enabled - Capture new Q&As</option>
                                                    <option value="false">Disabled - No learning</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">Enable automatic capture of new questions</p>
                                            </div>

                                            <!-- Approval Mode -->
                                            <div>
                                                <label class="form-label">Approval Mode</label>
                                                <select id="learningApprovalMode" class="form-select">
                                                    <option value="manual">Manual - Admin approval required</option>
                                                    <option value="auto-high-confidence">Auto - High confidence only</option>
                                                    <option value="disabled">Disabled - No new Q&As</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">How to handle new Q&A pairs</p>
                                            </div>

                                            <!-- Confidence Threshold -->
                                            <div>
                                                <label class="form-label">Learning Confidence Threshold</label>
                                                <div class="flex items-center space-x-3">
                                                    <input type="range" id="learningConfidenceThreshold" class="flex-1" min="0.5" max="0.95" step="0.05" value="0.85">
                                                    <span id="learningThresholdValue" class="text-sm font-medium text-gray-700 w-12">0.85</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Minimum confidence to auto-approve (if enabled)</p>
                                            </div>

                                            <!-- Max Pending Limit -->
                                            <div>
                                                <label class="form-label">Max Pending Q&As</label>
                                                <select id="maxPendingQnAs" class="form-select">
                                                    <option value="50">50 items</option>
                                                    <option value="100">100 items</option>
                                                    <option value="200">200 items</option>
                                                    <option value="500">500 items</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">Maximum pending items before cleanup</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Pending Q&A Management -->
                                    <div class="mb-6">
                                        <div class="flex items-center justify-between mb-4">
                                            <h4 class="text-md font-semibold text-gray-700 flex items-center">
                                                <i class="fas fa-clock mr-2 text-orange-600"></i>Pending Q&A Approval
                                                <span id="pendingCount" class="ml-2 px-2 py-1 bg-orange-100 text-orange-800 text-xs font-medium rounded-full">0 pending</span>
                                            </h4>
                                            <div class="flex items-center space-x-2">
                                                <button 
                                                    type="button" 
                                                    onclick="refreshPendingQnAs()" 
                                                    class="text-sm bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded transition duration-150 ease-in-out"
                                                >
                                                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                                                </button>
                                                <button 
                                                    type="button" 
                                                    onclick="bulkApproveHighConfidence()" 
                                                    class="text-sm bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded transition duration-150 ease-in-out"
                                                >
                                                    <i class="fas fa-check-double mr-1"></i>Bulk Approve (85%+)
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Pending Q&A List -->
                                        <div id="pendingQnAList" class="space-y-3 max-h-96 overflow-y-auto">
                                            <div class="text-center py-8 text-gray-500">
                                                <i class="fas fa-inbox text-3xl mb-2"></i>
                                                <p>No pending Q&A pairs</p>
                                                <p class="text-xs">New questions will appear here for approval</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Learning Statistics -->
                                    <div class="mb-6 p-4 bg-gradient-to-r from-green-50 to-teal-50 rounded-lg border border-green-200">
                                        <h4 class="text-md font-semibold text-gray-700 mb-4 flex items-center">
                                            <i class="fas fa-chart-bar mr-2 text-green-600"></i>Learning Statistics
                                        </h4>
                                        
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <div class="text-center">
                                                <div id="totalApproved" class="text-2xl font-bold text-green-600">0</div>
                                                <div class="text-xs text-gray-500">Approved</div>
                                            </div>
                                            <div class="text-center">
                                                <div id="totalRejected" class="text-2xl font-bold text-red-600">0</div>
                                                <div class="text-xs text-gray-500">Rejected</div>
                                            </div>
                                            <div class="text-center">
                                                <div id="averageConfidence" class="text-2xl font-bold text-blue-600">0%</div>
                                                <div class="text-xs text-gray-500">Avg Confidence</div>
                                            </div>
                                            <div class="text-center">
                                                <div id="learningRate" class="text-2xl font-bold text-purple-600">0</div>
                                                <div class="text-xs text-gray-500">Per Day</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                                        <div class="flex items-center space-x-3">
                                            <button 
                                                type="button" 
                                                onclick="exportKnowledgeBase()" 
                                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out"
                                            >
                                                <i class="fas fa-download mr-2"></i>Export Knowledge Base
                                            </button>
                                            <button 
                                                type="button" 
                                                onclick="resetLearningStats()" 
                                                class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out"
                                            >
                                                <i class="fas fa-undo mr-2"></i>Reset Stats
                                            </button>
                                        </div>
                                        <div class="flex items-center space-x-3">
                                            <span id="learning-settings-saved" class="text-green-600 text-sm hidden">
                                                <i class="fas fa-check-circle mr-1"></i>Settings Saved!
                                            </span>
                                            <button 
                                                type="button" 
                                                onclick="saveLearningSettings()" 
                                                class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-6 rounded-md shadow-sm transition duration-150 ease-in-out"
                                            >
                                                <i class="fas fa-save mr-2"></i>Save Learning Settings
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </section>
                    </div>

                </div>
            </div>
        </div>
    </body>

    <script>
        // Global function to get current company ID
        function getCurrentCompanyId() {
            // First try to get from global variable
            if (window.currentCompanyId) {
                return window.currentCompanyId;
            }
            
            // Fallback: extract from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const companyId = urlParams.get('id');
            
            if (!companyId) {
                console.error('Company ID not found in URL or global variable');
                return null;
            }
            
            return companyId;
        }

        // Utility function to show notifications
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
            
            // Set colors based on type
            const colors = {
                success: 'bg-green-100 border border-green-400 text-green-700',
                error: 'bg-red-100 border border-red-400 text-red-700',
                warning: 'bg-yellow-100 border border-yellow-400 text-yellow-700',
                info: 'bg-blue-100 border border-blue-400 text-blue-700'
            };
            
            notification.className += ` ${colors[type] || colors.info}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="flex-1">${message}</span>
                    <button type="button" class="ml-3 text-sm opacity-70 hover:opacity-100" onclick="closeNotification(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 10);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
            
            console.log(`ðŸ“¢ Notification (${type}): ${message}`);
        }

        // ðŸŽ™ï¸ ELEVENLABS VOICE FUNCTIONS
        let availableVoices = [];
        
        // Test ElevenLabs API connection
        async function testElevenLabsConnection() {
            const companyId = getCurrentCompanyId();
            if (!companyId) {
                showNotification('Error: Company ID not found', 'error');
                return;
            }

            const button = document.getElementById('test-api-connection');
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Testing...';
                button.disabled = true;

                console.log('ðŸ”§ Testing ElevenLabs connection...');
                
                const response = await fetch(`/api/elevenlabs/companies/${companyId}/test-connection`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('âœ… ElevenLabs connection successful!', 'success');
                    console.log('âœ… Connection test passed:', result);
                    
                    // Optionally refresh voices after successful connection
                    setTimeout(() => refreshVoices(), 1000);
                } else {
                    throw new Error(result.message || 'Connection test failed');
                }
            } catch (error) {
                console.error('âŒ ElevenLabs connection test failed:', error);
                showNotification(`âŒ Connection failed: ${error.message}`, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Refresh available voices
        async function refreshVoices() {
            const companyId = getCurrentCompanyId();
            if (!companyId) {
                showNotification('Error: Company ID not found', 'error');
                return;
            }

            const button = document.getElementById('refresh-voices');
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Loading...';
                button.disabled = true;

                console.log('ðŸŽ™ï¸ Refreshing ElevenLabs voices...');
                
                const response = await fetch(`/api/elevenlabs/companies/${companyId}/voices`);
                const result = await response.json();

                if (result.success) {
                    availableVoices = result.voices || [];
                    
                    // Check for any voices with undefined voice_id
                    const invalidVoices = availableVoices.filter(voice => !voice.voice_id || voice.voice_id === 'undefined');
                    if (invalidVoices.length > 0) {
                        console.warn('âš ï¸ Found voices with invalid voice_id:', invalidVoices);
                    }
                    
                    populateVoiceSelector();
                    showNotification(`âœ… Loaded ${availableVoices.length} voices`, 'success');
                    console.log(`âœ… Loaded ${availableVoices.length} voices:`, availableVoices);
                } else {
                    throw new Error(result.message || 'Failed to load voices');
                }
            } catch (error) {
                console.error('âŒ Failed to refresh voices:', error);
                showNotification(`âŒ Failed to load voices: ${error.message}`, 'error');
                availableVoices = [];
                populateVoiceSelector();
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Populate voice selector dropdown
        function populateVoiceSelector() {
            const selector = document.getElementById('voice-selector');
            const refreshButton = document.getElementById('refresh-voices');
            
            if (!selector) return;

            // Clear existing options except the first one
            while (selector.children.length > 1) {
                selector.removeChild(selector.lastChild);
            }
            
            // Always ensure button is in correct state
            selector.disabled = false;
            if (refreshButton) {
                refreshButton.innerHTML = '<i class="fas fa-sync mr-1"></i>Refresh Voices';
                refreshButton.disabled = false;
                refreshButton.classList.remove('opacity-50');
                console.log('ðŸ”§ Refresh button state restored');
            }

            // Add voice options
            availableVoices.forEach((voice, index) => {
                // Debug voice structure for first few voices
                if (index < 3) {
                    console.log(`ðŸ” Voice ${index} structure:`, {
                        voice_id: voice.voice_id,
                        id: voice.id,
                        name: voice.name,
                        keys: Object.keys(voice)
                    });
                }
                
                // Skip voices with invalid voice_id
                if (!voice.voice_id || voice.voice_id === 'undefined' || voice.voice_id === undefined) {
                    console.warn(`âš ï¸ Skipping voice with invalid ID:`, voice);
                    return;
                }
                
                const option = document.createElement('option');
                option.value = voice.voice_id;
                option.textContent = `${voice.name} (${voice.labels?.gender || 'Unknown'})`;
                option.setAttribute('data-category', voice.labels?.category || '');
                option.setAttribute('data-gender', voice.labels?.gender || '');
                
                // Debug logging for voice options
                if (voice.name.toLowerCase().includes('mark') || index < 3) {
                    console.log(`ðŸŽ™ï¸ Voice option ${index}: ${voice.name} = ${voice.voice_id}`);
                }
                
                selector.appendChild(option);
            });

            // Check for company-specific saved voice ID first
            let savedVoiceId = null;
            
            // Method 1: Check data attribute first (set by setupElevenLabsConfig)
            if (selector.getAttribute('data-saved-voice-id')) {
                savedVoiceId = selector.getAttribute('data-saved-voice-id');
                console.log('ðŸŽ™ï¸ Found saved voice ID from data attribute:', savedVoiceId);
            } 
            
            // Method 2: Try to get saved voice ID from the global company profile manager
            if (!savedVoiceId && window.companyProfileManager && window.companyProfileManager.currentData) {
                const data = window.companyProfileManager.currentData;
                if (data.elevenLabsVoiceId) {
                    savedVoiceId = data.elevenLabsVoiceId;
                    console.log('ðŸŽ™ï¸ Found saved voice ID from elevenLabsVoiceId:', savedVoiceId);
                } else if (data.aiSettings?.elevenLabs?.voiceId) {
                    savedVoiceId = data.aiSettings.elevenLabs.voiceId;
                    console.log('ðŸŽ™ï¸ Found saved voice ID from aiSettings.elevenLabs.voiceId:', savedVoiceId);
                } else if (data.voiceSettings?.voiceId) {
                    savedVoiceId = data.voiceSettings.voiceId;
                    console.log('ðŸŽ™ï¸ Found saved voice ID from voiceSettings.voiceId:', savedVoiceId);
                }
            }
            
            console.log('ðŸ” Checking for saved voice during population:', {
                savedVoiceId: savedVoiceId,
                currentSelectorValue: selector.value,
                availableVoicesCount: availableVoices.length,
                dataAttribute: selector.getAttribute('data-saved-voice-id'),
                companyDataExists: !!(window.companyProfileManager && window.companyProfileManager.currentData)
            });
            
            // If we have a saved voice ID, try to select it
            if (savedVoiceId && savedVoiceId !== 'undefined' && availableVoices.length > 0) {
                const savedVoice = availableVoices.find(v => v.voice_id === savedVoiceId);
                if (savedVoice) {
                    selector.value = savedVoiceId;
                    console.log(`ðŸŽ¯ Restored saved voice: ${savedVoice.name} (${savedVoiceId})`);
                    
                    // Trigger the change event to show voice preview
                    setTimeout(() => {
                        console.log(`ðŸ” Pre-handleVoiceChange selector value (saved): "${selector.value}"`);
                        handleVoiceChange();
                    }, 150);
                } else {
                    console.log(`âš ï¸ Saved voice ID ${savedVoiceId} not found in available voices, will auto-select first voice`);
                    // Fall back to auto-selecting first voice
                    if (availableVoices.length > 0) {
                        const firstVoice = availableVoices[0];
                        selector.value = firstVoice.voice_id;
                        console.log(`ðŸŽ¯ Auto-selected first voice (fallback): ${firstVoice.name} (${firstVoice.voice_id})`);
                        setTimeout(() => {
                            handleVoiceChange();
                        }, 150);
                    }
                }
            } else if (availableVoices.length > 0 && (!selector.value || selector.value === 'undefined' || selector.value === '')) {
                // Auto-select the first voice if no saved voice and none is selected
                const firstVoice = availableVoices[0];
                
                // Set the value directly and verify it was set correctly
                selector.value = firstVoice.voice_id;
                
                if (selector.value === firstVoice.voice_id) {
                    console.log(`ðŸŽ¯ Auto-selected first voice (no saved voice): ${firstVoice.name} (${firstVoice.voice_id})`);
                    
                    // Trigger the change event to show voice preview (with a slight delay to ensure DOM is ready)
                    setTimeout(() => {
                        console.log(`ðŸ” Pre-handleVoiceChange selector value: "${selector.value}"`);
                        handleVoiceChange();
                    }, 150);
                } else {
                    console.error(`âŒ Failed to auto-select voice. Expected: ${firstVoice.voice_id}, Got: ${selector.value}`);
                }
            }

            console.log(`ðŸ“ Populated voice selector with ${availableVoices.length} voices`);
        }

        // Filter voices based on gender and category
        function filterVoices() {
            const genderFilter = document.getElementById('voice-gender-filter')?.value || '';
            const categoryFilter = document.getElementById('voice-category-filter')?.value || '';
            const selector = document.getElementById('voice-selector');
            
            if (!selector) return;

            // Show/hide options based on filters
            Array.from(selector.options).forEach((option, index) => {
                if (index === 0) return; // Skip the "Choose a voice..." option

                const optionGender = option.getAttribute('data-gender') || '';
                const optionCategory = option.getAttribute('data-category') || '';

                const genderMatch = !genderFilter || optionGender.toLowerCase() === genderFilter.toLowerCase();
                const categoryMatch = !categoryFilter || optionCategory.toLowerCase() === categoryFilter.toLowerCase();

                option.style.display = (genderMatch && categoryMatch) ? 'block' : 'none';
            });

            console.log(`ðŸ” Filtered voices by gender: ${genderFilter}, category: ${categoryFilter}`);
        }

        // Handle voice selection change
        function handleVoiceChange() {
            const selector = document.getElementById('voice-selector');
            
            if (!selector) {
                console.error('âŒ Voice selector not found in handleVoiceChange');
                return;
            }
            
            console.log(`ðŸ” handleVoiceChange called, selector value: "${selector.value}"`);
            
            // Safeguard: if selector value is 'undefined', try to fix it
            if (selector.value === 'undefined') {
                console.log('ðŸš¨ Detected undefined voice selector value, attempting to fix...');
                
                // Try to set it to the first valid option
                if (availableVoices && availableVoices.length > 0) {
                    const firstValidVoice = availableVoices[0];
                    console.log(`ðŸ”§ Setting to first available voice: ${firstValidVoice.name} (${firstValidVoice.voice_id})`);
                    selector.value = firstValidVoice.voice_id;
                    
                    // Verify the fix worked
                    if (selector.value !== firstValidVoice.voice_id) {
                        console.error(`âŒ Failed to fix selector value. Expected: ${firstValidVoice.voice_id}, Got: ${selector.value}`);
                        return;
                    }
                } else {
                    console.log('ðŸ”§ No voices available, setting to empty');
                    selector.value = '';
                }
            }
            
            const selectedVoice = availableVoices.find(v => v.voice_id === selector.value);
            const previewSection = document.getElementById('voice-preview-section');
            const voiceInfo = document.getElementById('voice-info');
            const refreshButton = document.getElementById('refresh-voices');
            
            // Ensure refresh button is not stuck in loading state
            if (refreshButton && refreshButton.innerHTML.includes('Loading')) {
                refreshButton.innerHTML = '<i class="fas fa-sync mr-1"></i>Refresh Voices';
                refreshButton.disabled = false;
                console.log('ðŸ”§ Fixed stuck loading state on refresh button');
            }
            
            if (selectedVoice) {
                console.log('ðŸŽ™ï¸ Selected voice:', selectedVoice.name, 'ID:', selectedVoice.voice_id);
                
                // Show the preview section
                previewSection.classList.remove('hidden');
                
                // Populate voice information
                voiceInfo.innerHTML = `
                    <div class="text-sm">
                        <div class="font-medium text-gray-900 mb-1">${selectedVoice.name}</div>
                        <div class="text-gray-600 mb-2">${selectedVoice.labels?.description || 'No description available'}</div>
                        <div class="flex items-center space-x-4 text-xs text-gray-500">
                            ${selectedVoice.labels?.gender ? `<span><i class="fas fa-user mr-1"></i>${selectedVoice.labels.gender}</span>` : ''}
                            ${selectedVoice.labels?.age ? `<span><i class="fas fa-calendar mr-1"></i>${selectedVoice.labels.age}</span>` : ''}
                            ${selectedVoice.labels?.category ? `<span><i class="fas fa-tag mr-1"></i>${selectedVoice.labels.category}</span>` : ''}
                        </div>
                    </div>
                `;
                
                // Show voice sample preview if available
                if (selectedVoice.preview_url) {
                    const audioElement = document.getElementById('voice-preview-audio');
                    audioElement.src = selectedVoice.preview_url;
                    audioElement.classList.remove('hidden');
                }
                
                // Trigger form change detection (with a delay to prevent race conditions)
                setTimeout(() => {
                    if (typeof window.handleFormChange === 'function') {
                        console.log('ðŸ”„ Triggering form change detection from handleVoiceChange');
                        window.handleFormChange();
                    }
                }, 200);
            } else {
                // Hide the preview section if no voice selected
                previewSection.classList.add('hidden');
                voiceInfo.innerHTML = '';
                console.log('â„¹ï¸ No voice selected or voice not found');
            }
        }

        // Force reset button states (utility function)
        function resetButtonStates() {
            const refreshButton = document.getElementById('refresh-voices');
            if (refreshButton) {
                refreshButton.innerHTML = '<i class="fas fa-sync mr-1"></i>Refresh Voices';
                refreshButton.disabled = false;
                refreshButton.classList.remove('opacity-50');
                console.log('ðŸ”§ Force reset refresh button state');
            }
        }

        // Toggle between ClientsVia global API and company's own API
        function toggleApiKeySource() {
            const checkbox = document.getElementById('useOwnApiKey');
            const apiKeyInput = document.getElementById('elevenlabsApiKey');
            const globalInfo = document.getElementById('global-api-info');
            const ownInfo = document.getElementById('own-api-info');
            const subscriptionInfo = document.getElementById('subscription-info');
            const apiSourceDescription = document.getElementById('api-source-description');
            const toggleLabel = document.getElementById('toggle-label');
            
            if (checkbox.checked) {
                // Switch to own API mode
                apiKeyInput.disabled = false;
                apiKeyInput.required = true;
                globalInfo.classList.add('hidden');
                ownInfo.classList.remove('hidden');
                subscriptionInfo.classList.remove('hidden');
                apiSourceDescription.textContent = 'Using your own ElevenLabs API account';
                toggleLabel.textContent = 'Use ClientsVia API';
                
                console.log('ðŸ”„ Switched to own API mode');
            } else {
                // Switch to global API mode
                apiKeyInput.disabled = true;
                apiKeyInput.required = false;
                apiKeyInput.value = ''; // Clear the field
                globalInfo.classList.remove('hidden');
                ownInfo.classList.add('hidden');
                subscriptionInfo.classList.add('hidden');
                apiSourceDescription.textContent = 'Using ClientsVia global API (default for all companies)';
                toggleLabel.textContent = 'Use Own API';
                
                console.log('ðŸ”„ Switched to ClientsVia global API mode');
            }
            
            // Trigger form change detection
            if (typeof window.handleFormChange === 'function') {
                window.handleFormChange();
            }
        }

        // Generate test audio
        async function generateTestAudio() {
            const companyId = getCurrentCompanyId();
            const testText = document.getElementById('test-text')?.value;
            const voiceId = document.getElementById('voice-selector')?.value;
            const testResultsDiv = document.getElementById('test-results');
            
            if (!companyId) {
                showNotification('Error: Company ID not found', 'error');
                return;
            }
            
            if (!testText?.trim()) {
                showNotification('Please enter test text', 'error');
                return;
            }
            
            if (!voiceId || voiceId === 'undefined' || voiceId === '') {
                showNotification('Please select a voice first', 'error');
                return;
            }

            const button = document.getElementById('test-voice-btn');
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
                button.disabled = true;

                console.log('ðŸŽµ Generating test audio...', { voiceId, textLength: testText.length });
                
                const response = await fetch('/api/elevenlabs/synthesize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: testText.trim(),
                        voiceId: voiceId,
                        companyId: companyId // Pass company ID for API selection
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Create audio element and play
                    const audioData = `data:audio/mp3;base64,${result.audioContent}`;
                    const audio = new Audio(audioData);
                    
                    testResultsDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-volume-up text-green-600"></i>
                                <span class="text-sm font-medium">Audio generated successfully!</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button type="button" onclick="playTestAudio()" 
                                        class="text-sm bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded">
                                    <i class="fas fa-play mr-1"></i>Play
                                </button>
                                <button type="button" onclick="downloadAudio('${audioData}', 'test-voice.mp3')" 
                                        class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded">
                                    <i class="fas fa-download mr-1"></i>Download
                                </button>
                            </div>
                            <audio id="testAudio" controls class="hidden" src="${audioData}"></audio>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">
                            Size: ${(result.size / 1024).toFixed(1)} KB | Format: ${result.format || 'mp3'}
                        </div>
                    `;
                    
                    // Auto-play the audio
                    audio.play().catch(e => console.log('Auto-play blocked:', e));
                    
                    showNotification('âœ… Test audio generated successfully!', 'success');
                    console.log('âœ… Audio generated:', result);
                } else {
                    throw new Error(result.message || 'Failed to generate audio');
                }
            } catch (error) {
                console.error('âŒ Failed to generate test audio:', error);
                testResultsDiv.innerHTML = `
                    <div class="flex items-center space-x-3 text-red-600">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span class="text-sm">Failed to generate audio: ${error.message}</span>
                    </div>
                `;
                showNotification(`âŒ Failed to generate audio: ${error.message}`, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Stream test audio
        async function streamTestAudio() {
            const companyId = getCurrentCompanyId();
            const testText = document.getElementById('test-text')?.value;
            const voiceId = document.getElementById('voice-selector')?.value;
            const testResultsDiv = document.getElementById('test-results');
            
            if (!companyId) {
                showNotification('Error: Company ID not found', 'error');
                return;
            }
            
            if (!testText?.trim()) {
                showNotification('Please enter test text', 'error');
                return;
            }
            
            if (!voiceId || voiceId === 'undefined' || voiceId === '') {
                showNotification('Please select a voice first', 'error');
                return;
            }

            const button = document.getElementById('stream-test-btn');
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Streaming...';
                button.disabled = true;

                console.log('ðŸŒŠ Starting audio stream test...', { voiceId, textLength: testText.length });
                
                testResultsDiv.innerHTML = `
                    <div class="flex items-center space-x-3 text-blue-600">
                        <i class="fas fa-broadcast-tower animate-pulse"></i>
                        <span class="text-sm">Streaming audio...</span>
                    </div>
                `;

                const response = await fetch('/api/elevenlabs/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: testText.trim(),
                        voiceId: voiceId,
                        companyId: companyId
                    })
                });

                if (response.ok) {
                    // For stream, we'll show success message
                    testResultsDiv.innerHTML = `
                        <div class="flex items-center space-x-3 text-green-600">
                            <i class="fas fa-check-circle"></i>
                            <span class="text-sm">Stream test completed successfully!</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">
                            Streaming functionality is working properly.
                        </div>
                    `;
                    
                    showNotification('âœ… Stream test completed!', 'success');
                    console.log('âœ… Stream test completed');
                } else {
                    throw new Error('Stream test failed');
                }
            } catch (error) {
                console.error('âŒ Failed to stream test audio:', error);
                testResultsDiv.innerHTML = `
                    <div class="flex items-center space-x-3 text-red-600">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span class="text-sm">Stream test failed: ${error.message}</span>
                    </div>
                `;
                showNotification(`âŒ Stream test failed: ${error.message}`, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Close notification utility
        function closeNotification(button) {
            const notification = button.parentElement.parentElement;
            if (notification) {
                notification.remove();
            }
        }

        // Play test audio utility
        function playTestAudio() {
            const audioElement = document.getElementById('testAudio');
            if (audioElement) {
                audioElement.play().catch(e => {
                    console.error('Failed to play test audio:', e);
                    showNotification('âš ï¸ Could not play audio', 'error');
                });
            } else {
                console.error('Test audio element not found');
                showNotification('âš ï¸ Audio element not found', 'error');
            }
        }

        // Download audio utility
        function downloadAudio(audioData, filename) {
            const link = document.createElement('a');
            link.href = audioData;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            console.log('ðŸ“¥ Audio download initiated:', filename);
        }

        // Play voice sample
        function playVoiceSample() {
            const audioElement = document.getElementById('voice-preview-audio');
            const selector = document.getElementById('voice-selector');
            const selectedVoice = availableVoices.find(v => v.voice_id === selector.value);
            
            if (!selectedVoice) {
                showNotification('Please select a voice first', 'error');
                return;
            }
            
            if (selectedVoice.preview_url && audioElement) {
                audioElement.src = selectedVoice.preview_url;
                audioElement.play().catch(error => {
                    console.error('Failed to play voice sample:', error);
                    showNotification('Failed to play voice sample', 'error');
                });
                console.log('ðŸ”Š Playing voice sample for:', selectedVoice.name);
            } else {
                // Generate a quick sample using the selected voice
                generateVoiceSample(selectedVoice.voice_id, selectedVoice.name);
            }
        }

        // Generate a quick voice sample
        async function generateVoiceSample(voiceId, voiceName) {
            const companyId = getCurrentCompanyId();
            const sampleText = "Hello! This is a sample of how I sound. Thank you for listening.";
            
            try {
                console.log('ðŸŽµ Generating voice sample for:', voiceName);
                
                const response = await fetch('/api/elevenlabs/synthesize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: sampleText,
                        voiceId: voiceId,
                        companyId: companyId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const audioData = `data:audio/mp3;base64,${result.audioContent}`;
                    const audioElement = document.getElementById('voice-preview-audio');
                    audioElement.src = audioData;
                    audioElement.play();
                    
                    console.log('âœ… Voice sample generated and playing');
                    showNotification(`ðŸ”Š Playing sample of ${voiceName}`, 'success');
                } else {
                    throw new Error(result.message || 'Failed to generate sample');
                }
            } catch (error) {
                console.error('âŒ Failed to generate voice sample:', error);
                showNotification(`âŒ Failed to generate voice sample: ${error.message}`, 'error');
            }
        }

        // Initialize ElevenLabs event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Test API Connection button
            const testButton = document.getElementById('test-api-connection');
            if (testButton) {
                testButton.addEventListener('click', testElevenLabsConnection);
                console.log('âœ… Test API Connection button listener attached');
            }

            // Refresh Voices button
            const refreshButton = document.getElementById('refresh-voices');
            if (refreshButton) {
                refreshButton.addEventListener('click', refreshVoices);
                console.log('âœ… Refresh Voices button listener attached');
            }

            // Voice filter dropdowns
            const genderFilter = document.getElementById('voice-gender-filter');
            const categoryFilter = document.getElementById('voice-category-filter');
            
            if (genderFilter) {
                genderFilter.addEventListener('change', filterVoices);
                console.log('âœ… Gender filter listener attached');
            }
            
            if (categoryFilter) {
                categoryFilter.addEventListener('change', filterVoices);
                console.log('âœ… Category filter listener attached');
            }

            // Voice selector
            const voiceSelector = document.getElementById('voice-selector');
            if (voiceSelector) {
                voiceSelector.addEventListener('change', handleVoiceChange);
                console.log('âœ… Voice selector listener attached');
            }

            // API Key toggle
            const apiToggle = document.getElementById('useOwnApiKey');
            if (apiToggle) {
                apiToggle.addEventListener('change', toggleApiKeySource);
                console.log('âœ… API key toggle listener attached');
            }

            // Test voice button
            const testVoiceBtn = document.getElementById('test-voice-btn');
            if (testVoiceBtn) {
                testVoiceBtn.addEventListener('click', generateTestAudio);
                console.log('âœ… Test voice button listener attached');
            }

            // Stream test button
            const streamTestBtn = document.getElementById('stream-test-btn');
            if (streamTestBtn) {
                streamTestBtn.addEventListener('click', streamTestAudio);
                console.log('âœ… Stream test button listener attached');
            }

            // Play voice sample button
            const playSampleBtn = document.getElementById('play-voice-sample');
            if (playSampleBtn) {
                playSampleBtn.addEventListener('click', playVoiceSample);
                console.log('âœ… Play voice sample button listener attached');
            }

            // Auto-load voices when page loads
            setTimeout(() => {
                if (document.getElementById('voice-selector')) {
                    console.log('ðŸŽ™ï¸ Auto-loading voices on page load...');
                    
                    // Reset any stuck button states first
                    resetButtonStates();
                    
                    // Show loading state
                    const voiceSelector = document.getElementById('voice-selector');
                    const refreshButton = document.getElementById('refresh-voices');
                    
                    if (voiceSelector && voiceSelector.children.length <= 1) {
                        // Only has the default "Choose a voice..." option
                        const loadingOption = document.createElement('option');
                        loadingOption.value = '';
                        loadingOption.textContent = 'Loading voices...';
                        voiceSelector.appendChild(loadingOption);
                        voiceSelector.disabled = true;
                        
                        if (refreshButton) {
                            refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Loading...';
                            refreshButton.disabled = true;
                        }
                    }
                    
                    refreshVoices();
                    
                    // Debug: Setup voice selector value tracking
                    setTimeout(() => {
                        const selector = document.getElementById('voice-selector');
                        if (selector) {
                            let lastValue = selector.value;
                            
                            // Track property changes
                            const checkValue = () => {
                                if (selector.value !== lastValue) {
                                    console.log(`ðŸ” Voice selector value changed: "${lastValue}" -> "${selector.value}"`);
                                    console.trace('Voice selector change stack trace:');
                                    lastValue = selector.value;
                                }
                            };
                            
                            // Check periodically
                            setInterval(checkValue, 100);
                            
                            // Track events
                            selector.addEventListener('change', () => {
                                console.log(`ðŸ” Voice selector change event: value = "${selector.value}"`);
                            });
                        }
                    }, 2000);
                } else {
                    console.warn('âš ï¸ Voice selector not found on page load');
                }
            }, 1000);
            
            // Debug: Log all available elements for troubleshooting
            console.log('ðŸ” ElevenLabs UI Elements Check:');
            console.log('  - Test API Connection button:', !!document.getElementById('test-api-connection'));
            console.log('  - Refresh Voices button:', !!document.getElementById('refresh-voices')); 
            console.log('  - Voice selector:', !!document.getElementById('voice-selector'));
            console.log('  - API Key toggle:', !!document.getElementById('useOwnApiKey'));
            console.log('  - API Key input:', !!document.getElementById('elevenlabsApiKey'));
            console.log('  - Test voice button:', !!document.getElementById('test-voice-btn'));
            console.log('  - Stream test button:', !!document.getElementById('stream-test-btn'));
            console.log('  - Test text input:', !!document.getElementById('test-text'));
            console.log('  - Test results div:', !!document.getElementById('test-results'));
        });

        // ðŸš€ ENTERPRISE AI AGENT FUNCTIONS
        
        // Load trade categories for agent configuration
        async function loadAgentTradeCategories() {
            try {
                // Use the GLOBAL trade categories endpoint
                const response = await fetch('/api/trade-categories/');
                const categories = await response.json();
                
                // Populate the original dropdown (for compatibility)
                const selector = document.getElementById('agent-trade-categories');
                selector.innerHTML = '';
                
                // Populate the new checkboxes container
                const checkboxContainer = document.getElementById('trade-categories-checkboxes');
                checkboxContainer.innerHTML = '';
                
                categories.forEach(category => {
                    // Add to dropdown
                    const option = document.createElement('option');
                    option.value = category.name;
                    const qaCount = category.commonQAs ? category.commonQAs.length : 0;
                    option.textContent = `${category.name} (${qaCount} Q&As)`;
                    selector.appendChild(option);
                    
                    // Add to checkboxes
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center space-x-3 p-2 hover:bg-gray-100 rounded';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" 
                               id="trade-cat-${category.name}" 
                               value="${category.name}" 
                               onchange="handleTradeCheckboxChange()"
                               class="form-checkbox h-4 w-4 text-blue-600">
                        <label for="trade-cat-${category.name}" class="flex-1 text-sm text-gray-700 cursor-pointer">
                            ${category.name} <span class="text-gray-500">(${qaCount} Q&As)</span>
                        </label>
                    `;
                    checkboxContainer.appendChild(checkboxDiv);
                });
                
                console.log('âœ… Global trade categories loaded for agent configuration (dropdown + checkboxes)');
            } catch (error) {
                console.error('âŒ Failed to load trade categories:', error);
                // Show error in checkboxes container
                const checkboxContainer = document.getElementById('trade-categories-checkboxes');
                if (checkboxContainer) {
                    checkboxContainer.innerHTML = '<div class="text-center text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Failed to load categories</div>';
                }
            }
        }

        // Handle trade category selection change
        function handleTradeCategoryChange() {
            const selector = document.getElementById('agent-trade-categories');
            if (!selector) return;
            
            const selectedCategories = Array.from(selector.selectedOptions).map(option => option.value);
            console.log('ðŸ”„ Trade categories selection changed:', selectedCategories);
            
            // Update any related UI or trigger save
            // This function maintains compatibility with the original system
        }

        // Handle checkbox change for trade categories
        function handleTradeCheckboxChange() {
            const checkboxes = document.querySelectorAll('#trade-categories-checkboxes input[type="checkbox"]');
            const selectedCategories = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            console.log('ðŸ”„ Trade categories checkbox selection changed:', selectedCategories);
            
            // Update the selected categories display
            updateSelectedCategoriesDisplay(selectedCategories);
            
            // Sync with dropdown for compatibility
            const dropdown = document.getElementById('agent-trade-categories');
            if (dropdown) {
                Array.from(dropdown.options).forEach(option => {
                    option.selected = selectedCategories.includes(option.value);
                });
            }
        }

        // Update the selected categories display
        function updateSelectedCategoriesDisplay(selectedCategories) {
            const countElement = document.getElementById('selected-categories-count');
            const listElement = document.getElementById('selected-categories-list');
            
            if (countElement) {
                countElement.textContent = `${selectedCategories.length} selected`;
            }
            
            if (listElement) {
                if (selectedCategories.length === 0) {
                    listElement.innerHTML = '<div class="text-gray-400 text-sm italic">No categories selected</div>';
                } else {
                    const categoriesHTML = selectedCategories.map(category => 
                        `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mr-2 mb-2">
                            ${category}
                        </span>`
                    ).join('');
                    listElement.innerHTML = categoriesHTML;
                }
            }
        }

        // Load current agent settings
        async function loadAgentSettings() {
            const companyId = getCurrentCompanyId();
            if (!companyId) return;

            try {
                const response = await fetch(`/api/agent/companies/${companyId}/agent-settings`);
                const data = await response.json();
                
                // Populate trade categories
                const tradeSelector = document.getElementById('agent-trade-categories');
                const selectedTrades = data.tradeCategories || [];
                
                // Update dropdown selections
                Array.from(tradeSelector.options).forEach(option => {
                    option.selected = selectedTrades.includes(option.value);
                });

                // Update checkbox selections
                const checkboxes = document.querySelectorAll('#trade-categories-checkboxes input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectedTrades.includes(checkbox.value);
                });

                // Update the selected categories display
                updateSelectedCategoriesDisplay(selectedTrades);

                // Populate agent settings with safety checks
                const settings = data.agentSettings || {};
                
                // Helper function to safely set element values
                const safeSetValue = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = value;
                    } else {
                        // Only warn for critical elements, others are optional
                        if (!['agent-llmModel'].includes(id)) {
                            console.warn(`âš ï¸ Element not found: ${id}`);
                        }
                    }
                };
                
                const safeSetChecked = (id, checked) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.checked = checked;
                    } else {
                        console.warn(`âš ï¸ Element not found: ${id}`);
                    }
                };
                
                // Set values safely
                safeSetValue('agent-useLLM', settings.useLLM !== false ? 'true' : 'false');
                safeSetValue('agent-llmModel', settings.llmModel || 'gemini-pro');
                safeSetValue('agent-memoryMode', settings.memoryMode || 'short');
                safeSetValue('agent-escalationMode', settings.escalationMode || 'ask');
                safeSetValue('agent-rePromptAfterTurns', settings.rePromptAfterTurns || 3);
                safeSetValue('agent-maxPromptsPerCall', settings.maxPromptsPerCall || 2);
                
                // Fallback threshold slider with safety checks
                const thresholdSlider = document.getElementById('agent-fallbackThreshold');
                const thresholdValue = document.getElementById('fallback-threshold-value');
                if (thresholdSlider && thresholdValue) {
                    thresholdSlider.value = settings.fallbackThreshold || 0.5;
                    thresholdValue.textContent = thresholdSlider.value;
                } else {
                    console.warn('âš ï¸ Threshold slider elements not found');
                }
                
                // Advanced features with safety checks
                safeSetChecked('agent-semanticSearchEnabled', settings.semanticSearchEnabled !== false);
                safeSetChecked('agent-confidenceScoring', settings.confidenceScoring !== false);
                safeSetChecked('agent-autoLearningQueue', settings.autoLearningQueue !== false);
                
                console.log('âœ… Agent settings loaded successfully');
                
            } catch (error) {
                console.error('âŒ Failed to load agent settings:', error);
                alert('Failed to load agent settings. Please refresh the page.');
            }
        }

        // Save agent settings
        async function saveAgentSettings() {
            const companyId = getCurrentCompanyId();
            if (!companyId) {
                alert('Company ID not found. Please refresh the page.');
                return;
            }

            try {
                // Collect trade categories from checkboxes
                const checkboxes = document.querySelectorAll('#trade-categories-checkboxes input[type="checkbox"]:checked');
                const tradeCategories = Array.from(checkboxes).map(checkbox => checkbox.value);

                // Helper function to safely get element values
                const safeGetValue = (id, defaultValue = '') => {
                    const element = document.getElementById(id);
                    if (element) {
                        return element.value;
                    } else {
                        console.warn(`âš ï¸ Element not found during save: ${id}, using default: ${defaultValue}`);
                        return defaultValue;
                    }
                };
                
                const safeGetChecked = (id, defaultValue = false) => {
                    const element = document.getElementById(id);
                    if (element) {
                        return element.checked;
                    } else {
                        console.warn(`âš ï¸ Element not found during save: ${id}, using default: ${defaultValue}`);
                        return defaultValue;
                    }
                };

                // Collect agent settings safely
                const agentSettings = {
                    useLLM: safeGetValue('agent-useLLM') === 'true',
                    llmModel: safeGetValue('agent-llmModel', 'gemini-pro'),
                    memoryMode: safeGetValue('agent-memoryMode', 'short'),
                    fallbackThreshold: parseFloat(safeGetValue('agent-fallbackThreshold', '0.5')),
                    escalationMode: safeGetValue('agent-escalationMode', 'ask'),
                    rePromptAfterTurns: parseInt(safeGetValue('agent-rePromptAfterTurns', '3')),
                    maxPromptsPerCall: parseInt(safeGetValue('agent-maxPromptsPerCall', '2')),
                    semanticSearchEnabled: safeGetChecked('agent-semanticSearchEnabled', true),
                    confidenceScoring: safeGetChecked('agent-confidenceScoring', true),
                    autoLearningQueue: safeGetChecked('agent-autoLearningQueue', true)
                };

                const response = await fetch(`/api/agent/companies/${companyId}/agent-settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tradeCategories, agentSettings })
                });

                if (response.ok) {
                    const savedIndicator = document.getElementById('agent-settings-saved');
                    savedIndicator.classList.remove('hidden');
                    setTimeout(() => savedIndicator.classList.add('hidden'), 3000);
                    console.log('âœ… Agent settings saved successfully');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save settings');
                }

            } catch (error) {
                console.error('âŒ Failed to save agent settings:', error);
                alert(`Failed to save agent settings: ${error.message}`);
            }
        }

        // Test agent configuration
        async function testAgentConfiguration() {
            const companyId = getCurrentCompanyId();
            if (!companyId) return;

            const testMessage = prompt('Enter a test message for the AI agent:', 'What are your business hours?');
            if (!testMessage) return;

            try {
                const response = await fetch(`/api/agent/companies/${companyId}/test-agent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ testMessage })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(`Test Results:\n\nMessage: ${result.message}\nUsed LLM: ${result.usedLLM}\nModel: ${result.model}\nConfidence: ${(result.confidence * 100).toFixed(1)}%\nResponse Time: ${result.responseTime.toFixed(2)}s\nEscalation: ${result.escalationTriggered ? 'Yes' : 'No'}`);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('âŒ Agent test failed:', error);
                alert(`Test failed: ${error.message}`);
            }
        }

        // Reset to default settings
        function resetToDefaults() {
            if (!confirm('Reset all AI agent settings to defaults? This cannot be undone.')) return;

            // Reset form to defaults
            document.getElementById('agent-useLLM').value = 'true';
            document.getElementById('agent-llmModel').value = 'gemini-pro';
            document.getElementById('agent-memoryMode').value = 'short';
            document.getElementById('agent-escalationMode').value = 'ask';
            document.getElementById('agent-rePromptAfterTurns').value = '3';
            document.getElementById('agent-maxPromptsPerCall').value = '2';
            
            const thresholdSlider = document.getElementById('agent-fallbackThreshold');
            const thresholdValue = document.getElementById('fallback-threshold-value');
            thresholdSlider.value = '0.5';
            thresholdValue.textContent = '0.5';
            
            document.getElementById('agent-semanticSearchEnabled').checked = true;
            document.getElementById('agent-confidenceScoring').checked = true;
            document.getElementById('agent-autoLearningQueue').checked = true;
            
            // Clear trade category selection
            const tradeSelector = document.getElementById('agent-trade-categories');
            Array.from(tradeSelector.options).forEach(option => option.selected = false);
            
            console.log('âœ… Agent settings reset to defaults');
        }

        // Load agent analytics
        async function loadAgentAnalytics() {
            const companyId = getCurrentCompanyId();
            if (!companyId) return;

            try {
                const response = await fetch(`/api/agent/companies/${companyId}/agent-analytics?days=7`);
                const analytics = await response.json();
                
                const container = document.getElementById('agent-analytics-container');
                container.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600">${analytics.metrics.totalInteractions}</div>
                            <div class="text-sm text-gray-600">Total Interactions</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600">${(analytics.metrics.averageConfidence * 100).toFixed(1)}%</div>
                            <div class="text-sm text-gray-600">Avg Confidence</div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-yellow-600">${(analytics.metrics.escalationRate * 100).toFixed(1)}%</div>
                            <div class="text-sm text-gray-600">Escalation Rate</div>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-600">${analytics.metrics.responseTime.toFixed(1)}s</div>
                            <div class="text-sm text-gray-600">Avg Response Time</div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-700 mb-2">Top Questions (Last 7 Days)</h4>
                        <div class="space-y-2">
                            ${analytics.topQuestions.map(q => `
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span class="text-sm">${q.question}</span>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${q.frequency}x</span>
                                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">${(q.confidence * 100).toFixed(0)}%</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                console.log('âœ… Agent analytics loaded successfully');
                
            } catch (error) {
                console.error('âŒ Failed to load agent analytics:', error);
                document.getElementById('agent-analytics-container').innerHTML = `
                    <p class="text-red-500 text-center py-4">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Failed to load analytics data
                    </p>
                `;
            }
        }

        // ðŸŽ­ AGENT PERSONALITY SETTINGS FUNCTIONS - Module 1
        
        // Load agent personality settings
        async function loadAgentPersonalitySettings() {
            const companyId = getCurrentCompanyId();
            if (!companyId) return;

            try {
                const response = await fetch(`/api/company/companies/${companyId}/personality`);
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('voiceToneSelect').value = data.voiceTone || 'friendly';
                    document.getElementById('speechPaceSelect').value = data.speechPace || 'normal';
                    document.getElementById('bargeInToggle').checked = data.bargeInMode ?? true;
                    document.getElementById('emotionToggle').checked = data.acknowledgeEmotion ?? true;
                    document.getElementById('emojiToggle').checked = data.useEmojis ?? false;
                    
                    console.log('âœ… Personality settings loaded');
                } else if (response.status === 404) {
                    console.log('âš ï¸ Personality settings endpoint not implemented yet - using defaults');
                } else {
                    console.log(`âš ï¸ Personality settings API returned ${response.status} - using defaults`);
                }
            } catch (error) {
                console.warn('âš ï¸ Failed to load personality settings - using defaults:', error.message);
            }
        }

        // Save agent personality settings
        async function saveAgentPersonalitySettings() {
            const companyId = getCurrentCompanyId();
            if (!companyId) return;

            const personalityData = {
                voiceTone: document.getElementById('voiceToneSelect').value,
                speechPace: document.getElementById('speechPaceSelect').value,
                bargeInMode: document.getElementById('bargeInToggle').checked,
                acknowledgeEmotion: document.getElementById('emotionToggle').checked,
                useEmojis: document.getElementById('emojiToggle').checked
            };

            try {
                const response = await fetch(`/api/company/companies/${companyId}/personality`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(personalityData)
                });

                if (response.ok) {
                    // Show success message
                    const savedIndicator = document.getElementById('personality-settings-saved');
                    savedIndicator.classList.remove('hidden');
                    setTimeout(() => savedIndicator.classList.add('hidden'), 3000);
                    
                    console.log('âœ… Personality settings saved');
                    alert('âœ… Personality settings saved successfully!');
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                console.error('âŒ Failed to save personality settings:', error);
                alert(`âŒ Failed to save personality settings: ${error.message}`);
            }
        }

        // Preview personality voice
        async function previewPersonality() {
            const voiceTone = document.getElementById('voiceToneSelect').value;
            const speechPace = document.getElementById('speechPaceSelect').value;
            
            // Generate sample text based on voice tone
            let sampleText = "";
            switch(voiceTone) {
                case 'friendly':
                    sampleText = "Hi there! Thanks for calling. I'm here to help make your day better. How can I assist you?";
                    break;
                case 'professional':
                    sampleText = "Good day. Thank you for contacting us. I'm ready to assist you with your needs. How may I help?";
                    break;
                case 'playful':
                    sampleText = "Hey! What's up? Ready to get things done? I'm excited to help you out today!";
                    break;
            }
            
            alert(`ðŸŽ­ Voice Preview (${voiceTone} tone, ${speechPace} pace):\n\n"${sampleText}"\n\nNote: Full TTS preview will be available in production.`);
        }

        // Reset personality to defaults
        function resetPersonalityDefaults() {
            if (!confirm('Reset personality settings to defaults?')) return;
            
            document.getElementById('voiceToneSelect').value = 'friendly';
            document.getElementById('speechPaceSelect').value = 'normal';
            document.getElementById('bargeInToggle').checked = true;
            document.getElementById('emotionToggle').checked = true;
            document.getElementById('emojiToggle').checked = false;
            
            console.log('âœ… Personality settings reset to defaults');
        }
        
        // ðŸ“š KNOWLEDGE Q&A SOURCE CONTROLS FUNCTIONS - Module 2
        
        // Initialize drag-and-drop functionality for knowledge source priority
        function initKnowledgeSources() {
            // Set up range input event listeners
            const rangeInputs = document.querySelectorAll('input[type="range"][id^="threshold-"]');
            rangeInputs.forEach(input => {
                const valueDisplay = document.getElementById(`threshold-value-${input.id.split('-')[1]}`);
                if (valueDisplay) {
                    input.addEventListener('input', () => {
                        valueDisplay.textContent = parseFloat(input.value).toFixed(2);
                    });
                } else {
                    console.warn(`âš ï¸ Value display element not found for threshold: ${input.id}`);
                }
            });
            
            // Set up context retention slider
            const contextSlider = document.getElementById('contextRetentionSlider');
            const contextValue = document.getElementById('contextRetentionValue');
            
            if (contextSlider && contextValue) {
                contextSlider.addEventListener('input', () => {
                    contextValue.textContent = `${contextSlider.value} minutes`;
                });
            } else {
                console.warn('âš ï¸ Context retention slider elements not found');
            }
            
            // Initialize drag & drop (simulated for now)
            const container = document.getElementById('clientsvia-source-priority-container');
            if (!container) {
                console.warn('âš ï¸ Source priority container not found');
                return;
            }
            const items = container.querySelectorAll('.priority-item');
            
            // Simple click-based priority switching (since full drag-drop requires libraries)
            items.forEach(item => {
                item.addEventListener('click', function() {
                    if (event.target.tagName === 'INPUT') return; // Don't trigger on slider clicks
                    
                    // Ask user which priority to assign
                    const currentPriority = parseInt(this.querySelector('.priority-value').textContent);
                    const newPriority = prompt(`Change "${this.dataset.source}" priority (1-4):`, currentPriority);
                    
                    if (newPriority && !isNaN(newPriority) && newPriority >= 1 && newPriority <= 4) {
                        // Find the item that currently has the target priority
                        const targetItem = Array.from(items).find(i => 
                            parseInt(i.querySelector('.priority-value').textContent) === parseInt(newPriority)
                        );
                        
                        if (targetItem) {
                            // Swap priorities
                            targetItem.querySelector('.priority-value').textContent = currentPriority;
                            this.querySelector('.priority-value').textContent = newPriority;
                            
                            // Update visual order
                            updateSourcePriorityOrder();
                        }
                    }
                });
            });
            
            console.log('âœ… Knowledge source controls initialized');
        }
        
        // Update the visual order of sources based on priority
        function updateSourcePriorityOrder() {
            const container = document.getElementById('clientsvia-source-priority-container');
            if (!container) {
                console.warn('âš ï¸ Source priority container not found for reordering');
                return;
            }
            const items = Array.from(container.querySelectorAll('.priority-item'));
            
            // Sort items by priority
            items.sort((a, b) => {
                const priorityA = parseInt(a.querySelector('.priority-value').textContent);
                const priorityB = parseInt(b.querySelector('.priority-value').textContent);
                return priorityA - priorityB;
            });
            
            // Remove all items
            items.forEach(item => container.removeChild(item));
            
            // Add them back in sorted order
            items.forEach(item => container.appendChild(item));
        }
        
        // Load knowledge settings from API
        async function loadKnowledgeSettings() {
            const companyId = getCurrentCompanyId();
            if (!companyId) return;
            
            try {
                const response = await fetch(`/api/company/companies/${companyId}/knowledge`);
                if (!response.ok) {
                    console.log('Using default knowledge settings');
                    return;
                }
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    const settings = data.data;
                    
                    // Update source priorities
                    if (settings.sourcePriority) {
                        for (const [source, priority] of Object.entries(settings.sourcePriority)) {
                            const element = document.querySelector(`#source-${source} .priority-value`);
                            if (element) element.textContent = priority;
                        }
                        updateSourcePriorityOrder();
                    }
                    
                    // Update confidence thresholds
                    if (settings.confidenceThresholds) {
                        for (const [source, threshold] of Object.entries(settings.confidenceThresholds)) {
                            const slider = document.getElementById(`threshold-${source}`);
                            const display = document.getElementById(`threshold-value-${source}`);
                            
                            if (slider && display) {
                                slider.value = threshold;
                                display.textContent = parseFloat(threshold).toFixed(2);
                            }
                        }
                    }
                    
                    // Update memory settings
                    if (settings.memoryMode) {
                        document.getElementById('memoryModeSelect').value = settings.memoryMode;
                    }
                    
                    if (settings.contextRetentionMinutes) {
                        const slider = document.getElementById('contextRetentionSlider');
                        const display = document.getElementById('contextRetentionValue');
                        slider.value = settings.contextRetentionMinutes;
                        display.textContent = `${settings.contextRetentionMinutes} minutes`;
                    }
                    
                    // Update fallback behaviors
                    document.getElementById('rejectLowConfidenceToggle').checked = 
                        settings.rejectLowConfidence !== undefined ? settings.rejectLowConfidence : true;
                        
                    document.getElementById('escalateNoMatchToggle').checked = 
                        settings.escalateOnNoMatch !== undefined ? settings.escalateOnNoMatch : true;
                    
                    // Update fallback message
                    if (settings.fallbackMessage) {
                        document.getElementById('fallbackMessageInput').value = settings.fallbackMessage;
                    }
                    
                    console.log('âœ… Knowledge settings loaded');
                }
            } catch (error) {
                console.error('âŒ Failed to load knowledge settings:', error);
            }
        }
        
        // Save knowledge settings to API
        async function saveKnowledgeSettings() {
            const companyId = getCurrentCompanyId();
            if (!companyId) return;
            
            // Build source priority object
            const sourcePriority = {};
            document.querySelectorAll('.priority-item').forEach(item => {
                const source = item.dataset.source;
                const priority = parseInt(item.querySelector('.priority-value').textContent);
                sourcePriority[source] = priority;
            });
            
            // Build confidence thresholds object
            const confidenceThresholds = {};
            document.querySelectorAll('input[type="range"][id^="threshold-"]').forEach(input => {
                const source = input.id.split('-')[1];
                confidenceThresholds[source] = parseFloat(input.value);
            });
            
            // Build complete settings object
            const knowledgeData = {
                sourcePriority,
                confidenceThresholds,
                memoryMode: document.getElementById('memoryModeSelect').value,
                contextRetentionMinutes: parseInt(document.getElementById('contextRetentionSlider').value),
                rejectLowConfidence: document.getElementById('rejectLowConfidenceToggle').checked,
                escalateOnNoMatch: document.getElementById('escalateNoMatchToggle').checked,
                fallbackMessage: document.getElementById('fallbackMessageInput').value.trim()
            };
            
            try {
                const response = await fetch(`/api/company/companies/${companyId}/knowledge`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(knowledgeData)
                });
                
                if (response.ok) {
                    // Show success message
                    const savedIndicator = document.getElementById('knowledge-settings-saved');
                    savedIndicator.classList.remove('hidden');
                    setTimeout(() => savedIndicator.classList.add('hidden'), 3000);
                    
                    console.log('âœ… Knowledge settings saved');
                    alert('âœ… Knowledge settings saved successfully!');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save settings');
                }
            } catch (error) {
                console.error('âŒ Failed to save knowledge settings:', error);
                alert(`âŒ Failed to save knowledge settings: ${error.message}`);
            }
        }
        
        // Reset knowledge settings to defaults
        function resetKnowledgeDefaults() {
            if (!confirm('Reset knowledge settings to defaults?')) return;
            
            // Reset source priorities
            document.querySelector('#source-companyQnA .priority-value').textContent = '1';
            document.querySelector('#source-tradeQnA .priority-value').textContent = '2';
            document.querySelector('#source-vectorSearch .priority-value').textContent = '3';
            document.querySelector('#source-llmFallback .priority-value').textContent = '4';
            updateSourcePriorityOrder();
            
            // Reset confidence thresholds
            document.getElementById('threshold-companyQnA').value = 0.8;
            document.getElementById('threshold-value-companyQnA').textContent = '0.80';
            
            document.getElementById('threshold-tradeQnA').value = 0.75;
            document.getElementById('threshold-value-tradeQnA').textContent = '0.75';
            
            document.getElementById('threshold-vectorSearch').value = 0.7;
            document.getElementById('threshold-value-vectorSearch').textContent = '0.70';
            
            document.getElementById('threshold-llmFallback').value = 0.6;
            document.getElementById('threshold-value-llmFallback').textContent = '0.60';
            
            // Reset memory settings
            document.getElementById('memoryModeSelect').value = 'conversational';
            document.getElementById('contextRetentionSlider').value = 30;
            document.getElementById('contextRetentionValue').textContent = '30 minutes';
            
            // Reset fallback behaviors
            document.getElementById('rejectLowConfidenceToggle').checked = true;
            document.getElementById('escalateNoMatchToggle').checked = true;
            
            // Reset fallback message
            document.getElementById('fallbackMessageInput').value = 
                "I want to make sure I give you accurate information. Let me connect you with a specialist who can help.";
            
            console.log('âœ… Knowledge settings reset to defaults');
        }
        
        // ðŸ§  AGENT CLIENTSVIA INTELLIGENCE FUNCTIONS

        // ðŸŽ­ CLIENTSVIA PERSONALITY SETTINGS FUNCTIONS - Tab Interface
        
        // Preview ClientsVia personality voice
        async function previewClientsviaPersonality() {
            const voiceTone = document.getElementById('clientsvia-voiceToneSelect').value;
            const speechPace = document.getElementById('clientsvia-speechPaceSelect').value;
            
            // Generate sample text based on voice tone
            let sampleText = "";
            switch(voiceTone) {
                case 'friendly':
                    sampleText = "Hi there! Thanks for calling. I'm here to help make your day better. How can I assist you?";
                    break;
                case 'professional':
                    sampleText = "Good day. Thank you for contacting us. I'm ready to assist you with your needs. How may I help?";
                    break;
                case 'playful':
                    sampleText = "Hey! What's up? Ready to get things done? I'm excited to help you out today!";
                    break;
            }
            
            alert(`ðŸŽ­ ClientsVia Voice Preview (${voiceTone} tone, ${speechPace} pace):\n\n"${sampleText}"\n\nNote: Full TTS preview will be available in production.`);
        }

        // Reset ClientsVia personality to defaults
        function resetClientsviaPersonalityDefaults() {
            if (!confirm('Reset ClientsVia personality settings to defaults?')) return;
            
            document.getElementById('clientsvia-voiceToneSelect').value = 'friendly';
            document.getElementById('clientsvia-speechPaceSelect').value = 'normal';
            document.getElementById('clientsvia-bargeInToggle').checked = true;
            document.getElementById('clientsvia-emotionToggle').checked = true;
            document.getElementById('clientsvia-emojiToggle').checked = false;
            
            console.log('âœ… ClientsVia personality settings reset to defaults');
        }

        // Save ClientsVia agent personality settings
        async function saveClientsviaAgentPersonalitySettings() {
            const companyId = getCurrentCompanyId();
            if (!companyId) return;

            const personalitySettings = {
                voiceTone: document.getElementById('clientsvia-voiceToneSelect').value,
                speechPace: document.getElementById('clientsvia-speechPaceSelect').value,
                bargeIn: document.getElementById('clientsvia-bargeInToggle').checked,
                acknowledgeEmotion: document.getElementById('clientsvia-emotionToggle').checked,
                useEmojis: document.getElementById('clientsvia-emojiToggle').checked
            };

            try {
                const response = await fetch(`/api/companies/${companyId}/clientsvia-personality`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ personalitySettings })
                });

                if (response.ok) {
                    const saved = document.getElementById('clientsvia-personality-settings-saved');
                    saved.classList.remove('hidden');
                    setTimeout(() => saved.classList.add('hidden'), 3000);
                    console.log('âœ… ClientsVia personality settings saved successfully');
                } else if (response.status === 404) {
                    console.warn('âš ï¸ ClientsVia personality settings endpoint not implemented yet');
                } else {
                    throw new Error(`HTTP ${response.status}: Failed to save personality settings`);
                }
            } catch (error) {
                console.error('âŒ Failed to save ClientsVia personality settings:', error);
                alert(`âŒ Failed to save ClientsVia personality settings: ${error.message}`);
            }
        }

        // Load ClientsVia agent personality settings
        async function loadClientsviaAgentPersonalitySettings() {
            const companyId = getCurrentCompanyId();
            if (!companyId) return;

            try {
                const response = await fetch(`/api/companies/${companyId}/clientsvia-personality`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.personalitySettings) {
                        const settings = data.personalitySettings;
                        document.getElementById('clientsvia-voiceToneSelect').value = settings.voiceTone || 'friendly';
                        document.getElementById('clientsvia-speechPaceSelect').value = settings.speechPace || 'normal';
                        document.getElementById('clientsvia-bargeInToggle').checked = settings.bargeIn !== false;
                        document.getElementById('clientsvia-emotionToggle').checked = settings.acknowledgeEmotion !== false;
                        document.getElementById('clientsvia-emojiToggle').checked = settings.useEmojis || false;
                    }
                    console.log('âœ… ClientsVia personality settings loaded successfully');
                } else if (response.status === 404) {
                    console.warn('âš ï¸ ClientsVia personality settings endpoint not implemented yet - using defaults');
                } else {
                    console.warn(`âš ï¸ ClientsVia personality settings API returned ${response.status} - using defaults`);
                }
            } catch (error) {
                console.warn('âš ï¸ Failed to load ClientsVia personality settings - using defaults:', error.message);
            }
        }

        // Tab switching functionality
        function initClientsViaTabs() {
            const tabButtons = document.querySelectorAll('.clientsvia-tab-btn');
            const tabContents = document.querySelectorAll('.clientsvia-tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.id.replace('clientsvia-tab-', '');
                    
                    // Remove active class from all tabs and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active', 'block'));
                    tabContents.forEach(content => content.classList.add('hidden'));
                    
                    // Add active class to clicked tab and corresponding content
                    button.classList.add('active');
                    const targetContent = document.getElementById(`clientsvia-${targetTab}-content`);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                        targetContent.classList.add('active', 'block');
                    }
                });
            });
        }
        
        // Initialize ClientsVia Priority Flow drag & drop
        function initClientsViaPriorityFlow() {
            const container = document.getElementById('clientsvia-priority-flow-container');
            if (!container) return;
            
            // Enable drag and drop
            const items = container.querySelectorAll('.clientsvia-priority-item');
            items.forEach((item, index) => {
                item.addEventListener('dragstart', handleClientsViaDragStart);
                item.addEventListener('dragover', handleClientsViaDragOver);
                item.addEventListener('drop', handleClientsViaDrop);
                item.addEventListener('dragend', handleClientsViaDragEnd);
            });
            
            console.log('âœ… ClientsVia Priority Flow drag & drop initialized');
        }
        
        // ClientsVia drag handlers
        let clientsViaDraggedElement = null;
        
        function handleClientsViaDragStart(e) {
            clientsViaDraggedElement = this;
            this.style.opacity = '0.5';
        }
        
        function handleClientsViaDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleClientsViaDrop(e) {
            e.preventDefault();
            if (this !== clientsViaDraggedElement) {
                // Swap the elements
                const container = document.getElementById('clientsvia-priority-flow-container');
                const allItems = Array.from(container.children);
                const draggedIndex = allItems.indexOf(clientsViaDraggedElement);
                const droppedIndex = allItems.indexOf(this);
                
                if (draggedIndex < droppedIndex) {
                    container.insertBefore(clientsViaDraggedElement, this.nextSibling);
                } else {
                    container.insertBefore(clientsViaDraggedElement, this);
                }
                
                // Update priority numbers
                updateClientsViaPriorityNumbers();
            }
        }
        
        function handleClientsViaDragEnd(e) {
            this.style.opacity = '1';
            clientsViaDraggedElement = null;
        }
        
        // Update priority numbers after drag
        function updateClientsViaPriorityNumbers() {
            const items = document.querySelectorAll('.clientsvia-priority-item');
            items.forEach((item, index) => {
                const numberElement = item.querySelector('.priority-number span');
                if (numberElement) {
                    numberElement.textContent = index + 1;
                }
                item.setAttribute('data-priority-order', index + 1);
            });
        }
        
        // Initialize ClientsVia Knowledge Source controls
        function initClientsViaKnowledgeSources() {
            // Update threshold displays
            const thresholds = ['companyQnA', 'tradeQnA', 'vectorSearch', 'llmFallback'];
            thresholds.forEach(source => {
                const slider = document.getElementById(`clientsvia-threshold-${source}`);
                const display = document.getElementById(`clientsvia-threshold-value-${source}`);
                
                if (slider && display) {
                    slider.addEventListener('input', () => {
                        display.textContent = parseFloat(slider.value).toFixed(2);
                    });
                }
            });
            
            // Context retention slider
            const contextSlider = document.getElementById('clientsvia-contextRetentionSlider');
            const contextDisplay = document.getElementById('clientsvia-contextRetentionValue');
            
            if (contextSlider && contextDisplay) {
                contextSlider.addEventListener('input', () => {
                    contextDisplay.textContent = `${contextSlider.value} minutes`;
                });
            }
            
            console.log('âœ… ClientsVia Knowledge Sources initialized');
        }
        
        // Save ClientsVia configuration
        async function saveClientsViaConfiguration() {
            const companyId = getCurrentCompanyId();
            if (!companyId) {
                showNotification('Error: Company ID not found', 'error');
                return;
            }
            
            try {
                // Collect priority flow data
                const priorityItems = document.querySelectorAll('.clientsvia-priority-item');
                const priorityFlow = Array.from(priorityItems).map((item, index) => ({
                    type: item.getAttribute('data-priority-type'),
                    order: index + 1,
                    active: item.querySelector('.clientsvia-priority-toggle').checked
                }));
                
                // Collect knowledge source data
                const knowledgeSources = {
                    companyQnA: {
                        confidence: parseFloat(document.getElementById('clientsvia-threshold-companyQnA').value),
                        priority: 1
                    },
                    tradeQnA: {
                        confidence: parseFloat(document.getElementById('clientsvia-threshold-tradeQnA').value),
                        priority: 2
                    },
                    vectorSearch: {
                        confidence: parseFloat(document.getElementById('clientsvia-threshold-vectorSearch').value),
                        priority: 3
                    },
                    llmFallback: {
                        confidence: parseFloat(document.getElementById('clientsvia-threshold-llmFallback').value),
                        priority: 4
                    }
                };
                
                // Collect memory settings
                const memorySettings = {
                    mode: document.getElementById('clientsvia-memoryModeSelect').value,
                    contextRetentionTime: parseInt(document.getElementById('clientsvia-contextRetentionSlider').value),
                    rejectLowConfidence: document.getElementById('clientsvia-rejectLowConfidenceToggle').checked,
                    escalateNoMatch: document.getElementById('clientsvia-escalateNoMatchToggle').checked,
                    fallbackMessage: document.getElementById('clientsvia-fallbackMessageInput').value
                };
                
                const clientsViaConfig = {
                    priorityFlow,
                    knowledgeSources,
                    memorySettings,
                    lastUpdated: new Date().toISOString()
                };
                
                // Save to backend
                const response = await fetch(`/api/companies/${companyId}/clientsvia-config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(clientsViaConfig)
                });
                
                if (response.ok) {
                    showNotification('ClientsVia configuration saved successfully!', 'success');
                    console.log('âœ… ClientsVia configuration saved:', clientsViaConfig);
                } else if (response.status === 404) {
                    console.warn('âš ï¸ ClientsVia configuration endpoint not implemented yet');
                    showNotification('ClientsVia configuration endpoint not available yet', 'warning');
                } else {
                    throw new Error(`HTTP ${response.status}: Failed to save configuration`);
                }
                
            } catch (error) {
                console.error('âŒ Error saving ClientsVia configuration:', error);
                showNotification('Error saving ClientsVia configuration', 'error');
            }
        }
        
        // Initialize ClientsVia Intelligence
        function initClientsViaIntelligence() {
            initClientsViaTabs();
            initClientsViaPriorityFlow();
            initClientsViaKnowledgeSources();
            
            // Bind save button
            const saveButton = document.getElementById('save-clientsvia-all-config');
            if (saveButton) {
                saveButton.addEventListener('click', saveClientsViaConfiguration);
            }
            
            console.log('ðŸ§  ClientsVia Intelligence fully initialized');
        }
        
        // Update threshold value display
        document.addEventListener('DOMContentLoaded', function() {
            const thresholdSlider = document.getElementById('agent-fallbackThreshold');
            const thresholdValue = document.getElementById('fallback-threshold-value');
            
            if (thresholdSlider && thresholdValue) {
                thresholdSlider.addEventListener('input', function() {
                    thresholdValue.textContent = this.value;
                });
            }
        });

        // Basic mobile menu toggle
        // Mobile menu toggle
        document.getElementById('mobile-menu-button')?.addEventListener('click', () => {
            document.getElementById('mobile-menu')?.classList.toggle('hidden');
        });

        // Navigation link highlighting only
        document.addEventListener('DOMContentLoaded', function() {
            let currentPath = window.location.pathname.replace(/\/$/, "") || "/index.html";
            document.querySelectorAll('header nav a.nav-link, #mobile-menu a.nav-link').forEach(link => {
                let linkPath = new URL(link.href).pathname.replace(/\/$/, "") || "/index.html";
                link.classList.remove('active-tab', 'text-gray-700');
                if (linkPath === currentPath) {
                    link.classList.add('active-tab');
                } else {
                    link.classList.add('text-gray-700');
                }
            });

            // Load AI Agent data when tab is accessed
            const aiAgentTab = document.getElementById('tab-ai-agent-logic');
            if (aiAgentTab) {
                aiAgentTab.addEventListener('click', function() {
                    // Add small delay to ensure tab content is visible
                    setTimeout(() => {
                        loadAgentTradeCategories(); // Load checkboxes system
                        loadAgentSettings();
                        loadAgentPersonalitySettings(); // Module 1: Load personality settings
                        loadClientsviaAgentPersonalitySettings(); // ClientsVia: Load personality settings for tab interface
                        initKnowledgeSources(); // Module 2: Initialize knowledge source controls
                        loadKnowledgeSettings(); // Module 2: Load knowledge settings
                        loadAgentAnalytics();
                    }, 100);
                });
            }
        });
    </script>
    
    <script src="/js/company-profile-modern.js?v=2.1"></script>
    
    <!-- Main Page Initialization Script -->
    <script>
        // Main initialization when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Company Profile page DOMContentLoaded - Starting initialization...');
            
            // Get company ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const companyId = urlParams.get('id');
            
            if (companyId) {
                console.log('âœ… Company ID found in URL:', companyId);
                
                // Set global company ID
                window.companyId = companyId;
                
                // Initialize CompanyProfileManager and start loading data
                try {
                    console.log('ðŸ“¡ Creating CompanyProfileManager instance...');
                    window.companyProfileManager = new CompanyProfileManager();
                    
                    // Initialize the manager (this will call loadCompanyData internally)
                    window.companyProfileManager.init()
                        .then(() => {
                            console.log('âœ… Company Profile Manager initialized successfully');
                            
                            // Initialize ClientsVia Intelligence after company data loads
                            initClientsViaIntelligence();
                        })
                        .catch(error => {
                            console.error('âŒ Error initializing Company Profile Manager:', error);
                        });
                        
                } catch (error) {
                    console.error('âŒ Error creating CompanyProfileManager:', error);
                }
            } else {
                console.error('âŒ No company ID found in URL');
                document.getElementById('company-name-header').textContent = 'Error: No company ID provided';
                document.getElementById('company-id-subheader').textContent = 'Please access this page with a valid company ID.';
            }
        });

        // Response Categories Functions
        window.switchResponseCategory = function(category) {
            console.log('switchResponseCategory called with:', category);
            try {
                // Update tab buttons
                document.querySelectorAll('.response-category-tab').forEach(btn => {
                    btn.classList.remove('active', 'bg-purple-600', 'text-white');
                    btn.classList.add('bg-white', 'text-purple-600', 'hover:bg-purple-50');
                });
                
                // Activate clicked tab
                event.target.classList.add('active', 'bg-purple-600', 'text-white');
                event.target.classList.remove('bg-white', 'text-purple-600', 'hover:bg-purple-50');
                
                // Show/hide content sections
                document.querySelectorAll('.response-category-content').forEach(content => {
                    content.style.display = 'none';
                });
                
                const targetContent = document.getElementById(category + '-responses');
                if (targetContent) {
                    targetContent.style.display = 'block';
                    console.log('Successfully switched to:', category);
                } else {
                    console.error('Content section not found:', category + '-responses');
                }
            } catch (error) {
                console.error('Error in switchResponseCategory:', error);
            }
        };

        window.toggleResponsePreview = function() {
            console.log('toggleResponsePreview called');
            try {
                const button = event.target.closest('button');
                const previewPanel = document.getElementById('response-preview-panel');
                const isLiveMode = button.textContent.includes('Stop');
                
                if (!previewPanel) {
                    console.error('Preview panel not found!');
                    return;
                }
                
                if (isLiveMode) {
                    // Hide live preview panel
                    previewPanel.classList.add('hidden');
                    button.innerHTML = '<i class="fas fa-eye mr-2"></i>Live Preview';
                    button.classList.remove('bg-red-600', 'hover:bg-red-700');
                    button.classList.add('bg-purple-600', 'hover:bg-purple-700');
                    console.log('Live preview disabled - panel hidden');
                } else {
                    // Show live preview panel
                    previewPanel.classList.remove('hidden');
                    button.innerHTML = '<i class="fas fa-eye-slash mr-2"></i>Stop Preview';
                    button.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                    button.classList.add('bg-red-600', 'hover:bg-red-700');
                    
                    // Initialize preview content
                    const originalDiv = document.getElementById('preview-original');
                    const personalizedDiv = document.getElementById('preview-personalized');
                    if (originalDiv) originalDiv.textContent = 'Click on any response to see live preview...';
                    if (personalizedDiv) personalizedDiv.textContent = 'Personality-enhanced version will appear here...';
                    
                    console.log('Live preview enabled - panel shown');
                }
            } catch (error) {
                console.error('Error in toggleResponsePreview:', error);
            }
        };

        window.insertResponseVariable = function(textareaId, variable) {
            console.log('insertResponseVariable called:', textareaId, variable);
            try {
                const textarea = document.getElementById(textareaId);
                if (!textarea) {
                    console.error('Textarea not found:', textareaId);
                    return;
                }
                
                const cursorPosition = textarea.selectionStart;
                const textBefore = textarea.value.substring(0, cursorPosition);
                const textAfter = textarea.value.substring(textarea.selectionEnd);
                
                textarea.value = textBefore + variable + textAfter;
                textarea.focus();
                
                const newPosition = cursorPosition + variable.length;
                textarea.setSelectionRange(newPosition, newPosition);
                
                console.log('Variable inserted successfully:', variable);
            } catch (error) {
                console.error('Error in insertResponseVariable:', error);
            }
        };

        // Populate the Response Placeholders table with company data
        function populateResponsePlaceholdersTable() {
            const tableBody = document.getElementById('placeholders-table-body');
            if (!tableBody) return;
            
            // Get company data (this should be loaded from the CompanyProfileManager)
            const companyData = window.companyProfileManager?.companyData;
            
            const defaultPlaceholders = [
                {
                    placeholder: '{companyname}',
                    value: companyData?.companyName || 'atlas air',
                    description: 'The name of your company',
                    type: 'system'
                },
                {
                    placeholder: '{businessphone}',
                    value: companyData?.primaryContact?.phoneNumber || '+12395652202',
                    description: 'Main business phone number',
                    type: 'system'
                },
                {
                    placeholder: '{businessemail}',
                    value: companyData?.primaryContact?.email || 'mypenguinair@gmail.com',
                    description: 'Main business email address',
                    type: 'system'
                },
                {
                    placeholder: '{businesshours}',
                    value: companyData?.businessHours || 'm-f 9-5',
                    description: 'Standard business operating hours',
                    type: 'system'
                },
                {
                    placeholder: '{callername}',
                    value: 'John Doe',
                    description: 'Name of the caller (dynamic)',
                    type: 'dynamic'
                },
                {
                    placeholder: '{currenttime}',
                    value: new Date().toLocaleTimeString(),
                    description: 'Current time (dynamic)',
                    type: 'dynamic'
                },
                {
                    placeholder: '{departmentname}',
                    value: 'Customer Service',
                    description: 'Name of the department for transfers',
                    type: 'dynamic'
                },
                {
                    placeholder: '{specialistname}',
                    value: 'Sarah Wilson',
                    description: 'Name of specialist for transfers',
                    type: 'dynamic'
                },
                {
                    placeholder: '{servicetype}',
                    value: 'Technical Support',
                    description: 'Type of service being requested',
                    type: 'dynamic'
                },
                {
                    placeholder: '{alternativeservice}',
                    value: 'General Inquiries',
                    description: 'Alternative service option',
                    type: 'dynamic'
                },
                {
                    placeholder: '{estimatedtime}',
                    value: '5-10 minutes',
                    description: 'Estimated wait or processing time',
                    type: 'dynamic'
                },
                {
                    placeholder: '{website}',
                    value: companyData?.website || 'www.atlasair.com',
                    description: 'Company website URL',
                    type: 'system'
                }
            ];
            
            // Clear existing content
            tableBody.innerHTML = '';
            
            // Populate table with placeholders
            defaultPlaceholders.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-mono text-purple-700">${item.placeholder}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">
                        <div>${item.value}</div>
                        <div class="text-xs text-gray-500">${item.description}</div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                            item.type === 'system' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
                        }">
                            ${item.type}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-right text-sm font-medium">
                        <button type="button" class="text-indigo-600 hover:text-indigo-900">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            console.log('âœ… Response Placeholders table populated with', defaultPlaceholders.length, 'placeholders');
        }

        // Update variable insertion buttons in Response Categories
        function updateVariableInsertionButtons() {
            const placeholders = getAvailablePlaceholders();
            const buttonContainers = document.querySelectorAll('[data-response-variables]');
            
            buttonContainers.forEach(container => {
                const textareaId = container.getAttribute('data-response-variables');
                
                // Clear existing buttons
                container.innerHTML = '';
                
                // Add buttons for each placeholder
                placeholders.slice(0, 8).forEach(placeholder => { // Limit to 8 most common
                    const button = document.createElement('span');
                    button.className = 'inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 cursor-pointer hover:bg-blue-200 transition-colors';
                    button.textContent = placeholder.display;
                    button.onclick = () => insertResponseVariable(textareaId, placeholder.placeholder);
                    container.appendChild(button);
                });
                
                // Add a "More..." button if there are more placeholders
                if (placeholders.length > 8) {
                    const moreButton = document.createElement('span');
                    moreButton.className = 'inline-flex items-center px-2 py-1 rounded text-xs bg-gray-100 text-gray-600 cursor-pointer hover:bg-gray-200 transition-colors';
                    moreButton.innerHTML = '<i class="fas fa-ellipsis-h mr-1"></i>More';
                    moreButton.onclick = () => showAllPlaceholders(textareaId);
                    container.appendChild(moreButton);
                }
            });
            
            console.log('âœ… Variable insertion buttons updated for Response Categories');
        }
        
        // Show all placeholders in a modal/dropdown
        function showAllPlaceholders(textareaId) {
            const placeholders = getAvailablePlaceholders();
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium">Insert Placeholder</h3>
                        <button class="text-gray-400 hover:text-gray-600" onclick="this.closest('.fixed').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        ${placeholders.map(p => `
                            <button class="text-left p-2 rounded border hover:bg-blue-50 hover:border-blue-300 transition-colors"
                                    onclick="insertResponseVariable('${textareaId}', '${p.placeholder}'); this.closest('.fixed').remove();">
                                <div class="font-mono text-sm text-blue-600">${p.display}</div>
                                <div class="text-xs text-gray-500 truncate">${p.value}</div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        window.previewResponse = async function(textareaId) {
            console.log('previewResponse called:', textareaId);
            try {
                const textarea = document.getElementById(textareaId);
                if (!textarea) {
                    console.error('Textarea not found for preview:', textareaId);
                    return;
                }
                
                const template = textarea.value;
                
                // Get placeholders and their values
                const placeholders = getAvailablePlaceholders();
                let previewText = template;
                
                // Replace all placeholders with their actual values
                placeholders.forEach(placeholder => {
                    const regex = new RegExp(placeholder.placeholder.replace(/[{}]/g, '\\$&'), 'g');
                    previewText = previewText.replace(regex, placeholder.value);
                });
                
                // Also handle legacy double-brace formats for backward compatibility
                previewText = previewText
                    .replace(/\{\{callerName\}\}/g, 'John Smith')
                    .replace(/\{\{companyName\}\}/g, 'ClientsVia Solutions')
                    .replace(/\{\{currentTime\}\}/g, new Date().toLocaleTimeString())
                    .replace(/\{\{businessHours\}\}/g, 'Monday-Friday 9AM-5PM')
                    .replace(/\{\{website\}\}/g, 'www.clientsvia.com')
                    .replace(/\{\{departmentName\}\}/g, 'Technical Support')
                    .replace(/\{\{specialistName\}\}/g, 'Sarah Wilson')
                    .replace(/\{\{serviceType\}\}/g, 'our service')
                    .replace(/\{\{alternativeService\}\}/g, 'General Inquiries')
                    .replace(/\{\{estimatedTime\}\}/g, '5-10 minutes');
                
                // Check if preview text is empty
                if (!previewText.trim()) {
                    alert('Please enter some text to preview.');
                    return;
                }
                
                // Get current company and voice settings
                const companyId = getCurrentCompanyId();
                const voiceSelect = document.getElementById('voice-selector');
                const voiceId = voiceSelect ? voiceSelect.value : null;
                
                if (!voiceId) {
                    // Fallback to text preview if no voice selected
                    alert('ðŸŽ™ï¸ Voice Preview:\n\n' + previewText + '\n\n(Select a voice in AI Voice Settings tab to hear audio preview)');
                    return;
                }
                
                // Show loading state
                const originalText = `Preview: "${previewText.substring(0, 50)}${previewText.length > 50 ? '...' : ''}"`;
                if (confirm(`ðŸŽ™ï¸ Generate voice preview?\n\n${originalText}`)) {
                    
                    // Generate TTS audio
                    console.log('ðŸŽµ Generating preview audio...', { voiceId, textLength: previewText.length });
                    
                    const response = await fetch('/api/elevenlabs/synthesize', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            text: previewText.trim(),
                            voiceId: voiceId,
                            companyId: companyId
                        })
                    });
                    
                    const result = await response.json();
                    console.log('ðŸ” Full server response:', result);
                    
                    if (result.success) {
                        let audioUrl;
                        
                        // Handle different response formats
                        if (result.audioUrl) {
                            // Direct URL format
                            audioUrl = result.audioUrl;
                            console.log('ðŸ”Š Using direct audio URL:', audioUrl);
                        } else if (result.audioContent) {
                            // Base64 audio content - create blob URL
                            console.log('ðŸ”Š Converting base64 audio content to blob URL');
                            const binaryString = atob(result.audioContent);
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            const blob = new Blob([bytes], { type: 'audio/mpeg' });
                            audioUrl = URL.createObjectURL(blob);
                            console.log('ðŸ”Š Created blob URL:', audioUrl);
                        } else {
                            console.error('ðŸš« No audio URL or content found in response:', result);
                            alert('Audio generated but no playback data received from server.');
                            return;
                        }
                        
                        const audio = new Audio(audioUrl);
                        
                        // Add event listeners for debugging
                        audio.addEventListener('loadstart', () => console.log('ðŸ”Š Audio loadstart'));
                        audio.addEventListener('canplay', () => console.log('ðŸ”Š Audio canplay'));
                        audio.addEventListener('play', () => console.log('ðŸ”Š Audio started playing'));
                        audio.addEventListener('ended', () => {
                            console.log('ðŸ”Š Audio finished playing');
                            // Clean up blob URL if it was created from base64
                            if (result.audioContent && audioUrl.startsWith('blob:')) {
                                URL.revokeObjectURL(audioUrl);
                                console.log('ðŸ§¹ Cleaned up blob URL');
                            }
                        });
                        audio.addEventListener('error', (e) => console.error('ðŸš« Audio error:', e));
                        
                        // Attempt to play with user feedback
                        audio.play().then(() => {
                            console.log('ðŸŽµ Preview audio playing successfully');
                            // Show visual feedback that audio is playing
                            const notification = document.createElement('div');
                            notification.innerHTML = 'ðŸ”Š Playing preview...';
                            notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:10px;border-radius:5px;z-index:9999;';
                            document.body.appendChild(notification);
                            setTimeout(() => notification.remove(), 3000);
                        }).catch(err => {
                            console.error('ðŸš« Audio playback failed:', err);
                            alert(`ðŸ”Š Audio generated but playback blocked by browser.\n\nTry:\n1. Click on the page first\n2. Check browser volume\n3. Allow audio in browser settings\n\nError: ${err.message}`);
                        });
                    } else {
                        console.error('TTS generation failed:', result.error);
                        // Fallback to text preview
                        alert('ðŸŽ™ï¸ Voice Preview (TTS unavailable):\n\n' + previewText);
                    }
                }
                
            } catch (error) {
                console.error('Error in previewResponse:', error);
                // Fallback to text preview on error
                const textarea = document.getElementById(textareaId);
                if (textarea) {
                    const fallbackText = textarea.value
                        .replace(/\{\{callerName\}\}/g, 'John Smith')
                        .replace(/\{companyname\}/g, 'ClientsVia Solutions')
                        .replace(/\{\{companyName\}\}/g, 'ClientsVia Solutions');
                    alert('ðŸŽ™ï¸ Preview (fallback):\n\n' + fallbackText);
                }
            }
        };

        // Function to update live preview panel
        window.updateLivePreview = function(textareaId) {
            const previewPanel = document.getElementById('response-preview-panel');
            if (!previewPanel || previewPanel.classList.contains('hidden')) {
                return; // Live preview is not active
            }
            
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;
            
            const originalDiv = document.getElementById('preview-original');
            const personalizedDiv = document.getElementById('preview-personalized');
            
            if (originalDiv && personalizedDiv) {
                const template = textarea.value;
                
                // Show original template
                originalDiv.innerHTML = `<strong>${textareaId.replace('response-', '').replace('-', ' ')}:</strong><br>${template || 'Empty response...'}`;
                
                // Show personalized version with sample data
                const personalizedText = template
                    .replace(/\{\{callerName\}\}/g, 'John Smith')
                    .replace(/\{companyname\}/g, 'ClientsVia Solutions')
                    .replace(/\{\{companyName\}\}/g, 'ClientsVia Solutions')
                    .replace(/\{businessphone\}/g, '+1-234-567-8900')
                    .replace(/\{businessemail\}/g, 'info@clientsvia.com')
                    .replace(/\{businesshours\}/g, 'Monday-Friday 9AM-5PM')
                    .replace(/\{\{businessHours\}\}/g, 'Monday-Friday 9AM-5PM')
                    .replace(/\{\{website\}\}/g, 'www.clientsvia.com')
                    .replace(/\{\{departmentName\}\}/g, 'Technical Support')
                    .replace(/\{\{serviceType\}\}/g, 'our service')
                    .replace(/\{\{phoneNumber\}\}/g, 'your number')
                    .replace(/\{\{managerName\}\}/g, 'Sarah Johnson')
                    .replace(/\{\{issueType\}\}/g, 'this issue')
                    .replace(/\{\{requestType\}\}/g, 'your request')
                    .replace(/\{\{serviceProvided\}\}/g, 'solving your problem')
                    .replace(/\{\{estimatedTime\}\}/g, '2-3 minutes');
                
                personalizedDiv.innerHTML = `<strong>With Sample Data:</strong><br>${personalizedText || 'Empty response...'}`;
            }
        };

        // Initialize Response Categories with dynamic placeholders
        function initializeResponseCategories() {
            console.log('ðŸŽ­ Initializing Response Categories with dynamic placeholders...');
            
            // Convert all existing hard-coded variable buttons to data-response-variables containers
            const hardcodedContainers = document.querySelectorAll('.flex.flex-wrap.gap-1:not([data-response-variables])');
            
            hardcodedContainers.forEach(container => {
                // Check if this container has variable buttons (spans with onclick)
                const hasVariableButtons = container.querySelector('span[onclick*="insertVariable"], span[onclick*="insertResponseVariable"]');
                
                if (hasVariableButtons) {
                    // Find the associated textarea
                    const parentDiv = container.closest('.bg-white');
                    const textarea = parentDiv ? parentDiv.querySelector('textarea[id^="response-"]') : null;
                    
                    if (textarea) {
                        const textareaId = textarea.id;
                        container.setAttribute('data-response-variables', textareaId);
                        console.log(`âœ… Converted container for ${textareaId}`);
                    }
                }
            });
            
            // Update all variable insertion buttons
            updateVariableInsertionButtons();
            
            // Also standardize all textarea content to use single-brace format
            const responseTextareas = document.querySelectorAll('textarea[id^="response-"]');
            responseTextareas.forEach(textarea => {
                if (textarea.value) {
                    textarea.value = textarea.value
                        .replace(/\{\{callerName\}\}/g, '{callername}')
                        .replace(/\{\{companyName\}\}/g, '{companyname}')
                        .replace(/\{\{currentTime\}\}/g, '{currenttime}')
                        .replace(/\{\{businessHours\}\}/g, '{businesshours}')
                        .replace(/\{\{website\}\}/g, '{website}')
                        .replace(/\{\{departmentName\}\}/g, '{departmentname}')
                        .replace(/\{\{specialistName\}\}/g, '{specialistname}')
                        .replace(/\{\{serviceType\}\}/g, '{servicetype}')
                        .replace(/\{\{alternativeService\}\}/g, '{alternativeservice}')
                        .replace(/\{\{estimatedTime\}\}/g, '{estimatedtime}')
                        .replace(/\{\{phoneNumber\}\}/g, '{phonenumber}')
                        .replace(/\{\{preferredTime\}\}/g, '{preferredtime}')
                        .replace(/\{\{ticketNumber\}\}/g, '{ticketnumber}')
                        .replace(/\{\{managerName\}\}/g, '{managername}')
                        .replace(/\{\{issueType\}\}/g, '{issuetype}')
                        .replace(/\{\{requestType\}\}/g, '{requesttype}')
                        .replace(/\{\{serviceProvided\}\}/g, '{serviceprovided}');
                }
                
                if (textarea.placeholder) {
                    textarea.placeholder = textarea.placeholder
                        .replace(/\{\{callerName\}\}/g, '{callername}')
                        .replace(/\{\{companyName\}\}/g, '{companyname}')
                        .replace(/\{\{currentTime\}\}/g, '{currenttime}')
                        .replace(/\{\{businessHours\}\}/g, '{businesshours}')
                        .replace(/\{\{website\}\}/g, '{website}')
                        .replace(/\{\{departmentName\}\}/g, '{departmentname}')
                        .replace(/\{\{specialistName\}\}/g, '{specialistname}')
                        .replace(/\{\{serviceType\}\}/g, '{servicetype}')
                        .replace(/\{\{alternativeService\}\}/g, '{alternativeservice}')
                        .replace(/\{\{estimatedTime\}\}/g, '{estimatedtime}')
                        .replace(/\{\{phoneNumber\}\}/g, '{phonenumber}')
                        .replace(/\{\{preferredTime\}\}/g, '{preferredtime}')
                        .replace(/\{\{ticketNumber\}\}/g, '{ticketnumber}')
                        .replace(/\{\{managerName\}\}/g, '{managername}')
                        .replace(/\{\{issueType\}\}/g, '{issuetype}')
                        .replace(/\{\{requestType\}\}/g, '{requesttype}')
                        .replace(/\{\{serviceProvided\}\}/g, '{serviceprovided}');
                }
            });
            
            console.log('âœ… Response Categories initialization complete');
        }
        
        // Attach event listeners to all response textareas
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const responseTextareas = document.querySelectorAll('[id^="response-"]');
                responseTextareas.forEach(textarea => {
                    // Update live preview on focus and input
                    textarea.addEventListener('focus', () => updateLivePreview(textarea.id));
                    textarea.addEventListener('input', () => updateLivePreview(textarea.id));
                });
                console.log(`ðŸŽ­ Live preview listeners attached to ${responseTextareas.length} response textareas`);
            }, 1000); // Delay to ensure all elements are loaded

            // Initialize Response Categories with dynamic placeholders
            setTimeout(() => {
                populateResponsePlaceholdersTable(); // Populate table first
                initializeResponseCategories(); // Then convert existing elements
                updateVariableInsertionButtons(); // Finally update the buttons
            }, 1200);
        });

        console.log('âœ… Response Categories functions loaded successfully');
    </script>
    
    <!-- Modern implementation handles all initialization -->
</body>
