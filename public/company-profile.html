<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Company Profile</title>
    <link rel="icon" href="/favicon.ico">
    
    <!-- Tailwind CSS (Production Build) -->
    <link rel="stylesheet" href="/css/output.css">
    <link rel="stylesheet" href="/css/company-profile.css">
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        // ============================================================================
        // Guard: Company Profile requires a valid companyId
        // ============================================================================
        (function() {
            try {
                const params = new URLSearchParams(window.location.search || '');
                const rawId = params.get('companyId') || params.get('id') || params.get('company');
                const companyId = String(rawId || '').trim();
                const isMongoId = /^[a-f0-9]{24}$/i.test(companyId);

                if (!isMongoId) {
                    window.location.replace('/directory.html');
                }
            } catch (e) {
                // If something goes wrong, fail closed by going to directory.
                window.location.replace('/directory.html');
            }
        })();
    </script>
</head>
<body class="bg-gray-100">
    <div id="app" class="flex flex-col min-h-screen">
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex-shrink-0">
                        <a href="/index.html" class="text-2xl font-bold text-indigo-600">
                            <i class="fas fa-tachometer-alt mr-2"></i>Admin Dashboard
                        </a>
                        <div class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-clock mr-1"></i>ClientsVia V2 AI Agent Platform
                            <span class="mx-2">•</span>
                            <span id="page-loaded-time">Loading...</span>
                        </div>
                    </div>
                    <nav class="hidden md:flex items-center space-x-1">
                        <a href="/index.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 transition-colors">
                            <i class="fas fa-home mr-1"></i>Dashboard
                        </a>
                        <a href="/directory.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 transition-colors">
                            <i class="fas fa-list-alt mr-1"></i>Directory
                        </a>
                        <a href="/admin-data-center.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 transition-colors">
                            <i class="fas fa-database mr-1"></i>Data Center
                        </a>
                        <a href="/admin-call-archives.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 transition-colors">
                            <i class="fas fa-phone-volume mr-1"></i>Call Archives
                        </a>
                        <a href="/admin-global-instant-responses.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 transition-colors">
                            <i class="fas fa-brain mr-1"></i>Global AI Brain
                        </a>
                        <button onclick="logout()" class="px-3 py-2 rounded-md text-sm font-medium text-red-600 hover:text-red-700 hover:bg-red-50 transition-colors">
                            <i class="fas fa-sign-out-alt mr-1"></i>Logout
                        </button>
                    </nav>
                    <div class="md:hidden flex items-center">
                        <button id="mobile-menu-button" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
                            <span class="sr-only">Open main menu</span>
                            <i class="fas fa-bars text-2xl"></i>
                        </button>
                    </div>
                </div>

            <!-- Mobile menu -->
            <div id="mobile-menu" class="md:hidden hidden">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="/index.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <a href="/directory.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50">
                        <i class="fas fa-list-alt mr-2"></i>Directory
                    </a>
                    <a href="/admin-data-center.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50">
                        <i class="fas fa-database mr-2"></i>Data Center
                    </a>
                    <a href="/admin-call-archives.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50">
                        <i class="fas fa-phone-volume mr-2"></i>Call Archives
                    </a>
                    <a href="/admin-global-instant-responses.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-indigo-600 hover:bg-indigo-50">
                        <i class="fas fa-brain mr-2"></i>Global AI Brain
                    </a>
                    <button onclick="logout()" class="block px-3 py-2 rounded-md text-base font-medium text-red-600 hover:text-red-700 hover:bg-red-50 text-left w-full">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-1">
                    <div> 
                        <h1 class="text-3xl font-semibold text-gray-800" id="company-name-header">Loading...</h1>
                        <p id="company-id-subheader" class="text-xs text-gray-500 mt-1">ID: Loading...</p> 
                    </div>
                    <div class="flex items-center gap-x-3 mt-3 md:mt-0">
                        <!-- Control Plane Config Button -->
                        <button onclick="openConfigJsonModal()" 
                                style="background-color: #0d9488; color: white; padding: 8px 16px; border-radius: 6px; font-weight: 600; display: flex; align-items: center; gap: 8px; border: none; cursor: pointer;"
                                title="View Control Plane effective configuration"
                                onmouseover="this.style.backgroundColor='#0f766e'"
                                onmouseout="this.style.backgroundColor='#0d9488'">
                            <i class="fas fa-sliders-h"></i>
                            <span>Config JSON</span>
                        </button>
                        
                        <!-- HMAC Signed Snapshot Button -->
                        <button onclick="toggleControlPlanePanel()" 
                                style="background-color: #3b82f6; color: white; padding: 8px 16px; border-radius: 6px; font-weight: 600; display: flex; align-items: center; gap: 8px; border: none; cursor: pointer;"
                                title="View HMAC signed Control Plane snapshot"
                                onmouseover="this.style.backgroundColor='#2563eb'"
                                onmouseout="this.style.backgroundColor='#3b82f6'">
                            <i class="fas fa-lock"></i>
                            <span>Signed Snapshot</span>
                        </button>
                        <!-- Platform Snapshot Button (NOT runtime truth) -->
                        <button onclick="openTruthReport()" 
                                style="background-color: #1e40af; color: white; padding: 8px 16px; border-radius: 6px; font-weight: 600; display: flex; align-items: center; gap: 8px; border: none; cursor: pointer;"
                                title="Platform Snapshot: provider health + DB echo (NOT runtime). Runtime Truth is canonical."
                                onmouseover="this.style.backgroundColor='#1e3a8a'"
                                onmouseout="this.style.backgroundColor='#1e40af'">
                            <i class="fas fa-file-code"></i>
                            <span>Platform Snapshot</span>
                            <i class="fas fa-info-circle" title="Runtime Truth = what the agent will execute. Platform Snapshot = what providers think is configured + DB echo." style="opacity: 0.85;"></i>
                            <span id="truth-report-badge" class="hidden px-1.5 py-0.5 text-xs font-bold rounded-full"></span>
                        </button>
                        <!-- Runtime Truth Blockers JSON (canonical subset) -->
                        <button onclick="downloadRuntimeTruthBlockersJson()"
                                style="background-color: #0f766e; color: white; padding: 8px 16px; border-radius: 6px; font-weight: 600; display: flex; align-items: center; gap: 8px; border: none; cursor: pointer;"
                                title="Download Runtime Truth blockers JSON (_meta + health + blockers)."
                                onmouseover="this.style.backgroundColor='#0d9488'"
                                onmouseout="this.style.backgroundColor='#0f766e'">
                            <i class="fas fa-gavel"></i>
                            <span>Runtime Truth (Blockers)</span>
                        </button>
                        <span id="company-status-badge" class="status-badge mr-3">Status</span> 
                    </div>
                </div>
                <hr class="mb-6 mt-3">

                <div class="mb-6">
                    <div class="border-b border-gray-300 sticky top-16 z-30 bg-white">
                        <nav class="-mb-px flex flex-wrap space-x-1" aria-label="Tabs">
                            <button class="tab-button tab-button-active" id="tab-overview" data-tab="overview">
                                <i class="fas fa-info-circle mr-1"></i>Overview
                            </button>
                            <button class="tab-button tab-button-inactive" id="tab-config" data-tab="config">
                                <i class="fas fa-cogs mr-1"></i>Configuration
                            </button>
                            <button class="tab-button tab-button-inactive" id="tab-notes" data-tab="notes">
                                <i class="fas fa-sticky-note mr-1"></i>Notes
                            </button>
                            
                            <button class="tab-button tab-button-inactive" id="tab-ai-voice" data-tab="ai-voice">
                                <i class="fas fa-microphone-alt mr-1"></i>AI Voice Settings
                            </button>
                            
                            <button class="tab-button tab-button-inactive" id="tab-ai-agent-settings" data-tab="ai-agent-settings">
                                <i class="fas fa-robot mr-1"></i>AI Agent Settings
                            </button>
                            
                            <button class="tab-button tab-button-inactive" id="tab-spam-filter" data-tab="spam-filter">
                                <i class="fas fa-shield-alt mr-1"></i>Spam Filter
                            </button>

                        </nav>
                    </div>
                </div>

                <div id="tab-content-area">
                    <!-- ===== TAB SECTION START: OVERVIEW ===== -->
                    <div id="overview-content" class="tab-content-item">
                        <section class="profile-section bg-transparent shadow-none p-0">
                            <div id="company-details-edit-form">
                                <!-- Modern form will be inserted here by JavaScript -->
                                <p class="text-gray-500 text-center py-8">Loading company information...</p>
                            </div>
                            <!-- Company Contacts Section -->
                            <div id="company-contacts-section" class="mt-8">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-address-book mr-2 text-indigo-600"></i>Company Contacts
                                </h2>
                                <div id="contacts-list" class="space-y-6"></div>
                                <button type="button" id="add-contact-btn" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-150">
                                    <i class="fas fa-plus mr-1"></i>Add Contact
                                </button>
                            </div>
                        </section>
                    </div>
                    <!-- ===== TAB SECTION END: OVERVIEW ===== -->

                    <!-- ===== TAB SECTION START: CONFIGURATION ===== -->
                    <div id="config-content" class="tab-content-item hidden">
                        <section class="profile-section bg-transparent shadow-none p-0">
                            <h2 class="profile-section-title"><i class="fas fa-cogs mr-2 text-indigo-600"></i>Service Configuration</h2>
                            <form id="config-settings-form">
                                <div class="config-block">
                                    <h3 class="font-semibold text-gray-700 mb-2">Twilio Integration Credentials</h3>
                                    <p class="text-sm text-gray-500 mb-3">Enter the Twilio credentials that this company's AI agent will use.</p>
                                    <div class="space-y-3">
                                        <div>
                                            <label for="twilioAccountSid" class="form-label">Account SID</label>
                                            <input type="text" id="twilioAccountSid" name="twilioAccountSid" class="form-input wider-textbox" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                                        </div>
                                        <div>
                                            <label for="twilioAuthToken" class="form-label">Auth Token</label>
                                            <input type="text" id="twilioAuthToken" name="twilioAuthToken" class="form-input wider-textbox" placeholder="Enter Auth Token" style="font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="config-block mt-6">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="font-semibold text-gray-700">Account Status Control</h3>
                                        <span id="account-status-badge" class="px-3 py-1 rounded-full text-xs font-bold">
                                            <!-- Will be populated by JavaScript -->
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-4">Control call routing and account access. All Twilio settings are preserved when changing status.</p>
                                    
                                    <!-- Status Selector -->
                                    <div class="bg-white border-2 border-gray-200 rounded-lg p-5 mb-4">
                                        <label class="form-label mb-3 flex items-center">
                                            <i class="fas fa-toggle-on mr-2 text-indigo-600"></i>
                                            Account Status
                                        </label>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                            <!-- Active Status -->
                                            <label class="status-option cursor-pointer">
                                                <input type="radio" name="accountStatus" value="active" class="hidden status-radio">
                                                <div class="status-card border-2 rounded-lg p-4 transition-all hover:shadow-md">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <div class="flex items-center">
                                                            <i class="fas fa-check-circle text-green-600 text-xl mr-2"></i>
                                                            <span class="font-bold text-gray-900">Active</span>
                                                        </div>
                                                        <i class="fas fa-circle hidden check-indicator text-green-600"></i>
                                                    </div>
                                                    <p class="text-xs text-gray-600">AI agent handles all calls normally</p>
                                                </div>
                                            </label>
                                            
                                            <!-- Call Forward Status -->
                                            <label class="status-option cursor-pointer">
                                                <input type="radio" name="accountStatus" value="call_forward" class="hidden status-radio">
                                                <div class="status-card border-2 rounded-lg p-4 transition-all hover:shadow-md">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <div class="flex items-center">
                                                            <i class="fas fa-phone-forward text-yellow-600 text-xl mr-2"></i>
                                                            <span class="font-bold text-gray-900">Call Forward</span>
                                                        </div>
                                                        <i class="fas fa-circle hidden check-indicator text-yellow-600"></i>
                                                    </div>
                                                    <p class="text-xs text-gray-600">Forward calls to external number</p>
                                                </div>
                                            </label>
                                            
                                            <!-- Suspended Status -->
                                            <label class="status-option cursor-pointer">
                                                <input type="radio" name="accountStatus" value="suspended" class="hidden status-radio">
                                                <div class="status-card border-2 rounded-lg p-4 transition-all hover:shadow-md">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <div class="flex items-center">
                                                            <i class="fas fa-ban text-red-600 text-xl mr-2"></i>
                                                            <span class="font-bold text-gray-900">Suspended</span>
                                                        </div>
                                                        <i class="fas fa-circle hidden check-indicator text-red-600"></i>
                                                    </div>
                                                    <p class="text-xs text-gray-600">Block all incoming calls</p>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Call Forward Number (shown only when Call Forward is selected) -->
                                    <div id="call-forward-section" class="hidden bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                                        <div class="mb-4">
                                            <label for="call-forward-number" class="form-label flex items-center text-yellow-900">
                                                <i class="fas fa-phone mr-2"></i>
                                                Forward To Phone Number
                                            </label>
                                            <input 
                                                type="tel" 
                                                id="call-forward-number" 
                                                class="form-input mt-2" 
                                                placeholder="+12395551234" 
                                                pattern="\+?[1-9]\d{1,14}">
                                            <p class="text-xs text-yellow-700 mt-2">
                                                <i class="fas fa-info-circle mr-1"></i>
                                                Enter phone number in E.164 format (e.g., +12395551234)
                                            </p>
                                        </div>
                                        
                                        <div>
                                            <label for="call-forward-message" class="form-label flex items-center text-yellow-900">
                                                <i class="fas fa-comment-dots mr-2"></i>
                                                Custom Forward Message (Optional)
                                            </label>
                                            <textarea 
                                                id="call-forward-message" 
                                                class="form-input mt-2" 
                                                rows="2" 
                                                placeholder="Thank you for calling {Company Name}. Please hold while we connect your call."
                                                maxlength="300"></textarea>
                                            <p class="text-xs text-yellow-700 mt-2">
                                                <i class="fas fa-magic mr-1"></i>
                                                Use <code class="bg-yellow-200 px-1 rounded">{Company Name}</code> or <code class="bg-yellow-200 px-1 rounded">{CompanyName}</code> placeholder - it will be replaced with your company name. Leave empty for default message.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Suspended Message (shown only when Suspended is selected) -->
                                    <div id="suspended-section" class="hidden bg-red-50 border-2 border-red-300 rounded-lg p-4 mb-4">
                                        <div>
                                            <label for="suspended-message" class="form-label flex items-center text-red-900">
                                                <i class="fas fa-comment-dots mr-2"></i>
                                                Custom Suspension Message
                                            </label>
                                            <textarea 
                                                id="suspended-message" 
                                                class="form-input mt-2" 
                                                rows="3" 
                                                placeholder="We're sorry, but service for this number is temporarily unavailable. Please contact support for assistance."
                                                maxlength="300"></textarea>
                                            <p class="text-xs text-red-700 mt-2">
                                                <i class="fas fa-magic mr-1"></i>
                                                Use <code class="bg-red-200 px-1 rounded">{Company Name}</code> or <code class="bg-red-200 px-1 rounded">{CompanyName}</code> placeholder - it will be replaced with your company name. This message is what callers will hear.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Reason for Change (INTERNAL NOTES ONLY) -->
                                    <div class="mb-4">
                                        <label for="status-change-reason" class="form-label">Reason for Status Change (Internal Notes Only)</label>
                                        <textarea 
                                            id="status-change-reason" 
                                            class="form-input" 
                                            rows="2" 
                                            placeholder="e.g., Payment pending, Customer request, Maintenance"
                                            maxlength="200"></textarea>
                                    </div>
                                    
                                    <!-- Save Button -->
                                    <button 
                                        type="button" 
                                        id="save-account-status-btn"
                                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                                        <i class="fas fa-save mr-2"></i>Update Account Status
                                    </button>
                                    
                                    <!-- Status History -->
                                    <div id="status-history-section" class="mt-6 hidden">
                                        <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                                            <i class="fas fa-history mr-2 text-gray-600"></i>
                                            Status Change History
                                        </h4>
                                        <div id="status-history-list" class="space-y-2 max-h-60 overflow-y-auto">
                                            <!-- Will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Phone Numbers Management -->
                                <div class="config-block mt-6">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="font-semibold text-gray-700">Twilio Phone Numbers</h3>
                                        <button type="button" id="addPhoneNumberBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-3 py-1 rounded-md flex items-center">
                                            <i class="fas fa-plus mr-1"></i>Add Number
                                        </button>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-3">Manage all Twilio phone numbers available for this company's AI agents.</p>
                                    
                                    <!-- Phone Numbers List -->
                                    <div id="phoneNumbersList" class="space-y-3">
                                        <!-- Primary Phone Number (Default) -->
                                        <div class="phone-number-item border border-gray-200 rounded-lg p-4 bg-gray-50">
                                            <div class="flex items-center justify-between">
                                                <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <div>
                                                        <label class="form-label text-sm">Phone Number (E.164 format)</label>
                                                        <input type="tel" name="phoneNumber" class="form-input" placeholder="+12395551212" value="">
                                                    </div>
                                                    <div>
                                                        <label class="form-label text-sm">Friendly Name</label>
                                                        <input type="text" name="friendlyName" class="form-input" placeholder="Main Business Line" value="Primary Number">
                                                    </div>
                                                    <div>
                                                        <label class="form-label text-sm">Status</label>
                                                        <select name="status" class="form-select">
                                                            <option value="active" selected>Active</option>
                                                            <option value="inactive">Inactive</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="ml-4 flex items-center space-x-2">
                                                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Primary</span>
                                                    <button type="button" class="text-red-600 hover:text-red-800" title="Remove">
                                                        <i class="fas fa-trash text-sm"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Add Phone Number Template (Hidden) -->
                                    <template id="phoneNumberTemplate">
                                        <div class="phone-number-item border border-gray-200 rounded-lg p-4">
                                            <div class="flex items-center justify-between">
                                                <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <div>
                                                        <label class="form-label text-sm">Phone Number (E.164 format)</label>
                                                        <input type="tel" name="phoneNumber" class="form-input" placeholder="+12395551212">
                                                    </div>
                                                    <div>
                                                        <label class="form-label text-sm">Friendly Name</label>
                                                        <input type="text" name="friendlyName" class="form-input" placeholder="e.g., Emergency Line, Sales Line">
                                                    </div>
                                                    <div>
                                                        <label class="form-label text-sm">Status</label>
                                                        <select name="status" class="form-select">
                                                            <option value="active" selected>Active</option>
                                                            <option value="inactive">Inactive</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="ml-4 flex items-center space-x-2">
                                                    <button type="button" class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full hover:bg-blue-200" title="Set as Primary">
                                                        Set Primary
                                                    </button>
                                                    <button type="button" class="text-red-600 hover:text-red-800" title="Remove">
                                                        <i class="fas fa-trash text-sm"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Webhook Configuration Reference -->
                                <div class="config-block mt-6">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="font-semibold text-gray-700">Twilio Webhook Configuration</h3>
                                        <button type="button" id="toggleWebhookInfo" class="text-indigo-600 hover:text-indigo-800 text-sm flex items-center">
                                            <i class="fas fa-info-circle mr-1"></i>Show Webhook URLs
                                        </button>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-3">Use these webhook URLs in your Twilio Console for phone number configuration.</p>
                                    
                                    <div id="webhookInfoPanel" class="hidden">
                                        <!-- Dynamic webhook content will be generated by JavaScript -->
                                    </div>
                                </div>
                                
                                <!-- Additional API Configuration -->
                                <div class="config-block mt-6">
                                    <h3 class="font-semibold text-gray-700 mb-2">Additional API Keys</h3>
                                    <p class="text-sm text-gray-500 mb-3">Configure additional integrations and services.</p>
                                    <div class="space-y-3">
                                        <div>
                                            <label for="twilioApiKey" class="form-label">Twilio API Key (Optional)</label>
                                            <input type="text" id="twilioApiKey" name="twilioApiKey" class="form-input wider-textbox" placeholder="SKxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" style="font-family: monospace;">
                                        </div>
                                        <div>
                                            <label for="twilioApiSecret" class="form-label">Twilio API Secret (Optional)</label>
                                            <input type="text" id="twilioApiSecret" name="twilioApiSecret" class="form-input wider-textbox" placeholder="Enter API Secret" style="font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ════════════════════════════════════════════════════════════════════════════════
                                     GOOGLE CALENDAR INTEGRATION - V88 (Jan 2026)
                                     Real-time availability checking + automatic appointment booking
                                     ════════════════════════════════════════════════════════════════════════════════ -->
                                <div class="config-block mt-6" id="google-calendar-section">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="font-semibold text-gray-700">
                                            <i class="fab fa-google text-blue-600 mr-2"></i>Google Calendar Integration
                                            <span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Real-time Scheduling</span>
                                        </h3>
                                        <button type="button" id="gc-refresh-status" class="text-gray-500 hover:text-gray-700 text-sm">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-4">Connect your Google Calendar to enable real-time availability checking and automatic appointment creation.</p>
                                    
                                    <!-- Connection Status -->
                                    <div id="gc-status-panel" class="mb-4">
                                        <div id="gc-loading" class="text-center py-6 text-gray-500">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>Checking calendar status...
                                        </div>
                                        
                                        <!-- Not Configured (Platform level) -->
                                        <div id="gc-not-configured" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-4">
                                            <div class="flex items-start">
                                                <div class="flex-shrink-0">
                                                    <i class="fas fa-info-circle text-gray-400 text-xl"></i>
                                                </div>
                                                <div class="ml-3">
                                                    <h4 class="text-sm font-medium text-gray-800">Calendar Integration Not Configured</h4>
                                                    <p class="mt-1 text-sm text-gray-600">Google Calendar integration is not configured on this platform. Contact your administrator.</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Not Connected -->
                                        <div id="gc-not-connected" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                            <div class="flex items-start">
                                                <div class="flex-shrink-0">
                                                    <i class="fas fa-calendar-times text-yellow-500 text-xl"></i>
                                                </div>
                                                <div class="ml-3 flex-grow">
                                                    <h4 class="text-sm font-medium text-gray-800">Calendar Not Connected</h4>
                                                    <p class="mt-1 text-sm text-gray-600">Connect your Google Calendar to enable real-time availability checking.</p>
                                                    <button type="button" id="gc-connect-btn" class="mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                                        <i class="fab fa-google mr-2"></i>Connect Google Calendar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Connected -->
                                        <div id="gc-connected" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
                                            <div class="flex items-start">
                                                <div class="flex-shrink-0">
                                                    <i class="fas fa-calendar-check text-green-500 text-xl"></i>
                                                </div>
                                                <div class="ml-3 flex-grow">
                                                    <h4 class="text-sm font-medium text-gray-800">Calendar Connected</h4>
                                                    <div class="mt-1 text-sm text-gray-600">
                                                        <p><strong>Calendar:</strong> <span id="gc-calendar-name">-</span></p>
                                                        <p><strong>Account:</strong> <span id="gc-calendar-email">-</span></p>
                                                        <p><strong>Connected:</strong> <span id="gc-connected-at">-</span></p>
                                                    </div>
                                                    <div class="mt-3 flex items-center space-x-3">
                                                        <button type="button" id="gc-test-btn" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                                            <i class="fas fa-vial mr-1"></i>Test Connection
                                                        </button>
                                                        <button type="button" id="gc-disconnect-btn" class="inline-flex items-center px-3 py-1.5 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50">
                                                            <i class="fas fa-unlink mr-1"></i>Disconnect
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="flex-shrink-0 ml-3">
                                                    <label class="relative inline-flex items-center cursor-pointer">
                                                        <input type="checkbox" id="gc-enabled-toggle" class="sr-only peer">
                                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                                        <span class="ml-2 text-sm font-medium text-gray-700">Enabled</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Error State -->
                                        <div id="gc-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                                            <div class="flex items-start">
                                                <div class="flex-shrink-0">
                                                    <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                                                </div>
                                                <div class="ml-3">
                                                    <h4 class="text-sm font-medium text-red-800">Connection Error</h4>
                                                    <p class="mt-1 text-sm text-red-700" id="gc-error-message">-</p>
                                                    <button type="button" id="gc-reconnect-btn" class="mt-2 text-sm text-red-700 hover:text-red-900 underline">
                                                        Try reconnecting
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Calendar Settings (shown only when connected) -->
                                    <div id="gc-settings-panel" class="hidden border-t border-gray-200 pt-4 mt-4">
                                        <h4 class="text-sm font-semibold text-gray-700 mb-3">
                                            <i class="fas fa-cog mr-2"></i>Booking Settings
                                        </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="form-label">Buffer Before First Slot (minutes)</label>
                                                <input type="number" id="gc-buffer-minutes" class="form-input" value="60" min="0" max="480">
                                                <p class="text-xs text-gray-500 mt-1">Minimum time before earliest available appointment</p>
                                            </div>
                                            <div>
                                                <label class="form-label">Default Appointment Duration (minutes)</label>
                                                <input type="number" id="gc-duration-minutes" class="form-input" value="60" min="15" max="480" step="15">
                                                <p class="text-xs text-gray-500 mt-1">How long each appointment blocks on calendar</p>
                                            </div>
                                            <div>
                                                <label class="form-label">Max Days Ahead</label>
                                                <input type="number" id="gc-max-days" class="form-input" value="30" min="1" max="90">
                                                <p class="text-xs text-gray-500 mt-1">How far in advance customers can book</p>
                                            </div>
                                            <div>
                                                <label class="form-label">Fallback Mode</label>
                                                <select id="gc-fallback-mode" class="form-input">
                                                    <option value="preference_capture">Capture preference & confirm later</option>
                                                    <option value="transfer_to_human">Transfer to human</option>
                                                    <option value="error_message">Show error message</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">What to do if calendar is unavailable</p>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4 space-y-3">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="gc-include-phone" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked>
                                                <label for="gc-include-phone" class="ml-2 text-sm text-gray-700">Include customer phone in calendar event</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input type="checkbox" id="gc-include-address" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked>
                                                <label for="gc-include-address" class="ml-2 text-sm text-gray-700">Include customer address in calendar event</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input type="checkbox" id="gc-include-notes" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked>
                                                <label for="gc-include-notes" class="ml-2 text-sm text-gray-700">Include service notes in calendar event</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input type="checkbox" id="gc-send-invite" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                                <label for="gc-send-invite" class="ml-2 text-sm text-gray-700">Send calendar invite to customer (requires email)</label>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <label class="form-label">Event Title Template</label>
                                            <input type="text" id="gc-event-title" class="form-input wider-textbox" value="{serviceType} - {customerName}" placeholder="{serviceType} - {customerName}">
                                            <p class="text-xs text-gray-500 mt-1">Placeholders: {customerName}, {serviceType}, {companyName}</p>
                                        </div>
                                        
                                        <!-- ═══════════════════════════════════════════════════════════════════════════
                                             EVENT COLORS - V89 (Jan 2026)
                                             Color-code calendar events by service type
                                             ═══════════════════════════════════════════════════════════════════════════ -->
                                        <div class="mt-6 border-t border-gray-200 pt-4">
                                            <div class="flex items-center justify-between mb-3">
                                                <h4 class="text-sm font-semibold text-gray-700">
                                                    <i class="fas fa-palette mr-2 text-purple-600"></i>Event Colors (Tags)
                                                </h4>
                                                <div class="flex items-center">
                                                    <input type="checkbox" id="gc-colors-enabled" class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500" checked>
                                                    <label for="gc-colors-enabled" class="ml-2 text-sm text-gray-700">Enable color-coding</label>
                                                </div>
                                            </div>
                                            <p class="text-xs text-gray-500 mb-3">Color events automatically based on service type. AI detects intent (repair, maintenance, estimate, etc.) and applies the matching color.</p>
                                            
                                            <div id="gc-color-mappings" class="space-y-2">
                                                <!-- Color mappings will be populated by JavaScript -->
                                            </div>
                                            
                                            <div class="mt-3 flex items-center">
                                                <label class="text-sm text-gray-700 mr-2">Default color (when type unknown):</label>
                                                <select id="gc-default-color" class="form-input w-auto text-sm">
                                                    <option value="1">🟪 Lavender</option>
                                                    <option value="2">🟩 Sage</option>
                                                    <option value="3">🟣 Grape</option>
                                                    <option value="4">🩷 Flamingo</option>
                                                    <option value="5">🟨 Banana</option>
                                                    <option value="6">🟧 Tangerine</option>
                                                    <option value="7" selected>🩵 Peacock</option>
                                                    <option value="8">⬜ Graphite</option>
                                                    <option value="9">🟦 Blueberry</option>
                                                    <option value="10">💚 Basil</option>
                                                    <option value="11">🔴 Tomato</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4 flex justify-end">
                                            <button type="button" id="gc-save-settings-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">
                                                <i class="fas fa-save mr-2"></i>Save Calendar Settings
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ════════════════════════════════════════════════════════════════════════════════
                                     SMS NOTIFICATIONS - V88 (Jan 2026)
                                     Booking confirmations and appointment reminders via SMS
                                     ════════════════════════════════════════════════════════════════════════════════ -->
                                <div class="config-block mt-6" id="sms-notifications-section">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="font-semibold text-gray-700">
                                            <i class="fas fa-sms text-green-600 mr-2"></i>SMS Notifications
                                            <span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Booking Confirmations</span>
                                        </h3>
                                        <div class="flex items-center space-x-3">
                                            <button type="button" id="sms-refresh-status" class="text-gray-500 hover:text-gray-700 text-sm">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="sms-master-toggle" class="sr-only peer">
                                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                                <span class="ml-2 text-sm font-medium text-gray-700">Enabled</span>
                                            </label>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-4">Send automatic SMS confirmations when bookings complete and reminders before appointments.</p>
                                    
                                    <!-- Status Panel -->
                                    <div id="sms-status-panel" class="mb-4">
                                        <div id="sms-loading" class="text-center py-4 text-gray-500">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading SMS status...
                                        </div>
                                        
                                        <!-- No Twilio Credentials -->
                                        <div id="sms-no-twilio" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                            <div class="flex items-start">
                                                <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mt-1"></i>
                                                <div class="ml-3">
                                                    <h4 class="text-sm font-medium text-gray-800">Twilio Credentials Required</h4>
                                                    <p class="mt-1 text-sm text-gray-600">SMS notifications require Twilio credentials. Configure them in the Twilio Configuration section above.</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Ready -->
                                        <div id="sms-ready" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-start">
                                                    <i class="fas fa-check-circle text-green-500 text-xl"></i>
                                                    <div class="ml-3">
                                                        <h4 class="text-sm font-medium text-gray-800">SMS Notifications Ready</h4>
                                                        <p class="mt-1 text-sm text-gray-600">
                                                            <span id="sms-stats-sent">0</span> sent (last 30 days) · 
                                                            <span id="sms-stats-pending">0</span> pending
                                                        </p>
                                                    </div>
                                                </div>
                                                <button type="button" id="sms-test-btn" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                                    <i class="fas fa-paper-plane mr-1"></i>Send Test
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Email-to-SMS Gateway Test (A2P Workaround) -->
                                        <div id="sms-email-gateway-test" class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                            <h4 class="text-sm font-semibold text-gray-700 mb-2">
                                                <i class="fas fa-envelope text-blue-600 mr-2"></i>Email-to-SMS Gateway
                                                <span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">A2P Workaround</span>
                                            </h4>
                                            <p class="text-xs text-gray-500 mb-3">Send SMS via email when Twilio A2P 10DLC isn't ready yet.</p>
                                            
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Phone Number</label>
                                                    <input type="text" id="sms-gateway-phone" class="w-full p-2 text-sm border border-gray-300 rounded" placeholder="2395652202">
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Carrier</label>
                                                    <select id="sms-gateway-carrier" class="w-full p-2 text-sm border border-gray-300 rounded">
                                                        <option value="verizon">Verizon</option>
                                                        <option value="att">AT&T</option>
                                                        <option value="tmobile">T-Mobile</option>
                                                        <option value="sprint">Sprint</option>
                                                        <option value="uscellular">US Cellular</option>
                                                        <option value="metropcs">MetroPCS</option>
                                                        <option value="boost">Boost Mobile</option>
                                                        <option value="cricket">Cricket</option>
                                                        <option value="google_fi">Google Fi</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Message</label>
                                                    <input type="text" id="sms-gateway-message" class="w-full p-2 text-sm border border-gray-300 rounded" placeholder="Test from ClientsVia" value="Test booking confirmation from ClientsVia AI!">
                                                </div>
                                            </div>
                                            
                                            <button type="button" id="sms-gateway-send-btn" class="mt-3 inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition">
                                                <i class="fas fa-paper-plane mr-2"></i>Send via Email Gateway
                                            </button>
                                            <span id="sms-gateway-result" class="ml-3 text-sm"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- SMS Settings (shown when enabled) -->
                                    <div id="sms-settings-panel" class="hidden border-t border-gray-200 pt-4 mt-4 space-y-4">
                                        
                                        <!-- Confirmation SMS -->
                                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <h4 class="text-sm font-semibold text-gray-700">
                                                    <i class="fas fa-check mr-2 text-green-600"></i>Booking Confirmation
                                                </h4>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" id="sms-confirmation-enabled" class="sr-only peer" checked>
                                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                                                </label>
                                            </div>
                                            <p class="text-xs text-gray-500 mb-2">Sent immediately when a booking is completed</p>
                                            <textarea id="sms-confirmation-template" class="w-full p-2 text-sm border border-gray-300 rounded-md" rows="3" placeholder="Hi {customerName}! Your appointment with {companyName} is confirmed..."></textarea>
                                            <p class="text-xs text-gray-400 mt-1">Placeholders: {customerName}, {companyName}, {appointmentTime}, {customerAddress}, {serviceType}</p>
                                        </div>
                                        
                                        <!-- 24h Reminder -->
                                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <h4 class="text-sm font-semibold text-gray-700">
                                                    <i class="fas fa-clock mr-2 text-blue-600"></i>24-Hour Reminder
                                                </h4>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" id="sms-reminder24h-enabled" class="sr-only peer" checked>
                                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-500"></div>
                                                </label>
                                            </div>
                                            <p class="text-xs text-gray-500 mb-2">Sent 24 hours before the appointment</p>
                                            <textarea id="sms-reminder24h-template" class="w-full p-2 text-sm border border-gray-300 rounded-md" rows="3" placeholder="Reminder: Your appointment with {companyName} is tomorrow..."></textarea>
                                        </div>
                                        
                                        <!-- 1h Reminder -->
                                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <h4 class="text-sm font-semibold text-gray-700">
                                                    <i class="fas fa-bell mr-2 text-orange-600"></i>1-Hour Reminder
                                                </h4>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" id="sms-reminder1h-enabled" class="sr-only peer">
                                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-orange-500"></div>
                                                </label>
                                            </div>
                                            <p class="text-xs text-gray-500 mb-2">Sent 1 hour before the appointment</p>
                                            <textarea id="sms-reminder1h-template" class="w-full p-2 text-sm border border-gray-300 rounded-md" rows="3" placeholder="{companyName} reminder: Your technician will arrive in about 1 hour..."></textarea>
                                        </div>
                                        
                                        <!-- Quiet Hours -->
                                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <h4 class="text-sm font-semibold text-gray-700">
                                                    <i class="fas fa-moon mr-2 text-indigo-600"></i>Quiet Hours
                                                </h4>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" id="sms-quiet-hours-enabled" class="sr-only peer" checked>
                                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-500"></div>
                                                </label>
                                            </div>
                                            <p class="text-xs text-gray-500 mb-2">Don't send SMS during these hours (messages will be queued)</p>
                                            <div class="flex items-center space-x-2">
                                                <input type="time" id="sms-quiet-start" class="p-1 text-sm border border-gray-300 rounded" value="21:00">
                                                <span class="text-gray-500">to</span>
                                                <input type="time" id="sms-quiet-end" class="p-1 text-sm border border-gray-300 rounded" value="08:00">
                                            </div>
                                        </div>
                                        
                                        <div class="flex justify-end">
                                            <button type="button" id="sms-save-settings-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">
                                                <i class="fas fa-save mr-2"></i>Save SMS Settings
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-8 pt-5 border-t border-gray-200">
                                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                                        <i class="fas fa-save mr-2"></i>Save Configuration
                                    </button>
                                </div>
                            </form>
                        </section>
                    </div>
                    <!-- ===== TAB SECTION END: CONFIGURATION ===== -->

                    <!-- ===== TAB SECTION START: NOTES ===== -->
                    <div id="notes-content" class="tab-content-item hidden">
                        <section class="profile-section bg-transparent shadow-none p-0"> 
                            <h2 class="profile-section-title"><i class="fas fa-sticky-note mr-2 text-indigo-600"></i>Company Notes</h2>
                            <div id="add-note-area" class="mb-6">
                                <textarea id="new-note-textarea" class="notes-textarea wider-textbox" placeholder="Type your new note here..."></textarea>
                                <button id="add-new-note-button" class="mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                                    <i class="fas fa-plus-circle mr-2"></i>Add Note
                                </button>
                            </div>
                            <div id="notes-display-area">
                                <p class="text-gray-500 italic text-center py-4">Notes will appear here.</p>
                            </div>
                        </section>
                    </div>
                    <!-- ===== TAB SECTION END: NOTES ===== -->
                    

                    <!-- ===== REMOVED: LEGACY AI SETTINGS TAB =====
                         This entire section was removed because it conflicts with the 
                         100% in-house AI Agent Logic system. The legacy tab included:
                         - External LLM dependencies (Gemini 2.5 Flash)
                         - Cloud LLM Chain fallbacks 
                         - External Knowledge Base URLs
                         - Legacy personality system
                         
                         All functionality now handled by AI Agent Logic tab.
                         ===== LEGACY AI SETTINGS REMOVAL COMPLETE ===== -->

                    <!-- ===== TAB SECTION START: AI VOICE ===== -->
                    <div id="ai-voice-content" class="tab-content-item hidden">
                        <section class="profile-section bg-transparent shadow-none p-0">
                            <h2 class="profile-section-title">
                                <i class="fas fa-microphone-alt mr-2 text-indigo-600"></i>AI Voice Settings
                                <span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Latest ElevenLabs API</span>
                            </h2>

                            <!-- API Configuration Section -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gray-50 px-6 py-4 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-key mr-2 text-blue-600"></i>API Configuration
                                        <button type="button" id="test-api-connection" class="ml-auto text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded transition duration-150">
                                            <i class="fas fa-plug mr-1"></i>Test Connection
                                        </button>
                                    </h3>
                                </div>
                                
                                <form id="elevenlabs-api-form" class="p-6">
                                    <!-- API Key Source Toggle -->
                                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h4 class="text-sm font-semibold text-gray-800 mb-1">
                                                    <i class="fas fa-toggle-on mr-2 text-blue-600"></i>ElevenLabs API Source
                                                </h4>
                                                <p class="text-xs text-gray-600" id="api-source-description">
                                                    Using ClientsVia global API (default for all companies)
                                                </p>
                                            </div>
                                            <div class="flex items-center">
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" id="useOwnApiKey" class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                                    <span class="ml-3 text-sm font-medium text-gray-700" id="toggle-label">Use Own API</span>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- Global API Info -->
                                        <div id="global-api-info" class="mt-3 p-3 bg-white rounded border border-blue-100">
                                            <div class="flex items-center text-sm text-green-700">
                                                <i class="fas fa-check-circle mr-2"></i>
                                                <span>Using ClientsVia shared ElevenLabs account - no setup required!</span>
                                            </div>
                                            <p class="text-xs text-gray-600 mt-1">
                                                Voice synthesis costs are covered by ClientsVia. Perfect for most businesses.
                                            </p>
                                        </div>
                                        
                                        <!-- Own API Info (hidden by default) -->
                                        <div id="own-api-info" class="mt-3 p-3 bg-orange-50 rounded border border-orange-200 hidden">
                                            <div class="flex items-center text-sm text-orange-700">
                                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                                <span>Using your own ElevenLabs API account</span>
                                            </div>
                                            <p class="text-xs text-gray-600 mt-1">
                                                You'll be billed directly by ElevenLabs. Recommended for high-volume usage or special requirements.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div id="api-key-section" class="hidden">
                                            <label for="elevenlabsApiKey" class="form-label">
                                                <span id="api-key-label">Your ElevenLabs API Key</span>
                                                <span class="text-xs text-orange-600 ml-1" id="api-key-required">(Required when using own API)</span>
                                            </label>
                                            <input type="password" id="elevenlabsApiKey" name="elevenlabsApiKey" 
                                                   class="form-input" placeholder="sk-..." autocomplete="new-password" disabled>
                                            <p class="text-xs text-gray-500 mt-1" id="api-key-help">
                                                Get your API key from <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank" class="text-blue-600 hover:underline">ElevenLabs Dashboard</a>
                                            </p>
                                        </div>
                                        
                                        <div id="subscription-info" class="hidden">
                                            <label class="form-label">Subscription Status</label>
                                            <div id="subscription-details" class="text-sm bg-gray-50 p-3 rounded border">
                                                <!-- Subscription info will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!-- Voice Selection & Preview -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gray-50 px-6 py-4 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-user-friends mr-2 text-purple-600"></i>Voice Selection & Preview
                                        <button type="button" id="refresh-voices" class="ml-auto text-sm bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded transition duration-150">
                                            <i class="fas fa-sync mr-1"></i>Refresh Voices
                                        </button>
                                    </h3>
                                </div>
                                
                                <!-- Current Saved Voice Status -->
                                <div id="current-voice-status" class="px-6 py-3 bg-blue-50 border-b border-blue-100">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fas fa-microphone-alt text-blue-600 mr-2"></i>
                                            <span class="text-sm font-medium text-gray-700">Currently Active Voice:</span>
                                            <span id="current-voice-name" class="ml-2 text-sm font-semibold text-blue-700">Not configured</span>
                                        </div>
                                        <span id="voice-save-indicator" class="text-xs text-gray-500 hidden">
                                            <i class="fas fa-check-circle text-green-500 mr-1"></i>Saved
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="p-6">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Voice Selection -->
                                        <div>
                                            <label for="voice-selector" class="form-label">Select Voice</label>
                                            <select id="voice-selector" name="voiceId" class="form-select mb-3">
                                                <option value="">Choose a voice...</option>
                                            </select>
                                            
                                            <!-- Voice Filters -->
                                            <div class="flex space-x-2 mb-4">
                                                <select id="voice-gender-filter" class="text-xs border border-gray-300 rounded px-2 py-1">
                                                    <option value="">All Genders</option>
                                                    <option value="male">Male</option>
                                                    <option value="female">Female</option>
                                                </select>
                                                <select id="voice-category-filter" class="text-xs border border-gray-300 rounded px-2 py-1">
                                                    <option value="">All Categories</option>
                                                    <option value="conversational">Conversational</option>
                                                    <option value="professional">Professional</option>
                                                    <option value="narration">Narration</option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Voice Preview & Info -->
                                        <div id="voice-preview-section" class="hidden">
                                            <label class="form-label">Voice Preview</label>
                                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                                <div id="voice-info" class="mb-3">
                                                    <!-- Voice details will be populated here -->
                                                </div>
                                                
                                                <div class="flex items-center space-x-2">
                                                    <button type="button" id="play-voice-sample" class="text-sm bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded transition duration-150">
                                                        <i class="fas fa-play mr-1"></i>Play Sample
                                                    </button>
                                                    <audio id="voice-preview-audio" controls class="hidden"></audio>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced Voice Settings -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gray-50 px-6 py-4 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-sliders-h mr-2 text-orange-600"></i>Advanced Voice Settings
                                        <button type="button" id="reset-voice-settings" class="ml-auto text-sm bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded transition duration-150">
                                            <i class="fas fa-undo mr-1"></i>Reset to Optimal
                                        </button>
                                    </h3>
                                </div>
                                
                                <div class="p-6">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Left Column: Voice Quality -->
                                        <div class="space-y-4">
                                            <h4 class="text-md font-semibold text-gray-700 border-b pb-2">Voice Quality</h4>
                                            
                                            <!-- Stability -->
                                            <div>
                                                <label for="voice-stability" class="form-label flex items-center justify-between">
                                                    Stability
                                                    <span id="stability-value" class="text-sm text-gray-500">0.5</span>
                                                </label>
                                                <input type="range" id="voice-stability" name="stability" 
                                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                       value="0.5" min="0.0" max="1.0" step="0.1" oninput="updateSliderValue('stability', this.value)">
                                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span>Variable (0.0)</span>
                                                    <span>Stable (1.0)</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Higher = more consistent, Lower = more expressive</p>
                                            </div>

                                            <!-- Similarity Boost -->
                                            <div>
                                                <label for="voice-similarity" class="form-label flex items-center justify-between">
                                                    Similarity Boost
                                                    <span id="similarity-value" class="text-sm text-gray-500">0.7</span>
                                                </label>
                                                <input type="range" id="voice-similarity" name="similarity_boost" 
                                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                       value="0.7" min="0.0" max="1.0" step="0.1" oninput="updateSliderValue('similarity', this.value)">
                                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span>Creative (0.0)</span>
                                                    <span>Accurate (1.0)</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Higher = more similar to original voice</p>
                                            </div>

                                            <!-- Style -->
                                            <div>
                                                <label for="voice-style" class="form-label flex items-center justify-between">
                                                    Style Exaggeration
                                                    <span id="style-value" class="text-sm text-gray-500">0.0</span>
                                                </label>
                                                <input type="range" id="voice-style" name="style" 
                                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                       value="0.0" min="0.0" max="1.0" step="0.1" oninput="updateSliderValue('style', this.value)">
                                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span>Natural (0.0)</span>
                                                    <span>Exaggerated (1.0)</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Higher = more expressive, can reduce quality</p>
                                            </div>
                                        </div>

                                        <!-- Right Column: Performance & Output -->
                                        <div class="space-y-4">
                                            <h4 class="text-md font-semibold text-gray-700 border-b pb-2">Performance & Output</h4>
                                            
                                            <!-- Speaker Boost -->
                                            <div>
                                                <label class="form-label">Speaker Boost</label>
                                                <div class="flex items-center space-x-3">
                                                    <input type="checkbox" id="voice-speaker-boost" name="use_speaker_boost" 
                                                           class="form-checkbox" checked onchange="updateCheckboxValue('speaker-boost', this.checked)">
                                                    <span class="text-sm text-gray-700">Enable speaker boost for better quality</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">Recommended for most use cases</p>
                                            </div>

                                            <!-- Model Selection -->
                                            <div>
                                                <label for="voice-model" class="form-label">AI Model</label>
                                                <select id="voice-model" name="model_id" class="form-select">
                                                    <option value="eleven_turbo_v2_5">Turbo v2.5 (Fastest)</option>
                                                    <option value="eleven_multilingual_v2">Multilingual v2 (Quality)</option>
                                                    <option value="eleven_monolingual_v1">Monolingual v1 (Classic)</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">Turbo recommended for real-time applications</p>
                                            </div>

                                            <!-- Output Format -->
                                            <div>
                                                <label for="voice-format" class="form-label">Output Format</label>
                                                <select id="voice-format" name="output_format" class="form-select">
                                                    <option value="mp3_44100_128">MP3 44.1kHz 128kbps (Recommended)</option>
                                                    <option value="mp3_44100_192">MP3 44.1kHz 192kbps (Higher Quality)</option>
                                                    <option value="pcm_16000">PCM 16kHz (Phone Quality)</option>
                                                    <option value="pcm_22050">PCM 22kHz (Good Quality)</option>
                                                    <option value="pcm_44100">PCM 44.1kHz (CD Quality)</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">MP3 recommended for web delivery</p>
                                            </div>

                                            <!-- Streaming Optimization -->
                                            <div>
                                                <label for="voice-latency" class="form-label">Streaming Latency</label>
                                                <select id="voice-latency" name="optimize_streaming_latency" class="form-select">
                                                    <option value="0">No optimization (Best Quality)</option>
                                                    <option value="1">Light optimization</option>
                                                    <option value="2">Moderate optimization</option>
                                                    <option value="3">High optimization</option>
                                                    <option value="4">Maximum optimization (Real-time)</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">Higher values reduce latency but may affect quality</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 🚀 SPEECH DETECTION SETTINGS (V85) -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gray-50 px-6 py-4 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-tachometer-alt mr-2 text-red-600"></i>Call Response Timing
                                        <span class="ml-2 text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full">CRITICAL FOR SPEED</span>
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Controls how fast the AI responds to callers. Lower values = faster responses.</p>
                                </div>
                                
                                <div class="p-6">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Left Column: Timing -->
                                        <div class="space-y-4">
                                            <h4 class="text-md font-semibold text-gray-700 border-b pb-2">Response Timing</h4>
                                            
                                            <!-- Speech Timeout -->
                                            <div>
                                                <label for="speech-timeout" class="form-label flex items-center justify-between">
                                                    Speech Timeout
                                                    <span id="speech-timeout-value" class="text-sm font-bold text-red-600">3s</span>
                                                </label>
                                                <input type="range" id="speech-timeout" name="speechTimeout" 
                                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                       value="3" min="1" max="5" step="0.5" 
                                                       oninput="document.getElementById('speech-timeout-value').textContent = this.value + 's'">
                                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span>Fast (1s)</span>
                                                    <span>Slow (5s)</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">
                                                    <strong>How long to wait after caller stops talking.</strong><br>
                                                    Lower = faster responses, but may cut off pauses.<br>
                                                    <span class="text-green-600 font-semibold">Recommended: 1.5-2s for natural conversation</span>
                                                </p>
                                            </div>

                                            <!-- Initial Timeout -->
                                            <div>
                                                <label for="initial-timeout" class="form-label flex items-center justify-between">
                                                    Initial Wait
                                                    <span id="initial-timeout-value" class="text-sm text-gray-500">5s</span>
                                                </label>
                                                <input type="range" id="initial-timeout" name="initialTimeout" 
                                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                       value="5" min="3" max="15" step="1"
                                                       oninput="document.getElementById('initial-timeout-value').textContent = this.value + 's'">
                                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span>Short (3s)</span>
                                                    <span>Long (15s)</span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">How long to wait for caller to START speaking after greeting.</p>
                                            </div>
                                        </div>

                                        <!-- Right Column: Interruption -->
                                        <div class="space-y-4">
                                            <h4 class="text-md font-semibold text-gray-700 border-b pb-2">Caller Interruption</h4>
                                            
                                            <!-- Barge-In Toggle -->
                                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <label for="barge-in-toggle" class="font-semibold text-gray-800">Allow Caller to Interrupt</label>
                                                        <p class="text-sm text-gray-600">Let callers speak over the AI (barge-in)</p>
                                                    </div>
                                                    <label class="relative inline-flex items-center cursor-pointer">
                                                        <input type="checkbox" id="barge-in-toggle" name="bargeIn" class="sr-only peer">
                                                        <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                                    </label>
                                                </div>
                                                <p class="text-xs text-yellow-700 mt-2">
                                                    <i class="fas fa-lightbulb mr-1"></i>
                                                    <strong>Recommended: ON</strong> — Makes conversations feel more natural. Callers don't have to wait for AI to finish.
                                                </p>
                                            </div>

                                            <!-- Speed Info Box -->
                                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                                <h5 class="font-semibold text-blue-800 mb-2"><i class="fas fa-info-circle mr-1"></i>Latency Impact</h5>
                                                <ul class="text-sm text-blue-700 space-y-1">
                                                    <li>• <strong>Speech Timeout 3s → 1.5s</strong> = Save 1.5s per turn</li>
                                                    <li>• <strong>Barge-In ON</strong> = Perceived 2s faster</li>
                                                    <li>• Combined: <strong>~3.5s faster per response</strong></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Test & Preview -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                <div class="border-b border-gray-200 bg-gray-50 px-6 py-4 rounded-t-lg">
                                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-vial mr-2 text-green-600"></i>Test & Preview
                                    </h3>
                                </div>
                                
                                <div class="p-6">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Test Input -->
                                        <div>
                                            <label for="test-text" class="form-label">Test Message</label>
                                            <textarea id="test-text" name="testText" rows="3" class="form-input" 
                                                      placeholder="Enter text to test voice synthesis...">Hello! Thanks for calling. How can I help you today?</textarea>
                                            
                                            <div class="flex items-center space-x-3 mt-3">
                                                <button type="button" id="test-voice-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">
                                                    <i class="fas fa-play mr-2"></i>Generate Test Audio
                                                </button>
                                                <button type="button" id="stream-test-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">
                                                    <i class="fas fa-broadcast-tower mr-2"></i>Stream Test
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Test Results -->
                                        <div>
                                            <label class="form-label">Test Results</label>
                                            <div id="test-results" class="bg-gray-50 border border-gray-200 rounded-lg p-4 min-h-[120px]">
                                                <div class="text-center text-gray-500 py-8">
                                                    <i class="fas fa-headphones text-2xl mb-2"></i>
                                                    <p>Test your voice settings to hear how they sound</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Save Settings -->
                            <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded-lg p-6">
                                <div>
                                    <h3 class="text-md font-semibold text-gray-800">Save Voice Configuration</h3>
                                    <p class="text-sm text-gray-600">Apply these settings to your AI agent</p>
                                </div>
                                <div class="flex space-x-3">
                                    <button type="button" id="save-voice-settings" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-150">
                                        <i class="fas fa-save mr-2"></i>Save Voice Settings
                                    </button>
                                </div>
                            </div>
                        </section>
                    </div>
                    <!-- ===== TAB SECTION END: AI VOICE ===== -->

                    <!-- Legacy personality responses tab content removed - using modern AI Agent Logic system -->
                    <!-- Legacy personality responses content removed -->
                            <!-- V2 DELETED: Legacy informational text about response customization - V2 uses aiAgentSettings system -->

                            <!-- V2 DELETED: Legacy Placeholder Management Section - V2 uses aiAgentSettings system -->
                            <!-- Placeholder functionality integrated into V2 aiAgentSettings response categories -->

                            <!-- V2 DELETED: Legacy Response Categories Management Section - V2 uses aiAgentSettings system -->
                            <!-- Response category functionality integrated into V2 aiAgentSettings response system -->
                            <form id="personality-responses-form">
                                <div id="personality-responses-list" class="space-y-4"></div>
                                <div class="mt-8 pt-5 border-t border-gray-200">
                                </div>
                            </form>
                        </section>
                    </div>

                    <!-- Add/Edit Category Modal -->
                    <div id="category-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
                        <div style="background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                            <div style="display: flex; align-items: center; justify-between; margin-bottom: 20px;">
                                <h3 id="category-modal-title" style="font-size: 24px; font-weight: 700; color: #2c3e50; margin: 0;">Add Category</h3>
                                <button onclick="instantResponseCategoriesManager.closeCategoryModal()" style="background: none; border: none; font-size: 24px; color: #95a5a6; cursor: pointer; padding: 0; width: 32px; height: 32px;">
                                    &times;
                                </button>
                            </div>
                            
                            <form onsubmit="event.preventDefault(); instantResponseCategoriesManager.saveCategoryModal();">
                                <div style="margin-bottom: 20px;">
                                    <label for="ir-category-name" style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                                        Category Name <span style="color: #e74c3c;">*</span>
                                    </label>
                                    <input type="text" id="ir-category-name" required
                                           placeholder="e.g., Empathy, Greetings, Customer Waiting"
                                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;">
                                    <small style="color: #7f8c8d; font-size: 13px;">Short, descriptive name for organizing responses</small>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label for="ir-category-description" style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                                        Description <span style="color: #e74c3c;">*</span>
                                    </label>
                                    <textarea id="ir-category-description" required rows="4"
                                              placeholder="Describe how AI should behave in this category..."
                                              style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; resize: vertical;"></textarea>
                                    <small style="color: #7f8c8d; font-size: 13px;">This guides AI when generating Q&As for this category</small>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                    <div>
                                        <label for="category-icon" style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                                            Icon
                                        </label>
                                        <input type="text" id="category-icon" value="⚡"
                                               placeholder="⚡"
                                               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 24px; text-align: center;">
                                        <small style="color: #7f8c8d; font-size: 13px;">Emoji or icon</small>
                                    </div>
                                    
                                    <div>
                                        <label for="category-color" style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                                            Color
                                        </label>
                                        <input type="color" id="category-color" value="#4F46E5"
                                               style="width: 100%; height: 48px; padding: 4px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                        <small style="color: #7f8c8d; font-size: 13px;">Visual identifier</small>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                    <button type="button" onclick="instantResponseCategoriesManager.closeCategoryModal()"
                                            style="padding: 12px 24px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; font-weight: 600; color: #7f8c8d; cursor: pointer;">
                                        Cancel
                                    </button>
                                    <button type="submit" id="save-category-btn"
                                            style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; font-weight: 600; color: white; cursor: pointer;">
                                        <i class="fas fa-save mr-2"></i>Save Category
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Add/Edit Q&A Modal (MEGA FORM) -->
                    <div id="qna-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
                        <div style="background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 95vh; overflow-y: auto; padding: 40px; box-shadow: 0 25px 80px rgba(0,0,0,0.4);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #f0f0f0;">
                                <h3 id="qna-modal-title" style="font-size: 28px; font-weight: 800; color: #1a1a1a; margin: 0; display: flex; align-items: center; gap: 12px;">
                                    <span>Add Q&A</span>
                                </h3>
                                <button onclick="instantResponseCategoriesManager.closeQnAModal()" style="background: none; border: none; font-size: 32px; color: #999; cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;">
                                    &times;
                                </button>
                            </div>
                            
                            <form id="ir-qna-form" onsubmit="event.preventDefault(); instantResponseCategoriesManager.saveQnAModal();">
                                <!-- TRIGGER VARIATIONS SECTION -->
                                <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border: 2px solid #667eea40; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                                    <h4 style="font-size: 18px; font-weight: 700; color: #667eea; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-bolt"></i> Trigger Phrases
                                    </h4>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 14px;">
                                            Main Trigger <span style="color: #e74c3c;">*</span>
                                        </label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="text" id="qna-main-trigger" required
                                                   placeholder="e.g., I'm frustrated, please hold, thank you"
                                                   style="flex: 1; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; font-weight: 500;">
                                            <button type="button" onclick="instantResponseCategoriesManager.generateTriggerVariations()" 
                                                    style="padding: 14px 24px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; font-weight: 700; color: white; cursor: pointer; white-space: nowrap; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                                                <i class="fas fa-magic mr-2"></i>Generate 8 Variations
                                            </button>
                                        </div>
                                        <small style="color: #7f8c8d; font-size: 13px; display: block; margin-top: 5px;">
                                        </small>
                                    </div>
                                    
                                    <div id="variations-container" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px dashed #d0d0d0;">
                                        <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 12px; font-size: 14px;">
                                        </label>
                                        <div id="variations-list" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
                                            <!-- Variations will be inserted here -->
                                        </div>
                                        <button type="button" onclick="instantResponseCategoriesManager.addVariation()" 
                                                style="padding: 10px 20px; border: 2px dashed #667eea; background: white; border-radius: 8px; font-weight: 600; color: #667eea; cursor: pointer;">
                                            <i class="fas fa-plus mr-2"></i>Add Variation
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- RESPONSE SECTION -->
                                <div style="background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                                    <h4 style="font-size: 18px; font-weight: 700; color: #2c3e50; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-comment-dots"></i> AI Response
                                    </h4>
                                    
                                    <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 14px;">
                                        What should AI say? <span style="color: #e74c3c;">*</span>
                                    </label>
                                    <textarea id="qna-response" required rows="4"
                                              placeholder="e.g., I completely understand your frustration. Let me help you get this resolved right away."
                                              style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; resize: vertical; line-height: 1.6;"></textarea>
                                    
                                    <!-- AI SUGGEST RESPONSE BUTTON -->
                                    <button type="button" onclick="instantResponseCategoriesManager.suggestAIResponseForModal()" 
                                            style="margin-top: 10px; padding: 10px 20px; border: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 8px; font-weight: 700; color: white; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-magic"></i>
                                        AI Suggest Response (3 variations)
                                    </button>
                                    
                                    <small style="color: #7f8c8d; font-size: 13px; display: block; margin-top: 8px;">
                                    </small>
                                </div>
                                
                                <!-- ADVANCED BEHAVIOR (Collapsible) -->
                                <div id="advanced-section" style="border: 2px solid #ffd70020; border-radius: 12px; margin-bottom: 25px; overflow: hidden;">
                                    <button type="button" onclick="instantResponseCategoriesManager.toggleAdvanced()" 
                                            style="width: 100%; padding: 20px 25px; background: linear-gradient(135deg, #ffd70015 0%, #ff850015 100%); border: none; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                        <span style="font-size: 16px; font-weight: 700; color: #f39c12; display: flex; align-items: center; gap: 10px;">
                                            <i class="fas fa-cog"></i> Advanced Behavior (Optional - For Complex Scenarios)
                                        </span>
                                        <i id="advanced-toggle-icon" class="fas fa-chevron-down" style="color: #f39c12; font-size: 14px;"></i>
                                    </button>
                                    
                                    <div id="advanced-content" style="display: none; padding: 25px; background: white;">
                                        <!-- TIMING & FOLLOW-UP -->
                                        <div style="margin-bottom: 25px;">
                                            <h5 style="font-size: 16px; font-weight: 700; color: #e67e22; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                                <i class="fas fa-clock"></i> Timing & Follow-Up
                                            </h5>
                                            
                                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer;">
                                                <input type="checkbox" id="qna-timing-enabled" 
                                                       style="width: 20px; height: 20px; cursor: pointer;">
                                                <span style="font-weight: 600; color: #2c3e50;">Enable follow-up after silence</span>
                                            </label>
                                            
                                            <div id="timing-options" style="display: none; padding-left: 30px; border-left: 3px solid #e67e22; margin-left: 10px;">
                                                <div style="display: grid; grid-template-columns: 150px 1fr; gap: 15px; align-items: center; margin-bottom: 15px;">
                                                    <label style="font-weight: 600; color: #555; font-size: 14px;">Wait Duration:</label>
                                                    <input type="number" id="qna-wait-seconds" value="90" min="10" max="600"
                                                           style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                                </div>
                                                
                                                <div style="margin-bottom: 15px;">
                                                    <label style="display: block; font-weight: 600; color: #555; margin-bottom: 8px; font-size: 14px;">Follow-up Message:</label>
                                                    <textarea id="qna-followup-message" rows="2" placeholder="e.g., Excuse me, are you ready? I'm still here to help!"
                                                              style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;"></textarea>
                                                </div>
                                                
                                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer;">
                                                    <input type="checkbox" id="qna-second-followup" 
                                                           style="width: 18px; height: 18px; cursor: pointer;">
                                                    <span style="font-weight: 600; color: #2c3e50; font-size: 14px;">Enable 2nd follow-up</span>
                                                </label>
                                                
                                                <div id="second-followup-options" style="display: none; margin-left: 28px;">
                                                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 15px; align-items: center; margin-bottom: 15px;">
                                                        <label style="font-weight: 600; color: #555; font-size: 14px;">Wait Duration:</label>
                                                        <input type="number" id="qna-second-wait" value="120" min="10" max="600"
                                                               style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                                    </div>
                                                    
                                                    <div>
                                                        <label style="display: block; font-weight: 600; color: #555; margin-bottom: 8px; font-size: 14px;">2nd Follow-up Message:</label>
                                                        <textarea id="qna-second-message" rows="2" placeholder="e.g., I'm still here whenever you're ready!"
                                                                  style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- CONTEXT AWARENESS -->
                                        <div style="margin-bottom: 25px;">
                                            <h5 style="font-size: 16px; font-weight: 700; color: #3498db; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                                <i class="fas fa-brain"></i> Context Awareness
                                            </h5>
                                            
                                            <label style="display: flex; align-items: start; gap: 12px; cursor: pointer; padding: 15px; background: #ecf0f1; border-radius: 8px;">
                                                <input type="checkbox" id="qna-context-aware" 
                                                       style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px;">
                                                <div>
                                                    <span style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 5px;">Remember conversation context</span>
                                                    <small style="color: #7f8c8d; font-size: 13px; line-height: 1.5;">
                                                        AI will personalize this response based on what was discussed earlier in the conversation
                                                        <br>Example: If discussing pricing, AI might say "Take your time reviewing the pricing..."
                                                    </small>
                                                </div>
                                            </label>
                                        </div>
                                        
                                        <!-- PRIORITY -->
                                        <div>
                                            <h5 style="font-size: 16px; font-weight: 700; color: #9b59b6; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                                                <i class="fas fa-sort-amount-down"></i> Priority
                                            </h5>
                                            
                                            <div style="background: #ecf0f1; border-radius: 8px; padding: 15px;">
                                                <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 14px;">
                                                    Match Priority: <span id="qna-priority-display" style="color: #9b59b6; font-size: 18px;">50</span>
                                                </label>
                                                <input type="range" id="qna-priority" min="1" max="100" value="50" 
                                                       style="width: 100%; height: 8px; cursor: pointer;">
                                                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                                    <small style="color: #7f8c8d; font-size: 12px;">Low (checked last)</small>
                                                    <small style="color: #7f8c8d; font-size: 12px;">High (checked first)</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- STATUS & NOTES -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                                    <div>
                                        <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 14px;">
                                            Status
                                        </label>
                                        <select id="qna-enabled" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; cursor: pointer;">
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 14px;">
                                            Keywords <small style="color: #95a5a6; font-weight: 400;">(Auto-generated)</small>
                                        </label>
                                        <div id="qna-keywords-display" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f8f9fa; min-height: 48px; font-size: 13px; color: #7f8c8d; display: flex; align-items: center;">
                                            Keywords will be generated automatically
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 25px;">
                                    <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 14px;">
                                        Notes <small style="color: #95a5a6; font-weight: 400;">(Optional - Internal use only)</small>
                                    </label>
                                    <textarea id="qna-notes" rows="2" placeholder="Any special instructions or notes about this Q&A..."
                                              style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                                </div>
                                
                                <!-- SUBMIT BUTTONS -->
                                <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                                    <button type="button" onclick="instantResponseCategoriesManager.closeQnAModal()"
                                            style="padding: 14px 28px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; font-weight: 600; color: #7f8c8d; cursor: pointer; font-size: 15px;">
                                        Cancel
                                    </button>
                                    <button type="submit" id="save-qna-btn"
                                            style="padding: 14px 32px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; font-weight: 700; color: white; cursor: pointer; font-size: 15px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                                        <i class="fas fa-save mr-2"></i>Save Q&A
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    

                    <!-- Add/Edit Response Category Modal -->
                    <div id="response-category-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
                        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                            <div class="mt-3">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-medium text-gray-900" id="response-category-modal-title">Add Response Category</h3>
                                    <button type="button" class="text-gray-400 hover:text-gray-600" id="close-response-category-modal">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <form id="response-category-form">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label for="response-category-key" class="block text-sm font-medium text-gray-700 mb-2">
                                                Category Key <span class="text-red-500">*</span>
                                            </label>
                                            <input type="text" id="response-category-key" name="response-category-key" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                                   placeholder="e.g., greeting, pricing, support" required>
                                            <p class="text-xs text-gray-500 mt-1">Lowercase, no spaces (used for identification)</p>
                                        </div>
                                        <div>
                                            <label for="response-category-label" class="block text-sm font-medium text-gray-700 mb-2">
                                                Display Label <span class="text-red-500">*</span>
                                            </label>
                                            <input type="text" id="response-category-label" name="response-category-label" 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                                   placeholder="e.g., Greeting Response" required>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="response-category-icon" class="block text-sm font-medium text-gray-700 mb-2">
                                            Icon Class
                                        </label>
                                        <input type="text" id="response-category-icon" name="response-category-icon" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                               placeholder="e.g., fas fa-hand-wave">
                                        <p class="text-xs text-gray-500 mt-1">FontAwesome icon class (optional)</p>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="response-category-description" class="block text-sm font-medium text-gray-700 mb-2">
                                            Description
                                        </label>
                                        <textarea id="response-category-description" name="response-category-description" 
                                                  rows="2"
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                                  placeholder="Brief description of when this response is used"></textarea>
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label for="response-category-default" class="block text-sm font-medium text-gray-700 mb-2">
                                            Default Response Template
                                        </label>
                                        <textarea id="response-category-default" name="response-category-default" 
                                                  rows="3"
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                                  placeholder="Enter the default response template (you can use placeholders like {companyname})"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">Use placeholders like {companyname} for dynamic content</p>
                                    </div>
                                    
                                    <div class="flex justify-end space-x-3">
                                        <button type="button" id="cancel-response-category" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                                            Cancel
                                        </button>
                                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">
                                            <span id="response-category-submit-text">Add Category</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Legacy personality responses section completely removed -->

                    <!-- ============================================================================== -->
                    <!-- ===== TAB SECTION START: AI AGENT SETTINGS (NEW, MODERN, ISOLATED) ===== -->
                    <!-- ============================================================================== -->
                    -->
                    <!-- ============================================================================== -->
                    <div id="ai-agent-settings-content" class="tab-content-item hidden">
                        
                        <!-- Link isolated CSS -->
                        <link rel="stylesheet" href="/css/ai-agent-settings.css">
                        <link rel="stylesheet" href="/css/diagnostic-modal.css">
                        <link rel="stylesheet" href="/css/twilio-control-center.css">
                        <link rel="stylesheet" href="/css/voicecore.css">
                        <link rel="stylesheet" href="/css/system-diagnostics.css">
                        <link rel="stylesheet" href="/css/spam-filter.css">
                        
                        <div class="ai-settings-container">
                            
                            <!-- ========================================== -->
                            <!-- VOICECORE - AI VOICE & GREETINGS -->
                            <!-- ========================================== -->
                            <div class="voicecore-panel">
                                
                                <!-- Tab Navigation -->
                                <nav class="voicecore-tabs">
                                    <button class="voicecore-tab active" data-voicecore-tab="dashboard">
                                        <i class="fas fa-tachometer-alt"></i>
                                        Dashboard
                                    </button>
                                    <button class="voicecore-tab" data-voicecore-tab="messages">
                                        <i class="fas fa-comments"></i>
                                        Messages & Greetings
                                    </button>
                                    <button class="voicecore-tab" data-voicecore-tab="logs" disabled style="opacity: 0.5; cursor: not-allowed;">
                                        <i class="fas fa-list"></i>
                                        Call Logs
                                        <span style="font-size: 10px; background: #6c757d; color: white; padding: 2px 6px; border-radius: 8px; margin-left: 4px;">Soon</span>
                                    </button>
                                    <!-- LLM-0 Controls MOVED to Control Plane → Live Agent Status -->
                                </nav>
                                
                                <!-- Tab 1: Dashboard (Twilio Control Center) -->
                                <div class="voicecore-tab-content active" id="tab-dashboard">
                                    <!-- System Diagnostics Panel -->
                                    <div id="system-diagnostics-panel">
                                        <!-- System Diagnostics will be loaded here by JavaScript -->
                                    </div>

                                    <div id="twilio-control-center">
                                        <!-- Twilio Control Center will be loaded here by JavaScript -->
                                        <div class="voicecore-loading">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <p>Loading Twilio Control Center...</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tab 2: Messages & Greetings -->
                                <div class="voicecore-tab-content" id="tab-messages">
                                    <div id="connection-messages-container">
                                        <!-- Connection Messages UI will be loaded here by JavaScript -->
                                        <div class="voicecore-loading">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <p>Loading Connection Messages...</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tab 3: Call Logs (Future) -->
                                <div class="voicecore-tab-content" id="tab-logs">
                                    <div class="voicecore-empty-state">
                                        <i class="fas fa-list"></i>
                                        <h4>Call Logs Coming Soon</h4>
                                        <p>Detailed call history, transcripts, and analytics will be available here</p>
                                    </div>
                                </div>
                                
                                <!-- LLM-0 Controls MOVED to Control Plane → Live Agent Status -->
                                
                            </div>
                            
                            <!-- ========================================== -->
                            <!-- MISSION CONTROL DASHBOARD (REDESIGNED) -->
                            <!-- ========================================== -->
                            <div id="ai-settings-status-banner" class="ai-settings-mission-control">
                                <div class="mission-control-header">
                                    <div class="mission-control-icon">
                                        <svg class="progress-ring" width="120" height="120">
                                            <circle class="progress-ring-bg" cx="60" cy="60" r="54" />
                                            <circle class="progress-ring-circle" cx="60" cy="60" r="54" id="progress-ring-circle" />
                                            <text x="60" y="60" class="progress-ring-text" id="progress-ring-text" text-anchor="middle" dy=".3em">0%</text>
                                        </svg>
                                    </div>
                                    <div class="mission-control-details">
                                        <div class="mission-status">
                                            <h3 class="ai-settings-status-text">Loading configuration...</h3>
                                            <p class="mission-subtitle">Checking system readiness...</p>
                                        </div>
                                        <div class="mission-stats">
                                            <div class="stat-item clickable" 
                                                 onclick="aiAgentSettings.showDiagnostics('templates')"
                                                 title="Click for detailed diagnostics">
                                                <div class="stat-icon">📋</div>
                                                <div class="stat-content">
                                                    <span class="stat-value" id="stat-templates">-</span>
                                                    <span class="stat-label">Templates</span>
                                                </div>
                                                <div class="stat-chevron">›</div>
                                            </div>
                                            <div class="stat-item clickable" 
                                                 onclick="aiAgentSettings.showDiagnostics('variables')"
                                                 title="Click for detailed diagnostics">
                                                <div class="stat-icon">🔧</div>
                                                <div class="stat-content">
                                                    <span class="stat-value" id="stat-variables">-</span>
                                                    <span class="stat-label">Variables</span>
                                                </div>
                                                <div class="stat-chevron">›</div>
                                            </div>
                                            <div class="stat-item clickable" 
                                                 onclick="aiAgentSettings.showDiagnostics('twilio')"
                                                 title="Click for detailed diagnostics">
                                                <div class="stat-icon">📞</div>
                                                <div class="stat-content">
                                                    <span class="stat-value" id="stat-twilio">-</span>
                                                    <span class="stat-label">Twilio</span>
                                                </div>
                                                <div class="stat-chevron">›</div>
                                            </div>
                                            <div class="stat-item clickable" 
                                                 onclick="aiAgentSettings.showDiagnostics('voice')"
                                                 title="Click for detailed diagnostics">
                                                <div class="stat-icon">🎙️</div>
                                                <div class="stat-content">
                                                    <span class="stat-value" id="stat-voice">-</span>
                                                    <span class="stat-label">Voice</span>
                                                </div>
                                                <div class="stat-chevron">›</div>
                                            </div>
                                            <div class="stat-item clickable" 
                                                 onclick="aiAgentSettings.showDiagnostics('scenarios')"
                                                 title="Click for detailed diagnostics">
                                                <div class="stat-icon">🎭</div>
                                                <div class="stat-content">
                                                    <span class="stat-value" id="stat-scenarios">-</span>
                                                    <span class="stat-label">Scenarios</span>
                                                </div>
                                                <div class="stat-chevron">›</div>
                                            </div>
                                            <div class="stat-item clickable" 
                                                 onclick="aiAgentSettings.showDiagnostics('cheatsheet')"
                                                 title="Click for detailed diagnostics">
                                                <div class="stat-icon">📖</div>
                                                <div class="stat-content">
                                                    <span class="stat-value" id="stat-cheatsheet">-</span>
                                                    <span class="stat-label">CheatSheet</span>
                                                </div>
                                                <div class="stat-chevron">›</div>
                                            </div>
                                            <div class="stat-item clickable" 
                                                 onclick="aiAgentSettings.showDiagnostics('frontline-intel')"
                                                 title="Click for detailed diagnostics">
                                                <div class="stat-icon">📝</div>
                                                <div class="stat-content">
                                                    <span class="stat-value" id="stat-frontline-intel">-</span>
                                                    <span class="stat-label">Frontline-Intel</span>
                                                </div>
                                                <div class="stat-chevron">›</div>
                                            </div>
                                            <div class="stat-item clickable" 
                                                 onclick="aiAgentSettings.showDiagnostics('tier-settings')"
                                                 title="Click for detailed diagnostics">
                                                <div class="stat-icon">🎯</div>
                                                <div class="stat-content">
                                                    <span class="stat-value" id="stat-tier-settings">-</span>
                                                    <span class="stat-label">3-Tier Settings</span>
                                                </div>
                                                <div class="stat-chevron">›</div>
                                            </div>
                                            <div class="stat-item clickable" 
                                                 onclick="aiAgentSettings.showDiagnostics('tier-llm')"
                                                 title="Click for detailed diagnostics">
                                                <div class="stat-icon">🤖</div>
                                                <div class="stat-content">
                                                    <span class="stat-value" id="stat-tier-llm">-</span>
                                                    <span class="stat-label">3-Tier LLM</span>
                                                </div>
                                                <div class="stat-chevron">›</div>
                                            </div>
                                            <div class="stat-item clickable" 
                                                 onclick="aiAgentSettings.showDiagnostics('brain-llm')"
                                                 title="Click for detailed diagnostics">
                                                <div class="stat-icon">🧠</div>
                                                <div class="stat-content">
                                                    <span class="stat-value" id="stat-brain-llm">-</span>
                                                    <span class="stat-label">Brain LLM</span>
                                                </div>
                                                <div class="stat-chevron">›</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mission-control-actions">
                                        <button 
                                            id="ai-settings-go-live-btn" 
                                            class="go-live-btn" 
                                            onclick="aiAgentSettings.goLive()"
                                            disabled>
                                            <span class="btn-icon">🔒</span>
                                            <span class="btn-text">Cannot Go Live</span>
                                        </button>
                                        <div class="go-live-hint" id="go-live-hint">
                                            Fix blockers below to enable
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ========================================== -->
                            <!-- ACTION CENTER (BLOCKERS - REDESIGNED) -->
                            <!-- ========================================== -->
                            <div id="ai-settings-blockers" class="action-center" style="display: none;"></div>
                            
                            <!-- ========================================== -->
                            <!-- GO LIVE SETTINGS -->
                            <!-- ========================================== -->
                            <div class="ai-settings-section" style="margin-top: 2rem;">
                                <div class="section-header">
                                    <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span>📞</span>
                                        <span>Pre-Activation Message</span>
                                    </h3>
                                    <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">
                                        What callers hear when they call BEFORE you click "Go Live"
                                    </p>
                                </div>
                                <div class="section-content" style="margin-top: 1rem;">
                                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                        <label for="pre-activation-message" style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151;">
                                            Message Text
                                        </label>
                                        <textarea
                                            id="pre-activation-message"
                                            rows="4"
                                            style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-family: inherit; font-size: 0.875rem; resize: vertical;"
                                            placeholder="Thank you for calling {companyName}. Our AI receptionist is currently being configured..."
                                        ></textarea>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.75rem;">
                                            <div style="font-size: 0.75rem; color: #6b7280;">
                                                💡 Tip: Use <code>{companyName}</code> to insert your company name
                                            </div>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button
                                                    id="reset-pre-activation-message-btn"
                                                    onclick="aiAgentSettings.resetPreActivationMessage()"
                                                    style="padding: 0.5rem 1rem; background: #6b7280; color: white; border: none; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer;">
                                                    Reset to Default
                                                </button>
                                                <button
                                                    id="save-pre-activation-message-btn"
                                                    onclick="aiAgentSettings.savePreActivationMessage()"
                                                    style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer;">
                                                    Save Message
                                                </button>
                                            </div>
                                        </div>
                                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.375rem; font-size: 0.875rem; color: #1e40af;">
                                            <strong>📞 Preview:</strong> This message will play when someone calls your Twilio number before you activate the AI Agent. Use this to direct callers to an alternate number or inform them when the service will be ready.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ========================================== -->
                            <!-- AICORE CONTROL CENTER TITLE -->
                            <!-- ========================================== -->
                            <div class="my-8 p-6 bg-blue-600 rounded-xl shadow-lg">
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 bg-blue-700 rounded-2xl flex items-center justify-center text-4xl">
                                        🤖
                                    </div>
                                    <div class="flex-1">
                                        <h2 class="text-3xl font-bold text-white">
                                            AiCore Control Center
                                        </h2>
                                        <p class="text-sm text-white mt-1 font-medium">
                                            Mission Control for Your AI Agent • Variables • Logic • Knowledge • Performance
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ========================================== -->
                            <!-- AICORE CONTROL CENTER BUTTON -->
                            <!-- ========================================== -->
                            <div class="mt-4 mb-6 rounded-xl border-2 border-indigo-200 bg-gradient-to-r from-indigo-50 to-blue-50 p-4 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                                            <span class="text-2xl">🎛️</span>
                                            Advanced AiCore Control Center
                                        </h3>
                                        <p class="text-sm text-slate-600 mt-1">
                                            Open the full AiCore Control Plane for this company's brain configuration: booking rules, guardrails, behavior, knowledge routing, and CompanyOps.
                                        </p>
                                    </div>
                                    <button
                                        id="open-aicore-control-plane-btn"
                                        class="ml-4 inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white shadow-md hover:bg-indigo-700 hover:shadow-lg transition-all duration-200"
                                        type="button">
                                        <i class="fas fa-external-link-alt"></i>
                                        <span>Open Control Center</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ========================================== -->
                            <!-- V1 AICORE UI REMOVED (Phase D) -->
                            <!-- Variables, Templates, Scenarios, Cheat Sheet, etc. moved to Control Plane V2 -->
                            <!-- ========================================== -->
                            
                                </div>
                                
                        <!-- Load AI Agent Settings Managers (Customer-Facing Only) -->
                        <script src="/js/ai-agent-settings/AIAgentSettingsManager.js?v=5.3"></script>
                        <script src="/js/ai-agent-settings/SystemDiagnostics.js?v=1.0"></script>
                        <script src="/js/ai-agent-settings/VoiceCoreTabManager.js?v=7.0"></script>
                        <script src="/js/ai-agent-settings/TwilioControlCenter.js?v=5.0"></script>
                        <script src="/js/ai-agent-settings/ConnectionMessagesManager.js?v=13.0"></script>
                        <script src="/js/ai-agent-settings/SpamFilterManager.js?v=1.0"></script>
                        <script src="/js/ai-agent-settings/LLM0ControlsManager.js?v=1.0"></script>
                        <!-- V2 Navigator - for diagnostic "Fix Now" buttons -->
                        <script src="/js/control-plane-v2-navigator.js?v=1.0"></script>
                        
                        <!-- Load Voice Settings Manager -->
                        <script src="/js/ai-voice-settings/VoiceSettingsManager.js?v=1.0"></script>
                        
                        <script>
                            // AI Agent Settings initialization is now handled by company-profile-modern.js switchTab() method
                            // This ensures proper initialization when tab is activated via click or hash navigation
                        </script>
                        
                    </div>
                    <!-- ===== TAB SECTION END: AI AGENT SETTINGS ===== -->
                    <!-- ============================================================================== -->

                    <!-- ============================================================================== -->
                    <!-- ===== TAB SECTION START: SPAM FILTER ===== -->
                    <!-- ============================================================================== -->
                    <div id="spam-filter-content" class="tab-content-item hidden">
                        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            
                            <!-- Header -->
                            <div class="mb-8">
                                <h2 class="text-3xl font-bold text-gray-900 mb-2">
                                    <i class="fas fa-shield-alt text-red-500"></i>
                                    Smart Call Filter
                                </h2>
                                <p class="text-gray-600">
                                    Protect your AI agent from spam and robocalls with intelligent multi-layer detection
                                </p>
                            </div>

                            <!-- Spam Filter Dashboard Container -->
                            <div id="spam-filter-dashboard-container">
                                <!-- Content will be dynamically loaded by SpamFilterManager.js -->
                            </div>

                        </div>
                    </div>
                    <!-- ===== TAB SECTION END: SPAM FILTER ===== -->
                    <!-- ============================================================================== -->

    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    <!-- PLATFORM SNAPSHOT MODAL - Provider Health + DB Echo (NOT runtime truth) -->
    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    <div id="truth-report-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div style="background-color: #1e293b; color: #f1f5f9; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); width: 100%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-slate-800 text-white rounded-t-xl">
                <div class="flex items-center gap-3">
                    <i class="fas fa-file-code text-xl"></i>
                    <div>
                        <h2 class="text-lg font-bold">Platform Snapshot</h2>
                        <p class="text-xs text-slate-300">Provider health + DB echo (not runtime). Runtime Truth is canonical.</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="open-runtime-truth-btn" onclick="openRuntimeTruthCanonical()" class="px-3 py-1.5 text-sm bg-emerald-700 hover:bg-emerald-600 rounded-md transition-colors flex items-center gap-2"
                            title="Open Runtime Truth (Canonical) — what the agent will execute on calls. Source: /api/company/:companyId/runtime-truth">
                        <i class="fas fa-gavel"></i>
                        Open Runtime Truth (Canonical)
                        <i class="fas fa-info-circle" style="opacity: 0.85;" title="Runtime Truth = canonical enforcement report. Use this to judge what the agent will do on calls."></i>
                    </button>
                    <button onclick="refreshTruthReport()" class="px-3 py-1.5 text-sm bg-slate-600 hover:bg-slate-500 rounded-md transition-colors flex items-center gap-2">
                        <i class="fas fa-sync-alt" id="truth-refresh-icon"></i>
                        Refresh
                    </button>
                    <button id="copy-json-btn" onclick="copyTruthReport()" 
                            class="px-3 py-1.5 text-sm bg-indigo-600 hover:bg-indigo-500 rounded-md transition-all flex items-center gap-2"
                            style="transform: scale(1); box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                        <i id="copy-json-icon" class="fas fa-copy"></i>
                        <span id="copy-json-text">Copy JSON</span>
                    </button>
                    <button id="download-json-btn" onclick="downloadPlatformSnapshotBundle()" 
                            class="px-3 py-1.5 text-sm bg-slate-700 hover:bg-slate-600 rounded-md transition-all flex items-center gap-2"
                            title="Download JSON files (Platform Snapshot + Runtime Truth + DB Echo)">
                        <i class="fas fa-download"></i>
                        Download .json
                    </button>
                    <button onclick="closeTruthReport()" class="p-2 hover:bg-slate-600 rounded-md transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Body - SCROLLABLE -->
            <div class="flex-1 overflow-y-auto flex flex-col" style="max-height: calc(90vh - 140px);">
                <!-- Focused Health Panel -->
                <div id="truth-health-panel" style="padding: 16px 24px; background-color: #334155; border-bottom: 1px solid #475569;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <i class="fas fa-heartbeat" style="color: #94a3b8;"></i>
                        <span style="font-weight: 600; color: #f1f5f9;">Focused Health</span>
                        <span id="truth-health-status" style="margin-left: auto; padding: 4px 10px; font-size: 11px; font-weight: 700; border-radius: 12px; background-color: #475569; color: #f1f5f9;">Loading...</span>
                    </div>
                    <!-- Harmony Lock: Snapshot vs Runtime Truth effective config -->
                    <div id="truth-drift-banner" style="display:none; margin-bottom: 12px; padding: 10px 12px; border-radius: 10px; border: 1px solid #f59e0b; background: rgba(245, 158, 11, 0.12); color: #fde68a; font-size: 12px;">
                        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>DRIFT DETECTED</strong>
                            </div>
                            <div style="color:#e2e8f0;">
                                Platform Snapshot effectiveConfigVersion != Runtime Truth effectiveConfigVersion.
                                Snapshot may be stale or computed from different inputs than runtime.
                            </div>
                            <button onclick="refreshTruthReport()" style="margin-left:auto; padding: 6px 10px; border-radius: 8px; border: 1px solid #f59e0b; background: #f59e0b; color: #1e293b; font-weight: 700; cursor: pointer;">
                                Recompute Snapshot
                            </button>
                        </div>
                        <div style="margin-top: 6px; color:#cbd5e1;">
                            snapshot: <code id="truth-ecv-snapshot" style="background:#0b1220;padding:2px 6px;border-radius:6px;"></code>
                            · runtime: <code id="truth-ecv-runtime" style="background:#0b1220;padding:2px 6px;border-radius:6px;"></code>
                        </div>
                    </div>
                    <!-- EXPLAIN WHY NOT GREEN - Runtime Truth blockers -->
                    <div id="truth-why-not-green-banner" style="display:none; margin-bottom: 12px; padding: 12px 14px; border-radius: 10px; border: 1px solid #ef4444; background: rgba(239, 68, 68, 0.12); color: #fecaca; font-size: 12px;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom: 8px;">
                            <i class="fas fa-gavel"></i>
                            <strong id="truth-why-not-green-title">EXPLAIN WHY NOT GREEN</strong>
                            <span id="truth-why-not-green-status" style="margin-left: auto; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; background: #dc2626; color: #fff;">RED</span>
                        </div>
                        <div id="truth-why-not-green-summary" style="color:#e2e8f0; margin-bottom: 8px;"></div>
                        <div id="truth-why-not-green-blockers" style="background: rgba(0,0,0,0.2); padding: 10px 12px; border-radius: 6px; font-family: monospace; font-size: 11px;">
                            <!-- Blockers will be inserted here -->
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; font-size: 14px;" id="truth-health-grid">
                        <!-- Health metrics will be inserted here -->
                        <div style="padding: 12px; background-color: #475569; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8;">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Write Test Panel -->
                <div style="padding: 12px 24px; background-color: #78350f; border-bottom: 1px solid #92400e;">
                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <i class="fas fa-flask" style="color: #fbbf24;"></i>
                        <span style="font-weight: 600; color: #fef3c7; font-size: 14px;">Write Tests</span>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                            <button onclick="writeTestGreeting()" 
                                    style="padding: 8px 14px; font-size: 12px; background-color: #f59e0b; color: #1e293b; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-comment" id="write-test-greeting-icon"></i> Greeting
                            </button>
                            <button onclick="writeTestDynamicFlow()" 
                                    style="padding: 8px 14px; font-size: 12px; background-color: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-project-diagram" id="write-test-flow-icon"></i> New Flow
                            </button>
                            <button onclick="cleanupTestFlows()" 
                                    style="padding: 8px 14px; font-size: 12px; background-color: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer;"
                                    title="Delete test flows">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="write-test-result" style="margin-top: 8px; font-size: 12px; display: none;"></div>
                </div>
                
                <!-- Fix Legacy Flows Panel -->
                <div style="padding: 12px 24px; background-color: #581c87; border-bottom: 1px solid #7c3aed;">
                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <i class="fas fa-wrench" style="color: #c4b5fd;"></i>
                        <span style="font-weight: 600; color: #f3e8ff; font-size: 14px;">Fix Legacy Flows</span>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                            <select id="legacy-flow-selector" style="padding: 8px 12px; font-size: 12px; border: 2px solid #a855f7; border-radius: 6px; background-color: #1e293b; color: #f1f5f9;">
                                <option value="">Loading...</option>
                            </select>
                            <button onclick="convertFlowToV2()" 
                                    style="padding: 8px 14px; font-size: 12px; background-color: #a855f7; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-magic" id="convert-flow-icon"></i> Convert to V2
                            </button>
                        </div>
                    </div>
                    <div id="convert-result" style="margin-top: 8px; font-size: 12px; display: none;"></div>
                </div>
                
                <!-- Manual Save Panel - DARK THEME -->
                <div style="padding: 16px 24px; background-color: #14532d; border-bottom: 2px solid #22c55e;">
                    <div style="font-size: 14px; font-weight: 700; color: #86efac; margin-bottom: 12px;">
                        <i class="fas fa-keyboard" style="margin-right: 8px;"></i>Manual Save (Direct to DB)
                    </div>
                    
                    <!-- Greeting Input -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 12px; font-weight: 600; color: #86efac; margin-bottom: 6px;">Greeting</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="manual-greeting-input" 
                                   style="flex: 1; padding: 10px 14px; font-size: 14px; border: 2px solid #22c55e; border-radius: 6px; color: #1e293b; background: #f0fdf4;"
                                   placeholder="e.g., Thank you for calling Penguin Air!">
                            <button onclick="saveManualGreeting()" 
                                    style="padding: 10px 20px; font-size: 13px; font-weight: 600; background-color: #22c55e; color: #052e16; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-save" id="save-greeting-icon"></i> Save
                            </button>
                        </div>
                    </div>
                    
                    <!-- Flow JSON Input -->
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; color: #86efac; margin-bottom: 6px;">
                            Emergency Flow JSON (paste V2 schema)
                            <button onclick="loadEmergencyFlowTemplate()" 
                                    style="margin-left: 12px; padding: 6px 14px; font-size: 12px; font-weight: 700; background-color: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                📄 LOAD TEMPLATE
                            </button>
                        </label>
                        <textarea id="manual-flow-json-input" 
                                  style="width: 100%; height: 160px; padding: 12px; font-size: 12px; font-family: monospace; border: 2px solid #22c55e; border-radius: 6px; color: #1e293b; background: #f0fdf4; resize: vertical;"
                                  placeholder='{"flowKey": "emergency_service", "trigger": {...}, "actions": [...]}'></textarea>
                        <div style="display: flex; gap: 8px; margin-top: 10px;">
                            <button onclick="validateFlowJson()" 
                                    style="padding: 10px 18px; font-size: 12px; font-weight: 600; background-color: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-check-circle"></i> Validate
                            </button>
                            <button onclick="saveManualFlowJson()" 
                                    style="padding: 10px 18px; font-size: 12px; font-weight: 600; background-color: #22c55e; color: #052e16; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-save" id="save-flow-icon"></i> Save Flow
                            </button>
                        </div>
                    </div>
                    
                    <div id="manual-save-result" style="margin-top: 10px; font-size: 12px; display: none;"></div>
                </div>
                
                <!-- Meta Info -->
                <div id="truth-meta-panel" style="padding: 8px 24px; background-color: #475569; border-bottom: 1px solid #64748b; font-size: 12px; color: #cbd5e1; display: flex; flex-wrap: wrap; gap: 16px;">
                    <span><strong style="color: #f1f5f9;">Company:</strong> <span id="truth-company-name">-</span></span>
                    <span><strong style="color: #f1f5f9;">ID:</strong> <span id="truth-company-id">-</span></span>
                    <span><strong style="color: #f1f5f9;">Generated:</strong> <span id="truth-generated-at">-</span></span>
                    <span><strong style="color: #f1f5f9;">Environment:</strong> <span id="truth-environment">-</span></span>
                    <span><strong style="color: #f1f5f9;">Source:</strong> <span id="truth-source-tag">/platform-snapshot?scope=full + /raw</span></span>
                </div>
                
                <!-- Tab Switcher for JSON Views -->
                <div style="display: flex; border-bottom: 1px solid #475569; background-color: #334155;">
                    <button id="tab-runtime-snapshot" onclick="switchTruthTab('runtime')" 
                            style="padding: 10px 20px; font-size: 14px; font-weight: 600; border: none; border-bottom: 3px solid #6366f1; background: transparent; color: #a5b4fc; cursor: pointer;">
                        Platform Snapshot JSON
                    </button>
                    <button id="tab-db-echo" onclick="switchTruthTab('dbecho')" 
                            style="padding: 10px 20px; font-size: 14px; font-weight: 600; border: none; border-bottom: 3px solid transparent; background: transparent; color: #94a3b8; cursor: pointer;">
                        DB Echo (Raw)
                    </button>
                    <button id="tab-runtime-truth" onclick="switchTruthTab('canonical')" 
                            style="padding: 10px 20px; font-size: 14px; font-weight: 600; border: none; border-bottom: 3px solid transparent; background: transparent; color: #94a3b8; cursor: pointer;">
                        Runtime Truth (Canonical)
                    </button>
                </div>
                
                <!-- Platform Snapshot JSON Viewer -->
                <div id="truth-runtime-panel" class="flex-1 overflow-auto p-4 bg-slate-900">
                    <pre id="truth-json-viewer" class="text-xs text-green-400 font-mono whitespace-pre-wrap">Loading snapshot...</pre>
                </div>
                
                <!-- DB Echo JSON Viewer (hidden by default) -->
                <div id="truth-dbecho-panel" class="flex-1 overflow-auto p-4 bg-slate-900 hidden">
                    <pre id="truth-dbecho-viewer" class="text-xs text-cyan-400 font-mono whitespace-pre-wrap">Loading DB echo...</pre>
                </div>

                <!-- Runtime Truth (Canonical) JSON Viewer (hidden by default) -->
                <div id="truth-canonical-panel" class="flex-1 overflow-auto p-4 bg-slate-900 hidden">
                    <div style="margin-bottom: 10px; padding: 10px 12px; background: #0b1220; border: 1px solid #1f2937; border-radius: 8px; color: #cbd5e1; font-size: 12px; display: flex; flex-wrap: wrap; gap: 14px; align-items: center;">
                        <span style="font-weight: 700; color: #10b981;">Canonical Runtime Truth</span>
                        <span><strong style="color: #e2e8f0;">Source:</strong> <span id="rt-source-tag">/runtime-truth</span></span>
                        <span><strong style="color: #e2e8f0;">Schema:</strong> <span id="rt-schema-version">-</span></span>
                        <span><strong style="color: #e2e8f0;">Commit:</strong> <span id="rt-render-commit">-</span></span>
                    </div>
                    <pre id="truth-canonical-viewer" class="text-xs text-emerald-300 font-mono whitespace-pre-wrap">Click "Open Runtime Truth (Canonical)" or select this tab to load.</pre>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div style="padding: 12px 24px; border-top: 1px solid #475569; background-color: #0f172a; border-radius: 0 0 12px 12px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: #94a3b8;">
                <span>
                    <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                    This is a provider snapshot (not runtime). Runtime Truth is canonical for enforcement.
                </span>
                <span id="truth-fetch-time" style="color: #22c55e;">-</span>
            </div>
        </div>
    </div>
    
    <!-- Post-Save Verification Toast -->
    <div id="save-verify-toast" class="fixed bottom-6 right-6 z-50 hidden transform transition-all duration-300">
        <div class="px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px]" id="save-verify-toast-content">
            <i id="save-verify-toast-icon" class="fas fa-check-circle text-xl"></i>
            <div>
                <div id="save-verify-toast-title" class="font-semibold">Saved & Verified</div>
                <div id="save-verify-toast-detail" class="text-sm opacity-80">Platform snapshot updated</div>
            </div>
        </div>
    </div>

    <!-- ===================================================================== -->
    <!-- FLOW ACTION POPUP (Operator clarity: "What just happened?") -->
    <!-- ===================================================================== -->
    <div id="flow-action-popup" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div style="background-color: #0b1220; color: #e2e8f0; border-radius: 12px; width: 100%; max-width: 720px; border: 1px solid #334155; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.55);">
            <div style="display:flex; align-items:center; justify-content:space-between; padding: 14px 16px; border-bottom: 1px solid #1f2937;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <i id="flow-action-popup-icon" class="fas fa-info-circle" style="color:#93c5fd;"></i>
                    <div>
                        <div id="flow-action-popup-title" style="font-weight:800;">Flow Action</div>
                        <div id="flow-action-popup-subtitle" style="font-size:12px; color:#94a3b8;">What just happened</div>
                    </div>
                </div>
                <button onclick="closeFlowActionPopup()" style="padding:8px 10px; border-radius:10px; border: 1px solid #334155; background:#111827; color:#e2e8f0; cursor:pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 14px 16px;">
                <div id="flow-action-popup-message" style="padding: 10px 12px; border-radius: 10px; border: 1px solid #334155; background:#0f172a; color:#e2e8f0; font-size: 13px;">
                    ...
                </div>
                <div id="flow-action-popup-details-wrap" style="margin-top: 10px; display:none;">
                    <div style="font-size: 12px; color:#94a3b8; margin-bottom: 6px;">Details</div>
                    <pre id="flow-action-popup-details" style="white-space: pre-wrap; font-size: 12px; color:#cbd5e1; background:#0b1220; border: 1px solid #1f2937; border-radius: 10px; padding: 10px; max-height: 240px; overflow:auto;"></pre>
                </div>
                <div id="flow-action-popup-next-wrap" style="margin-top: 10px; display:none;">
                    <div style="font-size: 12px; color:#94a3b8; margin-bottom: 6px;">Next step</div>
                    <div id="flow-action-popup-next" style="font-size: 13px; color:#e2e8f0; background:#0f172a; border: 1px solid #334155; border-radius: 10px; padding: 10px 12px;"></div>
                </div>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; padding: 14px 16px; border-top: 1px solid #1f2937;">
                <button onclick="closeFlowActionPopup()" style="padding:10px 14px; border-radius:10px; border: 1px solid #334155; background:#111827; color:#e2e8f0; font-weight:700; cursor:pointer;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    <!-- CONFIG JSON MODAL - Control Plane Effective Configuration -->
    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    <div id="config-json-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div style="background-color: #0f172a; color: #f1f5f9; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); width: 100%; max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column;">
            <!-- Modal Header -->
            <div style="padding: 16px 24px; border-bottom: 1px solid #334155; display: flex; align-items: center; justify-content: space-between; background-color: #1e293b; border-radius: 12px 12px 0 0;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-sliders-h" style="font-size: 20px; color: #14b8a6;"></i>
                    <div>
                        <h2 style="font-size: 18px; font-weight: 700; margin: 0;">Control Plane Config</h2>
                        <p style="font-size: 12px; color: #94a3b8; margin: 0;">Effective Configuration + Lint Results</p>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="refreshConfigJson()" style="padding: 6px 12px; font-size: 14px; background-color: #475569; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-sync-alt" id="config-refresh-icon"></i>
                        Refresh
                    </button>
                    
                    <!-- Dropdown Copy Button -->
                    <div class="config-copy-dropdown" style="position: relative;">
                        <button onclick="toggleConfigCopyDropdown()" id="config-copy-btn"
                                style="padding: 6px 14px; font-size: 14px; background-color: #0d9488; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.15s ease;"
                                onmousedown="this.style.transform='scale(0.97)'"
                                onmouseup="this.style.transform='scale(1)'"
                                onmouseleave="this.style.transform='scale(1)'">
                            <i class="fas fa-copy"></i>
                            Copy Config
                            <i class="fas fa-caret-down" style="font-size: 11px; opacity: 0.8;"></i>
                        </button>
                        
                        <!-- Dropdown Menu (dynamically populated) -->
                        <div id="config-copy-dropdown-menu" style="display: none; position: absolute; top: calc(100% + 4px); right: 0; min-width: 260px; background: #1e293b; border: 1px solid #334155; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 1000; overflow: hidden; max-height: 400px; overflow-y: auto;">
                            <!-- Static: Copy Effective Config -->
                            <button onclick="copyConfigJson('effective'); closeConfigCopyDropdown();" 
                                    class="config-dropdown-item"
                                    style="width: 100%; padding: 12px 16px; font-size: 14px; background: transparent; color: #e2e8f0; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; text-align: left; transition: background 0.15s;"
                                    onmouseover="this.style.background='#334155'"
                                    onmouseout="this.style.background='transparent'">
                                <span style="font-size: 16px;">📋</span>
                                <div>
                                    <div style="font-weight: 500;">Copy Effective Config</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Computed runtime values</div>
                                </div>
                            </button>
                            
                            <!-- Divider -->
                            <div style="height: 1px; background: #334155;"></div>
                            
                            <!-- Dynamic: Raw Company Items (populated by JS) -->
                            <div id="raw-company-dropdown-items">
                                <!-- Will be populated by updateRawCompanyDropdownItems() -->
                                <button onclick="copyConfigJson('raw'); closeConfigCopyDropdown();" 
                                        class="config-dropdown-item"
                                        style="width: 100%; padding: 12px 16px; font-size: 14px; background: transparent; color: #e2e8f0; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; text-align: left; transition: background 0.15s;"
                                        onmouseover="this.style.background='#334155'"
                                        onmouseout="this.style.background='transparent'">
                                    <span style="font-size: 16px;">🧾</span>
                                    <div>
                                        <div style="font-weight: 500;">Copy Raw Company JSON</div>
                                        <div style="font-size: 11px; color: #94a3b8;">MongoDB document (ground truth)</div>
                                    </div>
                                </button>
                            </div>
                            
                            <!-- Divider -->
                            <div style="height: 1px; background: #334155;"></div>
                            
                            <!-- Static: Copy Lint Results -->
                            <button onclick="copyConfigJson('lint'); closeConfigCopyDropdown();" 
                                    class="config-dropdown-item"
                                    style="width: 100%; padding: 12px 16px; font-size: 14px; background: transparent; color: #e2e8f0; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; text-align: left; transition: background 0.15s;"
                                    onmouseover="this.style.background='#334155'"
                                    onmouseout="this.style.background='transparent'">
                                <span style="font-size: 16px;">🔍</span>
                                <div>
                                    <div style="font-weight: 500;">Copy Lint Results</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Warnings &amp; errors</div>
                                </div>
                            </button>
                            
                            <!-- Divider -->
                            <div style="height: 1px; background: #334155;"></div>
                            
                            <!-- Static: Download Raw Company -->
                            <button onclick="downloadRawCompanyJson(); closeConfigCopyDropdown();" 
                                    class="config-dropdown-item"
                                    style="width: 100%; padding: 12px 16px; font-size: 14px; background: transparent; color: #e2e8f0; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; text-align: left; transition: background 0.15s;"
                                    onmouseover="this.style.background='#334155'"
                                    onmouseout="this.style.background='transparent'">
                                <span style="font-size: 16px;">💾</span>
                                <div>
                                    <div style="font-weight: 500;">Download Raw Company (.json)</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Full file download (recommended)</div>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="closeConfigJsonModal()" style="padding: 8px; background: transparent; border: none; color: #94a3b8; cursor: pointer; border-radius: 6px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Body with Tabs -->
            <div style="flex: 1; overflow-y: auto; padding: 0;">
                <!-- Tabs -->
                <div style="display: flex; border-bottom: 1px solid #334155; background-color: #1e293b;">
                    <button onclick="switchConfigTab('effective')" class="config-tab active" data-tab="effective" 
                            style="padding: 12px 24px; border: none; background: transparent; color: #f1f5f9; cursor: pointer; font-weight: 500; border-bottom: 2px solid transparent;">
                        <i class="fas fa-check-circle" style="color: #22c55e;"></i> Effective Config
                    </button>
                    <button onclick="switchConfigTab('raw')" class="config-tab" data-tab="raw"
                            style="padding: 12px 24px; border: none; background: transparent; color: #94a3b8; cursor: pointer; font-weight: 500; border-bottom: 2px solid transparent;">
                        <i class="fas fa-database" style="color: #60a5fa;"></i> Raw Company
                    </button>
                    <button onclick="switchConfigTab('lint')" class="config-tab" data-tab="lint"
                            style="padding: 12px 24px; border: none; background: transparent; color: #94a3b8; cursor: pointer; font-weight: 500; border-bottom: 2px solid transparent;">
                        <i class="fas fa-clipboard-check" style="color: #f59e0b;"></i> Lint Results
                    </button>
                </div>
                
                <!-- Tab Content: Effective Config -->
                <div id="config-tab-effective" class="config-tab-content" style="padding: 20px;">
                    <div style="margin-bottom: 16px; padding: 12px; background-color: #1e293b; border-radius: 8px; display: flex; gap: 24px;">
                        <div>
                            <span style="color: #94a3b8; font-size: 12px;">Score</span>
                            <div id="config-score-badge" style="font-size: 24px; font-weight: 700; color: #22c55e;">--</div>
                        </div>
                        <div>
                            <span style="color: #94a3b8; font-size: 12px;">Grade</span>
                            <div id="config-grade-badge" style="font-size: 24px; font-weight: 700; color: #22c55e;">--</div>
                        </div>
                        <div>
                            <span style="color: #94a3b8; font-size: 12px;">Issues</span>
                            <div id="config-issues-badge" style="font-size: 24px; font-weight: 700; color: #f59e0b;">--</div>
                        </div>
                        <div>
                            <span style="color: #94a3b8; font-size: 12px;">Booking Slots</span>
                            <div id="config-slots-badge" style="font-size: 24px; font-weight: 700; color: #60a5fa;">--</div>
                        </div>
                    </div>
                    <pre id="config-effective-json" style="background-color: #0f172a; padding: 16px; border-radius: 8px; font-size: 11px; overflow-x: auto; max-height: 400px; overflow-y: auto; border: 1px solid #334155; color: #e2e8f0;">Loading...</pre>
                </div>
                
                <!-- Tab Content: Raw Company -->
                <div id="config-tab-raw" class="config-tab-content" style="padding: 20px; display: none;">
                    <div style="margin-bottom: 16px; padding: 12px; background-color: #1e293b; border-radius: 8px;">
                        <span style="color: #94a3b8; font-size: 12px;">Source</span>
                        <div style="color: #e2e8f0;">MongoDB company document (raw)</div>
                    </div>
                    <pre id="config-raw-json" style="background-color: #0f172a; padding: 16px; border-radius: 8px; font-size: 11px; overflow-x: auto; max-height: 400px; overflow-y: auto; border: 1px solid #334155; color: #e2e8f0;">Loading...</pre>
                </div>
                
                <!-- Tab Content: Lint Results -->
                <div id="config-tab-lint" class="config-tab-content" style="padding: 20px; display: none;">
                    
                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <!-- GREETING OPTIMIZER WIDGET (WIRED TO REAL PATHS) -->
                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <div id="greeting-optimizer-panel" style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); border-radius: 12px; border: 1px solid #334155;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 20px;">🎯</span>
                                <div>
                                    <div style="font-weight: 700; font-size: 14px; color: #e2e8f0;">Greeting Optimizer</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Target: 6-8 words (~2.5s TTS)</div>
                                </div>
                            </div>
                            <div id="greeting-status-badge" style="padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; background: #065f46; color: #10b981;">OK</div>
                        </div>
                        
                        <!-- EFFECTIVE GREETING (What Runtime Actually Uses) -->
                        <div style="margin-bottom: 12px; padding: 10px; background: #0f172a; border-radius: 8px; border-left: 3px solid #14b8a6;">
                            <div style="font-size: 10px; color: #14b8a6; font-weight: 600; margin-bottom: 4px;">EFFECTIVE GREETING (what runtime uses):</div>
                            <div id="greeting-effective-text" style="font-size: 13px; color: #e2e8f0; font-style: italic;">"Loading..."</div>
                            <div id="greeting-effective-source" style="font-size: 10px; color: #64748b; margin-top: 4px;">Source: --</div>
                        </div>
                        
                        <!-- WRITE TARGETS (Where saves go) -->
                        <div style="margin-bottom: 12px; padding: 10px; background: #0f172a; border-radius: 8px;">
                            <div style="font-size: 10px; color: #f59e0b; font-weight: 600; margin-bottom: 6px;">📝 WRITE TARGETS (where saves go):</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                <span style="font-size: 10px; padding: 2px 8px; background: #334155; border-radius: 4px; color: #e2e8f0; font-family: monospace;">connectionMessages.voice.text</span>
                                <span style="font-size: 10px; padding: 2px 8px; background: #334155; border-radius: 4px; color: #e2e8f0; font-family: monospace;">connectionMessages.voice.realtime.text</span>
                            </div>
                            <div id="greeting-mirror-targets" style="margin-top: 6px; font-size: 10px; color: #64748b; display: none;">
                                Also mirrored to: <span id="greeting-mirror-list"></span>
                            </div>
                        </div>
                        
                        <!-- Stats Row -->
                        <div style="display: flex; gap: 16px; margin-bottom: 12px; padding: 10px; background: #0f172a; border-radius: 8px;">
                            <div style="text-align: center;">
                                <div id="greeting-word-count" style="font-size: 24px; font-weight: 700; color: #14b8a6;">--</div>
                                <div style="font-size: 10px; color: #94a3b8;">words</div>
                            </div>
                            <div style="text-align: center;">
                                <div id="greeting-tts-seconds" style="font-size: 24px; font-weight: 700; color: #f59e0b;">--</div>
                                <div style="font-size: 10px; color: #94a3b8;">seconds</div>
                            </div>
                            <div style="flex: 1; display: flex; align-items: center;">
                                <div id="greeting-preview" style="font-size: 12px; color: #e2e8f0; font-style: italic; line-height: 1.4;">Loading...</div>
                            </div>
                        </div>
                        
                        <!-- PENDING CHANGE INDICATOR (shows when preset clicked but not saved) -->
                        <div id="greeting-pending-panel" style="display: none; margin-bottom: 12px; padding: 10px; background: #422006; border-radius: 8px; border: 1px solid #f59e0b;">
                            <div style="font-size: 10px; color: #fbbf24; font-weight: 600; margin-bottom: 4px;">⚠️ PENDING CHANGE (not saved yet):</div>
                            <div id="greeting-pending-text" style="font-size: 13px; color: #fef3c7; font-style: italic;">"..."</div>
                            <div style="margin-top: 8px; display: flex; gap: 8px;">
                                <button onclick="saveGreetingNow()" 
                                        style="padding: 6px 12px; font-size: 11px; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    ✓ Save Greeting
                                </button>
                                <button onclick="cancelGreetingPending()" 
                                        style="padding: 6px 12px; font-size: 11px; background: #475569; color: #e2e8f0; border: none; border-radius: 6px; cursor: pointer;">
                                    ✕ Cancel
                                </button>
                                <button onclick="testResolveGreeting()" 
                                        style="padding: 6px 12px; font-size: 11px; background: #1e40af; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    🔍 Test Resolve
                                </button>
                            </div>
                        </div>
                        
                        <!-- One-Click Presets (preview only, no auto-save) -->
                        <div style="font-size: 11px; color: #94a3b8; margin-bottom: 8px;">⚡ Click to preview (then Save):</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <!-- ULTRA-FAST (BEST) - 5 words, ~2s TTS -->
                            <button onclick="previewGreetingPreset('{{companyName}} — how can I help?')" 
                                    style="padding: 8px 12px; font-size: 11px; background: #065f46; color: #10b981; border: 2px solid #10b981; border-radius: 6px; cursor: pointer; transition: all 0.15s; position: relative;"
                                    onmouseover="this.style.background='#047857'" onmouseout="this.style.background='#065f46'"
                                    title="ULTRA-FAST: 5 words, ~2s TTS, Penguin Air Gold Standard">
                                ⭐ {{companyName}} — how can I help?
                                <span style="position: absolute; top: -8px; right: -8px; background: #f59e0b; color: #0f172a; font-size: 8px; padding: 2px 4px; border-radius: 4px; font-weight: 700;">BEST</span>
                            </button>
                            <!-- WARMER (GOOD) - 8 words, ~2.5s TTS -->
                            <button onclick="previewGreetingPreset('Thanks for calling {{companyName}} — how can I help?')" 
                                    style="padding: 8px 12px; font-size: 11px; background: #334155; color: #e2e8f0; border: 1px solid #475569; border-radius: 6px; cursor: pointer; transition: all 0.15s;"
                                    onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#334155'"
                                    title="WARMER: 8 words, ~2.5s TTS">
                                Thanks for calling {{companyName}} — how can I help?
                            </button>
                            <!-- FRIENDLY (OK) - 7 words -->
                            <button onclick="previewGreetingPreset('Hi — {{companyName}}. How can I help?')" 
                                    style="padding: 8px 12px; font-size: 11px; background: #334155; color: #e2e8f0; border: 1px solid #475569; border-radius: 6px; cursor: pointer; transition: all 0.15s;"
                                    onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#334155'"
                                    title="FRIENDLY: 7 words, ~2.5s TTS">
                                Hi — {{companyName}}. How can I help?
                            </button>
                        </div>
                        
                        <!-- Why This Greeting Tooltip -->
                        <div style="margin-top: 12px; padding: 10px; background: #0f172a; border-radius: 6px; border: 1px dashed #334155;">
                            <div style="font-size: 10px; color: #64748b; display: flex; align-items: flex-start; gap: 8px;">
                                <span>💡</span>
                                <div>
                                    <strong style="color: #94a3b8;">Why the ultra-short greeting?</strong>
                                    <ul style="margin: 4px 0 0 12px; padding: 0; color: #64748b;">
                                        <li>5 words = ~2s TTS (fastest response)</li>
                                        <li>{{companyName}} auto-fills from placeholders</li>
                                        <li>Ends with question = invites caller response</li>
                                        <li>Penguin Air Gold Standard = proven conversion</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <!-- QUICKANSWERS DEDUPER (WITH ACTIONS) -->
                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <div id="quickanswers-deduper-panel" style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, #422006 0%, #0f172a 100%); border-radius: 12px; border: 1px solid #78350f; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 20px;">⚠️</span>
                                <div>
                                    <div style="font-weight: 700; font-size: 14px; color: #fbbf24;">QuickAnswer Duplicates Detected</div>
                                    <div style="font-size: 11px; color: #fcd34d;">Same triggers → inconsistent responses</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <button onclick="restoreDisabledQuickAnswers()" 
                                        style="padding: 4px 8px; font-size: 10px; background: transparent; color: #fcd34d; border: 1px solid #78350f; border-radius: 4px; cursor: pointer;"
                                        title="Restore previously disabled duplicates">
                                    ↩ Restore Disabled
                                </button>
                                <div id="qa-duplicates-count" style="padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; background: #78350f; color: #fbbf24;">0</div>
                            </div>
                        </div>
                        
                        <!-- Duplicates List -->
                        <div id="qa-duplicates-list" style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Populated by JS with action buttons -->
                        </div>
                    </div>
                    
                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <!-- CONFIG HEALTH STATUS (WITH CONFLICT DETAILS) -->
                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <div id="config-health-panel" style="margin-bottom: 20px; padding: 16px; background: #0f172a; border-radius: 12px; border: 1px solid #334155; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span id="config-health-icon" style="font-size: 20px;">⚡</span>
                                <div>
                                    <div id="config-health-title" style="font-weight: 700; font-size: 14px; color: #e2e8f0;">Config Health</div>
                                    <div id="config-health-summary" style="font-size: 11px; color: #94a3b8;">Checking...</div>
                                </div>
                            </div>
                            <div id="config-health-badge" style="padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; background: #065f46; color: #10b981;">OK</div>
                        </div>
                        
                        <!-- CONFLICT DETAILS (populated by JS) -->
                        <div id="config-conflict-details" style="display: none; margin-top: 12px;">
                            <!-- Each conflict will be rendered here -->
                        </div>
                        
                        <!-- WARNINGS DETAILS -->
                        <div id="config-warning-details" style="display: none; margin-top: 12px;">
                            <!-- Each warning will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <!-- LEGACY KEYS DETECTED (Golden Blueprint Validator) -->
                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <div id="legacy-keys-panel" style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, #4c1d95 0%, #0f172a 100%); border-radius: 12px; border: 1px solid #7c3aed; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 20px;">🗑️</span>
                                <div>
                                    <div style="font-weight: 700; font-size: 14px; color: #c4b5fd;">Legacy Keys Detected</div>
                                    <div style="font-size: 11px; color: #a78bfa;">Not in Golden Blueprint → ignored at runtime</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <button onclick="nukeLegacyKeys(true)" 
                                        style="padding: 4px 8px; font-size: 10px; background: transparent; color: #c4b5fd; border: 1px solid #7c3aed; border-radius: 4px; cursor: pointer;"
                                        title="Preview what would be deleted">
                                    👁️ Preview Nuke
                                </button>
                                <button onclick="nukeLegacyKeys(false)" 
                                        style="padding: 4px 8px; font-size: 10px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;"
                                        title="Delete legacy keys (safe)">
                                    🔥 Nuke Legacy
                                </button>
                                <div id="legacy-keys-count" style="padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; background: #7c3aed; color: white;">0</div>
                            </div>
                        </div>
                        
                        <!-- Blueprint Version -->
                        <div id="blueprint-version" style="font-size: 10px; color: #a78bfa; margin-bottom: 12px;">
                            Golden Blueprint: <span id="blueprint-version-text">Loading...</span>
                        </div>
                        
                        <!-- Legacy Keys List -->
                        <div id="legacy-keys-list" style="display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto;">
                            <!-- Populated by JS -->
                        </div>
                        
                        <!-- Deprecated Namespaces Warning -->
                        <div id="deprecated-namespaces-warning" style="display: none; margin-top: 12px; padding: 10px; background: #7f1d1d; border-radius: 6px; border: 1px solid #ef4444;">
                            <div style="font-size: 11px; color: #fca5a5; font-weight: 600;">⚠️ DEPRECATED NAMESPACES FOUND:</div>
                            <div id="deprecated-namespaces-list" style="font-size: 10px; color: #fecaca; margin-top: 4px;"></div>
                        </div>
                        
                        <!-- Variables Migration Prompt -->
                        <div id="variables-migration-prompt" style="display: none; margin-top: 12px; padding: 10px; background: #422006; border-radius: 6px; border: 1px solid #f59e0b;">
                            <div style="font-size: 11px; color: #fcd34d; font-weight: 600;">📦 Legacy "variables" detected</div>
                            <div style="font-size: 10px; color: #fef3c7; margin-top: 4px;">
                                These should be migrated to "placeholders" (the canonical system).
                            </div>
                            <button onclick="migrateVariablesToPlaceholders()" 
                                    style="margin-top: 8px; padding: 6px 12px; font-size: 10px; background: #f59e0b; color: #0f172a; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                ⚡ Migrate to Placeholders
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lint Issues List -->
                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px; font-weight: 600;">Lint Issues:</div>
                    <div id="config-lint-list" style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="padding: 20px; text-align: center; color: #94a3b8;">Loading lint results...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-gray-500 text-sm">
            © <span id="current-year"></span> ClientVia.ai All rights reserved.
        </div>
    </footer>
    
    <script>
        // Set current year in footer
        const yearSpan = document.getElementById('current-year');
        if (yearSpan) {
            yearSpan.textContent = new Date().getFullYear();
        }
        
        // Global helper function for slider value updates (used by inline HTML oninput attributes)
        function updateSliderValue(name, value) {
            const displayElement = document.getElementById(`${name}-value`);
            if (displayElement) {
                displayElement.textContent = parseFloat(value).toFixed(1);
            }
        }
        
        // Global helper function for checkbox value updates (used by inline HTML onchange attributes)
        function updateCheckboxValue(name, checked) {
            // This function can be used for any checkbox-related UI updates
            console.log(`Checkbox ${name} changed to: ${checked}`);
        }
    </script>
    
    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    <!-- PLATFORM SNAPSHOT JAVASCRIPT - Provider Snapshot + DB Echo (NOT runtime) -->
    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    <script>
        // Store current data for copy
        let currentTruthSnapshot = null;
        let currentDbEcho = null;
        let currentRuntimeTruth = null;
        let currentTruthTab = 'runtime';
        
        // ═══════════════════════════════════════════════════════════════════════════
        // PLATFORM SNAPSHOT - Open Modal
        // ═══════════════════════════════════════════════════════════════════════════
        async function openTruthReport() {
            const modal = document.getElementById('truth-report-modal');
            if (modal) {
                modal.classList.remove('hidden');
                await loadTruthReport();
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // PLATFORM SNAPSHOT - Close Modal
        // ═══════════════════════════════════════════════════════════════════════════
        function closeTruthReport() {
            const modal = document.getElementById('truth-report-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // PLATFORM SNAPSHOT - Refresh
        // ═══════════════════════════════════════════════════════════════════════════
        async function refreshTruthReport() {
            const icon = document.getElementById('truth-refresh-icon');
            if (icon) icon.classList.add('fa-spin');
            await loadTruthReport();
            if (icon) icon.classList.remove('fa-spin');
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // PLATFORM SNAPSHOT - Load Snapshot (Providers)
        // ═══════════════════════════════════════════════════════════════════════════
        async function loadTruthReport() {
            const companyId = window.currentCompanyId || window.companyId;
            if (!companyId) {
                showTruthError('No company ID found');
                return;
            }
            
            const startTime = Date.now();
            
            try {
                const authToken = localStorage.getItem('adminToken');
                const response = await fetch(`/api/company/${companyId}/platform-snapshot?scope=full`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const apiResponse = await response.json();
                // API returns { success: true, snapshot: { ... } } - extract inner snapshot
                const snapshot = apiResponse.snapshot || apiResponse;
                currentTruthSnapshot = snapshot;
                
                // Load Runtime Truth as the judge for Harmony Lock (effectiveConfigVersion drift)
                if (!currentRuntimeTruth) {
                    try { await loadRuntimeTruthCanonical(); } catch {}
                }
                
                const fetchTime = Date.now() - startTime;
                
                // Update meta panel
                document.getElementById('truth-company-name').textContent = snapshot.meta?.companyName || snapshot.providers?.controlPlane?.data?.companyName || '-';
                document.getElementById('truth-company-id').textContent = companyId;
                document.getElementById('truth-generated-at').textContent = snapshot.meta?.generatedAt ? new Date(snapshot.meta.generatedAt).toLocaleString() : '-';
                document.getElementById('truth-environment').textContent = window.location.hostname.includes('localhost') ? 'Development' : 'Production';
                const sourceTag = document.getElementById('truth-source-tag');
                if (sourceTag) sourceTag.textContent = '/platform-snapshot?scope=full + /raw';
                document.getElementById('truth-fetch-time').textContent = `Fetched in ${fetchTime}ms`;
                
                // Update health panel
                updateTruthHealthPanel(snapshot);
                
                // Update JSON viewer
                document.getElementById('truth-json-viewer').textContent = JSON.stringify(snapshot, null, 2);
                
                // Also load DB Echo
                await loadDbEcho();
                
                // Populate legacy flow selector for conversion tools
                await populateLegacyFlowSelector();
                
            } catch (error) {
                console.error('[PLATFORM SNAPSHOT] Error:', error);
                showTruthError(error.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // RUNTIME TRUTH (CANONICAL) - Load
        // ═══════════════════════════════════════════════════════════════════════════
        async function loadRuntimeTruthCanonical() {
            const companyId = window.currentCompanyId || window.companyId;
            if (!companyId) return;
            try {
                const authToken = localStorage.getItem('adminToken');
                const response = await fetch(`/api/company/${companyId}/runtime-truth`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const rt = await response.json();
                currentRuntimeTruth = rt;
                const schemaVersion = rt?._meta?.schemaVersion || '-';
                const renderCommit = rt?._meta?.deploy?.renderGitCommit || rt?._meta?.deploy?.gitCommit || '-';
                const schemaEl = document.getElementById('rt-schema-version');
                const commitEl = document.getElementById('rt-render-commit');
                if (schemaEl) schemaEl.textContent = schemaVersion;
                if (commitEl) commitEl.textContent = renderCommit;
                const viewer = document.getElementById('truth-canonical-viewer');
                if (viewer) viewer.textContent = JSON.stringify(rt, null, 2);
                
                // ═══════════════════════════════════════════════════════════════════
                // EXPLAIN WHY NOT GREEN - Display Runtime Truth blockers
                // ═══════════════════════════════════════════════════════════════════
                updateWhyNotGreenBanner(rt?.data?.health || rt?.health);
                
                try { showSaveVerifyToast(true, 'Runtime Truth Loaded', `ECV: ${rt?._meta?.effectiveConfigVersion || '-'}`); } catch {}
            } catch (error) {
                const viewer = document.getElementById('truth-canonical-viewer');
                if (viewer) viewer.textContent = `Error loading runtime-truth: ${error.message}`;
                try { showSaveVerifyToast(false, 'Runtime Truth Failed', error.message); } catch {}
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // EXPLAIN WHY NOT GREEN - Render blockers from Runtime Truth
        // ═══════════════════════════════════════════════════════════════════════════
        function updateWhyNotGreenBanner(health) {
            const banner = document.getElementById('truth-why-not-green-banner');
            const title = document.getElementById('truth-why-not-green-title');
            const statusBadge = document.getElementById('truth-why-not-green-status');
            const summary = document.getElementById('truth-why-not-green-summary');
            const blockersDiv = document.getElementById('truth-why-not-green-blockers');
            
            if (!banner) return;
            
            const status = health?.status || 'UNKNOWN';
            const explain = health?.explainWhyNotGreen;
            
            // Show banner if not GREEN
            if (status === 'GREEN' || !explain) {
                banner.style.display = 'none';
                return;
            }
            
            banner.style.display = 'block';
            
            // Update status badge
            if (statusBadge) {
                statusBadge.textContent = status;
                if (status === 'RED') {
                    banner.style.borderColor = '#ef4444';
                    banner.style.background = 'rgba(239, 68, 68, 0.12)';
                    statusBadge.style.background = '#dc2626';
                } else if (status === 'YELLOW') {
                    banner.style.borderColor = '#f59e0b';
                    banner.style.background = 'rgba(245, 158, 11, 0.12)';
                    statusBadge.style.background = '#d97706';
                }
            }
            
            // Update summary
            if (summary) {
                summary.textContent = explain.summary || `Runtime Truth: ${status}`;
            }
            
            // Render blockers and warnings
            if (blockersDiv) {
                let html = '';
                
                if (explain.blockers?.length > 0) {
                    html += '<div style="margin-bottom: 8px;"><strong style="color: #f87171;">🔴 Critical Blockers:</strong></div>';
                    explain.blockers.forEach(b => {
                        html += `<div style="margin-left: 12px; margin-bottom: 4px;">
                            <span style="color: #fecaca;">• [${b.area || 'runtime'}]</span> ${b.message}
                            ${b.fix ? `<br><span style="color: #9ca3af; margin-left: 14px;">Fix: ${b.fix}</span>` : ''}
                        </div>`;
                    });
                }
                
                if (explain.warnings?.length > 0) {
                    html += '<div style="margin-top: 8px; margin-bottom: 8px;"><strong style="color: #fcd34d;">🟡 Warnings:</strong></div>';
                    explain.warnings.forEach(w => {
                        html += `<div style="margin-left: 12px; margin-bottom: 4px;">
                            <span style="color: #fef3c7;">• [${w.area || 'runtime'}]</span> ${w.message}
                            ${w.fix ? `<br><span style="color: #9ca3af; margin-left: 14px;">Fix: ${w.fix}</span>` : ''}
                        </div>`;
                    });
                }
                
                blockersDiv.innerHTML = html || 'No details available';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // DOWNLOAD HELPERS (Large JSON payloads)
        // ═══════════════════════════════════════════════════════════════════════════
        function downloadJsonFile({ filename, data }) {
            try {
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 2000);
            } catch (e) {
                alert(`Download failed: ${e.message}`);
            }
        }

        function getCompanyIdForDownload() {
            return window.currentCompanyId || window.companyId ||
                new URLSearchParams(window.location.search).get('id') ||
                localStorage.getItem('currentCompanyId');
        }

        function makeFilename(prefix, companyId) {
            const ts = new Date().toISOString().replace(/[:.]/g, '-');
            return `${prefix}_${companyId}_${ts}.json`;
        }

        async function downloadPlatformSnapshotBundle() {
            const companyId = getCompanyIdForDownload();
            if (!companyId) {
                alert('No companyId found');
                return;
            }

            // Ensure we have data; fetch if missing
            if (!currentTruthSnapshot) {
                try { await loadTruthReport(); } catch {}
            }
            if (!currentDbEcho) {
                try { await loadDbEcho(); } catch {}
            }
            if (!currentRuntimeTruth) {
                try { await loadRuntimeTruthCanonical(); } catch {}
            }

            // Platform Snapshot
            if (currentTruthSnapshot) {
                downloadJsonFile({
                    filename: makeFilename('platform_snapshot', companyId),
                    data: currentTruthSnapshot
                });
            } else {
                alert('Platform Snapshot not available yet (try Refresh).');
            }

            // Runtime Truth (Canonical)
            if (currentRuntimeTruth) {
                downloadJsonFile({
                    filename: makeFilename('runtime_truth_canonical', companyId),
                    data: currentRuntimeTruth
                });
            } else {
                alert('Runtime Truth not available yet (click Open Runtime Truth first).');
            }

            // DB Echo
            if (currentDbEcho) {
                downloadJsonFile({
                    filename: makeFilename('db_echo_raw_company', companyId),
                    data: currentDbEcho
                });
            } else {
                alert('DB Echo not available yet (try Refresh).');
            }
        }

        // CTA handler (button in header)
        async function openRuntimeTruthCanonical() {
            // Switch to canonical tab and load (with operator-visible feedback)
            try {
                showSaveVerifyToast(true, 'Loading Runtime Truth…', 'Fetching /api/company/:companyId/runtime-truth');
            } catch {}

            switchTruthTab('canonical');

            // Auto-scroll so it never "looks like nothing happened"
            try {
                const panel = document.getElementById('truth-canonical-panel');
                if (panel && typeof panel.scrollIntoView === 'function') {
                    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } catch {}

            await loadRuntimeTruthCanonical();

            // Scroll to the viewer once loaded (success or error message is visible there)
            try {
                const viewer = document.getElementById('truth-canonical-viewer');
                if (viewer && typeof viewer.scrollIntoView === 'function') {
                    viewer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                showSaveVerifyToast(true, 'Runtime Truth Loaded', 'Canonical enforcement JSON is now visible');
            } catch {}
        }

        // Ensure Runtime Truth button works even if inline onclick is blocked/overridden.
        // (Some injected UI scripts can interfere with inline handlers.)
        window.openRuntimeTruthCanonical = openRuntimeTruthCanonical;
        window.loadRuntimeTruthCanonical = loadRuntimeTruthCanonical;

        document.addEventListener('DOMContentLoaded', () => {
            try {
                const btn = document.getElementById('open-runtime-truth-btn');
                if (btn && !btn.dataset.boundRuntimeTruth) {
                    btn.dataset.boundRuntimeTruth = '1';
                    btn.addEventListener('click', (e) => {
                        // If inline works, this is harmless; if inline is blocked, this saves the day.
                        e.preventDefault();
                        e.stopPropagation();
                        window.openRuntimeTruthCanonical?.();
                    }, { capture: true });
                }
            } catch {}
        });

        // Download a minimal, canonical subset: _meta + health (+ blockers)
        async function downloadRuntimeTruthBlockersJson() {
            if (!currentRuntimeTruth) {
                try { await loadRuntimeTruthCanonical(); } catch {}
            }
            if (!currentRuntimeTruth) {
                alert('Runtime Truth not available yet (open Runtime Truth first).');
                return;
            }
            const companyId = window.currentCompanyId || window.companyId || 'company';
            const subset = {
                _meta: currentRuntimeTruth?._meta || null,
                health: currentRuntimeTruth?.health || null,
                blockers: Array.isArray(currentRuntimeTruth?.health?.issues)
                    ? currentRuntimeTruth.health.issues.filter(i => (i?.severity || '').toString().toUpperCase() !== 'INFO')
                    : []
            };
            downloadJsonFile({
                filename: makeFilename('runtime_truth_blockers', companyId),
                data: subset
            });
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // DB ECHO - Load Raw Company Data
        // ═══════════════════════════════════════════════════════════════════════════
        async function loadDbEcho() {
            const companyId = window.currentCompanyId || window.companyId;
            if (!companyId) return;
            
            try {
                const authToken = localStorage.getItem('adminToken');
                const response = await fetch(`/api/company/${companyId}/raw`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const dbData = await response.json();
                currentDbEcho = dbData;
                
                // Update DB Echo viewer
                document.getElementById('truth-dbecho-viewer').textContent = JSON.stringify(dbData, null, 2);
                
            } catch (error) {
                console.error('[DB ECHO] Error:', error);
                document.getElementById('truth-dbecho-viewer').textContent = `Error loading DB echo: ${error.message}`;
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // TAB SWITCHING
        // ═══════════════════════════════════════════════════════════════════════════
        function switchTruthTab(tab) {
            currentTruthTab = tab;
            
            const runtimeTab = document.getElementById('tab-runtime-snapshot');
            const dbechoTab = document.getElementById('tab-db-echo');
            const canonicalTab = document.getElementById('tab-runtime-truth');
            const runtimePanel = document.getElementById('truth-runtime-panel');
            const dbechoPanel = document.getElementById('truth-dbecho-panel');
            const canonicalPanel = document.getElementById('truth-canonical-panel');
            
            if (tab === 'runtime') {
                runtimeTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600';
                dbechoTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                if (canonicalTab) canonicalTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                runtimePanel.classList.remove('hidden');
                dbechoPanel.classList.add('hidden');
                if (canonicalPanel) canonicalPanel.classList.add('hidden');
            } else {
                if (tab === 'dbecho') {
                    runtimeTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                    dbechoTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-cyan-600 text-cyan-600';
                    if (canonicalTab) canonicalTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                    runtimePanel.classList.add('hidden');
                    dbechoPanel.classList.remove('hidden');
                    if (canonicalPanel) canonicalPanel.classList.add('hidden');
                } else {
                    // canonical
                    runtimeTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                    dbechoTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                    if (canonicalTab) canonicalTab.className = 'px-4 py-2 text-sm font-medium border-b-2 border-emerald-600 text-emerald-600';
                    runtimePanel.classList.add('hidden');
                    dbechoPanel.classList.add('hidden');
                    if (canonicalPanel) canonicalPanel.classList.remove('hidden');
                    if (!currentRuntimeTruth) {
                        loadRuntimeTruthCanonical().catch(() => {});
                    }
                }
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // WRITE TEST GREETING - End-to-End Verification
        // ═══════════════════════════════════════════════════════════════════════════
        async function writeTestGreeting() {
            const companyId = window.currentCompanyId || window.companyId;
            if (!companyId) {
                alert('No company ID found');
                return;
            }
            
            const icon = document.getElementById('write-test-greeting-icon');
            const resultEl = document.getElementById('write-test-result');
            
            if (icon) icon.className = 'fas fa-spinner fa-spin';
            if (resultEl) resultEl.classList.add('hidden');
            
            try {
                const authToken = localStorage.getItem('adminToken');
                
                // Step 1: Write test greeting
                const writeResponse = await fetch(`/api/company/${companyId}/raw/write-test-greeting`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!writeResponse.ok) {
                    throw new Error(`Write failed: HTTP ${writeResponse.status}`);
                }
                
                const writeResult = await writeResponse.json();
                
                // Step 2: Refresh Platform Snapshot (both snapshot and DB Echo)
                await loadTruthReport();
                
                // Step 3: Verify the change
                const verifySnapshot = currentTruthSnapshot;
                const verifyDbEcho = currentDbEcho;
                
                const snapshotGreeting = verifySnapshot?.providers?.controlPlane?.data?.frontDesk?.greetingConfigured;
                const snapshotSource = verifySnapshot?.providers?.controlPlane?.data?.frontDesk?.greetingSource;
                const dbGreeting = verifyDbEcho?.greetingFields?.['frontDeskBehavior.greeting'];
                
                // Show result
                if (resultEl) {
                    if (writeResult.success && snapshotGreeting && dbGreeting === writeResult.testGreeting) {
                        resultEl.textContent = `✅ PASSED: DB="${writeResult.testGreeting?.substring(0, 30)}..." | Snapshot: configured=${snapshotGreeting}, source=${snapshotSource}`;
                        resultEl.className = 'text-xs text-green-700';
                        showSaveVerifyToast(true, 'Write Test PASSED', 'Greeting saved to DB and visible in snapshot');
                    } else {
                        resultEl.textContent = `❌ MISMATCH: DB="${dbGreeting}" | Snapshot: configured=${snapshotGreeting}, source=${snapshotSource}`;
                        resultEl.className = 'text-xs text-red-700';
                        showSaveVerifyToast(false, 'Write Test FAILED', 'DB write succeeded but snapshot not updated');
                    }
                    resultEl.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('[WRITE TEST] Error:', error);
                if (resultEl) {
                    resultEl.textContent = `❌ ERROR: ${error.message}`;
                    resultEl.className = 'text-xs text-red-700';
                    resultEl.classList.remove('hidden');
                }
                showSaveVerifyToast(false, 'Write Test Error', error.message);
            } finally {
                if (icon) icon.className = 'fas fa-edit';
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // PLATFORM SNAPSHOT - Update Health Panel
        // ═══════════════════════════════════════════════════════════════════════════
        function updateTruthHealthPanel(snapshot) {
            const grid = document.getElementById('truth-health-grid');
            const statusBadge = document.getElementById('truth-health-status');
            
            if (!grid || !snapshot) return;
            
            // Extract key metrics
            const controlPlane = snapshot.providers?.controlPlane?.data || {};
            const dynamicFlow = snapshot.providers?.dynamicFlow?.data || {};
            const callProtection = snapshot.providers?.callProtection?.data || {};
            const drift = snapshot.drift || {};
            const completeness = snapshot.completeness || {};

            // ───────────────────────────────────────────────────────────────
            // HARMONY LOCK: Snapshot ECV vs Runtime Truth ECV
            // ───────────────────────────────────────────────────────────────
            try {
                const banner = document.getElementById('truth-drift-banner');
                const ecvSnapEl = document.getElementById('truth-ecv-snapshot');
                const ecvRunEl = document.getElementById('truth-ecv-runtime');
                const snapshotECV = snapshot?.meta?.effectiveConfigVersion || null;
                const runtimeECV = currentRuntimeTruth?._meta?.effectiveConfigVersion || null;

                if (ecvSnapEl) ecvSnapEl.textContent = snapshotECV || '(missing)';
                if (ecvRunEl) ecvRunEl.textContent = runtimeECV || '(missing)';

                const driftDetected = !!(snapshotECV && runtimeECV && snapshotECV !== runtimeECV);
                if (banner) {
                    banner.style.display = driftDetected ? 'block' : 'none';
                }
            } catch {}
            
            const frontDesk = controlPlane.frontDesk || {};
            const flows = dynamicFlow.flows || [];
            const firstFlow = flows[0] || {};
            
            // Build health metrics
            const metrics = [
                {
                    label: 'Greeting',
                    value: frontDesk.greetingConfigured ? '✅ Configured' : '❌ Missing',
                    detail: frontDesk.greetingSource || 'none',
                    ok: frontDesk.greetingConfigured
                },
                {
                    label: 'Dynamic Flow',
                    value: dynamicFlow.flowsInvalid === 0 ? '✅ Valid' : `❌ ${dynamicFlow.flowsInvalid} Invalid`,
                    detail: `${dynamicFlow.flowsTotal || 0} flows`,
                    ok: dynamicFlow.flowsInvalid === 0
                },
                {
                    label: 'Trigger Phrases',
                    value: firstFlow.triggerPhraseCount > 0 ? `✅ ${firstFlow.triggerPhraseCount}` : '❌ 0',
                    detail: firstFlow.flowKey || '-',
                    ok: firstFlow.triggerPhraseCount > 0
                },
                {
                    label: 'Actions',
                    value: firstFlow.actionsCount || 0,
                    detail: (dynamicFlow.actionTypesUsed || []).join(', ') || '-',
                    ok: firstFlow.actionsCount >= 4
                },
                {
                    label: 'Call Protection',
                    value: (callProtection.invalidRules || []).length === 0 ? '✅ Valid' : `❌ ${callProtection.invalidRules?.length} Invalid`,
                    detail: `${callProtection.rulesTotal || 0} rules`,
                    ok: (callProtection.invalidRules || []).length === 0
                },
                {
                    label: 'Warnings',
                    value: (drift.warnings || []).length,
                    detail: (drift.warnings || []).slice(0, 2).join(', ') || 'None',
                    ok: (drift.warnings || []).length === 0
                },
                {
                    label: 'Score',
                    value: `${completeness.score || 0}%`,
                    detail: completeness.grade || '-',
                    ok: (completeness.score || 0) >= 80
                },
                {
                    label: 'Status',
                    value: completeness.status || '-',
                    detail: completeness.summary?.split('.')[0] || '-',
                    ok: completeness.status === 'GREEN'
                }
            ];
            
            // Render metrics
            grid.innerHTML = metrics.map(m => `
                <div class="p-2 bg-white rounded border ${m.ok ? 'border-green-200' : 'border-red-200'}">
                    <div class="text-xs text-gray-500 truncate">${m.label}</div>
                    <div class="font-semibold ${m.ok ? 'text-green-700' : 'text-red-700'}">${m.value}</div>
                    <div class="text-xs text-gray-400 truncate" title="${m.detail}">${m.detail}</div>
                </div>
            `).join('');
            
            // Update overall status
            const allOk = metrics.every(m => m.ok);
            const someOk = metrics.some(m => m.ok);
            
            if (allOk) {
                statusBadge.textContent = '🟢 HEALTHY';
                statusBadge.className = 'ml-auto px-2 py-0.5 text-xs font-bold rounded-full bg-green-100 text-green-800';
            } else if (someOk) {
                statusBadge.textContent = '🟡 WARNINGS';
                statusBadge.className = 'ml-auto px-2 py-0.5 text-xs font-bold rounded-full bg-yellow-100 text-yellow-800';
            } else {
                statusBadge.textContent = '🔴 ISSUES';
                statusBadge.className = 'ml-auto px-2 py-0.5 text-xs font-bold rounded-full bg-red-100 text-red-800';
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // PLATFORM SNAPSHOT - Show Error
        // ═══════════════════════════════════════════════════════════════════════════
        function showTruthError(message) {
            const grid = document.getElementById('truth-health-grid');
            const viewer = document.getElementById('truth-json-viewer');
            const statusBadge = document.getElementById('truth-health-status');
            
            if (grid) grid.innerHTML = `<div class="col-span-4 p-4 bg-red-50 text-red-700 rounded">Error: ${message}</div>`;
            if (viewer) viewer.textContent = `Error loading snapshot: ${message}`;
            if (statusBadge) {
                statusBadge.textContent = '🔴 ERROR';
                statusBadge.className = 'ml-auto px-2 py-0.5 text-xs font-bold rounded-full bg-red-100 text-red-800';
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // PLATFORM SNAPSHOT - Copy to Clipboard
        // ═══════════════════════════════════════════════════════════════════════════
        async function copyTruthReport() {
            const dataToCopy = currentTruthTab === 'dbecho' ? currentDbEcho : currentTruthSnapshot;
            const label = currentTruthTab === 'dbecho' ? 'DB Echo' : 'Runtime Snapshot';
            
            if (!dataToCopy) {
                alert(`No ${label} loaded`);
                return;
            }
            
            const btn = document.getElementById('copy-json-btn');
            const icon = document.getElementById('copy-json-icon');
            const text = document.getElementById('copy-json-text');
            
            // Press effect
            if (btn) {
                btn.style.transform = 'scale(0.95)';
                btn.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
            }
            
            try {
                const jsonString = JSON.stringify(dataToCopy, null, 2);
                await navigator.clipboard.writeText(jsonString);
                
                // Success visual feedback
                if (btn) {
                    btn.style.backgroundColor = '#059669'; // Green
                }
                if (icon) {
                    icon.className = 'fas fa-check';
                }
                if (text) {
                    text.textContent = 'Copied!';
                }
                
                // Calculate stats for popup
                const lines = jsonString.split('\n').length;
                const sizeKB = (new Blob([jsonString]).size / 1024).toFixed(1);
                const providersCount = Object.keys(dataToCopy.providers || {}).length;
                const score = dataToCopy.completeness?.score || 'N/A';
                const status = dataToCopy.completeness?.status || 'N/A';
                
                // Show detailed popup
                showCopyPopup({
                    label,
                    lines,
                    sizeKB,
                    providersCount,
                    score,
                    status,
                    companyName: dataToCopy.meta?.companyName || dataToCopy.company?.companyName || 'Unknown'
                });
                
                // Reset button after delay
                setTimeout(() => {
                    if (btn) {
                        btn.style.transform = 'scale(1)';
                        btn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
                        btn.style.backgroundColor = '#4f46e5'; // Back to indigo
                    }
                    if (icon) {
                        icon.className = 'fas fa-copy';
                    }
                    if (text) {
                        text.textContent = 'Copy JSON';
                    }
                }, 2000);
                
            } catch (error) {
                console.error('[PLATFORM SNAPSHOT] Copy failed:', error);
                
                // Reset press effect
                if (btn) {
                    btn.style.transform = 'scale(1)';
                    btn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
                    btn.style.backgroundColor = '#dc2626'; // Red for error
                }
                
                alert('Failed to copy: ' + error.message);
                
                setTimeout(() => {
                    if (btn) btn.style.backgroundColor = '#4f46e5';
                }, 2000);
            }
        }
        
        // Show copy popup with details
        function showCopyPopup(data) {
            // Remove any existing popup
            const existingPopup = document.getElementById('copy-popup');
            if (existingPopup) existingPopup.remove();
            
            const popup = document.createElement('div');
            popup.id = 'copy-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
                color: white;
                padding: 24px 32px;
                border-radius: 12px;
                box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
                z-index: 10001;
                min-width: 320px;
                animation: popupIn 0.3s ease-out;
            `;
            
            popup.innerHTML = `
                <style>
                    @keyframes popupIn {
                        from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                        to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    }
                    @keyframes popupOut {
                        from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                        to { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                    }
                </style>
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 12px;">✅</div>
                    <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 4px;">Copied to Clipboard!</h3>
                    <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">${data.label} for ${data.companyName}</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; text-align: left; background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px;">
                        <div>
                            <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase;">Lines</div>
                            <div style="font-size: 18px; font-weight: bold;">${data.lines.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase;">Size</div>
                            <div style="font-size: 18px; font-weight: bold;">${data.sizeKB} KB</div>
                        </div>
                        <div>
                            <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase;">Providers</div>
                            <div style="font-size: 18px; font-weight: bold;">${data.providersCount}</div>
                        </div>
                        <div>
                            <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase;">Score</div>
                            <div style="font-size: 18px; font-weight: bold; color: ${data.status === 'GREEN' ? '#22c55e' : data.status === 'YELLOW' ? '#eab308' : '#ef4444'};">
                                ${data.score}%
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Auto-close after 2.5 seconds
            setTimeout(() => {
                popup.style.animation = 'popupOut 0.2s ease-in forwards';
                setTimeout(() => popup.remove(), 200);
            }, 2500);
            
            // Click anywhere to close
            popup.addEventListener('click', () => {
                popup.style.animation = 'popupOut 0.2s ease-in forwards';
                setTimeout(() => popup.remove(), 200);
            });
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // POST-SAVE VERIFICATION SYSTEM
        // ═══════════════════════════════════════════════════════════════════════════
        
        /**
         * Verify that a save operation actually persisted to runtime
         * Call this after any save operation
         * 
         * @param {string} expectedField - e.g., 'greetingConfigured'
         * @param {any} expectedValue - e.g., true
         * @param {string} fieldPath - e.g., 'providers.controlPlane.data.frontDesk.greetingConfigured'
         */
        async function verifySaveWithSnapshot(expectedField, expectedValue, fieldPath) {
            const companyId = window.currentCompanyId || window.companyId;
            if (!companyId) {
                showSaveVerifyToast(false, 'Verification Failed', 'No company ID');
                return false;
            }
            
            try {
                const authToken = localStorage.getItem('adminToken');
                const response = await fetch(`/api/company/${companyId}/platform-snapshot?scope=full`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const snapshot = await response.json();
                
                // Navigate to the field
                const actualValue = getNestedValue(snapshot, fieldPath);
                
                if (actualValue === expectedValue) {
                    showSaveVerifyToast(true, 'Saved & Verified', `${expectedField} updated in runtime`);
                    return true;
                } else {
                    showSaveVerifyToast(false, 'Save Mismatch', `${expectedField}: expected ${expectedValue}, got ${actualValue}`);
                    return false;
                }
                
            } catch (error) {
                console.error('[VERIFY SAVE] Error:', error);
                showSaveVerifyToast(false, 'Verification Failed', error.message);
                return false;
            }
        }
        
        /**
         * Get nested value from object by path
         */
        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => current?.[key], obj);
        }
        
        /**
         * Show save verification toast
         */
        function showSaveVerifyToast(success, title, detail) {
            const toast = document.getElementById('save-verify-toast');
            const content = document.getElementById('save-verify-toast-content');
            const icon = document.getElementById('save-verify-toast-icon');
            const titleEl = document.getElementById('save-verify-toast-title');
            const detailEl = document.getElementById('save-verify-toast-detail');
            
            if (!toast) return;
            
            // Update content
            if (success) {
                content.className = 'px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] bg-green-600 text-white';
                icon.className = 'fas fa-check-circle text-xl';
            } else {
                content.className = 'px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] bg-red-600 text-white';
                icon.className = 'fas fa-exclamation-circle text-xl';
            }
            
            titleEl.textContent = title;
            detailEl.textContent = detail;
            
            // Show toast
            toast.classList.remove('hidden');
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 4000);
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // FLOW ACTION POPUP (Operator clarity)
        // ═══════════════════════════════════════════════════════════════════════════
        function showFlowActionPopup({ status = 'info', title = 'Flow Action', message = '', details = '', next = '' } = {}) {
            const modal = document.getElementById('flow-action-popup');
            const icon = document.getElementById('flow-action-popup-icon');
            const titleEl = document.getElementById('flow-action-popup-title');
            const msgEl = document.getElementById('flow-action-popup-message');
            const detailsWrap = document.getElementById('flow-action-popup-details-wrap');
            const detailsEl = document.getElementById('flow-action-popup-details');
            const nextWrap = document.getElementById('flow-action-popup-next-wrap');
            const nextEl = document.getElementById('flow-action-popup-next');

            if (!modal) return;

            const iconByStatus = {
                success: { cls: 'fas fa-check-circle', color: '#22c55e' },
                warning: { cls: 'fas fa-exclamation-triangle', color: '#f59e0b' },
                error: { cls: 'fas fa-times-circle', color: '#ef4444' },
                info: { cls: 'fas fa-info-circle', color: '#93c5fd' }
            };
            const picked = iconByStatus[status] || iconByStatus.info;

            if (icon) {
                icon.className = picked.cls;
                icon.style.color = picked.color;
            }
            if (titleEl) titleEl.textContent = title;
            if (msgEl) msgEl.textContent = message;

            const hasDetails = !!(details && String(details).trim().length > 0);
            if (detailsWrap) detailsWrap.style.display = hasDetails ? 'block' : 'none';
            if (detailsEl && hasDetails) detailsEl.textContent = String(details);

            const hasNext = !!(next && String(next).trim().length > 0);
            if (nextWrap) nextWrap.style.display = hasNext ? 'block' : 'none';
            if (nextEl && hasNext) nextEl.textContent = String(next);

            modal.classList.remove('hidden');
        }

        function closeFlowActionPopup() {
            const modal = document.getElementById('flow-action-popup');
            if (!modal) return;
            modal.classList.add('hidden');
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // WRITE TEST DYNAMIC FLOW - End-to-End Verification
        // ═══════════════════════════════════════════════════════════════════════════
        async function writeTestDynamicFlow() {
            const companyId = window.currentCompanyId || window.companyId;
            if (!companyId) {
                alert('No company ID found');
                return;
            }
            
            const icon = document.getElementById('write-test-flow-icon');
            const resultEl = document.getElementById('write-test-result');
            
            if (icon) icon.className = 'fas fa-spinner fa-spin';
            if (resultEl) resultEl.classList.add('hidden');
            
            try {
                const authToken = localStorage.getItem('adminToken');
                
                // Step 1: Write test dynamic flow
                const writeResponse = await fetch(`/api/company/${companyId}/raw/write-test-dynamic-flow`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!writeResponse.ok) {
                    throw new Error(`Write failed: HTTP ${writeResponse.status}`);
                }
                
                const writeResult = await writeResponse.json();
                
                // Step 2: Refresh Platform Snapshot
                await loadTruthReport();
                
                // Step 3: Check snapshot for the test flow
                const verifySnapshot = currentTruthSnapshot;
                const flows = verifySnapshot?.providers?.dynamicFlow?.data?.flows || [];
                const testFlow = flows.find(f => f.flowKey === 'emergency_service_test');
                
                // Show result
                if (resultEl) {
                    const v = writeResult.verification;
                    if (writeResult.success && testFlow && testFlow.triggerPhraseCount > 0 && testFlow.actionsCount === 4) {
                        resultEl.innerHTML = `
                            <div class="p-2 bg-green-100 rounded">
                                <strong class="text-green-800">✅ DYNAMIC FLOW TEST PASSED</strong><br>
                                <span class="text-green-700">
                                    DB: triggerType=${v.triggerType}, phrases=${v.triggerPhrasesCount}, actions=${v.actionsCount}<br>
                                    Snapshot: triggerType=${testFlow.triggerType}, phrases=${testFlow.triggerPhraseCount}, actions=${testFlow.actionsCount}<br>
                                    Schema: ${testFlow.schemaUsed || 'unknown'}
                                </span>
                            </div>
                        `;
                        showSaveVerifyToast(true, 'Dynamic Flow Test PASSED', `${v.actionsCount} actions, ${v.triggerPhrasesCount} phrases`);
                    } else {
                        resultEl.innerHTML = `
                            <div class="p-2 bg-red-100 rounded">
                                <strong class="text-red-800">❌ DYNAMIC FLOW TEST FAILED</strong><br>
                                <span class="text-red-700">
                                    DB Verification: ${JSON.stringify(v, null, 2)}<br>
                                    Snapshot Flow: ${testFlow ? JSON.stringify(testFlow, null, 2) : 'NOT FOUND IN SNAPSHOT'}
                                </span>
                            </div>
                        `;
                        showSaveVerifyToast(false, 'Dynamic Flow Test FAILED', 'Check result details');
                    }
                    resultEl.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('[WRITE TEST] Dynamic Flow Error:', error);
                if (resultEl) {
                    resultEl.innerHTML = `<div class="p-2 bg-red-100 rounded text-red-800">❌ ERROR: ${error.message}</div>`;
                    resultEl.classList.remove('hidden');
                }
                showSaveVerifyToast(false, 'Write Test Error', error.message);
            } finally {
                if (icon) icon.className = 'fas fa-project-diagram';
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // MANUAL SAVE - Greeting and Flow JSON
        // ═══════════════════════════════════════════════════════════════════════════
        
        // Load the V2 emergency flow template into the textarea
        function loadEmergencyFlowTemplate() {
            const template = {
                flowKey: "emergency_service",
                name: "Emergency Service Detection",
                enabled: true,
                priority: 200,
                
                trigger: {
                    type: "phrase",
                    config: {
                        phrases: [
                            "emergency",
                            "urgent",
                            "no AC",
                            "ac not working",
                            "water leaking",
                            "flooding",
                            "smell gas",
                            "burning smell",
                            "sparking",
                            "smoke"
                        ],
                        fuzzy: true,
                        minConfidence: 0.7
                    }
                },
                
                actions: [
                    {
                        timing: "on_activate",
                        type: "set_flag",
                        config: {
                            flagName: "isEmergency",
                            flagValue: true,
                            alsoWriteToCallLedgerFacts: true
                        }
                    },
                    {
                        timing: "on_activate",
                        type: "append_ledger",
                        config: {
                            key: "alerts",
                            value: "Emergency detected by phrase trigger"
                        }
                    },
                    {
                        timing: "on_activate",
                        type: "ack_once",
                        config: {
                            key: "ack_emergency_service",
                            response: "Understood — this sounds urgent. I'm going to prioritize this right now."
                        }
                    },
                    {
                        timing: "on_activate",
                        type: "transition_mode",
                        config: {
                            mode: "EMERGENCY"
                        }
                    }
                ],
                
                settings: {
                    allowConcurrent: false
                }
            };
            
            document.getElementById('manual-flow-json-input').value = JSON.stringify(template, null, 2);
            showSaveVerifyToast(true, 'Template Loaded', 'V2 emergency flow template ready to save');
        }
        
        // Validate flow JSON without saving
        function validateFlowJson() {
            const textarea = document.getElementById('manual-flow-json-input');
            const resultEl = document.getElementById('manual-save-result');
            
            try {
                const flow = JSON.parse(textarea.value);
                
                const errors = [];
                if (!flow.flowKey) errors.push('Missing flowKey');
                if (!flow.trigger?.type) errors.push('Missing trigger.type');
                if (flow.trigger?.type === 'phrase' && (!flow.trigger?.config?.phrases || flow.trigger.config.phrases.length === 0)) {
                    errors.push('Missing trigger.config.phrases for phrase trigger');
                }
                if (!flow.actions || flow.actions.length === 0) errors.push('Missing actions array');
                
                const actionTypes = (flow.actions || []).map(a => a.type);
                const required = ['set_flag', 'append_ledger', 'ack_once', 'transition_mode'];
                const missing = required.filter(t => !actionTypes.includes(t));
                if (missing.length > 0) errors.push(`Missing actions: ${missing.join(', ')}`);
                
                if (errors.length > 0) {
                    resultEl.innerHTML = `<div style="padding: 10px; background-color: #fef3c7; border-radius: 6px; color: #92400e; border: 1px solid #f59e0b;">⚠️ Validation Issues:<br>${errors.join('<br>')}</div>`;
                    showFlowActionPopup({
                        status: 'warning',
                        title: 'Validate Flow',
                        message: 'Flow JSON parsed, but the schema has validation issues. Nothing was saved.',
                        details: errors.join('\n'),
                        next: 'Fix the listed issues, then click Validate again. Only click “Save Flow” after Validate is clean.'
                    });
                } else {
                    resultEl.innerHTML = `<div style="padding: 10px; background-color: #dcfce7; border-radius: 6px; color: #166534; border: 1px solid #16a34a;">✅ Valid V2 schema! Ready to save.</div>`;
                    showFlowActionPopup({
                        status: 'success',
                        title: 'Validate Flow',
                        message: 'Validation passed. This flow JSON is valid and ready to save.',
                        details: `flowKey: ${flow.flowKey}\ntrigger.type: ${flow.trigger?.type}\nactions: ${(flow.actions || []).length}`,
                        next: 'If you intended to write this flow into the database, click “Save Flow”. Otherwise, close this panel.'
                    });
                }
                resultEl.style.display = 'block';
                
            } catch (e) {
                resultEl.innerHTML = `<div style="padding: 10px; background-color: #fee2e2; border-radius: 6px; color: #991b1b; border: 1px solid #ef4444;">❌ Invalid JSON: ${e.message}</div>`;
                resultEl.style.display = 'block';
                showFlowActionPopup({
                    status: 'error',
                    title: 'Validate Flow',
                    message: 'Validation failed because the JSON is not valid. Nothing was saved.',
                    details: e.message,
                    next: 'Click “LOAD TEMPLATE” or paste a complete JSON object, then click Validate again.'
                });
            }
        }
        
        // Save greeting to DB
        async function saveManualGreeting() {
            const companyId = window.currentCompanyId || window.companyId;
            if (!companyId) return alert('No company ID');
            
            const greeting = document.getElementById('manual-greeting-input').value.trim();
            if (!greeting) return alert('Please enter a greeting');
            
            const icon = document.getElementById('save-greeting-icon');
            const resultEl = document.getElementById('manual-save-result');
            
            if (icon) icon.className = 'fas fa-spinner fa-spin';
            
            try {
                const authToken = localStorage.getItem('adminToken');
                const response = await fetch(`/api/company/${companyId}/raw/save-greeting`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ greeting })
                });
                
                const result = await response.json();
                
                // Refresh Platform Snapshot
                await loadTruthReport();
                
                if (result.success) {
                    resultEl.innerHTML = `<div style="padding: 10px; background-color: #dcfce7; border-radius: 6px; color: #166534; border: 1px solid #16a34a;">✅ Greeting saved! Check snapshot for greetingConfigured.</div>`;
                    showSaveVerifyToast(true, 'Greeting Saved', result.savedTo);
                } else {
                    resultEl.innerHTML = `<div style="padding: 10px; background-color: #fee2e2; border-radius: 6px; color: #991b1b; border: 1px solid #ef4444;">❌ ${result.error}</div>`;
                    showSaveVerifyToast(false, 'Save Failed', result.error);
                }
                resultEl.style.display = 'block';
                
            } catch (error) {
                resultEl.innerHTML = `<div style="padding: 10px; background-color: #fee2e2; border-radius: 6px; color: #991b1b; border: 1px solid #ef4444;">❌ Error: ${error.message}</div>`;
                resultEl.style.display = 'block';
                showSaveVerifyToast(false, 'Error', error.message);
            } finally {
                if (icon) icon.className = 'fas fa-save';
            }
        }
        
        // Save flow JSON to DB
        async function saveManualFlowJson() {
            const companyId = window.currentCompanyId || window.companyId;
            if (!companyId) return alert('No company ID');
            
            const textarea = document.getElementById('manual-flow-json-input');
            const resultEl = document.getElementById('manual-save-result');
            const icon = document.getElementById('save-flow-icon');
            
            let flow;
            try {
                flow = JSON.parse(textarea.value);
            } catch (e) {
                resultEl.innerHTML = `<div style="padding: 10px; background-color: #fee2e2; border-radius: 6px; color: #991b1b; border: 1px solid #ef4444;">❌ Invalid JSON: ${e.message}</div>`;
                resultEl.style.display = 'block';
                showFlowActionPopup({
                    status: 'error',
                    title: 'Save Flow',
                    message: 'Save was blocked because the JSON is invalid. Nothing was saved to the database.',
                    details: e.message,
                    next: 'Click “Validate” to see what’s wrong, or click “LOAD TEMPLATE” to generate a valid starter flow.'
                });
                return;
            }

            // Operator clarity: confirm intent (this writes directly to DB)
            showFlowActionPopup({
                status: 'info',
                title: 'Save Flow',
                message: `You are about to save a flow JSON directly to the database for this company.`,
                details: `companyId: ${companyId}\nflowKey: ${flow.flowKey || 'missing'}\nactions: ${(flow.actions || []).length}`,
                next: 'If this was accidental: close this popup and DO NOT click “Save Flow” again. If intentional: proceed and watch for “Flow Saved”.'
            });
            
            if (icon) icon.className = 'fas fa-spinner fa-spin';
            
            try {
                const authToken = localStorage.getItem('adminToken');
                const response = await fetch(`/api/company/${companyId}/raw/save-flow-json`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ flow })
                });
                
                const result = await response.json();
                
                // Refresh Platform Snapshot
                await loadTruthReport();
                
                if (result.success) {
                    const v = result.verification;
                    resultEl.innerHTML = `
                        <div style="padding: 10px; background-color: #dcfce7; border-radius: 6px; color: #166534; border: 1px solid #16a34a;">
                            ✅ Flow "${v.flowKey}" saved!<br>
                            Schema: ${v.schemaUsed}, Phrases: ${v.triggerPhrasesCount}, Actions: ${v.actionsCount}<br>
                            Types: ${v.actionTypes.join(', ')}
                        </div>
                    `;
                    showSaveVerifyToast(true, 'Flow Saved', `${v.flowKey} with ${v.actionsCount} actions`);
                    showFlowActionPopup({
                        status: 'success',
                        title: 'Save Flow',
                        message: 'Flow saved successfully to the database and snapshot refreshed.',
                        details: `flowKey: ${v.flowKey}\nschemaUsed: ${v.schemaUsed}\ntriggerPhrases: ${v.triggerPhrasesCount}\nactions: ${v.actionsCount}\nactionTypes: ${Array.isArray(v.actionTypes) ? v.actionTypes.join(', ') : ''}`,
                        next: 'Click Refresh at the top of this modal and confirm Dynamic Flow shows Valid. Then use Runtime Truth (Canonical) to prove enforcement.'
                    });
                } else {
                    const errorsHtml = result.validationErrors ? 
                        result.validationErrors.map(e => `• ${e}`).join('<br>') : result.error;
                    resultEl.innerHTML = `<div style="padding: 10px; background-color: #fee2e2; border-radius: 6px; color: #991b1b; border: 1px solid #ef4444;">❌ ${errorsHtml}</div>`;
                    showSaveVerifyToast(false, 'Save Failed', result.error);
                    showFlowActionPopup({
                        status: 'error',
                        title: 'Save Flow',
                        message: 'Save failed. The server rejected the flow or returned validation errors.',
                        details: result.validationErrors ? result.validationErrors.join('\n') : (result.error || 'Unknown error'),
                        next: 'Click Validate first, then fix the errors and try Save again.'
                    });
                }
                resultEl.style.display = 'block';
                
            } catch (error) {
                resultEl.innerHTML = `<div style="padding: 10px; background-color: #fee2e2; border-radius: 6px; color: #991b1b; border: 1px solid #ef4444;">❌ Error: ${error.message}</div>`;
                resultEl.style.display = 'block';
                showSaveVerifyToast(false, 'Error', error.message);
                showFlowActionPopup({
                    status: 'error',
                    title: 'Save Flow',
                    message: 'Save failed due to a network/server error.',
                    details: error.message,
                    next: 'Try Refresh, then Save again. If it continues, copy the error and send it to engineering.'
                });
            } finally {
                if (icon) icon.className = 'fas fa-save';
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CONVERT FLOW TO V2 - Fix legacy flows
        // ═══════════════════════════════════════════════════════════════════════════
        async function populateLegacyFlowSelector() {
            const selector = document.getElementById('legacy-flow-selector');
            if (!selector) return;
            
            // Get flows from current snapshot
            const flows = currentTruthSnapshot?.providers?.dynamicFlow?.data?.flows || [];
            
            selector.innerHTML = '';
            
            if (flows.length === 0) {
                selector.innerHTML = '<option value="">No flows found</option>';
                return;
            }
            
            // Add each flow, highlighting legacy ones
            flows.forEach(f => {
                const option = document.createElement('option');
                option.value = f.flowKey;
                const status = f.schemaUsed === 'legacy' ? '⚠️ LEGACY' : '✓ v2';
                const issues = f.isValid ? '' : ' (INVALID)';
                option.textContent = `${f.flowKey} [${status}]${issues}`;
                if (f.schemaUsed === 'legacy' || !f.isValid) {
                    option.style.color = '#dc2626';
                    option.style.fontWeight = 'bold';
                }
                selector.appendChild(option);
            });
        }
        
        async function convertFlowToV2() {
            const companyId = window.currentCompanyId || window.companyId;
            const selector = document.getElementById('legacy-flow-selector');
            const flowKey = selector?.value;
            
            if (!companyId || !flowKey) {
                alert('Please select a flow to convert');
                return;
            }
            
            const icon = document.getElementById('convert-flow-icon');
            const resultEl = document.getElementById('convert-result');
            
            if (icon) icon.className = 'fas fa-spinner fa-spin';
            if (resultEl) resultEl.classList.add('hidden');
            
            try {
                const authToken = localStorage.getItem('adminToken');
                
                // Step 1: Convert the flow
                const convertResponse = await fetch(`/api/company/${companyId}/raw/convert-flow-to-v2`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ flowKey })
                });
                
                if (!convertResponse.ok) {
                    const errData = await convertResponse.json();
                    throw new Error(errData.error || `HTTP ${convertResponse.status}`);
                }
                
                const convertResult = await convertResponse.json();
                
                // Step 2: Refresh Platform Snapshot
                await loadTruthReport();
                
                // Step 3: Verify in snapshot
                const flows = currentTruthSnapshot?.providers?.dynamicFlow?.data?.flows || [];
                const updatedFlow = flows.find(f => f.flowKey === flowKey);
                
                // Update selector
                await populateLegacyFlowSelector();
                
                // Show result
                if (resultEl) {
                    const v = convertResult.verification;
                    if (convertResult.success && updatedFlow && updatedFlow.schemaUsed === 'v2') {
                        resultEl.innerHTML = `
                            <div class="p-2 bg-green-100 rounded">
                                <strong class="text-green-800">✅ CONVERSION SUCCESSFUL</strong><br>
                                <span class="text-green-700">
                                    Previous: ${convertResult.previousSchema}<br>
                                    Now: schema=${v.schemaUsed}, phrases=${v.triggerPhrasesCount}, actions=${v.actionsCount}<br>
                                    Phrases: ${v.triggerPhrasesSample?.join(', ') || 'none'}
                                </span>
                            </div>
                        `;
                        showSaveVerifyToast(true, 'Conversion PASSED', `${flowKey} is now V2`);
                    } else {
                        resultEl.innerHTML = `
                            <div class="p-2 bg-yellow-100 rounded">
                                <strong class="text-yellow-800">⚠️ CONVERSION PARTIAL</strong><br>
                                <span class="text-yellow-700">
                                    Result: ${JSON.stringify(v, null, 2)}<br>
                                    Snapshot: ${updatedFlow ? JSON.stringify(updatedFlow, null, 2) : 'NOT FOUND'}
                                </span>
                            </div>
                        `;
                        showSaveVerifyToast(false, 'Conversion needs review', 'Check details');
                    }
                    resultEl.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('[CONVERT] Error:', error);
                if (resultEl) {
                    resultEl.innerHTML = `<div class="p-2 bg-red-100 rounded text-red-800">❌ ERROR: ${error.message}</div>`;
                    resultEl.classList.remove('hidden');
                }
                showSaveVerifyToast(false, 'Conversion Error', error.message);
            } finally {
                if (icon) icon.className = 'fas fa-magic';
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CLEANUP TEST FLOWS - Remove test data
        // ═══════════════════════════════════════════════════════════════════════════
        async function cleanupTestFlows() {
            const companyId = window.currentCompanyId || window.companyId;
            if (!companyId) return;
            
            if (!confirm('Delete all test flows (emergency_service_test, DEBUG_*)?')) return;
            
            try {
                const authToken = localStorage.getItem('adminToken');
                const response = await fetch(`/api/company/${companyId}/raw/cleanup-test-flows`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSaveVerifyToast(true, 'Cleanup Complete', `Deleted ${result.deletedCount} test flows`);
                    await loadTruthReport();
                } else {
                    showSaveVerifyToast(false, 'Cleanup Failed', result.error);
                }
                
            } catch (error) {
                showSaveVerifyToast(false, 'Cleanup Error', error.message);
            }
        }
        
        // Export for use by other scripts
        window.verifySaveWithSnapshot = verifySaveWithSnapshot;
        window.showSaveVerifyToast = showSaveVerifyToast;
        window.openTruthReport = openTruthReport;
        window.closeTruthReport = closeTruthReport;
        window.refreshTruthReport = refreshTruthReport;
        window.copyTruthReport = copyTruthReport;
        window.switchTruthTab = switchTruthTab;
        window.loadDbEcho = loadDbEcho;
        window.writeTestGreeting = writeTestGreeting;
        window.writeTestDynamicFlow = writeTestDynamicFlow;
        window.cleanupTestFlows = cleanupTestFlows;
        window.convertFlowToV2 = convertFlowToV2;
        window.populateLegacyFlowSelector = populateLegacyFlowSelector;
        window.saveManualGreeting = saveManualGreeting;
        window.saveManualFlowJson = saveManualFlowJson;
        window.validateFlowJson = validateFlowJson;
        window.loadEmergencyFlowTemplate = loadEmergencyFlowTemplate;
    </script>
    
    <!-- Load Company Profile Modern JavaScript -->
    <script src="/js/company-profile-modern.js?v=2.21"></script>
    
    <!-- Main Page Initialization Script -->
    <script>
        // Open Control Plane with current companyId
        function openControlPlane(event) {
            if (event) event.preventDefault();
            const companyId = window.currentCompanyId || window.companyId || localStorage.getItem('currentCompanyId');
            if (companyId) {
                window.location.href = `/control-plane-v2.html?companyId=${companyId}`;
            } else {
                alert('No company selected. Please select a company first.');
            }
        }

        // Main initialization when page loads
        document.addEventListener('DOMContentLoaded', function() {
            
            // Wire up the AiCore Control Center button
            const controlPlaneBtn = document.getElementById('open-aicore-control-plane-btn');
            if (controlPlaneBtn) {
                controlPlaneBtn.addEventListener('click', openControlPlane);
            }
            
            // Hash-based navigation support (for back button from Control Plane)
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                setTimeout(() => {
                    const tabButton = document.getElementById(`tab-${hash}`);
                    if (tabButton) {
                        console.log(`🔗 [COMPANY PROFILE] Hash navigation: activating tab "${hash}"`);
                        tabButton.click();
                    }
                }, 500); // Give time for page to fully initialize
            }
            
            // Get company ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const companyId = urlParams.get('id');
            
            if (companyId) {
                
                // Set global company ID
                window.companyId = companyId;
                window.currentCompanyId = companyId;
                
                // Store in localStorage for persistence
                localStorage.setItem('currentCompanyId', companyId);
                
                // Start fetching company data immediately
                
                // Wait a moment for all scripts to load
                setTimeout(() => {
                    if (typeof fetchCompanyData === 'function') {
                        fetchCompanyData();
                    } else if (window.companyProfileManager && typeof window.companyProfileManager.loadCompanyData === 'function') {
                        window.companyProfileManager.loadCompanyData();
                    } else {
                    }
                }, 100);
                
                // Initialize Google Calendar after short delay
                setTimeout(() => {
                    if (typeof initGoogleCalendar === 'function') {
                        initGoogleCalendar(companyId);
                    }
                }, 200);
                
                // Check for Google Calendar OAuth callback params
                const gcSuccess = urlParams.get('gcSuccess');
                const gcError = urlParams.get('gcError');
                const gcEmail = urlParams.get('gcEmail');
                
                if (gcSuccess === 'true') {
                    // Show success notification
                    setTimeout(() => {
                        alert(`✅ Google Calendar connected successfully!\n\nAccount: ${gcEmail || 'Unknown'}\n\nYour AI receptionist can now check real-time availability and create appointments.`);
                        // Clean URL
                        window.history.replaceState({}, '', `?id=${companyId}`);
                        // Refresh calendar status
                        if (typeof initGoogleCalendar === 'function') {
                            initGoogleCalendar(companyId);
                        }
                    }, 500);
                } else if (gcError) {
                    // Show error notification
                    setTimeout(() => {
                        alert(`❌ Google Calendar connection failed:\n\n${decodeURIComponent(gcError)}\n\nPlease try again.`);
                        // Clean URL
                        window.history.replaceState({}, '', `?id=${companyId}`);
                    }, 500);
                }
            } else {
                const container = document.querySelector('.profile-container');
                if (container) {
                    container.innerHTML = '<div class="p-8 text-center"><h1 class="text-2xl font-bold text-red-600">Error: No company ID provided</h1><p class="text-gray-600 mt-2">Please access this page with a valid company ID.</p></div>';
                }
            }
        });
        
        // ════════════════════════════════════════════════════════════════════════════════
        // AUTH TOKEN HELPER (must be defined early for calendar/SMS init)
        // ════════════════════════════════════════════════════════════════════════════════
        function getAuthToken(){
            return localStorage.getItem("adminToken") || localStorage.getItem("token") || "";
        }
        
        // ════════════════════════════════════════════════════════════════════════════════
        // GOOGLE CALENDAR INTEGRATION - V88 (Jan 2026)
        // ════════════════════════════════════════════════════════════════════════════════
        
        async function initGoogleCalendar(companyId) {
            console.log('📅 [GOOGLE CALENDAR] Initializing...');
            
            const loadingEl = document.getElementById('gc-loading');
            const notConfiguredEl = document.getElementById('gc-not-configured');
            const notConnectedEl = document.getElementById('gc-not-connected');
            const connectedEl = document.getElementById('gc-connected');
            const errorEl = document.getElementById('gc-error');
            const settingsPanel = document.getElementById('gc-settings-panel');
            
            // Helper to hide all states
            function hideAllStates() {
                loadingEl?.classList.add('hidden');
                notConfiguredEl?.classList.add('hidden');
                notConnectedEl?.classList.add('hidden');
                connectedEl?.classList.add('hidden');
                errorEl?.classList.add('hidden');
                settingsPanel?.classList.add('hidden');
            }
            
            try {
                const token = getAuthToken(); // Use consistent token retrieval
                const response = await fetch(`/api/company/${companyId}/google-calendar/status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                console.log('📅 [GOOGLE CALENDAR] Status:', data);
                
                hideAllStates();
                
                if (!data.success) {
                    errorEl?.classList.remove('hidden');
                    document.getElementById('gc-error-message').textContent = data.error || 'Unknown error';
                    return;
                }
                
                if (!data.platformConfigured) {
                    notConfiguredEl?.classList.remove('hidden');
                    return;
                }
                
                if (!data.connected) {
                    notConnectedEl?.classList.remove('hidden');
                } else {
                    connectedEl?.classList.remove('hidden');
                    settingsPanel?.classList.remove('hidden');
                    
                    // Populate connected info
                    document.getElementById('gc-calendar-name').textContent = data.calendarName || 'Primary Calendar';
                    document.getElementById('gc-calendar-email').textContent = data.calendarEmail || '-';
                    document.getElementById('gc-connected-at').textContent = data.connectedAt 
                        ? new Date(data.connectedAt).toLocaleDateString() 
                        : '-';
                    
                    // Set enabled toggle
                    const enabledToggle = document.getElementById('gc-enabled-toggle');
                    if (enabledToggle) enabledToggle.checked = data.enabled !== false;
                    
                    // Populate settings
                    const settings = data.settings || {};
                    document.getElementById('gc-buffer-minutes').value = settings.bufferMinutes || 60;
                    document.getElementById('gc-duration-minutes').value = settings.defaultDurationMinutes || 60;
                    document.getElementById('gc-max-days').value = settings.maxBookingDaysAhead || 30;
                    document.getElementById('gc-fallback-mode').value = settings.fallbackMode || 'preference_capture';
                    document.getElementById('gc-include-phone').checked = settings.includeCustomerPhone !== false;
                    document.getElementById('gc-include-address').checked = settings.includeCustomerAddress !== false;
                    document.getElementById('gc-include-notes').checked = settings.includeServiceNotes !== false;
                    document.getElementById('gc-send-invite').checked = settings.sendCustomerInvite === true;
                    document.getElementById('gc-event-title').value = settings.eventTitleTemplate || '{serviceType} - {customerName}';
                    
                    // Populate event color settings
                    const eventColors = data.eventColors || {};
                    document.getElementById('gc-colors-enabled').checked = eventColors.enabled !== false;
                    document.getElementById('gc-default-color').value = eventColors.defaultColorId || '7';
                    renderColorMappings(eventColors.colorMapping);
                    
                    // Show error badge if there are errors
                    if (data.consecutiveErrors > 0) {
                        console.warn('📅 [GOOGLE CALENDAR] Has errors:', data.lastError);
                    }
                }
            } catch (err) {
                console.error('📅 [GOOGLE CALENDAR] Init error:', err);
                hideAllStates();
                errorEl?.classList.remove('hidden');
                document.getElementById('gc-error-message').textContent = err.message;
            }
            
            // Wire up event handlers
            wireGoogleCalendarHandlers(companyId);
        }
        
        // Color emoji map for Google Calendar colors
        const GC_COLOR_OPTIONS = [
            { id: '1', emoji: '🟪', name: 'Lavender' },
            { id: '2', emoji: '🟩', name: 'Sage' },
            { id: '3', emoji: '🟣', name: 'Grape' },
            { id: '4', emoji: '🩷', name: 'Flamingo' },
            { id: '5', emoji: '🟨', name: 'Banana' },
            { id: '6', emoji: '🟧', name: 'Tangerine' },
            { id: '7', emoji: '🩵', name: 'Peacock' },
            { id: '8', emoji: '⬜', name: 'Graphite' },
            { id: '9', emoji: '🟦', name: 'Blueberry' },
            { id: '10', emoji: '💚', name: 'Basil' },
            { id: '11', emoji: '🔴', name: 'Tomato' }
        ];
        
        // Default color mappings
        const DEFAULT_COLOR_MAPPINGS = [
            { serviceType: 'service', colorId: '7', label: 'Service Call' },
            { serviceType: 'repair', colorId: '11', label: 'Repair' },
            { serviceType: 'emergency', colorId: '4', label: 'Emergency' },
            { serviceType: 'maintenance', colorId: '10', label: 'Maintenance' },
            { serviceType: 'estimate', colorId: '5', label: 'Estimate' },
            { serviceType: 'sales', colorId: '9', label: 'Sales' },
            { serviceType: 'consultation', colorId: '3', label: 'Consultation' },
            { serviceType: 'installation', colorId: '2', label: 'Installation' },
            { serviceType: 'inspection', colorId: '6', label: 'Inspection' },
            { serviceType: 'other', colorId: '8', label: 'Other' }
        ];
        
        function renderColorMappings(mappings) {
            const container = document.getElementById('gc-color-mappings');
            if (!container) return;
            
            const data = mappings && mappings.length > 0 ? mappings : DEFAULT_COLOR_MAPPINGS;
            
            container.innerHTML = data.map(item => {
                const colorOptions = GC_COLOR_OPTIONS.map(c => 
                    `<option value="${c.id}" ${c.id === item.colorId ? 'selected' : ''}>${c.emoji} ${c.name}</option>`
                ).join('');
                
                return `
                    <div class="gc-color-row flex items-center gap-2 py-1" data-service-type="${item.serviceType}">
                        <span class="text-xs text-gray-500 w-24 capitalize">${item.serviceType}</span>
                        <select class="gc-color-select form-input text-sm py-1 w-36">${colorOptions}</select>
                        <input type="text" class="gc-color-label form-input text-sm py-1 flex-1" value="${item.label || item.serviceType}" placeholder="Label">
                    </div>
                `;
            }).join('');
        }
        
        function wireGoogleCalendarHandlers(companyId) {
            const token = getAuthToken();
            
            // Connect button
            document.getElementById('gc-connect-btn')?.addEventListener('click', async () => {
                try {
                    const response = await fetch(`/api/company/${companyId}/google-calendar/auth-url`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    
                    if (data.success && data.authUrl) {
                        // Redirect to Google OAuth
                        window.location.href = data.authUrl;
                    } else {
                        alert('Failed to generate authorization URL: ' + (data.error || 'Unknown error'));
                    }
                } catch (err) {
                    alert('Error connecting to calendar: ' + err.message);
                }
            });
            
            // Reconnect button (in error state)
            document.getElementById('gc-reconnect-btn')?.addEventListener('click', async () => {
                document.getElementById('gc-connect-btn')?.click();
            });
            
            // Disconnect button
            document.getElementById('gc-disconnect-btn')?.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to disconnect Google Calendar? The AI will switch to preference capture mode.')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/company/${companyId}/google-calendar/disconnect`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('Calendar disconnected successfully');
                        initGoogleCalendar(companyId);
                    } else {
                        alert('Failed to disconnect: ' + (data.error || 'Unknown error'));
                    }
                } catch (err) {
                    alert('Error disconnecting: ' + err.message);
                }
            });
            
            // Test button
            document.getElementById('gc-test-btn')?.addEventListener('click', async () => {
                const btn = document.getElementById('gc-test-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Testing...';
                btn.disabled = true;
                
                try {
                    const response = await fetch(`/api/company/${companyId}/google-calendar/test`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        alert(`✅ Connection successful!\n\nCalendar: ${data.calendarName}\nTimezone: ${data.timezone}`);
                    } else {
                        alert('❌ Connection test failed: ' + (data.error || 'Unknown error'));
                    }
                } catch (err) {
                    alert('Error testing connection: ' + err.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
            
            // Enabled toggle
            document.getElementById('gc-enabled-toggle')?.addEventListener('change', async (e) => {
                try {
                    const response = await fetch(`/api/company/${companyId}/google-calendar/toggle`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ enabled: e.target.checked })
                    });
                    const data = await response.json();
                    
                    if (!data.success) {
                        e.target.checked = !e.target.checked; // Revert
                        alert('Failed to toggle: ' + (data.error || 'Unknown error'));
                    }
                } catch (err) {
                    e.target.checked = !e.target.checked; // Revert
                    alert('Error: ' + err.message);
                }
            });
            
            // Save settings button
            document.getElementById('gc-save-settings-btn')?.addEventListener('click', async () => {
                const btn = document.getElementById('gc-save-settings-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                btn.disabled = true;
                
                try {
                    // Gather color mappings from UI
                    const colorMappings = [];
                    document.querySelectorAll('#gc-color-mappings .gc-color-row').forEach(row => {
                        const serviceType = row.dataset.serviceType;
                        const colorId = row.querySelector('.gc-color-select')?.value || '7';
                        const label = row.querySelector('.gc-color-label')?.value || serviceType;
                        colorMappings.push({ serviceType, colorId, label });
                    });
                    
                    const settings = {
                        bufferMinutes: parseInt(document.getElementById('gc-buffer-minutes').value) || 60,
                        defaultDurationMinutes: parseInt(document.getElementById('gc-duration-minutes').value) || 60,
                        maxBookingDaysAhead: parseInt(document.getElementById('gc-max-days').value) || 30,
                        fallbackMode: document.getElementById('gc-fallback-mode').value,
                        includeCustomerPhone: document.getElementById('gc-include-phone').checked,
                        includeCustomerAddress: document.getElementById('gc-include-address').checked,
                        includeServiceNotes: document.getElementById('gc-include-notes').checked,
                        sendCustomerInvite: document.getElementById('gc-send-invite').checked,
                        eventTitleTemplate: document.getElementById('gc-event-title').value
                    };
                    
                    const eventColors = {
                        enabled: document.getElementById('gc-colors-enabled').checked,
                        colorMapping: colorMappings,
                        defaultColorId: document.getElementById('gc-default-color').value
                    };
                    
                    const response = await fetch(`/api/company/${companyId}/google-calendar/settings`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ settings, eventColors })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('✅ Calendar settings saved!');
                    } else {
                        alert('Failed to save: ' + (data.error || 'Unknown error'));
                    }
                } catch (err) {
                    alert('Error saving settings: ' + err.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
            
            // Refresh button
            document.getElementById('gc-refresh-status')?.addEventListener('click', () => {
                initGoogleCalendar(companyId);
            });
        }
        
        // ════════════════════════════════════════════════════════════════════════════════
        // SMS NOTIFICATIONS - V88 (Jan 2026)
        // ════════════════════════════════════════════════════════════════════════════════
        
        async function initSMSNotifications(companyId) {
            const token = getAuthToken();
            
            // Show loading
            document.getElementById('sms-loading').classList.remove('hidden');
            document.getElementById('sms-no-twilio').classList.add('hidden');
            document.getElementById('sms-ready').classList.add('hidden');
            document.getElementById('sms-settings-panel').classList.add('hidden');
            
            try {
                const response = await fetch(`/api/company/${companyId}/sms-notifications/status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                document.getElementById('sms-loading').classList.add('hidden');
                
                if (!data.hasTwilioCredentials) {
                    document.getElementById('sms-no-twilio').classList.remove('hidden');
                    return;
                }
                
                document.getElementById('sms-ready').classList.remove('hidden');
                
                // Set master toggle
                document.getElementById('sms-master-toggle').checked = data.enabled;
                
                // Show/hide settings based on enabled state
                if (data.enabled) {
                    document.getElementById('sms-settings-panel').classList.remove('hidden');
                }
                
                // Load full settings
                const settingsRes = await fetch(`/api/company/${companyId}/sms-notifications/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const settingsData = await settingsRes.json();
                
                if (settingsData.success) {
                    const s = settingsData.settings;
                    
                    // Confirmation
                    document.getElementById('sms-confirmation-enabled').checked = s.confirmation?.enabled !== false;
                    document.getElementById('sms-confirmation-template').value = s.confirmation?.template || '';
                    
                    // 24h reminder
                    document.getElementById('sms-reminder24h-enabled').checked = s.reminder24h?.enabled !== false;
                    document.getElementById('sms-reminder24h-template').value = s.reminder24h?.template || '';
                    
                    // 1h reminder
                    document.getElementById('sms-reminder1h-enabled').checked = s.reminder1h?.enabled || false;
                    document.getElementById('sms-reminder1h-template').value = s.reminder1h?.template || '';
                    
                    // Quiet hours
                    document.getElementById('sms-quiet-hours-enabled').checked = s.quietHours?.enabled !== false;
                    document.getElementById('sms-quiet-start').value = s.quietHours?.startTime || '21:00';
                    document.getElementById('sms-quiet-end').value = s.quietHours?.endTime || '08:00';
                }
                
                // Load stats
                const statsRes = await fetch(`/api/company/${companyId}/sms-notifications/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const statsData = await statsRes.json();
                
                if (statsData.success) {
                    document.getElementById('sms-stats-sent').textContent = statsData.stats.sent || 0;
                    document.getElementById('sms-stats-pending').textContent = statsData.stats.pending || 0;
                }
                
            } catch (err) {
                document.getElementById('sms-loading').classList.add('hidden');
                console.error('Failed to load SMS status:', err);
            }
        }
        
        // Initialize SMS Notifications when Configuration tab loads
        function initSMSNotificationsUI() {
            const companyId = window.companyId || window.currentCompanyId || new URLSearchParams(window.location.search).get('id');
            if (!companyId) return;
            
            initSMSNotifications(companyId);
            
            // Master toggle
            document.getElementById('sms-master-toggle')?.addEventListener('change', async (e) => {
                const token = getAuthToken();
                const enabled = e.target.checked;
                
                try {
                    const response = await fetch(`/api/company/${companyId}/sms-notifications/toggle`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ enabled })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        if (enabled) {
                            document.getElementById('sms-settings-panel').classList.remove('hidden');
                        } else {
                            document.getElementById('sms-settings-panel').classList.add('hidden');
                        }
                    }
                } catch (err) {
                    console.error('Failed to toggle SMS:', err);
                    e.target.checked = !enabled; // Revert
                }
            });
            
            // Save settings button
            document.getElementById('sms-save-settings-btn')?.addEventListener('click', async () => {
                const token = getAuthToken();
                const btn = document.getElementById('sms-save-settings-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                btn.disabled = true;
                
                try {
                    const settings = {
                        confirmation: {
                            enabled: document.getElementById('sms-confirmation-enabled').checked,
                            template: document.getElementById('sms-confirmation-template').value
                        },
                        reminder24h: {
                            enabled: document.getElementById('sms-reminder24h-enabled').checked,
                            template: document.getElementById('sms-reminder24h-template').value
                        },
                        reminder1h: {
                            enabled: document.getElementById('sms-reminder1h-enabled').checked,
                            template: document.getElementById('sms-reminder1h-template').value
                        },
                        quietHours: {
                            enabled: document.getElementById('sms-quiet-hours-enabled').checked,
                            startTime: document.getElementById('sms-quiet-start').value,
                            endTime: document.getElementById('sms-quiet-end').value
                        }
                    };
                    
                    const response = await fetch(`/api/company/${companyId}/sms-notifications/settings`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ settings })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('✅ SMS settings saved!');
                    } else {
                        alert('Failed to save: ' + (data.error || 'Unknown error'));
                    }
                } catch (err) {
                    alert('Error saving settings: ' + err.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
            
            // Test SMS button
            document.getElementById('sms-test-btn')?.addEventListener('click', async () => {
                const phone = prompt('Enter phone number to send test SMS (10 digits):');
                if (!phone) return;
                
                const token = getAuthToken();
                
                try {
                    const response = await fetch(`/api/company/${companyId}/sms-notifications/test`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ toPhone: phone, messageType: 'confirmation' })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('✅ Test SMS sent!\n\nMessage:\n' + data.messageSent);
                    } else {
                        alert('Failed to send test: ' + (data.error || 'Unknown error'));
                    }
                } catch (err) {
                    alert('Error sending test: ' + err.message);
                }
            });
            
            // Refresh button
            document.getElementById('sms-refresh-status')?.addEventListener('click', () => {
                initSMSNotifications(companyId);
            });
            
            // Email-to-SMS Gateway Test - Restore saved values
            const savedGatewayPhone = localStorage.getItem('sms_gateway_test_phone');
            const savedGatewayCarrier = localStorage.getItem('sms_gateway_test_carrier');
            if (savedGatewayPhone) document.getElementById('sms-gateway-phone').value = savedGatewayPhone;
            if (savedGatewayCarrier) document.getElementById('sms-gateway-carrier').value = savedGatewayCarrier;
            
            document.getElementById('sms-gateway-send-btn')?.addEventListener('click', async () => {
                const phone = document.getElementById('sms-gateway-phone').value.trim();
                const carrier = document.getElementById('sms-gateway-carrier').value;
                const message = document.getElementById('sms-gateway-message').value.trim();
                const resultEl = document.getElementById('sms-gateway-result');
                const btn = document.getElementById('sms-gateway-send-btn');
                const token = getAuthToken(); // Get token in scope
                
                // Save for next time
                localStorage.setItem('sms_gateway_test_phone', phone);
                localStorage.setItem('sms_gateway_test_carrier', carrier);
                
                if (!phone) {
                    resultEl.innerHTML = '<span class="text-red-600">❌ Enter phone number</span>';
                    return;
                }
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
                resultEl.innerHTML = '';
                
                try {
                    const response = await fetch(`/api/company/${companyId}/sms-notifications/test-email-gateway`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ toPhone: phone, carrier, message })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        resultEl.innerHTML = `<span class="text-green-600">✅ Sent via ${carrier}! Check your phone.</span>`;
                    } else {
                        resultEl.innerHTML = `<span class="text-red-600">❌ ${data.error || 'Failed'}</span>`;
                    }
                } catch (err) {
                    resultEl.innerHTML = `<span class="text-red-600">❌ ${err.message}</span>`;
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send via Email Gateway';
                }
            });
        }
        
        // Initialize SMS UI after DOM is ready and companyId is set
        setTimeout(initSMSNotificationsUI, 500);
    </script>
    
    <!-- =========================================================
    CONTROL PLANE JSON PANEL + VERIFY BUTTON
    Provides:
    - Load Control Plane JSON (signed snapshot)
    - Verify Hash (client-side tamper detection)
    - Server Verify (HMAC signature verification)
    - Copy JSON
    ========================================================= -->
    <style>
        .cv-card{border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:16px;margin:14px 0;background:rgba(0,0,0,.18)}
        .cv-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
        .cv-btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff;cursor:pointer;font-size:13px;font-weight:600}
        .cv-btn:hover{background:rgba(255,255,255,.10)}
        .cv-btn:disabled{opacity:0.5;cursor:not-allowed}
        .cv-badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);font-size:12px;background:rgba(0,0,0,.2)}
        .cv-pre{white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.35);border-radius:12px;padding:12px;max-height:420px;overflow:auto;border:1px solid rgba(255,255,255,.12);font-family:monospace;font-size:11px;color:#e2e8f0}
        .cv-muted{opacity:.8;font-size:12px;color:#94a3b8}
    </style>

    <div id="cv-control-plane-panel" class="cv-card" style="display:none;position:fixed;bottom:20px;right:20px;width:600px;max-width:90vw;z-index:9999;background:#1e293b;box-shadow:0 10px 40px rgba(0,0,0,.5);">
        <div class="cv-row" style="justify-content:space-between">
            <div>
                <div style="font-weight:700;font-size:14px;color:#f1f5f9;">🔐 Control Plane JSON</div>
                <div class="cv-muted">Signed snapshot with HMAC integrity verification</div>
            </div>
            <div class="cv-row">
                <span id="cv-cp-status" class="cv-badge">Not loaded</span>
                <button onclick="document.getElementById('cv-control-plane-panel').style.display='none'" class="cv-btn" style="padding:6px 10px;">✕</button>
            </div>
        </div>

        <div class="cv-row" style="margin-top:12px;">
            <button id="cv-cp-load" class="cv-btn" style="background:#3b82f6;">📥 Load Snapshot</button>
            <button id="cv-cp-verify-hash" class="cv-btn" disabled style="background:#8b5cf6;">🔍 Verify Hash</button>
            <button id="cv-cp-server-verify" class="cv-btn" disabled style="background:#f59e0b;" title="Verifies HMAC signature with server">🛡️ Server Verify</button>
            <button id="cv-cp-copy" class="cv-btn" disabled style="background:#10b981;">📋 Copy</button>
        </div>

        <div style="margin-top:12px;">
            <div class="cv-muted" id="cv-cp-meta"></div>
            <pre id="cv-cp-view" class="cv-pre" style="margin-top:8px;">Click "Load Snapshot" to fetch the signed Control Plane JSON...</pre>
        </div>
    </div>

    <!-- Toggle button MOVED to header next to Config JSON button -->

    <script>
    (function(){
        // ========= CONFIG (MATCHED TO YOUR BACKEND) =========
        const CONTROL_PLANE_SNAPSHOT_URL = (companyId) =>
            `/api/company/${companyId}/platform-snapshot?scope=full`;

        const CONTROL_PLANE_SERVER_VERIFY_URL = (companyId) =>
            `/api/company/${companyId}/platform-snapshot/verify`;

        // ========= HELPERS =========
        function getCompanyId(){
            const url = new URL(window.location.href);
            const qp = url.searchParams.get("id") || url.searchParams.get("companyId");
            return qp || window.companyId || window.currentCompanyId || localStorage.getItem('currentCompanyId') || null;
        }

        // getAuthToken() defined earlier (line ~4266) for calendar/SMS init

        function setStatus(text, kind){
            const el = document.getElementById("cv-cp-status");
            if(!el) return;
            el.textContent = text;
            el.style.borderColor =
                kind === "green" ? "rgba(64, 255, 160, .45)" :
                kind === "red"   ? "rgba(255, 90, 90, .55)" :
                kind === "yellow"? "rgba(255, 200, 80, .55)" :
                                   "rgba(255,255,255,.18)";
            el.style.color =
                kind === "green" ? "#4ade80" :
                kind === "red"   ? "#f87171" :
                kind === "yellow"? "#fbbf24" : "#94a3b8";
        }

        function stableStringify(value){
            if (value === null || value === undefined) return JSON.stringify(value);
            if (typeof value !== "object") return JSON.stringify(value);
            if (Array.isArray(value)) return "[" + value.map(stableStringify).join(",") + "]";
            const keys = Object.keys(value).sort();
            return "{" + keys.map(k => JSON.stringify(k)+":"+stableStringify(value[k])).join(",") + "}";
        }

        function stripIntegrity(obj){
            if (obj === null || typeof obj !== "object") return obj;
            if (Array.isArray(obj)) return obj.map(stripIntegrity);
            const out = {};
            for (const k of Object.keys(obj)) {
                if (k === "_integrity") continue;
                out[k] = stripIntegrity(obj[k]);
            }
            return out;
        }

        async function sha256Hex(str){
            const enc = new TextEncoder();
            const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
            const arr = Array.from(new Uint8Array(buf));
            return arr.map(b => b.toString(16).padStart(2,"0")).join("");
        }

        async function fetchJson(url, opts={}){
            const token = getAuthToken();
            const headers = Object.assign(
                { "Content-Type": "application/json" },
                token ? { "Authorization": `Bearer ${token}` } : {},
                opts.headers || {}
            );
            const res = await fetch(url, { ...opts, headers });
            const text = await res.text();
            let json;
            try { json = JSON.parse(text); } catch(e){ json = { raw: text }; }
            if(!res.ok){
                const msg = json?.error || json?.message || `HTTP ${res.status}`;
                throw new Error(msg);
            }
            return json;
        }

        // ========= STATE =========
        let lastSnapshot = null;

        // ========= ACTIONS =========
        async function loadSnapshot(){
            const companyId = getCompanyId();
            if(!companyId){
                setStatus("Missing companyId", "red");
                return;
            }

            setStatus("Loading...", "yellow");
            document.getElementById("cv-cp-view").textContent = "";
            document.getElementById("cv-cp-meta").textContent = "";

            try{
                const response = await fetchJson(CONTROL_PLANE_SNAPSHOT_URL(companyId));
                // API returns { success: true, snapshot: { ... } }
                const snap = response.snapshot || response;
                lastSnapshot = snap;

                const meta = snap?.meta || {};
                const integ = snap?._integrity || {};
                const completeness = snap?.completeness || {};
                
                document.getElementById("cv-cp-meta").innerHTML =
                    `<span style="color:#60a5fa">Company:</span> ${meta.companyName || companyId} | ` +
                    `<span style="color:#60a5fa">Score:</span> ${completeness.score || 0}% ${completeness.status || ''} | ` +
                    `<span style="color:#60a5fa">Integrity:</span> ${integ.algo || 'none'} | ` +
                    `<span style="color:#60a5fa">Generated:</span> ${meta.generatedAt ? new Date(meta.generatedAt).toLocaleTimeString() : '?'}`;

                document.getElementById("cv-cp-view").textContent = JSON.stringify(snap, null, 2);

                // Enable buttons
                document.getElementById("cv-cp-verify-hash").disabled = false;
                document.getElementById("cv-cp-copy").disabled = false;
                document.getElementById("cv-cp-server-verify").disabled = false;

                // Auto-verify hash if _integrity exists
                if (snap?._integrity?.hash && snap._integrity.algo !== 'none'){
                    const ok = await verifyHashClient();
                    setStatus(ok ? `✅ Loaded + Hash OK (${completeness.score}%)` : "⚠️ Loaded + Hash FAIL", ok ? "green" : "red");
                } else {
                    setStatus(`📄 Loaded (${completeness.score}%) - unsigned`, "yellow");
                }
            }catch(err){
                console.error("[CONTROL PLANE PANEL] load error:", err);
                setStatus(`❌ Load failed: ${String(err.message||err)}`, "red");
                document.getElementById("cv-cp-view").textContent = `Error: ${err.message}`;
            }
        }

        async function verifyHashClient(){
            if(!lastSnapshot) return false;

            const integ = lastSnapshot?._integrity;
            if(!integ?.hash || integ.algo === 'none'){
                setStatus("⚠️ No signature to verify", "yellow");
                return false;
            }

            setStatus("🔍 Verifying hash...", "yellow");
            try{
                const base = stripIntegrity(lastSnapshot);
                const canonical = stableStringify(base);
                const recomputed = await sha256Hex(canonical);

                if(recomputed === integ.hash){
                    setStatus("✅ Hash OK (client)", "green");
                    return true;
                } else {
                    setStatus("❌ Hash MISMATCH", "red");
                    console.warn("[CONTROL PLANE PANEL] hash mismatch", { recomputed, expected: integ.hash });
                    return false;
                }
            }catch(err){
                setStatus("❌ Hash verify error", "red");
                console.error("[CONTROL PLANE PANEL] hash verify error:", err);
                return false;
            }
        }

        async function serverVerify(){
            if(!lastSnapshot){
                setStatus("⚠️ Load snapshot first", "yellow");
                return;
            }
            
            const companyId = getCompanyId();
            if(!companyId){
                setStatus("❌ Missing companyId", "red");
                return;
            }
            
            setStatus("🛡️ Server verifying...", "yellow");
            try{
                const result = await fetchJson(CONTROL_PLANE_SERVER_VERIFY_URL(companyId), {
                    method: "POST",
                    body: JSON.stringify(lastSnapshot)
                });

                if(result?.ok){
                    setStatus("✅ Server Verify OK (HMAC)", "green");
                } else {
                    setStatus(`❌ Server Verify FAIL: ${result?.reason || "unknown"}`, "red");
                }
            }catch(err){
                setStatus(`❌ Server verify: ${String(err.message||err)}`, "red");
            }
        }

        async function copyJson(){
            if(!lastSnapshot) return;
            try{
                await navigator.clipboard.writeText(JSON.stringify(lastSnapshot, null, 2));
                const prevStatus = document.getElementById("cv-cp-status").textContent;
                setStatus("📋 Copied!", "green");
                setTimeout(()=>setStatus(prevStatus, "green"), 1200);
            }catch(e){
                const el = document.getElementById("cv-cp-view");
                el.focus();
                document.execCommand("selectAll", false, null);
                document.execCommand("copy");
                setStatus("📋 Copied (fallback)", "green");
            }
        }

        // Toggle panel visibility (button moved to header, no longer floating)
        window.toggleControlPlanePanel = function(){
            const panel = document.getElementById("cv-control-plane-panel");
            if (!panel) return;
            if(panel.style.display === "none" || panel.style.display === ""){
                panel.style.display = "block";
            } else {
                panel.style.display = "none";
            }
        };

        // Close panel handler
        window.closeControlPlanePanel = function(){
            const panel = document.getElementById("cv-control-plane-panel");
            if (panel) panel.style.display = "none";
        };

        // ========= INIT =========
        function init(){
            document.getElementById("cv-cp-load").addEventListener("click", loadSnapshot);
            document.getElementById("cv-cp-verify-hash").addEventListener("click", verifyHashClient);
            document.getElementById("cv-cp-server-verify").addEventListener("click", serverVerify);
            document.getElementById("cv-cp-copy").addEventListener("click", copyJson);
            setStatus("Ready", "yellow");
        }

        if(document.readyState === "loading"){
            document.addEventListener("DOMContentLoaded", init);
        } else {
            init();
        }
    })();
    </script>
    
    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    <!-- CONFIG JSON JAVASCRIPT - Control Plane Effective Config Modal -->
    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    <script>
        // Store Config JSON data
        let configEffectiveData = null;
        let configRawData = null;
        let currentConfigTab = 'effective';
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CONFIG JSON - Open Modal
        // ═══════════════════════════════════════════════════════════════════════════
        async function openConfigJsonModal() {
            const modal = document.getElementById('config-json-modal');
            if (modal) {
                modal.classList.remove('hidden');
                await loadConfigJsonData();
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CONFIG JSON - Close Modal
        // ═══════════════════════════════════════════════════════════════════════════
        function closeConfigJsonModal() {
            const modal = document.getElementById('config-json-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CONFIG JSON - Load Data
        // ═══════════════════════════════════════════════════════════════════════════
        async function loadConfigJsonData() {
            // Get companyId from multiple sources (same pattern as other functions)
            const companyId = window.currentCompanyId || window.companyId || 
                              new URLSearchParams(window.location.search).get('id') ||
                              localStorage.getItem('currentCompanyId');
            if (!companyId) {
                console.error('[CONFIG JSON] No companyId');
                return;
            }
            
            // Get auth token
            const authToken = localStorage.getItem('adminToken') || localStorage.getItem('token');
            
            try {
                // Load effective config
                const effectiveResponse = await fetch(`/api/company/${companyId}/control-plane/effective`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (effectiveResponse.ok) {
                    const data = await effectiveResponse.json();
                    if (data.success) {
                        configEffectiveData = data.data;
                        
                        // Update badges
                        const lint = data.data.lint || {};
                        const computed = data.data.computed || {};
                        const config = data.data.effectiveConfig || {};
                        
                        document.getElementById('config-score-badge').textContent = lint.score || '--';
                        document.getElementById('config-score-badge').style.color = 
                            lint.score >= 80 ? '#22c55e' : lint.score >= 60 ? '#f59e0b' : '#ef4444';
                        
                        document.getElementById('config-grade-badge').textContent = lint.grade || '--';
                        document.getElementById('config-grade-badge').style.color = 
                            lint.score >= 80 ? '#22c55e' : lint.score >= 60 ? '#f59e0b' : '#ef4444';
                        
                        document.getElementById('config-issues-badge').textContent = 
                            (lint.issuesCount || 0) + ' issues';
                        
                        document.getElementById('config-slots-badge').textContent = 
                            (config.booking?.slotsCount || 0);
                        
                        // Show effective config
                        document.getElementById('config-effective-json').textContent = 
                            JSON.stringify(data.data.effectiveConfig, null, 2);
                        
                        // Show lint results
                        renderConfigLintResults(data.data);
                    }
                } else {
                    document.getElementById('config-effective-json').textContent = 
                        JSON.stringify({ error: 'Failed to load effective config' }, null, 2);
                }
                
                // Load raw company data (uses the /control-plane/raw endpoint)
                const rawResponse = await fetch(`/api/company/${companyId}/control-plane/raw`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (rawResponse.ok) {
                    const rawData = await rawResponse.json();
                    if (rawData.success) {
                        configRawData = rawData.data;
                        // Extract relevant sections for display
                        const relevantSections = {
                            frontDeskBehavior: rawData.data?.company?.frontDeskBehavior,
                            connectionMessages: rawData.data?.company?.connectionMessages,
                            aiAgentSettings: rawData.data?.company?.aiAgentSettings,
                            booking: rawData.data?.company?.booking,
                            // Add scope info
                            _source: 'MongoDB company document',
                            _companyId: companyId
                        };
                        document.getElementById('config-raw-json').textContent = 
                            JSON.stringify(relevantSections, null, 2);
                        
                        // Update dropdown with chunk options (for large JSON)
                        updateRawCompanyDropdownItems();
                    } else {
                        configRawData = null;
                        updateRawCompanyDropdownItems();
                    }
                } else {
                    configRawData = null;
                    document.getElementById('config-raw-json').textContent = 
                        JSON.stringify({ error: 'Failed to load raw company data' }, null, 2);
                    // Update dropdown to show unavailable state
                    updateRawCompanyDropdownItems();
                }
                
            } catch (error) {
                console.error('[CONFIG JSON] Error loading data:', error);
                document.getElementById('config-effective-json').textContent = 
                    JSON.stringify({ error: error.message }, null, 2);
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CONFIG JSON - Render Lint Results + Widgets
        // ═══════════════════════════════════════════════════════════════════════════
        function renderConfigLintResults(data) {
            const listEl = document.getElementById('config-lint-list');
            const lint = data.lint || {};
            const warnings = data.warnings || [];
            const effectiveConfig = data.effectiveConfig || {};
            
            // ─────────────────────────────────────────────────────────────────────────
            // UPDATE GREETING OPTIMIZER
            // ─────────────────────────────────────────────────────────────────────────
            updateGreetingOptimizer(effectiveConfig);
            
            // ─────────────────────────────────────────────────────────────────────────
            // UPDATE QUICKANSWERS DEDUPER
            // ─────────────────────────────────────────────────────────────────────────
            updateQuickAnswersDeduper(effectiveConfig);
            
            // ─────────────────────────────────────────────────────────────────────────
            // UPDATE CONFIG HEALTH STATUS
            // ─────────────────────────────────────────────────────────────────────────
            updateConfigHealth(effectiveConfig);
            
            // ─────────────────────────────────────────────────────────────────────────
            // LOAD LEGACY KEYS REPORT (Golden Blueprint Validation)
            // ─────────────────────────────────────────────────────────────────────────
            loadLegacyReport();
            
            // Combine lint issues and warnings
            const allIssues = [...(lint.issues || []), ...warnings];
            
            if (allIssues.length === 0) {
                listEl.innerHTML = `
                    <div style="padding: 20px; background-color: #065f46; border-radius: 8px; color: white; text-align: center;">
                        <i class="fas fa-check-circle" style="font-size: 24px; margin-bottom: 8px;"></i>
                        <div style="font-weight: 600;">No issues found!</div>
                        <div style="font-size: 12px; opacity: 0.8;">Copy quality is excellent.</div>
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = allIssues.map(issue => {
                const severityColors = {
                    error: { bg: '#7f1d1d', border: '#ef4444', icon: '✕' },
                    warning: { bg: '#78350f', border: '#f59e0b', icon: '!' },
                    info: { bg: '#1e3a5f', border: '#3b82f6', icon: 'i' }
                };
                const colors = severityColors[issue.severity] || severityColors.info;
                
                return `
                    <div style="padding: 12px; background-color: ${colors.bg}; border-radius: 8px; border-left: 4px solid ${colors.border}; display: flex; gap: 12px; align-items: flex-start;">
                        <span style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background-color: ${colors.border}; border-radius: 50%; font-weight: bold; font-size: 12px; flex-shrink: 0;">${colors.icon}</span>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${issue.field || 'unknown'} • ${issue.rule || issue.severity}</div>
                            <div style="font-size: 13px; opacity: 0.9;">${issue.message || 'No message'}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // GREETING OPTIMIZER - State
        // ═══════════════════════════════════════════════════════════════════════════
        let pendingGreeting = null; // Stores pending greeting text before save
        let currentEffectiveGreeting = null; // What runtime actually uses
        let currentGreetingSource = null; // Where it came from
        
        // ═══════════════════════════════════════════════════════════════════════════
        // GREETING OPTIMIZER - Update Stats (WIRED TO REAL PATHS)
        // ═══════════════════════════════════════════════════════════════════════════
        function updateGreetingOptimizer(config) {
            const greeting = config.greeting?.standardized || config.greeting?.raw || '';
            const source = config.greeting?.source || config._meta?.greetingSource || 'unknown';
            
            // Store for later use
            currentEffectiveGreeting = greeting;
            currentGreetingSource = source;
            
            const words = greeting.split(/\s+/).filter(w => w.length > 0).length;
            const ttsSeconds = (words / 2.5).toFixed(1); // ~2.5 words per second
            
            // Update EFFECTIVE GREETING display
            document.getElementById('greeting-effective-text').textContent = greeting ? `"${greeting}"` : '(No greeting configured)';
            document.getElementById('greeting-effective-source').textContent = `Source: ${source}`;
            
            // Update stats
            document.getElementById('greeting-word-count').textContent = words;
            document.getElementById('greeting-tts-seconds').textContent = ttsSeconds;
            document.getElementById('greeting-preview').textContent = greeting || '(No greeting configured)';
            
            // Check if callFlowEngine.style.greeting exists (for mirroring info)
            const callFlowGreeting = config._rawPaths?.['callFlowEngine.style.greeting'];
            if (callFlowGreeting) {
                document.getElementById('greeting-mirror-targets').style.display = 'block';
                document.getElementById('greeting-mirror-list').textContent = 'callFlowEngine.style.greeting';
            } else {
                document.getElementById('greeting-mirror-targets').style.display = 'none';
            }
            
            // Update status badge
            const badge = document.getElementById('greeting-status-badge');
            const wordCountEl = document.getElementById('greeting-word-count');
            const ttsEl = document.getElementById('greeting-tts-seconds');
            
            if (words <= 8) {
                badge.textContent = 'OPTIMAL';
                badge.style.background = '#065f46';
                badge.style.color = '#10b981';
                wordCountEl.style.color = '#10b981';
                ttsEl.style.color = '#10b981';
            } else if (words <= 15) {
                badge.textContent = 'OK';
                badge.style.background = '#78350f';
                badge.style.color = '#fbbf24';
                wordCountEl.style.color = '#fbbf24';
                ttsEl.style.color = '#fbbf24';
            } else {
                badge.textContent = 'TOO LONG';
                badge.style.background = '#7f1d1d';
                badge.style.color = '#ef4444';
                wordCountEl.style.color = '#ef4444';
                ttsEl.style.color = '#ef4444';
            }
            
            // Clear pending panel if no pending change
            if (!pendingGreeting) {
                document.getElementById('greeting-pending-panel').style.display = 'none';
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // GREETING OPTIMIZER - Preview Preset (NO AUTO-SAVE)
        // ═══════════════════════════════════════════════════════════════════════════
        function previewGreetingPreset(greetingText) {
            pendingGreeting = greetingText;
            
            // Show pending panel
            const pendingPanel = document.getElementById('greeting-pending-panel');
            const pendingText = document.getElementById('greeting-pending-text');
            
            pendingPanel.style.display = 'block';
            pendingText.textContent = `"${greetingText}"`;
            
            showConfigCopyToast(true, '📝 Preview', 'Click "Save Greeting" to apply');
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // GREETING OPTIMIZER - Save Greeting Now
        // ═══════════════════════════════════════════════════════════════════════════
        async function saveGreetingNow() {
            if (!pendingGreeting) {
                showConfigCopyToast(false, '⚠️ Nothing to save', 'Select a preset first');
                return;
            }
            
            const companyId = window.currentCompanyId || window.companyId || 
                              new URLSearchParams(window.location.search).get('id') ||
                              localStorage.getItem('currentCompanyId');
            if (!companyId) {
                showConfigCopyToast(false, '❌ Error', 'No company ID found');
                return;
            }
            
            const authToken = localStorage.getItem('adminToken') || localStorage.getItem('token');
            
            try {
                // Save greeting via Control Plane endpoint (writes to MULTIPLE paths)
                const response = await fetch(`/api/company/${companyId}/control-plane/save`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        greeting: pendingGreeting,
                        mirrorToRealtime: true // Also write to realtime path
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const writtenPaths = result.writtenTo || ['connectionMessages.voice.text'];
                    
                    showConfigCopyToast(true, '✅ Greeting Saved!', `Written to: ${writtenPaths.join(', ')}`);
                    
                    // Clear pending state
                    pendingGreeting = null;
                    document.getElementById('greeting-pending-panel').style.display = 'none';
                    
                    // Refresh to show new lint results
                    await refreshConfigJson();
                } else {
                    const err = await response.json();
                    showConfigCopyToast(false, '❌ Save Failed', err.error || 'Unknown error');
                }
            } catch (err) {
                console.error('[GREETING] Save failed:', err);
                showConfigCopyToast(false, '❌ Error', err.message);
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // GREETING OPTIMIZER - Cancel Pending
        // ═══════════════════════════════════════════════════════════════════════════
        function cancelGreetingPending() {
            pendingGreeting = null;
            document.getElementById('greeting-pending-panel').style.display = 'none';
            showConfigCopyToast(true, '↩ Cancelled', 'Pending change discarded');
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // GREETING OPTIMIZER - Test Resolve (Verify what runtime will use)
        // ═══════════════════════════════════════════════════════════════════════════
        async function testResolveGreeting() {
            const companyId = window.currentCompanyId || window.companyId || 
                              new URLSearchParams(window.location.search).get('id') ||
                              localStorage.getItem('currentCompanyId');
            if (!companyId) {
                showConfigCopyToast(false, '❌ Error', 'No company ID found');
                return;
            }
            
            const authToken = localStorage.getItem('adminToken') || localStorage.getItem('token');
            
            try {
                // Fetch fresh effective config
                const response = await fetch(`/api/company/${companyId}/control-plane/effective`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const effectiveGreeting = data.data?.effectiveConfig?.greeting?.standardized || 
                                              data.data?.effectiveConfig?.greeting?.raw || '';
                    const source = data.data?.effectiveConfig?.greeting?.source || 'unknown';
                    
                    if (pendingGreeting && effectiveGreeting === pendingGreeting) {
                        showConfigCopyToast(true, '✅ Verified!', `Effective greeting = "${effectiveGreeting.substring(0, 40)}..." from ${source}`);
                    } else if (effectiveGreeting) {
                        showConfigCopyToast(true, '🔍 Current Effective', `"${effectiveGreeting.substring(0, 40)}..." from ${source}`);
                    } else {
                        showConfigCopyToast(false, '⚠️ No greeting', 'Effective greeting is empty');
                    }
                } else {
                    showConfigCopyToast(false, '❌ Resolve Failed', 'Could not fetch effective config');
                }
            } catch (err) {
                console.error('[GREETING] Test resolve failed:', err);
                showConfigCopyToast(false, '❌ Error', err.message);
            }
        }
        
        // Legacy function - now just calls preview
        async function applyGreetingPreset(greetingText) {
            previewGreetingPreset(greetingText);
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // QUICKANSWERS DEDUPER - Show Duplicates (WITH ACTIONS)
        // ═══════════════════════════════════════════════════════════════════════════
        let currentQuickAnswerDuplicates = []; // Store for action handlers
        
        function updateQuickAnswersDeduper(config) {
            const panel = document.getElementById('quickanswers-deduper-panel');
            const listEl = document.getElementById('qa-duplicates-list');
            const countBadge = document.getElementById('qa-duplicates-count');
            
            const duplicates = config.quickAnswers?.duplicates || [];
            currentQuickAnswerDuplicates = duplicates; // Store for actions
            
            if (duplicates.length === 0) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            countBadge.textContent = duplicates.length;
            
            listEl.innerHTML = duplicates.map((dup, i) => `
                <div style="padding: 12px; background: #0f172a; border-radius: 8px; border: 1px solid #78350f;">
                    <div style="font-size: 11px; color: #fbbf24; margin-bottom: 8px;">
                        <strong>Triggers:</strong> ${(dup.triggers || []).join(', ')}
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div style="padding: 8px; background: #1e293b; border-radius: 6px;">
                            <div style="font-size: 10px; color: #94a3b8; margin-bottom: 4px;">First QA (ID: ${dup.firstId || 'N/A'}):</div>
                            <div style="font-size: 12px; color: #e2e8f0;">"${dup.firstAnswer || 'N/A'}"</div>
                            <div style="font-size: 9px; color: #64748b; margin-top: 4px;">Priority: ${dup.firstPriority || 'default'} • Created: ${dup.firstCreated || 'N/A'}</div>
                        </div>
                        <div style="padding: 8px; background: #1e293b; border-radius: 6px;">
                            <div style="font-size: 10px; color: #94a3b8; margin-bottom: 4px;">Duplicate QA (ID: ${dup.duplicateId || 'N/A'}):</div>
                            <div style="font-size: 12px; color: #e2e8f0;">"${dup.duplicateAnswer || 'N/A'}"</div>
                            <div style="font-size: 9px; color: #64748b; margin-top: 4px;">Priority: ${dup.duplicatePriority || 'default'} • Created: ${dup.duplicateCreated || 'N/A'}</div>
                        </div>
                    </div>
                    
                    <!-- ACTION BUTTONS -->
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; padding-top: 8px; border-top: 1px solid #78350f;">
                        <button onclick="dedupeAction(${i}, 'keep_newest')" 
                                style="padding: 6px 10px; font-size: 10px; background: #059669; color: white; border: none; border-radius: 4px; cursor: pointer;"
                                title="Keep the newest QA, disable the older one">
                            ✓ Keep Newest
                        </button>
                        <button onclick="dedupeAction(${i}, 'keep_highest_priority')" 
                                style="padding: 6px 10px; font-size: 10px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;"
                                title="Keep the QA with highest priority, disable others">
                            ↑ Keep Highest Priority
                        </button>
                        <button onclick="dedupeAction(${i}, 'merge_triggers')" 
                                style="padding: 6px 10px; font-size: 10px; background: #7c3aed; color: white; border: none; border-radius: 4px; cursor: pointer;"
                                title="Merge all triggers into one QA and pick the answer">
                            ⊕ Merge Triggers
                        </button>
                        <button onclick="dedupeAction(${i}, 'keep_first')" 
                                style="padding: 6px 10px; font-size: 10px; background: #475569; color: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;"
                                title="Keep first, disable duplicate">
                            Keep First
                        </button>
                        <button onclick="dedupeAction(${i}, 'keep_duplicate')" 
                                style="padding: 6px 10px; font-size: 10px; background: #475569; color: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;"
                                title="Keep duplicate, disable first">
                            Keep Duplicate
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // QUICKANSWERS DEDUPER - Execute Action
        // ═══════════════════════════════════════════════════════════════════════════
        async function dedupeAction(dupIndex, action) {
            const dup = currentQuickAnswerDuplicates[dupIndex];
            if (!dup) {
                showConfigCopyToast(false, '❌ Error', 'Duplicate not found');
                return;
            }
            
            const companyId = window.currentCompanyId || window.companyId || 
                              new URLSearchParams(window.location.search).get('id') ||
                              localStorage.getItem('currentCompanyId');
            if (!companyId) {
                showConfigCopyToast(false, '❌ Error', 'No company ID found');
                return;
            }
            
            const authToken = localStorage.getItem('adminToken') || localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/company/${companyId}/quickanswers/dedupe`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action,
                        firstId: dup.firstId,
                        duplicateId: dup.duplicateId,
                        triggers: dup.triggers,
                        reason: 'duplicate_deduper',
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showConfigCopyToast(true, '✅ Dedupe Applied!', result.message || `Action: ${action}`);
                    // Refresh to show updated state
                    await refreshConfigJson();
                } else {
                    const err = await response.json();
                    showConfigCopyToast(false, '❌ Dedupe Failed', err.error || 'Unknown error');
                }
            } catch (err) {
                console.error('[DEDUPER] Action failed:', err);
                showConfigCopyToast(false, '❌ Error', err.message);
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // QUICKANSWERS DEDUPER - Restore Disabled
        // ═══════════════════════════════════════════════════════════════════════════
        async function restoreDisabledQuickAnswers() {
            const companyId = window.currentCompanyId || window.companyId || 
                              new URLSearchParams(window.location.search).get('id') ||
                              localStorage.getItem('currentCompanyId');
            if (!companyId) {
                showConfigCopyToast(false, '❌ Error', 'No company ID found');
                return;
            }
            
            const authToken = localStorage.getItem('adminToken') || localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/company/${companyId}/quickanswers/restore-disabled`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reason: 'duplicate_deduper' // Only restore those disabled by deduper
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showConfigCopyToast(true, '↩ Restored!', result.message || 'Disabled QAs restored');
                    await refreshConfigJson();
                } else {
                    const err = await response.json();
                    showConfigCopyToast(false, '❌ Restore Failed', err.error || 'Unknown error');
                }
            } catch (err) {
                console.error('[DEDUPER] Restore failed:', err);
                showConfigCopyToast(false, '❌ Error', err.message);
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CONFIG HEALTH - Show Status (WITH CONFLICT DETAILS)
        // ═══════════════════════════════════════════════════════════════════════════
        let currentConfigConflicts = []; // Store for action handlers
        
        function updateConfigHealth(config) {
            const panel = document.getElementById('config-health-panel');
            const iconEl = document.getElementById('config-health-icon');
            const titleEl = document.getElementById('config-health-title');
            const summaryEl = document.getElementById('config-health-summary');
            const badge = document.getElementById('config-health-badge');
            const conflictDetailsEl = document.getElementById('config-conflict-details');
            const warningDetailsEl = document.getElementById('config-warning-details');
            
            const health = config._health || {};
            const booking = config.booking || {};
            const discoveryConsent = config.discoveryConsent || {};
            
            // Build conflicts list from detected issues
            const conflicts = [];
            const warnings = [];
            
            // Check for booking engine conflict
            if (booking.hasConflict) {
                conflicts.push({
                    code: 'BOOKING_ENGINE_CONFLICT',
                    why: 'Two different booking systems are active with different slot definitions',
                    paths: [
                        `callFlowEngine.bookingFields (${booking.callFlowCount || 0} fields)`,
                        `frontDeskBehavior.bookingSlots (${booking.slotsCount || 0} slots)`
                    ],
                    recommendation: `Use "${booking.engineMode}" mode exclusively`,
                    fixAction: 'fix_booking_conflict'
                });
            }
            
            // Check for scenarios blocked by consent
            if (discoveryConsent.scenariosBlockedByConsent) {
                conflicts.push({
                    code: 'SCENARIOS_BLOCKED',
                    why: 'Consent settings are preventing scenario auto-responses',
                    paths: [
                        `discoveryConsent.disableScenarioAutoResponses = ${discoveryConsent.disableScenarioAutoResponses}`,
                        `discoveryConsent.forceLLMDiscovery = ${discoveryConsent.forceLLMDiscovery}`
                    ],
                    recommendation: discoveryConsent.recommendation || 'Set disableScenarioAutoResponses=false',
                    fixAction: 'fix_consent_blocking'
                });
            }
            
            // Add any config-level conflicts/warnings
            if (config._conflicts) conflicts.push(...config._conflicts);
            if (config._warnings) warnings.push(...config._warnings);
            
            currentConfigConflicts = conflicts; // Store for actions
            
            // Only show if there are issues
            if (conflicts.length === 0 && warnings.length === 0) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            
            if (conflicts.length > 0) {
                iconEl.textContent = '🚨';
                badge.textContent = 'CRITICAL';
                badge.style.background = '#7f1d1d';
                badge.style.color = '#ef4444';
                panel.style.borderColor = '#ef4444';
                panel.style.background = 'linear-gradient(135deg, #7f1d1d 0%, #0f172a 100%)';
                titleEl.innerHTML = `Config Health: <span style="color: #ef4444;">${conflicts.length} conflict(s)</span>`;
            } else if (warnings.length > 0) {
                iconEl.textContent = '⚠️';
                badge.textContent = 'WARNING';
                badge.style.background = '#78350f';
                badge.style.color = '#fbbf24';
                panel.style.borderColor = '#f59e0b';
                panel.style.background = 'linear-gradient(135deg, #422006 0%, #0f172a 100%)';
                titleEl.innerHTML = `Config Health: <span style="color: #fbbf24;">${warnings.length} warning(s)</span>`;
            }
            
            summaryEl.textContent = health.summary || `${conflicts.length} conflict(s), ${warnings.length} warning(s) need attention`;
            
            // Render CONFLICT DETAILS
            if (conflicts.length > 0) {
                conflictDetailsEl.style.display = 'block';
                conflictDetailsEl.innerHTML = conflicts.map((c, i) => `
                    <div style="padding: 12px; background: #0f172a; border-radius: 8px; border-left: 4px solid #ef4444; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="font-weight: 700; font-size: 12px; color: #ef4444; font-family: monospace;">${c.code}</div>
                            ${c.fixAction ? `
                                <button onclick="fixConfigConflict(${i})" 
                                        style="padding: 4px 8px; font-size: 10px; background: #059669; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ⚡ Auto-Fix
                                </button>
                            ` : ''}
                        </div>
                        
                        <div style="font-size: 12px; color: #e2e8f0; margin-bottom: 8px;">
                            <strong>Why:</strong> ${c.why}
                        </div>
                        
                        <div style="font-size: 11px; color: #94a3b8; margin-bottom: 8px;">
                            <strong>Paths involved:</strong>
                            <ul style="margin: 4px 0 0 16px; padding: 0;">
                                ${(c.paths || []).map(p => `<li style="font-family: monospace; color: #f59e0b;">${p}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div style="font-size: 11px; padding: 8px; background: #065f46; border-radius: 4px; color: #10b981;">
                            💡 <strong>Recommended:</strong> ${c.recommendation}
                        </div>
                    </div>
                `).join('');
            } else {
                conflictDetailsEl.style.display = 'none';
            }
            
            // Render WARNING DETAILS
            if (warnings.length > 0) {
                warningDetailsEl.style.display = 'block';
                warningDetailsEl.innerHTML = warnings.map(w => `
                    <div style="padding: 10px; background: #0f172a; border-radius: 6px; border-left: 3px solid #f59e0b; margin-bottom: 6px;">
                        <div style="font-size: 11px; color: #fbbf24;">${w.message || w}</div>
                    </div>
                `).join('');
            } else {
                warningDetailsEl.style.display = 'none';
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CONFIG HEALTH - Auto-Fix Conflict
        // ═══════════════════════════════════════════════════════════════════════════
        async function fixConfigConflict(conflictIndex) {
            const conflict = currentConfigConflicts[conflictIndex];
            if (!conflict) {
                showConfigCopyToast(false, '❌ Error', 'Conflict not found');
                return;
            }
            
            const companyId = window.currentCompanyId || window.companyId || 
                              new URLSearchParams(window.location.search).get('id') ||
                              localStorage.getItem('currentCompanyId');
            if (!companyId) {
                showConfigCopyToast(false, '❌ Error', 'No company ID found');
                return;
            }
            
            const authToken = localStorage.getItem('adminToken') || localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/company/${companyId}/control-plane/fix-conflict`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        conflictCode: conflict.code,
                        fixAction: conflict.fixAction
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showConfigCopyToast(true, '✅ Conflict Fixed!', result.message || `Fixed: ${conflict.code}`);
                    await refreshConfigJson();
                } else {
                    const err = await response.json();
                    showConfigCopyToast(false, '❌ Fix Failed', err.error || 'Unknown error');
                }
            } catch (err) {
                console.error('[CONFIG HEALTH] Fix conflict failed:', err);
                showConfigCopyToast(false, '❌ Error', err.message);
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // LEGACY KEYS - Load and Display
        // ═══════════════════════════════════════════════════════════════════════════
        let currentLegacyReport = null;
        
        async function loadLegacyReport() {
            const companyId = window.currentCompanyId || window.companyId || 
                              new URLSearchParams(window.location.search).get('id') ||
                              localStorage.getItem('currentCompanyId');
            if (!companyId) return;
            
            const authToken = localStorage.getItem('adminToken') || localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/company/${companyId}/control-plane/legacy-report`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentLegacyReport = data.data;
                    updateLegacyKeysPanel(data.data);
                }
            } catch (err) {
                console.error('[LEGACY REPORT] Load failed:', err);
            }
        }
        
        function updateLegacyKeysPanel(report) {
            const panel = document.getElementById('legacy-keys-panel');
            const countBadge = document.getElementById('legacy-keys-count');
            const listEl = document.getElementById('legacy-keys-list');
            const versionEl = document.getElementById('blueprint-version-text');
            const deprecatedWarning = document.getElementById('deprecated-namespaces-warning');
            const deprecatedList = document.getElementById('deprecated-namespaces-list');
            const variablesMigrationPrompt = document.getElementById('variables-migration-prompt');
            
            if (!report || (report.legacyCount === 0 && report.deprecatedKeys?.length === 0)) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            countBadge.textContent = report.legacyCount || 0;
            versionEl.textContent = report.blueprintVersion || 'unknown';
            
            // Combine legacy and deprecated keys
            const allLegacy = [...(report.legacyKeys || []), ...(report.deprecatedKeys || [])];
            
            listEl.innerHTML = allLegacy.slice(0, 20).map(item => `
                <div style="padding: 6px 10px; background: #1e1b4b; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 11px; font-family: monospace; color: #c4b5fd;">${item.key}</span>
                        <span style="font-size: 9px; color: #a78bfa; margin-left: 8px;">${item.reason}</span>
                    </div>
                    <span style="font-size: 9px; padding: 2px 6px; background: ${item.action === 'MIGRATE_OR_DELETE' ? '#dc2626' : '#7c3aed'}; border-radius: 3px; color: white;">${item.action || 'REVIEW'}</span>
                </div>
            `).join('');
            
            if (allLegacy.length > 20) {
                listEl.innerHTML += `
                    <div style="padding: 8px; text-align: center; font-size: 10px; color: #a78bfa;">
                        + ${allLegacy.length - 20} more legacy keys...
                    </div>
                `;
            }
            
            // Show deprecated namespaces warning
            const deprecatedNamespaces = report.deprecatedKeys?.filter(k => 
                k.key.startsWith('variables') || 
                k.key.startsWith('callFlowEngine.bookingFields')
            ) || [];
            
            if (deprecatedNamespaces.length > 0) {
                deprecatedWarning.style.display = 'block';
                deprecatedList.textContent = deprecatedNamespaces.map(k => k.key.split('.')[0]).filter((v, i, a) => a.indexOf(v) === i).join(', ');
            } else {
                deprecatedWarning.style.display = 'none';
            }
            
            // Show variables migration prompt
            const hasVariables = report.deprecatedKeys?.some(k => k.key.startsWith('variables'));
            variablesMigrationPrompt.style.display = hasVariables ? 'block' : 'none';
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // LEGACY KEYS - Nuke (Delete)
        // ═══════════════════════════════════════════════════════════════════════════
        async function nukeLegacyKeys(dryRun = true) {
            const companyId = window.currentCompanyId || window.companyId || 
                              new URLSearchParams(window.location.search).get('id') ||
                              localStorage.getItem('currentCompanyId');
            if (!companyId) {
                showConfigCopyToast(false, '❌ Error', 'No company ID found');
                return;
            }
            
            const authToken = localStorage.getItem('adminToken') || localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/company/${companyId}/control-plane/nuke-legacy`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dryRun,
                        confirmNuke: !dryRun
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.dryRun) {
                        const keys = result.wouldDelete || [];
                        showConfigCopyToast(true, '👁️ Preview', `Would delete ${keys.length} keys: ${keys.slice(0, 3).join(', ')}${keys.length > 3 ? '...' : ''}`);
                    } else {
                        showConfigCopyToast(true, '🔥 Nuked!', result.message || 'Legacy keys deleted');
                        await refreshConfigJson();
                        await loadLegacyReport();
                    }
                } else {
                    const err = await response.json();
                    showConfigCopyToast(false, '❌ Nuke Failed', err.error || 'Unknown error');
                }
            } catch (err) {
                console.error('[NUKE LEGACY] Failed:', err);
                showConfigCopyToast(false, '❌ Error', err.message);
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // LEGACY KEYS - Migrate Variables to Placeholders
        // ═══════════════════════════════════════════════════════════════════════════
        async function migrateVariablesToPlaceholders() {
            const companyId = window.currentCompanyId || window.companyId || 
                              new URLSearchParams(window.location.search).get('id') ||
                              localStorage.getItem('currentCompanyId');
            if (!companyId) {
                showConfigCopyToast(false, '❌ Error', 'No company ID found');
                return;
            }
            
            const authToken = localStorage.getItem('adminToken') || localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/company/${companyId}/control-plane/migrate-variables`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dryRun: false
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showConfigCopyToast(true, '⚡ Migrated!', result.message || 'Variables migrated to placeholders');
                    await refreshConfigJson();
                    await loadLegacyReport();
                } else {
                    const err = await response.json();
                    showConfigCopyToast(false, '❌ Migration Failed', err.error || 'Unknown error');
                }
            } catch (err) {
                console.error('[MIGRATE VARIABLES] Failed:', err);
                showConfigCopyToast(false, '❌ Error', err.message);
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CONFIG JSON - Switch Tab
        // ═══════════════════════════════════════════════════════════════════════════
        function switchConfigTab(tabId) {
            currentConfigTab = tabId;
            
            // Update tab buttons
            document.querySelectorAll('.config-tab').forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.style.color = '#f1f5f9';
                    tab.style.borderBottomColor = '#14b8a6';
                    tab.classList.add('active');
                } else {
                    tab.style.color = '#94a3b8';
                    tab.style.borderBottomColor = 'transparent';
                    tab.classList.remove('active');
                }
            });
            
            // Show/hide content
            document.querySelectorAll('.config-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            const activeContent = document.getElementById(`config-tab-${tabId}`);
            if (activeContent) {
                activeContent.style.display = 'block';
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CONFIG JSON - Refresh
        // ═══════════════════════════════════════════════════════════════════════════
        async function refreshConfigJson() {
            const icon = document.getElementById('config-refresh-icon');
            if (icon) icon.classList.add('fa-spin');
            
            await loadConfigJsonData();
            
            setTimeout(() => {
                if (icon) icon.classList.remove('fa-spin');
            }, 500);
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CONFIG COPY DROPDOWN - Toggle & Close
        // ═══════════════════════════════════════════════════════════════════════════
        function toggleConfigCopyDropdown() {
            const menu = document.getElementById('config-copy-dropdown-menu');
            if (menu) {
                const isVisible = menu.style.display !== 'none';
                menu.style.display = isVisible ? 'none' : 'block';
                
                // Close on click outside
                if (!isVisible) {
                    setTimeout(() => {
                        document.addEventListener('click', closeConfigCopyDropdownOnClickOutside, { once: true });
                    }, 10);
                }
            }
        }
        
        function closeConfigCopyDropdown() {
            const menu = document.getElementById('config-copy-dropdown-menu');
            if (menu) menu.style.display = 'none';
        }
        
        function closeConfigCopyDropdownOnClickOutside(e) {
            const dropdown = document.querySelector('.config-copy-dropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                closeConfigCopyDropdown();
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // RAW COMPANY CHUNK SPLITTING (for large JSON)
        // ═══════════════════════════════════════════════════════════════════════════
        const RAW_COMPANY_MAX_CHARS = 28000; // ~28KB per chunk (safe for clipboard)
        let rawCompanyChunks = []; // Cache chunks after data loads
        
        /**
         * Split text into chunks by character count
         * IMPORTANT: No headers added - just pure text splits for valid JSON reassembly
         */
        function splitTextIntoChunks(text, maxChars = RAW_COMPANY_MAX_CHARS) {
            const chunks = [];
            for (let i = 0; i < text.length; i += maxChars) {
                chunks.push(text.slice(i, i + maxChars));
            }
            return chunks;
        }
        
        /**
         * Build chunks from raw company data
         */
        function buildRawCompanyChunks(rawCompanyObj, { pretty = true, maxChars = RAW_COMPANY_MAX_CHARS } = {}) {
            if (!rawCompanyObj) return [];
            const text = pretty
                ? JSON.stringify(rawCompanyObj, null, 2)
                : JSON.stringify(rawCompanyObj);
            return splitTextIntoChunks(text, maxChars);
        }
        
        /**
         * Update the Raw Company dropdown items based on chunk count
         */
        function updateRawCompanyDropdownItems() {
            const container = document.getElementById('raw-company-dropdown-items');
            if (!container) return;
            
            // Build chunks from current raw data
            rawCompanyChunks = buildRawCompanyChunks(configRawData);
            const numChunks = rawCompanyChunks.length;
            
            // If no data or error, show disabled item
            if (!configRawData || numChunks === 0) {
                container.innerHTML = `
                    <button disabled
                            style="width: 100%; padding: 12px 16px; font-size: 14px; background: transparent; color: #64748b; border: none; cursor: not-allowed; display: flex; align-items: center; gap: 10px; text-align: left; opacity: 0.6;">
                        <span style="font-size: 16px;">⚠️</span>
                        <div>
                            <div style="font-weight: 500;">Raw Company Unavailable</div>
                            <div style="font-size: 11px; color: #64748b;">API error - click Refresh</div>
                        </div>
                    </button>
                `;
                return;
            }
            
            // Calculate total size
            const totalChars = rawCompanyChunks.reduce((sum, c) => sum + c.length, 0);
            const totalKB = (totalChars / 1024).toFixed(1);
            
            // If single chunk, show simple copy option
            if (numChunks === 1) {
                container.innerHTML = `
                    <button onclick="copyRawCompanyPart(0); closeConfigCopyDropdown();" 
                            class="config-dropdown-item"
                            style="width: 100%; padding: 12px 16px; font-size: 14px; background: transparent; color: #e2e8f0; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; text-align: left; transition: background 0.15s;"
                            onmouseover="this.style.background='#334155'"
                            onmouseout="this.style.background='transparent'">
                        <span style="font-size: 16px;">🧾</span>
                        <div>
                            <div style="font-weight: 500;">Copy Raw Company JSON</div>
                            <div style="font-size: 11px; color: #94a3b8;">${totalKB} KB • MongoDB ground truth</div>
                        </div>
                    </button>
                `;
                return;
            }
            
            // Multiple chunks - show part options
            let html = `
                <div style="padding: 8px 16px; font-size: 11px; color: #f59e0b; background: #422006; border-bottom: 1px solid #334155;">
                    ⚠️ Large JSON (${totalKB} KB) — split into ${numChunks} parts for clipboard
                </div>
            `;
            
            for (let i = 0; i < numChunks; i++) {
                const chunkSize = (rawCompanyChunks[i].length / 1024).toFixed(1);
                html += `
                    <button onclick="copyRawCompanyPart(${i}); closeConfigCopyDropdown();" 
                            class="config-dropdown-item"
                            style="width: 100%; padding: 10px 16px; font-size: 14px; background: transparent; color: #e2e8f0; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; text-align: left; transition: background 0.15s;"
                            onmouseover="this.style.background='#334155'"
                            onmouseout="this.style.background='transparent'">
                        <span style="font-size: 14px; width: 24px; text-align: center;">${i + 1}</span>
                        <div>
                            <div style="font-weight: 500;">Copy Part ${i + 1}/${numChunks}</div>
                            <div style="font-size: 11px; color: #94a3b8;">${chunkSize} KB • Paste in order</div>
                        </div>
                    </button>
                `;
            }
            
            container.innerHTML = html;
        }
        
        /**
         * Copy a specific part of the raw company JSON
         */
        async function copyRawCompanyPart(partIndex) {
            if (!rawCompanyChunks || rawCompanyChunks.length === 0) {
                showConfigCopyToast(false, '⚠️ No Data', 'Please click Refresh first to load data.');
                return;
            }
            
            const chunk = rawCompanyChunks[partIndex];
            const numChunks = rawCompanyChunks.length;
            
            if (!chunk) {
                showConfigCopyToast(false, '❌ Invalid Part', `Part ${partIndex + 1} not found.`);
                return;
            }
            
            try {
                await navigator.clipboard.writeText(chunk);
                const sizeKB = (chunk.length / 1024).toFixed(1);
                
                if (numChunks === 1) {
                    showConfigCopyToast(true, '🧾 Raw Company Copied!', `${sizeKB} KB • Full JSON`);
                } else {
                    showConfigCopyToast(true, `🧾 Part ${partIndex + 1}/${numChunks} Copied!`, `${sizeKB} KB • Paste parts in order to reassemble`);
                }
            } catch (err) {
                console.error('[RAW COMPANY] Copy failed:', err);
                showConfigCopyToast(false, '❌ Copy Failed', err.message);
            }
        }
        
        /**
         * Download Raw Company JSON as file (best for large configs)
         */
        function downloadRawCompanyJson() {
            if (!configRawData) {
                showConfigCopyToast(false, '⚠️ No Data', 'Please click Refresh first to load data.');
                return;
            }
            
            try {
                const text = JSON.stringify(configRawData, null, 2);
                const blob = new Blob([text], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Generate filename with company name if available
                const companyName = configRawData?.data?.company?.companyName || configRawData?.companyName || 'company';
                const safeName = companyName.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
                const filename = `raw-${safeName}-${new Date().toISOString().slice(0,10)}.json`;
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                
                URL.revokeObjectURL(url);
                
                const sizeKB = (text.length / 1024).toFixed(1);
                showConfigCopyToast(true, '💾 Download Started!', `${filename} • ${sizeKB} KB`);
            } catch (err) {
                console.error('[RAW COMPANY] Download failed:', err);
                showConfigCopyToast(false, '❌ Download Failed', err.message);
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CONFIG JSON - Copy to Clipboard with Visual Feedback
        // ═══════════════════════════════════════════════════════════════════════════
        async function copyConfigJson(type) {
            let data;
            let label;
            let icon;
            
            if (type === 'effective') {
                data = configEffectiveData?.effectiveConfig;
                label = 'Effective Config';
                icon = '📋';
            } else if (type === 'raw') {
                data = configRawData;
                label = 'Raw Company JSON';
                icon = '🧾';
            } else if (type === 'lint') {
                data = {
                    lint: configEffectiveData?.lint,
                    computed: configEffectiveData?.computed,
                    warnings: configEffectiveData?.warnings
                };
                label = 'Lint Results';
                icon = '🔍';
            }
            
            if (data) {
                try {
                    const jsonString = JSON.stringify(data, null, 2);
                    await navigator.clipboard.writeText(jsonString);
                    
                    // Calculate stats for feedback
                    const lines = jsonString.split('\n').length;
                    const size = (jsonString.length / 1024).toFixed(1);
                    
                    // Show inline toast
                    showConfigCopyToast(true, `${icon} ${label} Copied!`, `${lines} lines • ${size} KB`);
                    
                } catch (err) {
                    console.error('[CONFIG JSON] Copy failed:', err);
                    showConfigCopyToast(false, '❌ Copy Failed', err.message);
                }
            } else {
                showConfigCopyToast(false, '⚠️ No Data', 'Please click Refresh first to load data.');
            }
        }
        
        // Show toast notification for config copy
        function showConfigCopyToast(success, title, detail) {
            // Remove existing toast if any
            const existing = document.getElementById('config-copy-toast');
            if (existing) existing.remove();
            
            // Create toast element
            const toast = document.createElement('div');
            toast.id = 'config-copy-toast';
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%) translateY(100px);
                padding: 12px 20px;
                border-radius: 10px;
                background: ${success ? '#059669' : '#dc2626'};
                color: white;
                font-weight: 600;
                font-size: 14px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 100000;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                transition: transform 0.3s ease-out;
            `;
            
            toast.innerHTML = `
                <span style="font-size: 15px;">${title}</span>
                <span style="font-size: 12px; opacity: 0.9;">${detail}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.style.transform = 'translateX(-50%) translateY(0)';
            });
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(-50%) translateY(100px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
    
</body>


