<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Button Test</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-6">Webhook Button Test</h1>
        
        <!-- Webhook Configuration Reference -->
        <div class="config-block mt-6">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-gray-700">Twilio Webhook Configuration</h3>
                <button type="button" id="toggleWebhookInfo" class="text-indigo-600 hover:text-indigo-800 text-sm flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>Show Webhook URLs
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-3">Use these webhook URLs in your Twilio Console for phone number configuration.</p>
            
            <div id="webhookInfoPanel" class="hidden">
                <!-- Dynamic webhook content will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Mock CompanyProfileManager for testing
        class TestCompanyProfileManager {
            constructor() {
                this.companyId = '67513b0afb3e7ba46b21e28c';
                this.apiBaseUrl = 'http://localhost:3000';
                this.currentData = {
                    companyName: 'Test Company',
                    companyId: this.companyId
                };
                
                this.setupWebhookToggle();
            }

            setupWebhookToggle() {
                const toggleWebhookBtn = document.getElementById('toggleWebhookInfo');
                const webhookPanel = document.getElementById('webhookInfoPanel');
                
                console.log('üîß Setting up webhook toggle...', { 
                    toggleWebhookBtn: !!toggleWebhookBtn, 
                    webhookPanel: !!webhookPanel,
                    companyId: this.companyId 
                });
                
                if (!toggleWebhookBtn || !webhookPanel) {
                    console.warn('‚ùå Webhook toggle elements not found:', { 
                        toggleWebhookBtn: !!toggleWebhookBtn, 
                        webhookPanel: !!webhookPanel 
                    });
                    return;
                }

                if (!this.companyId) {
                    console.warn('‚ùå Company ID not available for webhook setup');
                    return;
                }

                // Remove any existing event listeners by cloning the button
                const newToggleBtn = toggleWebhookBtn.cloneNode(true);
                toggleWebhookBtn.parentNode.replaceChild(newToggleBtn, toggleWebhookBtn);
                
                // Add the event listener to the new button
                newToggleBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('üîò Webhook toggle clicked for company:', this.companyId);
                    
                    const currentPanel = document.getElementById('webhookInfoPanel');
                    if (!currentPanel) {
                        console.error('‚ùå Webhook panel disappeared');
                        return;
                    }
                    
                    const isHidden = currentPanel.classList.contains('hidden');
                    console.log('üìä Panel hidden state:', isHidden);
                    
                    if (isHidden) {
                        // Generate dynamic webhook content with companyId
                        console.log('üîß Generating webhook panel for company:', this.companyId);
                        this.generateWebhookPanel();
                        currentPanel.classList.remove('hidden');
                        newToggleBtn.innerHTML = '<i class="fas fa-eye-slash mr-1"></i>Hide Webhook URLs';
                    } else {
                        currentPanel.classList.add('hidden');
                        newToggleBtn.innerHTML = '<i class="fas fa-info-circle mr-1"></i>Show Webhook URLs';
                    }
                });
                
                console.log('‚úÖ Webhook toggle setup complete');
            }

            generateWebhookPanel() {
                const webhookPanel = document.getElementById('webhookInfoPanel');
                if (!webhookPanel) {
                    console.error('‚ùå Webhook panel not found');
                    return;
                }
                
                if (!this.companyId) {
                    console.error('‚ùå Company ID not available');
                    webhookPanel.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <p class="text-red-800 text-sm">‚ö†Ô∏è Company ID not found. Please refresh the page.</p>
                        </div>
                    `;
                    return;
                }

                const baseUrl = this.apiBaseUrl || 'https://clientsvia-backend.onrender.com';
                console.log('üîß Generating webhooks for company:', this.companyId, 'Base URL:', baseUrl);
                
                // Define webhooks with companyId parameter
                const webhooks = [
                    {
                        title: 'üé§ Voice Webhook (Primary)',
                        url: `${baseUrl}/api/twilio/voice?companyId=${this.companyId}`,
                        description: 'Configure this in Twilio Console ‚Üí Phone Numbers ‚Üí Voice Configuration',
                        primary: true
                    },
                    {
                        title: 'üó£Ô∏è Speech Recognition',
                        url: `${baseUrl}/api/twilio/handle-speech?companyId=${this.companyId}`,
                        description: 'Used internally for AI speech processing',
                        primary: true
                    },
                    {
                        title: 'üìû Partial Speech',
                        url: `${baseUrl}/api/twilio/partial-speech?companyId=${this.companyId}`,
                        description: 'For real-time speech processing',
                        primary: false
                    },
                    {
                        title: '‚è±Ô∏è Speech Timing Test',
                        url: `${baseUrl}/api/twilio/speech-timing-test?companyId=${this.companyId}`,
                        description: 'For performance testing and optimization',
                        primary: false
                    }
                ];

                webhookPanel.innerHTML = `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 space-y-4">
                        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                            <h5 class="text-sm font-medium text-blue-900 mb-1">üè¢ Company: ${this.currentData?.companyName || 'Unknown'}</h5>
                            <p class="text-xs text-blue-700">Company ID: <code class="bg-white px-1 rounded">${this.companyId}</code></p>
                        </div>
                        
                        ${webhooks.map(webhook => `
                            <div class="webhook-item">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-sm font-medium text-gray-900">${webhook.title}</h4>
                                    <button type="button" class="copy-webhook-btn text-xs ${webhook.primary ? 'bg-blue-100 hover:bg-blue-200 text-blue-700' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'} px-2 py-1 rounded" data-webhook="${webhook.url}">
                                        <i class="fas fa-copy mr-1"></i>Copy
                                    </button>
                                </div>
                                <div class="bg-white border rounded p-2 font-mono text-sm text-gray-800 break-all">
                                    ${webhook.url}
                                </div>
                                <p class="text-xs text-gray-600 mt-1">${webhook.description}</p>
                            </div>
                        `).join('')}
                        
                        <!-- Configuration Instructions -->
                        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded">
                            <h5 class="text-sm font-medium text-blue-900 mb-2">üìã Quick Setup Instructions:</h5>
                            <ol class="text-xs text-blue-800 space-y-1">
                                <li>1. Go to <a href="https://console.twilio.com" target="_blank" class="underline hover:no-underline">Twilio Console</a></li>
                                <li>2. Navigate to Phone Numbers ‚Üí Manage ‚Üí Active Numbers</li>
                                <li>3. Click on your phone number</li>
                                <li>4. Set Voice Configuration webhook to the <strong>Voice Webhook URL</strong> above</li>
                                <li>5. Set HTTP method to <strong>POST</strong></li>
                                <li>6. Save configuration</li>
                                <li>7. Test by calling your number - the AI agent will respond with company-specific data</li>
                            </ol>
                        </div>
                    </div>
                `;

                // Re-setup copy functionality for dynamically generated buttons
                this.setupWebhookCopyButtons();
            }

            setupWebhookCopyButtons() {
                const copyButtons = document.querySelectorAll('.copy-webhook-btn');
                copyButtons.forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const webhookUrl = btn.dataset.webhook;
                        if (webhookUrl) {
                            try {
                                await navigator.clipboard.writeText(webhookUrl);
                                const originalText = btn.innerHTML;
                                btn.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                                btn.classList.add('bg-green-100', 'text-green-700');
                                btn.classList.remove('bg-blue-100', 'text-blue-700', 'bg-gray-100', 'text-gray-600');
                                
                                setTimeout(() => {
                                    btn.innerHTML = originalText;
                                    btn.classList.remove('bg-green-100', 'text-green-700');
                                    // Restore original colors based on webhook type
                                    if (webhookUrl.includes('voice') || webhookUrl.includes('speech')) {
                                        btn.classList.add('bg-blue-100', 'text-blue-700');
                                    } else {
                                        btn.classList.add('bg-gray-100', 'text-gray-600');
                                    }
                                }, 2000);
                            } catch (err) {
                                console.error('Failed to copy webhook URL:', err);
                                alert('Failed to copy webhook URL');
                            }
                        }
                    });
                });
            }
        }

        // Initialize test when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Initializing test...');
            const manager = new TestCompanyProfileManager();
        });
    </script>
</body>
</html>
