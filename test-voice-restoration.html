<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Restoration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>Voice Restoration Test for Company: 68813026dd95f599c74e49c7</h1>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Voice Selector</h2>
        <select id="voice-selector" data-saved-voice-id="">
            <option value="">Choose a voice...</option>
        </select>
        <p>Current selector value: <span id="selector-value">none</span></p>
    </div>
    
    <div class="test-section">
        <h2>Logs</h2>
        <div id="logs"></div>
    </div>

    <script>
        const companyId = '68813026dd95f599c74e49c7';
        const logs = document.getElementById('logs');
        const results = document.getElementById('test-results');
        const selectorValueSpan = document.getElementById('selector-value');
        
        function log(message, type = 'info') {
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = new Date().toLocaleTimeString() + ': ' + message;
            logs.appendChild(logDiv);
            console.log(message);
        }
        
        function updateSelectorValue() {
            const selector = document.getElementById('voice-selector');
            selectorValueSpan.textContent = selector.value || 'empty';
        }
        
        // Mock company profile manager for testing
        window.companyProfileManager = {
            currentData: null
        };
        
        let availableVoices = [];
        
        async function testVoiceRestoration() {
            try {
                log('üéôÔ∏è Starting voice restoration test...', 'success');
                
                // Step 1: Load company data
                log('üì• Loading company data...');
                const companyResponse = await fetch(`/api/company/${companyId}`);
                const companyData = await companyResponse.json();
                
                if (!companyData) {
                    throw new Error('Failed to load company data');
                }
                
                // Set up mock company profile manager
                window.companyProfileManager.currentData = companyData;
                
                log(`üè¢ Company loaded: ${companyData.companyName}`);
                log(`üéØ Saved voice ID: ${companyData.aiSettings?.elevenLabs?.voiceId || 'none'}`, 'warning');
                
                // Step 2: Load voices
                log('üéµ Loading voices...');
                const voicesResponse = await fetch(`/api/elevenlabs/companies/${companyId}/voices`);
                const voicesData = await voicesResponse.json();
                
                if (!voicesData.success) {
                    throw new Error('Failed to load voices: ' + voicesData.error);
                }
                
                availableVoices = voicesData.voices;
                log(`‚úÖ Loaded ${availableVoices.length} voices`);
                
                // Step 3: Test voice restoration logic
                log('üîÑ Testing voice restoration logic...');
                testVoiceRestorationLogic();
                
                results.innerHTML = `
                    <div class="success">‚úÖ Test completed successfully!</div>
                    <p><strong>Company:</strong> ${companyData.companyName}</p>
                    <p><strong>Saved Voice ID:</strong> ${companyData.aiSettings?.elevenLabs?.voiceId || 'none'}</p>
                    <p><strong>Available Voices:</strong> ${availableVoices.length}</p>
                    <p><strong>Final Selector Value:</strong> ${document.getElementById('voice-selector').value}</p>
                `;
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                results.innerHTML = `<div class="error">‚ùå Test failed: ${error.message}</div>`;
            }
        }
        
        function testVoiceRestorationLogic() {
            const selector = document.getElementById('voice-selector');
            
            // Clear existing options except the first one
            while (selector.children.length > 1) {
                selector.removeChild(selector.lastChild);
            }
            
            // Add voice options
            availableVoices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = voice.voice_id;
                option.textContent = `${voice.name} (${voice.labels?.gender || 'Unknown'})`;
                selector.appendChild(option);
                
                if (index < 3) {
                    log(`üéôÔ∏è Added voice: ${voice.name} = ${voice.voice_id}`);
                }
            });
            
            // Test voice restoration logic (copied from the actual code)
            let savedVoiceId = null;
            
            // Try to get saved voice ID from the global company profile manager
            if (window.companyProfileManager && window.companyProfileManager.currentData) {
                const data = window.companyProfileManager.currentData;
                if (data.elevenLabsVoiceId) {
                    savedVoiceId = data.elevenLabsVoiceId;
                } else if (data.aiSettings?.elevenLabs?.voiceId) {
                    savedVoiceId = data.aiSettings.elevenLabs.voiceId;
                } else if (data.voiceSettings?.voiceId) {
                    savedVoiceId = data.voiceSettings.voiceId;
                }
            }
            
            // Fallback: check if voice ID was stored as data attribute
            if (!savedVoiceId && selector.getAttribute('data-saved-voice-id')) {
                savedVoiceId = selector.getAttribute('data-saved-voice-id');
                log('üéôÔ∏è Using saved voice ID from data attribute: ' + savedVoiceId);
            }
            
            log(`üîç Checking for saved voice during population: savedVoiceId=${savedVoiceId}, availableVoicesCount=${availableVoices.length}`);
            
            // If we have a saved voice ID, try to select it
            if (savedVoiceId && savedVoiceId !== 'undefined' && availableVoices.length > 0) {
                const savedVoice = availableVoices.find(v => v.voice_id === savedVoiceId);
                if (savedVoice) {
                    selector.value = savedVoiceId;
                    log(`üéØ Restored saved voice: ${savedVoice.name} (${savedVoiceId})`, 'success');
                    updateSelectorValue();
                } else {
                    log(`‚ö†Ô∏è Saved voice ID ${savedVoiceId} not found in available voices, will auto-select first voice`, 'warning');
                    // Fall back to auto-selecting first voice
                    if (availableVoices.length > 0) {
                        const firstVoice = availableVoices[0];
                        selector.value = firstVoice.voice_id;
                        log(`üéØ Auto-selected first voice (fallback): ${firstVoice.name} (${firstVoice.voice_id})`, 'warning');
                        updateSelectorValue();
                    }
                }
            } else if (availableVoices.length > 0 && (!selector.value || selector.value === 'undefined' || selector.value === '')) {
                // Auto-select the first voice if no saved voice and none is selected
                const firstVoice = availableVoices[0];
                selector.value = firstVoice.voice_id;
                log(`üéØ Auto-selected first voice (no saved voice): ${firstVoice.name} (${firstVoice.voice_id})`, 'warning');
                updateSelectorValue();
            }
        }
        
        // Add event listener to track selector changes
        document.getElementById('voice-selector').addEventListener('change', updateSelectorValue);
        
        // Start the test
        testVoiceRestoration();
    </script>
</body>
</html>
